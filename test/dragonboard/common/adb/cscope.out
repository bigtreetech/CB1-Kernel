cscope 15 $HOME/workspace/tina/package/allwinner/adb/src -q 0000004414 0000654291
	@adb.c

17 
	#TRACE_TAG
 
TRACE_ADB


	)

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<ùy³.h
>

22 
	~<¡d¬g.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

25 
	~<¡ršg.h
>

26 
	~<time.h
>

27 
	~<sys/time.h
>

29 
	~"cuts/´İ”t›s.h
"

31 
	~"sysd•s.h
"

32 
	~"adb.h
"

33 
	~"adb_auth.h
"

35 
	#ARRAY_SIZE
(
a
è(×è/ (×)[0]))

	)

37 #ià!
ADB_HOST


38 
	~<´iv©e/ªdroid_fesy¡em_cÚfig.h
>

39 
	~<lšux/ÿ·b™y.h
>

40 
	~<lšux/´ùl.h
>

41 
	~<sys/mouÁ.h
>

43 
	~"usb_v’dÜs.h
"

46 #ià
ADB_TRACE


47 
ADB_MUTEX_DEFINE
Ğ
D_lock
 );

50 
	gHOST
 = 0;

52 
	gauth_’abËd
 = 0;

54 #ià!
ADB_HOST


55 cÚ¡ *
	gadb_deviû_bªÃr
 = "device";

58 
	$çl
(cÚ¡ *
fmt
, ...)

60 
va_li¡
 
­
;

61 
	`va_¡¬t
(
­
, 
fmt
);

62 
	`årštf
(
¡d”r
, "error: ");

63 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

64 
	`årštf
(
¡d”r
, "\n");

65 
	`va_’d
(
­
);

66 
	`ex™
(-1);

67 
	}
}

69 
	$çl_”ºo
(cÚ¡ *
fmt
, ...)

71 
va_li¡
 
­
;

72 
	`va_¡¬t
(
­
, 
fmt
);

73 
	`årštf
(
¡d”r
, "”rÜ: %s: ", 
	`¡»¼Ü
(
”ºo
));

74 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

75 
	`årštf
(
¡d”r
, "\n");

76 
	`va_’d
(
­
);

77 
	`ex™
(-1);

78 
	}
}

80 
	gadb_Œaû_mask
;

87 
	$adb_Œaû_š™
()

89 cÚ¡ * 
p
 = 
	`g‘’v
("ADB_TRACE");

90 cÚ¡ * 
q
;

93 cÚ¡ * 
g
;

94 
æag
;

95 } 
gs
[] = {

98 { "adb", 
TRACE_ADB
 },

99 { "sock‘s", 
TRACE_SOCKETS
 },

100 { "·ck‘s", 
TRACE_PACKETS
 },

101 { "rwx", 
TRACE_RWX
 },

102 { "usb", 
TRACE_USB
 },

103 { "sync", 
TRACE_SYNC
 },

104 { "sysd•s", 
TRACE_SYSDEPS
 },

105 { "Œª¥Üt", 
TRACE_TRANSPORT
 },

106 { "jdwp", 
TRACE_JDWP
 },

107 { "£rviûs", 
TRACE_SERVICES
 },

108 { "auth", 
TRACE_AUTH
 },

109 { 
NULL
, 0 }

112 ià(
p
 =ğ
NULL
)

116 *
p
) {

117 
Ën
, 
gn
;

119 
q
 = 
	`¡½brk
(
p
, " ,:;");

120 ià(
q
 =ğ
NULL
) {

121 
q
 = 
p
 + 
	`¡¾’
(p);

123 
Ën
 = 
q
 - 
p
;

125 
gn
 = 0; 
gs
[gn].
g
 !ğ
NULL
;agn++)

127 
gËn
 = 
	`¡¾’
(
gs
[
gn
].
g
);

129 ià(
Ën
 =ğ
gËn
 && !
	`memcmp
(
gs
[
gn
].
g
, 
p
,†en) )

131 
æag
 = 
gs
[
gn
].flag;

132 ià(
æag
 == 0) {

133 
adb_Œaû_mask
 = ~0;

136 
adb_Œaû_mask
 |ğ(1 << 
æag
);

140 
p
 = 
q
;

141 ià(*
p
)

142 
p
++;

144 
adb_Œaû_mask
 = ~0;

145 
	}
}

147 #ià!
ADB_HOST


152 
	~<¡d¬g.h
>

159 #undeà
İ’


160 #undeà
wr™e


161 
	#İ’
 
adb_İ’


	)

162 
	#wr™e
 
adb_wr™e


	)

163 
	~<qemu/qemu_pe.h
>

164 #undeà
İ’


165 #undeà
wr™e


166 
	#İ’
 
___xxx_İ’


	)

167 
	#wr™e
 
___xxx_wr™e


	)

170 
	gadb_debug_qemu
 = -1;

173 
	$adb_qemu_Œaû_š™
()

175 
cÚ_Çme
[32];

177 ià(
adb_debug_qemu
 >= 0) {

182 
	`¢´štf
(
cÚ_Çme
, (con_name), "qemud:adb-debug");

183 
adb_debug_qemu
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

184  (
adb_debug_qemu
 >= 0) ? 0 : -1;

185 
	}
}

187 
	$adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...)

189 
va_li¡
 
¬gs
;

190 
	`va_¡¬t
(
¬gs
, 
fmt
);

191 
msg
[1024];

193 ià(
adb_debug_qemu
 >= 0) {

194 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
¬gs
);

195 
	`adb_wr™e
(
adb_debug_qemu
, 
msg
, 
	`¡¾’
(msg));

197 
	}
}

200 
­ack‘
 *
	$g‘_­ack‘
()

202 
­ack‘
 *
p
 = 
	`m®loc
((apacket));

203 if(
p
 =ğ0è
	`çl
("failedo‡llocate‡n‡packet");

204 
	`mem£t
(
p
, 0, (
­ack‘
è- 
MAX_PAYLOAD
);

205  
p
;

206 
	}
}

208 
	$put_­ack‘
(
­ack‘
 *
p
)

210 
	`ä“
(
p
);

211 
	}
}

213 
	$hªdË_Úlše
(
©¿n¥Üt
 *
t
)

215 
	`D
("adb: online\n");

216 
t
->
Úlše
 = 1;

217 
	}
}

219 
	$hªdË_ofæše
(
©¿n¥Üt
 *
t
)

221 
	`D
("adb: offline\n");

223 
t
->
Úlše
 = 0;

224 
	`run_Œª¥Üt_discÚÃùs
(
t
);

225 
	}
}

227 #ià
DEBUG_PACKETS


228 
	#DUMPMAX
 32

	)

229 
	$´št_·ck‘
(cÚ¡ *
Ïb–
, 
­ack‘
 *
p
)

231 *
g
;

232 *
x
;

233 
couÁ
;

235 
p
->
msg
.
commªd
){

236 
A_SYNC
: 
g
 = "SYNC"; ;

237 
A_CNXN
: 
g
 = "CNXN" ; ;

238 
A_OPEN
: 
g
 = "OPEN"; ;

239 
A_OKAY
: 
g
 = "OKAY"; ;

240 
A_CLSE
: 
g
 = "CLSE"; ;

241 
A_WRTE
: 
g
 = "WRTE"; ;

242 
A_AUTH
: 
g
 = "AUTH"; ;

243 : 
g
 = "????"; ;

246 
	`årštf
(
¡d”r
, "%s: %s %08x %08x %04x \"",

247 
Ïb–
, 
g
, 
p
->
msg
.
¬g0
,…->msg.
¬g1
,…->msg.
d©a_Ëngth
);

248 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

249 
x
 = (*è
p
->
d©a
;

250 if(
couÁ
 > 
DUMPMAX
) {

251 
couÁ
 = 
DUMPMAX
;

252 
g
 = "\n";

254 
g
 = "\"\n";

256 
couÁ
-- > 0){

257 if((*
x
 >= ' ') && (*x < 127)) {

258 
	`åutc
(*
x
, 
¡d”r
);

260 
	`åutc
('.', 
¡d”r
);

262 
x
++;

264 
	`åuts
(
g
, 
¡d”r
);

265 
	}
}

268 
	$£nd_»ady
(
loÿl
, 
»mÙe
, 
©¿n¥Üt
 *
t
)

270 
	`D
("Calling send_ready \n");

271 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

272 
p
->
msg
.
commªd
 = 
A_OKAY
;

273 
p
->
msg
.
¬g0
 = 
loÿl
;

274 
p
->
msg
.
¬g1
 = 
»mÙe
;

275 
	`£nd_·ck‘
(
p
, 
t
);

276 
	}
}

278 
	$£nd_şo£
(
loÿl
, 
»mÙe
, 
©¿n¥Üt
 *
t
)

280 
	`D
("Calling send_close \n");

281 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

282 
p
->
msg
.
commªd
 = 
A_CLSE
;

283 
p
->
msg
.
¬g0
 = 
loÿl
;

284 
p
->
msg
.
¬g1
 = 
»mÙe
;

285 
	`£nd_·ck‘
(
p
, 
t
);

286 
	}
}

288 
size_t
 
	$fl_cÚÃù_d©a
(*
buf
, 
size_t
 
bufsize
)

290 #ià
ADB_HOST


291  
	`¢´štf
(
buf
, 
bufsize
, "host::") + 1;

293 cÚ¡ *
úxn_´İs
[] = {

298 cÚ¡ 
num_úxn_´İs
 = 
	`ARRAY_SIZE
(
úxn_´İs
);

299 
i
;

300 
size_t
 
»maššg
 = 
bufsize
;

301 
size_t
 
Ën
;

303 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "%s::", 
adb_deviû_bªÃr
);

304 
»maššg
 -ğ
Ën
;

305 
buf
 +ğ
Ën
;

306 
i
 = 0; i < 
num_úxn_´İs
; i++) {

307 
v®ue
[
PROPERTY_VALUE_MAX
];

308 
	`´İ”ty_g‘
(
úxn_´İs
[
i
], 
v®ue
, "");

309 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "%s=%s;", 
úxn_´İs
[
i
], 
v®ue
);

310 
»maššg
 -ğ
Ën
;

311 
buf
 +ğ
Ën
;

314  
bufsize
 - 
»maššg
 + 1;

316 
	}
}

318 
	$£nd_cÚÃù
(
©¿n¥Üt
 *
t
)

320 
	`D
("Calling send_connect \n");

321 
­ack‘
 *
ı
 = 
	`g‘_­ack‘
();

322 
ı
->
msg
.
commªd
 = 
A_CNXN
;

323 
ı
->
msg
.
¬g0
 = 
A_VERSION
;

324 
ı
->
msg
.
¬g1
 = 
MAX_PAYLOAD
;

325 
ı
->
msg
.
d©a_Ëngth
 = 
	`fl_cÚÃù_d©a
((*)ı->
d©a
,

326 (
ı
->
d©a
));

327 
	`£nd_·ck‘
(
ı
, 
t
);

328 
	}
}

330 
	$£nd_auth_»que¡
(
©¿n¥Üt
 *
t
)

332 
	`D
("Calling send_auth_request\n");

333 
­ack‘
 *
p
;

334 
»t
;

336 
»t
 = 
	`adb_auth_g’”©e_tok’
(
t
->
tok’
, (t->token));

337 ià(
»t
 !ğ(
t
->
tok’
)) {

338 
	`D
("E¼Ü g’”©šgok’„‘=%d\n", 
»t
);

342 
p
 = 
	`g‘_­ack‘
();

343 
	`memıy
(
p
->
d©a
, 
t
->
tok’
, 
»t
);

344 
p
->
msg
.
commªd
 = 
A_AUTH
;

345 
p
->
msg
.
¬g0
 = 
ADB_AUTH_TOKEN
;

346 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

347 
	`£nd_·ck‘
(
p
, 
t
);

348 
	}
}

350 
	$£nd_auth_»¥Ú£
(
ušt8_t
 *
tok’
, 
size_t
 
tok’_size
, 
©¿n¥Üt
 *
t
)

352 
	`D
("Calling send_auth_response\n");

353 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

354 
»t
;

356 
»t
 = 
	`adb_auth_sign
(
t
->
key
, 
tok’
, 
tok’_size
, 
p
->
d©a
);

357 ià(!
»t
) {

358 
	`D
("Error signingheoken\n");

359 
	`put_­ack‘
(
p
);

363 
p
->
msg
.
commªd
 = 
A_AUTH
;

364 
p
->
msg
.
¬g0
 = 
ADB_AUTH_SIGNATURE
;

365 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

366 
	`£nd_·ck‘
(
p
, 
t
);

367 
	}
}

369 
	$£nd_auth_publickey
(
©¿n¥Üt
 *
t
)

371 
	`D
("Calling send_auth_publickey\n");

372 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

373 
»t
;

375 
»t
 = 
	`adb_auth_g‘_u£rkey
(
p
->
d©a
, (p->data));

376 ià(!
»t
) {

377 
	`D
("Failedo get user…ublic key\n");

378 
	`put_­ack‘
(
p
);

382 
p
->
msg
.
commªd
 = 
A_AUTH
;

383 
p
->
msg
.
¬g0
 = 
ADB_AUTH_RSAPUBLICKEY
;

384 
p
->
msg
.
d©a_Ëngth
 = 
»t
;

385 
	`£nd_·ck‘
(
p
, 
t
);

386 
	}
}

388 
	$adb_auth_v”if›d
(
©¿n¥Üt
 *
t
)

390 
	`hªdË_Úlše
(
t
);

391 
	`£nd_cÚÃù
(
t
);

392 
	}
}

394 *
	$cÚÃùiÚ_¡©e_Çme
(
©¿n¥Üt
 *
t
)

396 ià(
t
 =ğ
NULL
) {

400 
t
->
cÚÃùiÚ_¡©e
) {

401 
CS_BOOTLOADER
:

403 
CS_DEVICE
:

405 
CS_OFFLINE
:

410 
	}
}

416 
	$qu®_ov”wr™e
(**
d¡
, cÚ¡ *
¤c
)

418 ià(!
d¡
)

421 
	`ä“
(*
d¡
);

422 *
d¡
 = 
NULL
;

424 ià(!
¤c
 || !*src)

427 *
d¡
 = 
	`¡rdup
(
¤c
);

428 
	}
}

430 
	$·r£_bªÃr
(*
bªÃr
, 
©¿n¥Üt
 *
t
)

432 cÚ¡ *
´İ_£ps
 = ";";

433 cÚ¡ 
key_v®_£p
 = '=';

434 *
ı
;

435 *
ty³
;

437 
	`D
("·r£_bªÃr: %s\n", 
bªÃr
);

438 
ty³
 = 
bªÃr
;

439 
ı
 = 
	`¡rchr
(
ty³
, ':');

440 ià(
ı
) {

441 *
ı
++ = 0;

443 
ı
 = 
	`¡rchr
(cp, ':');

444 ià(
ı
) {

445 *
§ve
;

446 *
key
;

447 
key
 = 
	`adb_¡¹ok_r
(
ı
 + 1, 
´İ_£ps
, &
§ve
);

448 
key
) {

449 
ı
 = 
	`¡rchr
(
key
, 
key_v®_£p
);

450 ià(
ı
) {

451 *
ı
++ = '\0';

452 ià(!
	`¡rcmp
(
key
, "ro.product.name"))

453 
	`qu®_ov”wr™e
(&
t
->
´oduù
, 
ı
);

454 ià(!
	`¡rcmp
(
key
, "ro.product.model"))

455 
	`qu®_ov”wr™e
(&
t
->
mod–
, 
ı
);

456 ià(!
	`¡rcmp
(
key
, "ro.product.device"))

457 
	`qu®_ov”wr™e
(&
t
->
deviû
, 
ı
);

459 
key
 = 
	`adb_¡¹ok_r
(
NULL
, 
´İ_£ps
, &
§ve
);

464 if(!
	`¡rcmp
(
ty³
, "bootloader")){

465 
	`D
("setting connection_stateo CS_BOOTLOADER\n");

466 
t
->
cÚÃùiÚ_¡©e
 = 
CS_BOOTLOADER
;

467 
	`upd©e_Œª¥Üts
();

471 if(!
	`¡rcmp
(
ty³
, "device")) {

472 
	`D
("setting connection_stateo CS_DEVICE\n");

473 
t
->
cÚÃùiÚ_¡©e
 = 
CS_DEVICE
;

474 
	`upd©e_Œª¥Üts
();

478 if(!
	`¡rcmp
(
ty³
, "recovery")) {

479 
	`D
("setting connection_stateo CS_RECOVERY\n");

480 
t
->
cÚÃùiÚ_¡©e
 = 
CS_RECOVERY
;

481 
	`upd©e_Œª¥Üts
();

485 if(!
	`¡rcmp
(
ty³
, "sideload")) {

486 
	`D
("setting connection_stateo CS_SIDELOAD\n");

487 
t
->
cÚÃùiÚ_¡©e
 = 
CS_SIDELOAD
;

488 
	`upd©e_Œª¥Üts
();

492 
t
->
cÚÃùiÚ_¡©e
 = 
CS_HOST
;

493 
	}
}

495 
	$hªdË_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

497 
asock‘
 *
s
;

499 
	`D
("hªdË_·ck‘(è%c%c%c%c\n", ((*è(&(
p
->
msg
.
commªd
)))[0],

500 ((*è(&(
p
->
msg
.
commªd
)))[1],

501 ((*è(&(
p
->
msg
.
commªd
)))[2],

502 ((*è(&(
p
->
msg
.
commªd
)))[3]);

503 
	`´št_·ck‘
("»cv", 
p
);

505 
p
->
msg
.
commªd
){

506 
A_SYNC
:

507 if(
p
->
msg
.
¬g0
){

508 
	`£nd_·ck‘
(
p
, 
t
);

509 if(
HOST
è
	`£nd_cÚÃù
(
t
);

511 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

512 
	`hªdË_ofæše
(
t
);

513 
	`£nd_·ck‘
(
p
, 
t
);

517 
A_CNXN
:

519 if(
t
->
cÚÃùiÚ_¡©e
 !ğ
CS_OFFLINE
) {

520 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

521 
	`hªdË_ofæše
(
t
);

524 
	`·r£_bªÃr
((*è
p
->
d©a
, 
t
);

526 ià(
HOST
 || !
auth_’abËd
) {

527 
	`hªdË_Úlše
(
t
);

528 if(!
HOST
è
	`£nd_cÚÃù
(
t
);

530 
	`£nd_auth_»que¡
(
t
);

534 
A_AUTH
:

535 ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_TOKEN
) {

536 
t
->
key
 = 
	`adb_auth_Ãxtkey
(t->key);

537 ià(
t
->
key
) {

538 
	`£nd_auth_»¥Ú£
(
p
->
d©a
,…->
msg
.
d©a_Ëngth
, 
t
);

541 
	`£nd_auth_publickey
(
t
);

543 } ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_SIGNATURE
) {

544 ià(
	`adb_auth_v”ify
(
t
->
tok’
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)) {

545 
	`adb_auth_v”if›d
(
t
);

546 
t
->
çed_auth_©‹m±s
 = 0;

548 ià(
t
->
çed_auth_©‹m±s
++ > 10)

549 
	`adb_¦“p_ms
(1000);

550 
	`£nd_auth_»que¡
(
t
);

552 } ià(
p
->
msg
.
¬g0
 =ğ
ADB_AUTH_RSAPUBLICKEY
) {

553 
	`adb_auth_cÚfœm_key
(
p
->
d©a
,…->
msg
.
d©a_Ëngth
, 
t
);

557 
A_OPEN
:

558 ià(
t
->
Úlše
) {

559 *
Çme
 = (*è
p
->
d©a
;

560 
Çme
[
p
->
msg
.
d©a_Ëngth
 > 0 ?…->msg.data_length - 1 : 0] = 0;

561 
s
 = 
	`ü—‹_loÿl_£rviû_sock‘
(
Çme
);

562 if(
s
 == 0) {

563 
	`£nd_şo£
(0, 
p
->
msg
.
¬g0
, 
t
);

565 
s
->
³”
 = 
	`ü—‹_»mÙe_sock‘
(
p
->
msg
.
¬g0
, 
t
);

566 
s
->
³”
->peer = s;

567 
	`£nd_»ady
(
s
->
id
, s->
³”
->id, 
t
);

568 
s
->
	`»ady
(s);

573 
A_OKAY
:

574 ià(
t
->
Úlše
) {

575 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
))) {

576 if(
s
->
³”
 == 0) {

577 
s
->
³”
 = 
	`ü—‹_»mÙe_sock‘
(
p
->
msg
.
¬g0
, 
t
);

578 
s
->
³”
->peer = s;

580 
s
->
	`»ady
(s);

585 
A_CLSE
:

586 ià(
t
->
Úlše
) {

587 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
))) {

588 
s
->
	`şo£
(s);

593 
A_WRTE
:

594 ià(
t
->
Úlše
) {

595 if((
s
 = 
	`fšd_loÿl_sock‘
(
p
->
msg
.
¬g1
))) {

596 
rid
 = 
p
->
msg
.
¬g0
;

597 
p
->
Ën
 =…->
msg
.
d©a_Ëngth
;

599 if(
s
->
	`’queue
(s, 
p
) == 0) {

600 
	`D
("Enqueuehe socket\n");

601 
	`£nd_»ady
(
s
->
id
, 
rid
, 
t
);

609 
	`´štf
("hªdË_·ck‘: wh© i %08x?!\n", 
p
->
msg
.
commªd
);

612 
	`put_­ack‘
(
p
);

613 
	}
}

615 
®i¡’”
 
	gli¡’”_li¡
 = {

616 .
Ãxt
 = &
li¡’”_li¡
,

617 .
	g´ev
 = &
li¡’”_li¡
,

620 
	$ss_li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
)

622 
asock‘
 *
s
;

624 if(
ev
 & 
FDE_READ
) {

625 
sockaddr
 
addr
;

626 
sockËn_t
 
®’
;

627 
fd
;

629 
®’
 = (
addr
);

630 
fd
 = 
	`adb_sock‘_acû±
(
_fd
, &
addr
, &
®’
);

631 if(
fd
 < 0) ;

633 
	`adb_sock‘_£tbufsize
(
fd
, 
CHUNK_SIZE
);

635 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

636 if(
s
) {

637 
	`cÚÃù_to_sm¬tsock‘
(
s
);

641 
	`adb_şo£
(
fd
);

643 
	}
}

645 
	$li¡’”_ev’t_func
(
_fd
, 
ev
, *
_l
)

647 
®i¡’”
 *
l
 = 
_l
;

648 
asock‘
 *
s
;

650 if(
ev
 & 
FDE_READ
) {

651 
sockaddr
 
addr
;

652 
sockËn_t
 
®’
;

653 
fd
;

655 
®’
 = (
addr
);

656 
fd
 = 
	`adb_sock‘_acû±
(
_fd
, &
addr
, &
®’
);

657 if(
fd
 < 0) ;

659 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

660 if(
s
) {

661 
s
->
Œª¥Üt
 = 
l
->transport;

662 
	`cÚÃù_to_»mÙe
(
s
, 
l
->
cÚÃù_to
);

666 
	`adb_şo£
(
fd
);

668 
	}
}

670 
	$ä“_li¡’”
(
®i¡’”
* 
l
)

672 ià(
l
->
Ãxt
) {

673 
l
->
Ãxt
->
´ev
 =†->prev;

674 
l
->
´ev
->
Ãxt
 =†->next;

675 
l
->
Ãxt
 =†->
´ev
 =†;

679 
	`fdev’t_»move
(&
l
->
fde
);

681 ià(
l
->
loÿl_Çme
)

682 
	`ä“
((*)
l
->
loÿl_Çme
);

684 ià(
l
->
cÚÃù_to
)

685 
	`ä“
((*)
l
->
cÚÃù_to
);

687 ià(
l
->
Œª¥Üt
) {

688 
	`»move_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

690 
	`ä“
(
l
);

691 
	}
}

693 
	$li¡’”_discÚÃù
(* 
_l
, 
©¿n¥Üt
* 
t
)

695 
®i¡’”
* 
l
 = 
_l
;

697 
	`ä“_li¡’”
(
l
);

698 
	}
}

700 
	$loÿl_Çme_to_fd
(cÚ¡ *
Çme
)

702 
pÜt
;

704 if(!
	`¡ºcmp
("tı:", 
Çme
, 4)){

705 
»t
;

706 
pÜt
 = 
	`©oi
(
Çme
 + 4);

707 
»t
 = 
	`sock‘_loİback_£rv”
(
pÜt
, 
SOCK_STREAM
);

708  
»t
;

710 #iâdeà
HAVE_WIN32_IPC


712 if(!
	`¡ºcmp
(
Çme
, "local:", 6)) {

713  
	`sock‘_loÿl_£rv”
(
Çme
 + 6,

714 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

715 } if(!
	`¡ºcmp
(
Çme
, "localabstract:", 14)) {

716  
	`sock‘_loÿl_£rv”
(
Çme
 + 14,

717 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

718 } if(!
	`¡ºcmp
(
Çme
, "localfilesystem:", 16)) {

719  
	`sock‘_loÿl_£rv”
(
Çme
 + 16,

720 
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
, 
SOCK_STREAM
);

724 
	`´štf
("unknowÀloÿÈpÜŠam'%s'\n", 
Çme
);

726 
	}
}

728 
	$»move_li¡’”
(cÚ¡ *
loÿl_Çme
, cÚ¡ *
cÚÃù_to
, 
©¿n¥Üt
* 
Œª¥Üt
)

730 
®i¡’”
 *
l
;

732 
l
 = 
li¡’”_li¡
.
Ãxt
;† != &listener_list;† =†->next) {

733 ià(!
	`¡rcmp
(
loÿl_Çme
, 
l
->local_name) &&

734 !
	`¡rcmp
(
cÚÃù_to
, 
l
->connect_to) &&

735 
l
->
Œª¥Üt
 &&†->transport ==ransport) {

737 
	`li¡’”_discÚÃù
(
l
, 
Œª¥Üt
);

743 
	}
}

745 
	$š¡®l_li¡’”
(cÚ¡ *
loÿl_Çme
, cÚ¡ *
cÚÃù_to
, 
©¿n¥Üt
* 
Œª¥Üt
)

747 
®i¡’”
 *
l
;

751 
l
 = 
li¡’”_li¡
.
Ãxt
;† != &listener_list;† =†->next){

752 if(
	`¡rcmp
(
loÿl_Çme
, 
l
->local_name) == 0) {

753 *
ùo
;

756 if(
l
->
cÚÃù_to
[0] == '*') {

760 
ùo
 = 
	`¡rdup
(
cÚÃù_to
);

761 if(
ùo
 == 0) {

766 
	`ä“
((*è
l
->
cÚÃù_to
);

767 
l
->
cÚÃù_to
 = 
ùo
;

768 ià(
l
->
Œª¥Üt
 !=ransport) {

769 
	`»move_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

770 
l
->
Œª¥Üt
 =ransport;

771 
	`add_Œª¥Üt_discÚÃù
(
l
->
Œª¥Üt
, &l->
discÚÃù
);

777 if((
l
 = 
	`ÿÎoc
(1, (
®i¡’”
))è=ğ0è
nomem
;

778 if((
l
->
loÿl_Çme
 = 
	`¡rdup
Öoÿl_Çme)è=ğ0è
nomem
;

779 if((
l
->
cÚÃù_to
 = 
	`¡rdup
(cÚÃù_to)è=ğ0è
nomem
;

782 
l
->
fd
 = 
	`loÿl_Çme_to_fd
(
loÿl_Çme
);

783 if(
l
->
fd
 < 0) {

784 
	`ä“
((*è
l
->
loÿl_Çme
);

785 
	`ä“
((*è
l
->
cÚÃù_to
);

786 
	`ä“
(
l
);

787 
	`´štf
("ÿÂÙ bšd '%s'\n", 
loÿl_Çme
);

791 
	`şo£_Ú_exec
(
l
->
fd
);

792 if(!
	`¡rcmp
(
l
->
cÚÃù_to
, "*smartsocket*")) {

793 
	`fdev’t_š¡®l
(&
l
->
fde
,†->
fd
, 
ss_li¡’”_ev’t_func
,†);

795 
	`fdev’t_š¡®l
(&
l
->
fde
,†->
fd
, 
li¡’”_ev’t_func
,†);

797 
	`fdev’t_£t
(&
l
->
fde
, 
FDE_READ
);

799 
l
->
Ãxt
 = &
li¡’”_li¡
;

800 
l
->
´ev
 = 
li¡’”_li¡
.prev;

801 
l
->
Ãxt
->
´ev
 =†;

802 
l
->
´ev
->
Ãxt
 =†;

803 
l
->
Œª¥Üt
 =ransport;

805 ià(
Œª¥Üt
) {

806 
l
->
discÚÃù
.
İaque
 =†;

807 
l
->
discÚÃù
.
func
 = 
li¡’”_discÚÃù
;

808 
	`add_Œª¥Üt_discÚÃù
(
Œª¥Üt
, &
l
->
discÚÃù
);

812 
nomem
:

813 
	`çl
("cannot‡llocate†istener");

815 
	}
}

817 #ifdeà
HAVE_WIN32_PROC


818 
BOOL
 
WINAPI
 
	$ù¾c_hªdËr
(
DWORD
 
ty³
)

820 
	`ex™
(
STATUS_CONTROL_C_EXIT
);

821  
TRUE
;

822 
	}
}

825 
	$adb_ş—nup
()

827 
	`usb_ş—nup
();

828 
	}
}

830 
	$¡¬t_loggšg
()

832 #ifdeà
HAVE_WIN32_PROC


833 
‹mp
[ 
MAX_PATH
 ];

834 
FILE
* 
âul
;

835 
FILE
* 
æog
;

837 
	`G‘TempP©h
Ğ(
‹mp
) - 8,emp );

838 
	`¡rÿt
Ğ
‹mp
, "adb.log" );

841 
âul
 = 
	`fİ’
( "NUL", "rt" );

842 ià(
âul
 !ğ
NULL
)

843 
¡dš
[0] = 
âul
[0];

845 
æog
 = 
	`fİ’
Ğ
‹mp
, "at" );

846 ià(
æog
 =ğ
NULL
)

847 
æog
 = 
âul
;

849 
	`£tvbuf
Ğ
æog
, 
NULL
, 
_IONBF
, 0 );

851 
¡dout
[0] = 
æog
[0];

852 
¡d”r
[0] = 
æog
[0];

853 
	`årštf
(
¡d”r
,"---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

855 
fd
;

857 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_RDONLY
);

858 
	`dup2
(
fd
, 0);

859 
	`adb_şo£
(
fd
);

861 
fd
 = 
	`unix_İ’
("/tmp/adb.log", 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
, 0640);

862 if(
fd
 < 0) {

863 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_WRONLY
);

865 
	`dup2
(
fd
, 1);

866 
	`dup2
(
fd
, 2);

867 
	`adb_şo£
(
fd
);

868 
	`årštf
(
¡d”r
,"---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

870 
	}
}

872 #ià!
ADB_HOST


873 
	$¡¬t_deviû_log
()

875 
fd
;

876 
·th
[
PATH_MAX
];

877 
tm
 
now
;

878 
time_t
 
t
;

879 
v®ue
[
PROPERTY_VALUE_MAX
];

883 
	`´İ”ty_g‘
("³rsi¡.adb.Œaû_mask", 
v®ue
, "");

884 ià(
	`ssÿnf
(
v®ue
, "%x", &
adb_Œaû_mask
) != 1)

887 
	`adb_mkdœ
("/data/adb", 0775);

888 
	`tz£t
();

889 
	`time
(&
t
);

890 
	`loÿÉime_r
(&
t
, &
now
);

891 
	`¡ráime
(
·th
, (path),

893 &
now
);

894 
fd
 = 
	`unix_İ’
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0640);

895 ià(
fd
 < 0)

899 
	`dup2
(
fd
, 1);

900 
	`dup2
(
fd
, 2);

901 
	`årštf
(
¡d”r
,"---‡db s¹šg (pid %dè---\n", 
	`g‘pid
());

902 
	`adb_şo£
(
fd
);

904 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_RDONLY
);

905 
	`dup2
(
fd
, 0);

906 
	`adb_şo£
(
fd
);

907 
	}
}

910 #ià
ADB_HOST


911 
	$Ïunch_£rv”
(
£rv”_pÜt
)

913 #ifdeà
HAVE_WIN32_PROC


918 
HANDLE
 
pe_»ad
, 
pe_wr™e
;

919 
SECURITY_ATTRIBUTES
 
§
;

920 
STARTUPINFO
 
¡¬tup
;

921 
PROCESS_INFORMATION
 
pšfo
;

922 
´og¿m_·th
[ 
MAX_PATH
 ];

923 
»t
;

925 
§
.
nL’gth
 = (sa);

926 
§
.
ÍSecur™yDesütÜ
 = 
NULL
;

927 
§
.
bInh”™HªdË
 = 
TRUE
;

930 
»t
 = 
	`C»©ePe
Ğ&
pe_»ad
, &
pe_wr™e
, &
§
, 0 );

931 ià(!
»t
) {

932 
	`årštf
(
¡d”r
, "C»©ePe(èçu»,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

936 
	`S‘HªdËInfÜm©iÚ
Ğ
pe_»ad
, 
HANDLE_FLAG_INHERIT
, 0 );

938 
	`Z”oMemÜy
Ğ&
¡¬tup
, (startup) );

939 
¡¬tup
.
cb
 = (startup);

940 
¡¬tup
.
hStdIÅut
 = 
	`G‘StdHªdË
Ğ
STD_INPUT_HANDLE
 );

941 
¡¬tup
.
hStdOuut
 = 
pe_wr™e
;

942 
¡¬tup
.
hStdE¼Ü
 = 
	`G‘StdHªdË
Ğ
STD_ERROR_HANDLE
 );

943 
¡¬tup
.
dwFÏgs
 = 
STARTF_USESTDHANDLES
;

945 
	`Z”oMemÜy
Ğ&
pšfo
, (pinfo) );

948 
	`G‘ModuËFeName
Ğ
NULL
, 
´og¿m_·th
, (program_path) );

950 
»t
 = 
	`C»©eProûss
(

951 
´og¿m_·th
,

955 
NULL
,

956 
NULL
,

957 
TRUE
,

958 
DETACHED_PROCESS
,

959 
NULL
,

960 
NULL
,

961 &
¡¬tup
,

962 &
pšfo
 );

964 
	`Clo£HªdË
Ğ
pe_wr™e
 );

966 ià(!
»t
) {

967 
	`årštf
(
¡d”r
, "C»©eProûs çu»,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

968 
	`Clo£HªdË
Ğ
pe_»ad
 );

972 
	`Clo£HªdË
Ğ
pšfo
.
hProûss
 );

973 
	`Clo£HªdË
Ğ
pšfo
.
hTh»ad
 );

977 
‹mp
[3];

978 
DWORD
 
couÁ
;

980 
»t
 = 
	`R—dFe
Ğ
pe_»ad
, 
‹mp
, 3, &
couÁ
, 
NULL
 );

981 
	`Clo£HªdË
Ğ
pe_»ad
 );

982 iàĞ!
»t
 ) {

983 
	`årštf
(
¡d”r
, "could‚Ù„—d ok from ADB S”v”,ƒ¼Ü = %ld\n", 
	`G‘La¡E¼Ü
() );

986 ià(
couÁ
 !ğ3 || 
‹mp
[0] != 'O' ||emp[1] != 'K' ||emp[2] != '\n') {

987 
	`årštf
(
¡d”r
, "ADB server didn't ACK\n" );

991 #–ià
	`defšed
(
HAVE_FORKEXEC
)

992 
·th
[
PATH_MAX
];

993 
fd
[2];

997 ià(
	`pe
(
fd
)) {

998 
	`årštf
(
¡d”r
, "pçed iÀÏunch_£rv”,ƒ¼no: %d\n", 
”ºo
);

1001 
	`g‘_my_·th
(
·th
, 
PATH_MAX
);

1002 
pid_t
 
pid
 = 
	`fÜk
();

1003 if(
pid
 < 0)  -1;

1005 ià(
pid
 == 0) {

1010 
	`adb_şo£
(
fd
[0]);

1011 
	`dup2
(
fd
[1], 
STDERR_FILENO
);

1012 
	`adb_şo£
(
fd
[1]);

1015 
»suÉ
 = 
	`exeş
(
·th
, "adb", "fÜk-£rv”", "£rv”", 
NULL
);

1017 
	`årštf
(
¡d”r
, "OOPS!ƒxeş„‘uºed %d,ƒ¼no: %d\n", 
»suÉ
, 
”ºo
);

1021 
‹mp
[3];

1023 
‹mp
[0] = 'A';emp[1] = 'B';emp[2] = 'C';

1025 
	`adb_şo£
(
fd
[1]);

1026 
»t
 = 
	`adb_»ad
(
fd
[0], 
‹mp
, 3);

1027 
§ved_”ºo
 = 
”ºo
;

1028 
	`adb_şo£
(
fd
[0]);

1029 ià(
»t
 < 0) {

1030 
	`årštf
(
¡d”r
, "could‚Ù„—d ok from ADB S”v”,ƒ¼nØğ%d\n", 
§ved_”ºo
);

1033 ià(
»t
 !ğ3 || 
‹mp
[0] != 'O' ||emp[1] != 'K' ||emp[2] != '\n') {

1034 
	`årštf
(
¡d”r
, "ADB server didn't ACK\n" );

1038 
	`£tsid
();

1044 
	}
}

1052 
	$bud_loÿl_Çme
(* 
rg‘_¡r
, 
size_t
 
rg‘_size
, 
£rv”_pÜt
)

1054 
	`¢´štf
(
rg‘_¡r
, 
rg‘_size
, "tı:%d", 
£rv”_pÜt
);

1055 
	}
}

1057 #ià!
ADB_HOST


1058 
	$should_drİ_´iveges
() {

1059 #iâdeà
ALLOW_ADBD_ROOT


1062 
£cu»
 = 0;

1063 
v®ue
[
PROPERTY_VALUE_MAX
];

1068 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
v®ue
, "");

1069 ià(
	`¡rcmp
(
v®ue
, "1") != 0) {

1070 
	`´İ”ty_g‘
("ro.£cu»", 
v®ue
, "1");

1071 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

1073 
£cu»
 = 1;

1077 
	`´İ”ty_g‘
("ro.debuggabË", 
v®ue
, "");

1078 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

1079 
	`´İ”ty_g‘
("£rviû.adb.roÙ", 
v®ue
, "");

1080 ià(
	`¡rcmp
(
v®ue
, "1") == 0) {

1081 
£cu»
 = 0;

1086  
£cu»
;

1088 
	}
}

1091 
	$adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
)

1093 #ià!
ADB_HOST


1094 
pÜt
;

1095 
v®ue
[
PROPERTY_VALUE_MAX
];

1097 
	`umask
(000);

1100 
	`©ex™
(
adb_ş—nup
);

1101 #ifdeà
HAVE_WIN32_PROC


1102 
	`S‘CÚsŞeCŒlHªdËr
Ğ
ù¾c_hªdËr
, 
TRUE
 );

1103 #–ià
	`defšed
(
HAVE_FORKEXEC
)

1105 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1108 
	`š™_Œª¥Üt_»gi¡¿tiÚ
();

1110 #ià
ADB_HOST


1111 
HOST
 = 1;

1112 
	`usb_v’dÜs_š™
();

1113 
	`usb_š™
();

1114 
	`loÿl_š™
(
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
);

1115 
	`adb_auth_š™
();

1117 
loÿl_Çme
[30];

1118 
	`bud_loÿl_Çme
(
loÿl_Çme
, Öoÿl_Çme), 
£rv”_pÜt
);

1119 if(
	`š¡®l_li¡’”
(
loÿl_Çme
, "*sm¬tsock‘*", 
NULL
)) {

1120 
	`ex™
(1);

1123 
	`´İ”ty_g‘
("ro.adb.£cu»", 
v®ue
, "0");

1124 
auth_’abËd
 = !
	`¡rcmp
(
v®ue
, "1");

1125 ià(
auth_’abËd
)

1126 
	`adb_auth_š™
();

1130 cÚ¡ * 
adb_ex‹º®_¡Üage
 = 
	`g‘’v
("ADB_EXTERNAL_STORAGE");

1131 ià(
NULL
 !ğ
adb_ex‹º®_¡Üage
) {

1132 
	`£‹nv
("EXTERNAL_STORAGE", 
adb_ex‹º®_¡Üage
, 1);

1134 
	`D
("Warning: ADB_EXTERNAL_STORAGE is‚ot set. Leaving EXTERNAL_STORAGE"

1140 ià(
	`should_drİ_´iveges
()) {

1141 
__u£r_ÿp_h—d”_¡ruù
 
h—d”
;

1142 
__u£r_ÿp_d©a_¡ruù
 
ÿp
;

1144 ià(
	`´ùl
(
PR_SET_KEEPCAPS
, 1, 0, 0, 0) != 0) {

1145 
	`ex™
(1);

1160 
gid_t
 
groups
[] = { 
AID_ADB
, 
AID_LOG
, 
AID_INPUT
, 
AID_INET
, 
AID_GRAPHICS
,

1161 
AID_NET_BT
, 
AID_NET_BT_ADMIN
, 
AID_SDCARD_R
, 
AID_SDCARD_RW
,

1162 
AID_MOUNT
, 
AID_NET_BW_STATS
 };

1163 ià(
	`£tgroups
((
groups
)/(groups[0]), groups) != 0) {

1164 
	`ex™
(1);

1168 ià(
	`£tgid
(
AID_SHELL
) != 0) {

1169 
	`ex™
(1);

1171 ià(
	`£tuid
(
AID_SHELL
) != 0) {

1172 
	`ex™
(1);

1176 
h—d”
.
v”siÚ
 = 
_LINUX_CAPABILITY_VERSION
;

1177 
h—d”
.
pid
 = 0;

1178 
ÿp
.
efãùive
 = c­.
³rm™‹d
 = (1 << 
CAP_SYS_BOOT
);

1179 
ÿp
.
šh”™abË
 = 0;

1180 
	`ÿp£t
(&
h—d”
, &
ÿp
);

1182 
	`D
("Local…ort disabled\n");

1184 
loÿl_Çme
[30];

1185 
	`bud_loÿl_Çme
(
loÿl_Çme
, Öoÿl_Çme), 
£rv”_pÜt
);

1186 if(
	`š¡®l_li¡’”
(
loÿl_Çme
, "*sm¬tsock‘*", 
NULL
)) {

1187 
	`ex™
(1);

1191 
usb
 = 0;

1192 ià(
	`acûss
(
USB_ADB_PATH
, 
F_OK
è=ğ0 ||‡cûss(
USB_FFS_ADB_EP0
, F_OK) == 0) {

1194 
	`usb_š™
();

1195 
usb
 = 1;

1201 
	`´İ”ty_g‘
("£rviû.adb.tı.pÜt", 
v®ue
, "");

1202 ià(!
v®ue
[0]) {

1203 
	`´İ”ty_g‘
("³rsi¡.adb.tı.pÜt", 
v®ue
, "");

1205 ià(
	`ssÿnf
(
v®ue
, "%d", &
pÜt
) == 1 &&…ort > 0) {

1206 
	`´štf
("usšg…Üt=%d\n", 
pÜt
);

1208 
	`loÿl_š™
(
pÜt
);

1209 } ià(!
usb
) {

1211 
	`loÿl_š™
(
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
);

1214 
	`D
("adb_main():…re init_jdwp()\n");

1215 
	`š™_jdwp
();

1216 
	`D
("adb_main():…ost init_jdwp()\n");

1219 ià(
is_d«mÚ
)

1222 #ifdeà
HAVE_WIN32_PROC


1223 
DWORD
 
couÁ
;

1224 
	`Wr™eFe
Ğ
	`G‘StdHªdË
Ğ
STD_OUTPUT_HANDLE
 ), "OK\n", 3, &
couÁ
, 
NULL
 );

1225 #–ià
	`defšed
(
HAVE_FORKEXEC
)

1226 
	`årštf
(
¡d”r
, "OK\n");

1228 
	`¡¬t_loggšg
();

1230 
	`D
("Event†oop starting\n");

1232 
	`fdev’t_loİ
();

1234 
	`usb_ş—nup
();

1237 
	}
}

1239 #ià
ADB_HOST


1240 
	$cÚÃù_deviû
(* 
ho¡
, * 
bufãr
, 
bufãr_size
)

1242 
pÜt
, 
fd
;

1243 * 
pÜt¡r
 = 
	`¡rchr
(
ho¡
, ':');

1244 
ho¡buf
[100];

1245 
£rŸl
[100];

1247 
	`¡ºıy
(
ho¡buf
, 
ho¡
, (hostbuf) - 1);

1248 ià(
pÜt¡r
) {

1249 ià(
pÜt¡r
 - 
ho¡
 >ğ(
±rdiff_t
)(
ho¡buf
)) {

1250 
	`¢´štf
(
bufãr
, 
bufãr_size
, "bad ho¡‚am%s", 
ho¡
);

1254 
ho¡buf
[
pÜt¡r
 - 
ho¡
] = 0;

1255 ià(
	`ssÿnf
(
pÜt¡r
 + 1, "%d", &
pÜt
) == 0) {

1256 
	`¢´štf
(
bufãr
, 
bufãr_size
, "bad…Üˆnumb” %s", 
pÜt¡r
);

1260 
pÜt
 = 
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
;

1263 
	`¢´štf
(
£rŸl
, (£rŸl), "%s:%d", 
ho¡buf
, 
pÜt
);

1264 ià(
	`fšd_Œª¥Üt
(
£rŸl
)) {

1265 
	`¢´štf
(
bufãr
, 
bufãr_size
, "®»ady cÚÃùedØ%s", 
£rŸl
);

1269 
fd
 = 
	`sock‘_ÃtwÜk_ş›Á
(
ho¡buf
, 
pÜt
, 
SOCK_STREAM
);

1270 ià(
fd
 < 0) {

1271 
	`¢´štf
(
bufãr
, 
bufãr_size
, "uÇbËØcÚÃùØ%s:%d", 
ho¡
, 
pÜt
);

1275 
	`D
("ş›Á: cÚÃùed oÀ»mÙÚ fd %d\n", 
fd
);

1276 
	`şo£_Ú_exec
(
fd
);

1277 
	`di§bË_tı_ÇgË
(
fd
);

1278 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, 
£rŸl
, 
pÜt
, 0);

1279 
	`¢´štf
(
bufãr
, 
bufãr_size
, "cÚÃùedØ%s", 
£rŸl
);

1280 
	}
}

1282 
	$cÚÃù_emuÏtÜ
(* 
pÜt_¥ec
, * 
bufãr
, 
bufãr_size
)

1284 * 
pÜt_£·¿tÜ
 = 
	`¡rchr
(
pÜt_¥ec
, ',');

1285 ià(!
pÜt_£·¿tÜ
) {

1286 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1288 
pÜt_¥ec
);

1293 *
pÜt_£·¿tÜ
++ = 0;

1294 
cÚsŞe_pÜt
 = 
	`¡¹Ş
(
pÜt_¥ec
, 
NULL
, 0);

1295 
adb_pÜt
 = 
	`¡¹Ş
(
pÜt_£·¿tÜ
, 
NULL
, 0);

1296 ià(!(
cÚsŞe_pÜt
 > 0 && 
adb_pÜt
 > 0)) {

1297 *(
pÜt_£·¿tÜ
 - 1) = ',';

1298 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1300 
pÜt_¥ec
);

1311 
©¿n¥Üt
* 
known_emuÏtÜ
 = 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
);

1312 ià(
known_emuÏtÜ
 !ğ
NULL
) {

1313 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1314 "EmuÏtÜ oÀpÜˆ%d‡Ì—dy„egi¡”ed.", 
adb_pÜt
);

1320 
ÿndid©e_¦Ù
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex
();

1321 ià(
ÿndid©e_¦Ù
 < 0) {

1322 
	`¢´štf
(
bufãr
, 
bufãr_size
, "Cannot‡ccept moreƒmulators.");

1327 ià(!
	`loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
)) {

1328 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1329 "CÚÃùedØemuÏtÜ oÀpÜt %d,%d", 
cÚsŞe_pÜt
, 
adb_pÜt
);

1331 
	`¢´štf
(
bufãr
, 
bufãr_size
,

1333 
cÚsŞe_pÜt
, 
adb_pÜt
);

1335 
	}
}

1338 
	$hªdË_ho¡_»que¡
(*
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
, 
asock‘
 *
s
)

1340 
©¿n¥Üt
 *
Œª¥Üt
 = 
NULL
;

1341 
buf
[4096];

1343 if(!
	`¡rcmp
(
£rviû
, "kill")) {

1344 
	`årštf
(
¡d”r
,"adb server killed by„emote„equest\n");

1345 
	`fæush
(
¡dout
);

1346 
	`adb_wr™e
(
»¶y_fd
, "OKAY", 4);

1347 
	`usb_ş—nup
();

1348 
	`ex™
(0);

1351 #ià
ADB_HOST


1356 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt", 
	`¡¾’
("transport"))) {

1357 * 
”rÜ_¡ršg
 = "unknown failure";

1358 
Œª¥Üt_ty³
 
ty³
 = 
kT¿n¥ÜtAny
;

1360 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-usb", 
	`¡¾’
("transport-usb"))) {

1361 
ty³
 = 
kT¿n¥ÜtUsb
;

1362 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-loÿl", 
	`¡¾’
("transport-local"))) {

1363 
ty³
 = 
kT¿n¥ÜtLoÿl
;

1364 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt-ªy", 
	`¡¾’
("transport-any"))) {

1365 
ty³
 = 
kT¿n¥ÜtAny
;

1366 } ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt:", 
	`¡¾’
("transport:"))) {

1367 
£rviû
 +ğ
	`¡¾’
("transport:");

1368 
£rŸl
 = 
£rviû
;

1371 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
ty³
, 
£rŸl
, &
”rÜ_¡ršg
);

1373 ià(
Œª¥Üt
) {

1374 
s
->
Œª¥Üt
 =ransport;

1375 
	`adb_wr™e
(
»¶y_fd
, "OKAY", 4);

1377 
	`£ndçmsg
(
»¶y_fd
, 
”rÜ_¡ršg
);

1383 ià(!
	`¡ºcmp
(
£rviû
, "devices", 7)) {

1384 
bufãr
[4096];

1385 
u£_lÚg
 = !
	`¡rcmp
(
£rviû
+7, "-l");

1386 ià(
u£_lÚg
 || 
£rviû
[7] == 0) {

1387 
	`mem£t
(
buf
, 0, (buf));

1388 
	`mem£t
(
bufãr
, 0, (buffer));

1389 
	`D
("Getting device†ist \n");

1390 
	`li¡_Œª¥Üts
(
bufãr
, (bufãr), 
u£_lÚg
);

1391 
	`¢´štf
(
buf
, (buf), "OKAY%04x%s",()
	`¡¾’
(
bufãr
),buffer);

1392 
	`D
("Wrote device†ist \n");

1393 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1399 ià(!
	`¡ºcmp
(
£rviû
, "connect:", 8)) {

1400 
bufãr
[4096];

1401 * 
ho¡
 = 
£rviû
 + 8;

1402 ià(!
	`¡ºcmp
(
ho¡
, "emu:", 4)) {

1403 
	`cÚÃù_emuÏtÜ
(
ho¡
 + 4, 
bufãr
, (buffer));

1405 
	`cÚÃù_deviû
(
ho¡
, 
bufãr
, (buffer));

1408 
	`¢´štf
(
buf
, (buf), "OKAY%04x%s",()
	`¡¾’
(
bufãr
), buffer);

1409 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1414 ià(!
	`¡ºcmp
(
£rviû
, "disconnect:", 11)) {

1415 
bufãr
[4096];

1416 
	`mem£t
(
bufãr
, 0, (buffer));

1417 * 
£rŸl
 = 
£rviû
 + 11;

1418 ià(
£rŸl
[0] == 0) {

1420 
	`uÄegi¡”_®l_tı_Œª¥Üts
();

1422 
ho¡buf
[100];

1424 ià(!
	`¡rchr
(
£rŸl
, ':')) {

1425 
	`¢´štf
(
ho¡buf
, (ho¡bufè- 1, "%s:5555", 
£rŸl
);

1426 
£rŸl
 = 
ho¡buf
;

1428 
©¿n¥Üt
 *
t
 = 
	`fšd_Œª¥Üt
(
£rŸl
);

1430 ià(
t
) {

1431 
	`uÄegi¡”_Œª¥Üt
(
t
);

1433 
	`¢´štf
(
bufãr
, (bufãr), "NØsuch deviû %s", 
£rŸl
);

1437 
	`¢´štf
(
buf
, (buf), "OKAY%04x%s",()
	`¡¾’
(
bufãr
), buffer);

1438 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1443 ià(!
	`¡rcmp
(
£rviû
, "version")) {

1444 
v”siÚ
[12];

1445 
	`¢´štf
(
v”siÚ
,  v”siÚ, "%04x", 
ADB_SERVER_VERSION
);

1446 
	`¢´štf
(
buf
,  buf, "OKAY%04x%s", ()
	`¡¾’
(
v”siÚ
), version);

1447 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1451 if(!
	`¡ºcmp
(
£rviû
,"g‘-£rŸÊo",
	`¡¾’
("get-serialno"))) {

1452 *
out
 = "unknown";

1453 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

1454 ià(
Œª¥Üt
 &&¿n¥Üt->
£rŸl
) {

1455 
out
 = 
Œª¥Üt
->
£rŸl
;

1457 
	`¢´štf
(
buf
,  buf, "OKAY%04x%s",()
	`¡¾’
(
out
),out);

1458 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1461 if(!
	`¡ºcmp
(
£rviû
,"g‘-dev·th",
	`¡¾’
("get-devpath"))) {

1462 *
out
 = "unknown";

1463 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

1464 ià(
Œª¥Üt
 &&¿n¥Üt->
dev·th
) {

1465 
out
 = 
Œª¥Üt
->
dev·th
;

1467 
	`¢´štf
(
buf
,  buf, "OKAY%04x%s",()
	`¡¾’
(
out
),out);

1468 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1472 ià(!
	`¡ºcmp
(
£rviû
,"emulator:",9)) {

1473 
pÜt
 = 
	`©oi
(
£rviû
+9);

1474 
	`loÿl_cÚÃù
(
pÜt
);

1480 if(!
	`¡ºcmp
(
£rviû
,"forward:",8) || !strncmp(service,"killforward:",12)) {

1481 *
loÿl
, *
»mÙe
, *
”r
;

1482 
r
;

1483 
©¿n¥Üt
 *
Œª¥Üt
;

1485 
ü—‹FÜw¬d
 = 
	`¡ºcmp
(
£rviû
,"kill",4);

1487 
loÿl
 = 
£rviû
 + (
ü—‹FÜw¬d
 ? 8 : 12);

1488 
»mÙe
 = 
	`¡rchr
(
loÿl
,';');

1489 if(
»mÙe
 == 0) {

1490 
	`£ndçmsg
(
»¶y_fd
, "malformed forward spec");

1494 *
»mÙe
++ = 0;

1495 if((
loÿl
[0] =ğ0è|| (
»mÙe
[0] == 0) || (remote[0] == '*')){

1496 
	`£ndçmsg
(
»¶y_fd
, "malformed forward spec");

1500 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, &
”r
);

1501 ià(!
Œª¥Üt
) {

1502 
	`£ndçmsg
(
»¶y_fd
, 
”r
);

1506 ià(
ü—‹FÜw¬d
) {

1507 
r
 = 
	`š¡®l_li¡’”
(
loÿl
, 
»mÙe
, 
Œª¥Üt
);

1509 
r
 = 
	`»move_li¡’”
(
loÿl
, 
»mÙe
, 
Œª¥Üt
);

1511 if(
r
 == 0) {

1513 
	`wr™ex
(
»¶y_fd
, "OKAYOKAY", 8);

1517 ià(
ü—‹FÜw¬d
) {

1518 
	`£ndçmsg
(
»¶y_fd
, (
r
 == -1) ? "cannot„ebind smartsocket" : "cannot bind socket");

1520 
	`£ndçmsg
(
»¶y_fd
, "cannot„emove†istener");

1525 if(!
	`¡ºcmp
(
£rviû
,"g‘-¡©e",
	`¡¾’
("get-state"))) {

1526 
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
(
CS_ANY
, 
‰y³
, 
£rŸl
, 
NULL
);

1527 *
¡©e
 = 
	`cÚÃùiÚ_¡©e_Çme
(
Œª¥Üt
);

1528 
	`¢´štf
(
buf
,  buf, "OKAY%04x%s",()
	`¡¾’
(
¡©e
),state);

1529 
	`wr™ex
(
»¶y_fd
, 
buf
, 
	`¡¾’
(buf));

1533 
	}
}

1535 #ià!
ADB_HOST


1536 
	g»cov”y_mode
 = 0;

1539 
	$maš
(
¬gc
, **
¬gv
)

1541 
	`check_ch
();

1542 #ià
ADB_HOST


1543 
	`adb_sysd•s_š™
();

1544 
	`adb_Œaû_š™
();

1545 
	`D
("Handling commandline()\n");

1546  
	`adb_commªdlše
(
¬gc
 - 1, 
¬gv
 + 1);

1550 
	`´štf
("init‡db main\n");

1551 
	`adb_qemu_Œaû_š™
();

1552 if((
¬gc
 > 1è&& (!
	`¡rcmp
(
¬gv
[1],"recovery"))) {

1553 
adb_deviû_bªÃr
 = "recovery";

1554 
»cov”y_mode
 = 1;

1557 
	`¡¬t_deviû_log
();

1558 
	`D
("Handling main()\n");

1559 
	`´štf
("Handling main()\n");

1560  
	`adb_maš
(0, 
DEFAULT_ADB_PORT
);

1562 
	}
}

	@adb.h

17 #iâdeà
__ADB_H


18 
	#__ADB_H


	)

20 
	~<lim™s.h
>

22 
	~"Œª¥Üt.h
"

24 
	#MAX_PAYLOAD
 4096

	)

26 
	#A_SYNC
 0x434e5953

	)

27 
	#A_CNXN
 0x4e584e43

	)

28 
	#A_OPEN
 0x4e45504f

	)

29 
	#A_OKAY
 0x59414b4f

	)

30 
	#A_CLSE
 0x45534c43

	)

31 
	#A_WRTE
 0x45545257

	)

32 
	#A_AUTH
 0x48545541

	)

34 
	#A_VERSION
 0x01000000

35 

	)

36 
	#ADB_VERSION_MAJOR
 1

37 
	#ADB_VERSION_MINOR
 0

38 

	)

39 
	#ADB_SERVER_VERSION
 31

40 

	)

41 
ames§ge
 
	tames§ge
;

42 
­ack‘
 
	t­ack‘
;

43 
asock‘
 
	tasock‘
;

44 
®i¡’”
 
	t®i¡’”
;

45 
a£rviû
 
	ta£rviû
;

46 
©¿n¥Üt
 
	t©¿n¥Üt
;

47 
adiscÚÃù
 
	tadiscÚÃù
;

48 
usb_hªdË
 
	tusb_hªdË
;

50 
	sames§ge
 {

51 
	mcommªd
;

52 
	m¬g0
;

53 
	m¬g1
;

54 
	md©a_Ëngth
;

55 
	md©a_check
;

56 
	mmagic
;

59 
	s­ack‘


61 
­ack‘
 *
	mÃxt
;

63 
	mËn
;

64 *
	m±r
;

66 
ames§ge
 
	mmsg
;

67 
	md©a
[
MAX_PAYLOAD
];

74 
	sasock‘
 {

78 
asock‘
 *
	mÃxt
;

79 
asock‘
 *
	m´ev
;

83 
	mid
;

88 
	mşosšg
;

93 
	mex™_Ú_şo£
;

98 
asock‘
 *
	m³”
;

104 
fdev’t
 
	mfde
;

105 
	mfd
;

109 
­ack‘
 *
	mpkt_fœ¡
;

110 
­ack‘
 *
	mpkt_Ï¡
;

118 (*
	m’queue
)(
asock‘
 *
	ms
, 
­ack‘
 *
	mpkt
);

123 (*
	m»ady
)(
asock‘
 *
	ms
);

129 (*
	mşo£
)(
asock‘
 *
	ms
);

132 *
	mexŒa
;

135 
©¿n¥Üt
 *
	mŒª¥Üt
;

144 
	sadiscÚÃù


146 (*
	mfunc
)(* 
	mİaque
, 
©¿n¥Üt
* 
	mt
);

147 * 
	mİaque
;

148 
adiscÚÃù
* 
	mÃxt
;

149 
adiscÚÃù
* 
	m´ev
;

162 
	eŒª¥Üt_ty³
 {

163 
	mkT¿n¥ÜtUsb
,

164 
	mkT¿n¥ÜtLoÿl
,

165 
	mkT¿n¥ÜtAny
,

166 
	mkT¿n¥ÜtHo¡
,

167 } 
	tŒª¥Üt_ty³
;

169 
	#TOKEN_SIZE
 20

	)

171 
	s©¿n¥Üt


173 
©¿n¥Üt
 *
	mÃxt
;

174 
©¿n¥Üt
 *
	m´ev
;

176 (*
	m»ad_äom_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

177 (*
	mwr™e_to_»mÙe
)(
­ack‘
 *
	mp
, 
©¿n¥Üt
 *
	mt
);

178 (*
	mşo£
)(
©¿n¥Üt
 *
	mt
);

179 (*
	mkick
)(
©¿n¥Üt
 *
	mt
);

181 
	mfd
;

182 
	mŒª¥Üt_sock‘
;

183 
fdev’t
 
	mŒª¥Üt_fde
;

184 
	m»f_couÁ
;

185 
	msync_tok’
;

186 
	mcÚÃùiÚ_¡©e
;

187 
	mÚlše
;

188 
Œª¥Üt_ty³
 
	mty³
;

191 
usb_hªdË
 *
	musb
;

192 
	msfd
;

195 *
	m£rŸl
;

196 *
	m´oduù
;

197 *
	mmod–
;

198 *
	mdeviû
;

199 *
	mdev·th
;

200 
	madb_pÜt
;

203 
	mkicked
;

204 
adiscÚÃù
 
	mdiscÚÃùs
;

206 *
	mkey
;

207 
	mtok’
[
TOKEN_SIZE
];

208 
fdev’t
 
	mauth_fde
;

209 
	mçed_auth_©‹m±s
;

222 
	s®i¡’”


224 
®i¡’”
 *
	mÃxt
;

225 
®i¡’”
 *
	m´ev
;

227 
fdev’t
 
	mfde
;

228 
	mfd
;

230 cÚ¡ *
	mloÿl_Çme
;

231 cÚ¡ *
	mcÚÃù_to
;

232 
©¿n¥Üt
 *
	mŒª¥Üt
;

233 
adiscÚÃù
 
	mdiscÚÃù
;

237 
´št_·ck‘
(cÚ¡ *
Ïb–
, 
­ack‘
 *
p
);

239 
asock‘
 *
fšd_loÿl_sock‘
(
id
);

240 
š¡®l_loÿl_sock‘
(
asock‘
 *
s
);

241 
»move_sock‘
(
asock‘
 *
s
);

242 
şo£_®l_sock‘s
(
©¿n¥Üt
 *
t
);

244 
	#LOCAL_CLIENT_PREFIX
 "emuÏtÜ-"

	)

246 
asock‘
 *
ü—‹_loÿl_sock‘
(
fd
);

247 
asock‘
 *
ü—‹_loÿl_£rviû_sock‘
(cÚ¡ *
de¡š©iÚ
);

249 
asock‘
 *
ü—‹_»mÙe_sock‘
(
id
, 
©¿n¥Üt
 *
t
);

250 
cÚÃù_to_»mÙe
(
asock‘
 *
s
, cÚ¡ *
de¡š©iÚ
);

251 
cÚÃù_to_sm¬tsock‘
(
asock‘
 *
s
);

253 
çl
(cÚ¡ *
fmt
, ...);

254 
çl_”ºo
(cÚ¡ *
fmt
, ...);

256 
hªdË_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
);

257 
£nd_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
);

259 
g‘_my_·th
(*
s
, 
size_t
 
maxL’
);

260 
Ïunch_£rv”
(
£rv”_pÜt
);

261 
adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
);

267 
š™_Œª¥Üt_»gi¡¿tiÚ
();

268 
li¡_Œª¥Üts
(*
buf
, 
size_t
 
bufsize
, 
lÚg_li¡šg
);

269 
upd©e_Œª¥Üts
();

271 
asock‘
* 
ü—‹_deviû_Œack”
();

278 
©¿n¥Üt
 *
acquœe_Úe_Œª¥Üt
(
¡©e
, 
Œª¥Üt_ty³
 
‰y³
, cÚ¡ * 
£rŸl
, **
”rÜ_out
);

279 
add_Œª¥Üt_discÚÃù
Ğ
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
 );

280 
»move_Œª¥Üt_discÚÃù
Ğ
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
 );

281 
run_Œª¥Üt_discÚÃùs
Ğ
©¿n¥Üt
* 
t
 );

282 
kick_Œª¥Üt
Ğ
©¿n¥Üt
* 
t
 );

285 #ià
ADB_HOST


286 
g‘_avaabË_loÿl_Œª¥Üt_šdex
();

288 
š™_sock‘_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
s
, 
pÜt
, 
loÿl
);

289 
š™_usb_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
usb_hªdË
 *
usb
, 
¡©e
);

292 
şo£_usb_deviûs
();

295 
»gi¡”_sock‘_Œª¥Üt
(
s
, cÚ¡ *
£rŸl
, 
pÜt
, 
loÿl
);

298 
uÄegi¡”_Œª¥Üt
(
©¿n¥Üt
 *
t
);

299 
uÄegi¡”_®l_tı_Œª¥Üts
();

301 
»gi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
h
, cÚ¡ *
£rŸl
, cÚ¡ *
dev·th
, 
wr™—bË
);

304 
uÄegi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
usb
);

306 
©¿n¥Üt
 *
fšd_Œª¥Üt
(cÚ¡ *
£rŸl
);

307 #ià
ADB_HOST


308 
©¿n¥Üt
* 
fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
);

311 
£rviû_to_fd
(cÚ¡ *
Çme
);

312 #ià
ADB_HOST


313 
asock‘
 *
ho¡_£rviû_to_sock‘
(cÚ¡ * 
Çme
, cÚ¡ *
£rŸl
);

316 #ià!
ADB_HOST


317 
š™_jdwp
();

318 
asock‘
* 
ü—‹_jdwp_£rviû_sock‘
();

319 
asock‘
* 
ü—‹_jdwp_Œack”_£rviû_sock‘
();

320 
ü—‹_jdwp_cÚÃùiÚ_fd
(
jdwp_pid
);

323 #ià!
ADB_HOST


325 
	mBACKUP
,

326 
	mRESTORE


327 } 
	tBackupO³¿tiÚ
;

328 
backup_£rviû
(
BackupO³¿tiÚ
 
İ”©iÚ
, * 
¬gs
);

329 
äamebufãr_£rviû
(
fd
, *
cook›
);

330 
log_£rviû
(
fd
, *
cook›
);

331 
»mouÁ_£rviû
(
fd
, *
cook›
);

332 * 
g‘_log_fe_·th
(cÚ¡ * 
log_Çme
);

336 
­ack‘
 *
g‘_­ack‘
();

337 
put_­ack‘
(
­ack‘
 *
p
);

339 
check_h—d”
(
­ack‘
 *
p
);

340 
check_d©a
(
­ack‘
 *
p
);

344 
	#ADB_TRACE
 1

	)

351 
	mTRACE_ADB
 = 0,

352 
	mTRACE_SOCKETS
,

353 
	mTRACE_PACKETS
,

354 
	mTRACE_TRANSPORT
,

355 
	mTRACE_RWX
,

356 
	mTRACE_USB
,

357 
	mTRACE_SYNC
,

358 
	mTRACE_SYSDEPS
,

359 
	mTRACE_JDWP
,

360 
	mTRACE_SERVICES
,

361 
	mTRACE_AUTH
,

362 } 
	tAdbT¿û
;

364 #ià
ADB_TRACE


366 #ià!
ADB_HOST


374 
adb_qemu_Œaû
(cÚ¡ * 
fmt
, ...);

376 
	#DQ
(...è
	`adb_qemu_Œaû
(
__VA_ARGS__
)

	)

378 
	#DQ
(...è(()0)

	)

381 
adb_Œaû_mask
;

382 
adb_Œaû_ouut_couÁ
;

383 
adb_Œaû_š™
();

385 
	#ADB_TRACING
 ((
adb_Œaû_mask
 & (1 << 
TRACE_TAG
)è!ğ0)

	)

388 
	#D
(...) \

390 
	`´štf
("[adbd D]"
__VA_ARGS__
); \

391 ià(
ADB_TRACING
) { \

392 
§ve_”ºo
 = 
”ºo
; \

393 
	`adb_mu‹x_lock
(&
D_lock
); \

394 
	`årštf
(
¡d”r
, "%s::%s():", \

395 
__FILE__
, 
__FUNCTION__
); \

396 
”ºo
 = 
§ve_”ºo
; \

397 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

398 
	`fæush
(
¡d”r
); \

399 
	`adb_mu‹x_uÆock
(&
D_lock
); \

400 
”ºo
 = 
§ve_”ºo
; \

402 } 0)

	)

403 
	#DR
(...) \

405 
	`´štf
("[adbd DR]"
__VA_ARGS__
); \

406 ià(
ADB_TRACING
) { \

407 
§ve_”ºo
 = 
”ºo
; \

408 
	`adb_mu‹x_lock
(&
D_lock
); \

409 
”ºo
 = 
§ve_”ºo
; \

410 
	`årštf
(
¡d”r
, 
__VA_ARGS__
 ); \

411 
	`fæush
(
¡d”r
); \

412 
	`adb_mu‹x_uÆock
(&
D_lock
); \

413 
”ºo
 = 
§ve_”ºo
; \

415 } 0)

	)

417 
	#D
(...è(()0)

	)

418 
	#DR
(...è(()0)

	)

419 
	#ADB_TRACING
 0

	)

423 #ià!
DEBUG_PACKETS


424 
	#´št_·ck‘
(
g
,
p
èdØ{} 0)

	)

427 #ià
ADB_HOST_ON_TARGET


431 
	#DEFAULT_ADB_PORT
 5038

	)

433 
	#DEFAULT_ADB_PORT
 5037

	)

436 
	#DEFAULT_ADB_LOCAL_TRANSPORT_PORT
 5555

	)

438 
	#ADB_CLASS
 0xff

	)

439 
	#ADB_SUBCLASS
 0x42

	)

440 
	#ADB_PROTOCOL
 0x1

	)

443 
loÿl_š™
(
pÜt
);

444 
loÿl_cÚÃù
(
pÜt
);

445 
loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
);

448 
usb_š™
();

449 
usb_ş—nup
();

450 
usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
);

451 
usb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
);

452 
usb_şo£
(
usb_hªdË
 *
h
);

453 
usb_kick
(
usb_hªdË
 *
h
);

456 #ià
ADB_HOST


457 
is_adb_š‹rçû
(
vid
, 
pid
, 
usb_şass
, 
usb_subşass
, 
usb_´ÙocŞ
);

460 
ho¡_to_Ë32
(
n
);

461 
adb_commªdlše
(
¬gc
, **
¬gv
);

463 
cÚÃùiÚ_¡©e
(
©¿n¥Üt
 *
t
);

465 
	#CS_ANY
 -1

	)

466 
	#CS_OFFLINE
 0

	)

467 
	#CS_BOOTLOADER
 1

	)

468 
	#CS_DEVICE
 2

	)

469 
	#CS_HOST
 3

	)

470 
	#CS_RECOVERY
 4

	)

471 
	#CS_NOPERM
 5

	)

472 
	#CS_SIDELOAD
 6

	)

474 
HOST
;

475 
SHELL_EXIT_NOTIFY_FD
;

477 
	#CHUNK_SIZE
 (64*1024)

	)

479 #ià!
ADB_HOST


480 
	#USB_ADB_PATH
 "/dev/ªdroid_adb"

	)

482 
	#USB_FFS_ADB_PATH
 "/dev/usb-ffs/adb/"

	)

483 
	#USB_FFS_ADB_EP
(
x
è
USB_FFS_ADB_PATH
#x

	)

485 
	#USB_FFS_ADB_EP0
 
	`USB_FFS_ADB_EP
(
•0
)

	)

486 
	#USB_FFS_ADB_OUT
 
	`USB_FFS_ADB_EP
(
•1
)

	)

487 
	#USB_FFS_ADB_IN
 
	`USB_FFS_ADB_EP
(
•2
)

	)

490 
£ndçmsg
(
fd
, cÚ¡ *
»asÚ
);

491 
hªdË_ho¡_»que¡
(*
£rviû
, 
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, 
»¶y_fd
, 
asock‘
 *
s
);

	@adb_auth.h

17 #iâdeà
__ADB_AUTH_H


18 
	#__ADB_AUTH_H


	)

20 
adb_auth_š™
();

21 
adb_auth_v”if›d
(
©¿n¥Üt
 *
t
);

25 
	#ADB_AUTH_TOKEN
 1

	)

27 
	#ADB_AUTH_SIGNATURE
 2

	)

28 
	#ADB_AUTH_RSAPUBLICKEY
 3

	)

30 #ià
ADB_HOST


32 
adb_auth_sign
(*
key
, *
tok’
, 
size_t
 
tok’_size
, *
sig
);

33 *
adb_auth_Ãxtkey
(*
cu¼’t
);

34 
adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
);

36 
šlše
 
	$adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
è{  0; 
	}
}

37 
šlše
 
	$adb_auth_v”ify
(*
tok’
, *
sig
, 
sigËn
è{  0; 
	}
}

38 
šlše
 
	$adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
è{ 
	}
}

39 
šlše
 
	$adb_auth_»lßd_keys
(è{ 
	}
}

43 
šlše
 
	$adb_auth_sign
(* 
key
, *
tok’
, 
size_t
 
tok’_size
, *
sig
è{  0; 
	}
}

44 
šlše
 *
	$adb_auth_Ãxtkey
(*
cu¼’t
è{  
NULL
; 
	}
}

45 
šlše
 
	$adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
è{  0; 
	}
}

47 
adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
);

48 
adb_auth_v”ify
(*
tok’
, *
sig
, 
sigËn
);

49 
adb_auth_cÚfœm_key
(*
d©a
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
);

50 
adb_auth_»lßd_keys
();

	@adb_auth_client.c

17 
	~<¡dio.h
>

18 
	~<¡ršg.h
>

19 
	~<»sŞv.h
>

20 
	~<cuts/li¡.h
>

21 
	~<cuts/sock‘s.h
>

23 
	~"sysd•s.h
"

24 
	~"adb.h
"

25 
	~"adb_auth.h
"

26 
	~"fdev’t.h
"

27 
	~"mšüy±/r§.h
"

29 
	#TRACE_TAG
 
TRACE_AUTH


	)

32 
	sadb_public_key
 {

33 
li¡node
 
	mnode
;

34 
RSAPublicKey
 
	mkey
;

37 
li¡node
 
	gkey_li¡
;

39 *
	gkey_·ths
[] = {

42 
NULL


45 
fdev’t
 
	gli¡’”_fde
;

46 
	gäamewÜk_fd
 = -1;

49 
	$»ad_keys
(cÚ¡ *
fe
, 
li¡node
 *
li¡
)

51 
adb_public_key
 *
key
;

52 
FILE
 *
f
;

53 
buf
[
MAX_PAYLOAD
];

54 *
£p
;

55 
»t
;

57 
f
 = 
	`fİ’
(
fe
, "r");

58 ià(!
f
) {

59 
	`D
("Cª'ˆİ’ '%s'\n", 
fe
);

63 
	`fg‘s
(
buf
, (buf), 
f
)) {

65 
key
 = 
	`ÿÎoc
(1, (*key) + 4);

66 ià(!
key
) {

67 
	`D
("Can't malloc key\n");

71 
£p
 = 
	`¡½brk
(
buf
, " \t");

72 ià(
£p
)

73 *
£p
 = '\0';

75 ià(
»t
 !ğ(
key
->key)) {

76 
	`D
("%s: Inv®id ba£64 d©¨»t=%d\n", 
fe
, 
»t
);

77 
	`ä“
(
key
);

81 ià(
key
->key.
Ën
 !ğ
RSANUMWORDS
) {

82 
	`D
("%s: Inv®id key†’ %d\n", 
fe
, 
key
->key.
Ën
);

83 
	`ä“
(
key
);

87 
	`li¡_add_
(
li¡
, &
key
->
node
);

90 
	`fşo£
(
f
);

91 
	}
}

93 
	$ä“_keys
(
li¡node
 *
li¡
)

95 
li¡node
 *
™em
;

97 !
	`li¡_em±y
(
li¡
)) {

98 
™em
 = 
	`li¡_h—d
(
li¡
);

99 
	`li¡_»move
(
™em
);

100 
	`ä“
(
	`node_to_™em
(
™em
, 
adb_public_key
, 
node
));

102 
	}
}

104 
	$adb_auth_»lßd_keys
()

106 *
·th
;

107 **
·ths
 = 
key_·ths
;

108 
¡©
 
buf
;

110 
	`ä“_keys
(&
key_li¡
);

112 (
·th
 = *
·ths
++)) {

113 ià(!
	`¡©
(
·th
, &
buf
)) {

114 
	`D
("Lßdšg key äom '%s'\n", 
·th
);

115 
	`»ad_keys
(
·th
, &
key_li¡
);

118 
	}
}

120 
	$adb_auth_g’”©e_tok’
(*
tok’
, 
size_t
 
tok’_size
)

122 
FILE
 *
f
;

123 
»t
;

125 
f
 = 
	`fİ’
("/dev/urandom", "r");

126 ià(!
f
)

129 
»t
 = 
	`ä—d
(
tok’
, 
tok’_size
, 1, 
f
);

131 
	`fşo£
(
f
);

132  
»t
 * 
tok’_size
;

133 
	}
}

135 
	$adb_auth_v”ify
(*
tok’
, *
sig
, 
sigËn
)

137 
li¡node
 *
™em
;

138 
adb_public_key
 *
key
;

139 
»t
;

141 ià(
sigËn
 !ğ
RSANUMBYTES
)

144 
	`li¡_fÜ_—ch
(
™em
, &
key_li¡
) {

145 
key
 = 
	`node_to_™em
(
™em
, 
adb_public_key
, 
node
);

146 
»t
 = 
	`RSA_v”ify
(&
key
->key, 
sig
, 
sigËn
, 
tok’
);

147 ià(
»t
)

152 
	}
}

154 
	$adb_auth_ev’t
(
fd
, 
ev’ts
, *
d©a
)

156 
©¿n¥Üt
 *
t
 = 
d©a
;

157 
»¥Ú£
[2];

158 
»t
;

160 ià(
ev’ts
 & 
FDE_READ
) {

161 
»t
 = 
	`unix_»ad
(
fd
, 
»¥Ú£
, (response));

162 ià(
»t
 < 0) {

163 
	`D
("Disconnect");

164 
	`fdev’t_»move
(&
t
->
auth_fde
);

165 
äamewÜk_fd
 = -1;

167 ià(
»t
 =ğ2 && 
»¥Ú£
[0] == 'O' &&„esponse[1] == 'K') {

168 
	`adb_auth_»lßd_keys
();

169 
	`adb_auth_v”if›d
(
t
);

172 
	}
}

174 
	$adb_auth_cÚfœm_key
(*
key
, 
size_t
 
Ën
, 
©¿n¥Üt
 *
t
)

176 
msg
[
MAX_PAYLOAD
];

177 
»t
;

179 ià(
äamewÜk_fd
 < 0) {

180 
	`D
("Client‚ot connected\n");

184 ià(
key
[
Ën
 - 1] != '\0') {

185 
	`D
("Key must be‡‚ull-terminated string\n");

189 
»t
 = 
	`¢´štf
(
msg
, (msg), "PK%s", 
key
);

190 ià(
»t
 >ğ(sigÃd)(
msg
)) {

191 
	`D
("KeyoØlÚg.„‘=%d", 
»t
);

194 
	`D
("S’dšg '%s'\n", 
msg
);

196 
»t
 = 
	`unix_wr™e
(
äamewÜk_fd
, 
msg
,„et);

197 ià(
»t
 < 0) {

198 
	`D
("FaedØwr™PK,ƒ¼no=%d\n", 
”ºo
);

202 
	`fdev’t_š¡®l
(&
t
->
auth_fde
, 
äamewÜk_fd
, 
adb_auth_ev’t
,);

203 
	`fdev’t_add
(&
t
->
auth_fde
, 
FDE_READ
);

204 
	}
}

206 
	$adb_auth_li¡’”
(
fd
, 
ev’ts
, *
d©a
)

208 
sockaddr
 
addr
;

209 
sockËn_t
 
®’
;

210 
s
;

212 
®’
 = (
addr
);

214 
s
 = 
	`adb_sock‘_acû±
(
fd
, &
addr
, &
®’
);

215 ià(
s
 < 0) {

216 
	`D
("FaedØacû±:ƒ¼no=%d\n", 
”ºo
);

220 
äamewÜk_fd
 = 
s
;

221 
	}
}

223 
	$adb_auth_š™
()

225 
fd
, 
»t
;

227 
	`li¡_š™
(&
key_li¡
);

228 
	`adb_auth_»lßd_keys
();

230 
fd
 = 
	`ªdroid_g‘_cÚŒŞ_sock‘
("adbd");

231 ià(
fd
 < 0) {

232 
	`D
("Failedo get‡dbd socket\n");

236 
»t
 = 
	`li¡’
(
fd
, 4);

237 ià(
»t
 < 0) {

238 
	`D
("FaedØli¡’ oÀ'%d'\n", 
fd
);

242 
	`fdev’t_š¡®l
(&
li¡’”_fde
, 
fd
, 
adb_auth_li¡’”
, 
NULL
);

243 
	`fdev’t_add
(&
li¡’”_fde
, 
FDE_READ
);

244 
	}
}

	@adb_auth_host.c

17 
	~<¡dio.h
>

19 #ifdeà
_WIN32


20 
	#WIN32_LEAN_AND_MEAN


	)

21 
	~"wšdows.h
"

22 
	~"shlobj.h
"

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<uni¡d.h
>

28 
	~<¡ršg.h
>

30 
	~"sysd•s.h
"

31 
	~"adb.h
"

32 
	~"adb_auth.h
"

36 
	#RSA_v”ify
 
RSA_v”ify_mšüy±


	)

37 
	~"mšüy±/r§.h
"

38 #undeà
RSA_v”ify


40 
	~<cuts/li¡.h
>

42 
	~<İ’s¦/evp.h
>

43 
	~<İ’s¦/objeùs.h
>

44 
	~<İ’s¦/³m.h
>

45 
	~<İ’s¦/r§.h
>

46 
	~<İ’s¦/sha.h
>

48 
	#TRACE_TAG
 
TRACE_AUTH


	)

50 
	#ANDROID_PATH
 ".ªdroid"

	)

51 
	#ADB_KEY_FILE
 "adbkey"

	)

54 
	sadb_´iv©e_key
 {

55 
li¡node
 
	mnode
;

56 
RSA
 *
	mr§
;

59 
li¡node
 
	gkey_li¡
;

63 
	$RSA_to_RSAPublicKey
(
RSA
 *
r§
, 
RSAPublicKey
 *
pkey
)

65 
»t
 = 1;

66 
i
;

68 
BN_CTX
* 
ùx
 = 
	`BN_CTX_Ãw
();

69 
BIGNUM
* 
r32
 = 
	`BN_Ãw
();

70 
BIGNUM
* 
¼
 = 
	`BN_Ãw
();

71 
BIGNUM
* 
r
 = 
	`BN_Ãw
();

72 
BIGNUM
* 
»m
 = 
	`BN_Ãw
();

73 
BIGNUM
* 
n
 = 
	`BN_Ãw
();

74 
BIGNUM
* 
n0šv
 = 
	`BN_Ãw
();

76 ià(
	`RSA_size
(
r§
è!ğ
RSANUMBYTES
) {

77 
»t
 = 0;

78 
out
;

81 
	`BN_£t_b™
(
r32
, 32);

82 
	`BN_cİy
(
n
, 
r§
->n);

83 
	`BN_£t_b™
(
r
, 
RSANUMWORDS
 * 32);

84 
	`BN_mod_sqr
(
¼
, 
r
, 
n
, 
ùx
);

85 
	`BN_div
(
NULL
, 
»m
, 
n
, 
r32
, 
ùx
);

86 
	`BN_mod_šv”£
(
n0šv
, 
»m
, 
r32
, 
ùx
);

88 
pkey
->
Ën
 = 
RSANUMWORDS
;

89 
pkey
->
n0šv
 = 0 - 
	`BN_g‘_wÜd
(n0inv);

90 
i
 = 0; i < 
RSANUMWORDS
; i++) {

91 
	`BN_div
(
¼
, 
»m
,„r, 
r32
, 
ùx
);

92 
pkey
->
¼
[
i
] = 
	`BN_g‘_wÜd
(
»m
);

93 
	`BN_div
(
n
, 
»m
,‚, 
r32
, 
ùx
);

94 
pkey
->
n
[
i
] = 
	`BN_g‘_wÜd
(
»m
);

96 
pkey
->
expÚ’t
 = 
	`BN_g‘_wÜd
(
r§
->
e
);

98 
out
:

99 
	`BN_ä“
(
n0šv
);

100 
	`BN_ä“
(
n
);

101 
	`BN_ä“
(
»m
);

102 
	`BN_ä“
(
r
);

103 
	`BN_ä“
(
¼
);

104 
	`BN_ä“
(
r32
);

105 
	`BN_CTX_ä“
(
ùx
);

107  
»t
;

108 
	}
}

110 
	$g‘_u£r_šfo
(*
buf
, 
size_t
 
Ën
)

112 
ho¡Çme
[1024], 
u£ºame
[1024];

113 
»t
;

115 #iâdeà
_WIN32


116 
»t
 = 
	`g‘ho¡Çme
(
ho¡Çme
, (hostname));

117 ià(
»t
 < 0)

119 
	`¡rıy
(
ho¡Çme
, "unknown");

121 #ià!
defšed
 
_WIN32
 && !defšed 
ADB_HOST_ON_TARGET


122 
»t
 = 
	`g‘logš_r
(
u£ºame
, (username));

123 ià(
»t
 < 0)

125 
	`¡rıy
(
u£ºame
, "unknown");

127 
»t
 = 
	`¢´štf
(
buf
, 
Ën
, " %s@%s", 
u£ºame
, 
ho¡Çme
);

128 ià(
»t
 >ğ(sigÃd)
Ën
)

129 
buf
[
Ën
 - 1] = '\0';

130 
	}
}

132 
	$wr™e_public_keyfe
(
RSA
 *
´iv©e_key
, cÚ¡ *
´iv©e_key_·th
)

134 
RSAPublicKey
 
pkey
;

135 
BIO
 *
bio
, *
b64
, *
bfe
;

136 
·th
[
PATH_MAX
], 
šfo
[
MAX_PAYLOAD
];

137 
»t
;

139 
»t
 = 
	`¢´štf
(
·th
, Õ©h), "%s.pub", 
´iv©e_key_·th
);

140 ià(
»t
 >ğ(sigÃd)(
·th
))

143 
»t
 = 
	`RSA_to_RSAPublicKey
(
´iv©e_key
, &
pkey
);

144 ià(!
»t
) {

145 
	`D
("Failedo converto…ublickey\n");

149 
bfe
 = 
	`BIO_Ãw_fe
(
·th
, "w");

150 ià(!
bfe
) {

151 
	`D
("FaedØİ’ '%s'\n", 
·th
);

155 
	`D
("Wr™šg…ubliøkeyØ'%s'\n", 
·th
);

157 
b64
 = 
	`BIO_Ãw
(
	`BIO_f_ba£64
());

158 
	`BIO_£t_æags
(
b64
, 
BIO_FLAGS_BASE64_NO_NL
);

160 
bio
 = 
	`BIO_push
(
b64
, 
bfe
);

161 
	`BIO_wr™e
(
bio
, &
pkey
, (pkey));

162 
	`BIO_æush
(
bio
);

163 
	`BIO_pİ
(
b64
);

164 
	`BIO_ä“
(
b64
);

166 
	`g‘_u£r_šfo
(
šfo
, (info));

167 
	`BIO_wr™e
(
bfe
, 
šfo
, 
	`¡¾’
(info));

168 
	`BIO_æush
(
bfe
);

169 
	`BIO_ä“_®l
(
bfe
);

172 
	}
}

174 
	$g’”©e_key
(cÚ¡ *
fe
)

176 
EVP_PKEY
* 
pkey
 = 
	`EVP_PKEY_Ãw
();

177 
BIGNUM
* 
expÚ’t
 = 
	`BN_Ãw
();

178 
RSA
* 
r§
 = 
	`RSA_Ãw
();

179 
mode_t
 
Şd_mask
;

180 
FILE
 *
f
 = 
NULL
;

181 
»t
 = 0;

183 
	`D
("g’”©e_key '%s'\n", 
fe
);

185 ià(!
pkey
 || !
expÚ’t
 || !
r§
) {

186 
	`D
("Failedo‡llocate key\n");

187 
out
;

190 
	`BN_£t_wÜd
(
expÚ’t
, 
RSA_F4
);

191 
	`RSA_g’”©e_key_ex
(
r§
, 2048, 
expÚ’t
, 
NULL
);

192 
	`EVP_PKEY_£t1_RSA
(
pkey
, 
r§
);

194 
Şd_mask
 = 
	`umask
(077);

196 
f
 = 
	`fİ’
(
fe
, "w");

197 ià(!
f
) {

198 
	`D
("FaedØİ’ '%s'\n", 
fe
);

199 
	`umask
(
Şd_mask
);

200 
out
;

203 
	`umask
(
Şd_mask
);

205 ià(!
	`PEM_wr™e_Priv©eKey
(
f
, 
pkey
, 
NULL
, NULL, 0, NULL, NULL)) {

206 
	`D
("Failedo write key\n");

207 
out
;

210 ià(!
	`wr™e_public_keyfe
(
r§
, 
fe
)) {

211 
	`D
("Failedo write…ublic key\n");

212 
out
;

215 
»t
 = 1;

217 
out
:

218 ià(
f
)

219 
	`fşo£
(
f
);

220 
	`EVP_PKEY_ä“
(
pkey
);

221 
	`RSA_ä“
(
r§
);

222 
	`BN_ä“
(
expÚ’t
);

223  
»t
;

224 
	}
}

226 
	$»ad_key
(cÚ¡ *
fe
, 
li¡node
 *
li¡
)

228 
adb_´iv©e_key
 *
key
;

229 
FILE
 *
f
;

231 
	`D
("»ad_key '%s'\n", 
fe
);

233 
f
 = 
	`fİ’
(
fe
, "r");

234 ià(!
f
) {

235 
	`D
("FaedØİ’ '%s'\n", 
fe
);

239 
key
 = 
	`m®loc
((*key));

240 ià(!
key
) {

241 
	`D
("Failedo‡lloc key\n");

242 
	`fşo£
(
f
);

245 
key
->
r§
 = 
	`RSA_Ãw
();

247 ià(!
	`PEM_»ad_RSAPriv©eKey
(
f
, &
key
->
r§
, 
NULL
, NULL)) {

248 
	`D
("Failedo„ead key\n");

249 
	`fşo£
(
f
);

250 
	`RSA_ä“
(
key
->
r§
);

251 
	`ä“
(
key
);

255 
	`fşo£
(
f
);

256 
	`li¡_add_
(
li¡
, &
key
->
node
);

258 
	}
}

260 
	$g‘_u£r_keyf•©h
(*
f’ame
, 
size_t
 
Ën
)

262 cÚ¡ *
fÜm©
, *
home
;

263 
ªdroid_dœ
[
PATH_MAX
];

264 
¡©
 
buf
;

265 #ifdeà
_WIN32


266 
·th
[
PATH_MAX
];

267 
home
 = 
	`g‘’v
("ANDROID_SDK_HOME");

268 ià(!
home
) {

269 
	`SHG‘FŞd”P©h
(
NULL
, 
CSIDL_PROFILE
, NULL, 0, 
·th
);

270 
home
 = 
·th
;

272 
fÜm©
 = "%s\\%s";

274 
home
 = 
	`g‘’v
("HOME");

275 ià(!
home
)

277 
fÜm©
 = "%s/%s";

280 
	`D
("hom'%s'\n", 
home
);

282 ià(
	`¢´štf
(
ªdroid_dœ
, ×ndroid_dœ), 
fÜm©
, 
home
,

283 
ANDROID_PATH
è>ğ()(
ªdroid_dœ
))

286 ià(
	`¡©
(
ªdroid_dœ
, &
buf
)) {

287 ià(
	`adb_mkdœ
(
ªdroid_dœ
, 0750) < 0) {

288 
	`D
("CªnÙ mkdœ '%s'", 
ªdroid_dœ
);

293  
	`¢´štf
(
f’ame
, 
Ën
, 
fÜm©
, 
ªdroid_dœ
, 
ADB_KEY_FILE
);

294 
	}
}

296 
	$g‘_u£r_key
(
li¡node
 *
li¡
)

298 
¡©
 
buf
;

299 
·th
[
PATH_MAX
];

300 
»t
;

302 
»t
 = 
	`g‘_u£r_keyf•©h
(
·th
, (path));

303 ià(
»t
 < 0 ||„‘ >ğ(sigÃd)(
·th
)) {

304 
	`D
("Error getting user key filename");

308 
	`D
("u£¸key '%s'\n", 
·th
);

310 ià(
	`¡©
(
·th
, &
buf
) == -1) {

311 ià(!
	`g’”©e_key
(
·th
)) {

312 
	`D
("Failedo generate‚ew key\n");

317  
	`»ad_key
(
·th
, 
li¡
);

318 
	}
}

320 
	$g‘_v’dÜ_keys
(
li¡node
 *
li¡
)

322 cÚ¡ *
adb_keys_·th
;

323 
keys_·th
[
MAX_PAYLOAD
];

324 *
·th
;

325 *
§ve
;

326 
¡©
 
buf
;

328 
adb_keys_·th
 = 
	`g‘’v
("ADB_VENDOR_KEYS");

329 ià(!
adb_keys_·th
)

331 
	`¡ºıy
(
keys_·th
, 
adb_keys_·th
, (keys_path));

333 
·th
 = 
	`adb_¡¹ok_r
(
keys_·th
, 
ENV_PATH_SEPARATOR_STR
, &
§ve
);

334 
·th
) {

335 
	`D
("R—dšg: '%s'\n", 
·th
);

337 ià(
	`¡©
(
·th
, &
buf
))

338 
	`D
("Cª'ˆ»ad '%s'\n", 
·th
);

339 ià(!
	`»ad_key
(
·th
, 
li¡
))

340 
	`D
("FaedØ»ad '%s'\n", 
·th
);

342 
·th
 = 
	`adb_¡¹ok_r
(
NULL
, 
ENV_PATH_SEPARATOR_STR
, &
§ve
);

344 
	}
}

346 
	$adb_auth_sign
(*
node
, *
tok’
, 
size_t
 
tok’_size
, *
sig
)

348 
Ën
;

349 
adb_´iv©e_key
 *
key
 = 
	`node_to_™em
(
node
, adb_private_key,‚ode);

351 ià(!
	`RSA_sign
(
NID_sha1
, 
tok’
, 
tok’_size
, 
sig
, &
Ën
, 
key
->
r§
)) {

355 
	`D
("adb_auth_sigÀËn=%d\n", 
Ën
);

356  ()
Ën
;

357 
	}
}

359 *
	$adb_auth_Ãxtkey
(*
cu¼’t
)

361 
li¡node
 *
™em
;

363 ià(
	`li¡_em±y
(&
key_li¡
))

364  
NULL
;

366 ià(!
cu¼’t
)

367  
	`li¡_h—d
(&
key_li¡
);

369 
	`li¡_fÜ_—ch
(
™em
, &
key_li¡
) {

370 ià(
™em
 =ğ
cu¼’t
) {

372 ià(
™em
->
Ãxt
 =ğ&
key_li¡
)

373  
NULL
;

374  
™em
->
Ãxt
;

378  
NULL
;

379 
	}
}

381 
	$adb_auth_g‘_u£rkey
(*
d©a
, 
size_t
 
Ën
)

383 
·th
[
PATH_MAX
];

384 *
fe
;

385 
»t
;

387 
»t
 = 
	`g‘_u£r_keyf•©h
(
·th
, (path) - 4);

388 ià(
»t
 < 0 ||„‘ >ğ(sigÃd)((
·th
) - 4)) {

389 
	`D
("Error getting user key filename");

392 
	`¡rÿt
(
·th
, ".pub");

394 
fe
 = 
	`lßd_fe
(
·th
, (*)&
»t
);

395 ià(!
fe
) {

396 
	`D
("Cª'ˆlßd '%s'\n", 
·th
);

400 ià(
Ën
 < (
size_t
)(
»t
 + 1)) {

401 
	`D
("%s: CÚ‹ÁoØÏrg»t=%d\n", 
·th
, 
»t
);

405 
	`memıy
(
d©a
, 
fe
, 
»t
);

406 
d©a
[
»t
] = '\0';

408  
»t
 + 1;

409 
	}
}

411 
	$adb_auth_š™
()

413 
»t
;

415 
	`D
("adb_auth_init\n");

417 
	`li¡_š™
(&
key_li¡
);

419 
»t
 = 
	`g‘_u£r_key
(&
key_li¡
);

420 ià(!
»t
) {

421 
	`D
("Failedo get user key\n");

425 
	`g‘_v’dÜ_keys
(&
key_li¡
);

426 
	}
}

	@adb_client.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡ršg.h
>

4 
	~<”ºo.h
>

5 
	~<lim™s.h
>

6 
	~<¡d¬g.h
>

7 
	~<zfe/zfe.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sys/¡©.h
>

11 
	~"sysd•s.h
"

13 
	#TRACE_TAG
 
TRACE_ADB


	)

14 
	~"adb_ş›Á.h
"

16 
Œª¥Üt_ty³
 
	g__adb_Œª¥Üt
 = 
kT¿n¥ÜtAny
;

17 cÚ¡ * 
	g__adb_£rŸl
 = 
NULL
;

19 
	g__adb_£rv”_pÜt
 = 
DEFAULT_ADB_PORT
;

21 
	$adb_£t_Œª¥Üt
(
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
)

23 
__adb_Œª¥Üt
 = 
ty³
;

24 
__adb_£rŸl
 = 
£rŸl
;

25 
	}
}

27 
	$adb_£t_tı_¥ecifics
(
£rv”_pÜt
)

29 
__adb_£rv”_pÜt
 = 
£rv”_pÜt
;

30 
	}
}

32 
	$adb_g‘_emuÏtÜ_cÚsŞe_pÜt
()

34 cÚ¡ * 
£rŸl
 = 
__adb_£rŸl
;

35 
pÜt
;

37 ià(
£rŸl
 =ğ
NULL
) {

41 * 
tmp
 = 
	`adb_qu”y
("host:devices");

42 * 
p
 = 
tmp
;

43 if(!
tmp
) {

44 
	`´štf
("noƒmulator connected\n");

47 *
p
) {

48 * 
q
 = 
	`¡rchr
(
p
, '\n');

49 ià(
q
 !ğ
NULL
)

50 *
q
++ = 0;

52 
q
 = 
p
 + 
	`¡¾’
(p);

54 ià(!
	`memcmp
(
p
, 
LOCAL_CLIENT_PREFIX
, (LOCAL_CLIENT_PREFIX)-1)) {

55 ià(
£rŸl
 !ğ
NULL
) {

56 
	`ä“
(
tmp
);

59 
£rŸl
 = 
p
;

62 
p
 = 
q
;

64 
	`ä“
(
tmp
);

66 ià(
£rŸl
 =ğ
NULL
)

70 ià(
	`memcmp
(
£rŸl
, 
LOCAL_CLIENT_PREFIX
, (LOCAL_CLIENT_PREFIX)-1) != 0)

74 
£rŸl
 +ğ(
LOCAL_CLIENT_PREFIX
)-1;

75 
pÜt
 = 
	`¡¹Ş
(
£rŸl
, 
NULL
, 10);

76  
pÜt
;

77 
	}
}

79 
	g__adb_”rÜ
[256] = { 0 };

81 cÚ¡ *
	$adb_”rÜ
()

83  
__adb_”rÜ
;

84 
	}
}

86 
	$sw™ch_sock‘_Œª¥Üt
(
fd
)

88 
£rviû
[64];

89 
tmp
[5];

90 
Ën
;

92 ià(
__adb_£rŸl
)

93 
	`¢´štf
(
£rviû
,  s”viû, "ho¡:Œª¥Üt:%s", 
__adb_£rŸl
);

95 * 
Œª¥Üt_ty³
 = "???";

97 
__adb_Œª¥Üt
) {

98 
kT¿n¥ÜtUsb
:

99 
Œª¥Üt_ty³
 = "transport-usb";

101 
kT¿n¥ÜtLoÿl
:

102 
Œª¥Üt_ty³
 = "transport-local";

104 
kT¿n¥ÜtAny
:

105 
Œª¥Üt_ty³
 = "transport-any";

107 
kT¿n¥ÜtHo¡
:

113 
	`¢´štf
(
£rviû
,  s”viû, "ho¡:%s", 
Œª¥Üt_ty³
);

115 
Ën
 = 
	`¡¾’
(
£rviû
);

116 
	`¢´štf
(
tmp
, mp, "%04x", 
Ën
);

118 if(
	`wr™ex
(
fd
, 
tmp
, 4è|| wr™ex(fd, 
£rviû
, 
Ën
)) {

119 
	`¡rıy
(
__adb_”rÜ
, "write failure during connection");

120 
	`adb_şo£
(
fd
);

123 
	`D
("Switchransport in…rogress\n");

125 if(
	`adb_¡©us
(
fd
)) {

126 
	`adb_şo£
(
fd
);

127 
	`D
("Switchransport failed\n");

130 
	`D
("Switchransport success\n");

132 
	}
}

134 
	$adb_¡©us
(
fd
)

136 
buf
[5];

137 
Ën
;

139 if(
	`»adx
(
fd
, 
buf
, 4)) {

140 
	`¡rıy
(
__adb_”rÜ
, "protocol fault (no status)");

144 if(!
	`memcmp
(
buf
, "OKAY", 4)) {

148 if(
	`memcmp
(
buf
, "FAIL", 4)) {

149 
	`¥rštf
(
__adb_”rÜ
,

151 
buf
[0], buf[1], buf[2], buf[3]);

155 if(
	`»adx
(
fd
, 
buf
, 4)) {

156 
	`¡rıy
(
__adb_”rÜ
, "protocol fault (status†en)");

159 
buf
[4] = 0;

160 
Ën
 = 
	`¡¹oul
((*)
buf
, 0, 16);

161 if(
Ën
 > 255)†en = 255;

162 if(
	`»adx
(
fd
, 
__adb_”rÜ
, 
Ën
)) {

163 
	`¡rıy
(
__adb_”rÜ
, "protocol fault (status„ead)");

166 
__adb_”rÜ
[
Ën
] = 0;

168 
	}
}

170 
	$_adb_cÚÃù
(cÚ¡ *
£rviû
)

172 
tmp
[5];

173 
Ën
;

174 
fd
;

176 
	`D
("_adb_cÚÃù: %s\n", 
£rviû
);

177 
Ën
 = 
	`¡¾’
(
£rviû
);

178 if((
Ën
 < 1) || (len > 1024)) {

179 
	`¡rıy
(
__adb_”rÜ
, "service‚ameoo†ong");

182 
	`¢´štf
(
tmp
, mp, "%04x", 
Ën
);

184 
fd
 = 
	`sock‘_loİback_ş›Á
(
__adb_£rv”_pÜt
, 
SOCK_STREAM
);

185 if(
fd
 < 0) {

186 
	`¡rıy
(
__adb_”rÜ
, "cannot connecto daemon");

190 ià(
	`memcmp
(
£rviû
,"ho¡",4è!ğ0 && 
	`sw™ch_sock‘_Œª¥Üt
(
fd
)) {

194 if(
	`wr™ex
(
fd
, 
tmp
, 4è|| wr™ex(fd, 
£rviû
, 
Ën
)) {

195 
	`¡rıy
(
__adb_”rÜ
, "write failure during connection");

196 
	`adb_şo£
(
fd
);

200 if(
	`adb_¡©us
(
fd
)) {

201 
	`adb_şo£
(
fd
);

205 
	`D
("_adb_cÚÃù:„‘uº fd %d\n", 
fd
);

206  
fd
;

207 
	}
}

209 
	$adb_cÚÃù
(cÚ¡ *
£rviû
)

212 
fd
 = 
	`_adb_cÚÃù
("host:version");

214 
	`D
("adb_cÚÃù: s”viû %s\n", 
£rviû
);

215 if(
fd
 == -2) {

216 
	`årštf
(
¡dout
,"* daemon‚ot„unning. starting it‚ow on…ort %d *\n",

217 
__adb_£rv”_pÜt
);

218 
¡¬t_£rv”
:

219 if(
	`Ïunch_£rv”
(
__adb_£rv”_pÜt
)) {

220 
	`årštf
(
¡d”r
,"* failedo start daemon *\n");

223 
	`årštf
(
¡dout
,"* daemon started successfully *\n");

226 
	`adb_¦“p_ms
(3000);

230 
buf
[100];

231 
n
;

232 
v”siÚ
 = 
ADB_SERVER_VERSION
 - 1;

235 if(
fd
 >= 0) {

236 if(
	`»adx
(
fd
, 
buf
, 4)è
”rÜ
;

238 
buf
[4] = 0;

239 
n
 = 
	`¡¹oul
(
buf
, 0, 16);

240 if(
n
 > ()(
buf
)è
”rÜ
;

241 if(
	`»adx
(
fd
, 
buf
, 
n
)è
”rÜ
;

242 
	`adb_şo£
(
fd
);

244 ià(
	`ssÿnf
(
buf
, "%04x", &
v”siÚ
è!ğ1è
”rÜ
;

248 ià(
	`¡rcmp
(
__adb_”rÜ
, "unknown host service") != 0)

249  
fd
;

252 if(
v”siÚ
 !ğ
ADB_SERVER_VERSION
) {

253 
	`´štf
("adb server is out of date. killing...\n");

254 
fd
 = 
	`_adb_cÚÃù
("host:kill");

255 
	`adb_şo£
(
fd
);

258 
	`adb_¦“p_ms
(2000);

259 
¡¬t_£rv”
;

264 ià(!
	`¡rcmp
(
£rviû
, "host:start-server"))

267 
fd
 = 
	`_adb_cÚÃù
(
£rviû
);

268 if(
fd
 == -2) {

269 
	`årštf
(
¡d”r
,"** daemon still‚ot„unning");

271 
	`D
("adb_cÚÃù:„‘uº fd %d\n", 
fd
);

273  
fd
;

274 
”rÜ
:

275 
	`adb_şo£
(
fd
);

277 
	}
}

280 
	$adb_commªd
(cÚ¡ *
£rviû
)

282 
fd
 = 
	`adb_cÚÃù
(
£rviû
);

283 if(
fd
 < 0) {

287 if(
	`adb_¡©us
(
fd
)) {

288 
	`adb_şo£
(
fd
);

293 
	}
}

295 *
	$adb_qu”y
(cÚ¡ *
£rviû
)

297 
buf
[5];

298 
n
;

299 *
tmp
;

301 
	`D
("adb_qu”y: %s\n", 
£rviû
);

302 
fd
 = 
	`adb_cÚÃù
(
£rviû
);

303 if(
fd
 < 0) {

304 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
__adb_”rÜ
);

308 if(
	`»adx
(
fd
, 
buf
, 4)è
oİs
;

310 
buf
[4] = 0;

311 
n
 = 
	`¡¹oul
(
buf
, 0, 16);

312 if(
n
 > 1024è
oİs
;

314 
tmp
 = 
	`m®loc
(
n
 + 1);

315 if(
tmp
 =ğ0è
oİs
;

317 if(
	`»adx
(
fd
, 
tmp
, 
n
) == 0) {

318 
tmp
[
n
] = 0;

319 
	`adb_şo£
(
fd
);

320  
tmp
;

322 
	`ä“
(
tmp
);

324 
oİs
:

325 
	`adb_şo£
(
fd
);

327 
	}
}

	@adb_client.h

1 #iâdeà
_ADB_CLIENT_H_


2 
	#_ADB_CLIENT_H_


	)

4 
	~"adb.h
"

10 
adb_cÚÃù
(cÚ¡ *
£rviû
);

11 
_adb_cÚÃù
(cÚ¡ *
£rviû
);

16 
adb_commªd
(cÚ¡ *
£rviû
);

22 *
adb_qu”y
(cÚ¡ *
£rviû
);

26 
adb_£t_Œª¥Üt
(
Œª¥Üt_ty³
 
ty³
, cÚ¡ * 
£rŸl
);

30 
adb_£t_tı_¥ecifics
(
£rv”_pÜt
);

36 
adb_g‘_emuÏtÜ_cÚsŞe_pÜt
();

42 
adb_£nd_emuÏtÜ_commªd
(
¬gc
, ** 
¬gv
);

45 cÚ¡ *
adb_”rÜ
();

51 
adb_¡©us
(
fd
);

	@backup_service.c

17 
	~<uni¡d.h
>

18 
	~<¡dio.h
>

20 
	~"sysd•s.h
"

22 
	#TRACE_TAG
 
TRACE_ADB


	)

23 
	~"adb.h
"

26 
pid_t
 
	mpid
;

27 
	mfd
;

28 } 
	tbackup_h¬ve¡_·¿ms
;

31 
	$backup_sock‘·œ
(
sv
[2]) {

32 
rc
 = 
	`unix_sock‘·œ
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0, 
sv
 );

33 ià(
rc
 < 0)

37 
	}
}

40 * 
	$backup_chd_wa™”
(* 
¬gs
) {

41 
¡©us
;

42 
backup_h¬ve¡_·¿ms
* 
·¿ms
 = (backup_h¬ve¡_·¿ms*è
¬gs
;

44 
	`wa™pid
(
·¿ms
->
pid
, &
¡©us
, 0);

45 
	`adb_şo£
(
·¿ms
->
fd
);

46 
	`ä“
(
·¿ms
);

47  
NULL
;

48 
	}
}

51 
	$backup_£rviû
(
BackupO³¿tiÚ
 
İ
, * 
¬gs
) {

52 
pid_t
 
pid
;

53 
s
[2];

54 * 
İ”©iÚ
;

55 
sock‘num
;

58 ià(
İ
 =ğ
BACKUP
) {

59 
İ”©iÚ
 = "backup";

60 
sock‘num
 = 
STDOUT_FILENO
;

62 
İ”©iÚ
 = "restore";

63 
sock‘num
 = 
STDIN_FILENO
;

66 
	`D
("backup_£rviû(%s, %s)\n", 
İ”©iÚ
, 
¬gs
);

70 ià(
	`backup_sock‘·œ
(
s
)) {

71 
	`D
("can't create backup/restore socketpair\n");

72 
	`årštf
(
¡d”r
, "unableo create backup/restore socketpair\n");

76 
	`D
("Backup/»¡Üsock‘…aœ: (£nd=%d,„eûive=%d)\n", 
s
[1], s[0]);

77 
	`şo£_Ú_exec
(
s
[0]);

80 
pid
 = 
	`fÜk
();

81 ià(
pid
 < 0) {

83 
	`D
("ÿn'ˆfÜk fÜ %s\n", 
İ”©iÚ
);

84 
	`årštf
(
¡d”r
, "uÇbËØfÜk fÜ %s\n", 
İ”©iÚ
);

85 
	`adb_şo£
(
s
[0]);

86 
	`adb_şo£
(
s
[1]);

91 ià(
pid
 == 0) {

93 * 
p
;

94 
¬gc
;

95 
pÜŠum
[16];

96 ** 
bu_¬gs
;

99 
¬gc
 = 3;

100 
p
 = (*)
¬gs
;… && *p; ) {

101 
¬gc
++;

102 *
p
 && *p != ':')…++;

103 ià(*
p
 == ':')…++;

106 
bu_¬gs
 = (**è
	`®loÿ
(
¬gc
*(*) + 1);

109 
¬gc
 = 0;

110 
bu_¬gs
[
¬gc
++] = "bu";

111 
	`¢´štf
(
pÜŠum
, ÕÜŠum), "%d", 
s
[1]);

112 
bu_¬gs
[
¬gc
++] = 
pÜŠum
;

113 
bu_¬gs
[
¬gc
++] = 
İ”©iÚ
;

114 
p
 = (*)
¬gs
;… && *p; ) {

115 
bu_¬gs
[
¬gc
++] = 
p
;

116 *
p
 && *p != ':')…++;

117 ià(*
p
 == ':') {

118 *
p
 = 0;

119 
p
++;

122 
bu_¬gs
[
¬gc
] = 
NULL
;

126 
	`adb_şo£
(
s
[0]);

129 
	`execvp
("/sy¡em/bš/bu", (* cÚ¡ *)
bu_¬gs
);

131 
	`årštf
(
¡d”r
, "Unableoƒxec 'bu', bailing\n");

132 
	`ex™
(-1);

134 
adb_th»ad_t
 
t
;

135 
backup_h¬ve¡_·¿ms
* 
·¿ms
;

138 
	`D
("fÜk(è»tuºed…id %d\n", 
pid
);

139 
	`adb_şo£
(
s
[1]);

142 
·¿ms
 = (
backup_h¬ve¡_·¿ms
*è
	`m®loc
((backup_harvest_params));

143 
·¿ms
->
pid
 =…id;

144 
·¿ms
->
fd
 = 
s
[0];

145 ià(
	`adb_th»ad_ü—‹
(&
t
, 
backup_chd_wa™”
, 
·¿ms
)) {

146 
	`adb_şo£
(
s
[0]);

147 
	`ä“
(
·¿ms
);

148 
	`D
("Unableo create child harvester\n");

154  
s
[0];

155 
	}
}

	@commandline.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

21 
	~<uni¡d.h
>

22 
	~<lim™s.h
>

23 
	~<¡d¬g.h
>

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<ùy³.h
>

27 
	~<as£¹.h
>

29 
	~"sysd•s.h
"

31 #ifdeà
HAVE_TERMIO_H


32 
	~<‹rmios.h
>

35 
	#TRACE_TAG
 
TRACE_ADB


	)

36 
	~"adb.h
"

37 
	~"adb_ş›Á.h
"

38 
	~"fe_sync_£rviû.h
"

40 
do_cmd
(
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, *
cmd
, ...);

42 
g‘_my_·th
(*
s
, 
size_t
 
maxL’
);

43 
fšd_sync_dœs
(cÚ¡ *
¤ÿrg
,

44 **
ªdroid_¤cdœ_out
, **
d©a_¤cdœ_out
);

45 
š¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, 
¬gc
, ** 
¬gv
);

46 
unš¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, 
¬gc
, ** 
¬gv
);

48 cÚ¡ *
	ggProduùOutP©h
 = 
NULL
;

50 *
	$´oduù_fe
(cÚ¡ *
exŒa
)

52 
n
;

53 *
x
;

55 ià(
gProduùOutP©h
 =ğ
NULL
) {

56 
	`årštf
(
¡d”r
, "adb: Product directory‚ot specified; "

58 
	`ex™
(1);

61 
n
 = 
	`¡¾’
(
gProduùOutP©h
è+ sŒËn(
exŒa
) + 2;

62 
x
 = 
	`m®loc
(
n
);

63 ià(
x
 == 0) {

64 
	`årštf
(
¡d”r
, "adb: Out of memory (product_file())\n");

65 
	`ex™
(1);

68 
	`¢´štf
(
x
, (
size_t
)
n
, "%s" 
OS_PATH_SEPARATOR_STR
 "%s", 
gProduùOutP©h
, 
exŒa
);

69  
x
;

70 
	}
}

72 
	$v”siÚ
(
FILE
 * 
out
) {

73 
	`årštf
(
out
, "Android Debug Bridge version %d.%d.%d\n",

74 
ADB_VERSION_MAJOR
, 
ADB_VERSION_MINOR
, 
ADB_SERVER_VERSION
);

75 
	}
}

77 
	$h–p
()

79 
	`v”siÚ
(
¡d”r
);

81 
	`årštf
(
¡d”r
,

192 
	}
}

194 
	$u§ge
()

196 
	`h–p
();

198 
	}
}

200 #ifdeà
HAVE_TERMIO_H


201 
‹rmios
 
	gtio_§ve
;

203 
	$¡dš_¿w_š™
(
fd
)

205 
‹rmios
 
tio
;

207 if(
	`tcg‘©Œ
(
fd
, &
tio
)) ;

208 if(
	`tcg‘©Œ
(
fd
, &
tio_§ve
)) ;

210 
tio
.
c_læag
 = 0;

213 
tio
.
c_cc
[
VTIME
] = 0;

214 
tio
.
c_cc
[
VMIN
] = 1;

216 
	`tc£‰r
(
fd
, 
TCSANOW
, &
tio
);

217 
	`tcæush
(
fd
, 
TCIFLUSH
);

218 
	}
}

220 
	$¡dš_¿w_»¡Üe
(
fd
)

222 
	`tc£‰r
(
fd
, 
TCSANOW
, &
tio_§ve
);

223 
	`tcæush
(
fd
, 
TCIFLUSH
);

224 
	}
}

227 
	$»ad_ªd_dump
(
fd
)

229 
buf
[4096];

230 
Ën
;

232 
fd
 >= 0) {

233 
	`D
("»ad_ªd_dump():…»‡db_»ad(fd=%d)\n", 
fd
);

234 
Ën
 = 
	`adb_»ad
(
fd
, 
buf
, 4096);

235 
	`D
("»ad_ªd_dump():…o¡‡db_»ad(fd=%d):†’=%d\n", 
fd
, 
Ën
);

236 if(
Ën
 == 0) {

240 if(
Ën
 < 0) {

241 if(
”ºo
 =ğ
EINTR
) ;

244 
	`fwr™e
(
buf
, 1, 
Ën
, 
¡dout
);

245 
	`fæush
(
¡dout
);

247 
	}
}

249 
	$cİy_to_fe
(
šFd
, 
outFd
) {

250 cÚ¡ 
size_t
 
BUFSIZE
 = 32 * 1024;

251 * 
buf
 = (*è
	`m®loc
(
BUFSIZE
);

252 
Ën
;

253 
tÙ®
 = 0;

255 
	`D
("cİy_to_fe(%d -> %d)\n", 
šFd
, 
outFd
);

257 
Ën
 = 
	`adb_»ad
(
šFd
, 
buf
, 
BUFSIZE
);

258 ià(
Ën
 == 0) {

259 
	`D
("copy_to_file() :„ead 0 bytes;ƒxiting\n");

262 ià(
Ën
 < 0) {

263 ià(
”ºo
 =ğ
EINTR
) {

264 
	`D
("copy_to_file() : EINTR,„etrying\n");

267 
	`D
("cİy_to_fe(è:ƒ¼Ü %d\n", 
”ºo
);

270 
	`adb_wr™e
(
outFd
, 
buf
, 
Ën
);

271 
tÙ®
 +ğ
Ën
;

273 
	`D
("cİy_to_fe(èfšished‡á” %lu by‹s\n", 
tÙ®
);

274 
	`ä“
(
buf
);

275 
	}
}

277 *
	$¡dš_»ad_th»ad
(*
x
)

279 
fd
, 
fdi
;

280 
buf
[1024];

281 
r
, 
n
;

282 
¡©e
 = 0;

284 *
fds
 = (*è
x
;

285 
fd
 = 
fds
[0];

286 
fdi
 = 
fds
[1];

287 
	`ä“
(
fds
);

291 
	`D
("¡dš_»ad_th»ad():…» unix_»ad(fdi=%d,...)\n", 
fdi
);

292 
r
 = 
	`unix_»ad
(
fdi
, 
buf
, 1024);

293 
	`D
("¡dš_»ad_th»ad():…o¡ unix_»ad(fdi=%d,...)\n", 
fdi
);

294 if(
r
 == 0) ;

295 if(
r
 < 0) {

296 if(
”ºo
 =ğ
EINTR
) ;

299 
n
 = 0;‚ < 
r
;‚++){

300 
buf
[
n
]) {

302 
¡©e
 = 1;

305 
¡©e
 = 1;

308 if(
¡©e
 == 1) state++;

311 if(
¡©e
 == 2) {

312 
	`årštf
(
¡d”r
,"\n* disconnect *\n");

313 #ifdeà
HAVE_TERMIO_H


314 
	`¡dš_¿w_»¡Üe
(
fdi
);

316 
	`ex™
(0);

319 
¡©e
 = 0;

322 
r
 = 
	`adb_wr™e
(
fd
, 
buf
,„);

323 if(
r
 <= 0) {

328 
	}
}

330 
	$š‹¿ùive_sh–l
()

332 
adb_th»ad_t
 
thr
;

333 
fdi
, 
fd
;

334 *
fds
;

336 
fd
 = 
	`adb_cÚÃù
("shell:");

337 if(
fd
 < 0) {

338 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

341 
fdi
 = 0;

343 
fds
 = 
	`m®loc
(() * 2);

344 
fds
[0] = 
fd
;

345 
fds
[1] = 
fdi
;

347 #ifdeà
HAVE_TERMIO_H


348 
	`¡dš_¿w_š™
(
fdi
);

350 
	`adb_th»ad_ü—‹
(&
thr
, 
¡dš_»ad_th»ad
, 
fds
);

351 
	`»ad_ªd_dump
(
fd
);

352 #ifdeà
HAVE_TERMIO_H


353 
	`¡dš_¿w_»¡Üe
(
fdi
);

356 
	}
}

359 
	$fÜm©_ho¡_commªd
(* 
bufãr
, 
size_t
 
buæ’
, cÚ¡ * 
commªd
, 
Œª¥Üt_ty³
 
‰y³
, cÚ¡ * 
£rŸl
)

361 ià(
£rŸl
) {

362 
	`¢´štf
(
bufãr
, 
buæ’
, "ho¡-£rŸl:%s:%s", 
£rŸl
, 
commªd
);

364 cÚ¡ * 
´efix
 = "host";

365 ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
)

366 
´efix
 = "host-usb";

367 ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
)

368 
´efix
 = "host-local";

370 
	`¢´štf
(
bufãr
, 
buæ’
, "%s:%s", 
´efix
, 
commªd
);

372 
	}
}

374 
	$adb_dowÆßd_bufãr
(cÚ¡ *
£rviû
, cÚ¡ * 
d©a
, 
sz
,

375 
´og»ss
)

377 
buf
[4096];

378 
tÙ®
;

379 
fd
;

380 cÚ¡ *
±r
;

382 
	`¥rštf
(
buf
,"%s:%d", 
£rviû
, 
sz
);

383 
fd
 = 
	`adb_cÚÃù
(
buf
);

384 if(
fd
 < 0) {

385 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

389 
İt
 = 
CHUNK_SIZE
;

390 
İt
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_SNDBUF
, &opt, (opt));

392 
tÙ®
 = 
sz
;

393 
±r
 = 
d©a
;

395 if(
´og»ss
) {

396 *
x
 = 
	`¡¼chr
(
£rviû
, ':');

397 if(
x
è
£rviû
 = x + 1;

400 
sz
 > 0) {

401 
xãr
 = (
sz
 > 
CHUNK_SIZE
) ? CHUNK_SIZE : sz;

402 if(
	`wr™ex
(
fd
, 
±r
, 
xãr
)) {

403 
	`adb_¡©us
(
fd
);

404 
	`årštf
(
¡d”r
,"* faedØwr™d©¨'%s' *\n", 
	`adb_”rÜ
());

407 
sz
 -ğ
xãr
;

408 
±r
 +ğ
xãr
;

409 if(
´og»ss
) {

410 
	`´štf
("£ndšg: '%s' %4d%% \r", 
£rviû
, ()(100LL - ((100LL * 
sz
è/ (
tÙ®
))));

411 
	`fæush
(
¡dout
);

414 if(
´og»ss
) {

415 
	`´štf
("\n");

418 if(
	`»adx
(
fd
, 
buf
, 4)){

419 
	`årštf
(
¡d”r
,"*ƒrror„eading„esponse *\n");

420 
	`adb_şo£
(
fd
);

423 if(
	`memcmp
(
buf
, "OKAY", 4)) {

424 
buf
[4] = 0;

425 
	`årštf
(
¡d”r
,"*ƒ¼Ü„e¥Ú£ '%s' *\n", 
buf
);

426 
	`adb_şo£
(
fd
);

430 
	`adb_şo£
(
fd
);

432 
	}
}

435 
	$adb_dowÆßd
(cÚ¡ *
£rviû
, cÚ¡ *
â
, 
´og»ss
)

437 *
d©a
;

438 
sz
;

440 
d©a
 = 
	`lßd_fe
(
â
, &
sz
);

441 if(
d©a
 == 0) {

442 
	`årštf
(
¡d”r
,"* cªnÙ„—d '%s' *\n", 
£rviû
);

446 
¡©us
 = 
	`adb_dowÆßd_bufãr
(
£rviû
, 
d©a
, 
sz
, 
´og»ss
);

447 
	`ä“
(
d©a
);

448  
¡©us
;

449 
	}
}

451 
	$¡©us_wšdow
(
Œª¥Üt_ty³
 
‰y³
, cÚ¡ * 
£rŸl
)

453 
commªd
[4096];

454 *
¡©e
 = 0;

455 *
Ï¡¡©e
 = 0;

458 #ifdeà
_WIN32


461 
fd
;

462 
fd
 = 
	`unix_İ’
("/dev/nuÎ", 
O_WRONLY
);

463 
	`dup2
(
fd
, 2);

464 
	`adb_şo£
(
fd
);

467 
	`fÜm©_ho¡_commªd
(
commªd
,  commªd, "g‘-¡©e", 
‰y³
, 
£rŸl
);

470 
	`adb_¦“p_ms
(250);

472 if(
¡©e
) {

473 
	`ä“
(
¡©e
);

474 
¡©e
 = 0;

477 
¡©e
 = 
	`adb_qu”y
(
commªd
);

479 if(
¡©e
) {

480 if(
Ï¡¡©e
 && !
	`¡rcmp
(
¡©e
,laststate)){

483 if(
Ï¡¡©e
è
	`ä“
(laststate);

484 
Ï¡¡©e
 = 
	`¡rdup
(
¡©e
);

488 
	`´štf
("%c[2J%c[2H", 27, 27);

489 
	`´štf
("Android Debug Bridge\n");

490 
	`´štf
("S‹: %s\n", 
¡©e
 ? state : "offline");

491 
	`fæush
(
¡dout
);

493 
	}
}

497 
	$dupAndQuÙe
(cÚ¡ *
s
)

499 cÚ¡ *
ts
;

500 
size_t
 
®loc_Ën
;

501 *
»t
;

502 *
de¡
;

504 
ts
 = 
s
;

506 
®loc_Ën
 = 0;

508  ;*
ts
 != '\0';s++) {

509 
®loc_Ën
++;

510 ià(*
ts
 == ' ' || *ts == '"' || *ts == '\\' || *ts == '(' || *ts == ')') {

511 
®loc_Ën
++;

515 
»t
 = (*)
	`m®loc
(
®loc_Ën
 + 1);

517 
ts
 = 
s
;

518 
de¡
 = 
»t
;

520  ;*
ts
 != '\0';s++) {

521 ià(*
ts
 == ' ' || *ts == '"' || *ts == '\\' || *ts == '(' || *ts == ')') {

522 *
de¡
++ = '\\';

525 *
de¡
++ = *
ts
;

528 *
de¡
++ = '\0';

530  
»t
;

531 
	}
}

540 
	$µp
(
¬gc
, **
¬gv
)

542 #ifdeà
HAVE_WIN32_PROC


543 
	`årštf
(
¡d”r
, "”rÜ:‡db % nÙ im¶em’‹d oÀWš32\n", 
¬gv
[0]);

546 *
adb_£rviû_Çme
;

547 
pid_t
 
pid
;

548 
fd
;

550 ià(
¬gc
 < 2) {

551 
	`årštf
(
¡d”r
, "usage:‡db %s <adb service‚ame> [ppp opts]\n",

552 
¬gv
[0]);

557 
adb_£rviû_Çme
 = 
¬gv
[1];

559 
fd
 = 
	`adb_cÚÃù
(
adb_£rviû_Çme
);

561 if(
fd
 < 0) {

562 
	`årštf
(
¡d”r
,"Error: Could‚ot open‡db service: %s. Error: %s\n",

563 
adb_£rviû_Çme
, 
	`adb_”rÜ
());

567 
pid
 = 
	`fÜk
();

569 ià(
pid
 < 0) {

570 
	`³¼Ü
("from fork()");

572 } ià(
pid
 == 0) {

573 
”r
;

574 
i
;

575 cÚ¡ **
µp_¬gs
;

578 
µp_¬gs
 = (cÚ¡ **è
	`®loÿ
((*è* 
¬gc
 + 1);

579 
µp_¬gs
[0] = "pppd";

580 
i
 = 2 ; i < 
¬gc
 ; i++) {

582 
µp_¬gs
[
i
 - 1] = 
¬gv
[i];

584 
µp_¬gs
[
i
-1] = 
NULL
;

588 
	`dup2
(
fd
, 
STDIN_FILENO
);

589 
	`dup2
(
fd
, 
STDOUT_FILENO
);

590 
	`adb_şo£
(
STDERR_FILENO
);

591 
	`adb_şo£
(
fd
);

593 
”r
 = 
	`execvp
("µpd", (* cÚ¡ *)
µp_¬gs
);

595 ià(
”r
 < 0) {

596 
	`³¼Ü
("execing…ppd");

598 
	`ex™
(-1);

602 
	`adb_şo£
(
fd
);

606 
	}
}

608 
	$£nd_sh–lcommªd
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, * 
buf
)

610 
fd
, 
»t
;

613 
fd
 = 
	`adb_cÚÃù
(
buf
);

614 if(
fd
 >= 0)

616 
	`årštf
(
¡d”r
,"- waiting for device -\n");

617 
	`adb_¦“p_ms
(1000);

618 
	`do_cmd
(
Œª¥Üt
, 
£rŸl
, "wait-for-device", 0);

621 
	`»ad_ªd_dump
(
fd
);

622 
»t
 = 
	`adb_şo£
(
fd
);

623 ià(
»t
)

624 
	`³¼Ü
("close");

626  
»t
;

627 
	}
}

629 
	$logÿt
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, 
¬gc
, **
¬gv
)

631 
buf
[4096];

633 *
log_gs
;

634 *
quÙed_log_gs
;

636 
log_gs
 = 
	`g‘’v
("ANDROID_LOG_TAGS");

637 
quÙed_log_gs
 = 
	`dupAndQuÙe
(
log_gs
 =ğ
NULL
 ? "" :†og_tags);

639 
	`¢´štf
(
buf
, (buf),

641 
quÙed_log_gs
);

643 
	`ä“
(
quÙed_log_gs
);

645 ià(!
	`¡rcmp
(
¬gv
[0],"longcat")) {

646 
	`¡ºÿt
(
buf
, " -v†ong", (buf)-1);

649 
¬gc
 -= 1;

650 
¬gv
 += 1;

651 
¬gc
-- > 0) {

652 *
quÙed
;

654 
quÙed
 = 
	`dupAndQuÙe
 (*
¬gv
++);

656 
	`¡ºÿt
(
buf
, " ", (buf)-1);

657 
	`¡ºÿt
(
buf
, 
quÙed
, (buf)-1);

658 
	`ä“
(
quÙed
);

661 
	`£nd_sh–lcommªd
(
Œª¥Üt
, 
£rŸl
, 
buf
);

663 
	}
}

665 
	$mkdœs
(*
·th
)

667 
»t
;

668 *
x
 = 
·th
 + 1;

671 
x
 = 
	`adb_dœ¡¬t
(x);

672 if(
x
 == 0)  0;

673 *
x
 = 0;

674 
»t
 = 
	`adb_mkdœ
(
·th
, 0775);

675 *
x
 = 
OS_PATH_SEPARATOR
;

676 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

677  
»t
;

679 
x
++;

682 
	}
}

684 
	$backup
(
¬gc
, ** 
¬gv
) {

685 
buf
[4096];

686 
deçuÉ_Çme
[32];

687 cÚ¡ * 
f’ame
 = 
	`¡rıy
(
deçuÉ_Çme
, "./backup.ab");

688 
fd
, 
outFd
;

689 
i
, 
j
;

692 
i
 = 1; i < 
¬gc
; i++) {

693 ià(!
	`¡rcmp
("-f", 
¬gv
[
i
])) {

694 ià(
i
 =ğ
¬gc
-1) {

695 
	`årštf
(
¡d”r
, "adb: -f…assed with‚o filename\n");

696  
	`u§ge
();

698 
f’ame
 = 
¬gv
[
i
+1];

699 
j
 = 
i
+2; j <ğ
¬gc
; ) {

700 
¬gv
[
i
++] =‡rgv[
j
++];

702 
¬gc
 -= 2;

703 
¬gv
[
¬gc
] = 
NULL
;

708 ià(
¬gc
 < 2è 
	`u§ge
();

710 
	`adb_uÆšk
(
f’ame
);

711 
	`mkdœs
((*)
f’ame
);

712 
outFd
 = 
	`adb_ü—t
(
f’ame
, 0640);

713 ià(
outFd
 < 0) {

714 
	`årštf
(
¡d”r
, "adb: uÇbËØİ’ f%s\n", 
f’ame
);

718 
	`¢´štf
(
buf
, (buf), "backup");

719 
¬gc
--, 
¬gv
++;‡rgc;‡rgc--,‡rgv++) {

720 
	`¡ºÿt
(
buf
, ":", (bufè- 
	`¡¾’
(buf) - 1);

721 
	`¡ºÿt
(
buf
, 
¬gv
[0], (bufè- 
	`¡¾’
(buf) - 1);

724 
	`D
("backup. f’ame=% buf=%s\n", 
f’ame
, 
buf
);

725 
fd
 = 
	`adb_cÚÃù
(
buf
);

726 ià(
fd
 < 0) {

727 
	`årštf
(
¡d”r
, "adb: unableo connect for backup\n");

728 
	`adb_şo£
(
outFd
);

732 
	`´štf
("Now unlock your device‡nd confirmhe backup operation.\n");

733 
	`cİy_to_fe
(
fd
, 
outFd
);

735 
	`adb_şo£
(
fd
);

736 
	`adb_şo£
(
outFd
);

738 
	}
}

740 
	$»¡Üe
(
¬gc
, ** 
¬gv
) {

741 cÚ¡ * 
f’ame
;

742 
fd
, 
rFd
;

744 ià(
¬gc
 !ğ2è 
	`u§ge
();

746 
f’ame
 = 
¬gv
[1];

747 
rFd
 = 
	`adb_İ’
(
f’ame
, 
O_RDONLY
);

748 ià(
rFd
 < 0) {

749 
	`årštf
(
¡d”r
, "adb: uÇbËØİ’ f%s\n", 
f’ame
);

753 
fd
 = 
	`adb_cÚÃù
("restore:");

754 ià(
fd
 < 0) {

755 
	`årštf
(
¡d”r
, "adb: unableo connect for backup\n");

756 
	`adb_şo£
(
rFd
);

760 
	`´štf
("Now unlock your device‡nd confirmhe„estore operation.\n");

761 
	`cİy_to_fe
(
rFd
, 
fd
);

763 
	`adb_şo£
(
fd
);

764 
	`adb_şo£
(
rFd
);

766 
	}
}

768 
	#SENTINEL_FILE
 "cÚfig" 
OS_PATH_SEPARATOR_STR
 "’v£tup.make"

	)

769 
	$tİ_wÜks
(cÚ¡ *
tİ
)

771 ià(
tİ
 !ğ
NULL
 && 
	`adb_is_absŞu‹_ho¡_·th
(top)) {

772 
·th_buf
[
PATH_MAX
];

773 
	`¢´štf
(
·th_buf
, (path_buf),

774 "%s" 
OS_PATH_SEPARATOR_STR
 
SENTINEL_FILE
, 
tİ
);

775  
	`acûss
(
·th_buf
, 
F_OK
) == 0;

778 
	}
}

780 *
	$fšd_tİ_äom
(cÚ¡ *
šdœ
, 
·th_buf
[
PATH_MAX
])

782 
	`¡rıy
(
·th_buf
, 
šdœ
);

784 ià(
	`tİ_wÜks
(
·th_buf
)) {

785  
·th_buf
;

787 *
s
 = 
	`adb_dœ¡İ
(
·th_buf
);

788 ià(
s
 !ğ
NULL
) {

789 *
s
 = '\0';

791 
·th_buf
[0] = '\0';

792  
NULL
;

795 
	}
}

797 *
	$fšd_tİ
(
·th_buf
[
PATH_MAX
])

799 *
tİ
 = 
	`g‘’v
("ANDROID_BUILD_TOP");

800 ià(
tİ
 !ğ
NULL
 &&op[0] != '\0') {

801 ià(!
	`tİ_wÜks
(
tİ
)) {

802 
	`årštf
(
¡d”r
, "adb: bad ANDROID_BUILD_TOP v®u\"%s\"\n", 
tİ
);

803  
NULL
;

806 
tİ
 = 
	`g‘’v
("TOP");

807 ià(
tİ
 !ğ
NULL
 &&op[0] != '\0') {

808 ià(!
	`tİ_wÜks
(
tİ
)) {

809 
	`årštf
(
¡d”r
, "adb: bad TOP v®u\"%s\"\n", 
tİ
);

810  
NULL
;

813 
tİ
 = 
NULL
;

817 ià(
tİ
 !ğ
NULL
) {

820 
	`¡rıy
(
·th_buf
, 
tİ
);

821  
·th_buf
;

827 
dœ
[
PATH_MAX
];

828 
tİ
 = 
	`fšd_tİ_äom
(
	`g‘cwd
(
dœ
, (dœ)), 
·th_buf
);

829 ià(
tİ
 =ğ
NULL
) {

833 
	`g‘_my_·th
(
dœ
, 
PATH_MAX
);

834 
tİ
 = 
	`fšd_tİ_äom
(
dœ
, 
·th_buf
);

836  
tİ
;

837 
	}
}

851 cÚ¡ *
	$fšd_´oduù_out_·th
(cÚ¡ *
hšt
)

853 
·th_buf
[
PATH_MAX
];

855 ià(
hšt
 =ğ
NULL
 || hint[0] == '\0') {

856  
NULL
;

861 ià(
	`adb_is_absŞu‹_ho¡_·th
(
hšt
)) {

862 
	`¡rıy
(
·th_buf
, 
hšt
);

863  
·th_buf
;

869 ià(
	`adb_dœ¡¬t
(
hšt
è!ğ
NULL
) {

870 ià(
	`g‘cwd
(
·th_buf
, Õ©h_buf)è=ğ
NULL
) {

871 
	`årštf
(
¡d”r
, "adb: Couldn'ˆg‘ CWD: %s\n", 
	`¡»¼Ü
(
”ºo
));

872  
NULL
;

874 ià(
	`¡¾’
(
·th_buf
è+ 1 + sŒËn(
hšt
) >= (path_buf)) {

875 
	`årštf
(
¡d”r
, "adb: Couldn't‡ssemble…ath\n");

876  
NULL
;

878 
	`¡rÿt
(
·th_buf
, 
OS_PATH_SEPARATOR_STR
);

879 
	`¡rÿt
(
·th_buf
, 
hšt
);

880  
·th_buf
;

888 
tİ_buf
[
PATH_MAX
];

889 cÚ¡ *
tİ
 = 
	`fšd_tİ
(
tİ_buf
);

890 ià(
tİ
 =ğ
NULL
) {

891 
	`årštf
(
¡d”r
, "adb: Couldn't findop of buildree\n");

892  
NULL
;

895 
	`¢´štf
(
·th_buf
, (path_buf),

896 "%s" 
OS_PATH_SEPARATOR_STR


897 "out" 
OS_PATH_SEPARATOR_STR


898 "rg‘" 
OS_PATH_SEPARATOR_STR


899 "´oduù" 
OS_PATH_SEPARATOR_STR


900 "%s", 
tİ_buf
, 
hšt
);

901 ià(
	`acûss
(
·th_buf
, 
F_OK
) < 0) {

902 
	`årštf
(
¡d”r
, "adb: Couldn't find‡…roduct dir "

903 "ba£d oÀ\"-°%s\"; \"%s\" dÛ¢'ˆexi¡\n", 
hšt
, 
·th_buf
);

904  
NULL
;

906  
·th_buf
;

907 
	}
}

909 
	$adb_commªdlše
(
¬gc
, **
¬gv
)

911 
buf
[4096];

912 
no_d«mÚ
 = 0;

913 
is_d«mÚ
 = 0;

914 
is_£rv”
 = 0;

915 
³rsi¡
 = 0;

916 
r
;

917 
quÙe
;

918 
Œª¥Üt_ty³
 
‰y³
 = 
kT¿n¥ÜtAny
;

919 * 
£rŸl
 = 
NULL
;

920 * 
£rv”_pÜt_¡r
 = 
NULL
;

928 
gProduùOutP©h
 = 
	`g‘’v
("ANDROID_PRODUCT_OUT");

929 ià(
gProduùOutP©h
 =ğ
NULL
 || gProductOutPath[0] == '\0') {

930 
gProduùOutP©h
 = 
NULL
;

934 
£rŸl
 = 
	`g‘’v
("ANDROID_SERIAL");

937 
£rv”_pÜt_¡r
 = 
	`g‘’v
("ANDROID_ADB_SERVER_PORT");

938 
£rv”_pÜt
 = 
DEFAULT_ADB_PORT
;

939 ià(
£rv”_pÜt_¡r
 && 
	`¡¾’
(server_port_str) > 0) {

940 
£rv”_pÜt
 = (è
	`¡¹Ş
(
£rv”_pÜt_¡r
, 
NULL
, 0);

941 ià(
£rv”_pÜt
 <= 0) {

942 
	`årštf
(
¡d”r
,

944 
£rv”_pÜt_¡r
);

945  
	`u§ge
();

950 
¬gc
 > 0) {

951 if(!
	`¡rcmp
(
¬gv
[0],"server")) {

952 
is_£rv”
 = 1;

953 } if(!
	`¡rcmp
(
¬gv
[0],"nodaemon")) {

954 
no_d«mÚ
 = 1;

955 } ià(!
	`¡rcmp
(
¬gv
[0], "fork-server")) {

957 
is_d«mÚ
 = 1;

958 } if(!
	`¡rcmp
(
¬gv
[0],"persist")) {

959 
³rsi¡
 = 1;

960 } if(!
	`¡ºcmp
(
¬gv
[0], "-p", 2)) {

961 cÚ¡ *
´oduù
 = 
NULL
;

962 ià(
¬gv
[0][2] == '\0') {

963 ià(
¬gc
 < 2è 
	`u§ge
();

964 
´oduù
 = 
¬gv
[1];

965 
¬gc
--;

966 
¬gv
++;

968 
´oduù
 = 
¬gv
[0] + 2;

970 
gProduùOutP©h
 = 
	`fšd_´oduù_out_·th
(
´oduù
);

971 ià(
gProduùOutP©h
 =ğ
NULL
) {

972 
	`årštf
(
¡d”r
, "adb: could‚ot„esolve \"-p %s\"\n",

973 
´oduù
);

974  
	`u§ge
();

976 } ià(
¬gv
[0][0]=='-' &&‡rgv[0][1]=='s') {

977 ià(
	`isdig™
(
¬gv
[0][2])) {

978 
£rŸl
 = 
¬gv
[0] + 2;

980 if(
¬gc
 < 2 || 
¬gv
[0][2] !ğ'\0'è 
	`u§ge
();

981 
£rŸl
 = 
¬gv
[1];

982 
¬gc
--;

983 
¬gv
++;

985 } ià(!
	`¡rcmp
(
¬gv
[0],"-d")) {

986 
‰y³
 = 
kT¿n¥ÜtUsb
;

987 } ià(!
	`¡rcmp
(
¬gv
[0],"-e")) {

988 
‰y³
 = 
kT¿n¥ÜtLoÿl
;

993 
¬gc
--;

994 
¬gv
++;

997 
	`adb_£t_Œª¥Üt
(
‰y³
, 
£rŸl
);

998 
	`adb_£t_tı_¥ecifics
(
£rv”_pÜt
);

1000 ià(
is_£rv”
) {

1001 ià(
no_d«mÚ
 || 
is_d«mÚ
) {

1002 
r
 = 
	`adb_maš
(
is_d«mÚ
, 
£rv”_pÜt
);

1004 
r
 = 
	`Ïunch_£rv”
(
£rv”_pÜt
);

1006 if(
r
) {

1007 
	`årštf
(
¡d”r
,"* could‚ot start server *\n");

1009  
r
;

1012 
tİ
:

1013 if(
¬gc
 == 0) {

1014  
	`u§ge
();

1019 if(!
	`¡rcmp
(
¬gv
[0], "devices")) {

1020 *
tmp
;

1021 *
li¡İt
;

1022 ià(
¬gc
 < 2)

1023 
li¡İt
 = "";

1024 ià(
¬gc
 =ğ2 && !
	`¡rcmp
(
¬gv
[1], "-l"))

1025 
li¡İt
 = 
¬gv
[1];

1027 
	`årštf
(
¡d”r
, "Usage:‡db devices [-l]\n");

1030 
	`¢´štf
(
buf
,  buf, "ho¡:%s%s", 
¬gv
[0], 
li¡İt
);

1031 
tmp
 = 
	`adb_qu”y
(
buf
);

1032 if(
tmp
) {

1033 
	`´štf
("List of devices‡ttached \n");

1034 
	`´štf
("%s\n", 
tmp
);

1041 if(!
	`¡rcmp
(
¬gv
[0], "connect")) {

1042 *
tmp
;

1043 ià(
¬gc
 != 2) {

1044 
	`årštf
(
¡d”r
, "Usage:‡db connect <host>[:<port>]\n");

1047 
	`¢´štf
(
buf
,  buf, "ho¡:cÚÃù:%s", 
¬gv
[1]);

1048 
tmp
 = 
	`adb_qu”y
(
buf
);

1049 if(
tmp
) {

1050 
	`´štf
("%s\n", 
tmp
);

1057 if(!
	`¡rcmp
(
¬gv
[0], "disconnect")) {

1058 *
tmp
;

1059 ià(
¬gc
 > 2) {

1060 
	`årštf
(
¡d”r
, "Usage:‡db disconnect [<host>[:<port>]]\n");

1063 ià(
¬gc
 == 2) {

1064 
	`¢´štf
(
buf
,  buf, "ho¡:discÚÃù:%s", 
¬gv
[1]);

1066 
	`¢´štf
(
buf
,  buf, "host:disconnect:");

1068 
tmp
 = 
	`adb_qu”y
(
buf
);

1069 if(
tmp
) {

1070 
	`´štf
("%s\n", 
tmp
);

1077 ià(!
	`¡rcmp
(
¬gv
[0], "emu")) {

1078  
	`adb_£nd_emuÏtÜ_commªd
(
¬gc
, 
¬gv
);

1081 if(!
	`¡rcmp
(
¬gv
[0], "shell") || !strcmp(argv[0], "hell")) {

1082 
r
;

1083 
fd
;

1085 
h
 = (
¬gv
[0][0] == 'h');

1087 ià(
h
) {

1088 
	`´štf
("\x1b[41;33m");

1089 
	`fæush
(
¡dout
);

1092 if(
¬gc
 < 2) {

1093 
	`D
("starting interactive shell\n");

1094 
r
 = 
	`š‹¿ùive_sh–l
();

1095 ià(
h
) {

1096 
	`´štf
("\x1b[0m");

1097 
	`fæush
(
¡dout
);

1099  
r
;

1102 
	`¢´štf
(
buf
,  buf, "sh–l:%s", 
¬gv
[1]);

1103 
¬gc
 -= 2;

1104 
¬gv
 += 2;

1105 
¬gc
-- > 0) {

1106 
	`¡rÿt
(
buf
, " ");

1109 
quÙe
 = (**
¬gv
 =ğ0 || 
	`¡rchr
(*argv, ' '));

1110 ià(
quÙe
)

1111 
	`¡rÿt
(
buf
, "\"");

1112 
	`¡rÿt
(
buf
, *
¬gv
++);

1113 ià(
quÙe
)

1114 
	`¡rÿt
(
buf
, "\"");

1118 
	`D
("š‹¿ùivsh–Èloİ. buff=%s\n", 
buf
);

1119 
fd
 = 
	`adb_cÚÃù
(
buf
);

1120 if(
fd
 >= 0) {

1121 
	`D
("abouˆtØ»ad_ªd_dump(fd=%d)\n", 
fd
);

1122 
	`»ad_ªd_dump
(
fd
);

1123 
	`D
("read_and_dump() done.\n");

1124 
	`adb_şo£
(
fd
);

1125 
r
 = 0;

1127 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

1128 
r
 = -1;

1131 if(
³rsi¡
) {

1132 
	`årštf
(
¡d”r
,"\n- waiting for device -\n");

1133 
	`adb_¦“p_ms
(1000);

1134 
	`do_cmd
(
‰y³
, 
£rŸl
, "wait-for-device", 0);

1136 ià(
h
) {

1137 
	`´štf
("\x1b[0m");

1138 
	`fæush
(
¡dout
);

1140 
	`D
("š‹¿ùivsh–Èloİ.„‘uº„=%d\n", 
r
);

1141  
r
;

1146 if(!
	`¡rcmp
(
¬gv
[0], "kill-server")) {

1147 
fd
;

1148 
fd
 = 
	`_adb_cÚÃù
("host:kill");

1149 if(
fd
 == -1) {

1150 
	`årštf
(
¡d”r
,"* server‚ot„unning *\n");

1156 if(!
	`¡rcmp
(
¬gv
[0], "sideload")) {

1157 if(
¬gc
 !ğ2è 
	`u§ge
();

1158 if(
	`adb_dowÆßd
("sid–ßd", 
¬gv
[1], 1)) {

1165 if(!
	`¡rcmp
(
¬gv
[0], "remount") || !strcmp(argv[0], "reboot")

1166 || !
	`¡rcmp
(
¬gv
[0], "reboot-bootloader")

1167 || !
	`¡rcmp
(
¬gv
[0], "tcpip") || !strcmp(argv[0], "usb")

1168 || !
	`¡rcmp
(
¬gv
[0], "root")) {

1169 
commªd
[100];

1170 ià(!
	`¡rcmp
(
¬gv
[0], "reboot-bootloader"))

1171 
	`¢´štf
(
commªd
, (command), "reboot:bootloader");

1172 ià(
¬gc
 > 1)

1173 
	`¢´štf
(
commªd
, (commªd), "%s:%s", 
¬gv
[0],‡rgv[1]);

1175 
	`¢´štf
(
commªd
, (commªd), "%s:", 
¬gv
[0]);

1176 
fd
 = 
	`adb_cÚÃù
(
commªd
);

1177 if(
fd
 >= 0) {

1178 
	`»ad_ªd_dump
(
fd
);

1179 
	`adb_şo£
(
fd
);

1182 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

1186 if(!
	`¡rcmp
(
¬gv
[0], "bugreport")) {

1187 ià(
¬gc
 !ğ1è 
	`u§ge
();

1188 
	`do_cmd
(
‰y³
, 
£rŸl
, "shell", "bugreport", 0);

1194 if(!
	`¡ºcmp
(
¬gv
[0], "wa™-fÜ-", 
	`¡¾’
("wait-for-"))) {

1195 * 
£rviû
 = 
¬gv
[0];

1196 ià(!
	`¡ºcmp
(
£rviû
, "wa™-fÜ-deviû", 
	`¡¾’
("wait-for-device"))) {

1197 ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
) {

1198 
£rviû
 = "wait-for-usb";

1199 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
) {

1200 
£rviû
 = "wait-for-local";

1202 
£rviû
 = "wait-for-any";

1206 
	`fÜm©_ho¡_commªd
(
buf
,  buf, 
£rviû
, 
‰y³
, 
£rŸl
);

1208 ià(
	`adb_commªd
(
buf
)) {

1209 
	`D
("çu»: % *\n",
	`adb_”rÜ
());

1210 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

1217 if(
¬gc
 > 1) {

1218 
¬gc
--;

1219 
¬gv
++;

1220 
tİ
;

1225 if(!
	`¡rcmp
(
¬gv
[0], "forward")) {

1226 if(
¬gc
 !ğ3è 
	`u§ge
();

1227 ià(
£rŸl
) {

1228 
	`¢´štf
(
buf
,  buf, "ho¡-£rŸl:%s:fÜw¬d:%s;%s",
£rŸl
, 
¬gv
[1],‡rgv[2]);

1229 } ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
) {

1230 
	`¢´štf
(
buf
,  buf, "ho¡-usb:fÜw¬d:%s;%s", 
¬gv
[1],‡rgv[2]);

1231 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
) {

1232 
	`¢´štf
(
buf
,  buf, "ho¡-loÿl:fÜw¬d:%s;%s", 
¬gv
[1],‡rgv[2]);

1234 
	`¢´štf
(
buf
,  buf, "ho¡:fÜw¬d:%s;%s", 
¬gv
[1],‡rgv[2]);

1236 if(
	`adb_commªd
(
buf
)) {

1237 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

1245 if(!
	`¡rcmp
(
¬gv
[0], "ls")) {

1246 if(
¬gc
 !ğ2è 
	`u§ge
();

1247  
	`do_sync_ls
(
¬gv
[1]);

1250 if(!
	`¡rcmp
(
¬gv
[0], "push")) {

1251 if(
¬gc
 !ğ3è 
	`u§ge
();

1252  
	`do_sync_push
(
¬gv
[1],‡rgv[2], 0 );

1255 if(!
	`¡rcmp
(
¬gv
[0], "pull")) {

1256 ià(
¬gc
 == 2) {

1257  
	`do_sync_puÎ
(
¬gv
[1], ".");

1258 } ià(
¬gc
 == 3) {

1259  
	`do_sync_puÎ
(
¬gv
[1],‡rgv[2]);

1261  
	`u§ge
();

1265 if(!
	`¡rcmp
(
¬gv
[0], "install")) {

1266 ià(
¬gc
 < 2è 
	`u§ge
();

1267  
	`š¡®l_­p
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1270 if(!
	`¡rcmp
(
¬gv
[0], "uninstall")) {

1271 ià(
¬gc
 < 2è 
	`u§ge
();

1272  
	`unš¡®l_­p
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1275 if(!
	`¡rcmp
(
¬gv
[0], "sync")) {

1276 *
¤ÿrg
, *
ªdroid_¤ı©h
, *
d©a_¤ı©h
;

1277 
li¡Úly
 = 0;

1279 
»t
;

1280 if(
¬gc
 < 2) {

1282 
¤ÿrg
 = 
NULL
;

1283 } ià(
¬gc
 >ğ2 && 
	`¡rcmp
(
¬gv
[1], "-l") == 0) {

1284 
li¡Úly
 = 1;

1285 ià(
¬gc
 == 3) {

1286 
¤ÿrg
 = 
¬gv
[2];

1288 
¤ÿrg
 = 
NULL
;

1290 } if(
¬gc
 == 2) {

1292 
¤ÿrg
 = 
¬gv
[1];

1294  
	`u§ge
();

1296 
»t
 = 
	`fšd_sync_dœs
(
¤ÿrg
, &
ªdroid_¤ı©h
, &
d©a_¤ı©h
);

1297 if(
»t
 !ğ0è 
	`u§ge
();

1299 if(
ªdroid_¤ı©h
 !ğ
NULL
)

1300 
»t
 = 
	`do_sync_sync
(
ªdroid_¤ı©h
, "/sy¡em", 
li¡Úly
);

1301 if(
»t
 =ğ0 && 
d©a_¤ı©h
 !ğ
NULL
)

1302 
»t
 = 
	`do_sync_sync
(
d©a_¤ı©h
, "/d©a", 
li¡Úly
);

1304 
	`ä“
(
ªdroid_¤ı©h
);

1305 
	`ä“
(
d©a_¤ı©h
);

1306  
»t
;

1311 if(!
	`¡rcmp
(
¬gv
[0],"get-state") ||

1312 !
	`¡rcmp
(
¬gv
[0],"get-serialno") ||

1313 !
	`¡rcmp
(
¬gv
[0],"get-devpath"))

1315 *
tmp
;

1317 
	`fÜm©_ho¡_commªd
(
buf
,  buf, 
¬gv
[0], 
‰y³
, 
£rŸl
);

1318 
tmp
 = 
	`adb_qu”y
(
buf
);

1319 if(
tmp
) {

1320 
	`´štf
("%s\n", 
tmp
);

1329 if(!
	`¡rcmp
(
¬gv
[0],"status-window")) {

1330 
	`¡©us_wšdow
(
‰y³
, 
£rŸl
);

1334 if(!
	`¡rcmp
(
¬gv
[0],"logcat") || !strcmp(argv[0],"lolcat") || !strcmp(argv[0],"longcat")) {

1335  
	`logÿt
(
‰y³
, 
£rŸl
, 
¬gc
, 
¬gv
);

1338 if(!
	`¡rcmp
(
¬gv
[0],"ppp")) {

1339  
	`µp
(
¬gc
, 
¬gv
);

1342 ià(!
	`¡rcmp
(
¬gv
[0], "start-server")) {

1343  
	`adb_cÚÃù
("host:start-server");

1346 ià(!
	`¡rcmp
(
¬gv
[0], "backup")) {

1347  
	`backup
(
¬gc
, 
¬gv
);

1350 ià(!
	`¡rcmp
(
¬gv
[0], "restore")) {

1351  
	`»¡Üe
(
¬gc
, 
¬gv
);

1354 ià(!
	`¡rcmp
(
¬gv
[0], "jdwp")) {

1355 
fd
 = 
	`adb_cÚÃù
("jdwp");

1356 ià(
fd
 >= 0) {

1357 
	`»ad_ªd_dump
(
fd
);

1358 
	`adb_şo£
(
fd
);

1361 
	`årštf
(
¡d”r
, "”rÜ: %s\n", 
	`adb_”rÜ
());

1367 if(!
	`¡rcmp
(
¬gv
[0], "help") || !strcmp(argv[0], "/?")) {

1368 
	`h–p
();

1372 if(!
	`¡rcmp
(
¬gv
[0], "version")) {

1373 
	`v”siÚ
(
¡dout
);

1377 
	`u§ge
();

1379 
	}
}

1381 
	$do_cmd
(
Œª¥Üt_ty³
 
‰y³
, * 
£rŸl
, *
cmd
, ...)

1383 *
¬gv
[16];

1384 
¬gc
;

1385 
va_li¡
 
­
;

1387 
	`va_¡¬t
(
­
, 
cmd
);

1388 
¬gc
 = 0;

1390 ià(
£rŸl
) {

1391 
¬gv
[
¬gc
++] = "-s";

1392 
¬gv
[
¬gc
++] = 
£rŸl
;

1393 } ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
) {

1394 
¬gv
[
¬gc
++] = "-d";

1395 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
) {

1396 
¬gv
[
¬gc
++] = "-e";

1399 
¬gv
[
¬gc
++] = 
cmd
;

1400 (
¬gv
[
¬gc
] = 
	`va_¬g
(
­
, *)) != 0)‡rgc++;

1401 
	`va_’d
(
­
);

1404 
n
;

1405 
	`årštf
(
¡d”r
,"¬gøğ%d\n",
¬gc
);

1406 
n
 = 0;‚ < 
¬gc
;‚++) {

1407 
	`årštf
(
¡d”r
,"¬gv[%d] = \"%s\"\n", 
n
, 
¬gv
[n]);

1411  
	`adb_commªdlše
(
¬gc
, 
¬gv
);

1412 
	}
}

1414 
	$fšd_sync_dœs
(cÚ¡ *
¤ÿrg
,

1415 **
ªdroid_¤cdœ_out
, **
d©a_¤cdœ_out
)

1417 *
ªdroid_¤cdœ
, *
d©a_¤cdœ
;

1419 if(
¤ÿrg
 =ğ
NULL
) {

1420 
ªdroid_¤cdœ
 = 
	`´oduù_fe
("system");

1421 
d©a_¤cdœ
 = 
	`´oduù_fe
("data");

1426 if(
	`¡rcmp
(
¤ÿrg
, "system") == 0) {

1427 
ªdroid_¤cdœ
 = 
	`´oduù_fe
("system");

1428 
d©a_¤cdœ
 = 
NULL
;

1429 } if(
	`¡rcmp
(
¤ÿrg
, "data") == 0) {

1430 
ªdroid_¤cdœ
 = 
NULL
;

1431 
d©a_¤cdœ
 = 
	`´oduù_fe
("data");

1439 if(
ªdroid_¤cdœ_out
 !ğ
NULL
)

1440 *
ªdroid_¤cdœ_out
 = 
ªdroid_¤cdœ
;

1442 
	`ä“
(
ªdroid_¤cdœ
);

1444 if(
d©a_¤cdœ_out
 !ğ
NULL
)

1445 *
d©a_¤cdœ_out
 = 
d©a_¤cdœ
;

1447 
	`ä“
(
d©a_¤cdœ
);

1450 
	}
}

1452 
	$pm_commªd
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
,

1453 
¬gc
, ** 
¬gv
)

1455 
buf
[4096];

1457 
	`¢´štf
(
buf
, (buf), "shell:pm");

1459 
¬gc
-- > 0) {

1460 *
quÙed
;

1462 
quÙed
 = 
	`dupAndQuÙe
(*
¬gv
++);

1464 
	`¡ºÿt
(
buf
, " ", (buf)-1);

1465 
	`¡ºÿt
(
buf
, 
quÙed
, (buf)-1);

1466 
	`ä“
(
quÙed
);

1469 
	`£nd_sh–lcommªd
(
Œª¥Üt
, 
£rŸl
, 
buf
);

1471 
	}
}

1473 
	$unš¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, 
¬gc
, ** 
¬gv
)

1477 ià(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1], "-k") == 0)

1479 
	`´štf
(

1483 "Iàyouruly wishØcÚtšue,ƒxecu‹ 'adb sh–Èpm unš¡®È-k %s'\n", 
¬gv
[2]);

1488  
	`pm_commªd
(
Œª¥Üt
, 
£rŸl
, 
¬gc
, 
¬gv
);

1489 
	}
}

1491 
	$d–‘e_fe
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, * 
f’ame
)

1493 
buf
[4096];

1494 * 
quÙed
;

1496 
	`¢´štf
(
buf
, (buf), "shell:rm ");

1497 
quÙed
 = 
	`dupAndQuÙe
(
f’ame
);

1498 
	`¡ºÿt
(
buf
, 
quÙed
, (buf)-1);

1499 
	`ä“
(
quÙed
);

1501 
	`£nd_sh–lcommªd
(
Œª¥Üt
, 
£rŸl
, 
buf
);

1503 
	}
}

1505 cÚ¡ * 
	$g‘_ba£Çme
(cÚ¡ * 
f’ame
)

1507 cÚ¡ * 
ba£Çme
 = 
	`adb_dœ¡İ
(
f’ame
);

1508 ià(
ba£Çme
) {

1509 
ba£Çme
++;

1510  
ba£Çme
;

1512  
f’ame
;

1514 
	}
}

1516 
	$check_fe
(cÚ¡ * 
f’ame
)

1518 
¡©
 
¡
;

1520 ià(
f’ame
 =ğ
NULL
) {

1524 ià(
	`¡©
(
f’ame
, &
¡
) != 0) {

1525 
	`årštf
(
¡d”r
, "ÿn'ˆfšd '%s'Øš¡®l\n", 
f’ame
);

1529 ià(!
	`S_ISREG
(
¡
.
¡_mode
)) {

1530 
	`årštf
(
¡d”r
, "ÿn'ˆš¡®È'%s' beÿu£ it' nÙ‡ fe\n", 
f’ame
);

1535 
	}
}

1537 
	$š¡®l_­p
(
Œª¥Üt_ty³
 
Œª¥Üt
, * 
£rŸl
, 
¬gc
, ** 
¬gv
)

1539 cÚ¡ *cÚ¡ 
DATA_DEST
 = "/data/local/tmp/%s";

1540 cÚ¡ *cÚ¡ 
SD_DEST
 = "/sdcard/tmp/%s";

1541 cÚ¡ * 
wh”e
 = 
DATA_DEST
;

1542 
­k_de¡
[
PATH_MAX
];

1543 
v”ifiÿtiÚ_de¡
[
PATH_MAX
];

1544 * 
­k_fe
;

1545 * 
v”ifiÿtiÚ_fe
 = 
NULL
;

1546 
fe_¬g
 = -1;

1547 
”r
;

1548 
i
;

1549 
v”ify_­k
 = 1;

1551 
i
 = 1; i < 
¬gc
; i++) {

1552 ià(*
¬gv
[
i
] != '-') {

1553 
fe_¬g
 = 
i
;

1555 } ià(!
	`¡rcmp
(
¬gv
[
i
], "-i")) {

1557 
i
++;

1558 } ià(!
	`¡rcmp
(
¬gv
[
i
], "-s")) {

1559 
wh”e
 = 
SD_DEST
;

1560 } ià(!
	`¡rcmp
(
¬gv
[
i
], "--algo")) {

1561 
v”ify_­k
 = 0;

1562 
i
++;

1563 } ià(!
	`¡rcmp
(
¬gv
[
i
], "--iv")) {

1564 
v”ify_­k
 = 0;

1565 
i
++;

1566 } ià(!
	`¡rcmp
(
¬gv
[
i
], "--key")) {

1567 
v”ify_­k
 = 0;

1568 
i
++;

1572 ià(
fe_¬g
 < 0) {

1573 
	`årštf
(
¡d”r
, "can't find filename in‡rguments\n");

1575 } ià(
fe_¬g
 + 2 < 
¬gc
) {

1576 
	`årštf
(
¡d”r
, "too many files specified; onlyakes APK file‡nd verifier file\n");

1580 
­k_fe
 = 
¬gv
[
fe_¬g
];

1582 ià(
fe_¬g
 !ğ
¬gc
 - 1) {

1583 
v”ifiÿtiÚ_fe
 = 
¬gv
[
fe_¬g
 + 1];

1586 ià(
	`check_fe
(
­k_fe
è|| check_fe(
v”ifiÿtiÚ_fe
)) {

1590 
	`¢´štf
(
­k_de¡
, ‡pk_de¡, 
wh”e
, 
	`g‘_ba£Çme
(
­k_fe
));

1591 ià(
v”ifiÿtiÚ_fe
 !ğ
NULL
) {

1592 
	`¢´štf
(
v”ifiÿtiÚ_de¡
, (v”ifiÿtiÚ_de¡), 
wh”e
, 
	`g‘_ba£Çme
(
v”ifiÿtiÚ_fe
));

1594 ià(!
	`¡rcmp
(
­k_de¡
, 
v”ifiÿtiÚ_de¡
)) {

1595 
	`årštf
(
¡d”r
, "APK‡nd verification file can't havehe same‚ame\n");

1600 
”r
 = 
	`do_sync_push
(
­k_fe
, 
­k_de¡
, 
v”ify_­k
);

1601 ià(
”r
) {

1602 
ş—nup_­k
;

1604 
¬gv
[
fe_¬g
] = 
­k_de¡
;

1607 ià(
v”ifiÿtiÚ_fe
 !ğ
NULL
) {

1608 
”r
 = 
	`do_sync_push
(
v”ifiÿtiÚ_fe
, 
v”ifiÿtiÚ_de¡
, 0 );

1609 ià(
”r
) {

1610 
ş—nup_­k
;

1612 
¬gv
[
fe_¬g
 + 1] = 
v”ifiÿtiÚ_de¡
;

1616 
	`pm_commªd
(
Œª¥Üt
, 
£rŸl
, 
¬gc
, 
¬gv
);

1618 
ş—nup_­k
:

1619 ià(
v”ifiÿtiÚ_fe
 !ğ
NULL
) {

1620 
	`d–‘e_fe
(
Œª¥Üt
, 
£rŸl
, 
v”ifiÿtiÚ_de¡
);

1623 
	`d–‘e_fe
(
Œª¥Üt
, 
£rŸl
, 
­k_de¡
);

1625  
”r
;

1626 
	}
}

	@console.c

1 
	~"sysd•s.h
"

2 
	~"adb.h
"

3 
	~"adb_ş›Á.h
"

4 
	~<¡dio.h
>

6 
	$cÚÃù_to_cÚsŞe
()

8 
fd
, 
pÜt
;

10 
pÜt
 = 
	`adb_g‘_emuÏtÜ_cÚsŞe_pÜt
();

11 ià(
pÜt
 < 0) {

12 ià(
pÜt
 == -2)

13 
	`årštf
(
¡d”r
, "error: morehan oneƒmulator detected. use -s option\n");

15 
	`årštf
(
¡d”r
, "error:‚oƒmulator detected\n");

18 
fd
 = 
	`sock‘_loİback_ş›Á
Ğ
pÜt
, 
SOCK_STREAM
 );

19 ià(
fd
 < 0) {

20 
	`årštf
(
¡d”r
, "”rÜ: could‚Ù cÚÃùØTCP…Üˆ%d\n", 
pÜt
);

23  
fd
;

24 
	}
}

27 
	$adb_£nd_emuÏtÜ_commªd
(
¬gc
, ** 
¬gv
)

29 
fd
, 
Â
;

31 
fd
 = 
	`cÚÃù_to_cÚsŞe
();

32 ià(
fd
 < 0)

35 
	#QUIT
 "qu™\n"

	)

37 
Â
 = 1;‚À< 
¬gc
;‚n++) {

38 
	`adb_wr™e
Ğ
fd
, 
¬gv
[
Â
], 
	`¡¾’
(argv[nn]) );

39 
	`adb_wr™e
Ğ
fd
, (
Â
 =ğ
¬gc
-1) ? "\n" : " ", 1 );

41 
	`adb_wr™e
Ğ
fd
, 
QUIT
, (QUIT)-1 );

42 
	`adb_şo£
(
fd
);

45 
	}
}

	@fdevent.c

18 
	~<sys/ioùl.h
>

20 
	~<¡dlib.h
>

21 
	~<¡dio.h
>

22 
	~<¡ršg.h
>

23 
	~<uni¡d.h
>

24 
	~<”ºo.h
>

26 
	~<fú.h
>

28 
	~<¡d¬g.h
>

29 
	~<¡ddef.h
>

31 
	~"fdev’t.h
"

32 
	~"Œª¥Üt.h
"

33 
	~"sysd•s.h
"

40 
	#DEBUG
 0

	)

45 
	gSHELL_EXIT_NOTIFY_FD
 = -1;

47 
	$çl
(cÚ¡ *
â
, cÚ¡ *
fmt
, ...)

49 
va_li¡
 
­
;

50 
	`va_¡¬t
(
­
, 
fmt
);

51 
	`årštf
(
¡d”r
, "%s:", 
â
);

52 
	`vårštf
(
¡d”r
, 
fmt
, 
­
);

53 
	`va_’d
(
­
);

54 
	`abÜt
();

55 
	}
}

57 
	#FATAL
(
x
...è
	`çl
(
__FUNCTION__
, x)

	)

59 #ià
DEBUG


60 
	#D
(...) \

62 
	`adb_mu‹x_lock
(&
D_lock
); \

63 
§ve_”ºo
 = 
”ºo
; \

64 
	`årštf
(
¡d”r
, "%s::%s():", 
__FILE__
, 
__FUNCTION__
); \

65 
”ºo
 = 
§ve_”ºo
; \

66 
	`årštf
(
¡d”r
, 
__VA_ARGS__
); \

67 
	`adb_mu‹x_uÆock
(&
D_lock
); \

68 
”ºo
 = 
§ve_”ºo
; \

69 } 0)

	)

70 
	$dump_fde
(
fdev’t
 *
fde
, cÚ¡ *
šfo
)

72 
	`adb_mu‹x_lock
(&
D_lock
);

73 
	`årštf
(
¡d”r
,"FDE #%03d %c%c%ø%s\n", 
fde
->
fd
,

74 
fde
->
¡©e
 & 
FDE_READ
 ? 'R' : ' ',

75 
fde
->
¡©e
 & 
FDE_WRITE
 ? 'W' : ' ',

76 
fde
->
¡©e
 & 
FDE_ERROR
 ? 'E' : ' ',

77 
šfo
);

78 
	`adb_mu‹x_uÆock
(&
D_lock
);

79 
	}
}

81 
	#D
(...è(()0)

	)

82 
	#dump_fde
(
fde
, 
šfo
èdØ{ } 0)

	)

85 
	#FDE_EVENTMASK
 0x00ff

	)

86 
	#FDE_STATEMASK
 0xff00

	)

88 
	#FDE_ACTIVE
 0x0100

	)

89 
	#FDE_PENDING
 0x0200

	)

90 
	#FDE_CREATED
 0x0400

	)

92 
fdev’t_¶i¡_’queue
(
fdev’t
 *
node
);

93 
fdev’t_¶i¡_»move
(
fdev’t
 *
node
);

94 
fdev’t
 *
fdev’t_¶i¡_dequeue
();

95 
fdev’t_sub´oc_ev’t_func
(
fd
, 
ev’ts
, *
u£rd©a
);

97 
fdev’t
 
	gli¡_³ndšg
 = {

98 .
Ãxt
 = &
li¡_³ndšg
,

99 .
	g´ev
 = &
li¡_³ndšg
,

102 
fdev’t
 **
	gfd_bË
 = 0;

103 
	gfd_bË_max
 = 0;

105 #ifdeà
CRAPTASTIC


108 
	~<sys/•Şl.h
>

110 
	g•Şl_fd
 = -1;

112 
	$fdev’t_š™
()

115 
•Şl_fd
 = 
	`•Şl_ü—‹
(256);

117 if(
•Şl_fd
 < 0) {

118 
	`³¼Ü
("epoll_create() failed");

119 
	`ex™
(1);

123 
	`fú
(
•Şl_fd
, 
F_SETFD
, 
FD_CLOEXEC
);

124 
	}
}

126 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

128 
•Şl_ev’t
 
ev
;

130 
	`mem£t
(&
ev
, 0, (ev));

131 
ev
.
ev’ts
 = 0;

132 
ev
.
d©a
.
±r
 = 
fde
;

135 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_ADD
, 
fde
->
fd
, &
ev
)) {

136 
	`³¼Ü
("epoll_ctl() failed\n");

137 
	`ex™
(1);

140 
	}
}

142 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

144 
•Şl_ev’t
 
ev
;

146 
	`mem£t
(&
ev
, 0, (ev));

147 
ev
.
ev’ts
 = 0;

148 
ev
.
d©a
.
±r
 = 
fde
;

155 
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_DEL
, 
fde
->
fd
, &
ev
);

156 
	}
}

158 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

160 
•Şl_ev’t
 
ev
;

161 
aùive
;

163 
aùive
 = (
fde
->
¡©e
 & 
FDE_EVENTMASK
) != 0;

165 
	`mem£t
(&
ev
, 0, (ev));

166 
ev
.
ev’ts
 = 0;

167 
ev
.
d©a
.
±r
 = 
fde
;

169 if(
ev’ts
 & 
FDE_READ
è
ev
.ev’t |ğ
EPOLLIN
;

170 if(
ev’ts
 & 
FDE_WRITE
è
ev
.ev’t |ğ
EPOLLOUT
;

171 if(
ev’ts
 & 
FDE_ERROR
è
ev
.ev’t |ğ(
EPOLLERR
 | 
EPOLLHUP
);

173 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

175 if(
aùive
) {

180 if(
ev
.
ev’ts
) {

181 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_MOD
, 
fde
->
fd
, &
ev
)) {

182 
	`³¼Ü
("epoll_ctl() failed\n");

183 
	`ex™
(1);

186 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_DEL
, 
fde
->
fd
, &
ev
)) {

187 
	`³¼Ü
("epoll_ctl() failed\n");

188 
	`ex™
(1);

195 if(
ev
.
ev’ts
) {

196 if(
	`•Şl_ùl
(
•Şl_fd
, 
EPOLL_CTL_ADD
, 
fde
->
fd
, &
ev
)) {

197 
	`³¼Ü
("epoll_ctl() failed\n");

198 
	`ex™
(1);

202 
	}
}

204 
	$fdev’t_´oûss
()

206 
•Şl_ev’t
 
ev’ts
[256];

207 
fdev’t
 *
fde
;

208 
i
, 
n
;

210 
n
 = 
	`•Şl_wa™
(
•Şl_fd
, 
ev’ts
, 256, -1);

212 if(
n
 < 0) {

213 if(
”ºo
 =ğ
EINTR
) ;

214 
	`³¼Ü
("epoll_wait");

215 
	`ex™
(1);

218 
i
 = 0; i < 
n
; i++) {

219 
•Şl_ev’t
 *
ev
 = 
ev’ts
 + 
i
;

220 
fde
 = 
ev
->
d©a
.
±r
;

222 if(
ev
->
ev’ts
 & 
EPOLLIN
) {

223 
fde
->
ev’ts
 |ğ
FDE_READ
;

225 if(
ev
->
ev’ts
 & 
EPOLLOUT
) {

226 
fde
->
ev’ts
 |ğ
FDE_WRITE
;

228 if(
ev
->
ev’ts
 & (
EPOLLERR
 | 
EPOLLHUP
)) {

229 
fde
->
ev’ts
 |ğ
FDE_ERROR
;

231 if(
fde
->
ev’ts
) {

232 if(
fde
->
¡©e
 & 
FDE_PENDING
) ;

233 
fde
->
¡©e
 |ğ
FDE_PENDING
;

234 
	`fdev’t_¶i¡_’queue
(
fde
);

237 
	}
}

241 #ifdeà
HAVE_WINSOCK


242 
	~<wšsock2.h
>

244 
	~<sys/£Ëù.h
>

247 
fd_£t
 
	g»ad_fds
;

248 
fd_£t
 
	gwr™e_fds
;

249 
fd_£t
 
	g”rÜ_fds
;

251 
	g£Ëù_n
 = 0;

253 
	$fdev’t_š™
()

255 
	`FD_ZERO
(&
»ad_fds
);

256 
	`FD_ZERO
(&
wr™e_fds
);

257 
	`FD_ZERO
(&
”rÜ_fds
);

258 
	}
}

260 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

262 if(
fde
->
fd
 >ğ
£Ëù_n
) {

263 
£Ëù_n
 = 
fde
->
fd
 + 1;

265 
	}
}

267 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

269 
i
, 
n
;

271 
	`FD_CLR
(
fde
->
fd
, &
»ad_fds
);

272 
	`FD_CLR
(
fde
->
fd
, &
wr™e_fds
);

273 
	`FD_CLR
(
fde
->
fd
, &
”rÜ_fds
);

275 
n
 = 0, 
i
 = 0; i < 
£Ëù_n
; i++) {

276 if(
fd_bË
[
i
] !ğ0è
n
 = i;

278 
£Ëù_n
 = 
n
 + 1;

279 
	}
}

281 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

283 if(
ev’ts
 & 
FDE_READ
) {

284 
	`FD_SET
(
fde
->
fd
, &
»ad_fds
);

286 
	`FD_CLR
(
fde
->
fd
, &
»ad_fds
);

288 if(
ev’ts
 & 
FDE_WRITE
) {

289 
	`FD_SET
(
fde
->
fd
, &
wr™e_fds
);

291 
	`FD_CLR
(
fde
->
fd
, &
wr™e_fds
);

293 if(
ev’ts
 & 
FDE_ERROR
) {

294 
	`FD_SET
(
fde
->
fd
, &
”rÜ_fds
);

296 
	`FD_CLR
(
fde
->
fd
, &
”rÜ_fds
);

299 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

300 
	}
}

305 
	$fdev’t_fd_check
(
fd_£t
 *
fds
)

307 
i
, 
n
 = 0;

308 
fdev’t
 *
fde
;

310 
i
 = 0; i < 
£Ëù_n
; i++) {

311 
fde
 = 
fd_bË
[
i
];

312 if(
fde
 == 0) ;

313 if(
	`fú
(
i
, 
F_GETFL
, 
NULL
) < 0) {

314 
	`FD_SET
(
i
, 
fds
);

315 
n
++;

320  
n
;

321 
	}
}

323 #ià!
DEBUG


324 
šlše
 
	$dump_®l_fds
(cÚ¡ *
exŒa_msg
è{
	}
}

326 
	$dump_®l_fds
(cÚ¡ *
exŒa_msg
)

328 
i
;

329 
fdev’t
 *
fde
;

331 
msg_buff
[
FD_SETSIZE
*6 + 1], *
pb
=msg_buff;

332 
size_t
 
max_ch¬s
 = 
FD_SETSIZE
 * 6 + 1;

333 
´š‹d_out
;

334 
	#SAFE_SPRINTF
(...) \

336 
´š‹d_out
 = 
	`¢´štf
(
pb
, 
max_ch¬s
, 
__VA_ARGS__
); \

337 ià(
´š‹d_out
 <= 0) { \

338 
	`D
("... snprintf failed.\n"); \

341 ià(
max_ch¬s
 < ()
´š‹d_out
) { \

342 
	`D
("... snprintf out of space.\n"); \

345 
pb
 +ğ
´š‹d_out
; \

346 
max_ch¬s
 -ğ
´š‹d_out
; \

347 } 0)

	)

349 
i
 = 0; i < 
£Ëù_n
; i++) {

350 
fde
 = 
fd_bË
[
i
];

351 
	`SAFE_SPRINTF
("%d", 
i
);

352 if(
fde
 == 0) {

353 
	`SAFE_SPRINTF
("? ");

356 if(
	`fú
(
i
, 
F_GETFL
, 
NULL
) < 0) {

357 
	`SAFE_SPRINTF
("b");

359 
	`SAFE_SPRINTF
(" ");

361 
	`D
("% fd_bË[]->fd = {%s}\n", 
exŒa_msg
, 
msg_buff
);

362 
	}
}

365 
	$fdev’t_´oûss
()

367 
i
, 
n
;

368 
fdev’t
 *
fde
;

369 
ev’ts
;

370 
fd_£t
 
rfd
, 
wfd
, 
efd
;

372 
	`memıy
(&
rfd
, &
»ad_fds
, (
fd_£t
));

373 
	`memıy
(&
wfd
, &
wr™e_fds
, (
fd_£t
));

374 
	`memıy
(&
efd
, &
”rÜ_fds
, (
fd_£t
));

376 
	`dump_®l_fds
("pre select()");

378 
n
 = 
	`£Ëù
(
£Ëù_n
, &
rfd
, &
wfd
, &
efd
, 
NULL
);

379 
§ved_”ºo
 = 
”ºo
;

380 
	`D
("£Ëù(è»tuºed‚=%d,ƒ¼no=%d\n", 
n
,‚<0?
§ved_”ºo
:0);

382 
	`dump_®l_fds
("post select()");

384 if(
n
 < 0) {

385 
§ved_”ºo
) {

386 
EINTR
: ;

387 
EBADF
:

389 
	`FD_ZERO
(&
wfd
);

390 
	`FD_ZERO
(&
efd
);

391 
	`FD_ZERO
(&
rfd
);

394 
	`D
("UÃx³ùed s–eù(è”rÜ=%d\n", 
§ved_”ºo
);

398 if(
n
 <= 0) {

401 
n
 = 
	`fdev’t_fd_check
(&
rfd
);

404 
i
 = 0; (˜< 
£Ëù_n
è&& (
n
 > 0); i++) {

405 
ev’ts
 = 0;

406 if(
	`FD_ISSET
(
i
, &
rfd
)è{ 
ev’ts
 |ğ
FDE_READ
; 
n
--; }

407 if(
	`FD_ISSET
(
i
, &
wfd
)è{ 
ev’ts
 |ğ
FDE_WRITE
; 
n
--; }

408 if(
	`FD_ISSET
(
i
, &
efd
)è{ 
ev’ts
 |ğ
FDE_ERROR
; 
n
--; }

410 if(
ev’ts
) {

411 
fde
 = 
fd_bË
[
i
];

412 if(
fde
 == 0)

413 
	`FATAL
("missšg fdfÜ fd %d\n", 
i
);

415 
fde
->
ev’ts
 |=ƒvents;

417 
	`D
("gotƒvents fde->fd=%dƒvents=%04x, state=%04x\n",

418 
fde
->
fd
, fde->
ev’ts
, fde->
¡©e
);

419 if(
fde
->
¡©e
 & 
FDE_PENDING
) ;

420 
fde
->
¡©e
 |ğ
FDE_PENDING
;

421 
	`fdev’t_¶i¡_’queue
(
fde
);

424 
	}
}

428 
	$fdev’t_»gi¡”
(
fdev’t
 *
fde
)

430 if(
fde
->
fd
 < 0) {

431 
	`FATAL
("bogu Ãg©ivfd (%d)\n", 
fde
->
fd
);

434 if(
fde
->
fd
 >ğ
fd_bË_max
) {

435 
Şdmax
 = 
fd_bË_max
;

436 if(
fde
->
fd
 > 32000) {

437 
	`FATAL
("bogu huuuugfd (%d)\n", 
fde
->
fd
);

439 if(
fd_bË_max
 == 0) {

440 
	`fdev’t_š™
();

441 
fd_bË_max
 = 256;

443 
fd_bË_max
 <ğ
fde
->
fd
) {

444 
fd_bË_max
 *= 2;

446 
fd_bË
 = 
	`»®loc
(fd_bË, (
fdev’t
*è* 
fd_bË_max
);

447 if(
fd_bË
 == 0) {

448 
	`FATAL
("could‚Ùƒx·nd fd_bËØ%dƒÁr›s\n", 
fd_bË_max
);

450 
	`mem£t
(
fd_bË
 + 
Şdmax
, 0, (è* (
fd_bË_max
 - oldmax));

453 
fd_bË
[
fde
->
fd
] = fde;

454 
	}
}

456 
	$fdev’t_uÄegi¡”
(
fdev’t
 *
fde
)

458 if((
fde
->
fd
 < 0è|| (fde->fd >ğ
fd_bË_max
)) {

459 
	`FATAL
("fd ouˆoà¿ng(%d)\n", 
fde
->
fd
);

462 if(
fd_bË
[
fde
->
fd
] != fde) {

463 
	`FATAL
("fd_bË ouˆoàsynø[%d]\n", 
fde
->
fd
);

466 
fd_bË
[
fde
->
fd
] = 0;

468 if(!(
fde
->
¡©e
 & 
FDE_DONT_CLOSE
)) {

469 
	`dump_fde
(
fde
, "close");

470 
	`adb_şo£
(
fde
->
fd
);

472 
	}
}

474 
	$fdev’t_¶i¡_’queue
(
fdev’t
 *
node
)

476 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

478 
node
->
Ãxt
 = 
li¡
;

479 
node
->
´ev
 = 
li¡
->prev;

480 
node
->
´ev
->
Ãxt
 =‚ode;

481 
li¡
->
´ev
 = 
node
;

482 
	}
}

484 
	$fdev’t_¶i¡_»move
(
fdev’t
 *
node
)

486 
node
->
´ev
->
Ãxt
 =‚ode->next;

487 
node
->
Ãxt
->
´ev
 =‚ode->prev;

488 
node
->
Ãxt
 = 0;

489 
node
->
´ev
 = 0;

490 
	}
}

492 
fdev’t
 *
	$fdev’t_¶i¡_dequeue
()

494 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

495 
fdev’t
 *
node
 = 
li¡
->
Ãxt
;

497 if(
node
 =ğ
li¡
)  0;

499 
li¡
->
Ãxt
 = 
node
->next;

500 
li¡
->
Ãxt
->
´ev
 =†ist;

501 
node
->
Ãxt
 = 0;

502 
node
->
´ev
 = 0;

504  
node
;

505 
	}
}

507 
	$fdev’t_ÿÎ_fdfunc
(
fdev’t
* 
fde
)

509 
ev’ts
 = 
fde
->events;

510 
fde
->
ev’ts
 = 0;

511 if(!(
fde
->
¡©e
 & 
FDE_PENDING
)) ;

512 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

513 
	`dump_fde
(
fde
, "callback");

514 
fde
->
	`func
(fde->
fd
, 
ev’ts
, fde->
¬g
);

515 
	}
}

517 
	$fdev’t_sub´oc_ev’t_func
(
fd
, 
ev
, *
u£rd©a
)

520 
	`D
("sub´oøhªdlšg oÀfd=%dƒv=%04x\n", 
fd
, 
ev
);

523 if((
fd
 < 0è|| (fd >ğ
fd_bË_max
)) {

524 
	`FATAL
("fd %d ouˆoà¿ngfÜ fd_bË \n", 
fd
);

526 
fdev’t
 *
fde
 = 
fd_bË
[
fd
];

527 
	`fdev’t_add
(
fde
, 
FDE_READ
);

529 if(
ev
 & 
FDE_READ
){

530 
sub´oc_fd
;

532 if(
	`»adx
(
fd
, &
sub´oc_fd
, (subproc_fd))) {

533 
	`FATAL
("FaedØ»adhsub´oc' fd from fd=%d\n", 
fd
);

535 if((
sub´oc_fd
 < 0è|| (sub´oc_fd >ğ
fd_bË_max
)) {

536 
	`D
("subproc_fd %d out of„ange 0, fd_table_max=%d\n",

537 
sub´oc_fd
, 
fd_bË_max
);

540 
fdev’t
 *
sub´oc_fde
 = 
fd_bË
[
sub´oc_fd
];

541 if(!
sub´oc_fde
) {

542 
	`D
("sub´oc_fd %d cË¬ed from fd_bË\n", 
sub´oc_fd
);

545 if(
sub´oc_fde
->
fd
 !ğ
sub´oc_fd
) {

547 
	`D
("sub´oc_fd %d !ğfd_bË[].fd %d\n", 
sub´oc_fd
, 
sub´oc_fde
->
fd
);

551 
sub´oc_fde
->
fÜû_eof
 = 1;

553 
rcouÁ
 = 0;

554 
	`ioùl
(
sub´oc_fd
, 
FIONREAD
, &
rcouÁ
);

555 
	`D
("subproc with fd=%d has„count=%dƒrr=%d\n",

556 
sub´oc_fd
, 
rcouÁ
, 
”ºo
);

558 if(
rcouÁ
) {

565 
	`D
("sub´oc_fde.¡©e=%04x\n", 
sub´oc_fde
->
¡©e
);

566 
sub´oc_fde
->
ev’ts
 |ğ
FDE_READ
;

567 if(
sub´oc_fde
->
¡©e
 & 
FDE_PENDING
) {

570 
sub´oc_fde
->
¡©e
 |ğ
FDE_PENDING
;

571 
	`fdev’t_ÿÎ_fdfunc
(
sub´oc_fde
);

573 
	}
}

575 
fdev’t
 *
	$fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
)

577 
fdev’t
 *
fde
 = (fdev’t*è
	`m®loc
((fdevent));

578 if(
fde
 == 0)  0;

579 
	`fdev’t_š¡®l
(
fde
, 
fd
, 
func
, 
¬g
);

580 
fde
->
¡©e
 |ğ
FDE_CREATED
;

581  
fde
;

582 
	}
}

584 
	$fdev’t_de¡roy
(
fdev’t
 *
fde
)

586 if(
fde
 == 0) ;

587 if(!(
fde
->
¡©e
 & 
FDE_CREATED
)) {

588 
	`FATAL
("fd%°nÙ c»©ed by fdev’t_ü—‹()\n", 
fde
);

590 
	`fdev’t_»move
(
fde
);

591 
	}
}

593 
	$fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
)

595 
	`mem£t
(
fde
, 0, (
fdev’t
));

596 
fde
->
¡©e
 = 
FDE_ACTIVE
;

597 
fde
->
fd
 = fd;

598 
fde
->
fÜû_eof
 = 0;

599 
fde
->
func
 = func;

600 
fde
->
¬g
 =‡rg;

602 #iâdeà
HAVE_WINSOCK


603 
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
);

605 
	`fdev’t_»gi¡”
(
fde
);

606 
	`dump_fde
(
fde
, "connect");

607 
	`fdev’t_cÚÃù
(
fde
);

608 
fde
->
¡©e
 |ğ
FDE_ACTIVE
;

609 
	}
}

611 
	$fdev’t_»move
(
fdev’t
 *
fde
)

613 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

614 
	`fdev’t_¶i¡_»move
(
fde
);

617 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

618 
	`fdev’t_discÚÃù
(
fde
);

619 
	`dump_fde
(
fde
, "disconnect");

620 
	`fdev’t_uÄegi¡”
(
fde
);

623 
fde
->
¡©e
 = 0;

624 
fde
->
ev’ts
 = 0;

625 
	}
}

628 
	$fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
)

630 
ev’ts
 &ğ
FDE_EVENTMASK
;

632 if((
fde
->
¡©e
 & 
FDE_EVENTMASK
è=ğ
ev’ts
) ;

634 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

635 
	`fdev’t_upd©e
(
fde
, 
ev’ts
);

636 
	`dump_fde
(
fde
, "update");

639 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

641 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

646 
fde
->
ev’ts
 &= (~events);

647 if(
fde
->
ev’ts
 == 0) {

648 
	`fdev’t_¶i¡_»move
(
fde
);

649 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

652 
	}
}

654 
	$fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
)

656 
	`fdev’t_£t
(

657 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è| (
ev’ts
 & FDE_EVENTMASK));

658 
	}
}

660 
	$fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
)

662 
	`fdev’t_£t
(

663 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è& (~(
ev’ts
 & FDE_EVENTMASK)));

664 
	}
}

666 
	$fdev’t_sub´oc_£tup
()

668 
s
[2];

670 if(
	`adb_sock‘·œ
(
s
)) {

671 
	`FATAL
("cannot create shell-exit socket-pair\n");

673 
SHELL_EXIT_NOTIFY_FD
 = 
s
[0];

674 
fdev’t
 *
fde
;

675 
fde
 = 
	`fdev’t_ü—‹
(
s
[1], 
fdev’t_sub´oc_ev’t_func
, 
NULL
);

676 if(!
fde
)

677 
	`FATAL
("cannot create fdevent for shell-exit handler\n");

678 
	`fdev’t_add
(
fde
, 
FDE_READ
);

679 
	}
}

681 
	$fdev’t_loİ
()

683 
fdev’t
 *
fde
;

684 
	`fdev’t_sub´oc_£tup
();

687 
	`D
("--- ---- waiting forƒvents\n");

689 
	`fdev’t_´oûss
();

691 (
fde
 = 
	`fdev’t_¶i¡_dequeue
())) {

692 
	`fdev’t_ÿÎ_fdfunc
(
fde
);

695 
	}
}

	@fdevent.h

17 #iâdeà
__FDEVENT_H


18 
	#__FDEVENT_H


	)

20 
	~<¡dšt.h
>

23 
	#FDE_READ
 0x0001

	)

24 
	#FDE_WRITE
 0x0002

	)

25 
	#FDE_ERROR
 0x0004

	)

26 
	#FDE_TIMEOUT
 0x0008

	)

29 
	#FDE_DONT_CLOSE
 0x0080

	)

31 
fdev’t
 
	tfdev’t
;

33 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

39 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

44 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

48 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

53 
	`fdev’t_»move
(
fdev’t
 *
™em
);

57 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

58 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

59 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

61 
	`fdev’t_£t_timeout
(
fdev’t
 *
fde
, 
št64_t
 
timeout_ms
);

65 
	`fdev’t_loİ
();

67 
	sfdev’t


69 
fdev’t
 *
Ãxt
;

70 
fdev’t
 *
´ev
;

72 
fd
;

73 
fÜû_eof
;

75 
¡©e
;

76 
ev’ts
;

78 
fd_func
 
func
;

79 *
¬g
;

	@file_sync_client.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/time.h
>

23 
	~<time.h
>

24 
	~<dœ’t.h
>

25 
	~<lim™s.h
>

26 
	~<sys/ty³s.h
>

27 
	~<zfe/zfe.h
>

29 
	~"sysd•s.h
"

30 
	~"adb.h
"

31 
	~"adb_ş›Á.h
"

32 
	~"fe_sync_£rviû.h
"

35 
	gtÙ®_by‹s
;

36 
	g¡¬t_time
;

38 
	$NOW
()

40 
timev®
 
tv
;

41 
	`g‘timeofday
(&
tv
, 0);

42  ((è
tv
.
tv_u£c
) +

43 1000000LL * ((è
tv
.
tv_£c
);

44 
	}
}

46 
	$BEGIN
()

48 
tÙ®_by‹s
 = 0;

49 
¡¬t_time
 = 
	`NOW
();

50 
	}
}

52 
	$END
()

54 
t
 = 
	`NOW
(è- 
¡¬t_time
;

55 if(
tÙ®_by‹s
 == 0) ;

57 ià(
t
 == 0)

58 
t
 = 1000000;

60 
	`årštf
(
¡d”r
,"%lld KB/s (%lld bytes in %lld.%03llds)\n",

61 ((((è
tÙ®_by‹s
è* 1000000LLè/ 
t
) / 1024LL,

62 (è
tÙ®_by‹s
, (
t
 / 1000000LL), (t % 1000000LL) / 1000LL);

63 
	}
}

65 
	$sync_qu™
(
fd
)

67 
syncmsg
 
msg
;

69 
msg
.
»q
.
id
 = 
ID_QUIT
;

70 
msg
.
»q
.
Çm–’
 = 0;

72 
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req));

73 
	}
}

75 (*
	tsync_ls_cb
)(
	tmode
, 
	tsize
, 
	ttime
, cÚ¡ *
	tÇme
, *
	tcook›
);

77 
	$sync_ls
(
fd
, cÚ¡ *
·th
, 
sync_ls_cb
 
func
, *
cook›
)

79 
syncmsg
 
msg
;

80 
buf
[257];

81 
Ën
;

83 
Ën
 = 
	`¡¾’
(
·th
);

84 if(
Ën
 > 1024è
ç
;

86 
msg
.
»q
.
id
 = 
ID_LIST
;

87 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

89 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

90 
	`wr™ex
(
fd
, 
·th
, 
Ën
)) {

91 
ç
;

95 if(
	`»adx
(
fd
, &
msg
.
d’t
, (msg.dent))) ;

96 if(
msg
.
d’t
.
id
 =ğ
ID_DONE
)  0;

97 if(
msg
.
d’t
.
id
 !ğ
ID_DENT
) ;

99 
Ën
 = 
	`Éohl
(
msg
.
d’t
.
Çm–’
);

100 if(
Ën
 > 256) ;

102 if(
	`»adx
(
fd
, 
buf
, 
Ën
)) ;

103 
buf
[
Ën
] = 0;

105 
	`func
(
	`Éohl
(
msg
.
d’t
.
mode
),

106 
	`Éohl
(
msg
.
d’t
.
size
),

107 
	`Éohl
(
msg
.
d’t
.
time
),

108 
buf
, 
cook›
);

111 
ç
:

112 
	`adb_şo£
(
fd
);

114 
	}
}

116 
sync£ndbuf
 
	tsync£ndbuf
;

118 
	ssync£ndbuf
 {

119 
	mid
;

120 
	msize
;

121 
	md©a
[
SYNC_DATA_MAX
];

124 
sync£ndbuf
 
	g£nd_bufãr
;

126 
	$sync_»adtime
(
fd
, cÚ¡ *
·th
, *
time¡amp
)

128 
syncmsg
 
msg
;

129 
Ën
 = 
	`¡¾’
(
·th
);

131 
msg
.
»q
.
id
 = 
ID_STAT
;

132 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

134 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

135 
	`wr™ex
(
fd
, 
·th
, 
Ën
)) {

139 if(
	`»adx
(
fd
, &
msg
.
¡©
, (msg.stat))) {

143 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
) {

147 *
time¡amp
 = 
	`Éohl
(
msg
.
¡©
.
time
);

149 
	}
}

151 
	$sync_¡¬t_»adtime
(
fd
, cÚ¡ *
·th
)

153 
syncmsg
 
msg
;

154 
Ën
 = 
	`¡¾’
(
·th
);

156 
msg
.
»q
.
id
 = 
ID_STAT
;

157 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

159 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

160 
	`wr™ex
(
fd
, 
·th
, 
Ën
)) {

165 
	}
}

167 
	$sync_fšish_»adtime
(
fd
, *
time¡amp
,

168 *
mode
, *
size
)

170 
syncmsg
 
msg
;

172 if(
	`»adx
(
fd
, &
msg
.
¡©
, (msg.stat)))

175 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
)

178 *
time¡amp
 = 
	`Éohl
(
msg
.
¡©
.
time
);

179 *
mode
 = 
	`Éohl
(
msg
.
¡©
.mode);

180 *
size
 = 
	`Éohl
(
msg
.
¡©
.size);

183 
	}
}

185 
	$sync_»admode
(
fd
, cÚ¡ *
·th
, *
mode
)

187 
syncmsg
 
msg
;

188 
Ën
 = 
	`¡¾’
(
·th
);

190 
msg
.
»q
.
id
 = 
ID_STAT
;

191 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

193 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

194 
	`wr™ex
(
fd
, 
·th
, 
Ën
)) {

198 if(
	`»adx
(
fd
, &
msg
.
¡©
, (msg.stat))) {

202 if(
msg
.
¡©
.
id
 !ğ
ID_STAT
) {

206 *
mode
 = 
	`Éohl
(
msg
.
¡©
.mode);

208 
	}
}

210 
	$wr™e_d©a_fe
(
fd
, cÚ¡ *
·th
, 
sync£ndbuf
 *
sbuf
)

212 
lfd
, 
”r
 = 0;

214 
lfd
 = 
	`adb_İ’
(
·th
, 
O_RDONLY
);

215 if(
lfd
 < 0) {

216 
	`årštf
(
¡d”r
,"ÿÂÙ o³À'%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

220 
sbuf
->
id
 = 
ID_DATA
;

222 
»t
;

224 
»t
 = 
	`adb_»ad
(
lfd
, 
sbuf
->
d©a
, 
SYNC_DATA_MAX
);

225 if(!
»t
)

228 if(
»t
 < 0) {

229 if(
”ºo
 =ğ
EINTR
)

231 
	`årštf
(
¡d”r
,"ÿÂÙ„—d '%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

235 
sbuf
->
size
 = 
	`htŞl
(
»t
);

236 if(
	`wr™ex
(
fd
, 
sbuf
, (è* 2 + 
»t
)){

237 
”r
 = -1;

240 
tÙ®_by‹s
 +ğ
»t
;

243 
	`adb_şo£
(
lfd
);

244  
”r
;

245 
	}
}

247 
	$wr™e_d©a_bufãr
(
fd
, * 
fe_bufãr
, 
size
, 
sync£ndbuf
 *
sbuf
)

249 
”r
 = 0;

250 
tÙ®
 = 0;

252 
sbuf
->
id
 = 
ID_DATA
;

253 
tÙ®
 < 
size
) {

254 
couÁ
 = 
size
 - 
tÙ®
;

255 ià(
couÁ
 > 
SYNC_DATA_MAX
) {

256 
couÁ
 = 
SYNC_DATA_MAX
;

259 
	`memıy
(
sbuf
->
d©a
, &
fe_bufãr
[
tÙ®
], 
couÁ
);

260 
sbuf
->
size
 = 
	`htŞl
(
couÁ
);

261 if(
	`wr™ex
(
fd
, 
sbuf
, (è* 2 + 
couÁ
)){

262 
”r
 = -1;

265 
tÙ®
 +ğ
couÁ
;

266 
tÙ®_by‹s
 +ğ
couÁ
;

269  
”r
;

270 
	}
}

272 #ifdeà
HAVE_SYMLINKS


273 
	$wr™e_d©a_lšk
(
fd
, cÚ¡ *
·th
, 
sync£ndbuf
 *
sbuf
)

275 
Ën
, 
»t
;

277 
Ën
 = 
	`»adlšk
(
·th
, 
sbuf
->
d©a
, 
SYNC_DATA_MAX
-1);

278 if(
Ën
 < 0) {

279 
	`årštf
(
¡d”r
, "”rÜ„—dšg†šk '%s': %s\n", 
·th
, 
	`¡»¼Ü
(
”ºo
));

282 
sbuf
->
d©a
[
Ën
] = '\0';

284 
sbuf
->
size
 = 
	`htŞl
(
Ën
 + 1);

285 
sbuf
->
id
 = 
ID_DATA
;

287 
»t
 = 
	`wr™ex
(
fd
, 
sbuf
, (è* 2 + 
Ën
 + 1);

288 if(
»t
)

291 
tÙ®_by‹s
 +ğ
Ën
 + 1;

294 
	}
}

297 
	$sync_£nd
(
fd
, cÚ¡ *
Í©h
, cÚ¡ *
½©h
,

298 
mtime
, 
mode_t
 
mode
, 
v”ifyApk
)

300 
syncmsg
 
msg
;

301 
Ën
, 
r
;

302 
sync£ndbuf
 *
sbuf
 = &
£nd_bufãr
;

303 * 
fe_bufãr
 = 
NULL
;

304 
size
 = 0;

305 
tmp
[64];

307 
Ën
 = 
	`¡¾’
(
½©h
);

308 if(
Ën
 > 1024è
ç
;

310 
	`¢´štf
(
tmp
, Ñmp), ",%d", 
mode
);

311 
r
 = 
	`¡¾’
(
tmp
);

313 ià(
v”ifyApk
) {

314 
lfd
;

315 
zfe_t
 
z
;

316 
z’Œy_t
 
’Œy
;

317 
amt
;

322 
lfd
 = 
	`adb_İ’
(
Í©h
, 
O_RDONLY
);

323 if(
lfd
 < 0) {

324 
	`årštf
(
¡d”r
,"ÿÂÙ o³À'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

328 
size
 = 
	`adb_l£ek
(
lfd
, 0, 
SEEK_END
);

329 ià(
size
 =ğ-1 || -1 =ğ
	`adb_l£ek
(
lfd
, 0, 
SEEK_SET
)) {

330 
	`årštf
(
¡d”r
, "”rÜ s“kšg iÀf'%s'\n", 
Í©h
);

331 
	`adb_şo£
(
lfd
);

335 
fe_bufãr
 = (*)
	`m®loc
(
size
);

336 ià(
fe_bufãr
 =ğ
NULL
) {

337 
	`årštf
(
¡d”r
, "could‚ot‡llocate buffer for '%s'\n",

338 
Í©h
);

339 
	`adb_şo£
(
lfd
);

342 
amt
 = 
	`adb_»ad
(
lfd
, 
fe_bufãr
, 
size
);

343 ià(
amt
 !ğ
size
) {

344 
	`årštf
(
¡d”r
, "”rÜ„—dšg from fe: '%s'\n", 
Í©h
);

345 
	`adb_şo£
(
lfd
);

346 
	`ä“
(
fe_bufãr
);

350 
	`adb_şo£
(
lfd
);

352 
z
 = 
	`š™_zfe
(
fe_bufãr
, 
size
);

353 ià(
z
 =ğ
NULL
) {

354 
	`årštf
(
¡d”r
, "file '%s' is‚ot‡ valid zip file\n",

355 
Í©h
);

356 
	`ä“
(
fe_bufãr
);

360 
’Œy
 = 
	`lookup_z’Œy
(
z
, "AndroidManifest.xml");

361 
	`»Ëa£_zfe
(
z
);

362 ià(
’Œy
 =ğ
NULL
) {

363 
	`årštf
(
¡d”r
, "file '%s' does‚ot contain AndroidManifest.xml\n",

364 
Í©h
);

365 
	`ä“
(
fe_bufãr
);

370 
msg
.
»q
.
id
 = 
ID_SEND
;

371 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
 + 
r
);

373 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

374 
	`wr™ex
(
fd
, 
½©h
, 
Ën
è|| wr™ex(fd, 
tmp
, 
r
)) {

375 
	`ä“
(
fe_bufãr
);

376 
ç
;

379 ià(
fe_bufãr
) {

380 
	`wr™e_d©a_bufãr
(
fd
, 
fe_bufãr
, 
size
, 
sbuf
);

381 
	`ä“
(
fe_bufãr
);

382 } ià(
	`S_ISREG
(
mode
))

383 
	`wr™e_d©a_fe
(
fd
, 
Í©h
, 
sbuf
);

384 #ifdeà
HAVE_SYMLINKS


385 ià(
	`S_ISLNK
(
mode
))

386 
	`wr™e_d©a_lšk
(
fd
, 
Í©h
, 
sbuf
);

389 
ç
;

391 
msg
.
d©a
.
id
 = 
ID_DONE
;

392 
msg
.
d©a
.
size
 = 
	`htŞl
(
mtime
);

393 if(
	`wr™ex
(
fd
, &
msg
.
d©a
, (msg.data)))

394 
ç
;

396 if(
	`»adx
(
fd
, &
msg
.
¡©us
, (msg.status)))

399 if(
msg
.
¡©us
.
id
 !ğ
ID_OKAY
) {

400 if(
msg
.
¡©us
.
id
 =ğ
ID_FAIL
) {

401 
Ën
 = 
	`Éohl
(
msg
.
¡©us
.
msgËn
);

402 if(
Ën
 > 256)†en = 256;

403 if(
	`»adx
(
fd
, 
sbuf
->
d©a
, 
Ën
)) {

406 
sbuf
->
d©a
[
Ën
] = 0;

408 
	`¡rıy
(
sbuf
->
d©a
, "unknown„eason");

410 
	`årštf
(
¡d”r
,"çedØcİy '%s'Ø'%s': %s\n", 
Í©h
, 
½©h
, 
sbuf
->
d©a
);

416 
ç
:

417 
	`årštf
(
¡d”r
,"protocol failure\n");

418 
	`adb_şo£
(
fd
);

420 
	}
}

422 
	$mkdœs
(*
Çme
)

424 
»t
;

425 *
x
 = 
Çme
 + 1;

428 
x
 = 
	`adb_dœ¡¬t
(x);

429 if(
x
 == 0)  0;

430 *
x
 = 0;

431 
»t
 = 
	`adb_mkdœ
(
Çme
, 0775);

432 *
x
 = 
OS_PATH_SEPARATOR
;

433 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

434  
»t
;

436 
x
++;

439 
	}
}

441 
	$sync_»cv
(
fd
, cÚ¡ *
½©h
, cÚ¡ *
Í©h
)

443 
syncmsg
 
msg
;

444 
Ën
;

445 
lfd
 = -1;

446 *
bufãr
 = 
£nd_bufãr
.
d©a
;

447 
id
;

449 
Ën
 = 
	`¡¾’
(
½©h
);

450 if(
Ën
 > 1024)  -1;

452 
msg
.
»q
.
id
 = 
ID_RECV
;

453 
msg
.
»q
.
Çm–’
 = 
	`htŞl
(
Ën
);

454 if(
	`wr™ex
(
fd
, &
msg
.
»q
, (msg.req)) ||

455 
	`wr™ex
(
fd
, 
½©h
, 
Ën
)) {

459 if(
	`»adx
(
fd
, &
msg
.
d©a
, (msg.data))) {

462 
id
 = 
msg
.
d©a
.id;

464 if((
id
 =ğ
ID_DATA
è|| (id =ğ
ID_DONE
)) {

465 
	`adb_uÆšk
(
Í©h
);

466 
	`mkdœs
((*)
Í©h
);

467 
lfd
 = 
	`adb_ü—t
(
Í©h
, 0644);

468 if(
lfd
 < 0) {

469 
	`årštf
(
¡d”r
,"ÿÂÙ c»©'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

472 
hªdË_d©a
;

474 
»mÙe_”rÜ
;

478 if(
	`»adx
(
fd
, &
msg
.
d©a
, (msg.data))) {

481 
id
 = 
msg
.
d©a
.id;

483 
hªdË_d©a
:

484 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

485 if(
id
 =ğ
ID_DONE
) ;

486 if(
id
 !ğ
ID_DATA
è
»mÙe_”rÜ
;

487 if(
Ën
 > 
SYNC_DATA_MAX
) {

488 
	`årštf
(
¡d”r
,"data overrun\n");

489 
	`adb_şo£
(
lfd
);

493 if(
	`»adx
(
fd
, 
bufãr
, 
Ën
)) {

494 
	`adb_şo£
(
lfd
);

498 if(
	`wr™ex
(
lfd
, 
bufãr
, 
Ën
)) {

499 
	`årštf
(
¡d”r
,"ÿÂÙ wr™'%s': %s\n", 
½©h
, 
	`¡»¼Ü
(
”ºo
));

500 
	`adb_şo£
(
lfd
);

504 
tÙ®_by‹s
 +ğ
Ën
;

507 
	`adb_şo£
(
lfd
);

510 
»mÙe_”rÜ
:

511 
	`adb_şo£
(
lfd
);

512 
	`adb_uÆšk
(
Í©h
);

514 if(
id
 =ğ
ID_FAIL
) {

515 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

516 if(
Ën
 > 256)†en = 256;

517 if(
	`»adx
(
fd
, 
bufãr
, 
Ën
)) {

520 
bufãr
[
Ën
] = 0;

522 
	`memıy
(
bufãr
, &
id
, 4);

523 
bufãr
[4] = 0;

526 
	`årštf
(
¡d”r
,"çedØcİy '%s'Ø'%s': %s\n", 
½©h
, 
Í©h
, 
bufãr
);

528 
	}
}

535 
	$do_sync_ls_cb
(
mode
, 
size
, 
time
,

536 cÚ¡ *
Çme
, *
cook›
)

538 
	`´štf
("%08x %08x %08x %s\n", 
mode
, 
size
, 
time
, 
Çme
);

539 
	}
}

541 
	$do_sync_ls
(cÚ¡ *
·th
)

543 
fd
 = 
	`adb_cÚÃù
("sync:");

544 if(
fd
 < 0) {

545 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

549 if(
	`sync_ls
(
fd
, 
·th
, 
do_sync_ls_cb
, 0)) {

552 
	`sync_qu™
(
fd
);

555 
	}
}

557 
cİyšfo
 
	tcİyšfo
;

559 
	scİyšfo


561 
cİyšfo
 *
	mÃxt
;

562 cÚ¡ *
	m¤c
;

563 cÚ¡ *
	md¡
;

564 
	mtime
;

565 
	mmode
;

566 
	msize
;

567 
	mæag
;

571 
cİyšfo
 *
	$mkcİyšfo
(cÚ¡ *
¥©h
, cÚ¡ *
d·th
,

572 cÚ¡ *
Çme
, 
isdœ
)

574 
¦’
 = 
	`¡¾’
(
¥©h
);

575 
dËn
 = 
	`¡¾’
(
d·th
);

576 
Æ’
 = 
	`¡¾’
(
Çme
);

577 
ssize
 = 
¦’
 + 
Æ’
 + 2;

578 
dsize
 = 
dËn
 + 
Æ’
 + 2;

580 
cİyšfo
 *
ci
 = 
	`m®loc
((cİyšfoè+ 
ssize
 + 
dsize
);

581 if(
ci
 == 0) {

582 
	`årštf
(
¡d”r
,"out of memory\n");

583 
	`abÜt
();

586 
ci
->
Ãxt
 = 0;

587 
ci
->
time
 = 0;

588 
ci
->
mode
 = 0;

589 
ci
->
size
 = 0;

590 
ci
->
æag
 = 0;

591 
ci
->
¤c
 = (const *)(ci + 1);

592 
ci
->
d¡
 = ci->
¤c
 + 
ssize
;

593 
	`¢´štf
((*è
ci
->
¤c
, 
ssize
, 
isdœ
 ? "%s%s/" : "%s%s", 
¥©h
, 
Çme
);

594 
	`¢´štf
((*è
ci
->
d¡
, 
dsize
, 
isdœ
 ? "%s%s/" : "%s%s", 
d·th
, 
Çme
);

597  
ci
;

598 
	}
}

601 
	$loÿl_bud_li¡
(
cİyšfo
 **
f–i¡
,

602 cÚ¡ *
Í©h
, cÚ¡ *
½©h
)

604 
DIR
 *
d
;

605 
dœ’t
 *
de
;

606 
¡©
 
¡
;

607 
cİyšfo
 *
dœli¡
 = 0;

608 
cİyšfo
 *
ci
, *
Ãxt
;

612 
d
 = 
	`İ’dœ
(
Í©h
);

613 if(
d
 == 0) {

614 
	`årštf
(
¡d”r
,"ÿÂÙ o³À'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

618 (
de
 = 
	`»addœ
(
d
))) {

619 
¡©_·th
[
PATH_MAX
];

620 *
Çme
 = 
de
->
d_Çme
;

622 if(
Çme
[0] == '.') {

623 if(
Çme
[1] == 0) ;

624 if((
Çme
[1] == '.') && (name[2] == 0)) ;

631 ià(
	`¡¾’
(
Í©h
è+ sŒËn(
de
->
d_Çme
è+ 1 > (
¡©_·th
))

633 
	`¡rıy
(
¡©_·th
, 
Í©h
);

634 
	`¡rÿt
(
¡©_·th
, 
de
->
d_Çme
);

635 
	`¡©
(
¡©_·th
, &
¡
);

637 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

638 
ci
 = 
	`mkcİyšfo
(
Í©h
, 
½©h
, 
Çme
, 1);

639 
ci
->
Ãxt
 = 
dœli¡
;

640 
dœli¡
 = 
ci
;

642 
ci
 = 
	`mkcİyšfo
(
Í©h
, 
½©h
, 
Çme
, 0);

643 if(
	`l¡©
(
ci
->
¤c
, &
¡
)) {

644 
	`årštf
(
¡d”r
,"ÿÂÙ sˆ'%s': %s\n", 
ci
->
¤c
, 
	`¡»¼Ü
(
”ºo
));

645 
	`şo£dœ
(
d
);

649 if(!
	`S_ISREG
(
¡
.
¡_mode
è&& !
	`S_ISLNK
(st.st_mode)) {

650 
	`årštf
(
¡d”r
, "skpšg s³cŸÈf'%s'\n", 
ci
->
¤c
);

651 
	`ä“
(
ci
);

653 
ci
->
time
 = 
¡
.
¡_mtime
;

654 
ci
->
mode
 = 
¡
.
¡_mode
;

655 
ci
->
size
 = 
¡
.
¡_size
;

656 
ci
->
Ãxt
 = *
f–i¡
;

657 *
f–i¡
 = 
ci
;

662 
	`şo£dœ
(
d
);

664 
ci
 = 
dœli¡
; c˜!ğ0; c˜ğ
Ãxt
) {

665 
Ãxt
 = 
ci
->next;

666 
	`loÿl_bud_li¡
(
f–i¡
, 
ci
->
¤c
, ci->
d¡
);

667 
	`ä“
(
ci
);

671 
	}
}

674 
	$cİy_loÿl_dœ_»mÙe
(
fd
, cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
checktime¡amps
, 
li¡Úly
)

676 
cİyšfo
 *
f–i¡
 = 0;

677 
cİyšfo
 *
ci
, *
Ãxt
;

678 
pushed
 = 0;

679 
sk³d
 = 0;

681 if((
Í©h
[0] =ğ0è|| (
½©h
[0] == 0))  -1;

682 if(
Í©h
[
	`¡¾’
(lpath) - 1] != '/') {

683 
tm¶’
 = 
	`¡¾’
(
Í©h
)+2;

684 *
tmp
 = 
	`m®loc
(
tm¶’
);

685 if(
tmp
 == 0)  -1;

686 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/",
Í©h
);

687 
Í©h
 = 
tmp
;

689 if(
½©h
[
	`¡¾’
(rpath) - 1] != '/') {

690 
tm¶’
 = 
	`¡¾’
(
½©h
)+2;

691 *
tmp
 = 
	`m®loc
(
tm¶’
);

692 if(
tmp
 == 0)  -1;

693 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/",
½©h
);

694 
½©h
 = 
tmp
;

697 if(
	`loÿl_bud_li¡
(&
f–i¡
, 
Í©h
, 
½©h
)) {

701 if(
checktime¡amps
){

702 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

703 if(
	`sync_¡¬t_»adtime
(
fd
, 
ci
->
d¡
)) {

707 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

708 
time¡amp
, 
mode
, 
size
;

709 if(
	`sync_fšish_»adtime
(
fd
, &
time¡amp
, &
mode
, &
size
))

711 if(
size
 =ğ
ci
->size) {

713 if((
	`S_ISREG
(
ci
->
mode
 & modeè&& 
time¡amp
 =ğci->
time
) ||

714 (
	`S_ISLNK
(
ci
->
mode
 & modeè&& 
time¡amp
 >ğci->
time
))

715 
ci
->
æag
 = 1;

719 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğ
Ãxt
) {

720 
Ãxt
 = 
ci
->next;

721 if(
ci
->
æag
 == 0) {

722 
	`årštf
(
¡d”r
,"%¥ush: % -> %s\n", 
li¡Úly
 ? "would " : "", 
ci
->
¤c
, ci->
d¡
);

723 if(!
li¡Úly
 &&

724 
	`sync_£nd
(
fd
, 
ci
->
¤c
, ci->
d¡
, ci->
time
, ci->
mode
, 0 )){

727 
pushed
++;

729 
sk³d
++;

731 
	`ä“
(
ci
);

734 
	`årštf
(
¡d”r
,"%d file%s…ushed. %d file%s skipped.\n",

735 
pushed
, (pushed == 1) ? "" : "s",

736 
sk³d
, (skipped == 1) ? "" : "s");

739 
	}
}

742 
	$do_sync_push
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
v”ifyApk
)

744 
¡©
 
¡
;

745 
mode
;

746 
fd
;

748 
fd
 = 
	`adb_cÚÃù
("sync:");

749 if(
fd
 < 0) {

750 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

754 if(
	`¡©
(
Í©h
, &
¡
)) {

755 
	`årštf
(
¡d”r
,"ÿÂÙ sˆ'%s': %s\n", 
Í©h
, 
	`¡»¼Ü
(
”ºo
));

756 
	`sync_qu™
(
fd
);

760 if(
	`S_ISDIR
(
¡
.
¡_mode
)) {

761 
	`BEGIN
();

762 if(
	`cİy_loÿl_dœ_»mÙe
(
fd
, 
Í©h
, 
½©h
, 0, 0)) {

765 
	`END
();

766 
	`sync_qu™
(
fd
);

769 if(
	`sync_»admode
(
fd
, 
½©h
, &
mode
)) {

772 if((
mode
 !ğ0è&& 
	`S_ISDIR
(mode)) {

776 cÚ¡ *
Çme
 = 
	`adb_dœ¡İ
(
Í©h
);

777 if(
Çme
 == 0) {

778 
Çme
 = 
Í©h
;

780 
Çme
++;

782 
tm¶’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
½©h
) + 2;

783 *
tmp
 = 
	`m®loc
(
	`¡¾’
(
Çme
è+ sŒËn(
½©h
) + 2);

784 if(
tmp
 == 0)  1;

785 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/%s", 
½©h
, 
Çme
);

786 
½©h
 = 
tmp
;

788 
	`BEGIN
();

789 if(
	`sync_£nd
(
fd
, 
Í©h
, 
½©h
, 
¡
.
¡_mtime
, st.
¡_mode
, 
v”ifyApk
)) {

792 
	`END
();

793 
	`sync_qu™
(
fd
);

799 
	}
}

803 
cİyšfo
 **
	mf–i¡
;

804 
cİyšfo
 **
	mdœli¡
;

805 cÚ¡ *
	m½©h
;

806 cÚ¡ *
	mÍ©h
;

807 } 
	tsync_ls_bud_li¡_cb_¬gs
;

810 
	$sync_ls_bud_li¡_cb
(
mode
, 
size
, 
time
,

811 cÚ¡ *
Çme
, *
cook›
)

813 
sync_ls_bud_li¡_cb_¬gs
 *
¬gs
 = (sync_ls_bud_li¡_cb_¬g *)
cook›
;

814 
cİyšfo
 *
ci
;

816 ià(
	`S_ISDIR
(
mode
)) {

817 
cİyšfo
 **
dœli¡
 = 
¬gs
->dirlist;

820 ià(
Çme
[0] == '.') {

821 ià(
Çme
[1] == '\0') ;

822 ià((
Çme
[1] == '.') && (name[2] == '\0')) ;

825 
ci
 = 
	`mkcİyšfo
(
¬gs
->
½©h
,‡rgs->
Í©h
, 
Çme
, 1);

826 
ci
->
Ãxt
 = *
dœli¡
;

827 *
dœli¡
 = 
ci
;

828 } ià(
	`S_ISREG
(
mode
è|| 
	`S_ISLNK
(mode)) {

829 
cİyšfo
 **
f–i¡
 = 
¬gs
->filelist;

831 
ci
 = 
	`mkcİyšfo
(
¬gs
->
½©h
,‡rgs->
Í©h
, 
Çme
, 0);

832 
ci
->
time
 =ime;

833 
ci
->
mode
 = mode;

834 
ci
->
size
 = size;

835 
ci
->
Ãxt
 = *
f–i¡
;

836 *
f–i¡
 = 
ci
;

838 
	`årštf
(
¡d”r
, "skpšg s³cŸÈf'%s'\n", 
Çme
);

840 
	}
}

842 
	$»mÙe_bud_li¡
(
syncfd
, 
cİyšfo
 **
f–i¡
,

843 cÚ¡ *
½©h
, cÚ¡ *
Í©h
)

845 
cİyšfo
 *
dœli¡
 = 
NULL
;

846 
sync_ls_bud_li¡_cb_¬gs
 
¬gs
;

848 
¬gs
.
f–i¡
 = filelist;

849 
¬gs
.
dœli¡
 = &dirlist;

850 
¬gs
.
½©h
 =„path;

851 
¬gs
.
Í©h
 =†path;

854 ià(
	`sync_ls
(
syncfd
, 
½©h
, 
sync_ls_bud_li¡_cb
, (*)&
¬gs
)) {

859 
dœli¡
 !ğ
NULL
) {

860 
cİyšfo
 *
Ãxt
 = 
dœli¡
->next;

861 ià(
	`»mÙe_bud_li¡
(
syncfd
, 
f–i¡
, 
dœli¡
->
¤c
, dœli¡->
d¡
)) {

864 
	`ä“
(
dœli¡
);

865 
dœli¡
 = 
Ãxt
;

869 
	}
}

871 
	$cİy_»mÙe_dœ_loÿl
(
fd
, cÚ¡ *
½©h
, cÚ¡ *
Í©h
,

872 
checktime¡amps
)

874 
cİyšfo
 *
f–i¡
 = 0;

875 
cİyšfo
 *
ci
, *
Ãxt
;

876 
puÎed
 = 0;

877 
sk³d
 = 0;

880 ià(
½©h
[0] =ğ0 || 
Í©h
[0] == 0)  -1;

881 ià(
½©h
[
	`¡¾’
(rpath) - 1] != '/') {

882 
tm¶’
 = 
	`¡¾’
(
½©h
) + 2;

883 *
tmp
 = 
	`m®loc
(
tm¶’
);

884 ià(
tmp
 == 0)  -1;

885 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/", 
½©h
);

886 
½©h
 = 
tmp
;

888 ià(
Í©h
[
	`¡¾’
(lpath) - 1] != '/') {

889 
tm¶’
 = 
	`¡¾’
(
Í©h
) + 2;

890 *
tmp
 = 
	`m®loc
(
tm¶’
);

891 ià(
tmp
 == 0)  -1;

892 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/", 
Í©h
);

893 
Í©h
 = 
tmp
;

896 
	`årštf
(
¡d”r
, "pull: building file†ist...\n");

898 ià(
	`»mÙe_bud_li¡
(
fd
, &
f–i¡
, 
½©h
, 
Í©h
)) {

903 ià(
checktime¡amps
) {

904 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

905 ià(
	`sync_¡¬t_»adtime
(
fd
, 
ci
->
d¡
)) {

909 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğci->
Ãxt
) {

910 
time¡amp
, 
mode
, 
size
;

911 ià(
	`sync_fšish_»adtime
(
fd
, &
time¡amp
, &
mode
, &
size
))

913 ià(
size
 =ğ
ci
->size) {

915 ià((
	`S_ISREG
(
ci
->
mode
 & modeè&& 
time¡amp
 =ğci->
time
) ||

916 (
	`S_ISLNK
(
ci
->
mode
 & modeè&& 
time¡amp
 >ğci->
time
))

917 
ci
->
æag
 = 1;

922 
ci
 = 
f–i¡
; c˜!ğ0; c˜ğ
Ãxt
) {

923 
Ãxt
 = 
ci
->next;

924 ià(
ci
->
æag
 == 0) {

925 
	`årštf
(
¡d”r
, "puÎ: % -> %s\n", 
ci
->
¤c
, ci->
d¡
);

926 ià(
	`sync_»cv
(
fd
, 
ci
->
¤c
, ci->
d¡
)) {

929 
puÎed
++;

931 
sk³d
++;

933 
	`ä“
(
ci
);

936 
	`årštf
(
¡d”r
, "%d file%s…ulled. %d file%s skipped.\n",

937 
puÎed
, (pulled == 1) ? "" : "s",

938 
sk³d
, (skipped == 1) ? "" : "s");

941 
	}
}

943 
	$do_sync_puÎ
(cÚ¡ *
½©h
, cÚ¡ *
Í©h
)

945 
mode
;

946 
¡©
 
¡
;

948 
fd
;

950 
fd
 = 
	`adb_cÚÃù
("sync:");

951 if(
fd
 < 0) {

952 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

956 if(
	`sync_»admode
(
fd
, 
½©h
, &
mode
)) {

959 if(
mode
 == 0) {

960 
	`årštf
(
¡d”r
,"»mÙobjeù '%s' dÛ nÙƒxi¡\n", 
½©h
);

964 if(
	`S_ISREG
(
mode
è|| 
	`S_ISLNK
(modeè|| 
	`S_ISCHR
(modeè|| 
	`S_ISBLK
(mode)) {

965 if(
	`¡©
(
Í©h
, &
¡
) == 0) {

966 if(
	`S_ISDIR
(
¡
.
¡_mode
)) {

970 cÚ¡ *
Çme
 = 
	`adb_dœ¡İ
(
½©h
);

971 if(
Çme
 == 0) {

972 
Çme
 = 
½©h
;

974 
Çme
++;

976 
tm¶’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
Í©h
) + 2;

977 *
tmp
 = 
	`m®loc
(
tm¶’
);

978 if(
tmp
 == 0)  1;

979 
	`¢´štf
(
tmp
, 
tm¶’
, "%s/%s", 
Í©h
, 
Çme
);

980 
Í©h
 = 
tmp
;

983 
	`BEGIN
();

984 if(
	`sync_»cv
(
fd
, 
½©h
, 
Í©h
)) {

987 
	`END
();

988 
	`sync_qu™
(
fd
);

991 } if(
	`S_ISDIR
(
mode
)) {

992 
	`BEGIN
();

993 ià(
	`cİy_»mÙe_dœ_loÿl
(
fd
, 
½©h
, 
Í©h
, 0)) {

996 
	`END
();

997 
	`sync_qu™
(
fd
);

1001 
	`årštf
(
¡d”r
,"»mÙobjeù '%s'‚Ù‡ fÜ dœeùÜy\n", 
½©h
);

1004 
	}
}

1006 
	$do_sync_sync
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
li¡Úly
)

1008 
	`årštf
(
¡d”r
,"syncšg %s...\n",
½©h
);

1010 
fd
 = 
	`adb_cÚÃù
("sync:");

1011 if(
fd
 < 0) {

1012 
	`årštf
(
¡d”r
,"”rÜ: %s\n", 
	`adb_”rÜ
());

1016 
	`BEGIN
();

1017 if(
	`cİy_loÿl_dœ_»mÙe
(
fd
, 
Í©h
, 
½©h
, 1, 
li¡Úly
)){

1020 
	`END
();

1021 
	`sync_qu™
(
fd
);

1024 
	}
}

	@file_sync_service.c

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<¡ršg.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/ty³s.h
>

23 
	~<dœ’t.h
>

24 
	~<utime.h
>

26 
	~<”ºo.h
>

28 
	~"sysd•s.h
"

30 
	#TRACE_TAG
 
TRACE_SYNC


	)

31 
	~"adb.h
"

32 
	~"fe_sync_£rviû.h
"

34 
	$mkdœs
(*
Çme
)

36 
»t
;

37 *
x
 = 
Çme
 + 1;

39 if(
Çme
[0] != '/')  -1;

42 
x
 = 
	`adb_dœ¡¬t
(x);

43 if(
x
 == 0)  0;

44 *
x
 = 0;

45 
»t
 = 
	`adb_mkdœ
(
Çme
, 0775);

46 if((
»t
 < 0è&& (
”ºo
 !ğ
EEXIST
)) {

47 
	`D
("mkdœ(\"%s\"è-> %s\n", 
Çme
, 
	`¡»¼Ü
(
”ºo
));

48 *
x
 = '/';

49  
»t
;

51 *
x
++ = '/';

54 
	}
}

56 
	$do_¡©
(
s
, cÚ¡ *
·th
)

58 
syncmsg
 
msg
;

59 
¡©
 
¡
;

61 
msg
.
¡©
.
id
 = 
ID_STAT
;

63 if(
	`l¡©
(
·th
, &
¡
)) {

64 
msg
.
¡©
.
mode
 = 0;

65 
msg
.
¡©
.
size
 = 0;

66 
msg
.
¡©
.
time
 = 0;

68 
msg
.
¡©
.
mode
 = 
	`htŞl
(
¡
.
¡_mode
);

69 
msg
.
¡©
.
size
 = 
	`htŞl
(
¡
.
¡_size
);

70 
msg
.
¡©
.
time
 = 
	`htŞl
(
¡
.
¡_mtime
);

73  
	`wr™ex
(
s
, &
msg
.
¡©
, (msg.stat));

74 
	}
}

76 
	$do_li¡
(
s
, cÚ¡ *
·th
)

78 
DIR
 *
d
;

79 
dœ’t
 *
de
;

80 
¡©
 
¡
;

81 
syncmsg
 
msg
;

82 
Ën
;

84 
tmp
[1024 + 256 + 1];

85 *
âame
;

87 
Ën
 = 
	`¡¾’
(
·th
);

88 
	`memıy
(
tmp
, 
·th
, 
Ën
);

89 
tmp
[
Ën
] = '/';

90 
âame
 = 
tmp
 + 
Ën
 + 1;

92 
msg
.
d’t
.
id
 = 
ID_DENT
;

94 
d
 = 
	`İ’dœ
(
·th
);

95 if(
d
 =ğ0è
dÚe
;

97 (
de
 = 
	`»addœ
(
d
))) {

98 
Ën
 = 
	`¡¾’
(
de
->
d_Çme
);

102 if(
Ën
 > 256) ;

104 
	`¡rıy
(
âame
, 
de
->
d_Çme
);

105 if(
	`l¡©
(
tmp
, &
¡
) == 0) {

106 
msg
.
d’t
.
mode
 = 
	`htŞl
(
¡
.
¡_mode
);

107 
msg
.
d’t
.
size
 = 
	`htŞl
(
¡
.
¡_size
);

108 
msg
.
d’t
.
time
 = 
	`htŞl
(
¡
.
¡_mtime
);

109 
msg
.
d’t
.
Çm–’
 = 
	`htŞl
(
Ën
);

111 if(
	`wr™ex
(
s
, &
msg
.
d’t
, (msg.dent)) ||

112 
	`wr™ex
(
s
, 
de
->
d_Çme
, 
Ën
)) {

118 
	`şo£dœ
(
d
);

120 
dÚe
:

121 
msg
.
d’t
.
id
 = 
ID_DONE
;

122 
msg
.
d’t
.
mode
 = 0;

123 
msg
.
d’t
.
size
 = 0;

124 
msg
.
d’t
.
time
 = 0;

125 
msg
.
d’t
.
Çm–’
 = 0;

126  
	`wr™ex
(
s
, &
msg
.
d’t
, (msg.dent));

127 
	}
}

129 
	$ç_mes§ge
(
s
, cÚ¡ *
»asÚ
)

131 
syncmsg
 
msg
;

132 
Ën
 = 
	`¡¾’
(
»asÚ
);

134 
	`D
("sync: fau»: %s\n", 
»asÚ
);

136 
msg
.
d©a
.
id
 = 
ID_FAIL
;

137 
msg
.
d©a
.
size
 = 
	`htŞl
(
Ën
);

138 if(
	`wr™ex
(
s
, &
msg
.
d©a
, (msg.data)) ||

139 
	`wr™ex
(
s
, 
»asÚ
, 
Ën
)) {

144 
	}
}

146 
	$ç_”ºo
(
s
)

148  
	`ç_mes§ge
(
s
, 
	`¡»¼Ü
(
”ºo
));

149 
	}
}

151 
	$hªdË_£nd_fe
(
s
, *
·th
, 
mode_t
 
mode
, *
bufãr
)

153 
syncmsg
 
msg
;

154 
time¡amp
 = 0;

155 
fd
;

157 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
, 
mode
);

158 if(
fd
 < 0 && 
”ºo
 =ğ
ENOENT
) {

159 
	`mkdœs
(
·th
);

160 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
, 
mode
);

162 if(
fd
 < 0 && 
”ºo
 =ğ
EEXIST
) {

163 
fd
 = 
	`adb_İ’_mode
(
·th
, 
O_WRONLY
, 
mode
);

165 if(
fd
 < 0) {

166 if(
	`ç_”ºo
(
s
))

168 
fd
 = -1;

172 
Ën
;

174 if(
	`»adx
(
s
, &
msg
.
d©a
, (msg.data)))

175 
ç
;

177 if(
msg
.
d©a
.
id
 !ğ
ID_DATA
) {

178 if(
msg
.
d©a
.
id
 =ğ
ID_DONE
) {

179 
time¡amp
 = 
	`Éohl
(
msg
.
d©a
.
size
);

182 
	`ç_mes§ge
(
s
, "invalid data message");

183 
ç
;

185 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

186 if(
Ën
 > 
SYNC_DATA_MAX
) {

187 
	`ç_mes§ge
(
s
, "oversize data message");

188 
ç
;

190 if(
	`»adx
(
s
, 
bufãr
, 
Ën
))

191 
ç
;

193 if(
fd
 < 0)

195 if(
	`wr™ex
(
fd
, 
bufãr
, 
Ën
)) {

196 
§ved_”ºo
 = 
”ºo
;

197 
	`adb_şo£
(
fd
);

198 
	`adb_uÆšk
(
·th
);

199 
fd
 = -1;

200 
”ºo
 = 
§ved_”ºo
;

201 if(
	`ç_”ºo
(
s
))  -1;

205 if(
fd
 >= 0) {

206 
utimbuf
 
u
;

207 
	`adb_şo£
(
fd
);

208 
u
.
aùime
 = 
time¡amp
;

209 
u
.
modtime
 = 
time¡amp
;

210 
	`utime
(
·th
, &
u
);

212 
msg
.
¡©us
.
id
 = 
ID_OKAY
;

213 
msg
.
¡©us
.
msgËn
 = 0;

214 if(
	`wr™ex
(
s
, &
msg
.
¡©us
, (msg.status)))

219 
ç
:

220 if(
fd
 >= 0)

221 
	`adb_şo£
(
fd
);

222 
	`adb_uÆšk
(
·th
);

224 
	}
}

226 #ifdeà
HAVE_SYMLINKS


227 
	$hªdË_£nd_lšk
(
s
, *
·th
, *
bufãr
)

229 
syncmsg
 
msg
;

230 
Ën
;

231 
»t
;

233 if(
	`»adx
(
s
, &
msg
.
d©a
, (msg.data)))

236 if(
msg
.
d©a
.
id
 !ğ
ID_DATA
) {

237 
	`ç_mes§ge
(
s
, "invalid data message:ƒxpected ID_DATA");

241 
Ën
 = 
	`Éohl
(
msg
.
d©a
.
size
);

242 if(
Ën
 > 
SYNC_DATA_MAX
) {

243 
	`ç_mes§ge
(
s
, "oversize data message");

246 if(
	`»adx
(
s
, 
bufãr
, 
Ën
))

249 
»t
 = 
	`symlšk
(
bufãr
, 
·th
);

250 if(
»t
 && 
”ºo
 =ğ
ENOENT
) {

251 
	`mkdœs
(
·th
);

252 
»t
 = 
	`symlšk
(
bufãr
, 
·th
);

254 if(
»t
) {

255 
	`ç_”ºo
(
s
);

259 if(
	`»adx
(
s
, &
msg
.
d©a
, (msg.data)))

262 if(
msg
.
d©a
.
id
 =ğ
ID_DONE
) {

263 
msg
.
¡©us
.
id
 = 
ID_OKAY
;

264 
msg
.
¡©us
.
msgËn
 = 0;

265 if(
	`wr™ex
(
s
, &
msg
.
¡©us
, (msg.status)))

268 
	`ç_mes§ge
(
s
, "invalid data message:ƒxpected ID_DONE");

273 
	}
}

276 
	$do_£nd
(
s
, *
·th
, *
bufãr
)

278 *
tmp
;

279 
mode_t
 
mode
;

280 
is_lšk
, 
»t
;

282 
tmp
 = 
	`¡¼chr
(
·th
,',');

283 if(
tmp
) {

284 *
tmp
 = 0;

285 
”ºo
 = 0;

286 
mode
 = 
	`¡¹oul
(
tmp
 + 1, 
NULL
, 0);

287 #iâdeà
HAVE_SYMLINKS


288 
is_lšk
 = 0;

290 
is_lšk
 = 
	`S_ISLNK
(
mode
);

292 
mode
 &= 0777;

294 if(!
tmp
 || 
”ºo
) {

295 
mode
 = 0644;

296 
is_lšk
 = 0;

299 
	`adb_uÆšk
(
·th
);

302 #ifdeà
HAVE_SYMLINKS


303 if(
is_lšk
)

304 
»t
 = 
	`hªdË_£nd_lšk
(
s
, 
·th
, 
bufãr
);

310 
mode
 |= ((mode >> 3) & 0070);

311 
mode
 |= ((mode >> 3) & 0007);

313 
»t
 = 
	`hªdË_£nd_fe
(
s
, 
·th
, 
mode
, 
bufãr
);

316  
»t
;

317 
	}
}

319 
	$do_»cv
(
s
, cÚ¡ *
·th
, *
bufãr
)

321 
syncmsg
 
msg
;

322 
fd
, 
r
;

324 
fd
 = 
	`adb_İ’
(
·th
, 
O_RDONLY
);

325 if(
fd
 < 0) {

326 if(
	`ç_”ºo
(
s
))  -1;

330 
msg
.
d©a
.
id
 = 
ID_DATA
;

332 
r
 = 
	`adb_»ad
(
fd
, 
bufãr
, 
SYNC_DATA_MAX
);

333 if(
r
 <= 0) {

334 if(
r
 == 0) ;

335 if(
”ºo
 =ğ
EINTR
) ;

336 
r
 = 
	`ç_”ºo
(
s
);

337 
	`adb_şo£
(
fd
);

338  
r
;

340 
msg
.
d©a
.
size
 = 
	`htŞl
(
r
);

341 if(
	`wr™ex
(
s
, &
msg
.
d©a
, (msg.data)) ||

342 
	`wr™ex
(
s
, 
bufãr
, 
r
)) {

343 
	`adb_şo£
(
fd
);

348 
	`adb_şo£
(
fd
);

350 
msg
.
d©a
.
id
 = 
ID_DONE
;

351 
msg
.
d©a
.
size
 = 0;

352 if(
	`wr™ex
(
s
, &
msg
.
d©a
, (msg.data))) {

357 
	}
}

359 
	$fe_sync_£rviû
(
fd
, *
cook›
)

361 
syncmsg
 
msg
;

362 
Çme
[1025];

363 
Çm–’
;

365 *
bufãr
 = 
	`m®loc
(
SYNC_DATA_MAX
);

366 if(
bufãr
 =ğ0è
ç
;

369 
	`D
("sync: waiting for command\n");

371 if(
	`»adx
(
fd
, &
msg
.
»q
, (msg.req))) {

372 
	`ç_mes§ge
(
fd
, "command„ead failure");

375 
Çm–’
 = 
	`Éohl
(
msg
.
»q
.namelen);

376 if(
Çm–’
 > 1024) {

377 
	`ç_mes§ge
(
fd
, "invalid‚amelen");

380 if(
	`»adx
(
fd
, 
Çme
, 
Çm–’
)) {

381 
	`ç_mes§ge
(
fd
, "filename„ead failure");

384 
Çme
[
Çm–’
] = 0;

386 
msg
.
»q
.
Çm–’
 = 0;

387 
	`D
("sync: '%s' '%s'\n", (*è&
msg
.
»q
, 
Çme
);

389 
msg
.
»q
.
id
) {

390 
ID_STAT
:

391 if(
	`do_¡©
(
fd
, 
Çme
)è
ç
;

393 
ID_LIST
:

394 if(
	`do_li¡
(
fd
, 
Çme
)è
ç
;

396 
ID_SEND
:

397 if(
	`do_£nd
(
fd
, 
Çme
, 
bufãr
)è
ç
;

399 
ID_RECV
:

400 if(
	`do_»cv
(
fd
, 
Çme
, 
bufãr
)è
ç
;

402 
ID_QUIT
:

403 
ç
;

405 
	`ç_mes§ge
(
fd
, "unknown command");

406 
ç
;

410 
ç
:

411 if(
bufãr
 !ğ0è
	`ä“
(buffer);

412 
	`D
("sync: done\n");

413 
	`adb_şo£
(
fd
);

414 
	}
}

	@file_sync_service.h

17 #iâdeà
_FILE_SYNC_SERVICE_H_


18 
	#_FILE_SYNC_SERVICE_H_


	)

20 #ifdeà
HAVE_BIG_ENDIAN


21 
šlše
 
	$__sw­_ušt32
(
x
)

23  (((
x
) & 0xFF000000) >> 24)

24 | (((
x
) & 0x00FF0000) >> 8)

25 | (((
x
) & 0x0000FF00) << 8)

26 | (((
x
) & 0x000000FF) << 24);

27 
	}
}

28 
	#htŞl
(
x
è
	`__sw­_ušt32
(x)

	)

29 
	#Éohl
(
x
è
	`__sw­_ušt32
(x)

	)

30 
	#MKID
(
a
,
b
,
c
,
d
è((dè| ((cè<< 8è| ((bè<< 16è| (×è<< 24))

	)

32 
	#htŞl
(
x
è(x)

	)

33 
	#Éohl
(
x
è(x)

	)

34 
	#MKID
(
a
,
b
,
c
,
d
è(×è| ((bè<< 8è| ((cè<< 16è| ((dè<< 24))

	)

37 
	#ID_STAT
 
	`MKID
('S','T','A','T')

	)

38 
	#ID_LIST
 
	`MKID
('L','I','S','T')

	)

39 
	#ID_ULNK
 
	`MKID
('U','L','N','K')

	)

40 
	#ID_SEND
 
	`MKID
('S','E','N','D')

	)

41 
	#ID_RECV
 
	`MKID
('R','E','C','V')

	)

42 
	#ID_DENT
 
	`MKID
('D','E','N','T')

	)

43 
	#ID_DONE
 
	`MKID
('D','O','N','E')

	)

44 
	#ID_DATA
 
	`MKID
('D','A','T','A')

	)

45 
	#ID_OKAY
 
	`MKID
('O','K','A','Y')

	)

46 
	#ID_FAIL
 
	`MKID
('F','A','I','L')

	)

47 
	#ID_QUIT
 
	`MKID
('Q','U','I','T')

	)

50 
	mid
;

52 
	mid
;

53 
	mÇm–’
;

54 } 
	m»q
;

56 
	mid
;

57 
	mmode
;

58 
	msize
;

59 
	mtime
;

60 } 
	m¡©
;

62 
	mid
;

63 
	mmode
;

64 
	msize
;

65 
	mtime
;

66 
	mÇm–’
;

67 } 
	md’t
;

69 
	mid
;

70 
	msize
;

71 } 
	md©a
;

73 
	mid
;

74 
	mmsgËn
;

75 } 
	m¡©us
;

76 } 
	tsyncmsg
;

79 
fe_sync_£rviû
(
fd
, *
cook›
);

80 
do_sync_ls
(cÚ¡ *
·th
);

81 
do_sync_push
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
v”ifyApk
);

82 
do_sync_sync
(cÚ¡ *
Í©h
, cÚ¡ *
½©h
, 
li¡Úly
);

83 
do_sync_puÎ
(cÚ¡ *
½©h
, cÚ¡ *
Í©h
);

85 
	#SYNC_DATA_MAX
 (64*1024)

	)

	@framebuffer_service.c

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

21 
	~<fú.h
>

22 
	~<”ºo.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/wa™.h
>

26 
	~"fdev’t.h
"

27 
	~"adb.h
"

29 
	~<lšux/fb.h
>

30 
	~<sys/ioùl.h
>

31 
	~<sys/mmª.h
>

38 #iâdeà
TEMP_FAILURE_RETRY


40 
	#TEMP_FAILURE_RETRY
(
exp
) ({ \

41 
	`ty³of
 (
exp
è
_rc
; \

43 
_rc
 = (
exp
); \

44 } 
_rc
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

45 
_rc
; })

	)

53 
	#DDMS_RAWIMAGE_VERSION
 1

	)

54 
	sfbšfo
 {

55 
	mv”siÚ
;

56 
	mbµ
;

57 
	msize
;

58 
	mwidth
;

59 
	mheight
;

60 
	m»d_off£t
;

61 
	m»d_Ëngth
;

62 
	mblue_off£t
;

63 
	mblue_Ëngth
;

64 
	mg»’_off£t
;

65 
	mg»’_Ëngth
;

66 
	m®pha_off£t
;

67 
	m®pha_Ëngth
;

68 } 
__©Œibu‹__
((
·cked
));

70 
	$äamebufãr_£rviû
(
fd
, *
cook›
)

72 
fbšfo
 fbinfo;

73 
i
;

74 
buf
[1024];

75 
fd_sü“nÿp
;

76 
w
, 
h
, 
f
;

77 
fds
[2];

79 ià(
	`pe
(
fds
è< 0è
dÚe
;

81 
pid_t
 
pid
 = 
	`fÜk
();

82 ià(
pid
 < 0è
dÚe
;

84 ià(
pid
 == 0) {

85 
	`dup2
(
fds
[1], 
STDOUT_FILENO
);

86 
	`şo£
(
fds
[0]);

87 
	`şo£
(
fds
[1]);

88 cÚ¡ * 
commªd
 = "screencap";

89 cÚ¡ *
¬gs
[2] = {
commªd
, 
NULL
};

90 
	`execvp
(
commªd
, (**)
¬gs
);

91 
	`ex™
(1);

94 
fd_sü“nÿp
 = 
fds
[0];

97 if(
	`»adx
(
fd_sü“nÿp
, &
w
, 4)è
dÚe
;

98 if(
	`»adx
(
fd_sü“nÿp
, &
h
, 4)è
dÚe
;

99 if(
	`»adx
(
fd_sü“nÿp
, &
f
, 4)è
dÚe
;

101 
fbšfo
.
v”siÚ
 = 
DDMS_RAWIMAGE_VERSION
;

103 
f
) {

105 
fbšfo
.
bµ
 = 32;

106 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

107 
fbšfo
.
width
 = 
w
;

108 
fbšfo
.
height
 = 
h
;

109 
fbšfo
.
»d_off£t
 = 0;

110 
fbšfo
.
»d_Ëngth
 = 8;

111 
fbšfo
.
g»’_off£t
 = 8;

112 
fbšfo
.
g»’_Ëngth
 = 8;

113 
fbšfo
.
blue_off£t
 = 16;

114 
fbšfo
.
blue_Ëngth
 = 8;

115 
fbšfo
.
®pha_off£t
 = 24;

116 
fbšfo
.
®pha_Ëngth
 = 8;

119 
fbšfo
.
bµ
 = 32;

120 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

121 
fbšfo
.
width
 = 
w
;

122 
fbšfo
.
height
 = 
h
;

123 
fbšfo
.
»d_off£t
 = 0;

124 
fbšfo
.
»d_Ëngth
 = 8;

125 
fbšfo
.
g»’_off£t
 = 8;

126 
fbšfo
.
g»’_Ëngth
 = 8;

127 
fbšfo
.
blue_off£t
 = 16;

128 
fbšfo
.
blue_Ëngth
 = 8;

129 
fbšfo
.
®pha_off£t
 = 24;

130 
fbšfo
.
®pha_Ëngth
 = 0;

133 
fbšfo
.
bµ
 = 24;

134 
fbšfo
.
size
 = 
w
 * 
h
 * 3;

135 
fbšfo
.
width
 = 
w
;

136 
fbšfo
.
height
 = 
h
;

137 
fbšfo
.
»d_off£t
 = 0;

138 
fbšfo
.
»d_Ëngth
 = 8;

139 
fbšfo
.
g»’_off£t
 = 8;

140 
fbšfo
.
g»’_Ëngth
 = 8;

141 
fbšfo
.
blue_off£t
 = 16;

142 
fbšfo
.
blue_Ëngth
 = 8;

143 
fbšfo
.
®pha_off£t
 = 24;

144 
fbšfo
.
®pha_Ëngth
 = 0;

147 
fbšfo
.
bµ
 = 16;

148 
fbšfo
.
size
 = 
w
 * 
h
 * 2;

149 
fbšfo
.
width
 = 
w
;

150 
fbšfo
.
height
 = 
h
;

151 
fbšfo
.
»d_off£t
 = 11;

152 
fbšfo
.
»d_Ëngth
 = 5;

153 
fbšfo
.
g»’_off£t
 = 5;

154 
fbšfo
.
g»’_Ëngth
 = 6;

155 
fbšfo
.
blue_off£t
 = 0;

156 
fbšfo
.
blue_Ëngth
 = 5;

157 
fbšfo
.
®pha_off£t
 = 0;

158 
fbšfo
.
®pha_Ëngth
 = 0;

161 
fbšfo
.
bµ
 = 32;

162 
fbšfo
.
size
 = 
w
 * 
h
 * 4;

163 
fbšfo
.
width
 = 
w
;

164 
fbšfo
.
height
 = 
h
;

165 
fbšfo
.
»d_off£t
 = 16;

166 
fbšfo
.
»d_Ëngth
 = 8;

167 
fbšfo
.
g»’_off£t
 = 8;

168 
fbšfo
.
g»’_Ëngth
 = 8;

169 
fbšfo
.
blue_off£t
 = 0;

170 
fbšfo
.
blue_Ëngth
 = 8;

171 
fbšfo
.
®pha_off£t
 = 24;

172 
fbšfo
.
®pha_Ëngth
 = 8;

175 
dÚe
;

179 if(
	`wr™ex
(
fd
, &
fbšfo
, (fbšfo))è
dÚe
;

182 
i
 = 0; i < 
fbšfo
.
size
; i +ğ(
buf
)) {

183 if(
	`»adx
(
fd_sü“nÿp
, 
buf
, (buf))è
dÚe
;

184 if(
	`wr™ex
(
fd
, 
buf
, (buf))è
dÚe
;

186 if(
	`»adx
(
fd_sü“nÿp
, 
buf
, 
fbšfo
.
size
 % (buf))è
dÚe
;

187 if(
	`wr™ex
(
fd
, 
buf
, 
fbšfo
.
size
 % (buf))è
dÚe
;

189 
dÚe
:

190 
	`TEMP_FAILURE_RETRY
(
	`wa™pid
(
pid
, 
NULL
, 0));

192 
	`şo£
(
fds
[0]);

193 
	`şo£
(
fds
[1]);

194 
	`şo£
(
fd
);

195 
	}
}

	@get_my_path_darwin.c

17 #impÜˆ<
C¬bÚ
/C¬bÚ.
h
>

18 
	~<uni¡d.h
>

20 
	$g‘_my_·th
(*
s
, 
size_t
 
maxL’
)

22 
ProûssS”ŸlNumb”
 
p¢
;

23 
	`G‘Cu¼’tProûss
(&
p¢
);

24 
CFDiùiÚ¬yRef
 
diù
;

25 
diù
 = 
	`ProûssInfÜm©iÚCİyDiùiÚ¬y
(&
p¢
, 0xffffffff);

26 
CFSŒšgRef
 
v®ue
 = (CFSŒšgRef)
	`CFDiùiÚ¬yG‘V®ue
(
diù
,

27 
	`CFSTR
("CFBundleExecutable"));

28 
	`CFSŒšgG‘CSŒšg
(
v®ue
, 
s
, 
maxL’
, 
kCFSŒšgEncodšgUTF8
);

29 
	}
}

	@get_my_path_freebsd.c

20 
	~<sys/ty³s.h
>

21 
	~<uni¡d.h
>

22 
	~<lim™s.h
>

23 
	~<¡dio.h
>

26 
	$g‘_my_·th
(*
exe
, 
size_t
 
maxL’
)

28 
´oc
[64];

30 
	`¢´štf
(
´oc
, Õroc), "/´oc/%d/fe", 
	`g‘pid
());

32 
”r
 = 
	`»adlšk
(
´oc
, 
exe
, 
maxL’
 - 1);

34 
exe
[
”r
 > 0 ?ƒrr : 0] = '\0';

35 
	}
}

	@get_my_path_linux.c

17 
	~<sys/ty³s.h
>

18 
	~<uni¡d.h
>

19 
	~<lim™s.h
>

20 
	~<¡dio.h
>

22 
	$g‘_my_·th
(*
exe
, 
size_t
 
maxL’
)

24 
´oc
[64];

25 
	`¢´štf
(
´oc
, …roc, "/´oc/%d/exe", 
	`g‘pid
());

26 
”r
 = 
	`»adlšk
(
´oc
, 
exe
, 
maxL’
 - 1);

27 if(
”r
 > 0) {

28 
exe
[
”r
] = '\0';

30 
exe
[0] = '\0';

32 
	}
}

	@get_my_path_windows.c

17 
	~<lim™s.h
>

18 
	~<as£¹.h
>

19 
	~<wšdows.h
>

21 
	$g‘_my_·th
(*
exe
, 
size_t
 
maxL’
)

23 *
r
;

26 ià(
	`G‘ModuËFeName
(
NULL
, 
exe
, 
maxL’
) > 0) {

27 
r
 = 
	`¡¼chr
(
exe
, '\\');

28 ià(
r
 !ğ
NULL
)

29 *
r
 = '\0';

31 
exe
[0] = '\0';

33 
	}
}

	@jdwp_service.c

2 
	~"sysd•s.h
"

3 
	#TRACE_TAG
 
TRACE_JDWP


	)

4 
	~"adb.h
"

5 
	~<”ºo.h
>

6 
	~<¡dio.h
>

7 
	~<¡ršg.h
>

8 
	~<uni¡d.h
>

97 
	#MAX_OUT_FDS
 4

	)

99 #ià!
ADB_HOST


101 
	~<sys/sock‘.h
>

102 
	~<sys/un.h
>

104 
JdwpProûss
 
	tJdwpProûss
;

105 
	sJdwpProûss
 {

106 
JdwpProûss
* 
	mÃxt
;

107 
JdwpProûss
* 
	m´ev
;

108 
	mpid
;

109 
	msock‘
;

110 
fdev’t
* 
	mfde
;

112 
	mš_buff
[4];

113 
	mš_Ën
;

115 
	mout_fds
[
MAX_OUT_FDS
];

116 
	mout_couÁ
;

119 
JdwpProûss
 
	g_jdwp_li¡
;

122 
	$jdwp_´oûss_li¡
Ğ* 
bufãr
, 
bufã¾’
 )

124 * 
’d
 = 
bufãr
 + 
bufã¾’
;

125 * 
p
 = 
bufãr
;

126 
JdwpProûss
* 
´oc
 = 
_jdwp_li¡
.
Ãxt
;

128  ; 
´oc
 !ğ&
_jdwp_li¡
;…roøğ´oc->
Ãxt
 ) {

129 
Ën
;

132 ià(
´oc
->
pid
 < 0)

135 
Ën
 = 
	`¢´štf
(
p
, 
’d
-p, "%d\n", 
´oc
->
pid
);

136 ià(
p
 + 
Ën
 >ğ
’d
)

138 
p
 +ğ
Ën
;

140 
p
[0] = 0;

141  (
p
 - 
bufãr
);

142 
	}
}

146 
	$jdwp_´oûss_li¡_msg
Ğ* 
bufãr
, 
bufã¾’
 )

148 
h—d
[5];

149 
Ën
 = 
	`jdwp_´oûss_li¡
Ğ
bufãr
+4, 
bufã¾’
-4 );

150 
	`¢´štf
(
h—d
,  h—d, "%04x", 
Ën
);

151 
	`memıy
(
bufãr
, 
h—d
, 4);

152  
Ën
 + 4;

153 
	}
}

156 
jdwp_´oûss_li¡_upd©ed
();

159 
	$jdwp_´oûss_ä“
Ğ
JdwpProûss
* 
´oc
 )

161 ià(
´oc
) {

162 
n
;

164 
´oc
->
´ev
->
Ãxt
 =…roc->next;

165 
´oc
->
Ãxt
->
´ev
 =…roc->prev;

167 ià(
´oc
->
sock‘
 >= 0) {

168 
	`adb_shutdown
(
´oc
->
sock‘
);

169 
	`adb_şo£
(
´oc
->
sock‘
);

170 
´oc
->
sock‘
 = -1;

173 ià(
´oc
->
fde
 !ğ
NULL
) {

174 
	`fdev’t_de¡roy
(
´oc
->
fde
);

175 
´oc
->
fde
 = 
NULL
;

177 
´oc
->
pid
 = -1;

179 
n
 = 0;‚ < 
´oc
->
out_couÁ
;‚++) {

180 
	`adb_şo£
(
´oc
->
out_fds
[
n
]);

182 
´oc
->
out_couÁ
 = 0;

184 
	`ä“
(
´oc
);

186 
	`jdwp_´oûss_li¡_upd©ed
();

188 
	}
}

191 
jdwp_´oûss_ev’t
(, , *);

194 
JdwpProûss
*

195 
	$jdwp_´oûss_®loc
Ğ
sock‘
 )

197 
JdwpProûss
* 
´oc
 = 
	`ÿÎoc
(1,(*proc));

199 ià(
´oc
 =ğ
NULL
) {

200 
	`D
("notƒnough memoryo create‚ew JDWP…rocess\n");

201  
NULL
;

204 
´oc
->
sock‘
 = socket;

205 
´oc
->
pid
 = -1;

206 
´oc
->
Ãxt
 =…roc;

207 
´oc
->
´ev
 =…roc;

209 
´oc
->
fde
 = 
	`fdev’t_ü—‹
Ğ
sock‘
, 
jdwp_´oûss_ev’t
,…roc );

210 ià(
´oc
->
fde
 =ğ
NULL
) {

211 
	`D
("could‚ot create fdevent for‚ew JDWP…rocess\n" );

212 
	`ä“
(
´oc
);

213  
NULL
;

216 
´oc
->
fde
->
¡©e
 |ğ
FDE_DONT_CLOSE
;

217 
´oc
->
š_Ën
 = 0;

218 
´oc
->
out_couÁ
 = 0;

221 
´oc
->
Ãxt
 = &
_jdwp_li¡
;

222 
´oc
->
´ev
 =…roc->
Ãxt
->prev;

224 
´oc
->
´ev
->
Ãxt
 =…roc;

225 
´oc
->
Ãxt
->
´ev
 =…roc;

228 
	`fdev’t_add
(
´oc
->
fde
, 
FDE_READ
);

230  
´oc
;

231 
	}
}

235 
	$jdwp_´oûss_ev’t
Ğ
sock‘
, 
ev’ts
, * 
_´oc
 )

237 
JdwpProûss
* 
´oc
 = 
_´oc
;

239 ià(
ev’ts
 & 
FDE_READ
) {

240 ià(
´oc
->
pid
 < 0) {

242 * 
p
 = 
´oc
->
š_buff
 +…roc->
š_Ën
;

243 
size
 = 4 - 
´oc
->
š_Ën
;

244 
‹mp
[5];

245 
size
 > 0) {

246 
Ën
 = 
	`»cv
Ğ
sock‘
, 
p
, 
size
, 0 );

247 ià(
Ën
 < 0) {

248 ià(
”ºo
 =ğ
EINTR
)

250 ià(
”ºo
 =ğ
EAGAIN
)

253 
	`D
("weird unknown JDWP…rocess failure: %s\n",

254 
	`¡»¼Ü
(
”ºo
));

256 
Clo£Proûss
;

258 ià(
Ën
 == 0) {

259 
	`D
("weirdƒnd-of-stream from unknown JDWP…rocess\n");

260 
Clo£Proûss
;

262 
p
 +ğ
Ën
;

263 
´oc
->
š_Ën
 +ğ
Ën
;

264 
size
 -ğ
Ën
;

267 
	`memıy
(
‹mp
, 
´oc
->
š_buff
, 4);

268 
‹mp
[4] = 0;

270 ià(
	`ssÿnf
Ğ
‹mp
, "%04x", &
´oc
->
pid
 ) != 1) {

271 
	`D
("could‚Ù decodJDWP %°PID‚umb”: '%s'\n", 
´oc
, 
‹mp
);

272 
Clo£Proûss
;

276 
	`D
("Addšg…id %dØjdw°´oûs li¡\n", 
´oc
->
pid
);

277 
	`jdwp_´oûss_li¡_upd©ed
();

283 
buf
[32];

286 
Ën
 = 
	`»cv
(
sock‘
, 
buf
, (buf), 0);

288 ià(
Ën
 <= 0) {

289 ià(
Ën
 < 0 && 
”ºo
 =ğ
EINTR
)

291 ià(
Ën
 < 0 && 
”ºo
 =ğ
EAGAIN
)

294 
	`D
("‹rmš©šg JDWP %d cÚÃùiÚ: %s\n", 
´oc
->
pid
,

295 
	`¡»¼Ü
(
”ºo
));

300 
	`D
( "ignoring unexpected JDWP %d control socket‡ctivity (%d bytes)\n",

301 
´oc
->
pid
, 
Ën
 );

305 
Clo£Proûss
:

306 ià(
´oc
->
pid
 >= 0)

307 
	`D
Ğ"»movpid %dØjdw°´oûs li¡\n", 
´oc
->
pid
 );

308 
	`jdwp_´oûss_ä“
(
´oc
);

313 ià(
ev’ts
 & 
FDE_WRITE
) {

314 
	`D
("tryingo writeo JDWP…id controli (count=%d first=%d) %d\n",

315 
´oc
->
pid
,…roc->
out_couÁ
,…roc->
out_fds
[0]);

316 ià(
´oc
->
out_couÁ
 > 0) {

317 
fd
 = 
´oc
->
out_fds
[0];

318 
n
, 
»t
;

319 
cmsghdr
* 
cmsg
;

320 
msghdr
 
msg
;

321 
iovec
 
iov
;

322 
dummy
 = '!';

323 
bufãr
[(
cmsghdr
) + ()];

324 
æags
;

326 
iov
.
iov_ba£
 = &
dummy
;

327 
iov
.
iov_Ën
 = 1;

328 
msg
.
msg_Çme
 = 
NULL
;

329 
msg
.
msg_Çm–’
 = 0;

330 
msg
.
msg_iov
 = &
iov
;

331 
msg
.
msg_iovËn
 = 1;

332 
msg
.
msg_æags
 = 0;

333 
msg
.
msg_cÚŒŞ
 = 
bufãr
;

334 
msg
.
msg_cÚŒŞËn
 = (
bufãr
);

336 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
);

337 
cmsg
->
cmsg_Ën
 = 
msg
.
msg_cÚŒŞËn
;

338 
cmsg
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

339 
cmsg
->
cmsg_ty³
 = 
SCM_RIGHTS
;

340 ((*)
	`CMSG_DATA
(
cmsg
))[0] = 
fd
;

342 
æags
 = 
	`fú
(
´oc
->
sock‘
,
F_GETFL
,0);

344 ià(
æags
 == -1) {

345 
	`D
("failedo get cntl flags for socket %d: %s\n",

346 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

347 
Clo£Proûss
;

351 ià(
	`fú
(
´oc
->
sock‘
, 
F_SETFL
, 
æags
 & ~
O_NONBLOCK
) == -1) {

352 
	`D
("failedo„emove O_NONBLOCK flag for socket %d: %s\n",

353 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

354 
Clo£Proûss
;

358 
»t
 = 
	`£ndmsg
(
´oc
->
sock‘
, &
msg
, 0);

359 ià(
»t
 >= 0) {

360 
	`adb_şo£
(
fd
);

363 ià(
”ºo
 =ğ
EINTR
)

365 
	`D
("sending‚ew file descriptoro JDWP %d failed: %s\n",

366 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

367 
Clo£Proûss
;

370 
	`D
("sent file descriptor %do JDWP…rocess %d\n",

371 
fd
, 
´oc
->
pid
);

373 
n
 = 1;‚ < 
´oc
->
out_couÁ
;‚++)

374 
´oc
->
out_fds
[
n
-1] =…roc->out_fds[n];

376 ià(
	`fú
(
´oc
->
sock‘
, 
F_SETFL
, 
æags
) == -1) {

377 
	`D
("failedo set O_NONBLOCK flag for socket %d: %s\n",

378 
´oc
->
pid
, 
	`¡»¼Ü
(
”ºo
));

379 
Clo£Proûss
;

382 ià(--
´oc
->
out_couÁ
 == 0)

383 
	`fdev’t_d–
Ğ
´oc
->
fde
, 
FDE_WRITE
 );

386 
	}
}

390 
	$ü—‹_jdwp_cÚÃùiÚ_fd
(
pid
)

392 
JdwpProûss
* 
´oc
 = 
_jdwp_li¡
.
Ãxt
;

394 
	`D
("lookšg fÜ…id %d iÀJDWP…roûs li¡\n", 
pid
);

395  ; 
´oc
 !ğ&
_jdwp_li¡
;…roøğ´oc->
Ãxt
 ) {

396 ià(
´oc
->
pid
 ==…id) {

397 
FoundIt
;

400 
	`D
("search failed !!\n");

403 
FoundIt
:

405 
fds
[2];

407 ià(
´oc
->
out_couÁ
 >ğ
MAX_OUT_FDS
) {

408 
	`D
("%s:oo many…ending JDWP connection for…id %d\n",

409 
__FUNCTION__
, 
pid
);

413 ià(
	`adb_sock‘·œ
(
fds
) < 0) {

414 
	`D
("%s: socket…air creation failed: %s\n",

415 
__FUNCTION__
, 
	`¡»¼Ü
(
”ºo
));

419 
´oc
->
out_fds
[…roc->
out_couÁ
 ] = 
fds
[1];

420 ià(++
´oc
->
out_couÁ
 == 1)

421 
	`fdev’t_add
Ğ
´oc
->
fde
, 
FDE_WRITE
 );

423  
fds
[0];

425 
	}
}

433 
	#JDWP_CONTROL_NAME
 "\0jdwp-cÚŒŞ"

	)

434 
	#JDWP_CONTROL_NAME_LEN
 ((
JDWP_CONTROL_NAME
)-1)

	)

437 
	mli¡’_sock‘
;

438 
fdev’t
* 
	mfde
;

440 } 
	tJdwpCÚŒŞ
;

444 
jdwp_cÚŒŞ_ev’t
(
s
, 
ev’ts
, * 
u£r
);

448 
	$jdwp_cÚŒŞ_š™
Ğ
JdwpCÚŒŞ
* 
cÚŒŞ
,

449 cÚ¡ * 
sockÇme
,

450 
sockÇm–’
 )

452 
sockaddr_un
 
addr
;

453 
sockËn_t
 
add¾’
;

454 
s
;

455 
max·th
 = (
addr
.
sun_·th
);

456 
·thËn
 = 
sockÇm–’
;

458 ià(
·thËn
 >ğ
max·th
) {

459 
	`D
( "vm debug control socket‚ameoo†ong (%dƒxtra chars)\n",

460 
·thËn
+1-
max·th
 );

464 
	`mem£t
(&
addr
, 0, (addr));

465 
addr
.
sun_çmy
 = 
AF_UNIX
;

466 
	`memıy
(
addr
.
sun_·th
, 
sockÇme
, 
sockÇm–’
);

468 
s
 = 
	`sock‘
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0 );

469 ià(
s
 < 0) {

470 
	`D
( "could‚ot create vm debug control socket. %d: %s\n",

471 
”ºo
, 
	`¡»¼Ü
(errno));

475 
add¾’
 = (
·thËn
 + (
addr
.
sun_çmy
));

477 ià(
	`bšd
(
s
, (
sockaddr
*)&
addr
, 
add¾’
) < 0) {

478 
	`D
( "could‚ot bind vm debug control socket: %d: %s\n",

479 
”ºo
, 
	`¡»¼Ü
(errno) );

480 
	`adb_şo£
(
s
);

484 iàĞ
	`li¡’
(
s
, 4) < 0 ) {

485 
	`D
("listen failed in jdwp control socket: %d: %s\n",

486 
”ºo
, 
	`¡»¼Ü
(errno));

487 
	`adb_şo£
(
s
);

491 
cÚŒŞ
->
li¡’_sock‘
 = 
s
;

493 
cÚŒŞ
->
fde
 = 
	`fdev’t_ü—‹
(
s
, 
jdwp_cÚŒŞ_ev’t
, control);

494 ià(
cÚŒŞ
->
fde
 =ğ
NULL
) {

495 
	`D
( "could‚ot create fdevent for jdwp control socket\n" );

496 
	`adb_şo£
(
s
);

501 
	`fdev’t_add
(
cÚŒŞ
->
fde
, 
FDE_READ
);

502 
	`şo£_Ú_exec
(
s
);

504 
	`D
("jdw°cÚŒŞ sock‘ s¹ed (%d)\n", 
cÚŒŞ
->
li¡’_sock‘
);

506 
	}
}

510 
	$jdwp_cÚŒŞ_ev’t
Ğ
s
, 
ev’ts
, * 
_cÚŒŞ
 )

512 
JdwpCÚŒŞ
* 
cÚŒŞ
 = (JdwpCÚŒŞ*è
_cÚŒŞ
;

514 ià(
ev’ts
 & 
FDE_READ
) {

515 
sockaddr
 
addr
;

516 
sockËn_t
 
add¾’
 = (
addr
);

517 
s
 = -1;

518 
JdwpProûss
* 
´oc
;

521 
s
 = 
	`adb_sock‘_acû±
Ğ
cÚŒŞ
->
li¡’_sock‘
, &
addr
, &
add¾’
 );

522 ià(
s
 < 0) {

523 ià(
”ºo
 =ğ
EINTR
)

525 ià(
”ºo
 =ğ
ECONNABORTED
) {

527 
	`D
("oops,he JDWP…rocess died„eally quick\n");

531 
	`D
( "weird‡ccept() failed on jdwp control socket: %s\n",

532 
	`¡»¼Ü
(
”ºo
) );

536 
s
 < 0);

538 
´oc
 = 
	`jdwp_´oûss_®loc
Ğ
s
 );

539 ià(
´oc
 =ğ
NULL
)

542 
	}
}

545 
JdwpCÚŒŞ
 
	g_jdwp_cÚŒŞ
;

552 
asock‘
 
	msock‘
;

553 
	m·ss
;

554 } 
	tJdwpSock‘
;

557 
	$jdwp_sock‘_şo£
Ğ
asock‘
* 
s
 )

559 
asock‘
* 
³”
 = 
s
->peer;

561 
	`»move_sock‘
(
s
);

563 ià(
³”
) {

564 
³”
->³” = 
NULL
;

565 
³”
->
	`şo£
(peer);

567 
	`ä“
(
s
);

568 
	}
}

571 
	$jdwp_sock‘_’queue
Ğ
asock‘
* 
s
, 
­ack‘
* 
p
 )

574 
	`put_­ack‘
(
p
);

575 
s
->
³”
->
	`şo£
(s->peer);

577 
	}
}

581 
	$jdwp_sock‘_»ady
Ğ
asock‘
* 
s
 )

583 
JdwpSock‘
* 
jdwp
 = (JdwpSock‘*)
s
;

584 
asock‘
* 
³”
 = 
jdwp
->
sock‘
.peer;

589 ià(
jdwp
->
·ss
 == 0) {

590 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

591 
p
->
Ën
 = 
	`jdwp_´oûss_li¡
((*í->
d©a
, 
MAX_PAYLOAD
);

592 
³”
->
	`’queue
Õ“r, 
p
);

593 
jdwp
->
·ss
 = 1;

596 
³”
->
	`şo£
(peer);

598 
	}
}

600 
asock‘
*

601 
	$ü—‹_jdwp_£rviû_sock‘
( )

603 
JdwpSock‘
* 
s
 = 
	`ÿÎoc
((*s),1);

605 ià(
s
 =ğ
NULL
)

606  
NULL
;

608 
	`š¡®l_loÿl_sock‘
(&
s
->
sock‘
);

610 
s
->
sock‘
.
»ady
 = 
jdwp_sock‘_»ady
;

611 
s
->
sock‘
.
’queue
 = 
jdwp_sock‘_’queue
;

612 
s
->
sock‘
.
şo£
 = 
jdwp_sock‘_şo£
;

613 
s
->
·ss
 = 0;

615  &
s
->
sock‘
;

616 
	}
}

623 
JdwpT¿ck”
 
	tJdwpT¿ck”
;

625 
	sJdwpT¿ck”
 {

626 
asock‘
 
	msock‘
;

627 
JdwpT¿ck”
* 
	mÃxt
;

628 
JdwpT¿ck”
* 
	m´ev
;

629 
	mÃed_upd©e
;

632 
JdwpT¿ck”
 
	g_jdwp_Œack”s_li¡
;

636 
	$jdwp_´oûss_li¡_upd©ed
()

638 
bufãr
[1024];

639 
Ën
;

640 
JdwpT¿ck”
* 
t
 = 
_jdwp_Œack”s_li¡
.
Ãxt
;

642 
Ën
 = 
	`jdwp_´oûss_li¡_msg
(
bufãr
, (buffer));

644  ; 
t
 !ğ&
_jdwp_Œack”s_li¡
; =->
Ãxt
 ) {

645 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

646 
asock‘
* 
³”
 = 
t
->
sock‘
.peer;

647 
	`memıy
(
p
->
d©a
, 
bufãr
, 
Ën
);

648 
p
->
Ën
 =†en;

649 
³”
->
	`’queue
Ğ³”, 
p
 );

651 
	}
}

654 
	$jdwp_Œack”_şo£
Ğ
asock‘
* 
s
 )

656 
JdwpT¿ck”
* 
Œack”
 = (JdwpT¿ck”*è
s
;

657 
asock‘
* 
³”
 = 
s
->peer;

659 ià(
³”
) {

660 
³”
->³” = 
NULL
;

661 
³”
->
	`şo£
(peer);

664 
	`»move_sock‘
(
s
);

666 
Œack”
->
´ev
->
Ãxt
 =racker->next;

667 
Œack”
->
Ãxt
->
´ev
 =racker->prev;

669 
	`ä“
(
s
);

670 
	}
}

673 
	$jdwp_Œack”_»ady
Ğ
asock‘
* 
s
 )

675 
JdwpT¿ck”
* 
t
 = (JdwpT¿ck”*è
s
;

677 ià(
t
->
Ãed_upd©e
) {

678 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

679 
t
->
Ãed_upd©e
 = 0;

680 
p
->
Ën
 = 
	`jdwp_´oûss_li¡_msg
((*í->
d©a
, (p->data));

681 
s
->
³”
->
	`’queue
(s->³”, 
p
);

683 
	}
}

686 
	$jdwp_Œack”_’queue
Ğ
asock‘
* 
s
, 
­ack‘
* 
p
 )

689 
	`put_­ack‘
(
p
);

690 
s
->
³”
->
	`şo£
(s->peer);

692 
	}
}

695 
asock‘
*

696 
	$ü—‹_jdwp_Œack”_£rviû_sock‘
( )

698 
JdwpT¿ck”
* 
t
 = 
	`ÿÎoc
((*t),1);

700 ià(
t
 =ğ
NULL
)

701  
NULL
;

703 
t
->
Ãxt
 = &
_jdwp_Œack”s_li¡
;

704 
t
->
´ev
 =->
Ãxt
->prev;

706 
t
->
Ãxt
->
´ev
 =;

707 
t
->
´ev
->
Ãxt
 =;

709 
	`š¡®l_loÿl_sock‘
(&
t
->
sock‘
);

711 
t
->
sock‘
.
»ady
 = 
jdwp_Œack”_»ady
;

712 
t
->
sock‘
.
’queue
 = 
jdwp_Œack”_’queue
;

713 
t
->
sock‘
.
şo£
 = 
jdwp_Œack”_şo£
;

714 
t
->
Ãed_upd©e
 = 1;

716  &
t
->
sock‘
;

717 
	}
}

721 
	$š™_jdwp
()

723 
_jdwp_li¡
.
Ãxt
 = &_jdwp_list;

724 
_jdwp_li¡
.
´ev
 = &_jdwp_list;

726 
_jdwp_Œack”s_li¡
.
Ãxt
 = &_jdwp_trackers_list;

727 
_jdwp_Œack”s_li¡
.
´ev
 = &_jdwp_trackers_list;

729  
	`jdwp_cÚŒŞ_š™
Ğ&
_jdwp_cÚŒŞ
,

730 
JDWP_CONTROL_NAME
,

731 
JDWP_CONTROL_NAME_LEN
 );

732 
	}
}

	@libs/libcutils/abort_socket.c

17 
	~<¡dlib.h
>

18 
	~<”ºo.h
>

19 
	~<uni¡d.h
>

20 
	~<fú.h
>

21 
	~<sys/sock‘.h
>

22 
	~<pŞl.h
>

24 
	~"cuts/abÜt_sock‘.h
"

26 
asock‘
 *
	$asock‘_š™
(
fd
) {

27 
abÜt_fd
[2];

28 
æags
;

29 
asock‘
 *
s
;

32 
æags
 = 
	`fú
(
fd
, 
F_GETFL
);

33 ià(
æags
 == -1)

34  
NULL
;

35 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
))

36  
NULL
;

40 ià(
	`pe
(
abÜt_fd
))

41  
NULL
;

42 
æags
 = 
	`fú
(
abÜt_fd
[1], 
F_GETFL
);

43 ià(
æags
 == -1)

44  
NULL
;

45 ià(
	`fú
(
abÜt_fd
[1], 
F_SETFL
, 
æags
 | 
O_NONBLOCK
))

46  
NULL
;

48 
s
 = 
	`m®loc
((
asock‘
));

49 ià(!
s
)

50  
NULL
;

52 
s
->
fd
 = fd;

53 
s
->
abÜt_fd
[0] =‡bort_fd[0];

54 
s
->
abÜt_fd
[1] =‡bort_fd[1];

56  
s
;

57 
	}
}

59 
	$asock‘_cÚÃù
(
asock‘
 *
s
, cÚ¡ 
sockaddr
 *
addr
,

60 
sockËn_t
 
add¾’
, 
timeout
) {

62 
»t
;

65 
»t
 = 
	`cÚÃù
(
s
->
fd
, 
addr
, 
add¾’
);

66 } 
»t
 && 
”ºo
 =ğ
EINTR
);

68 ià(
»t
 && 
”ºo
 =ğ
EINPROGRESS
) {

70 
sockËn_t
 
»’
;

71 
pŞlfd
 
pfd
[2];

73 
pfd
[0].
fd
 = 
s
->fd;

74 
pfd
[0].
ev’ts
 = 
POLLOUT
;

75 
pfd
[0].
»v’ts
 = 0;

76 
pfd
[1].
fd
 = 
s
->
abÜt_fd
[0];

77 
pfd
[1].
ev’ts
 = 
POLLIN
;

78 
pfd
[1].
»v’ts
 = 0;

81 
»t
 = 
	`pŞl
(
pfd
, 2, 
timeout
);

82 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

84 ià(
»t
 < 0)

86 ià(
»t
 == 0) {

88 
”ºo
 = 
ETIMEDOUT
;

92 ià(
pfd
[1].
»v’ts
) {

94 
”ºo
 = 
ECANCELED
;

98 ià(
pfd
[0].
»v’ts
) {

99 ià(
pfd
[0].
»v’ts
 & 
POLLOUT
) {

101 
»’
 = (
»t
);

102 ià(
	`g‘sockİt
(
s
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
»t
, &
»’
))

105 ià(
»t
) {

106 
”ºo
 = 
»t
;

110 
”ºo
 = 
ECONNABORTED
;

116  
»t
;

117 
	}
}

119 
	$asock‘_acû±
(
asock‘
 *
s
, 
sockaddr
 *
addr
,

120 
sockËn_t
 *
add¾’
, 
timeout
) {

122 
»t
;

123 
pŞlfd
 
pfd
[2];

125 
pfd
[0].
fd
 = 
s
->fd;

126 
pfd
[0].
ev’ts
 = 
POLLIN
;

127 
pfd
[0].
»v’ts
 = 0;

128 
pfd
[1].
fd
 = 
s
->
abÜt_fd
[0];

129 
pfd
[1].
ev’ts
 = 
POLLIN
;

130 
pfd
[1].
»v’ts
 = 0;

133 
»t
 = 
	`pŞl
(
pfd
, 2, 
timeout
);

134 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

136 ià(
»t
 < 0)

138 ià(
»t
 == 0) {

140 
”ºo
 = 
ETIMEDOUT
;

144 ià(
pfd
[1].
»v’ts
) {

146 
”ºo
 = 
ECANCELED
;

150 ià(
pfd
[0].
»v’ts
) {

151 ià(
pfd
[0].
»v’ts
 & 
POLLIN
) {

154 
»t
 = 
	`acû±
(
s
->
fd
, 
addr
, 
add¾’
);

155 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

158 
”ºo
 = 
ECONNABORTED
;

163  
»t
;

164 
	}
}

166 
	$asock‘_»ad
(
asock‘
 *
s
, *
buf
, 
size_t
 
couÁ
, 
timeout
) {

167 
»t
;

168 
pŞlfd
 
pfd
[2];

170 
pfd
[0].
fd
 = 
s
->fd;

171 
pfd
[0].
ev’ts
 = 
POLLIN
;

172 
pfd
[0].
»v’ts
 = 0;

173 
pfd
[1].
fd
 = 
s
->
abÜt_fd
[0];

174 
pfd
[1].
ev’ts
 = 
POLLIN
;

175 
pfd
[1].
»v’ts
 = 0;

178 
»t
 = 
	`pŞl
(
pfd
, 2, 
timeout
);

179 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

181 ià(
»t
 < 0)

183 ià(
»t
 == 0) {

185 
”ºo
 = 
ETIMEDOUT
;

189 ià(
pfd
[1].
»v’ts
) {

191 
”ºo
 = 
ECANCELED
;

195 ià(
pfd
[0].
»v’ts
) {

196 ià(
pfd
[0].
»v’ts
 & 
POLLIN
) {

199 
»t
 = 
	`»ad
(
s
->
fd
, 
buf
, 
couÁ
);

200 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

203 
”ºo
 = 
ECONNABORTED
;

208  
»t
;

209 
	}
}

211 
	$asock‘_wr™e
(
asock‘
 *
s
, cÚ¡ *
buf
, 
size_t
 
couÁ
,

212 
timeout
) {

213 
»t
;

214 
pŞlfd
 
pfd
[2];

216 
pfd
[0].
fd
 = 
s
->fd;

217 
pfd
[0].
ev’ts
 = 
POLLOUT
;

218 
pfd
[0].
»v’ts
 = 0;

219 
pfd
[1].
fd
 = 
s
->
abÜt_fd
[0];

220 
pfd
[1].
ev’ts
 = 
POLLIN
;

221 
pfd
[1].
»v’ts
 = 0;

224 
»t
 = 
	`pŞl
(
pfd
, 2, 
timeout
);

225 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

227 ià(
»t
 < 0)

229 ià(
»t
 == 0) {

231 
”ºo
 = 
ETIMEDOUT
;

235 ià(
pfd
[1].
»v’ts
) {

237 
”ºo
 = 
ECANCELED
;

241 ià(
pfd
[0].
»v’ts
) {

242 ià(
pfd
[0].
»v’ts
 & 
POLLOUT
) {

245 
»t
 = 
	`wr™e
(
s
->
fd
, 
buf
, 
couÁ
);

246 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

249 
”ºo
 = 
ECONNABORTED
;

254  
»t
;

255 
	}
}

257 
	$asock‘_abÜt
(
asock‘
 *
s
) {

258 
»t
;

259 
buf
 = 0;

262 
	`shutdown
(
s
->
fd
, 
SHUT_RDWR
);

266 
»t
 = 
	`wr™e
(
s
->
abÜt_fd
[1], &
buf
, 1);

267 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

268 
	}
}

270 
	$asock‘_de¡roy
(
asock‘
 *
s
) {

271 
asock‘
 
s_cİy
 = *
s
;

276 
s
->
fd
 = -1;

277 
s
->
abÜt_fd
[0] = -1;

278 
s
->
abÜt_fd
[1] = -1;

285 
	`asock‘_abÜt
(&
s_cİy
);

288 
	`şo£
(
s_cİy
.
abÜt_fd
[1]);

289 
	`şo£
(
s_cİy
.
abÜt_fd
[0]);

290 
	`şo£
(
s_cİy
.
fd
);

292 
	`ä“
(
s
);

293 
	}
}

	@libs/libcutils/android_reboot.c

17 
	~<uni¡d.h
>

18 
	~<sys/»boÙ.h
>

19 
	~<sys/ty³s.h
>

20 
	~<sys/¡©.h
>

21 
	~<fú.h
>

22 
	~<¡dio.h
>

23 
	~<¡ršg.h
>

25 
	~<cuts/ªdroid_»boÙ.h
>

31 
	$»mouÁ_ro_dÚe
()

33 
FILE
 *
f
;

34 
mouÁ_dev
[256];

35 
mouÁ_dœ
[256];

36 
mouÁ_ty³
[256];

37 
mouÁ_İts
[256];

38 
mouÁ_äeq
;

39 
mouÁ_·s¢o
;

40 
m©ch
;

41 
found_rw_fs
 = 0;

43 
f
 = 
	`fİ’
("/proc/mounts", "r");

44 ià(! 
f
) {

50 
m©ch
 = 
	`fsÿnf
(
f
, "%255s %255s %255s %255s %d %d\n",

51 
mouÁ_dev
, 
mouÁ_dœ
, 
mouÁ_ty³
,

52 
mouÁ_İts
, &
mouÁ_äeq
, &
mouÁ_·s¢o
);

53 
mouÁ_dev
[255] = 0;

54 
mouÁ_dœ
[255] = 0;

55 
mouÁ_ty³
[255] = 0;

56 
mouÁ_İts
[255] = 0;

57 ià((
m©ch
 =ğ6è&& !
	`¡ºcmp
(
mouÁ_dev
, "/dev/block", 10è&& 
	`¡r¡r
(
mouÁ_İts
, "rw")) {

58 
found_rw_fs
 = 1;

61 } 
m©ch
 !ğ
EOF
);

63 
	`fşo£
(
f
);

65  !
found_rw_fs
;

66 
	}
}

79 
	$»mouÁ_ro
()

81 
fd
, 
út
 = 0;

86 
fd
 = 
	`İ’
("/´oc/sy¤q-Œigg”", 
O_WRONLY
);

87 ià(
fd
 < 0) {

90 
	`wr™e
(
fd
, "u", 1);

91 
	`şo£
(
fd
);

95 !
	`»mouÁ_ro_dÚe
(è&& (
út
 < 50)) {

96 
	`u¦“p
(100000);

97 
út
++;

101 
	}
}

103 
wr™e_misc
(*
»asÚ
);

105 
	$ªdroid_»boÙ
(
cmd
, 
æags
, *
¬g
)

107 
»t
;

109 ià(!(
æags
 & 
ANDROID_RB_FLAG_NO_SYNC
))

110 
	`sync
();

112 ià(!(
æags
 & 
ANDROID_RB_FLAG_NO_REMOUNT_RO
))

113 
	`»mouÁ_ro
();

115 
cmd
) {

116 
ANDROID_RB_RESTART
:

117 
»t
 = 
	`»boÙ
(
RB_AUTOBOOT
);

120 
ANDROID_RB_POWEROFF
:

121 
»t
 = 
	`»boÙ
(
RB_POWER_OFF
);

124 
ANDROID_RB_RESTART2
:

127 
	`wr™e_misc
(
¬g
);

128 
»t
 = 
	`»boÙ
(
RB_AUTOBOOT
);

132 
»t
 = -1;

135  
»t
;

136 
	}
}

	@libs/libcutils/arch-arm/memset32.S

21 .
	g‹xt


22 .
	g®ign


24 .
glob®
 
	gªdroid_mem£t32


25 .
ty³
 
	gªdroid_mem£t32
, %
	gfunùiÚ


26 .
glob®
 
	gªdroid_mem£t16


27 .
ty³
 
	gªdroid_mem£t16
, %
funùiÚ


37 
	gªdroid_mem£t16
:

38 .
â¡¬t


39 
cmp
 
r2
, #1

40 
bxË
 
Ì


43 
mov
 
	gr1
,„1, 
	gl¦
 #16

44 
Ür
 
	gr1
,„1,„1, 
	gl¤
 #16

47 
t¡
 
	gr0
, #2

48 
¡ºeh
 
	gr1
, [
r0
], #2

49 
subÃ
 
	gr2
,„2, #2

50 .
â’d


52 
	gªdroid_mem£t32
:

53 .
â¡¬t


54 .
§ve
 {
Ì
}

55 
¡r
 
Ì
, [
¥
, #-4]!

58 
mov
 
	gr12
, 
r1


59 
mov
 
	gÌ
, 
r1


60 
rsb
 
	gr3
, 
	gr0
, #0

61 
ªds
 
	gr3
,„3, #0
x1C


62 
	gbeq
 .
L®igÃd32


63 
cmp
 
	gr3
, 
r2


64 
ªdhi
 
	gr3
, 
	gr2
, #0
x1C


65 
sub
 
	gr2
,„2, 
r3


68 
movs
 
	gr3
,„3, 
	gl¦
 #28

69 
¡mcsŸ
 
	gr0
!, {
	gr1
, 
	gÌ
}

70 
¡mcsŸ
 
	gr0
!, {
	gr1
, 
	gÌ
}

71 
¡mmiŸ
 
	gr0
!, {
	gr1
, 
	gÌ
}

72 
movs
 
	gr3
,„3, 
	gl¦
 #2

73 
¡rcs
 
	gr1
, [
r0
], #4

75 .
	gL®igÃd32
:

76 
mov
 
r3
, 
	gr1


77 1: 
subs
 
r2
, 
	gr2
, #32

78 
¡mhsŸ
 
	gr0
!, {
	gr1
,
	gr3
,
	gr12
,
	gÌ
}

79 
¡mhsŸ
 
	gr0
!, {
	gr1
,
	gr3
,
	gr12
,
	gÌ
}

80 
	gbhs
 1b

81 
add
 
	gr2
,„2, #32

84 
movs
 
	gr2
,„2, 
	gl¦
 #28

85 
¡mcsŸ
 
	gr0
!, {
	gr1
,
	gr3
,
	gr12
,
	gÌ
}

86 
¡mmiŸ
 
	gr0
!, {
	gr1
,
	gÌ
}

87 
movs
 
	gr2
,„2, 
	gl¦
 #2

88 
¡rcs
 
	gr1
, [
r0
], #4

89 
¡rmih
 
	gÌ
, [
r0
], #2

91 
ldr
 
	gÌ
, [
¥
], #4

92 
bx
 
	gÌ


93 .
	gâ’d


	@libs/libcutils/arch-x86/android_memset16.S

20 #ià
defšed
(
USE_SSE2
)

22 
	~"ÿche_w¿µ”.S
"

23 #undeà
__i686


24 
	#USE_AS_ANDROID


	)

25 
	#s£2_mem£t16_©om
 
ªdroid_mem£t16


	)

26 
	~"s£2-mem£t16-©om.S
"

30 
	~"mem£t16.S
"

	@libs/libcutils/arch-x86/android_memset32.S

20 #ià
defšed
(
USE_SSE2
)

22 
	~"ÿche_w¿µ”.S
"

23 #undeà
__i686


24 
	#USE_AS_ANDROID


	)

25 
	#s£2_mem£t32_©om
 
ªdroid_mem£t32


	)

26 
	~"s£2-mem£t32-©om.S
"

30 
	~"mem£t32.S
"

	@libs/libcutils/arch-x86/cache_wrapper.S

21 
	#SHARED_CACHE_SIZE
 (512*1024è

	)

22 
	#DATA_CACHE_SIZE
 (24*1024è

	)

23 
	#SHARED_CACHE_SIZE_HALF
 (
SHARED_CACHE_SIZE
 / 2)

	)

24 
	#DATA_CACHE_SIZE_HALF
 (
DATA_CACHE_SIZE
 / 2)

	)

	@libs/libcutils/arch-x86/sse2-memset16-atom.S

20 #iâdeà
L


21 
	#L
(
Ïb–
è.
L
##
	)
label

24 #iâdeà
ALIGN


25 
	#ALIGN
(
n
è.
p2®ign
 
	)
n

28 #iâdeà
cfi_¡¬roc


29 
	#cfi_¡¬roc
 .
cfi_¡¬roc


	)

32 #iâdeà
cfi_’d´oc


33 
	#cfi_’d´oc
 .
cfi_’d´oc


	)

36 #iâdeà
cfi_»l_off£t


37 
	#cfi_»l_off£t
(
»g
, 
off
è.
cfi_»l_off£t
„eg, 
	)
off

40 #iâdeà
cfi_»¡Üe


41 
	#cfi_»¡Üe
(
»g
è.
cfi_»¡Üe
 
	)
reg

44 #iâdeà
cfi_adju¡_cç_off£t


45 
	#cfi_adju¡_cç_off£t
(
off
è.
cfi_adju¡_cç_off£t
 
	)
off

48 #iâdeà
ENTRY


49 
	#ENTRY
(
Çme
) \

50 .
ty³
 
Çme
, @
funùiÚ
; \

51 .
globl
 
Çme
; \

52 .
p2®ign
 4; \

53 
Çme
: \

54 
cfi_¡¬roc


	)

57 #iâdeà
END


58 
	#END
(
Çme
) \

59 
cfi_’d´oc
; \

60 .
size
 
Çme
, .-
	)
name

63 
	#CFI_PUSH
(
REG
) \

64 
	`cfi_adju¡_cç_off£t
 (4); \

65 
	`cfi_»l_off£t
 (
REG
, 0)

	)

67 
	#CFI_POP
(
REG
) \

68 
	`cfi_adju¡_cç_off£t
 (-4); \

69 
	`cfi_»¡Üe
 (
REG
)

	)

71 
	#PUSH
(
REG
è
pushl
 REG; 
	`CFI_PUSH
 (REG)

	)

72 
	#POP
(
REG
è
pİl
 REG; 
	`CFI_POP
 (REG)

	)

74 #ifdeà
USE_AS_BZERO16


75 
	#DEST
 
PARMS


	)

76 
	#LEN
 
DEST
+4

	)

78 
	#DEST
 
PARMS


	)

79 
	#CHR
 
DEST
+4

	)

80 
	#LEN
 
CHR
+4

	)

84 
	#SETRTNVAL


	)

86 
	#SETRTNVAL
 
movl
 
	`DEST
(%
e¥
), %
—x


	)

89 #ifdeà
SHARED


90 
	#ENTRANCE
 
	`PUSH
 (%
ebx
);

	)

91 
	#RETURN_END
 
	`POP
 (%
ebx
); 
»t


	)

92 
	#RETURN
 
RETURN_END
; 
	`CFI_PUSH
 (%
ebx
)

	)

93 
	#PARMS
 8

	)

94 
	#JMPTBL
(
I
, 
B
èI - 
	)
B

98 
	#BRANCH_TO_JMPTBL_ENTRY
(
TABLE
) \

100 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx
; \

102 
add
 
	`$
(
TABLE
 - .), %
ebx
; \

105 
	`add
 (%
ebx
,%
ecx
,4), %ebx; \

107 
jmp
 *%
ebx


	)

109 .
	g£ùiÚ
 .
	ggnu
.
	glškÚû
.
	gt
.
	g__i686
.
	gg‘_pc_thunk
.
	gbx
,"ax",@
	g´ogb™s


110 .
globl
 
	g__i686
.
	gg‘_pc_thunk
.
	gbx


111 .
hidd’
 
	g__i686
.
	gg‘_pc_thunk
.
bx


112 
ALIGN
 (4)

113 .
ty³
 
	g__i686
.
	gg‘_pc_thunk
.
	gbx
,@
funùiÚ


114 
	g__i686
.
	gg‘_pc_thunk
.
	gbx
:

115 
movl
 (%
e¥
), %
ebx


116 
	g»t


118 
	#ENTRANCE


	)

119 
	#RETURN_END
 
»t


	)

120 
	#RETURN
 
RETURN_END


	)

121 
	#PARMS
 4

	)

122 
	#JMPTBL
(
I
, 
B
è
	)
I

126 
	#BRANCH_TO_JMPTBL_ENTRY
(
TABLE
) \

127 
jmp
 *
	`TABLE
(,%
ecx
,4)

	)

130 .
	g£ùiÚ
 .
	g‹xt
.
	gs£2
,"ax",@
´ogb™s


131 
	$ALIGN
 (4)

132 
	$ENTRY
 (
s£2_mem£t16_©om
)

133 
ENTRANCE


135 
movl
 
	`LEN
(%
e¥
), %
ecx


136 #ifdeà
USE_AS_ANDROID


137 
shr
 
$1
, %
ecx


139 #ifdeà
USE_AS_BZERO16


140 
xÜ
 %
—x
, %eax

142 
movzwl
 
	`CHR
(%
e¥
), %
—x


143 
mov
 %
—x
, %
edx


144 
shl
 
$16
, %
—x


145 
Ü
 %
edx
, %
—x


147 
movl
 
	`DEST
(%
e¥
), %
edx


148 
cmp
 
$32
, %
ecx


149 
j«
 
	$L
(32
wÜdsÜmÜe
)

151 
	$L
(
wr™e_Ëss32wÜds
):

152 
	`Ëa
 (%
edx
, %
ecx
, 2), %edx

153 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	`L
(
bË_Ëss32wÜds
))

156 .
push£ùiÚ
 .
rod©a
.
s£2
,"a",@
´ogb™s


157 
	$ALIGN
 (2)

158 
	$L
(
bË_Ëss32wÜds
):

159 .
	`JMPTBL
 (
	`L
(
wr™e_0wÜds
), L(
bË_Ëss32wÜds
))

160 .
	`JMPTBL
 (
	`L
(
wr™e_1wÜds
), L(
bË_Ëss32wÜds
))

161 .
	`JMPTBL
 (
	`L
(
wr™e_2wÜds
), L(
bË_Ëss32wÜds
))

162 .
	`JMPTBL
 (
	`L
(
wr™e_3wÜds
), L(
bË_Ëss32wÜds
))

163 .
	`JMPTBL
 (
	`L
(
wr™e_4wÜds
), L(
bË_Ëss32wÜds
))

164 .
	`JMPTBL
 (
	`L
(
wr™e_5wÜds
), L(
bË_Ëss32wÜds
))

165 .
	`JMPTBL
 (
	`L
(
wr™e_6wÜds
), L(
bË_Ëss32wÜds
))

166 .
	`JMPTBL
 (
	`L
(
wr™e_7wÜds
), L(
bË_Ëss32wÜds
))

167 .
	`JMPTBL
 (
	`L
(
wr™e_8wÜds
), L(
bË_Ëss32wÜds
))

168 .
	`JMPTBL
 (
	`L
(
wr™e_9wÜds
), L(
bË_Ëss32wÜds
))

169 .
	`JMPTBL
 (
	`L
(
wr™e_10wÜds
), L(
bË_Ëss32wÜds
))

170 .
	`JMPTBL
 (
	`L
(
wr™e_11wÜds
), L(
bË_Ëss32wÜds
))

171 .
	`JMPTBL
 (
	`L
(
wr™e_12wÜds
), L(
bË_Ëss32wÜds
))

172 .
	`JMPTBL
 (
	`L
(
wr™e_13wÜds
), L(
bË_Ëss32wÜds
))

173 .
	`JMPTBL
 (
	`L
(
wr™e_14wÜds
), L(
bË_Ëss32wÜds
))

174 .
	`JMPTBL
 (
	`L
(
wr™e_15wÜds
), L(
bË_Ëss32wÜds
))

175 .
	`JMPTBL
 (
	`L
(
wr™e_16wÜds
), L(
bË_Ëss32wÜds
))

176 .
	`JMPTBL
 (
	`L
(
wr™e_17wÜds
), L(
bË_Ëss32wÜds
))

177 .
	`JMPTBL
 (
	`L
(
wr™e_18wÜds
), L(
bË_Ëss32wÜds
))

178 .
	`JMPTBL
 (
	`L
(
wr™e_19wÜds
), L(
bË_Ëss32wÜds
))

179 .
	`JMPTBL
 (
	`L
(
wr™e_20wÜds
), L(
bË_Ëss32wÜds
))

180 .
	`JMPTBL
 (
	`L
(
wr™e_21wÜds
), L(
bË_Ëss32wÜds
))

181 .
	`JMPTBL
 (
	`L
(
wr™e_22wÜds
), L(
bË_Ëss32wÜds
))

182 .
	`JMPTBL
 (
	`L
(
wr™e_23wÜds
), L(
bË_Ëss32wÜds
))

183 .
	`JMPTBL
 (
	`L
(
wr™e_24wÜds
), L(
bË_Ëss32wÜds
))

184 .
	`JMPTBL
 (
	`L
(
wr™e_25wÜds
), L(
bË_Ëss32wÜds
))

185 .
	`JMPTBL
 (
	`L
(
wr™e_26wÜds
), L(
bË_Ëss32wÜds
))

186 .
	`JMPTBL
 (
	`L
(
wr™e_27wÜds
), L(
bË_Ëss32wÜds
))

187 .
	`JMPTBL
 (
	`L
(
wr™e_28wÜds
), L(
bË_Ëss32wÜds
))

188 .
	`JMPTBL
 (
	`L
(
wr™e_29wÜds
), L(
bË_Ëss32wÜds
))

189 .
	`JMPTBL
 (
	`L
(
wr™e_30wÜds
), L(
bË_Ëss32wÜds
))

190 .
	`JMPTBL
 (
	`L
(
wr™e_31wÜds
), L(
bË_Ëss32wÜds
))

191 .
pİ£ùiÚ


193 
	$ALIGN
 (4)

194 
	$L
(
wr™e_28wÜds
):

195 
movl
 %
—x
, -56(%
edx
)

196 
movl
 %
—x
, -52(%
edx
)

197 
	$L
(
wr™e_24wÜds
):

198 
movl
 %
—x
, -48(%
edx
)

199 
movl
 %
—x
, -44(%
edx
)

200 
	$L
(
wr™e_20wÜds
):

201 
movl
 %
—x
, -40(%
edx
)

202 
movl
 %
—x
, -36(%
edx
)

203 
	$L
(
wr™e_16wÜds
):

204 
movl
 %
—x
, -32(%
edx
)

205 
movl
 %
—x
, -28(%
edx
)

206 
	$L
(
wr™e_12wÜds
):

207 
movl
 %
—x
, -24(%
edx
)

208 
movl
 %
—x
, -20(%
edx
)

209 
	$L
(
wr™e_8wÜds
):

210 
movl
 %
—x
, -16(%
edx
)

211 
movl
 %
—x
, -12(%
edx
)

212 
	$L
(
wr™e_4wÜds
):

213 
movl
 %
—x
, -8(%
edx
)

214 
movl
 %
—x
, -4(%
edx
)

215 
	$L
(
wr™e_0wÜds
):

216 
SETRTNVAL


217 
RETURN


219 
	$ALIGN
 (4)

220 
	$L
(
wr™e_29wÜds
):

221 
movl
 %
—x
, -58(%
edx
)

222 
movl
 %
—x
, -54(%
edx
)

223 
	$L
(
wr™e_25wÜds
):

224 
movl
 %
—x
, -50(%
edx
)

225 
movl
 %
—x
, -46(%
edx
)

226 
	$L
(
wr™e_21wÜds
):

227 
movl
 %
—x
, -42(%
edx
)

228 
movl
 %
—x
, -38(%
edx
)

229 
	$L
(
wr™e_17wÜds
):

230 
movl
 %
—x
, -34(%
edx
)

231 
movl
 %
—x
, -30(%
edx
)

232 
	$L
(
wr™e_13wÜds
):

233 
movl
 %
—x
, -26(%
edx
)

234 
movl
 %
—x
, -22(%
edx
)

235 
	$L
(
wr™e_9wÜds
):

236 
movl
 %
—x
, -18(%
edx
)

237 
movl
 %
—x
, -14(%
edx
)

238 
	$L
(
wr™e_5wÜds
):

239 
movl
 %
—x
, -10(%
edx
)

240 
movl
 %
—x
, -6(%
edx
)

241 
	$L
(
wr™e_1wÜds
):

242 
mov
 %
ax
, -2(%
edx
)

243 
SETRTNVAL


244 
RETURN


246 
	$ALIGN
 (4)

247 
	$L
(
wr™e_30wÜds
):

248 
movl
 %
—x
, -60(%
edx
)

249 
movl
 %
—x
, -56(%
edx
)

250 
	$L
(
wr™e_26wÜds
):

251 
movl
 %
—x
, -52(%
edx
)

252 
movl
 %
—x
, -48(%
edx
)

253 
	$L
(
wr™e_22wÜds
):

254 
movl
 %
—x
, -44(%
edx
)

255 
movl
 %
—x
, -40(%
edx
)

256 
	$L
(
wr™e_18wÜds
):

257 
movl
 %
—x
, -36(%
edx
)

258 
movl
 %
—x
, -32(%
edx
)

259 
	$L
(
wr™e_14wÜds
):

260 
movl
 %
—x
, -28(%
edx
)

261 
movl
 %
—x
, -24(%
edx
)

262 
	$L
(
wr™e_10wÜds
):

263 
movl
 %
—x
, -20(%
edx
)

264 
movl
 %
—x
, -16(%
edx
)

265 
	$L
(
wr™e_6wÜds
):

266 
movl
 %
—x
, -12(%
edx
)

267 
movl
 %
—x
, -8(%
edx
)

268 
	$L
(
wr™e_2wÜds
):

269 
movl
 %
—x
, -4(%
edx
)

270 
SETRTNVAL


271 
RETURN


273 
	$ALIGN
 (4)

274 
	$L
(
wr™e_31wÜds
):

275 
movl
 %
—x
, -62(%
edx
)

276 
movl
 %
—x
, -58(%
edx
)

277 
	$L
(
wr™e_27wÜds
):

278 
movl
 %
—x
, -54(%
edx
)

279 
movl
 %
—x
, -50(%
edx
)

280 
	$L
(
wr™e_23wÜds
):

281 
movl
 %
—x
, -46(%
edx
)

282 
movl
 %
—x
, -42(%
edx
)

283 
	$L
(
wr™e_19wÜds
):

284 
movl
 %
—x
, -38(%
edx
)

285 
movl
 %
—x
, -34(%
edx
)

286 
	$L
(
wr™e_15wÜds
):

287 
movl
 %
—x
, -30(%
edx
)

288 
movl
 %
—x
, -26(%
edx
)

289 
	$L
(
wr™e_11wÜds
):

290 
movl
 %
—x
, -22(%
edx
)

291 
movl
 %
—x
, -18(%
edx
)

292 
	$L
(
wr™e_7wÜds
):

293 
movl
 %
—x
, -14(%
edx
)

294 
movl
 %
—x
, -10(%
edx
)

295 
	$L
(
wr™e_3wÜds
):

296 
movl
 %
—x
, -6(%
edx
)

297 
movw
 %
ax
, -2(%
edx
)

298 
SETRTNVAL


299 
RETURN


301 
	$ALIGN
 (4)

303 
	$L
(32
wÜdsÜmÜe
):

304 
shl
 
$1
, %
ecx


305 
‹¡
 
$0x01
, %
edx


306 
jz
 
	$L
(
®igÃd2by‹s
)

307 
mov
 %
—x
, (%
edx
)

308 
mov
 %
—x
, -4(%
edx
, %
ecx
)

309 
sub
 
$2
, %
ecx


310 
add
 
$1
, %
edx


311 
rŞ
 
$8
, %
—x


312 
	$L
(
®igÃd2by‹s
):

313 #ifdeà
USE_AS_BZERO16


314 
pxÜ
 %
xmm0
, %xmm0

316 
movd
 %
—x
, %
xmm0


317 
pshufd
 
$0
, %
xmm0
, %xmm0

319 
‹¡l
 
$0xf
, %
edx


320 
jz
 
	$L
(
®igÃd_16
)

322 
	$L
(
nÙ_®igÃd_16
):

323 
movdqu
 %
xmm0
, (%
edx
)

324 
movl
 %
edx
, %
—x


325 
ªd
 
$
-16, %
edx


326 
add
 
$16
, %
edx


327 
sub
 %
edx
, %
—x


328 
add
 %
—x
, %
ecx


329 
movd
 %
xmm0
, %
—x


331 
	$ALIGN
 (4)

332 
	$L
(
®igÃd_16
):

333 
cmp
 
$128
, %
ecx


334 
j«
 
	$L
(128b
y‹sÜmÜe
)

336 
	$L
(
®igÃd_16_Ëss128by‹s
):

337 
add
 %
ecx
, %
edx


338 
shr
 
$1
, %
ecx


339 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

341 
	$ALIGN
 (4)

342 
	$L
(128b
y‹sÜmÜe
):

343 #ifdeà
SHARED_CACHE_SIZE


344 
	`PUSH
 (%
ebx
)

345 
mov
 
$SHARED_CACHE_SIZE
, %
ebx


347 #ifdeà
SHARED


348 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx


349 
add
 
$_GLOBAL_OFFSET_TABLE_
, %
ebx


350 
mov
 
__x86_sh¬ed_ÿche_size
@
	`GOTOFF
(%
ebx
), %ebx

352 
	`PUSH
 (%
ebx
)

353 
mov
 
__x86_sh¬ed_ÿche_size
, %
ebx


356 
cmp
 %
ebx
, %
ecx


357 
j«
 
	$L
(128b
y‹sÜmÜe_Á_¡¬t
)

360 #ifdeà
DATA_CACHE_SIZE


361 
	`POP
 (%
ebx
)

362 
	#RESTORE_EBX_STATE
 
	`CFI_PUSH
 (%
ebx
)

	)

363 
cmp
 
$DATA_CACHE_SIZE
, %
ecx


365 #ifdeà
SHARED


366 
	#RESTORE_EBX_STATE


	)

367 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx


368 
add
 
$_GLOBAL_OFFSET_TABLE_
, %
ebx


369 
cmp
 
__x86_d©a_ÿche_size
@
	`GOTOFF
(%
ebx
), %
ecx


371 
	`POP
 (%
ebx
)

372 
	#RESTORE_EBX_STATE
 
	`CFI_PUSH
 (%
ebx
)

	)

373 
cmp
 
__x86_d©a_ÿche_size
, %
ecx


377 
j«
 
	$L
(128b
y‹s_L2_nÜm®
)

378 
subl
 
$128
, %
ecx


379 
	$L
(128b
y‹sÜmÜe_nÜm®
):

380 
sub
 
$128
, %
ecx


381 
movdqa
 %
xmm0
, (%
edx
)

382 
movdqa
 %
xmm0
, 0x10(%
edx
)

383 
movdqa
 %
xmm0
, 0x20(%
edx
)

384 
movdqa
 %
xmm0
, 0x30(%
edx
)

385 
movdqa
 %
xmm0
, 0x40(%
edx
)

386 
movdqa
 %
xmm0
, 0x50(%
edx
)

387 
movdqa
 %
xmm0
, 0x60(%
edx
)

388 
movdqa
 %
xmm0
, 0x70(%
edx
)

389 
Ëa
 128(%
edx
), %edx

390 
jb
 
	$L
(128b
y‹¦ess_nÜm®
)

393 
sub
 
$128
, %
ecx


394 
movdqa
 %
xmm0
, (%
edx
)

395 
movdqa
 %
xmm0
, 0x10(%
edx
)

396 
movdqa
 %
xmm0
, 0x20(%
edx
)

397 
movdqa
 %
xmm0
, 0x30(%
edx
)

398 
movdqa
 %
xmm0
, 0x40(%
edx
)

399 
movdqa
 %
xmm0
, 0x50(%
edx
)

400 
movdqa
 %
xmm0
, 0x60(%
edx
)

401 
movdqa
 %
xmm0
, 0x70(%
edx
)

402 
Ëa
 128(%
edx
), %edx

403 
j«
 
	$L
(128b
y‹sÜmÜe_nÜm®
)

405 
	$L
(128b
y‹¦ess_nÜm®
):

406 
Ëa
 128(%
ecx
), %ecx

407 
add
 %
ecx
, %
edx


408 
shr
 
$1
, %
ecx


409 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

411 
	$ALIGN
 (4)

412 
	$L
(128b
y‹s_L2_nÜm®
):

413 
´eãtcht0
 0x380(%
edx
)

414 
´eãtcht0
 0x3c0(%
edx
)

415 
sub
 
$128
, %
ecx


416 
movdqa
 %
xmm0
, (%
edx
)

417 
mov­s
 %
xmm0
, 0x10(%
edx
)

418 
mov­s
 %
xmm0
, 0x20(%
edx
)

419 
mov­s
 %
xmm0
, 0x30(%
edx
)

420 
mov­s
 %
xmm0
, 0x40(%
edx
)

421 
mov­s
 %
xmm0
, 0x50(%
edx
)

422 
mov­s
 %
xmm0
, 0x60(%
edx
)

423 
mov­s
 %
xmm0
, 0x70(%
edx
)

424 
add
 
$128
, %
edx


425 
cmp
 
$128
, %
ecx


426 
j«
 
	$L
(128b
y‹s_L2_nÜm®
)

428 
	$L
(128b
y‹¦ess_L2_nÜm®
):

429 
add
 %
ecx
, %
edx


430 
shr
 
$1
, %
ecx


431 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

433 
RESTORE_EBX_STATE


434 
	$L
(128b
y‹sÜmÜe_Á_¡¬t
):

435 
sub
 %
ebx
, %
ecx


436 
mov
 %
ebx
, %
—x


437 
ªd
 
$0x7f
, %
—x


438 
add
 %
—x
, %
ecx


439 
movd
 %
xmm0
, %
—x


440 
	$ALIGN
 (4)

441 
	$L
(128b
y‹sÜmÜe_sh¬ed_ÿche_loİ
):

442 
´eãtcht0
 0x3c0(%
edx
)

443 
´eãtcht0
 0x380(%
edx
)

444 
sub
 
$0x80
, %
ebx


445 
movdqa
 %
xmm0
, (%
edx
)

446 
movdqa
 %
xmm0
, 0x10(%
edx
)

447 
movdqa
 %
xmm0
, 0x20(%
edx
)

448 
movdqa
 %
xmm0
, 0x30(%
edx
)

449 
movdqa
 %
xmm0
, 0x40(%
edx
)

450 
movdqa
 %
xmm0
, 0x50(%
edx
)

451 
movdqa
 %
xmm0
, 0x60(%
edx
)

452 
movdqa
 %
xmm0
, 0x70(%
edx
)

453 
add
 
$0x80
, %
edx


454 
cmp
 
$0x80
, %
ebx


455 
j«
 
	$L
(128b
y‹sÜmÜe_sh¬ed_ÿche_loİ
)

456 
cmp
 
$0x80
, %
ecx


457 
jb
 
	$L
(
sh¬ed_ÿche_loİ_’d
)

458 
	$ALIGN
 (4)

459 
	$L
(128b
y‹sÜmÜe_Á
):

460 
sub
 
$0x80
, %
ecx


461 
movÁdq
 %
xmm0
, (%
edx
)

462 
movÁdq
 %
xmm0
, 0x10(%
edx
)

463 
movÁdq
 %
xmm0
, 0x20(%
edx
)

464 
movÁdq
 %
xmm0
, 0x30(%
edx
)

465 
movÁdq
 %
xmm0
, 0x40(%
edx
)

466 
movÁdq
 %
xmm0
, 0x50(%
edx
)

467 
movÁdq
 %
xmm0
, 0x60(%
edx
)

468 
movÁdq
 %
xmm0
, 0x70(%
edx
)

469 
add
 
$0x80
, %
edx


470 
cmp
 
$0x80
, %
ecx


471 
j«
 
	$L
(128b
y‹sÜmÜe_Á
)

472 
sãnû


473 
	$L
(
sh¬ed_ÿche_loİ_’d
):

474 #ià
defšed
 
DATA_CACHE_SIZE
 || !defšed 
SHARED


475 
	`POP
 (%
ebx
)

477 
add
 %
ecx
, %
edx


478 
shr
 
$1
, %
ecx


479 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	`L
(
bË_16_128by‹s
))

482 .
push£ùiÚ
 .
rod©a
.
s£2
,"a",@
´ogb™s


483 
	$ALIGN
 (2)

484 
	$L
(
bË_16_128by‹s
):

485 .
	`JMPTBL
 (
	`L
(
®igÃd_16_0by‹s
), L(
bË_16_128by‹s
))

486 .
	`JMPTBL
 (
	`L
(
®igÃd_16_2by‹s
), L(
bË_16_128by‹s
))

487 .
	`JMPTBL
 (
	`L
(
®igÃd_16_4by‹s
), L(
bË_16_128by‹s
))

488 .
	`JMPTBL
 (
	`L
(
®igÃd_16_6by‹s
), L(
bË_16_128by‹s
))

489 .
	`JMPTBL
 (
	`L
(
®igÃd_16_8by‹s
), L(
bË_16_128by‹s
))

490 .
	`JMPTBL
 (
	`L
(
®igÃd_16_10by‹s
), L(
bË_16_128by‹s
))

491 .
	`JMPTBL
 (
	`L
(
®igÃd_16_12by‹s
), L(
bË_16_128by‹s
))

492 .
	`JMPTBL
 (
	`L
(
®igÃd_16_14by‹s
), L(
bË_16_128by‹s
))

493 .
	`JMPTBL
 (
	`L
(
®igÃd_16_16by‹s
), L(
bË_16_128by‹s
))

494 .
	`JMPTBL
 (
	`L
(
®igÃd_16_18by‹s
), L(
bË_16_128by‹s
))

495 .
	`JMPTBL
 (
	`L
(
®igÃd_16_20by‹s
), L(
bË_16_128by‹s
))

496 .
	`JMPTBL
 (
	`L
(
®igÃd_16_22by‹s
), L(
bË_16_128by‹s
))

497 .
	`JMPTBL
 (
	`L
(
®igÃd_16_24by‹s
), L(
bË_16_128by‹s
))

498 .
	`JMPTBL
 (
	`L
(
®igÃd_16_26by‹s
), L(
bË_16_128by‹s
))

499 .
	`JMPTBL
 (
	`L
(
®igÃd_16_28by‹s
), L(
bË_16_128by‹s
))

500 .
	`JMPTBL
 (
	`L
(
®igÃd_16_30by‹s
), L(
bË_16_128by‹s
))

501 .
	`JMPTBL
 (
	`L
(
®igÃd_16_32by‹s
), L(
bË_16_128by‹s
))

502 .
	`JMPTBL
 (
	`L
(
®igÃd_16_34by‹s
), L(
bË_16_128by‹s
))

503 .
	`JMPTBL
 (
	`L
(
®igÃd_16_36by‹s
), L(
bË_16_128by‹s
))

504 .
	`JMPTBL
 (
	`L
(
®igÃd_16_38by‹s
), L(
bË_16_128by‹s
))

505 .
	`JMPTBL
 (
	`L
(
®igÃd_16_40by‹s
), L(
bË_16_128by‹s
))

506 .
	`JMPTBL
 (
	`L
(
®igÃd_16_42by‹s
), L(
bË_16_128by‹s
))

507 .
	`JMPTBL
 (
	`L
(
®igÃd_16_44by‹s
), L(
bË_16_128by‹s
))

508 .
	`JMPTBL
 (
	`L
(
®igÃd_16_46by‹s
), L(
bË_16_128by‹s
))

509 .
	`JMPTBL
 (
	`L
(
®igÃd_16_48by‹s
), L(
bË_16_128by‹s
))

510 .
	`JMPTBL
 (
	`L
(
®igÃd_16_50by‹s
), L(
bË_16_128by‹s
))

511 .
	`JMPTBL
 (
	`L
(
®igÃd_16_52by‹s
), L(
bË_16_128by‹s
))

512 .
	`JMPTBL
 (
	`L
(
®igÃd_16_54by‹s
), L(
bË_16_128by‹s
))

513 .
	`JMPTBL
 (
	`L
(
®igÃd_16_56by‹s
), L(
bË_16_128by‹s
))

514 .
	`JMPTBL
 (
	`L
(
®igÃd_16_58by‹s
), L(
bË_16_128by‹s
))

515 .
	`JMPTBL
 (
	`L
(
®igÃd_16_60by‹s
), L(
bË_16_128by‹s
))

516 .
	`JMPTBL
 (
	`L
(
®igÃd_16_62by‹s
), L(
bË_16_128by‹s
))

517 .
	`JMPTBL
 (
	`L
(
®igÃd_16_64by‹s
), L(
bË_16_128by‹s
))

518 .
	`JMPTBL
 (
	`L
(
®igÃd_16_66by‹s
), L(
bË_16_128by‹s
))

519 .
	`JMPTBL
 (
	`L
(
®igÃd_16_68by‹s
), L(
bË_16_128by‹s
))

520 .
	`JMPTBL
 (
	`L
(
®igÃd_16_70by‹s
), L(
bË_16_128by‹s
))

521 .
	`JMPTBL
 (
	`L
(
®igÃd_16_72by‹s
), L(
bË_16_128by‹s
))

522 .
	`JMPTBL
 (
	`L
(
®igÃd_16_74by‹s
), L(
bË_16_128by‹s
))

523 .
	`JMPTBL
 (
	`L
(
®igÃd_16_76by‹s
), L(
bË_16_128by‹s
))

524 .
	`JMPTBL
 (
	`L
(
®igÃd_16_78by‹s
), L(
bË_16_128by‹s
))

525 .
	`JMPTBL
 (
	`L
(
®igÃd_16_80by‹s
), L(
bË_16_128by‹s
))

526 .
	`JMPTBL
 (
	`L
(
®igÃd_16_82by‹s
), L(
bË_16_128by‹s
))

527 .
	`JMPTBL
 (
	`L
(
®igÃd_16_84by‹s
), L(
bË_16_128by‹s
))

528 .
	`JMPTBL
 (
	`L
(
®igÃd_16_86by‹s
), L(
bË_16_128by‹s
))

529 .
	`JMPTBL
 (
	`L
(
®igÃd_16_88by‹s
), L(
bË_16_128by‹s
))

530 .
	`JMPTBL
 (
	`L
(
®igÃd_16_90by‹s
), L(
bË_16_128by‹s
))

531 .
	`JMPTBL
 (
	`L
(
®igÃd_16_92by‹s
), L(
bË_16_128by‹s
))

532 .
	`JMPTBL
 (
	`L
(
®igÃd_16_94by‹s
), L(
bË_16_128by‹s
))

533 .
	`JMPTBL
 (
	`L
(
®igÃd_16_96by‹s
), L(
bË_16_128by‹s
))

534 .
	`JMPTBL
 (
	`L
(
®igÃd_16_98by‹s
), L(
bË_16_128by‹s
))

535 .
	`JMPTBL
 (
	`L
(
®igÃd_16_100by‹s
), L(
bË_16_128by‹s
))

536 .
	`JMPTBL
 (
	`L
(
®igÃd_16_102by‹s
), L(
bË_16_128by‹s
))

537 .
	`JMPTBL
 (
	`L
(
®igÃd_16_104by‹s
), L(
bË_16_128by‹s
))

538 .
	`JMPTBL
 (
	`L
(
®igÃd_16_106by‹s
), L(
bË_16_128by‹s
))

539 .
	`JMPTBL
 (
	`L
(
®igÃd_16_108by‹s
), L(
bË_16_128by‹s
))

540 .
	`JMPTBL
 (
	`L
(
®igÃd_16_110by‹s
), L(
bË_16_128by‹s
))

541 .
	`JMPTBL
 (
	`L
(
®igÃd_16_112by‹s
), L(
bË_16_128by‹s
))

542 .
	`JMPTBL
 (
	`L
(
®igÃd_16_114by‹s
), L(
bË_16_128by‹s
))

543 .
	`JMPTBL
 (
	`L
(
®igÃd_16_116by‹s
), L(
bË_16_128by‹s
))

544 .
	`JMPTBL
 (
	`L
(
®igÃd_16_118by‹s
), L(
bË_16_128by‹s
))

545 .
	`JMPTBL
 (
	`L
(
®igÃd_16_120by‹s
), L(
bË_16_128by‹s
))

546 .
	`JMPTBL
 (
	`L
(
®igÃd_16_122by‹s
), L(
bË_16_128by‹s
))

547 .
	`JMPTBL
 (
	`L
(
®igÃd_16_124by‹s
), L(
bË_16_128by‹s
))

548 .
	`JMPTBL
 (
	`L
(
®igÃd_16_126by‹s
), L(
bË_16_128by‹s
))

549 .
pİ£ùiÚ


552 
	$ALIGN
 (4)

553 
	$L
(
®igÃd_16_112by‹s
):

554 
movdqa
 %
xmm0
, -112(%
edx
)

555 
	$L
(
®igÃd_16_96by‹s
):

556 
movdqa
 %
xmm0
, -96(%
edx
)

557 
	$L
(
®igÃd_16_80by‹s
):

558 
movdqa
 %
xmm0
, -80(%
edx
)

559 
	$L
(
®igÃd_16_64by‹s
):

560 
movdqa
 %
xmm0
, -64(%
edx
)

561 
	$L
(
®igÃd_16_48by‹s
):

562 
movdqa
 %
xmm0
, -48(%
edx
)

563 
	$L
(
®igÃd_16_32by‹s
):

564 
movdqa
 %
xmm0
, -32(%
edx
)

565 
	$L
(
®igÃd_16_16by‹s
):

566 
movdqa
 %
xmm0
, -16(%
edx
)

567 
	$L
(
®igÃd_16_0by‹s
):

568 
SETRTNVAL


569 
RETURN


572 
	$ALIGN
 (4)

573 
	$L
(
®igÃd_16_114by‹s
):

574 
movdqa
 %
xmm0
, -114(%
edx
)

575 
	$L
(
®igÃd_16_98by‹s
):

576 
movdqa
 %
xmm0
, -98(%
edx
)

577 
	$L
(
®igÃd_16_82by‹s
):

578 
movdqa
 %
xmm0
, -82(%
edx
)

579 
	$L
(
®igÃd_16_66by‹s
):

580 
movdqa
 %
xmm0
, -66(%
edx
)

581 
	$L
(
®igÃd_16_50by‹s
):

582 
movdqa
 %
xmm0
, -50(%
edx
)

583 
	$L
(
®igÃd_16_34by‹s
):

584 
movdqa
 %
xmm0
, -34(%
edx
)

585 
	$L
(
®igÃd_16_18by‹s
):

586 
movdqa
 %
xmm0
, -18(%
edx
)

587 
	$L
(
®igÃd_16_2by‹s
):

588 
movw
 %
ax
, -2(%
edx
)

589 
SETRTNVAL


590 
RETURN


592 
	$ALIGN
 (4)

593 
	$L
(
®igÃd_16_116by‹s
):

594 
movdqa
 %
xmm0
, -116(%
edx
)

595 
	$L
(
®igÃd_16_100by‹s
):

596 
movdqa
 %
xmm0
, -100(%
edx
)

597 
	$L
(
®igÃd_16_84by‹s
):

598 
movdqa
 %
xmm0
, -84(%
edx
)

599 
	$L
(
®igÃd_16_68by‹s
):

600 
movdqa
 %
xmm0
, -68(%
edx
)

601 
	$L
(
®igÃd_16_52by‹s
):

602 
movdqa
 %
xmm0
, -52(%
edx
)

603 
	$L
(
®igÃd_16_36by‹s
):

604 
movdqa
 %
xmm0
, -36(%
edx
)

605 
	$L
(
®igÃd_16_20by‹s
):

606 
movdqa
 %
xmm0
, -20(%
edx
)

607 
	$L
(
®igÃd_16_4by‹s
):

608 
movl
 %
—x
, -4(%
edx
)

609 
SETRTNVAL


610 
RETURN


613 
	$ALIGN
 (4)

614 
	$L
(
®igÃd_16_118by‹s
):

615 
movdqa
 %
xmm0
, -118(%
edx
)

616 
	$L
(
®igÃd_16_102by‹s
):

617 
movdqa
 %
xmm0
, -102(%
edx
)

618 
	$L
(
®igÃd_16_86by‹s
):

619 
movdqa
 %
xmm0
, -86(%
edx
)

620 
	$L
(
®igÃd_16_70by‹s
):

621 
movdqa
 %
xmm0
, -70(%
edx
)

622 
	$L
(
®igÃd_16_54by‹s
):

623 
movdqa
 %
xmm0
, -54(%
edx
)

624 
	$L
(
®igÃd_16_38by‹s
):

625 
movdqa
 %
xmm0
, -38(%
edx
)

626 
	$L
(
®igÃd_16_22by‹s
):

627 
movdqa
 %
xmm0
, -22(%
edx
)

628 
	$L
(
®igÃd_16_6by‹s
):

629 
movl
 %
—x
, -6(%
edx
)

630 
movw
 %
ax
, -2(%
edx
)

631 
SETRTNVAL


632 
RETURN


635 
	$ALIGN
 (4)

636 
	$L
(
®igÃd_16_120by‹s
):

637 
movdqa
 %
xmm0
, -120(%
edx
)

638 
	$L
(
®igÃd_16_104by‹s
):

639 
movdqa
 %
xmm0
, -104(%
edx
)

640 
	$L
(
®igÃd_16_88by‹s
):

641 
movdqa
 %
xmm0
, -88(%
edx
)

642 
	$L
(
®igÃd_16_72by‹s
):

643 
movdqa
 %
xmm0
, -72(%
edx
)

644 
	$L
(
®igÃd_16_56by‹s
):

645 
movdqa
 %
xmm0
, -56(%
edx
)

646 
	$L
(
®igÃd_16_40by‹s
):

647 
movdqa
 %
xmm0
, -40(%
edx
)

648 
	$L
(
®igÃd_16_24by‹s
):

649 
movdqa
 %
xmm0
, -24(%
edx
)

650 
	$L
(
®igÃd_16_8by‹s
):

651 
movq
 %
xmm0
, -8(%
edx
)

652 
SETRTNVAL


653 
RETURN


656 
	$ALIGN
 (4)

657 
	$L
(
®igÃd_16_122by‹s
):

658 
movdqa
 %
xmm0
, -122(%
edx
)

659 
	$L
(
®igÃd_16_106by‹s
):

660 
movdqa
 %
xmm0
, -106(%
edx
)

661 
	$L
(
®igÃd_16_90by‹s
):

662 
movdqa
 %
xmm0
, -90(%
edx
)

663 
	$L
(
®igÃd_16_74by‹s
):

664 
movdqa
 %
xmm0
, -74(%
edx
)

665 
	$L
(
®igÃd_16_58by‹s
):

666 
movdqa
 %
xmm0
, -58(%
edx
)

667 
	$L
(
®igÃd_16_42by‹s
):

668 
movdqa
 %
xmm0
, -42(%
edx
)

669 
	$L
(
®igÃd_16_26by‹s
):

670 
movdqa
 %
xmm0
, -26(%
edx
)

671 
	$L
(
®igÃd_16_10by‹s
):

672 
movq
 %
xmm0
, -10(%
edx
)

673 
movw
 %
ax
, -2(%
edx
)

674 
SETRTNVAL


675 
RETURN


678 
	$ALIGN
 (4)

679 
	$L
(
®igÃd_16_124by‹s
):

680 
movdqa
 %
xmm0
, -124(%
edx
)

681 
	$L
(
®igÃd_16_108by‹s
):

682 
movdqa
 %
xmm0
, -108(%
edx
)

683 
	$L
(
®igÃd_16_92by‹s
):

684 
movdqa
 %
xmm0
, -92(%
edx
)

685 
	$L
(
®igÃd_16_76by‹s
):

686 
movdqa
 %
xmm0
, -76(%
edx
)

687 
	$L
(
®igÃd_16_60by‹s
):

688 
movdqa
 %
xmm0
, -60(%
edx
)

689 
	$L
(
®igÃd_16_44by‹s
):

690 
movdqa
 %
xmm0
, -44(%
edx
)

691 
	$L
(
®igÃd_16_28by‹s
):

692 
movdqa
 %
xmm0
, -28(%
edx
)

693 
	$L
(
®igÃd_16_12by‹s
):

694 
movq
 %
xmm0
, -12(%
edx
)

695 
movl
 %
—x
, -4(%
edx
)

696 
SETRTNVAL


697 
RETURN


700 
	$ALIGN
 (4)

701 
	$L
(
®igÃd_16_126by‹s
):

702 
movdqa
 %
xmm0
, -126(%
edx
)

703 
	$L
(
®igÃd_16_110by‹s
):

704 
movdqa
 %
xmm0
, -110(%
edx
)

705 
	$L
(
®igÃd_16_94by‹s
):

706 
movdqa
 %
xmm0
, -94(%
edx
)

707 
	$L
(
®igÃd_16_78by‹s
):

708 
movdqa
 %
xmm0
, -78(%
edx
)

709 
	$L
(
®igÃd_16_62by‹s
):

710 
movdqa
 %
xmm0
, -62(%
edx
)

711 
	$L
(
®igÃd_16_46by‹s
):

712 
movdqa
 %
xmm0
, -46(%
edx
)

713 
	$L
(
®igÃd_16_30by‹s
):

714 
movdqa
 %
xmm0
, -30(%
edx
)

715 
	$L
(
®igÃd_16_14by‹s
):

716 
movq
 %
xmm0
, -14(%
edx
)

717 
movl
 %
—x
, -6(%
edx
)

718 
movw
 %
ax
, -2(%
edx
)

719 
SETRTNVAL


720 
RETURN


722 
	`END
 (
s£2_mem£t16_©om
)

	@libs/libcutils/arch-x86/sse2-memset32-atom.S

20 #iâdeà
L


21 
	#L
(
Ïb–
è.
L
##
	)
label

24 #iâdeà
ALIGN


25 
	#ALIGN
(
n
è.
p2®ign
 
	)
n

28 #iâdeà
cfi_¡¬roc


29 
	#cfi_¡¬roc
 .
cfi_¡¬roc


	)

32 #iâdeà
cfi_’d´oc


33 
	#cfi_’d´oc
 .
cfi_’d´oc


	)

36 #iâdeà
cfi_»l_off£t


37 
	#cfi_»l_off£t
(
»g
, 
off
è.
cfi_»l_off£t
„eg, 
	)
off

40 #iâdeà
cfi_»¡Üe


41 
	#cfi_»¡Üe
(
»g
è.
cfi_»¡Üe
 
	)
reg

44 #iâdeà
cfi_adju¡_cç_off£t


45 
	#cfi_adju¡_cç_off£t
(
off
è.
cfi_adju¡_cç_off£t
 
	)
off

48 #iâdeà
ENTRY


49 
	#ENTRY
(
Çme
) \

50 .
ty³
 
Çme
, @
funùiÚ
; \

51 .
globl
 
Çme
; \

52 .
p2®ign
 4; \

53 
Çme
: \

54 
cfi_¡¬roc


	)

57 #iâdeà
END


58 
	#END
(
Çme
) \

59 
cfi_’d´oc
; \

60 .
size
 
Çme
, .-
	)
name

63 
	#CFI_PUSH
(
REG
) \

64 
	`cfi_adju¡_cç_off£t
 (4); \

65 
	`cfi_»l_off£t
 (
REG
, 0)

	)

67 
	#CFI_POP
(
REG
) \

68 
	`cfi_adju¡_cç_off£t
 (-4); \

69 
	`cfi_»¡Üe
 (
REG
)

	)

71 
	#PUSH
(
REG
è
pushl
 REG; 
	`CFI_PUSH
 (REG)

	)

72 
	#POP
(
REG
è
pİl
 REG; 
	`CFI_POP
 (REG)

	)

74 #ifdeà
USE_AS_BZERO32


75 
	#DEST
 
PARMS


	)

76 
	#LEN
 
DEST
+4

	)

78 
	#DEST
 
PARMS


	)

79 
	#DWDS
 
DEST
+4

	)

80 
	#LEN
 
DWDS
+4

	)

83 #ifdeà
USE_AS_WMEMSET32


84 
	#SETRTNVAL
 
movl
 
	`DEST
(%
e¥
), %
—x


	)

86 
	#SETRTNVAL


	)

89 #ifdeà
SHARED


90 
	#ENTRANCE
 
	`PUSH
 (%
ebx
);

	)

91 
	#RETURN_END
 
	`POP
 (%
ebx
); 
»t


	)

92 
	#RETURN
 
RETURN_END
; 
	`CFI_PUSH
 (%
ebx
)

	)

93 
	#PARMS
 8

	)

94 
	#JMPTBL
(
I
, 
B
èI - 
	)
B

98 
	#BRANCH_TO_JMPTBL_ENTRY
(
TABLE
) \

100 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx
; \

102 
add
 
	`$
(
TABLE
 - .), %
ebx
; \

105 
	`add
 (%
ebx
,%
ecx
,4), %ebx; \

107 
jmp
 *%
ebx


	)

109 .
	g£ùiÚ
 .
	ggnu
.
	glškÚû
.
	gt
.
	g__i686
.
	gg‘_pc_thunk
.
	gbx
,"ax",@
	g´ogb™s


110 .
globl
 
	g__i686
.
	gg‘_pc_thunk
.
	gbx


111 .
hidd’
 
	g__i686
.
	gg‘_pc_thunk
.
bx


112 
ALIGN
 (4)

113 .
ty³
 
	g__i686
.
	gg‘_pc_thunk
.
	gbx
,@
funùiÚ


114 
	g__i686
.
	gg‘_pc_thunk
.
	gbx
:

115 
movl
 (%
e¥
), %
ebx


116 
	g»t


118 
	#ENTRANCE


	)

119 
	#RETURN_END
 
»t


	)

120 
	#RETURN
 
RETURN_END


	)

121 
	#PARMS
 4

	)

122 
	#JMPTBL
(
I
, 
B
è
	)
I

126 
	#BRANCH_TO_JMPTBL_ENTRY
(
TABLE
) \

127 
jmp
 *
	`TABLE
(,%
ecx
,4)

	)

130 .
	g£ùiÚ
 .
	g‹xt
.
	gs£2
,"ax",@
´ogb™s


131 
	$ALIGN
 (4)

132 
	$ENTRY
 (
s£2_mem£t32_©om
)

133 
ENTRANCE


135 
movl
 
	`LEN
(%
e¥
), %
ecx


136 #ifdeà
USE_AS_ANDROID


137 
shr
 
$2
, %
ecx


139 #ifdeà
USE_AS_BZERO32


140 
xÜ
 %
—x
, %eax

142 
mov
 
	`DWDS
(%
e¥
), %
—x


143 
mov
 %
—x
, %
edx


145 
movl
 
	`DEST
(%
e¥
), %
edx


146 
cmp
 
$16
, %
ecx


147 
j«
 
	$L
(16db
wÜdsÜmÜe
)

149 
	$L
(
wr™e_Ëss16dbwÜds
):

150 
	`Ëa
 (%
edx
, %
ecx
, 4), %edx

151 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	`L
(
bË_Ëss16dbwÜds
))

153 .
push£ùiÚ
 .
rod©a
.
s£2
,"a",@
´ogb™s


154 
	$ALIGN
 (2)

155 
	$L
(
bË_Ëss16dbwÜds
):

156 .
	`JMPTBL
 (
	`L
(
wr™e_0dbwÜds
), L(
bË_Ëss16dbwÜds
))

157 .
	`JMPTBL
 (
	`L
(
wr™e_1dbwÜds
), L(
bË_Ëss16dbwÜds
))

158 .
	`JMPTBL
 (
	`L
(
wr™e_2dbwÜds
), L(
bË_Ëss16dbwÜds
))

159 .
	`JMPTBL
 (
	`L
(
wr™e_3dbwÜds
), L(
bË_Ëss16dbwÜds
))

160 .
	`JMPTBL
 (
	`L
(
wr™e_4dbwÜds
), L(
bË_Ëss16dbwÜds
))

161 .
	`JMPTBL
 (
	`L
(
wr™e_5dbwÜds
), L(
bË_Ëss16dbwÜds
))

162 .
	`JMPTBL
 (
	`L
(
wr™e_6dbwÜds
), L(
bË_Ëss16dbwÜds
))

163 .
	`JMPTBL
 (
	`L
(
wr™e_7dbwÜds
), L(
bË_Ëss16dbwÜds
))

164 .
	`JMPTBL
 (
	`L
(
wr™e_8dbwÜds
), L(
bË_Ëss16dbwÜds
))

165 .
	`JMPTBL
 (
	`L
(
wr™e_9dbwÜds
), L(
bË_Ëss16dbwÜds
))

166 .
	`JMPTBL
 (
	`L
(
wr™e_10dbwÜds
), L(
bË_Ëss16dbwÜds
))

167 .
	`JMPTBL
 (
	`L
(
wr™e_11dbwÜds
), L(
bË_Ëss16dbwÜds
))

168 .
	`JMPTBL
 (
	`L
(
wr™e_12dbwÜds
), L(
bË_Ëss16dbwÜds
))

169 .
	`JMPTBL
 (
	`L
(
wr™e_13dbwÜds
), L(
bË_Ëss16dbwÜds
))

170 .
	`JMPTBL
 (
	`L
(
wr™e_14dbwÜds
), L(
bË_Ëss16dbwÜds
))

171 .
	`JMPTBL
 (
	`L
(
wr™e_15dbwÜds
), L(
bË_Ëss16dbwÜds
))

172 .
pİ£ùiÚ


174 
	$ALIGN
 (4)

175 
	$L
(
wr™e_15dbwÜds
):

176 
movl
 %
—x
, -60(%
edx
)

177 
	$L
(
wr™e_14dbwÜds
):

178 
movl
 %
—x
, -56(%
edx
)

179 
	$L
(
wr™e_13dbwÜds
):

180 
movl
 %
—x
, -52(%
edx
)

181 
	$L
(
wr™e_12dbwÜds
):

182 
movl
 %
—x
, -48(%
edx
)

183 
	$L
(
wr™e_11dbwÜds
):

184 
movl
 %
—x
, -44(%
edx
)

185 
	$L
(
wr™e_10dbwÜds
):

186 
movl
 %
—x
, -40(%
edx
)

187 
	$L
(
wr™e_9dbwÜds
):

188 
movl
 %
—x
, -36(%
edx
)

189 
	$L
(
wr™e_8dbwÜds
):

190 
movl
 %
—x
, -32(%
edx
)

191 
	$L
(
wr™e_7dbwÜds
):

192 
movl
 %
—x
, -28(%
edx
)

193 
	$L
(
wr™e_6dbwÜds
):

194 
movl
 %
—x
, -24(%
edx
)

195 
	$L
(
wr™e_5dbwÜds
):

196 
movl
 %
—x
, -20(%
edx
)

197 
	$L
(
wr™e_4dbwÜds
):

198 
movl
 %
—x
, -16(%
edx
)

199 
	$L
(
wr™e_3dbwÜds
):

200 
movl
 %
—x
, -12(%
edx
)

201 
	$L
(
wr™e_2dbwÜds
):

202 
movl
 %
—x
, -8(%
edx
)

203 
	$L
(
wr™e_1dbwÜds
):

204 
movl
 %
—x
, -4(%
edx
)

205 
	$L
(
wr™e_0dbwÜds
):

206 
SETRTNVAL


207 
RETURN


209 
	$ALIGN
 (4)

210 
	$L
(16db
wÜdsÜmÜe
):

211 
‹¡
 
$3
, %
edx


212 
jz
 
	$L
(
®igÃd4by‹s
)

213 
mov
 %
—x
, (%
edx
)

214 
mov
 %
—x
, -4(%
edx
, %
ecx
, 4)

215 
sub
 
$1
, %
ecx


216 
rŞ
 
$24
, %
—x


217 
add
 
$1
, %
edx


218 
‹¡
 
$3
, %
edx


219 
jz
 
	$L
(
®igÃd4by‹s
)

220 
rÜ
 
$8
, %
—x


221 
add
 
$1
, %
edx


222 
‹¡
 
$3
, %
edx


223 
jz
 
	$L
(
®igÃd4by‹s
)

224 
rÜ
 
$8
, %
—x


225 
add
 
$1
, %
edx


226 
	$L
(
®igÃd4by‹s
):

227 
shl
 
$2
, %
ecx


229 #ifdeà
USE_AS_BZERO32


230 
pxÜ
 %
xmm0
, %xmm0

232 
movd
 %
—x
, %
xmm0


233 
pshufd
 
$0
, %
xmm0
, %xmm0

235 
‹¡l
 
$0xf
, %
edx


236 
jz
 
	$L
(
®igÃd_16
)

238 
	$L
(
nÙ_®igÃd_16
):

239 
movdqu
 %
xmm0
, (%
edx
)

240 
movl
 %
edx
, %
—x


241 
ªd
 
$
-16, %
edx


242 
add
 
$16
, %
edx


243 
sub
 %
edx
, %
—x


244 
add
 %
—x
, %
ecx


245 
movd
 %
xmm0
, %
—x


246 
	$ALIGN
 (4)

247 
	$L
(
®igÃd_16
):

248 
cmp
 
$128
, %
ecx


249 
j«
 
	$L
(128b
y‹sÜmÜe
)

251 
	$L
(
®igÃd_16_Ëss128by‹s
):

252 
add
 %
ecx
, %
edx


253 
shr
 
$2
, %
ecx


254 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

256 
	$ALIGN
 (4)

257 
	$L
(128b
y‹sÜmÜe
):

258 #ifdeà
SHARED_CACHE_SIZE


259 
	`PUSH
 (%
ebx
)

260 
mov
 
$SHARED_CACHE_SIZE
, %
ebx


262 #ifdeà
SHARED


263 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx


264 
add
 
$_GLOBAL_OFFSET_TABLE_
, %
ebx


265 
mov
 
__x86_sh¬ed_ÿche_size
@
	`GOTOFF
(%
ebx
), %ebx

267 
	`PUSH
 (%
ebx
)

268 
mov
 
__x86_sh¬ed_ÿche_size
, %
ebx


271 
cmp
 %
ebx
, %
ecx


272 
j«
 
	$L
(128b
y‹sÜmÜe_Á_¡¬t
)

274 #ifdeà
DATA_CACHE_SIZE


275 
	`POP
 (%
ebx
)

276 
	#RESTORE_EBX_STATE
 
	`CFI_PUSH
 (%
ebx
)

	)

277 
cmp
 
$DATA_CACHE_SIZE
, %
ecx


279 #ifdeà
SHARED


280 
	#RESTORE_EBX_STATE


	)

281 
ÿÎ
 
__i686
.
g‘_pc_thunk
.
bx


282 
add
 
$_GLOBAL_OFFSET_TABLE_
, %
ebx


283 
cmp
 
__x86_d©a_ÿche_size
@
	`GOTOFF
(%
ebx
), %
ecx


285 
	`POP
 (%
ebx
)

286 
	#RESTORE_EBX_STATE
 
	`CFI_PUSH
 (%
ebx
)

	)

287 
cmp
 
__x86_d©a_ÿche_size
, %
ecx


291 
j«
 
	$L
(128b
y‹s_L2_nÜm®
)

292 
subl
 
$128
, %
ecx


293 
	$L
(128b
y‹sÜmÜe_nÜm®
):

294 
sub
 
$128
, %
ecx


295 
movdqa
 %
xmm0
, (%
edx
)

296 
movdqa
 %
xmm0
, 0x10(%
edx
)

297 
movdqa
 %
xmm0
, 0x20(%
edx
)

298 
movdqa
 %
xmm0
, 0x30(%
edx
)

299 
movdqa
 %
xmm0
, 0x40(%
edx
)

300 
movdqa
 %
xmm0
, 0x50(%
edx
)

301 
movdqa
 %
xmm0
, 0x60(%
edx
)

302 
movdqa
 %
xmm0
, 0x70(%
edx
)

303 
Ëa
 128(%
edx
), %edx

304 
jb
 
	$L
(128b
y‹¦ess_nÜm®
)

307 
sub
 
$128
, %
ecx


308 
movdqa
 %
xmm0
, (%
edx
)

309 
movdqa
 %
xmm0
, 0x10(%
edx
)

310 
movdqa
 %
xmm0
, 0x20(%
edx
)

311 
movdqa
 %
xmm0
, 0x30(%
edx
)

312 
movdqa
 %
xmm0
, 0x40(%
edx
)

313 
movdqa
 %
xmm0
, 0x50(%
edx
)

314 
movdqa
 %
xmm0
, 0x60(%
edx
)

315 
movdqa
 %
xmm0
, 0x70(%
edx
)

316 
Ëa
 128(%
edx
), %edx

317 
j«
 
	$L
(128b
y‹sÜmÜe_nÜm®
)

319 
	$L
(128b
y‹¦ess_nÜm®
):

320 
Ëa
 128(%
ecx
), %ecx

321 
add
 %
ecx
, %
edx


322 
shr
 
$2
, %
ecx


323 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

325 
	$ALIGN
 (4)

326 
	$L
(128b
y‹s_L2_nÜm®
):

327 
´eãtcht0
 0x380(%
edx
)

328 
´eãtcht0
 0x3c0(%
edx
)

329 
sub
 
$128
, %
ecx


330 
movdqa
 %
xmm0
, (%
edx
)

331 
mov­s
 %
xmm0
, 0x10(%
edx
)

332 
mov­s
 %
xmm0
, 0x20(%
edx
)

333 
mov­s
 %
xmm0
, 0x30(%
edx
)

334 
mov­s
 %
xmm0
, 0x40(%
edx
)

335 
mov­s
 %
xmm0
, 0x50(%
edx
)

336 
mov­s
 %
xmm0
, 0x60(%
edx
)

337 
mov­s
 %
xmm0
, 0x70(%
edx
)

338 
add
 
$128
, %
edx


339 
cmp
 
$128
, %
ecx


340 
j«
 
	$L
(128b
y‹s_L2_nÜm®
)

342 
	$L
(128b
y‹¦ess_L2_nÜm®
):

343 
add
 %
ecx
, %
edx


344 
shr
 
$2
, %
ecx


345 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	$L
(
bË_16_128by‹s
))

347 
RESTORE_EBX_STATE


348 
	$L
(128b
y‹sÜmÜe_Á_¡¬t
):

349 
sub
 %
ebx
, %
ecx


350 
mov
 %
ebx
, %
—x


351 
ªd
 
$0x7f
, %
—x


352 
add
 %
—x
, %
ecx


353 
movd
 %
xmm0
, %
—x


354 
	$ALIGN
 (4)

355 
	$L
(128b
y‹sÜmÜe_sh¬ed_ÿche_loİ
):

356 
´eãtcht0
 0x3c0(%
edx
)

357 
´eãtcht0
 0x380(%
edx
)

358 
sub
 
$0x80
, %
ebx


359 
movdqa
 %
xmm0
, (%
edx
)

360 
movdqa
 %
xmm0
, 0x10(%
edx
)

361 
movdqa
 %
xmm0
, 0x20(%
edx
)

362 
movdqa
 %
xmm0
, 0x30(%
edx
)

363 
movdqa
 %
xmm0
, 0x40(%
edx
)

364 
movdqa
 %
xmm0
, 0x50(%
edx
)

365 
movdqa
 %
xmm0
, 0x60(%
edx
)

366 
movdqa
 %
xmm0
, 0x70(%
edx
)

367 
add
 
$0x80
, %
edx


368 
cmp
 
$0x80
, %
ebx


369 
j«
 
	$L
(128b
y‹sÜmÜe_sh¬ed_ÿche_loİ
)

370 
cmp
 
$0x80
, %
ecx


371 
jb
 
	$L
(
sh¬ed_ÿche_loİ_’d
)

373 
	$ALIGN
 (4)

374 
	$L
(128b
y‹sÜmÜe_Á
):

375 
sub
 
$0x80
, %
ecx


376 
movÁdq
 %
xmm0
, (%
edx
)

377 
movÁdq
 %
xmm0
, 0x10(%
edx
)

378 
movÁdq
 %
xmm0
, 0x20(%
edx
)

379 
movÁdq
 %
xmm0
, 0x30(%
edx
)

380 
movÁdq
 %
xmm0
, 0x40(%
edx
)

381 
movÁdq
 %
xmm0
, 0x50(%
edx
)

382 
movÁdq
 %
xmm0
, 0x60(%
edx
)

383 
movÁdq
 %
xmm0
, 0x70(%
edx
)

384 
add
 
$0x80
, %
edx


385 
cmp
 
$0x80
, %
ecx


386 
j«
 
	$L
(128b
y‹sÜmÜe_Á
)

387 
sãnû


388 
	$L
(
sh¬ed_ÿche_loİ_’d
):

389 #ià
defšed
 
DATA_CACHE_SIZE
 || !defšed 
SHARED


390 
	`POP
 (%
ebx
)

392 
add
 %
ecx
, %
edx


393 
shr
 
$2
, %
ecx


394 
	`BRANCH_TO_JMPTBL_ENTRY
 (
	`L
(
bË_16_128by‹s
))

396 .
push£ùiÚ
 .
rod©a
.
s£2
,"a",@
´ogb™s


397 
	$ALIGN
 (2)

398 
	$L
(
bË_16_128by‹s
):

399 .
	`JMPTBL
 (
	`L
(
®igÃd_16_0by‹s
), L(
bË_16_128by‹s
))

400 .
	`JMPTBL
 (
	`L
(
®igÃd_16_4by‹s
), L(
bË_16_128by‹s
))

401 .
	`JMPTBL
 (
	`L
(
®igÃd_16_8by‹s
), L(
bË_16_128by‹s
))

402 .
	`JMPTBL
 (
	`L
(
®igÃd_16_12by‹s
), L(
bË_16_128by‹s
))

403 .
	`JMPTBL
 (
	`L
(
®igÃd_16_16by‹s
), L(
bË_16_128by‹s
))

404 .
	`JMPTBL
 (
	`L
(
®igÃd_16_20by‹s
), L(
bË_16_128by‹s
))

405 .
	`JMPTBL
 (
	`L
(
®igÃd_16_24by‹s
), L(
bË_16_128by‹s
))

406 .
	`JMPTBL
 (
	`L
(
®igÃd_16_28by‹s
), L(
bË_16_128by‹s
))

407 .
	`JMPTBL
 (
	`L
(
®igÃd_16_32by‹s
), L(
bË_16_128by‹s
))

408 .
	`JMPTBL
 (
	`L
(
®igÃd_16_36by‹s
), L(
bË_16_128by‹s
))

409 .
	`JMPTBL
 (
	`L
(
®igÃd_16_40by‹s
), L(
bË_16_128by‹s
))

410 .
	`JMPTBL
 (
	`L
(
®igÃd_16_44by‹s
), L(
bË_16_128by‹s
))

411 .
	`JMPTBL
 (
	`L
(
®igÃd_16_48by‹s
), L(
bË_16_128by‹s
))

412 .
	`JMPTBL
 (
	`L
(
®igÃd_16_52by‹s
), L(
bË_16_128by‹s
))

413 .
	`JMPTBL
 (
	`L
(
®igÃd_16_56by‹s
), L(
bË_16_128by‹s
))

414 .
	`JMPTBL
 (
	`L
(
®igÃd_16_60by‹s
), L(
bË_16_128by‹s
))

415 .
	`JMPTBL
 (
	`L
(
®igÃd_16_64by‹s
), L(
bË_16_128by‹s
))

416 .
	`JMPTBL
 (
	`L
(
®igÃd_16_68by‹s
), L(
bË_16_128by‹s
))

417 .
	`JMPTBL
 (
	`L
(
®igÃd_16_72by‹s
), L(
bË_16_128by‹s
))

418 .
	`JMPTBL
 (
	`L
(
®igÃd_16_76by‹s
), L(
bË_16_128by‹s
))

419 .
	`JMPTBL
 (
	`L
(
®igÃd_16_80by‹s
), L(
bË_16_128by‹s
))

420 .
	`JMPTBL
 (
	`L
(
®igÃd_16_84by‹s
), L(
bË_16_128by‹s
))

421 .
	`JMPTBL
 (
	`L
(
®igÃd_16_88by‹s
), L(
bË_16_128by‹s
))

422 .
	`JMPTBL
 (
	`L
(
®igÃd_16_92by‹s
), L(
bË_16_128by‹s
))

423 .
	`JMPTBL
 (
	`L
(
®igÃd_16_96by‹s
), L(
bË_16_128by‹s
))

424 .
	`JMPTBL
 (
	`L
(
®igÃd_16_100by‹s
), L(
bË_16_128by‹s
))

425 .
	`JMPTBL
 (
	`L
(
®igÃd_16_104by‹s
), L(
bË_16_128by‹s
))

426 .
	`JMPTBL
 (
	`L
(
®igÃd_16_108by‹s
), L(
bË_16_128by‹s
))

427 .
	`JMPTBL
 (
	`L
(
®igÃd_16_112by‹s
), L(
bË_16_128by‹s
))

428 .
	`JMPTBL
 (
	`L
(
®igÃd_16_116by‹s
), L(
bË_16_128by‹s
))

429 .
	`JMPTBL
 (
	`L
(
®igÃd_16_120by‹s
), L(
bË_16_128by‹s
))

430 .
	`JMPTBL
 (
	`L
(
®igÃd_16_124by‹s
), L(
bË_16_128by‹s
))

431 .
pİ£ùiÚ


433 
	$ALIGN
 (4)

434 
	$L
(
®igÃd_16_112by‹s
):

435 
movdqa
 %
xmm0
, -112(%
edx
)

436 
	$L
(
®igÃd_16_96by‹s
):

437 
movdqa
 %
xmm0
, -96(%
edx
)

438 
	$L
(
®igÃd_16_80by‹s
):

439 
movdqa
 %
xmm0
, -80(%
edx
)

440 
	$L
(
®igÃd_16_64by‹s
):

441 
movdqa
 %
xmm0
, -64(%
edx
)

442 
	$L
(
®igÃd_16_48by‹s
):

443 
movdqa
 %
xmm0
, -48(%
edx
)

444 
	$L
(
®igÃd_16_32by‹s
):

445 
movdqa
 %
xmm0
, -32(%
edx
)

446 
	$L
(
®igÃd_16_16by‹s
):

447 
movdqa
 %
xmm0
, -16(%
edx
)

448 
	$L
(
®igÃd_16_0by‹s
):

449 
SETRTNVAL


450 
RETURN


452 
	$ALIGN
 (4)

453 
	$L
(
®igÃd_16_116by‹s
):

454 
movdqa
 %
xmm0
, -116(%
edx
)

455 
	$L
(
®igÃd_16_100by‹s
):

456 
movdqa
 %
xmm0
, -100(%
edx
)

457 
	$L
(
®igÃd_16_84by‹s
):

458 
movdqa
 %
xmm0
, -84(%
edx
)

459 
	$L
(
®igÃd_16_68by‹s
):

460 
movdqa
 %
xmm0
, -68(%
edx
)

461 
	$L
(
®igÃd_16_52by‹s
):

462 
movdqa
 %
xmm0
, -52(%
edx
)

463 
	$L
(
®igÃd_16_36by‹s
):

464 
movdqa
 %
xmm0
, -36(%
edx
)

465 
	$L
(
®igÃd_16_20by‹s
):

466 
movdqa
 %
xmm0
, -20(%
edx
)

467 
	$L
(
®igÃd_16_4by‹s
):

468 
movl
 %
—x
, -4(%
edx
)

469 
SETRTNVAL


470 
RETURN


472 
	$ALIGN
 (4)

473 
	$L
(
®igÃd_16_120by‹s
):

474 
movdqa
 %
xmm0
, -120(%
edx
)

475 
	$L
(
®igÃd_16_104by‹s
):

476 
movdqa
 %
xmm0
, -104(%
edx
)

477 
	$L
(
®igÃd_16_88by‹s
):

478 
movdqa
 %
xmm0
, -88(%
edx
)

479 
	$L
(
®igÃd_16_72by‹s
):

480 
movdqa
 %
xmm0
, -72(%
edx
)

481 
	$L
(
®igÃd_16_56by‹s
):

482 
movdqa
 %
xmm0
, -56(%
edx
)

483 
	$L
(
®igÃd_16_40by‹s
):

484 
movdqa
 %
xmm0
, -40(%
edx
)

485 
	$L
(
®igÃd_16_24by‹s
):

486 
movdqa
 %
xmm0
, -24(%
edx
)

487 
	$L
(
®igÃd_16_8by‹s
):

488 
movq
 %
xmm0
, -8(%
edx
)

489 
SETRTNVAL


490 
RETURN


492 
	$ALIGN
 (4)

493 
	$L
(
®igÃd_16_124by‹s
):

494 
movdqa
 %
xmm0
, -124(%
edx
)

495 
	$L
(
®igÃd_16_108by‹s
):

496 
movdqa
 %
xmm0
, -108(%
edx
)

497 
	$L
(
®igÃd_16_92by‹s
):

498 
movdqa
 %
xmm0
, -92(%
edx
)

499 
	$L
(
®igÃd_16_76by‹s
):

500 
movdqa
 %
xmm0
, -76(%
edx
)

501 
	$L
(
®igÃd_16_60by‹s
):

502 
movdqa
 %
xmm0
, -60(%
edx
)

503 
	$L
(
®igÃd_16_44by‹s
):

504 
movdqa
 %
xmm0
, -44(%
edx
)

505 
	$L
(
®igÃd_16_28by‹s
):

506 
movdqa
 %
xmm0
, -28(%
edx
)

507 
	$L
(
®igÃd_16_12by‹s
):

508 
movq
 %
xmm0
, -12(%
edx
)

509 
movl
 %
—x
, -4(%
edx
)

510 
SETRTNVAL


511 
RETURN


513 
	`END
 (
s£2_mem£t32_©om
)

	@libs/libcutils/array.c

17 
	~<cuts/¬¿y.h
>

18 
	~<as£¹.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

21 
	~<lim™s.h
>

23 
	#INITIAL_CAPACITY
 (4)

	)

24 
	#MAX_CAPACITY
 (()(
UINT_MAX
/(*)))

	)

26 
	sA¼ay
 {

27 ** 
	mcÚ‹Ás
;

28 
	msize
;

29 
	mÿ·c™y
;

32 
A¼ay
* 
	$¬¿yC»©e
() {

33  
	`ÿÎoc
(1, (
A¼ay
));

34 
	}
}

36 
	$¬¿yF»e
(
A¼ay
* 
¬¿y
) {

37 
	`as£¹
(
¬¿y
 !ğ
NULL
);

40 
	`ä“
(
¬¿y
->
cÚ‹Ás
);

43 
	`ä“
(
¬¿y
);

44 
	}
}

47 
	$’su»C­ac™y
(
A¼ay
* 
¬¿y
, 
ÿ·c™y
) {

48 
ŞdC­ac™y
 = 
¬¿y
->
ÿ·c™y
;

49 ià(
ÿ·c™y
 > 
ŞdC­ac™y
) {

50 
ÃwC­ac™y
 = (
ŞdC­ac™y
 =ğ0è? 
INITIAL_CAPACITY
 : oldCapacity;

53 ià(
ÿ·c™y
 > 
MAX_CAPACITY
)

57 
ÃwC­ac™y
 < 
ÿ·c™y
) {

58 
ÃwC­
 = 
ÃwC­ac™y
*2;

60 ià(
ÃwC­
 < 
ÃwC­ac™y
 ||‚ewC­ > 
MAX_CAPACITY
) {

61 
ÃwC­
 = 
MAX_CAPACITY
;

63 
ÃwC­ac™y
 = 
ÃwC­
;

67 ià(
ÃwC­ac™y
 < 0 ||‚ewC­ac™y > 
MAX_CAPACITY
)

70 ** 
ÃwCÚ‹Ás
;

71 ià(
¬¿y
->
cÚ‹Ás
 =ğ
NULL
) {

73 
ÃwCÚ‹Ás
 = 
	`m®loc
(
ÃwC­ac™y
 * (*));

74 ià(
ÃwCÚ‹Ás
 =ğ
NULL
) {

79 
ÃwCÚ‹Ás
 = 
	`»®loc
(
¬¿y
->
cÚ‹Ás
, (*è* 
ÃwC­ac™y
);

80 ià(
ÃwCÚ‹Ás
 =ğ
NULL
) {

85 
¬¿y
->
ÿ·c™y
 = 
ÃwC­ac™y
;

86 
¬¿y
->
cÚ‹Ás
 = 
ÃwCÚ‹Ás
;

90 
	}
}

92 
	$¬¿yAdd
(
A¼ay
* 
¬¿y
, * 
poš‹r
) {

93 
	`as£¹
(
¬¿y
 !ğ
NULL
);

94 
size
 = 
¬¿y
->size;

95 
»suÉ
 = 
	`’su»C­ac™y
(
¬¿y
, 
size
 + 1);

96 ià(
»suÉ
 < 0) {

97  
»suÉ
;

99 
¬¿y
->
cÚ‹Ás
[
size
] = 
poš‹r
;

100 
¬¿y
->
size
++;

102 
	}
}

104 
šlše
 
	$checkBounds
(
A¼ay
* 
¬¿y
, 
šdex
) {

105 
	`as£¹
(
¬¿y
 !ğ
NULL
);

106 
	`as£¹
(
šdex
 < 
¬¿y
->
size
);

107 
	`as£¹
(
šdex
 >= 0);

108 
	}
}

110 * 
	$¬¿yG‘
(
A¼ay
* 
¬¿y
, 
šdex
) {

111 
	`checkBounds
(
¬¿y
, 
šdex
);

112  
¬¿y
->
cÚ‹Ás
[
šdex
];

113 
	}
}

115 * 
	$¬¿yRemove
(
A¼ay
* 
¬¿y
, 
šdex
) {

116 
	`checkBounds
(
¬¿y
, 
šdex
);

118 * 
poš‹r
 = 
¬¿y
->
cÚ‹Ás
[
šdex
];

120 
ÃwSize
 = 
¬¿y
->
size
 - 1;

123 ià(
šdex
 !ğ
ÃwSize
) {

124 
	`memmove
(
¬¿y
->
cÚ‹Ás
 + 
šdex
,‡rray->contents + index + 1,

125 ((*)è* (
ÃwSize
 - 
šdex
));

128 
¬¿y
->
size
 = 
ÃwSize
;

130  
poš‹r
;

131 
	}
}

133 * 
	$¬¿yS‘
(
A¼ay
* 
¬¿y
, 
šdex
, * 
poš‹r
) {

134 
	`checkBounds
(
¬¿y
, 
šdex
);

135 * 
Şd
 = 
¬¿y
->
cÚ‹Ás
[
šdex
];

136 
¬¿y
->
cÚ‹Ás
[
šdex
] = 
poš‹r
;

137  
Şd
;

138 
	}
}

140 
	$¬¿yS‘Size
(
A¼ay
* 
¬¿y
, 
ÃwSize
) {

141 
	`as£¹
(
¬¿y
 !ğ
NULL
);

142 
	`as£¹
(
ÃwSize
 >= 0);

144 
ŞdSize
 = 
¬¿y
->
size
;

146 ià(
ÃwSize
 > 
ŞdSize
) {

148 
»suÉ
 = 
	`’su»C­ac™y
(
¬¿y
, 
ÃwSize
);

149 ià(
»suÉ
 < 0) {

150  
»suÉ
;

154 
	`mem£t
(
¬¿y
->
cÚ‹Ás
 + (*è* 
ŞdSize
, 0,

155 (*è* (
ÃwSize
 - 
ŞdSize
));

158 
¬¿y
->
size
 = 
ÃwSize
;

161 
	}
}

163 
	$¬¿ySize
(
A¼ay
* 
¬¿y
) {

164 
	`as£¹
(
¬¿y
 !ğ
NULL
);

165  
¬¿y
->
size
;

166 
	}
}

168 cÚ¡ ** 
	$¬¿yUnw¿p
(
A¼ay
* 
¬¿y
) {

169  (cÚ¡ **)
¬¿y
->
cÚ‹Ás
;

170 
	}
}

	@libs/libcutils/ashmem-dev.c

23 
	~<uni¡d.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/ty³s.h
>

26 
	~<sys/¡©.h
>

27 
	~<sys/ioùl.h
>

28 
	~<fú.h
>

31 
	~<ashmem.h
>

33 
	~<cuts/ashmem.h
>

35 
	#ASHMEM_DEVICE
 "/dev/ashmem"

	)

44 
	$ashmem_ü—‹_»giÚ
(cÚ¡ *
Çme
, 
size_t
 
size
)

46 
fd
, 
»t
;

48 
fd
 = 
	`İ’
(
ASHMEM_DEVICE
, 
O_RDWR
);

49 ià(
fd
 < 0)

50  
fd
;

52 ià(
Çme
) {

53 
buf
[
ASHMEM_NAME_LEN
];

55 
	`¡¾ıy
(
buf
, 
Çme
, (buf));

56 
»t
 = 
	`ioùl
(
fd
, 
ASHMEM_SET_NAME
, 
buf
);

57 ià(
»t
 < 0)

58 
”rÜ
;

61 
»t
 = 
	`ioùl
(
fd
, 
ASHMEM_SET_SIZE
, 
size
);

62 ià(
»t
 < 0)

63 
”rÜ
;

65  
fd
;

67 
”rÜ
:

68 
	`şo£
(
fd
);

69  
»t
;

70 
	}
}

72 
	$ashmem_£t_´Ù_»giÚ
(
fd
, 
´Ù
)

74  
	`ioùl
(
fd
, 
ASHMEM_SET_PROT_MASK
, 
´Ù
);

75 
	}
}

77 
	$ashmem_pš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
)

79 
ashmem_pš
 
pš
 = { 
off£t
, 
Ën
 };

80  
	`ioùl
(
fd
, 
ASHMEM_PIN
, &
pš
);

81 
	}
}

83 
	$ashmem_uÅš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
)

85 
ashmem_pš
 
pš
 = { 
off£t
, 
Ën
 };

86  
	`ioùl
(
fd
, 
ASHMEM_UNPIN
, &
pš
);

87 
	}
}

89 
	$ashmem_g‘_size_»giÚ
(
fd
)

91  
	`ioùl
(
fd
, 
ASHMEM_GET_SIZE
, 
NULL
);

92 
	}
}

	@libs/libcutils/ashmem-host.c

22 
	~<uni¡d.h
>

23 
	~<¡ršg.h
>

24 
	~<¡dlib.h
>

25 
	~<sys/ty³s.h
>

26 
	~<sys/¡©.h
>

27 
	~<fú.h
>

28 
	~<¡dio.h
>

29 
	~<”ºo.h
>

30 
	~<time.h
>

31 
	~<lim™s.h
>

33 
	~<cuts/ashmem.h
>

35 
	$ashmem_ü—‹_»giÚ
(cÚ¡ *
ignÜed
, 
size_t
 
size
)

37 cÚ¡ 
txt
[] = "abcdefghijklmnopqrstuvwxyz"

39 
Çme
[64];

40 
»Œ›s
 = 0;

41 
pid_t
 
pid
 = 
	`g‘pid
();

42 
fd
;

44 
	`¤ªd
(
	`time
(
NULL
è+ 
pid
);

46 
»Œy
:

48 
	`¢´štf
(
Çme
, (name), "/tmp/android-ashmem-%d-%c%c%c%c%c%c%c%c",

49 
pid
,

50 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

51 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

52 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

53 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

54 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

55 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

56 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))],

57 
txt
[(è((Ñxtè- 1è* (
	`¿nd
(è/ (
RAND_MAX
 + 1.0)))]);

60 
fd
 = 
	`İ’
(
Çme
, 
O_RDWR
 | 
O_CREAT
 | 
O_EXCL
, 0600);

61 ià(
fd
 == -1) {

63 ià(
”ºo
 =ğ
EEXIST
 && ++
»Œ›s
 < 6)

64 
»Œy
;

69 ià(
	`árunÿ‹
(
fd
, 
size
) == -1)

70 
”rÜ
;

72 ià(
	`uÆšk
(
Çme
) == -1)

73 
”rÜ
;

75  
fd
;

76 
”rÜ
:

77 
	`şo£
(
fd
);

79 
	}
}

81 
	$ashmem_£t_´Ù_»giÚ
(
fd
, 
´Ù
)

84 
	}
}

86 
	$ashmem_pš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
)

88  
ASHMEM_NOT_PURGED
;

89 
	}
}

91 
	$ashmem_uÅš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
)

93  
ASHMEM_IS_UNPINNED
;

94 
	}
}

96 
	$ashmem_g‘_size_»giÚ
(
fd
)

98 
¡©
 
buf
;

99 
»suÉ
;

101 
»suÉ
 = 
	`f¡©
(
fd
, &
buf
);

102 ià(
»suÉ
 == -1) {

108 ià(!(
buf
.
¡_Æšk
 =ğ0 && 
	`S_ISREG
(buf.
¡_mode
))) {

109 
”ºo
 = 
ENOTTY
;

113  ()
buf
.
¡_size
;

114 
	}
}

	@libs/libcutils/atomic.c

17 
	#šlše


	)

19 
	~<cuts/©omic-šlše.h
>

	@libs/libcutils/buffer.c

17 
	#LOG_TAG
 "bufãr"

	)

19 
	~<as£¹.h
>

20 
	~<”ºo.h
>

21 
	~<¡dlib.h
>

22 
	~<uni¡d.h
>

24 
	~"bufãr.h
"

25 
	~"loghack.h
"

27 
Bufãr
* 
	$bufãrC»©e
(
size_t
 
ÿ·c™y
) {

28 
Bufãr
* 
bufãr
 = 
	`m®loc
((Buffer));

29 ià(
bufãr
 =ğ
NULL
) {

30  
NULL
;

32 
bufãr
->
ÿ·c™y
 = capacity;

33 
bufãr
->
ex³ùed
 = 0;

34 
bufãr
->
d©a
 = 
	`m®loc
(
ÿ·c™y
);

35 ià(
bufãr
->
d©a
 =ğ
NULL
) {

36 
	`ä“
(
bufãr
);

37  
NULL
;

39  
bufãr
;

40 
	}
}

42 
	$bufãrF»e
(
Bufãr
* 
bufãr
) {

43 
	`ä“
(
bufãr
->
d©a
);

44 
	`ä“
(
bufãr
);

45 
	}
}

47 
Bufãr
* 
	$bufãrW¿p
(* 
d©a
, 
size_t
 
ÿ·c™y
, size_ˆ
size
) {

48 
Bufãr
* 
bufãr
 = 
	`m®loc
((Buffer));

49 ià(
bufãr
 =ğ
NULL
) {

50  
NULL
;

53 
bufãr
->
d©a
 = data;

54 
bufãr
->
ÿ·c™y
 = capacity;

55 
bufãr
->
size
 = size;

56 
bufãr
->
ex³ùed
 = 0;

57  
bufãr
;

58 
	}
}

60 
	$bufãrP»·»FÜR—d
(
Bufãr
* 
bufãr
, 
size_t
 
ex³ùed
) {

61 ià(
ex³ùed
 > 
bufãr
->
ÿ·c™y
) {

63 * 
ex·nded
 = 
	`»®loc
(
bufãr
->
d©a
, 
ex³ùed
);

64 ià(
ex·nded
 =ğ
NULL
) {

65 
”ºo
 = 
ENOMEM
;

68 
bufãr
->
ÿ·c™y
 = 
ex³ùed
;

69 
bufãr
->
d©a
 = 
ex·nded
;

72 
bufãr
->
size
 = 0;

73 
bufãr
->
ex³ùed
 =ƒxpected;

75 
	}
}

77 
ssize_t
 
	$bufãrR—d
(
Bufãr
* 
bufãr
, 
fd
) {

78 
	`as£¹
(
bufãr
->
size
 < bufãr->
ex³ùed
);

80 
ssize_t
 
by‹sR—d
 = 
	`»ad
(
fd
,

81 
bufãr
->
d©a
 + bufãr->
size
,

82 
bufãr
->
ex³ùed
 - bufãr->
size
);

84 ià(
by‹sR—d
 > 0) {

85 
bufãr
->
size
 +ğ
by‹sR—d
;

86  
bufãr
->
size
;

89  
by‹sR—d
;

90 
	}
}

92 
	$bufãrP»·»FÜWr™e
(
Bufãr
* 
bufãr
) {

93 
bufãr
->
»maššg
 = bufãr->
size
;

94 
	}
}

96 
ssize_t
 
	$bufãrWr™e
(
Bufãr
* 
bufãr
, 
fd
) {

97 
	`as£¹
(
bufãr
->
»maššg
 > 0);

98 
	`as£¹
(
bufãr
->
»maššg
 <ğbufãr->
size
);

100 
ssize_t
 
by‹sWr™‹n
 = 
	`wr™e
(
fd
,

101 
bufãr
->
d©a
 + bufãr->
size
 - bufãr->
»maššg
,

102 
bufãr
->
»maššg
);

104 ià(
by‹sWr™‹n
 >= 0) {

105 
bufãr
->
»maššg
 -ğ
by‹sWr™‹n
;

107 
	`ALOGD
("Bufã¸by‹ wr™‹n: %d", (è
by‹sWr™‹n
);

108 
	`ALOGD
("Bufã¸size: %d", (è
bufãr
->
size
);

109 
	`ALOGD
("Bufã¸»maššg: %d", (è
bufãr
->
»maššg
);

111  
bufãr
->
»maššg
;

114  
by‹sWr™‹n
;

115 
	}
}

	@libs/libcutils/buffer.h

21 #iâdeà
__BUFFER_H


22 
	#__BUFFER_H


	)

24 #ifdeà
__ılu¥lus


28 
	~<¡dlib.h
>

36 * 
d©a
;

40 
size_t
 
ex³ùed
;

43 
size_t
 
»maššg
;

47 
size_t
 
size
;

50 
size_t
 
ÿ·c™y
;

51 } 
	tBufãr
;

56 
	#bufãrR—dCom¶‘e
(
bufãr
è(bufãr->
ex³ùed
 =ğbufãr->
size
)

	)

61 
	#bufãrWr™eCom¶‘e
(
bufãr
è(bufãr->
»maššg
 =ğ0)

	)

66 
Bufãr
* 
bufãrC»©e
(
size_t
 
š™ŸlC­ac™y
);

71 
Bufãr
* 
bufãrW¿p
(* 
d©a
, 
size_t
 
ÿ·c™y
, size_ˆ
size
);

76 
bufãrF»e
(
Bufãr
* 
bufãr
);

83 
bufãrP»·»FÜR—d
(
Bufãr
* 
bufãr
, 
size_t
 
ex³ùed
);

92 
ssize_t
 
bufãrR—d
(
Bufãr
* 
bufãr
, 
fd
);

97 
bufãrP»·»FÜWr™e
(
Bufãr
* 
bufãr
);

106 
ssize_t
 
bufãrWr™e
(
Bufãr
* 
bufãr
, 
fd
);

108 #ifdeà
__ılu¥lus


	@libs/libcutils/config_utils.c

17 
	~<¡ršg.h
>

18 
	~<ùy³.h
>

19 
	~<¡dlib.h
>

20 
	~<fú.h
>

21 
	~<uni¡d.h
>

23 
	~<cuts/cÚfig_uts.h
>

24 
	~<cuts/misc.h
>

26 
úode
* 
	$cÚfig_node
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

28 
úode
 *
node
;

30 
node
 = 
	`ÿÎoc
((
úode
), 1);

31 if(
node
) {

32 
node
->
Çme
 =‚ame ?‚ame : "";

33 
node
->
v®ue
 = value ? value : "";

36  
node
;

37 
	}
}

39 
úode
* 
	$cÚfig_fšd
(
úode
 *
roÙ
, cÚ¡ *
Çme
)

41 
úode
 *
node
, *
m©ch
 = 
NULL
;

44 
node
 = 
roÙ
->
fœ¡_chd
;‚ode;‚odğnode->
Ãxt
)

45 if(!
	`¡rcmp
(
node
->
Çme
,‚ame))

46 
m©ch
 = 
node
;

48  
m©ch
;

49 
	}
}

51 
úode
* 
	$_cÚfig_ü—‹
(
úode
 *
roÙ
, cÚ¡ *
Çme
)

53 
úode
 *
node
;

55 
node
 = 
	`cÚfig_node
(
Çme
, 
NULL
);

57 if(
roÙ
->
Ï¡_chd
)

58 
roÙ
->
Ï¡_chd
->
Ãxt
 = 
node
;

60 
roÙ
->
fœ¡_chd
 = 
node
;

62 
roÙ
->
Ï¡_chd
 = 
node
;

64  
node
;

65 
	}
}

67 
	$cÚfig_boŞ
(
úode
 *
roÙ
, cÚ¡ *
Çme
, 
_deçuÉ
)

69 
úode
 *
node
;

71 
node
 = 
	`cÚfig_fšd
(
roÙ
, 
Çme
);

72 if(!
node
)

73  
_deçuÉ
;

75 
node
->
v®ue
[0]) {

83 
	}
}

85 cÚ¡ * 
	$cÚfig_¡r
(
úode
 *
roÙ
, cÚ¡ *
Çme
, cÚ¡ *
_deçuÉ
)

87 
úode
 *
node
;

89 
node
 = 
	`cÚfig_fšd
(
roÙ
, 
Çme
);

90 if(!
node
)

91  
_deçuÉ
;

92  
node
->
v®ue
;

93 
	}
}

95 
	$cÚfig_£t
(
úode
 *
roÙ
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

97 
úode
 *
node
;

99 
node
 = 
	`cÚfig_fšd
(
roÙ
, 
Çme
);

100 if(
node
)

101 
node
->
v®ue
 = value;

103 
node
 = 
	`_cÚfig_ü—‹
(
roÙ
, 
Çme
);

104 
node
->
v®ue
 = value;

106 
	}
}

108 
	#T_EOF
 0

	)

109 
	#T_TEXT
 1

	)

110 
	#T_DOT
 2

	)

111 
	#T_OBRACE
 3

	)

112 
	#T_CBRACE
 4

	)

116 *
	md©a
;

117 *
	m‹xt
;

118 
	mËn
;

119 
	mÃxt
;

120 } 
	tc¡©e
;

122 
	$_Ëx
(
c¡©e
 *
cs
, 
v®ue
)

124 
c
;

125 *
s
;

126 *
d©a
;

128 
d©a
 = 
cs
->data;

130 if(
cs
->
Ãxt
 != 0) {

131 
c
 = 
cs
->
Ãxt
;

132 
cs
->
Ãxt
 = 0;

133 
gÙ_c
;

136 
»¡¬t
:

138 
c
 = *
d©a
++;

139 
gÙ_c
:

140 if(
	`is¥aû
(
c
))

143 
c
) {

145  
T_EOF
;

149 *
d©a
) {

151 
cs
->
d©a
 = data;

152  
T_EOF
;

154 
cs
->
d©a
 = data + 1;

155 
»¡¬t
;

157 
d©a
++;

163 
cs
->
d©a
 = data;

164  
T_DOT
;

167 
cs
->
d©a
 = data;

168  
T_OBRACE
;

171 
cs
->
d©a
 = data;

172  
T_CBRACE
;

175 
s
 = 
d©a
 - 1;

177 if(
v®ue
) {

179 if(*
d©a
 == 0) {

180 
cs
->
d©a
 = data;

183 if(*
d©a
 == '\n') {

184 
cs
->
d©a
 = data + 1;

185 *
d©a
-- = 0;

188 
d©a
++;

192 
d©a
 > 
s
){

193 if(!
	`is¥aû
(*
d©a
)) ;

194 *
d©a
-- = 0;

197 
gÙ_‹xt
;

200 if(
	`is¥aû
(*
d©a
)) {

201 *
d©a
 = 0;

202 
cs
->
d©a
 = data + 1;

203 
gÙ_‹xt
;

205 *
d©a
) {

207 
cs
->
d©a
 = data;

208 
gÙ_‹xt
;

212 
cs
->
Ãxt
 = *
d©a
;

213 *
d©a
 = 0;

214 
cs
->
d©a
 = data + 1;

215 
gÙ_‹xt
;

217 
d©a
++;

224 
gÙ_‹xt
:

225 
cs
->
‹xt
 = 
s
;

226  
T_TEXT
;

227 
	}
}

230 *
	gTOKENNAMES
[] = { "EOF", "TEXT", "DOT", "OBRACE", "CBRACE" };

232 
	$Ëx
(
c¡©e
 *
cs
, 
v®ue
)

234 
tok
 = 
	`_Ëx
(
cs
, 
v®ue
);

235 
	`´štf
("TOKEN(%dè% %s\n", 
v®ue
, 
TOKENNAMES
[
tok
],

236 
tok
 =ğ
T_TEXT
 ? 
cs
->
‹xt
 : "");

237  
tok
;

238 
	}
}

240 
	#Ëx
(
cs
,
v
è
	`_Ëx
(cs,v)

	)

243 
·r£_ex´
(
c¡©e
 *
cs
, 
úode
 *
node
);

245 
	$·r£_block
(
c¡©e
 *
cs
, 
úode
 *
node
)

248 
	`Ëx
(
cs
, 0)){

249 
T_TEXT
:

250 if(
	`·r£_ex´
(
cs
, 
node
))  -1;

253 
T_CBRACE
:

260 
	}
}

262 
	$·r£_ex´
(
c¡©e
 *
cs
, 
úode
 *
roÙ
)

264 
úode
 *
node
;

267 
node
 = 
	`cÚfig_fšd
(
roÙ
, 
cs
->
‹xt
);

268 if(!
node
 || *node->
v®ue
)

269 
node
 = 
	`_cÚfig_ü—‹
(
roÙ
, 
cs
->
‹xt
);

272 
	`Ëx
(
cs
, 1)) {

273 
T_DOT
:

274 if(
	`Ëx
(
cs
, 0è!ğ
T_TEXT
)

276 
node
 = 
	`_cÚfig_ü—‹
Òode, 
cs
->
‹xt
);

279 
T_TEXT
:

280 
node
->
v®ue
 = 
cs
->
‹xt
;

283 
T_OBRACE
:

284  
	`·r£_block
(
cs
, 
node
);

290 
	}
}

292 
	$cÚfig_lßd
(
úode
 *
roÙ
, *
d©a
)

294 if(
d©a
 != 0) {

295 
c¡©e
 
cs
;

296 
cs
.
d©a
 = data;

297 
cs
.
Ãxt
 = 0;

300 
	`Ëx
(&
cs
, 0)) {

301 
T_TEXT
:

302 if(
	`·r£_ex´
(&
cs
, 
roÙ
))

310 
	}
}

312 
	$cÚfig_lßd_fe
(
úode
 *
roÙ
, cÚ¡ *
â
)

314 *
d©a
;

315 
d©a
 = 
	`lßd_fe
(
â
, 0);

316 
	`cÚfig_lßd
(
roÙ
, 
d©a
);

317 
	}
}

319 
	$cÚfig_ä“
(
úode
 *
roÙ
)

321 
úode
 *
cur
 = 
roÙ
->
fœ¡_chd
;

323 
cur
) {

324 
úode
 *
´ev
 = 
cur
;

325 
	`cÚfig_ä“
(
cur
);

326 
cur
 = cur->
Ãxt
;

327 
	`ä“
(
´ev
);

329 
	}
}

	@libs/libcutils/cpu_info.c

18 
	~<cuts/ıu_šfo.h
>

19 
	~<¡dlib.h
>

20 
	~<¡dio.h
>

21 
	~<¡ršg.h
>

25 
	g£rŸl_numb”
[100] = { 0 };

27 cÚ¡ * 
	$g‘_ıu_£rŸl_numb”
()

29 ià(
£rŸl_numb”
[0] == 0)

31 
FILE
* 
fe
;

32 * 
chp
, *
’d
;

33 * 
wh™e¥aû
;

34 
Ëngth
;

37 
fe
 = 
	`fİ’
("proc/cpuinfo", "r");

38 ià(! 
fe
)

39  
NULL
;

41 (
chp
 = 
	`fg‘s
(
£rŸl_numb”
, (£rŸl_numb”), 
fe
)è!ğ
NULL
)

45 ià(
	`¡ºcmp
(
chp
, "Serial", 6) != 0)

48 
chp
 = 
	`¡rchr
(chp, ':');

49 ià(!
chp
)

53  *(++
chp
) == ' ') {}

56 
’d
 = 
chp
;

57 *
’d
 && *end != ' ' && *end != '\t' && *end != '\n' && *end != '\r')

58 ++
’d
;

59 *
’d
 = 0;

61 
wh™e¥aû
 = 
	`¡rchr
(
chp
, ' ');

62 ià(
wh™e¥aû
)

63 *
wh™e¥aû
 = 0;

64 
wh™e¥aû
 = 
	`¡rchr
(
chp
, '\t');

65 ià(
wh™e¥aû
)

66 *
wh™e¥aû
 = 0;

67 
wh™e¥aû
 = 
	`¡rchr
(
chp
, '\r');

68 ià(
wh™e¥aû
)

69 *
wh™e¥aû
 = 0;

70 
wh™e¥aû
 = 
	`¡rchr
(
chp
, '\n');

71 ià(
wh™e¥aû
)

72 *
wh™e¥aû
 = 0;

75 
	`memmove
(
£rŸl_numb”
, 
chp
, 
	`¡¾’
(chp) + 1);

79 
	`fşo£
(
fe
);

82  (
£rŸl_numb”
[0] ? s”Ÿl_numb” : 
NULL
);

83 
	}
}

	@libs/libcutils/cutils/abort_socket.h

49 
	~<¡dlib.h
>

50 
	~<sys/sock‘.h
>

52 #iâdeà
__CUTILS_ABORT_SOCKET_H__


53 
	#__CUTILS_ABORT_SOCKET_H__


	)

54 #ifdeà
__ılu¥lus


58 
	sasock‘
 {

59 
fd
;

60 
abÜt_fd
[2];

67 
asock‘
 *
asock‘_š™
(
fd
);

77 
asock‘_cÚÃù
(
asock‘
 *
s
, cÚ¡ 
sockaddr
 *
addr
,

78 
sockËn_t
 
add¾’
, 
timeout
);

80 
asock‘_acû±
(
asock‘
 *
s
, 
sockaddr
 *
addr
,

81 
sockËn_t
 *
add¾’
, 
timeout
);

83 
asock‘_»ad
(
asock‘
 *
s
, *
buf
, 
size_t
 
couÁ
, 
timeout
);

85 
asock‘_wr™e
(
asock‘
 *
s
, cÚ¡ *
buf
, 
size_t
 
couÁ
,

86 
timeout
);

93 
asock‘_abÜt
(
asock‘
 *
s
);

98 
asock‘_de¡roy
(
asock‘
 *
s
);

100 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/android_reboot.h

17 #iâdeà
__CUTILS_ANDROID_REBOOT_H__


18 
	#__CUTILS_ANDROID_REBOOT_H__


	)

20 
	g__BEGIN_DECLS


23 
	#ANDROID_RB_RESTART
 0xDEAD0001

	)

24 
	#ANDROID_RB_POWEROFF
 0xDEAD0002

	)

25 
	#ANDROID_RB_RESTART2
 0xDEAD0003

	)

28 
	#ANDROID_RB_FLAG_NO_SYNC
 0x1

	)

29 
	#ANDROID_RB_FLAG_NO_REMOUNT_RO
 0x2

	)

31 
ªdroid_»boÙ
(
cmd
, 
æags
, *
¬g
);

33 
	g__END_DECLS


	@libs/libcutils/cutils/array.h

21 #iâdeà
__ARRAY_H


22 
	#__ARRAY_H


	)

24 #ifdeà
__ılu¥lus


28 
	~<¡dlib.h
>

31 
A¼ay
 
	tA¼ay
;

34 
A¼ay
* 
¬¿yC»©e
();

37 
¬¿yF»e
(
A¼ay
* 
¬¿y
);

40 
¬¿yAdd
(
A¼ay
* 
¬¿y
, * 
poš‹r
);

43 * 
¬¿yG‘
(
A¼ay
* 
¬¿y
, 
šdex
);

46 * 
¬¿yRemove
(
A¼ay
* 
¬¿y
, 
šdex
);

49 * 
¬¿yS‘
(
A¼ay
* 
¬¿y
, 
šdex
, * 
poš‹r
);

52 
¬¿yS‘Size
(
A¼ay
* 
¬¿y
, 
size
);

55 
¬¿ySize
(
A¼ay
* 
¬¿y
);

61 cÚ¡ ** 
¬¿yUnw¿p
(
A¼ay
* 
¬¿y
);

63 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/ashmem.h

10 #iâdeà
_CUTILS_ASHMEM_H


11 
	#_CUTILS_ASHMEM_H


	)

13 
	~<¡ddef.h
>

15 #ifdeà
__ılu¥lus


19 
ashmem_ü—‹_»giÚ
(cÚ¡ *
Çme
, 
size_t
 
size
);

20 
ashmem_£t_´Ù_»giÚ
(
fd
, 
´Ù
);

21 
ashmem_pš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
);

22 
ashmem_uÅš_»giÚ
(
fd
, 
size_t
 
off£t
, size_ˆ
Ën
);

23 
ashmem_g‘_size_»giÚ
(
fd
);

25 #ifdeà
__ılu¥lus


29 #iâdeà
__ASHMEMIOC


31 
	#ASHMEM_NAME_LEN
 256

	)

33 
	#ASHMEM_NAME_DEF
 "dev/ashmem"

	)

36 
	#ASHMEM_NOT_PURGED
 0

	)

37 
	#ASHMEM_WAS_PURGED
 1

	)

40 
	#ASHMEM_IS_UNPINNED
 0

	)

41 
	#ASHMEM_IS_PINNED
 1

	)

	@libs/libcutils/cutils/atomic-arm.h

17 #iâdeà
ANDROID_CUTILS_ATOMIC_ARM_H


18 
	#ANDROID_CUTILS_ATOMIC_ARM_H


	)

20 
	~<¡dšt.h
>

21 
	~<machše/ıu-ã©u»s.h
>

23 
šlše
 
	$ªdroid_comp”_b¬r›r
()

25 
__asm__
 
	`__vŞ©e__
 ("" : : : "memory");

26 
	}
}

28 #ià
ANDROID_SMP
 == 0

29 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

31 
	`ªdroid_comp”_b¬r›r
();

32 
	}
}

33 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

35 
	`ªdroid_comp”_b¬r›r
();

36 
	}
}

37 #–ià
defšed
(
__ARM_HAVE_DMB
)

38 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

40 
__asm__
 
	`__vŞ©e__
 ("dmb" : : : "memory");

41 
	}
}

42 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

44 
__asm__
 
	`__vŞ©e__
 ("dmb st" : : : "memory");

45 
	}
}

46 #–ià
defšed
(
__ARM_HAVE_LDREX_STREX
)

47 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

49 
__asm__
 
	`__vŞ©e__
 ("mcr…15, 0, %0, c7, c10, 5" : : "r" (0) : "memory");

50 
	}
}

51 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

53 
	`ªdroid_memÜy_b¬r›r
();

54 
	}
}

56 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

58 (
	tku£r_memÜy_b¬r›r
)();

59 (*(
ku£r_memÜy_b¬r›r
 *)0xffff0fa0)();

60 
	}
}

61 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

63 
	`ªdroid_memÜy_b¬r›r
();

64 
	}
}

67 
šlše
 
št32_t
 
	$ªdroid_©omic_acquœe_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

69 
št32_t
 
v®ue
 = *
±r
;

70 
	`ªdroid_memÜy_b¬r›r
();

71  
v®ue
;

72 
	}
}

74 
šlše
 
št32_t
 
	$ªdroid_©omic_»Ëa£_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

76 
	`ªdroid_memÜy_b¬r›r
();

77  *
±r
;

78 
	}
}

80 
šlše
 
	$ªdroid_©omic_acquœe_¡Üe
(
št32_t
 
v®ue
,

81 vŞ©
št32_t
 *
±r
)

83 *
±r
 = 
v®ue
;

84 
	`ªdroid_memÜy_b¬r›r
();

85 
	}
}

87 
šlše
 
	$ªdroid_©omic_»Ëa£_¡Üe
(
št32_t
 
v®ue
,

88 vŞ©
št32_t
 *
±r
)

90 
	`ªdroid_memÜy_b¬r›r
();

91 *
±r
 = 
v®ue
;

92 
	}
}

94 #ià
defšed
(
__thumb__
)

95 
ªdroid_©omic_ÿs
(
št32_t
 
Şd_v®ue
, iÁ32_ˆ
Ãw_v®ue
,

96 vŞ©
št32_t
 *
±r
);

97 #–ià
defšed
(
__ARM_HAVE_LDREX_STREX
)

98 
šlše
 
	$ªdroid_©omic_ÿs
(
št32_t
 
Şd_v®ue
, iÁ32_ˆ
Ãw_v®ue
,

99 vŞ©
št32_t
 *
±r
)

101 
št32_t
 
´ev
, 
¡©us
;

103 
__asm__
 
	`__vŞ©e__
 ("ldrex %0, [%3]\n"

107 : "=&r" (
´ev
), "=&r" (
¡©us
), "+m"(*
±r
)

108 : "r" (
±r
), "Ir" (
Şd_v®ue
), "r" (
Ãw_v®ue
)

110 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

111  
´ev
 !ğ
Şd_v®ue
;

112 
	}
}

114 
šlše
 
	$ªdroid_©omic_ÿs
(
št32_t
 
Şd_v®ue
, iÁ32_ˆ
Ãw_v®ue
,

115 vŞ©
št32_t
 *
±r
)

117 (
	tku£r_cmpxchg
)(
	tšt32_t
, int32_t, volatile int32_t *);

118 
št32_t
 
´ev
, 
¡©us
;

119 
´ev
 = *
±r
;

121 
¡©us
 = (*(
ku£r_cmpxchg
 *)0xffff0fc0)(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

122 ià(
	`__butš_ex³ù
(
¡©us
 == 0, 1))

124 
´ev
 = *
±r
;

125 } 
´ev
 =ğ
Şd_v®ue
);

127 
	}
}

130 
šlše
 
	$ªdroid_©omic_acquœe_ÿs
(
št32_t
 
Şd_v®ue
,

131 
št32_t
 
Ãw_v®ue
,

132 vŞ©
št32_t
 *
±r
)

134 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

135 
	`ªdroid_memÜy_b¬r›r
();

136  
¡©us
;

137 
	}
}

139 
šlše
 
	$ªdroid_©omic_»Ëa£_ÿs
(
št32_t
 
Şd_v®ue
,

140 
št32_t
 
Ãw_v®ue
,

141 vŞ©
št32_t
 *
±r
)

143 
	`ªdroid_memÜy_b¬r›r
();

144  
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

145 
	}
}

148 #ià
defšed
(
__thumb__
)

149 
št32_t
 
ªdroid_©omic_add
(št32_ˆ
šüem’t
,

150 vŞ©
št32_t
 *
±r
);

151 #–ià
defšed
(
__ARM_HAVE_LDREX_STREX
)

152 
šlše
 
št32_t
 
	$ªdroid_©omic_add
(
št32_t
 
šüem’t
,

153 vŞ©
št32_t
 *
±r
)

155 
št32_t
 
´ev
, 
tmp
, 
¡©us
;

156 
	`ªdroid_memÜy_b¬r›r
();

158 
__asm__
 
	`__vŞ©e__
 ("ldrex %0, [%4]\n"

161 : "=&r" (
´ev
), "=&r" (
tmp
),

162 "=&r" (
¡©us
), "+m" (*
±r
)

163 : "r" (
±r
), "Ir" (
šüem’t
)

165 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

166  
´ev
;

167 
	}
}

169 
šlše
 
št32_t
 
	$ªdroid_©omic_add
(
št32_t
 
šüem’t
,

170 vŞ©
št32_t
 *
±r
)

172 
št32_t
 
´ev
, 
¡©us
;

173 
	`ªdroid_memÜy_b¬r›r
();

175 
´ev
 = *
±r
;

176 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
´ev
,…»v + 
šüem’t
, 
±r
);

177 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

178  
´ev
;

179 
	}
}

182 
šlše
 
št32_t
 
	$ªdroid_©omic_šc
(vŞ©
št32_t
 *
addr
)

184  
	`ªdroid_©omic_add
(1, 
addr
);

185 
	}
}

187 
šlše
 
št32_t
 
	$ªdroid_©omic_dec
(vŞ©
št32_t
 *
addr
)

189  
	`ªdroid_©omic_add
(-1, 
addr
);

190 
	}
}

192 #ià
defšed
(
__thumb__
)

193 
št32_t
 
ªdroid_©omic_ªd
(št32_ˆ
v®ue
, vŞ©št32_ˆ*
±r
);

194 #–ià
defšed
(
__ARM_HAVE_LDREX_STREX
)

195 
šlše
 
št32_t
 
	$ªdroid_©omic_ªd
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

197 
št32_t
 
´ev
, 
tmp
, 
¡©us
;

198 
	`ªdroid_memÜy_b¬r›r
();

200 
__asm__
 
	`__vŞ©e__
 ("ldrex %0, [%4]\n"

203 : "=&r" (
´ev
), "=&r" (
tmp
),

204 "=&r" (
¡©us
), "+m" (*
±r
)

205 : "r" (
±r
), "Ir" (
v®ue
)

207 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

208  
´ev
;

209 
	}
}

211 
šlše
 
št32_t
 
	$ªdroid_©omic_ªd
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

213 
št32_t
 
´ev
, 
¡©us
;

214 
	`ªdroid_memÜy_b¬r›r
();

216 
´ev
 = *
±r
;

217 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
´ev
,…»v & 
v®ue
, 
±r
);

218 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

219  
´ev
;

220 
	}
}

223 #ià
defšed
(
__thumb__
)

224 
št32_t
 
ªdroid_©omic_Ü
(št32_ˆ
v®ue
, vŞ©št32_ˆ*
±r
);

225 #–ià
defšed
(
__ARM_HAVE_LDREX_STREX
)

226 
šlše
 
št32_t
 
	$ªdroid_©omic_Ü
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

228 
št32_t
 
´ev
, 
tmp
, 
¡©us
;

229 
	`ªdroid_memÜy_b¬r›r
();

231 
__asm__
 
	`__vŞ©e__
 ("ldrex %0, [%4]\n"

234 : "=&r" (
´ev
), "=&r" (
tmp
),

235 "=&r" (
¡©us
), "+m" (*
±r
)

236 : "r" (
±r
), "Ir" (
v®ue
)

238 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

239  
´ev
;

240 
	}
}

242 
šlše
 
št32_t
 
	$ªdroid_©omic_Ü
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

244 
št32_t
 
´ev
, 
¡©us
;

245 
	`ªdroid_memÜy_b¬r›r
();

247 
´ev
 = *
±r
;

248 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
´ev
,…»v | 
v®ue
, 
±r
);

249 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

250  
´ev
;

251 
	}
}

	@libs/libcutils/cutils/atomic-inline.h

17 #iâdeà
ANDROID_CUTILS_ATOMIC_INLINE_H


18 
	#ANDROID_CUTILS_ATOMIC_INLINE_H


	)

20 #ifdeà
__ılu¥lus


42 #ià!
defšed
(
ANDROID_SMP
)

46 #ià
defšed
(
__¬m__
)

47 
	~<cuts/©omic-¬m.h
>

48 #–ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

49 
	~<cuts/©omic-x86.h
>

50 #–ià
defšed
(
__ms__
)

51 
	~<cuts/©omic-ms.h
>

53 #”rÜ 
©omic
 
İ”©iÚs
 
¬e
 
unsuµÜ‹d


56 #ià
ANDROID_SMP
 == 0

57 
	#ANDROID_MEMBAR_FULL
 
ªdroid_comp”_b¬r›r


	)

59 
	#ANDROID_MEMBAR_FULL
 
ªdroid_memÜy_b¬r›r


	)

62 #ià
ANDROID_SMP
 == 0

63 
	#ANDROID_MEMBAR_STORE
 
ªdroid_comp”_b¬r›r


	)

65 
	#ANDROID_MEMBAR_STORE
 
ªdroid_memÜy_¡Üe_b¬r›r


	)

68 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/atomic-mips.h

17 #iâdeà
ANDROID_CUTILS_ATOMIC_MIPS_H


18 
	#ANDROID_CUTILS_ATOMIC_MIPS_H


	)

20 
	~<¡dšt.h
>

22 
šlše
 
	$ªdroid_comp”_b¬r›r
()

24 
__asm__
 
	`__vŞ©e__
 ("" : : : "memory");

25 
	}
}

27 #ià
ANDROID_SMP
 == 0

28 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

30 
	`ªdroid_comp”_b¬r›r
();

31 
	}
}

32 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

34 
	`ªdroid_comp”_b¬r›r
();

35 
	}
}

37 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

39 
__asm__
 
	`__vŞ©e__
 ("sync" : : : "memory");

40 
	}
}

41 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

43 
__asm__
 
	`__vŞ©e__
 ("sync" : : : "memory");

44 
	}
}

47 
šlše
 
št32_t
 
	$ªdroid_©omic_acquœe_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

49 
št32_t
 
v®ue
 = *
±r
;

50 
	`ªdroid_memÜy_b¬r›r
();

51  
v®ue
;

52 
	}
}

54 
šlše
 
št32_t
 
	$ªdroid_©omic_»Ëa£_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

56 
	`ªdroid_memÜy_b¬r›r
();

57  *
±r
;

58 
	}
}

60 
šlše
 
	$ªdroid_©omic_acquœe_¡Üe
(
št32_t
 
v®ue
,

61 vŞ©
št32_t
 *
±r
)

63 *
±r
 = 
v®ue
;

64 
	`ªdroid_memÜy_b¬r›r
();

65 
	}
}

67 
šlše
 
	$ªdroid_©omic_»Ëa£_¡Üe
(
št32_t
 
v®ue
,

68 vŞ©
št32_t
 *
±r
)

70 
	`ªdroid_memÜy_b¬r›r
();

71 *
±r
 = 
v®ue
;

72 
	}
}

74 
šlše
 
	$ªdroid_©omic_ÿs
(
št32_t
 
Şd_v®ue
, iÁ32_ˆ
Ãw_v®ue
,

75 vŞ©
št32_t
 *
±r
)

77 
št32_t
 
´ev
, 
¡©us
;

79 
__asm__
 
	`__vŞ©e__
 (

86 : [
´ev
] "=&r" (´ev), [
¡©us
] "=&r" (status)

87 : [
±r
] "r" (±r), [
Şd
] "r" (
Şd_v®ue
), [
Ãw_v®ue
] "r" (new_value)

89 } 
	`__butš_ex³ù
(
¡©us
 == 0, 0));

90  
´ev
 !ğ
Şd_v®ue
;

91 
	}
}

93 
šlše
 
	$ªdroid_©omic_acquœe_ÿs
(
št32_t
 
Şd_v®ue
,

94 
št32_t
 
Ãw_v®ue
,

95 vŞ©
št32_t
 *
±r
)

97 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

98 
	`ªdroid_memÜy_b¬r›r
();

99  
¡©us
;

100 
	}
}

102 
šlše
 
	$ªdroid_©omic_»Ëa£_ÿs
(
št32_t
 
Şd_v®ue
,

103 
št32_t
 
Ãw_v®ue
,

104 vŞ©
št32_t
 *
±r
)

106 
	`ªdroid_memÜy_b¬r›r
();

107  
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

108 
	}
}

111 
šlše
 
št32_t
 
	$ªdroid_©omic_sw­
(
št32_t
 
Ãw_v®ue
,

112 vŞ©
št32_t
 *
±r
)

114 
št32_t
 
´ev
, 
¡©us
;

116 
__asm__
 
	`__vŞ©e__
 (

120 : [
´ev
] "=&r" (´ev), [
¡©us
] "=&r" (status)

121 : [
±r
] "r" (±r), [
Ãw_v®ue
] "r" (new_value)

123 } 
	`__butš_ex³ù
(
¡©us
 == 0, 0));

124 
	`ªdroid_memÜy_b¬r›r
();

125  
´ev
;

126 
	}
}

128 
šlše
 
št32_t
 
	$ªdroid_©omic_add
(
št32_t
 
šüem’t
,

129 vŞ©
št32_t
 *
±r
)

131 
št32_t
 
´ev
, 
¡©us
;

132 
	`ªdroid_memÜy_b¬r›r
();

134 
__asm__
 
	`__vŞ©e__
 (

138 : [
¡©us
] "=&r" (¡©us), [
´ev
] "=&r" (prev)

139 : [
±r
] "r" (±r), [
šc
] "Ir" (
šüem’t
)

141 } 
	`__butš_ex³ù
(
¡©us
 == 0, 0));

142  
´ev
;

143 
	}
}

145 
šlše
 
št32_t
 
	$ªdroid_©omic_šc
(vŞ©
št32_t
 *
addr
)

147  
	`ªdroid_©omic_add
(1, 
addr
);

148 
	}
}

150 
šlše
 
št32_t
 
	$ªdroid_©omic_dec
(vŞ©
št32_t
 *
addr
)

152  
	`ªdroid_©omic_add
(-1, 
addr
);

153 
	}
}

155 
šlše
 
št32_t
 
	$ªdroid_©omic_ªd
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

157 
št32_t
 
´ev
, 
¡©us
;

158 
	`ªdroid_memÜy_b¬r›r
();

160 
__asm__
 
	`__vŞ©e__
 (

164 : [
´ev
] "=&r" (´ev), [
¡©us
] "=&r" (status)

165 : [
±r
] "r" (±r), [
v®ue
] "Ir" (value)

167 } 
	`__butš_ex³ù
(
¡©us
 == 0, 0));

168  
´ev
;

169 
	}
}

171 
šlše
 
št32_t
 
	$ªdroid_©omic_Ü
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

173 
št32_t
 
´ev
, 
¡©us
;

174 
	`ªdroid_memÜy_b¬r›r
();

176 
__asm__
 
	`__vŞ©e__
 (

180 : [
´ev
] "=&r" (´ev), [
¡©us
] "=&r" (status)

181 : [
±r
] "r" (±r), [
v®ue
] "Ir" (value)

183 } 
	`__butš_ex³ù
(
¡©us
 == 0, 0));

184  
´ev
;

185 
	}
}

	@libs/libcutils/cutils/atomic-x86.h

17 #iâdeà
ANDROID_CUTILS_ATOMIC_X86_H


18 
	#ANDROID_CUTILS_ATOMIC_X86_H


	)

20 
	~<¡dšt.h
>

22 
šlše
 
	$ªdroid_comp”_b¬r›r
()

24 
__asm__
 
	`__vŞ©e__
 ("" : : : "memory");

25 
	}
}

27 #ià
ANDROID_SMP
 == 0

28 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

30 
	`ªdroid_comp”_b¬r›r
();

31 
	}
}

32 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

34 
	`ªdroid_comp”_b¬r›r
();

35 
	}
}

37 
šlše
 
	$ªdroid_memÜy_b¬r›r
()

39 
__asm__
 
	`__vŞ©e__
 ("mfence" : : : "memory");

40 
	}
}

41 
šlše
 
	$ªdroid_memÜy_¡Üe_b¬r›r
()

43 
	`ªdroid_comp”_b¬r›r
();

44 
	}
}

47 
šlše
 
št32_t
 
	$ªdroid_©omic_acquœe_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

49 
št32_t
 
v®ue
 = *
±r
;

50 
	`ªdroid_comp”_b¬r›r
();

51  
v®ue
;

52 
	}
}

54 
šlše
 
št32_t
 
	$ªdroid_©omic_»Ëa£_lßd
(vŞ©cÚ¡ 
št32_t
 *
±r
)

56 
	`ªdroid_memÜy_b¬r›r
();

57  *
±r
;

58 
	}
}

60 
šlše
 
	$ªdroid_©omic_acquœe_¡Üe
(
št32_t
 
v®ue
,

61 vŞ©
št32_t
 *
±r
)

63 *
±r
 = 
v®ue
;

64 
	`ªdroid_memÜy_b¬r›r
();

65 
	}
}

67 
šlše
 
	$ªdroid_©omic_»Ëa£_¡Üe
(
št32_t
 
v®ue
,

68 vŞ©
št32_t
 *
±r
)

70 
	`ªdroid_comp”_b¬r›r
();

71 *
±r
 = 
v®ue
;

72 
	}
}

74 
šlše
 
	$ªdroid_©omic_ÿs
(
št32_t
 
Şd_v®ue
, iÁ32_ˆ
Ãw_v®ue
,

75 vŞ©
št32_t
 *
±r
)

77 
št32_t
 
´ev
;

78 
__asm__
 
	`__vŞ©e__
 ("lock; cmpxchgl %1, %2"

79 : "÷" (
´ev
)

80 : "q" (
Ãw_v®ue
), "m" (*
±r
), "0" (
Şd_v®ue
)

82  
´ev
 !ğ
Şd_v®ue
;

83 
	}
}

85 
šlše
 
	$ªdroid_©omic_acquœe_ÿs
(
št32_t
 
Şd_v®ue
,

86 
št32_t
 
Ãw_v®ue
,

87 vŞ©
št32_t
 *
±r
)

90  
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

91 
	}
}

93 
šlše
 
	$ªdroid_©omic_»Ëa£_ÿs
(
št32_t
 
Şd_v®ue
,

94 
št32_t
 
Ãw_v®ue
,

95 vŞ©
št32_t
 *
±r
)

98  
	`ªdroid_©omic_ÿs
(
Şd_v®ue
, 
Ãw_v®ue
, 
±r
);

99 
	}
}

101 
šlše
 
št32_t
 
	$ªdroid_©omic_add
(
št32_t
 
šüem’t
,

102 vŞ©
št32_t
 *
±r
)

104 
__asm__
 
	`__vŞ©e__
 ("lock; xaddl %0, %1"

105 : "+r" (
šüem’t
), "+m" (*
±r
)

108  
šüem’t
;

109 
	}
}

111 
šlše
 
št32_t
 
	$ªdroid_©omic_šc
(vŞ©
št32_t
 *
addr
)

113  
	`ªdroid_©omic_add
(1, 
addr
);

114 
	}
}

116 
šlše
 
št32_t
 
	$ªdroid_©omic_dec
(vŞ©
št32_t
 *
addr
)

118  
	`ªdroid_©omic_add
(-1, 
addr
);

119 
	}
}

121 
šlše
 
št32_t
 
	$ªdroid_©omic_ªd
(
št32_t
 
v®ue
,

122 vŞ©
št32_t
 *
±r
)

124 
št32_t
 
´ev
, 
¡©us
;

126 
´ev
 = *
±r
;

127 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
´ev
,…»v & 
v®ue
, 
±r
);

128 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

129  
´ev
;

130 
	}
}

132 
šlše
 
št32_t
 
	$ªdroid_©omic_Ü
(
št32_t
 
v®ue
, vŞ©št32_ˆ*
±r
)

134 
št32_t
 
´ev
, 
¡©us
;

136 
´ev
 = *
±r
;

137 
¡©us
 = 
	`ªdroid_©omic_ÿs
(
´ev
,…»v | 
v®ue
, 
±r
);

138 } 
	`__butš_ex³ù
(
¡©us
 != 0, 0));

139  
´ev
;

140 
	}
}

	@libs/libcutils/cutils/atomic.h

17 #iâdeà
ANDROID_CUTILS_ATOMIC_H


18 
	#ANDROID_CUTILS_ATOMIC_H


	)

20 
	~<¡dšt.h
>

21 
	~<sys/ty³s.h
>

23 #ifdeà
__ılu¥lus


68 
št32_t
 
ªdroid_©omic_šc
(vŞ©št32_t* 
addr
);

69 
št32_t
 
ªdroid_©omic_dec
(vŞ©št32_t* 
addr
);

70 
št32_t
 
ªdroid_©omic_add
(št32_ˆ
v®ue
, vŞ©št32_t* 
addr
);

71 
št32_t
 
ªdroid_©omic_ªd
(št32_ˆ
v®ue
, vŞ©št32_t* 
addr
);

72 
št32_t
 
ªdroid_©omic_Ü
(št32_ˆ
v®ue
, vŞ©št32_t* 
addr
);

80 
št32_t
 
ªdroid_©omic_acquœe_lßd
(vŞ©cÚ¡ iÁ32_t* 
addr
);

81 
št32_t
 
ªdroid_©omic_»Ëa£_lßd
(vŞ©cÚ¡ iÁ32_t* 
addr
);

89 
ªdroid_©omic_acquœe_¡Üe
(
št32_t
 
v®ue
, vŞ©št32_t* 
addr
);

90 
ªdroid_©omic_»Ëa£_¡Üe
(
št32_t
 
v®ue
, vŞ©št32_t* 
addr
);

104 
ªdroid_©omic_acquœe_ÿs
(
št32_t
 
Şdv®ue
, iÁ32_ˆ
Ãwv®ue
,

105 vŞ©
št32_t
* 
addr
);

106 
ªdroid_©omic_»Ëa£_ÿs
(
št32_t
 
Şdv®ue
, iÁ32_ˆ
Ãwv®ue
,

107 vŞ©
št32_t
* 
addr
);

114 
	#ªdroid_©omic_wr™e
 
ªdroid_©omic_»Ëa£_¡Üe


	)

115 
	#ªdroid_©omic_cmpxchg
 
ªdroid_©omic_»Ëa£_ÿs


	)

117 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/bitops.h

17 #iâdeà
__CUTILS_BITOPS_H


18 
	#__CUTILS_BITOPS_H


	)

20 
	~<sys/cdefs.h
>

22 
__BEGIN_DECLS


24 
šlše
 
	$pİcouÁ
(
x
)

26  
	`__butš_pİcouÁ
(
x
);

27 
	}
}

29 
šlše
 
	$pİcouÁl
(
x
)

31  
	`__butš_pİcouÁl
(
x
);

32 
	}
}

34 
šlše
 
	$pİcouÁÎ
(
x
)

36  
	`__butš_pİcouÁÎ
(
x
);

37 
	}
}

39 
	g__END_DECLS


	@libs/libcutils/cutils/compiler.h

17 #iâdeà
ANDROID_CUTILS_COMPILER_H


18 
	#ANDROID_CUTILS_COMPILER_H


	)

24 #ifdeà
__ılu¥lus


25 
	#CC_LIKELY
Ğ
exp
 ) (
	`__butš_ex³ù
Ğ!!Óxp), 
Œue
 ))

	)

26 
	#CC_UNLIKELY
Ğ
exp
 ) (
	`__butš_ex³ù
Ğ!!Óxp), 
çl£
 ))

	)

28 
	#CC_LIKELY
Ğ
exp
 ) (
	`__butš_ex³ù
Ğ!!Óxp), 1 ))

	)

29 
	#CC_UNLIKELY
Ğ
exp
 ) (
	`__butš_ex³ù
Ğ!!Óxp), 0 ))

	)

42 
	#ANDROID_API
 
	`__©Œibu‹__
((
	`visib™y
("deçuÉ")))

	)

	@libs/libcutils/cutils/config_utils.h

17 #iâdeà
__CUTILS_CONFIG_UTILS_H


18 
	#__CUTILS_CONFIG_UTILS_H


	)

20 #ifdeà
__ılu¥lus


24 
úode
 
	túode
;

27 
	súode


29 
úode
 *
Ãxt
;

30 
úode
 *
fœ¡_chd
;

31 
úode
 *
Ï¡_chd
;

32 cÚ¡ *
Çme
;

33 cÚ¡ *
v®ue
;

37 
cÚfig_lßd
(
úode
 *
roÙ
, *
d©a
);

40 
cÚfig_lßd_fe
(
úode
 *
roÙ
, cÚ¡ *
â
);

43 
úode
* 
cÚfig_node
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

46 
úode
* 
cÚfig_fšd
(úod*
roÙ
, cÚ¡ *
Çme
);

49 
cÚfig_boŞ
(
úode
 *
roÙ
, cÚ¡ *
Çme
, 
_deçuÉ
);

52 cÚ¡ * 
cÚfig_¡r
(
úode
 *
roÙ
, cÚ¡ *
Çme
, cÚ¡ *
_deçuÉ
);

55 
cÚfig_£t
(
úode
 *
roÙ
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

58 
cÚfig_ä“
(
úode
 *
roÙ
);

60 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/cpu_info.h

17 #iâdeà
__CUTILS_CPU_INFO_H


18 
	#__CUTILS_CPU_INFO_H


	)

20 #ifdeà
__ılu¥lus


28 cÚ¡ * 
g‘_ıu_£rŸl_numb”
();

30 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/debugger.h

17 #iâdeà
__CUTILS_DEBUGGER_H


18 
	#__CUTILS_DEBUGGER_H


	)

20 
	~<sys/ty³s.h
>

22 #ifdeà
__ılu¥lus


26 
	#DEBUGGER_SOCKET_NAME
 "ªdroid:debugg”d"

	)

30 
DEBUGGER_ACTION_CRASH
,

32 
DEBUGGER_ACTION_DUMP_TOMBSTONE
,

34 
DEBUGGER_ACTION_DUMP_BACKTRACE
,

35 } 
	tdebugg”_aùiÚ_t
;

39 
debugg”_aùiÚ_t
 
aùiÚ
;

40 
pid_t
 
tid
;

41 } 
	tdebugg”_msg_t
;

47 
dump_tomb¡Úe
(
pid_t
 
tid
, * 
·thbuf
, 
size_t
 
·thËn
);

52 
dump_backŒaû_to_fe
(
pid_t
 
tid
, 
fd
);

54 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/dir_hash.h

18 
	mSHA_1
,

19 } 
	tHashAlgÜ™hm
;

21 
g‘_fe_hash
(
HashAlgÜ™hm
 
®gÜ™hm
, cÚ¡ *
·th
,

22 *
ouut_¡ršg
, 
size_t
 
max_ouut_¡ršg
);

24 
g‘_»cursive_hash_mªiã¡
(
HashAlgÜ™hm
 
®gÜ™hm
,

25 cÚ¡ *
dœeùÜy_·th
,

26 **
ouut_¡ršg
);

	@libs/libcutils/cutils/event_tag_map.h

17 #iâdeà
_LIBS_CUTILS_EVENTTAGMAP_H


18 
	#_LIBS_CUTILS_EVENTTAGMAP_H


	)

20 #ifdeà
__ılu¥lus


24 
	#EVENT_TAG_MAP_FILE
 "/sy¡em/‘c/ev’t-log-gs"

	)

26 
Ev’tTagM­
;

27 
Ev’tTagM­
 
	tEv’tTagM­
;

34 
Ev’tTagM­
* 
ªdroid_İ’Ev’tTagM­
(cÚ¡ * 
feName
);

39 
ªdroid_şo£Ev’tTagM­
(
Ev’tTagM­
* 
m­
);

44 cÚ¡ * 
ªdroid_lookupEv’tTag
(cÚ¡ 
Ev’tTagM­
* 
m­
, 
g
);

46 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/fs.h

17 #iâdeà
__CUTILS_FS_H


18 
	#__CUTILS_FS_H


	)

20 
	~<sys/ty³s.h
>

27 #iâdeà
TEMP_FAILURE_RETRY


29 
	#TEMP_FAILURE_RETRY
(
exp
) ({ \

30 
	`ty³of
 (
exp
è
_rc
; \

32 
_rc
 = (
exp
); \

33 } 
_rc
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

34 
_rc
; })

	)

37 #ifdeà
__ılu¥lus


44 
fs_´•¬e_dœ
(cÚ¡ * 
·th
, 
mode_t
 
mode
, 
uid_t
 
uid
, 
gid_t
 
gid
);

50 
fs_»ad_©omic_št
(cÚ¡ * 
·th
, * 
v®ue
);

56 
fs_wr™e_©omic_št
(cÚ¡ * 
·th
, 
v®ue
);

58 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/hashmap.h

21 #iâdeà
__HASHMAP_H


22 
	#__HASHMAP_H


	)

24 
	~<¡dboŞ.h
>

25 
	~<¡dlib.h
>

27 #ifdeà
__ılu¥lus


32 
Hashm­
 
	tHashm­
;

41 
Hashm­
* 
hashm­C»©e
(
size_t
 
š™ŸlC­ac™y
,

42 (*
hash
)(* 
key
), 
boŞ
 (*
equ®s
)(* 
keyA
, * 
keyB
));

47 
hashm­F»e
(
Hashm­
* 
m­
);

53 
hashm­Hash
(* 
key
, 
size_t
 
keySize
);

62 * 
hashm­Put
(
Hashm­
* 
m­
, * 
key
, * 
v®ue
);

68 * 
hashm­G‘
(
Hashm­
* 
m­
, * 
key
);

73 
boŞ
 
hashm­CÚšsKey
(
Hashm­
* 
m­
, * 
key
);

82 * 
hashm­Memoize
(
Hashm­
* 
m­
, * 
key
,

83 * (*
š™ŸlV®ue
)(* 
key
, * 
cÚ‹xt
), * context);

89 * 
hashm­Remove
(
Hashm­
* 
m­
, * 
key
);

94 
size_t
 
hashm­Size
(
Hashm­
* 
m­
);

100 
hashm­FÜEach
(
Hashm­
* 
m­
,

101 
boŞ
 (*
ÿÎback
)(* 
key
, * 
v®ue
, * 
cÚ‹xt
),

102 * 
cÚ‹xt
);

111 
hashm­Lock
(
Hashm­
* 
m­
);

116 
hashm­UÆock
(
Hashm­
* 
m­
);

125 
hashm­IÁHash
(* 
key
);

130 
boŞ
 
hashm­IÁEqu®s
(* 
keyA
, * 
keyB
);

139 
size_t
 
hashm­Cu¼’tC­ac™y
(
Hashm­
* 
m­
);

144 
size_t
 
hashm­CouÁCŞlisiÚs
(
Hashm­
* 
m­
);

146 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/iosched_policy.h

17 #iâdeà
__CUTILS_IOSCHED_POLICY_H


18 
	#__CUTILS_IOSCHED_POLICY_H


	)

20 #ifdeà
__ılu¥lus


25 
IoSchedCÏss_NONE
,

26 
IoSchedCÏss_RT
,

27 
IoSchedCÏss_BE
,

28 
IoSchedCÏss_IDLE
,

29 } 
	tIoSchedCÏss
;

31 
ªdroid_£t_iİrio
(
pid
, 
IoSchedCÏss
 
şazz
, 
iİrio
);

32 
ªdroid_g‘_iİrio
(
pid
, 
IoSchedCÏss
 *
şazz
, *
iİrio
);

34 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/jstring.h

17 #iâdeà
__CUTILS_STRING16_H


18 
	#__CUTILS_STRING16_H


	)

20 
	~<¡dšt.h
>

21 
	~<¡ddef.h
>

23 #ifdeà
__ılu¥lus


27 
ušt16_t
 
	tch¬16_t
;

29 * 
¡ºdup16to8
 (cÚ¡ 
ch¬16_t
* 
s
, 
size_t
 
n
);

30 
size_t
 
¡ºËn16to8
 (cÚ¡ 
ch¬16_t
* 
s
, size_ˆ
n
);

31 * 
¡ºıy16to8
 (*
de¡
, cÚ¡ 
ch¬16_t
*
s
, 
size_t
 
n
);

33 
ch¬16_t
 * 
¡rdup8to16
 (cÚ¡ * 
s
, 
size_t
 *
out_Ën
);

34 
size_t
 
¡¾’8to16
 (cÚ¡ * 
utf8SŒ
);

35 
ch¬16_t
 * 
¡rıy8to16
 (ch¬16_ˆ*
de¡
, cÚ¡ *
s
, 
size_t
 *
out_Ën
);

36 
ch¬16_t
 * 
¡rıyËn8to16
 (ch¬16_ˆ*
de¡
, cÚ¡ *
s
, 
Ëngth
,

37 
size_t
 *
out_Ën
);

39 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/klog.h

17 #iâdeà
_CUTILS_KLOG_H_


18 
	#_CUTILS_KLOG_H_


	)

20 
klog_š™
();

21 
klog_£t_Ëv–
(
Ëv–
);

22 
klog_şo£
();

23 
	$klog_wr™e
(
Ëv–
, cÚ¡ *
fmt
, ...)

24 
	`__©Œibu‹__
 ((
	`fÜm©
(
´štf
, 2, 3)));

26 
	#KLOG_ERROR
(
g
,
x
...è
	`klog_wr™e
(3, "<3>"ag ": " x)

	)

27 
	#KLOG_WARNING
(
g
,
x
...è
	`klog_wr™e
(4, "<4>"ag ": " x)

	)

28 
	#KLOG_NOTICE
(
g
,
x
...è
	`klog_wr™e
(5, "<5>"ag ": " x)

	)

29 
	#KLOG_INFO
(
g
,
x
...è
	`klog_wr™e
(6, "<6>"ag ": " x)

	)

30 
	#KLOG_DEBUG
(
g
,
x
...è
	`klog_wr™e
(7, "<7>"ag ": " x)

	)

32 
	#KLOG_DEFAULT_LEVEL
 3

	)

	@libs/libcutils/cutils/list.h

17 #iâdeà
_CUTILS_LIST_H_


18 
	#_CUTILS_LIST_H_


	)

20 
	~<¡ddef.h
>

22 #ifdeà
__ılu¥lus


26 
	sli¡node


28 
li¡node
 *
Ãxt
;

29 
li¡node
 *
´ev
;

32 
	#node_to_™em
(
node
, 
cÚš”
, 
memb”
) \

33 (
cÚš”
 *è(((*è(
node
)è- 
	`off£tof
(cÚš”, 
memb”
))

	)

35 
	#li¡_deş¬e
(
Çme
) \

36 
li¡node
 
Çme
 = { \

37 .
Ãxt
 = &
Çme
, \

38 .
´ev
 = &
Çme
, \

39 }

	)

41 
	#li¡_fÜ_—ch
(
node
, 
li¡
) \

42 
node
 = (
li¡
)->
Ãxt
;‚od!ğÖi¡);‚odğnode->Ãxt)

	)

44 
	#li¡_fÜ_—ch_»v”£
(
node
, 
li¡
) \

45 
node
 = (
li¡
)->
´ev
;‚od!ğÖi¡);‚odğnode->´ev)

	)

47 
li¡_š™
(
li¡node
 *
li¡
);

48 
li¡_add_
(
li¡node
 *
li¡
, li¡nod*
™em
);

49 
li¡_»move
(
li¡node
 *
™em
);

51 
	#li¡_em±y
(
li¡
è(Öi¡è=ğÖi¡)->
Ãxt
)

	)

52 
	#li¡_h—d
(
li¡
è(Öi¡)->
Ãxt
)

	)

53 
	#li¡_
(
li¡
è(Öi¡)->
´ev
)

	)

55 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/log.h

28 #iâdeà
_LIBS_CUTILS_LOG_H


29 
	#_LIBS_CUTILS_LOG_H


	)

31 
	~<¡dio.h
>

32 
	~<time.h
>

33 
	~<sys/ty³s.h
>

34 
	~<uni¡d.h
>

35 #ifdeà
HAVE_PTHREADS


36 
	~<±h»ad.h
>

38 
	~<¡d¬g.h
>

40 #ifdeà
__ılu¥lus


44 
	#ALOGV
(
x
,
¬g
...è
	`´štf
("[V] "x,##¬g)

	)

45 
	#ALOGD
(
x
,
¬g
...è
	`´štf
("[D] "x,##¬g)

	)

46 
	#ALOGI
(
x
,
¬g
...è
	`´štf
("[I] "x,##¬g)

	)

47 
	#ALOGW
(
x
,
¬g
...è
	`´štf
("[W] "x,##¬g)

	)

50 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/log_bak_for_android.h

28 #iâdeà
_LIBS_CUTILS_LOG_H


29 
	#_LIBS_CUTILS_LOG_H


	)

31 
	~<¡dio.h
>

32 
	~<time.h
>

33 
	~<sys/ty³s.h
>

34 
	~<uni¡d.h
>

35 #ifdeà
HAVE_PTHREADS


36 
	~<±h»ad.h
>

38 
	~<¡d¬g.h
>

40 
	~<cuts/uio.h
>

41 
	~<cuts/logd.h
>

43 #ifdeà
__ılu¥lus


55 #iâdeà
LOG_NDEBUG


56 #ifdeà
NDEBUG


57 
	#LOG_NDEBUG
 1

	)

59 
	#LOG_NDEBUG
 0

	)

68 #iâdeà
LOG_TAG


69 
	#LOG_TAG
 
NULL


	)

77 #iâdeà
ALOGV


78 #ià
LOG_NDEBUG


79 
	#ALOGV
(...è(()0)

	)

81 
	#ALOGV
(...è(()
	`ALOG
(
LOG_VERBOSE
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

85 
	#CONDITION
(
cÚd
è(
	`__butš_ex³ù
((cÚd)!=0, 0))

	)

87 #iâdeà
ALOGV_IF


88 #ià
LOG_NDEBUG


89 
	#ALOGV_IF
(
cÚd
, ...è(()0)

	)

91 
	#ALOGV_IF
(
cÚd
, ...) \

92 Ğ(
	`CONDITION
(
cÚd
)) \

93 ? (()
	`ALOG
(
LOG_VERBOSE
, 
LOG_TAG
, 
__VA_ARGS__
)) \

94 : ()0 )

	)

101 #iâdeà
ALOGD


102 
	#ALOGD
(...è(()
	`ALOG
(
LOG_DEBUG
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

105 #iâdeà
ALOGD_IF


106 
	#ALOGD_IF
(
cÚd
, ...) \

107 Ğ(
	`CONDITION
(
cÚd
)) \

108 ? (()
	`ALOG
(
LOG_DEBUG
, 
LOG_TAG
, 
__VA_ARGS__
)) \

109 : ()0 )

	)

115 #iâdeà
ALOGI


116 
	#ALOGI
(...è(()
	`ALOG
(
LOG_INFO
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

119 #iâdeà
ALOGI_IF


120 
	#ALOGI_IF
(
cÚd
, ...) \

121 Ğ(
	`CONDITION
(
cÚd
)) \

122 ? (()
	`ALOG
(
LOG_INFO
, 
LOG_TAG
, 
__VA_ARGS__
)) \

123 : ()0 )

	)

129 #iâdeà
ALOGW


130 
	#ALOGW
(...è(()
	`ALOG
(
LOG_WARN
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

133 #iâdeà
ALOGW_IF


134 
	#ALOGW_IF
(
cÚd
, ...) \

135 Ğ(
	`CONDITION
(
cÚd
)) \

136 ? (()
	`ALOG
(
LOG_WARN
, 
LOG_TAG
, 
__VA_ARGS__
)) \

137 : ()0 )

	)

143 #iâdeà
ALOGE


144 
	#ALOGE
(...è(()
	`ALOG
(
LOG_ERROR
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

147 #iâdeà
ALOGE_IF


148 
	#ALOGE_IF
(
cÚd
, ...) \

149 Ğ(
	`CONDITION
(
cÚd
)) \

150 ? (()
	`ALOG
(
LOG_ERROR
, 
LOG_TAG
, 
__VA_ARGS__
)) \

151 : ()0 )

	)

160 #iâdeà
IF_ALOGV


161 #ià
LOG_NDEBUG


162 
	#IF_ALOGV
(èià(
çl£
)

	)

164 
	#IF_ALOGV
(è
	`IF_ALOG
(
LOG_VERBOSE
, 
LOG_TAG
)

	)

172 #iâdeà
IF_ALOGD


173 
	#IF_ALOGD
(è
	`IF_ALOG
(
LOG_DEBUG
, 
LOG_TAG
)

	)

180 #iâdeà
IF_ALOGI


181 
	#IF_ALOGI
(è
	`IF_ALOG
(
LOG_INFO
, 
LOG_TAG
)

	)

188 #iâdeà
IF_ALOGW


189 
	#IF_ALOGW
(è
	`IF_ALOG
(
LOG_WARN
, 
LOG_TAG
)

	)

196 #iâdeà
IF_ALOGE


197 
	#IF_ALOGE
(è
	`IF_ALOG
(
LOG_ERROR
, 
LOG_TAG
)

	)

206 #iâdeà
SLOGV


207 #ià
LOG_NDEBUG


208 
	#SLOGV
(...è(()0)

	)

210 
	#SLOGV
(...è(()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_VERBOSE
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

214 
	#CONDITION
(
cÚd
è(
	`__butš_ex³ù
((cÚd)!=0, 0))

	)

216 #iâdeà
SLOGV_IF


217 #ià
LOG_NDEBUG


218 
	#SLOGV_IF
(
cÚd
, ...è(()0)

	)

220 
	#SLOGV_IF
(
cÚd
, ...) \

221 Ğ(
	`CONDITION
(
cÚd
)) \

222 ? (()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_VERBOSE
, 
LOG_TAG
, 
__VA_ARGS__
)) \

223 : ()0 )

	)

230 #iâdeà
SLOGD


231 
	#SLOGD
(...è(()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_DEBUG
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

234 #iâdeà
SLOGD_IF


235 
	#SLOGD_IF
(
cÚd
, ...) \

236 Ğ(
	`CONDITION
(
cÚd
)) \

237 ? (()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_DEBUG
, 
LOG_TAG
, 
__VA_ARGS__
)) \

238 : ()0 )

	)

244 #iâdeà
SLOGI


245 
	#SLOGI
(...è(()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_INFO
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

248 #iâdeà
SLOGI_IF


249 
	#SLOGI_IF
(
cÚd
, ...) \

250 Ğ(
	`CONDITION
(
cÚd
)) \

251 ? (()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_INFO
, 
LOG_TAG
, 
__VA_ARGS__
)) \

252 : ()0 )

	)

258 #iâdeà
SLOGW


259 
	#SLOGW
(...è(()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_WARN
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

262 #iâdeà
SLOGW_IF


263 
	#SLOGW_IF
(
cÚd
, ...) \

264 Ğ(
	`CONDITION
(
cÚd
)) \

265 ? (()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_WARN
, 
LOG_TAG
, 
__VA_ARGS__
)) \

266 : ()0 )

	)

272 #iâdeà
SLOGE


273 
	#SLOGE
(...è(()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_ERROR
, 
LOG_TAG
, 
__VA_ARGS__
))

	)

276 #iâdeà
SLOGE_IF


277 
	#SLOGE_IF
(
cÚd
, ...) \

278 Ğ(
	`CONDITION
(
cÚd
)) \

279 ? (()
	`__ªdroid_log_buf_´št
(
LOG_ID_SYSTEM
, 
ANDROID_LOG_ERROR
, 
LOG_TAG
, 
__VA_ARGS__
)) \

280 : ()0 )

	)

293 #iâdeà
LOG_ALWAYS_FATAL_IF


294 
	#LOG_ALWAYS_FATAL_IF
(
cÚd
, ...) \

295 Ğ(
	`CONDITION
(
cÚd
)) \

296 ? (()
	`ªdroid_´štAs£¹
(#cÚd, 
LOG_TAG
, ## 
__VA_ARGS__
)) \

297 : ()0 )

	)

300 #iâdeà
LOG_ALWAYS_FATAL


301 
	#LOG_ALWAYS_FATAL
(...) \

302 Ğ(()
	`ªdroid_´štAs£¹
(
NULL
, 
LOG_TAG
, ## 
__VA_ARGS__
)è)

	)

309 #ià
LOG_NDEBUG


311 #iâdeà
LOG_FATAL_IF


312 
	#LOG_FATAL_IF
(
cÚd
, ...è(()0)

	)

314 #iâdeà
LOG_FATAL


315 
	#LOG_FATAL
(...è(()0)

	)

320 #iâdeà
LOG_FATAL_IF


321 
	#LOG_FATAL_IF
(
cÚd
, ...è
	`LOG_ALWAYS_FATAL_IF
(cÚd, ## 
__VA_ARGS__
)

	)

323 #iâdeà
LOG_FATAL


324 
	#LOG_FATAL
(...è
	`LOG_ALWAYS_FATAL
(
__VA_ARGS__
)

	)

333 #iâdeà
ALOG_ASSERT


334 
	#ALOG_ASSERT
(
cÚd
, ...è
	`LOG_FATAL_IF
(!(cÚd), ## 
__VA_ARGS__
)

	)

348 #iâdeà
ALOG


349 
	#ALOG
(
´iÜ™y
, 
g
, ...) \

350 
	`LOG_PRI
(
ANDROID_
##
´iÜ™y
, 
g
, 
__VA_ARGS__
)

	)

356 #iâdeà
LOG_PRI


357 
	#LOG_PRI
(
´iÜ™y
, 
g
, ...) \

358 
	`ªdroid_´štLog
(
´iÜ™y
, 
g
, 
__VA_ARGS__
)

	)

364 #iâdeà
LOG_PRI_VA


365 
	#LOG_PRI_VA
(
´iÜ™y
, 
g
, 
fmt
, 
¬gs
) \

366 
	`ªdroid_v´štLog
(
´iÜ™y
, 
NULL
, 
g
, 
fmt
, 
¬gs
)

	)

372 #iâdeà
IF_ALOG


373 
	#IF_ALOG
(
´iÜ™y
, 
g
) \

374 ià(
	`ªdroid_‹¡Log
(
ANDROID_
##
´iÜ™y
, 
g
))

	)

388 
EVENT_TYPE_INT
 = 0,

389 
EVENT_TYPE_LONG
 = 1,

390 
EVENT_TYPE_STRING
 = 2,

391 
EVENT_TYPE_LIST
 = 3,

392 } 
	tAndroidEv’tLogTy³
;

395 #iâdeà
LOG_EVENT_INT


396 
	#LOG_EVENT_INT
(
_g
, 
_v®ue
) { \

397 
štBuf
 = 
_v®ue
; \

398 (è
	`ªdroid_btWr™eLog
(
_g
, 
EVENT_TYPE_INT
, &
štBuf
, \

399 (
štBuf
)); \

400 }

	)

402 #iâdeà
LOG_EVENT_LONG


403 
	#LOG_EVENT_LONG
(
_g
, 
_v®ue
) { \

404 
lÚgBuf
 = 
_v®ue
; \

405 (è
	`ªdroid_btWr™eLog
(
_g
, 
EVENT_TYPE_LONG
, &
lÚgBuf
, \

406 (
lÚgBuf
)); \

407 }

	)

409 #iâdeà
LOG_EVENT_STRING


410 
	#LOG_EVENT_STRING
(
_g
, 
_v®ue
) \

411 ((è0è

	)

421 
	#ªdroid_´štLog
(
´io
, 
g
, 
fmt
...) \

422 
	`__ªdroid_log_´št
(
´io
, 
g
, 
fmt
)

	)

424 
	#ªdroid_v´štLog
(
´io
, 
cÚd
, 
g
, 
fmt
...) \

425 
	`__ªdroid_log_v´št
(
´io
, 
g
, 
fmt
)

	)

435 
	#__ªdroid_£cÚd
(
dummy
, 
£cÚd
, ...è
	)
second

440 
	#__ªdroid_»¡
(
fœ¡
, ...è, ## 
__VA_ARGS__


	)

442 
	#ªdroid_´štAs£¹
(
cÚd
, 
g
, 
fmt
...) \

443 
	`__ªdroid_log_as£¹
(
cÚd
, 
g
, \

444 
	`__ªdroid_£cÚd
(0, ## 
fmt
, 
NULL
è
	`__ªdroid_»¡
(fmt))

	)

446 
	#ªdroid_wr™eLog
(
´io
, 
g
, 
‹xt
) \

447 
	`__ªdroid_log_wr™e
(
´io
, 
g
, 
‹xt
)

	)

449 
	#ªdroid_bWr™eLog
(
g
, 
·ylßd
, 
Ën
) \

450 
	`__ªdroid_log_bwr™e
(
g
, 
·ylßd
, 
Ën
)

	)

451 
	#ªdroid_btWr™eLog
(
g
, 
ty³
, 
·ylßd
, 
Ën
) \

452 
	`__ªdroid_log_btwr™e
(
g
, 
ty³
, 
·ylßd
, 
Ën
)

	)

455 
	#ªdroid_‹¡Log
(
´io
, 
g
è(1)

	)

456 
	#ªdroid_wr™evLog
(
vec
,
num
èdo{}0)

	)

457 
	#ªdroid_wr™e1Log
(
¡r
,
Ën
èdo{}0)

	)

458 
	#ªdroid_£tMšPriÜ™y
(
g
, 
´io
èdo{}0)

	)

460 
	#ªdroid_logToFe
(
g
, 
fe
è(0)

	)

461 
	#ªdroid_logToFd
(
g
, 
fd
è(0)

	)

464 
LOG_ID_MAIN
 = 0,

465 
LOG_ID_RADIO
 = 1,

466 
LOG_ID_EVENTS
 = 2,

467 
LOG_ID_SYSTEM
 = 3,

469 
LOG_ID_MAX


470 } 
	tlog_id_t
;

475 
__ªdroid_log_buf_wr™e
(
bufID
, 
´io
, cÚ¡ *
g
, cÚ¡ *
‹xt
);

476 
__ªdroid_log_buf_´št
(
bufID
, 
´io
, cÚ¡ *
g
, cÚ¡ *
fmt
, ...);

479 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/logd.h

17 #iâdeà
_ANDROID_CUTILS_LOGD_H


18 
	#_ANDROID_CUTILS_LOGD_H


	)

23 
	~<ªdroid/log.h
>

26 
	~<time.h
>

27 
	~<¡dio.h
>

28 
	~<uni¡d.h
>

29 
	~<¡dšt.h
>

30 
	~<sys/ty³s.h
>

31 #ifdeà
HAVE_PTHREADS


32 
	~<±h»ad.h
>

34 
	~<cuts/uio.h
>

35 
	~<¡d¬g.h
>

37 #ifdeà
__ılu¥lus


41 
__ªdroid_log_bwr™e
(
št32_t
 
g
, cÚ¡ *
·ylßd
, 
size_t
 
Ën
);

42 
__ªdroid_log_btwr™e
(
št32_t
 
g
, 
ty³
, cÚ¡ *
·ylßd
,

43 
size_t
 
Ën
);

45 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/logger.h

10 #iâdeà
_UTILS_LOGGER_H


11 
	#_UTILS_LOGGER_H


	)

13 
	~<¡dšt.h
>

20 
	slogg”_’Œy
 {

21 
ušt16_t
 
	mËn
;

22 
ušt16_t
 
	m__·d
;

23 
št32_t
 
	mpid
;

24 
št32_t
 
	mtid
;

25 
št32_t
 
	m£c
;

26 
št32_t
 
	mn£c
;

27 
	mmsg
[0];

35 
	slogg”_’Œy_v2
 {

36 
ušt16_t
 
	mËn
;

37 
ušt16_t
 
	mhdr_size
;

38 
št32_t
 
	mpid
;

39 
št32_t
 
	mtid
;

40 
št32_t
 
	m£c
;

41 
št32_t
 
	mn£c
;

42 
ušt32_t
 
	meuid
;

43 
	mmsg
[0];

46 
	#LOGGER_LOG_MAIN
 "log/maš"

	)

47 
	#LOGGER_LOG_RADIO
 "log/¿dio"

	)

48 
	#LOGGER_LOG_EVENTS
 "log/ev’ts"

	)

49 
	#LOGGER_LOG_SYSTEM
 "log/sy¡em"

	)

57 
	#LOGGER_ENTRY_MAX_PAYLOAD
 4076

	)

64 
	#LOGGER_ENTRY_MAX_LEN
 (5*1024)

	)

66 #ifdeà
HAVE_IOCTL


68 
	~<sys/ioùl.h
>

70 
	#__LOGGERIO
 0xAE

	)

72 
	#LOGGER_GET_LOG_BUF_SIZE
 
	`_IO
(
__LOGGERIO
, 1è

	)

73 
	#LOGGER_GET_LOG_LEN
 
	`_IO
(
__LOGGERIO
, 2è

	)

74 
	#LOGGER_GET_NEXT_ENTRY_LEN
 
	`_IO
(
__LOGGERIO
, 3è

	)

75 
	#LOGGER_FLUSH_LOG
 
	`_IO
(
__LOGGERIO
, 4è

	)

76 
	#LOGGER_GET_VERSION
 
	`_IO
(
__LOGGERIO
, 5è

	)

77 
	#LOGGER_SET_VERSION
 
	`_IO
(
__LOGGERIO
, 6è

	)

	@libs/libcutils/cutils/logprint.h

17 #iâdeà
_LOGPRINT_H


18 
	#_LOGPRINT_H


	)

20 
	~<cuts/log.h
>

21 
	~<cuts/logg”.h
>

22 
	~<cuts/ev’t_g_m­.h
>

23 
	~<±h»ad.h
>

25 #ifdeà
__ılu¥lus


30 
FORMAT_OFF
 = 0,

31 
FORMAT_BRIEF
,

32 
FORMAT_PROCESS
,

33 
FORMAT_TAG
,

34 
FORMAT_THREAD
,

35 
FORMAT_RAW
,

36 
FORMAT_TIME
,

37 
FORMAT_THREADTIME
,

38 
FORMAT_LONG
,

39 } 
	tAndroidLogPrštFÜm©
;

41 
AndroidLogFÜm©_t
 
	tAndroidLogFÜm©
;

43 
	sAndroidLogEÁry_t
 {

44 
time_t
 
tv_£c
;

45 
tv_n£c
;

46 
ªdroid_LogPriÜ™y
 
´iÜ™y
;

47 
št32_t
 
pid
;

48 
št32_t
 
tid
;

49 cÚ¡ * 
g
;

50 
size_t
 
mes§geL’
;

51 cÚ¡ * 
mes§ge
;

52 } 
	tAndroidLogEÁry
;

54 
AndroidLogFÜm©
 *
ªdroid_log_fÜm©_Ãw
();

56 
ªdroid_log_fÜm©_ä“
(
AndroidLogFÜm©
 *
p_fÜm©
);

58 
ªdroid_log_£tPrštFÜm©
(
AndroidLogFÜm©
 *
p_fÜm©
,

59 
AndroidLogPrštFÜm©
 
fÜm©
);

64 
AndroidLogPrštFÜm©
 
ªdroid_log_fÜm©FromSŒšg
(cÚ¡ *
s
);

76 
ªdroid_log_addF‹rRuË
(
AndroidLogFÜm©
 *
p_fÜm©
,

77 cÚ¡ *
f‹rEx´essiÚ
);

90 
ªdroid_log_addF‹rSŒšg
(
AndroidLogFÜm©
 *
p_fÜm©
,

91 cÚ¡ *
f‹rSŒšg
);

98 
ªdroid_log_shouldPrštLše
 (

99 
AndroidLogFÜm©
 *
p_fÜm©
, cÚ¡ *
g
, 
ªdroid_LogPriÜ™y
 
´i
);

109 
ªdroid_log_´oûssLogBufãr
(
logg”_’Œy
 *
buf
,

110 
AndroidLogEÁry
 *
’Œy
);

118 
ªdroid_log_´oûssBš¬yLogBufãr
(
logg”_’Œy
 *
buf
,

119 
AndroidLogEÁry
 *
’Œy
, cÚ¡ 
Ev’tTagM­
* 
m­
, * 
mes§geBuf
,

120 
mes§geBufL’
);

131 *
ªdroid_log_fÜm©LogLše
 (

132 
AndroidLogFÜm©
 *
p_fÜm©
,

133 *
deçuÉBufãr
,

134 
size_t
 
deçuÉBufãrSize
,

135 cÚ¡ 
AndroidLogEÁry
 *
p_lše
,

136 
size_t
 *
p_outL’gth
);

145 
ªdroid_log_´štLogLše
(

146 
AndroidLogFÜm©
 *
p_fÜm©
,

147 
fd
,

148 cÚ¡ 
AndroidLogEÁry
 *
’Œy
);

151 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/memory.h

17 #iâdeà
ANDROID_CUTILS_MEMORY_H


18 
	#ANDROID_CUTILS_MEMORY_H


	)

20 
	~<¡dšt.h
>

21 
	~<sys/ty³s.h
>

23 #ifdeà
__ılu¥lus


28 
ªdroid_mem£t16
(
ušt16_t
* 
d¡
, ušt16_ˆ
v®ue
, 
size_t
 
size
);

31 
ªdroid_mem£t32
(
ušt32_t
* 
d¡
, ušt32_ˆ
v®ue
, 
size_t
 
size
);

33 #ià!
HAVE_STRLCPY


35 
size_t
 
¡¾ıy
(*
d¡
, cÚ¡ *
¤c
, size_ˆ
size
);

38 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/misc.h

17 #iâdeà
__CUTILS_MISC_H


18 
	#__CUTILS_MISC_H


	)

20 #ifdeà
__ılu¥lus


29 *
lßd_fe
(cÚ¡ *
â
, *
sz
);

35 
debugg”d_cÚÃù
();

41 
	#FIRST_APPLICATION_UID
 10000

	)

42 
	#LAST_APPLICATION_UID
 99999

	)

44 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/mq.h

21 #iâdeà
__MQ_H


22 
	#__MQ_H


	)

24 #ifdeà
__ılu¥lus


29 
MqMes§ge
 
	tMqMes§ge
;

32 
MqDe¡š©iÚ
 
	tMqDe¡š©iÚ
;

35 
MqBy‹s
 
	tMqBy‹s
;

43 
	tMqMes§geLi¡’”
(
	tMqDe¡š©iÚ
* 
	tde¡š©iÚ
, 
	tMqMes§ge
* 
	tmes§ge
);

50 
	tMqClo£Li¡’”
(
	tMqDe¡š©iÚ
* 
	tde¡š©iÚ
);

61 
MqMes§ge
* 
mqC»©eMes§ge
(
MqBy‹s
 
h—d”
, MqBy‹ 
body
,

62 
MqDe¡š©iÚ
* 
»¶yTo
);

65 
mqS’dMes§ge
(
MqMes§ge
* 
mes§ge
, 
MqDe¡š©iÚ
* 
de¡š©iÚ
);

77 
MqDe¡š©iÚ
* 
mqC»©eDe¡š©iÚ
(
MqMes§geLi¡’”
* 
mes§geLi¡’”
,

78 
MqClo£Li¡’”
* 
şo£Li¡’”
, * 
u£rD©a
);

89 * 
mqG‘U£rD©a
(
MqDe¡š©iÚ
* 
de¡š©iÚ
);

96 
mqIsDe¡š©iÚLoÿl
(
MqDe¡š©iÚ
* 
de¡š©iÚ
);

101 
mqK“pDe¡š©iÚ
(
MqDesštiÚ
* 
de¡š©iÚ
);

106 
mqF»eDe¡š©iÚ
(
MqDe¡š©iÚ
* 
desštiÚ
);

113 
MqDe¡š©iÚ
* 
mqG‘De¡š©iÚ
(* 
Çme
);

118 
mqPutDe¡š©iÚ
(* 
Çme
, 
MqDe¡š©iÚ
* 
desštiÚ
);

120 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/multiuser.h

17 #iâdeà
__CUTILS_MULTIUSER_H


18 
	#__CUTILS_MULTIUSER_H


	)

20 
	~<sys/ty³s.h
>

22 #ifdeà
__ılu¥lus


28 
	#MULTIUSER_APP_PER_USER_RANGE
 100000

	)

30 
uid_t
 
	tu£rid_t
;

31 
uid_t
 
	t­pid_t
;

33 
u£rid_t
 
muÉiu£r_g‘_u£r_id
(
uid_t
 
uid
);

34 
­pid_t
 
muÉiu£r_g‘_­p_id
(
uid_t
 
uid
);

35 
uid_t
 
muÉiu£r_g‘_uid
(
u£rid_t
 
u£rId
, 
­pid_t
 
­pId
);

37 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/native_handle.h

17 #iâdeà
NATIVE_HANDLE_H_


18 
	#NATIVE_HANDLE_H_


	)

20 #ifdeà
__ılu¥lus


24 
	sÇtive_hªdË


26 
v”siÚ
;

27 
numFds
;

28 
numIÁs
;

29 
d©a
[0];

30 } 
	tÇtive_hªdË_t
;

40 
Çtive_hªdË_şo£
(cÚ¡ 
Çtive_hªdË_t
* 
h
);

50 
Çtive_hªdË_t
* 
Çtive_hªdË_ü—‹
(
numFds
, 
numIÁs
);

62 
Çtive_hªdË_d–‘e
(
Çtive_hªdË_t
* 
h
);

65 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/open_memstream.h

17 #iâdeà
__CUTILS_OPEN_MEMSTREAM_H__


18 
	#__CUTILS_OPEN_MEMSTREAM_H__


	)

20 
	~<¡dio.h
>

22 #iâdeà
HAVE_OPEN_MEMSTREAM


24 #ifdeà
__ılu¥lus


28 
FILE
* 
İ’_mem¡»am
(** 
buå
, 
size_t
* 
siz•
);

30 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/partition_utils.h

17 #iâdeà
__CUTILS_PARTITION_WIPED_H__


18 
	#__CUTILS_PARTITION_WIPED_H__


	)

20 
__BEGIN_DECLS


22 
·¹™iÚ_wed
(*
sourû
);

23 
”a£_foÙ”
(cÚ¡ *
dev_·th
, 
size
);

25 
	g__END_DECLS


	@libs/libcutils/cutils/process_name.h

21 #iâdeà
__PROCESS_NAME_H


22 
	#__PROCESS_NAME_H


	)

24 #ifdeà
__ılu¥lus


33 
£t_´oûss_Çme
(cÚ¡ * 
´oûss_Çme
);

36 cÚ¡ * 
g‘_´oûss_Çme
();

38 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/properties.h

17 #iâdeà
__CUTILS_PROPERTIES_H


18 
	#__CUTILS_PROPERTIES_H


	)

20 #ifdeà
__ılu¥lus


31 
	#PROPERTY_KEY_MAX
 32

	)

32 
	#PROPERTY_VALUE_MAX
 92

	)

41 
´İ”ty_g‘
(cÚ¡ *
key
, *
v®ue
, cÚ¡ *
deçuÉ_v®ue
);

45 
´İ”ty_£t
(cÚ¡ *
key
, cÚ¡ *
v®ue
);

47 
´İ”ty_li¡
((*
´İâ
)(cÚ¡ *
key
, cÚ¡ *
v®ue
, *
cook›
), *cookie);

50 #ifdeà
HAVE_SYSTEM_PROPERTY_SERVER


55 
	#SYSTEM_PROPERTY_PIPE_NAME
 "/tmp/ªdroid-sy¥rİ"

	)

58 
kSy¡emPrİ”tyUnknown
 = 0,

59 
kSy¡emPrİ”tyG‘
,

60 
kSy¡emPrİ”tyS‘
,

61 
kSy¡emPrİ”tyLi¡


66 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/qsort_r_compat.h

23 #iâdeà
_LIBS_CUTILS_QSORT_R_COMPAT_H


24 
	#_LIBS_CUTILS_QSORT_R_COMPAT_H


	)

26 
	~<¡dlib.h
>

28 #ifdeà
__ılu¥lus


32 
qsÜt_r_com·t
(* 
ba£
, 
size_t
 
Ãl
, size_ˆ
width
, * 
thunk
,

33 (*
com·r
)(*, const * , const * ));

35 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/qtaguid.h

17 #iâdeà
__CUTILS_QTAGUID_H


18 
	#__CUTILS_QTAGUID_H


	)

20 
	~<¡dšt.h
>

21 
	~<sys/ty³s.h
>

22 
	~<uni¡d.h
>

24 #ifdeà
__ılu¥lus


31 
qguid_gSock‘
(
sockfd
, 
g
, 
uid_t
 
uid
);

36 
qguid_uÁagSock‘
(
sockfd
);

43 
qguid_£tCouÁ”S‘
(
couÁ”S‘Num
, 
uid_t
 
uid
);

54 
qguid_d–‘eTagD©a
(
g
, 
uid_t
 
uid
);

60 
qguid_£tPacif›r
(
Ú
);

62 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/record_stream.h

21 #iâdeà
_CUTILS_RECORD_STREAM_H


22 
	#_CUTILS_RECORD_STREAM_H


	)

24 #ifdeà
__ılu¥lus


29 
RecÜdSŒ—m
 
	tRecÜdSŒ—m
;

31 
RecÜdSŒ—m
 *
»cÜd_¡»am_Ãw
(
fd
, 
size_t
 
maxRecÜdL’
);

32 
»cÜd_¡»am_ä“
(
RecÜdSŒ—m
 *
p_rs
);

34 
»cÜd_¡»am_g‘_Ãxt
 (
RecÜdSŒ—m
 *
p_rs
, ** 
p_outRecÜd
,

35 
size_t
 *
p_outRecÜdL’
);

37 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/sched_policy.h

17 #iâdeà
__CUTILS_SCHED_POLICY_H


18 
	#__CUTILS_SCHED_POLICY_H


	)

20 #ifdeà
__ılu¥lus


26 
SP_DEFAULT
 = -1,

27 
SP_BACKGROUND
 = 0,

28 
SP_FOREGROUND
 = 1,

29 
SP_SYSTEM
 = 2,

30 
SP_AUDIO_APP
 = 3,

31 
SP_AUDIO_SYS
 = 4,

32 
SP_CNT
,

33 
SP_MAX
 = 
SP_CNT
 - 1,

34 
SP_SYSTEM_DEFAULT
 = 
SP_FOREGROUND
,

35 } 
	tSchedPŞicy
;

43 
£t_sched_pŞicy
(
tid
, 
SchedPŞicy
 
pŞicy
);

49 
g‘_sched_pŞicy
(
tid
, 
SchedPŞicy
 *
pŞicy
);

55 cÚ¡ *
g‘_sched_pŞicy_Çme
(
SchedPŞicy
 
pŞicy
);

57 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/selector.h

23 #iâdeà
__SELECTOR_H


24 
	#__SELECTOR_H


	)

26 #ifdeà
__ılu¥lus


30 
	~<¡dboŞ.h
>

35 
S–eùÜ
 
	tS–eùÜ
;

49 
S–eùabËFd
 
	tS–eùabËFd
;

50 
	sS–eùabËFd
 {

53 
fd
;

56 * 
d©a
;

62 
boŞ
 
»move
;

68 (*
befÜeS–eù
)(
S–eùabËFd
* 
£lf
);

74 (*
ÚR—dabË
)(
S–eùabËFd
* 
£lf
);

80 (*
ÚWr™abË
)(
S–eùabËFd
* 
£lf
);

86 (*
ÚExû±
)(
S–eùabËFd
* 
£lf
);

92 (*
ÚRemove
)(
S–eùabËFd
* 
£lf
);

97 
S–eùÜ
* 
£ËùÜ
;

103 
S–eùÜ
* 
£ËùÜC»©e
();

112 
S–eùabËFd
* 
£ËùÜAdd
(
S–eùÜ
* 
£ËùÜ
, 
fd
);

118 
£ËùÜWakeUp
(
S–eùÜ
* 
£ËùÜ
);

124 
£ËùÜLoİ
(
S–eùÜ
* 
£ËùÜ
);

126 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/sockets.h

17 #iâdeà
__CUTILS_SOCKETS_H


18 
	#__CUTILS_SOCKETS_H


	)

20 
	~<”ºo.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dboŞ.h
>

25 #ifdeà
HAVE_WINSOCK


26 
	~<wšsock2.h
>

27 
	tsockËn_t
;

28 #–ià
HAVE_SYS_SOCKET_H


29 
	~<sys/sock‘.h
>

32 
	#ANDROID_SOCKET_ENV_PREFIX
 "ANDROID_SOCKET_"

	)

33 
	#ANDROID_SOCKET_DIR
 "/dev/sock‘"

	)

35 #ifdeà
__ılu¥lus


47 
šlše
 
ªdroid_g‘_cÚŒŞ_sock‘
(cÚ¡ *
Çme
)

49 
key
[64] = 
ANDROID_SOCKET_ENV_PREFIX
;

50 cÚ¡ *
v®
;

51 
fd
;

54 #ià
HAVE_STRLCPY


55 
¡¾ıy
(
key
 + (
ANDROID_SOCKET_ENV_PREFIX
) - 1,

56 
Çme
,

57 (
key
è- (
ANDROID_SOCKET_ENV_PREFIX
));

59 
¡ºıy
(
key
 + (
ANDROID_SOCKET_ENV_PREFIX
) - 1,

60 
Çme
,

61 (
key
è- (
ANDROID_SOCKET_ENV_PREFIX
));

62 
key
[(key)-1] = '\0';

65 
v®
 = 
g‘’v
(
key
);

66 ià(!
v®
)

69 
”ºo
 = 0;

70 
fd
 = 
¡¹Ş
(
v®
, 
NULL
, 10);

71 ià(
”ºo
)

74  
fd
;

81 
	#ANDROID_SOCKET_NAMESPACE_ABSTRACT
 0

	)

83 
	#ANDROID_SOCKET_NAMESPACE_RESERVED
 1

	)

85 
	#ANDROID_SOCKET_NAMESPACE_FILESYSTEM
 2

	)

87 
sock‘_loİback_ş›Á
(
pÜt
, 
ty³
);

88 
sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
);

89 
sock‘_loİback_£rv”
(
pÜt
, 
ty³
);

90 
sock‘_loÿl_£rv”
(cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
);

91 
sock‘_loÿl_£rv”_bšd
(
s
, cÚ¡ *
Çme
, 
Çme¥aûId
);

92 
sock‘_loÿl_ş›Á_cÚÃù
(
fd
,

93 cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
);

94 
sock‘_loÿl_ş›Á
(cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
);

95 
sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
);

106 
boŞ
 
sock‘_³”_is_Œu¡ed
(
fd
);

108 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/str_parms.h

17 #iâdeà
__CUTILS_STR_PARMS_H


18 
	#__CUTILS_STR_PARMS_H


	)

20 
	~<¡dšt.h
>

22 
	g¡r_·rms
;

24 
¡r_·rms
 *
¡r_·rms_ü—‹
();

25 
¡r_·rms
 *
¡r_·rms_ü—‹_¡r
(cÚ¡ *
_¡ršg
);

26 
¡r_·rms_de¡roy
(
¡r_·rms
 *str_parms);

28 
¡r_·rms_d–
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
);

30 
¡r_·rms_add_¡r
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

31 cÚ¡ *
v®ue
);

32 
¡r_·rms_add_št
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
, 
v®ue
);

34 
¡r_·rms_add_æßt
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

35 
v®ue
);

37 
¡r_·rms_g‘_¡r
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

38 *
out_v®
, 
Ën
);

39 
¡r_·rms_g‘_št
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

40 *
out_v®
);

41 
¡r_·rms_g‘_æßt
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

42 *
out_v®
);

44 *
¡r_·rms_to_¡r
(
¡r_·rms
 *str_parms);

47 
¡r_·rms_dump
(
¡r_·rms
 *str_parms);

	@libs/libcutils/cutils/threads.h

17 #iâdeà
_LIBS_CUTILS_THREADS_H


18 
	#_LIBS_CUTILS_THREADS_H


	)

20 #ifdeà
__ılu¥lus


32 #ifdeà
HAVE_PTHREADS


34 
	~<±h»ad.h
>

37 
±h»ad_mu‹x_t
 
lock
;

38 
has_s
;

39 
±h»ad_key_t
 
s
;

41 } 
	tth»ad_¡Üe_t
;

43 
	#THREAD_STORE_INITIALIZER
 { 
PTHREAD_MUTEX_INITIALIZER
, 0, 0 }

	)

45 #–ià
defšed
 
HAVE_WIN32_THREADS


47 
	~<wšdows.h
>

50 
lock_š™
;

51 
has_s
;

52 
DWORD
 
s
;

53 
CRITICAL_SECTION
 
lock
;

55 } 
	tth»ad_¡Üe_t
;

57 
	#THREAD_STORE_INITIALIZER
 { 0, 0, 0, {0, 0, 0, 0, 0, 0} }

	)

63 (*
th»ad_¡Üe_de¡ruù_t
)(* 
	tv®ue
);

65 * 
th»ad_¡Üe_g‘
(
th»ad_¡Üe_t
* 
¡Üe
);

67 
th»ad_¡Üe_£t
(
th»ad_¡Üe_t
* 
¡Üe
,

68 * 
v®ue
,

69 
th»ad_¡Üe_de¡ruù_t
 
de¡roy
);

79 #ifdeà
HAVE_PTHREADS


81 
±h»ad_mu‹x_t
 
	tmu‹x_t
;

83 
	#MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

85 
__šlše__
 
mu‹x_lock
(
mu‹x_t
* 
lock
)

87 
±h»ad_mu‹x_lock
(
lock
);

89 
__šlše__
 
mu‹x_uÆock
(
mu‹x_t
* 
lock
)

91 
±h»ad_mu‹x_uÆock
(
lock
);

93 
__šlše__
 
mu‹x_š™
(
mu‹x_t
* 
lock
)

95  
±h»ad_mu‹x_š™
(
lock
, 
NULL
);

97 
__šlše__
 
mu‹x_de¡roy
(
mu‹x_t
* 
lock
)

99 
±h»ad_mu‹x_de¡roy
(
lock
);

103 #ifdeà
HAVE_WIN32_THREADS


105 
	gš™
;

106 
CRITICAL_SECTION
 
	glock
[1];

107 } 
	tmu‹x_t
;

109 
	#MUTEX_INITIALIZER
 { 0, {{ 
NULL
, 0, 0, NULL, NULL, 0 }} }

	)

111 
__šlše__
 
mu‹x_lock
(
mu‹x_t
* 
lock
)

113 ià(!
	glock
->
	gš™
) {

114 
	glock
->
	gš™
 = 1;

115 
In™ŸlizeCr™iÿlSeùiÚ
Ğ
lock
->lock );

116 
	glock
->
	gš™
 = 2;

117 } 
	glock
->
	gš™
 != 2)

118 
SË•
(10);

120 
EÁ”Cr™iÿlSeùiÚ
(
lock
->lock);

123 
__šlše__
 
mu‹x_uÆock
(
mu‹x_t
* 
lock
)

125 
L—veCr™iÿlSeùiÚ
(
lock
->lock);

127 
__šlše__
 
mu‹x_š™
(
mu‹x_t
* 
lock
)

129 
In™ŸlizeCr™iÿlSeùiÚ
(
lock
->lock);

130 
	glock
->
	gš™
 = 2;

133 
__šlše__
 
mu‹x_de¡roy
(
mu‹x_t
* 
lock
)

135 ià(
	glock
->
	gš™
) {

136 
	glock
->
	gš™
 = 0;

137 
D–‘eCr™iÿlSeùiÚ
(
lock
->lock);

142 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/tztime.h

17 #iâdeà
_CUTILS_TZTIME_H


18 
	#_CUTILS_TZTIME_H


	)

20 
	~<time.h
>

22 #ifdeà
__ılu¥lus


26 
time_t
 
mktime_tz
(
tm
 * cÚ¡ 
tmp
, cÚ¡ * 
tz
);

27 
loÿÉime_tz
(cÚ¡ 
time_t
 * cÚ¡ 
tim•
, 
tm
 * 
tmp
, cÚ¡ * 
tz
);

29 #ifdeà
HAVE_ANDROID_OS


34 
	~<biÚic_time.h
>

38 
	s¡ráime_loÿË
 {

39 cÚ¡ *
mÚ
[12];

40 cÚ¡ *
mÚth
[12];

41 cÚ¡ *
¡ªd®Úe_mÚth
[12];

42 cÚ¡ *
wday
[7];

43 cÚ¡ *
w“kday
[7];

44 cÚ¡ *
X_fmt
;

45 cÚ¡ *
x_fmt
;

46 cÚ¡ *
c_fmt
;

47 cÚ¡ *
am
;

48 cÚ¡ *
pm
;

49 cÚ¡ *
d©e_fmt
;

52 
size_t
 
¡ráime_tz
(*
s
, size_ˆ
max
, cÚ¡ *
fÜm©
, cÚ¡ 
tm
 *tm, cÚ¡ 
¡ráime_loÿË
 *
loÿË
);

56 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/uevent.h

17 #iâdeà
__CUTILS_UEVENT_H


18 
	#__CUTILS_UEVENT_H


	)

20 
	~<¡dboŞ.h
>

21 
	~<sys/sock‘.h
>

23 #ifdeà
__ılu¥lus


27 
uev’t_İ’_sock‘
(
buf_sz
, 
boŞ
 
·ssüed
);

28 
ssize_t
 
uev’t_k”Ãl_muÉiÿ¡_»cv
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
);

29 
ssize_t
 
uev’t_k”Ãl_muÉiÿ¡_uid_»cv
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
, 
uid_t
 *
uid
);

31 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/uio.h

20 #iâdeà
_LIBS_CUTILS_UIO_H


21 
	#_LIBS_CUTILS_UIO_H


	)

23 #ifdeà
HAVE_SYS_UIO_H


24 
	~<sys/uio.h
>

27 #ifdeà
__ılu¥lus


31 
	~<¡ddef.h
>

33 
	siovec
 {

34 cÚ¡ * 
iov_ba£
;

35 
size_t
 
iov_Ën
;

38 
»adv
Ğ
fd
, 
iovec
* 
vecs
, 
couÁ
 );

39 
wr™ev
Ğ
fd
, cÚ¡ 
iovec
* 
vecs
, 
couÁ
 );

41 #ifdeà
__ılu¥lus


	@libs/libcutils/cutils/zygote.h

17 #iâdeà
__CUTILS_ZYGOTE_H


18 
	#__CUTILS_ZYGOTE_H


	)

20 #ifdeà
__ılu¥lus


24 
zygÙe_run_ÚeshÙ
(
£ndStdio
, 
¬gc
, cÚ¡ **
¬gv
);

25 
zygÙe_run
(
¬gc
, cÚ¡ **
¬gv
);

26 
zygÙe_run_wa™
(
¬gc
, cÚ¡ **
¬gv
, (*
po¡_run_func
)());

28 #ifdeà
__ılu¥lus


	@libs/libcutils/debugger.c

17 
	~<¡dlib.h
>

18 
	~<uni¡d.h
>

20 
	~<cuts/debugg”.h
>

21 
	~<cuts/sock‘s.h
>

23 
	$dump_tomb¡Úe
(
pid_t
 
tid
, * 
·thbuf
, 
size_t
 
·thËn
) {

24 
s
 = 
	`sock‘_loÿl_ş›Á
(
DEBUGGER_SOCKET_NAME
,

25 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

26 ià(
s
 < 0) {

30 
debugg”_msg_t
 
msg
;

31 
msg
.
tid
 =id;

32 
msg
.
aùiÚ
 = 
DEBUGGER_ACTION_DUMP_TOMBSTONE
;

34 
»suÉ
 = 0;

35 ià(
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
s
, &
msg
, (msg))) != (msg)) {

36 
»suÉ
 = -1;

38 
ack
;

39 ià(
	`TEMP_FAILURE_RETRY
(
	`»ad
(
s
, &
ack
, 1)) != 1) {

40 
»suÉ
 = -1;

42 ià(
·thbuf
 && 
·thËn
) {

43 
ssize_t
 
n
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
s
, 
·thbuf
, 
·thËn
 - 1));

44 ià(
n
 <= 0) {

45 
»suÉ
 = -1;

47 
·thbuf
[
n
] = '\0';

52 
	`TEMP_FAILURE_RETRY
(
	`şo£
(
s
));

53  
»suÉ
;

54 
	}
}

56 
	$dump_backŒaû_to_fe
(
pid_t
 
tid
, 
fd
) {

57 
s
 = 
	`sock‘_loÿl_ş›Á
(
DEBUGGER_SOCKET_NAME
,

58 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

59 ià(
s
 < 0) {

63 
debugg”_msg_t
 
msg
;

64 
msg
.
tid
 =id;

65 
msg
.
aùiÚ
 = 
DEBUGGER_ACTION_DUMP_BACKTRACE
;

67 
»suÉ
 = 0;

68 ià(
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
s
, &
msg
, (msg))) != (msg)) {

69 
»suÉ
 = -1;

71 
ack
;

72 ià(
	`TEMP_FAILURE_RETRY
(
	`»ad
(
s
, &
ack
, 1)) != 1) {

73 
»suÉ
 = -1;

75 
bufãr
[4096];

76 
ssize_t
 
n
;

77 (
n
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
s
, 
bufãr
, (buffer)))) > 0) {

78 ià(
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
fd
, 
bufãr
, 
n
)) !=‚) {

79 
»suÉ
 = -1;

85 
	`TEMP_FAILURE_RETRY
(
	`şo£
(
s
));

86  
»suÉ
;

87 
	}
}

	@libs/libcutils/dir_hash.c

17 
	~<dœ’t.h
>

18 
	~<”ºo.h
>

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<sha1.h
>

23 
	~<uni¡d.h
>

24 
	~<lim™s.h
>

26 
	~<sys/¡©.h
>

28 
	~<Ãtš‘/š.h
>

29 
	~<»sŞv.h
>

31 
	~<cuts/dœ_hash.h
>

39 
	$g‘_fe_hash
(
HashAlgÜ™hm
 
®gÜ™hm
, cÚ¡ *
·th
,

40 *
ouut_¡ršg
, 
size_t
 
max_ouut_¡ršg
) {

41 
SHA1_CTX
 
cÚ‹xt
;

42 
¡©
 
sb
;

43 
md
[
SHA1_DIGEST_LENGTH
];

44 
u£d
;

45 
size_t
 
n
;

47 ià(
®gÜ™hm
 !ğ
SHA_1
) {

48 
”ºo
 = 
EINVAL
;

52 ià(
	`¡©
(
·th
, &
sb
) != 0) {

56 ià(
	`S_ISLNK
(
sb
.
¡_mode
)) {

57 
buf
[
PATH_MAX
];

58 
Ën
;

60 
Ën
 = 
	`»adlšk
(
·th
, 
buf
, (buf));

61 ià(
Ën
 < 0) {

65 
	`SHA1In™
(&
cÚ‹xt
);

66 
	`SHA1Upd©e
(&
cÚ‹xt
, (*è
buf
, 
Ën
);

67 
	`SHA1Fš®
(
md
, &
cÚ‹xt
);

68 } ià(
	`S_ISREG
(
sb
.
¡_mode
)) {

69 
buf
[10000];

70 
FILE
 *
f
 = 
	`fİ’
(
·th
, "rb");

71 
Ën
;

73 ià(
f
 =ğ
NULL
) {

77 
	`SHA1In™
(&
cÚ‹xt
);

79 (
Ën
 = 
	`ä—d
(
buf
, 1, (buf), 
f
)) > 0) {

80 
	`SHA1Upd©e
(&
cÚ‹xt
, (*è
buf
, 
Ën
);

83 ià(
	`ã¼Ü
(
f
)) {

84 
	`fşo£
(
f
);

88 
	`fşo£
(
f
);

89 
	`SHA1Fš®
(
md
, &
cÚ‹xt
);

92 ià(
	`S_ISLNK
(
sb
.
¡_mode
è|| 
	`S_ISREG
(sb.st_mode)) {

93 
u£d
 = 
	`b64_Áİ
(
md
, 
SHA1_DIGEST_LENGTH
,

94 
ouut_¡ršg
, 
max_ouut_¡ršg
);

95 ià(
u£d
 < 0) {

96 
”ºo
 = 
ENOSPC
;

100 
n
 = 
	`¢´štf
(
ouut_¡ršg
 + 
u£d
, 
max_ouut_¡ršg
 - used,

101 " %d 0%Ø%d %d", (è
sb
.
¡_size
, sb.
¡_mode
,

102 (è
sb
.
¡_uid
, (èsb.
¡_gid
);

104 
n
 = 
	`¢´štf
(
ouut_¡ršg
, 
max_ouut_¡ršg
,

105 "- - 0%Ø%d %d", 
sb
.
¡_mode
,

106 (è
sb
.
¡_uid
, (èsb.
¡_gid
);

109 ià(
n
 >ğ
max_ouut_¡ršg
 - 
u£d
) {

110 
”ºo
 = 
ENOSPC
;

111  -(
u£d
 + 
n
);

114  
u£d
 + 
n
;

115 
	}
}

117 
	sli¡
 {

118 *
	mÇme
;

119 
li¡
 *
	mÃxt
;

122 
	$cmp
(cÚ¡ *
a
, cÚ¡ *
b
) {

123 
li¡
 *cÚ¡ *
¿
 = 
a
;

124 
li¡
 *cÚ¡ *
rb
 = 
b
;

126  
	`¡rcmp
((*
¿
)->
Çme
, (*
rb
)->name);

127 
	}
}

129 
	$»cur£
(
HashAlgÜ™hm
 
®gÜ™hm
, cÚ¡ *
dœeùÜy_·th
,

130 
li¡
 **
out
) {

131 
li¡
 *li¡ = 
NULL
;

132 
li¡
 *
f
;

134 
dœ’t
 *
de
;

135 
DIR
 *
d
 = 
	`İ’dœ
(
dœeùÜy_·th
);

137 ià(
d
 =ğ
NULL
) {

141 (
de
 = 
	`»addœ
(
d
)è!ğ
NULL
) {

142 ià(
	`¡rcmp
(
de
->
d_Çme
, ".") == 0) {

145 ià(
	`¡rcmp
(
de
->
d_Çme
, "..") == 0) {

149 *
Çme
 = 
	`m®loc
(
	`¡¾’
(
de
->
d_Çme
) + 1);

150 
li¡
 *
node
 = 
	`m®loc
((list));

152 ià(
Çme
 =ğ
NULL
 || 
node
 == NULL) {

153 
li¡
 *
Ãxt
;

154 
f
 = 
li¡
; f !ğ
NULL
; f = 
Ãxt
) {

155 
Ãxt
 = 
f
->next;

156 
	`ä“
(
f
->
Çme
);

157 
	`ä“
(
f
);

160 
	`ä“
(
Çme
);

161 
	`ä“
(
node
);

165 
	`¡rıy
(
Çme
, 
de
->
d_Çme
);

167 
node
->
Çme
 =‚ame;

168 
node
->
Ãxt
 = 
li¡
;

169 
li¡
 = 
node
;

172 
	`şo£dœ
(
d
);

174 
f
 = 
li¡
; f !ğ
NULL
; f = f->
Ãxt
) {

175 
¡©
 
sb
;

176 *
Çme
;

177 
out¡r
[
NAME_MAX
 + 100];

178 *
k“p
;

179 
li¡
 *
»s
;

181 
Çme
 = 
	`m®loc
(
	`¡¾’
(
f
->Çmeè+ sŒËn(
dœeùÜy_·th
) + 2);

182 ià(
Çme
 =ğ
NULL
) {

183 
li¡
 *
Ãxt
;

184 
f
 = 
li¡
; f !ğ
NULL
; f = f->
Ãxt
) {

185 
Ãxt
 = 
f
->next;

186 
	`ä“
(
f
->
Çme
);

187 
	`ä“
(
f
);

189 
f
 = *
out
; f !ğ
NULL
; f = f->
Ãxt
) {

190 
Ãxt
 = 
f
->next;

191 
	`ä“
(
f
->
Çme
);

192 
	`ä“
(
f
);

194 *
out
 = 
NULL
;

198 
	`¥rštf
(
Çme
, "%s/%s", 
dœeùÜy_·th
, 
f
->name);

200 
Ën
 = 
	`g‘_fe_hash
(
®gÜ™hm
, 
Çme
,

201 
out¡r
, (outstr));

202 ià(
Ën
 < 0) {

207 
k“p
 = 
	`m®loc
(
Ën
 + 
	`¡¾’
(
Çme
) + 3);

208 
»s
 = 
	`m®loc
((
li¡
));

210 ià(
k“p
 =ğ
NULL
 || 
»s
 == NULL) {

211 
li¡
 *
Ãxt
;

212 
f
 = 
li¡
; f !ğ
NULL
; f = f->
Ãxt
) {

213 
Ãxt
 = 
f
->next;

214 
	`ä“
(
f
->
Çme
);

215 
	`ä“
(
f
);

217 
f
 = *
out
; f !ğ
NULL
; f = f->
Ãxt
) {

218 
Ãxt
 = 
f
->next;

219 
	`ä“
(
f
->
Çme
);

220 
	`ä“
(
f
);

222 *
out
 = 
NULL
;

224 
	`ä“
(
k“p
);

225 
	`ä“
(
»s
);

229 
	`¥rštf
(
k“p
, "% %s\n", 
Çme
, 
out¡r
);

231 
»s
->
Çme
 = 
k“p
;

232 
»s
->
Ãxt
 = *
out
;

233 *
out
 = 
»s
;

235 ià((
	`¡©
(
Çme
, &
sb
è=ğ0è&& 
	`S_ISDIR
(sb.
¡_mode
)) {

236 ià(
	`»cur£
(
®gÜ™hm
, 
Çme
, 
out
) < 0) {

237 
li¡
 *
Ãxt
;

238 
f
 = 
li¡
; f !ğ
NULL
; f = 
Ãxt
) {

239 
Ãxt
 = 
f
->next;

240 
	`ä“
(
f
->
Çme
);

241 
	`ä“
(
f
);

249 
li¡
 *
Ãxt
;

250 
f
 = 
li¡
; f !ğ
NULL
; f = 
Ãxt
) {

251 
Ãxt
 = 
f
->next;

253 
	`ä“
(
f
->
Çme
);

254 
	`ä“
(
f
);

256 
	}
}

264 
	$g‘_»cursive_hash_mªiã¡
(
HashAlgÜ™hm
 
®gÜ™hm
,

265 cÚ¡ *
dœeùÜy_·th
,

266 **
ouut_¡ršg
) {

267 
li¡
 *
out
 = 
NULL
;

268 
li¡
 *
r
;

269 
li¡
 **list;

270 
couÁ
 = 0;

271 
Ën
 = 0;

272 
»’
 = 0;

273 
i
;

274 *
buf
;

276 ià(
	`»cur£
(
®gÜ™hm
, 
dœeùÜy_·th
, &
out
) < 0) {

280 
r
 = 
out
;„ !ğ
NULL
;„ =„->
Ãxt
) {

281 
couÁ
++;

282 
Ën
 +ğ
	`¡¾’
(
r
->
Çme
);

285 
li¡
 = 
	`m®loc
(
couÁ
 * (list *));

286 ià(
li¡
 =ğ
NULL
) {

287 
li¡
 *
Ãxt
;

288 
r
 = 
out
;„ !ğ
NULL
;„ = 
Ãxt
) {

289 
Ãxt
 = 
r
->next;

290 
	`ä“
(
r
->
Çme
);

291 
	`ä“
(
r
);

296 
couÁ
 = 0;

297 
r
 = 
out
;„ !ğ
NULL
;„ =„->
Ãxt
) {

298 
li¡
[
couÁ
++] = 
r
;

301 
	`qsÜt
(
li¡
, 
couÁ
, (li¡ *), 
cmp
);

303 
buf
 = 
	`m®loc
(
Ën
 + 1);

304 ià(
buf
 =ğ
NULL
) {

305 
li¡
 *
Ãxt
;

306 
r
 = 
out
;„ !ğ
NULL
;„ = 
Ãxt
) {

307 
Ãxt
 = 
r
->next;

308 
	`ä“
(
r
->
Çme
);

309 
	`ä“
(
r
);

311 
	`ä“
(
li¡
);

315 
i
 = 0; i < 
couÁ
; i++) {

316 
n
 = 
	`¡¾’
(
li¡
[
i
]->
Çme
);

318 
	`¡rıy
(
buf
 + 
»’
, 
li¡
[
i
]->
Çme
);

319 
»’
 +ğ
n
;

322 
	`ä“
(
li¡
);

324 
li¡
 *
Ãxt
;

325 
r
 = 
out
;„ !ğ
NULL
;„ = 
Ãxt
) {

326 
Ãxt
 = 
r
->next;

328 
	`ä“
(
r
->
Çme
);

329 
	`ä“
(
r
);

332 *
ouut_¡ršg
 = 
buf
;

333  
»’
;

334 
	}
}

	@libs/libcutils/dlmalloc_stubs.c

17 
	~"../../../biÚic/libc/biÚic/dlm®loc.h
"

18 
	~"cuts/log.h
"

25 
dlm®loc_š¥eù_®l
((*
hªdËr
)(*, *, 
size_t
, *),

26 * 
¬g
)

28 
	`ALOGW
("Called host unimplemented stub: dlmalloc_inspect_all");

29 
	}
}

31 
	$dlm®loc_Œim
(
size_t
 
unu£d
)

33 
	`ALOGW
("Called host unimplemented stub: dlmalloc_trim");

35 
	}
}

	@libs/libcutils/fs.c

17 
	#LOG_TAG
 "cuts"

	)

19 
	~<cuts/fs.h
>

20 
	~<cuts/log.h
>

22 
	~<sys/ty³s.h
>

23 
	~<sys/¡©.h
>

24 
	~<fú.h
>

25 
	~<uni¡d.h
>

26 
	~<”ºo.h
>

27 
	~<¡ršg.h
>

28 
	~<lim™s.h
>

30 
	#ALL_PERMS
 (
S_ISUID
 | 
S_ISGID
 | 
S_ISVTX
 | 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
)

	)

31 
	#BUF_SIZE
 64

	)

33 
	$fs_´•¬e_dœ
(cÚ¡ * 
·th
, 
mode_t
 
mode
, 
uid_t
 
uid
, 
gid_t
 
gid
) {

35 
¡©
 
sb
;

36 ià(
	`TEMP_FAILURE_RETRY
(
	`l¡©
(
·th
, &
sb
)) == -1) {

37 ià(
”ºo
 =ğ
ENOENT
) {

38 
ü—‹
;

40 
	`ALOGE
("FaedØl¡©(%s): %s", 
·th
, 
	`¡»¼Ü
(
”ºo
));

46 ià(!
	`S_ISDIR
(
sb
.
¡_mode
)) {

47 
	`ALOGE
("NÙ‡ dœeùÜy: %s", 
·th
);

50 ià(((
sb
.
¡_mode
 & 
ALL_PERMS
è=ğ
mode
è&& (sb.
¡_uid
 =ğ
uid
è&& (sb.
¡_gid
 =ğ
gid
)) {

53 
fixup
;

56 
ü—‹
:

57 ià(
	`TEMP_FAILURE_RETRY
(
	`mkdœ
(
·th
, 
mode
)) == -1) {

58 ià(
”ºo
 !ğ
EEXIST
) {

59 
	`ALOGE
("FaedØmkdœ(%s): %s", 
·th
, 
	`¡»¼Ü
(
”ºo
));

64 
fixup
:

65 ià(
	`TEMP_FAILURE_RETRY
(
	`chmod
(
·th
, 
mode
)) == -1) {

66 
	`ALOGE
("FaedØchmod(%s, %d): %s", 
·th
, 
mode
, 
	`¡»¼Ü
(
”ºo
));

69 ià(
	`TEMP_FAILURE_RETRY
(
	`chown
(
·th
, 
uid
, 
gid
)) == -1) {

70 
	`ALOGE
("FaedØchown(%s, %d, %d): %s", 
·th
, 
uid
, 
gid
, 
	`¡»¼Ü
(
”ºo
));

75 
	}
}

77 
	$fs_»ad_©omic_št
(cÚ¡ * 
·th
, * 
out_v®ue
) {

78 
fd
 = 
	`TEMP_FAILURE_RETRY
(
	`İ’
(
·th
, 
O_RDONLY
));

79 ià(
fd
 == -1) {

80 
	`ALOGE
("FaedØ»ad %s: %s", 
·th
, 
	`¡»¼Ü
(
”ºo
));

84 
buf
[
BUF_SIZE
];

85 ià(
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
buf
, 
BUF_SIZE
)) == -1) {

86 
	`ALOGE
("FaedØ»ad %s: %s", 
·th
, 
	`¡»¼Ü
(
”ºo
));

87 
ç
;

89 ià(
	`ssÿnf
(
buf
, "%d", 
out_v®ue
) != 1) {

90 
	`ALOGE
("FaedØ·r£ %s: %s", 
·th
, 
	`¡»¼Ü
(
”ºo
));

91 
ç
;

93 
	`şo£
(
fd
);

96 
ç
:

97 
	`şo£
(
fd
);

98 *
out_v®ue
 = -1;

100 
	}
}

102 
	$fs_wr™e_©omic_št
(cÚ¡ * 
·th
, 
v®ue
) {

103 
‹mp
[
PATH_MAX
];

104 ià(
	`¢´štf
(
‹mp
, 
PATH_MAX
, "%s.XXXXXX", 
·th
) >= PATH_MAX) {

105 
	`ALOGE
("Pathoo†ong");

109 
fd
 = 
	`TEMP_FAILURE_RETRY
(
	`mk¡emp
(
‹mp
));

110 ià(
fd
 == -1) {

111 
	`ALOGE
("FaedØİ’ %s: %s", 
‹mp
, 
	`¡»¼Ü
(
”ºo
));

115 
buf
[
BUF_SIZE
];

116 
Ën
 = 
	`¢´štf
(
buf
, 
BUF_SIZE
, "%d", 
v®ue
) + 1;

117 ià(
Ën
 > 
BUF_SIZE
) {

118 
	`ALOGE
("V®u%doØÏrge: %s", 
v®ue
, 
	`¡»¼Ü
(
”ºo
));

119 
ç
;

121 ià(
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
fd
, 
buf
, 
Ën
)) <†en) {

122 
	`ALOGE
("FaedØwr™%s: %s", 
‹mp
, 
	`¡»¼Ü
(
”ºo
));

123 
ç
;

125 ià(
	`şo£
(
fd
) == -1) {

126 
	`ALOGE
("FaedØşo£ %s: %s", 
‹mp
, 
	`¡»¼Ü
(
”ºo
));

127 
ç_şo£d
;

130 ià(
	`»Çme
(
‹mp
, 
·th
) == -1) {

131 
	`ALOGE
("FaedØ»Çm% tØ%s: %s", 
‹mp
, 
·th
, 
	`¡»¼Ü
(
”ºo
));

132 
ç_şo£d
;

137 
ç
:

138 
	`şo£
(
fd
);

139 
ç_şo£d
:

140 
	`uÆšk
(
‹mp
);

142 
	}
}

	@libs/libcutils/hashmap.c

17 
	~<cuts/hashm­.h
>

18 
	~<as£¹.h
>

19 
	~<”ºo.h
>

20 
	~<cuts/th»ads.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dboŞ.h
>

24 
	~<sys/ty³s.h
>

26 
EÁry
 
	tEÁry
;

27 
	sEÁry
 {

28 * 
	mkey
;

29 
	mhash
;

30 * 
	mv®ue
;

31 
EÁry
* 
	mÃxt
;

34 
	sHashm­
 {

35 
EÁry
** 
	mbuck‘s
;

36 
size_t
 
	mbuck‘CouÁ
;

37 (*
	mhash
)(* 
	mkey
);

38 
boŞ
 (*
equ®s
)(* 
	mkeyA
, * 
	mkeyB
);

39 
mu‹x_t
 
	mlock
;

40 
size_t
 
	msize
;

43 
Hashm­
* 
hashm­C»©e
(
size_t
 
š™ŸlC­ac™y
,

44 (*
hash
)(* 
key
), 
	$boŞ
 (*
equ®s
)(* 
keyA
, * 
keyB
)) {

45 
	`as£¹
(
hash
 !ğ
NULL
);

46 
	`as£¹
(
equ®s
 !ğ
NULL
);

48 
Hashm­
* 
m­
 = 
	`m®loc
((Hashmap));

49 ià(
m­
 =ğ
NULL
) {

50  
NULL
;

54 
size_t
 
mšimumBuck‘CouÁ
 = 
š™ŸlC­ac™y
 * 4 / 3;

55 
m­
->
buck‘CouÁ
 = 1;

56 
m­
->
buck‘CouÁ
 <ğ
mšimumBuck‘CouÁ
) {

58 
m­
->
buck‘CouÁ
 <<= 1;

61 
m­
->
buck‘s
 = 
	`ÿÎoc
(m­->
buck‘CouÁ
, (
EÁry
*));

62 ià(
m­
->
buck‘s
 =ğ
NULL
) {

63 
	`ä“
(
m­
);

64  
NULL
;

67 
m­
->
size
 = 0;

69 
m­
->
hash
 = hash;

70 
m­
->
equ®s
 =ƒquals;

72 
	`mu‹x_š™
(&
m­
->
lock
);

74  
m­
;

75 
	}
}

80 
šlše
 
	$hashKey
(
Hashm­
* 
m­
, * 
key
) {

81 
h
 = 
m­
->
	`hash
(
key
);

85 
h
 += ~(h << 9);

86 
h
 ^= ((() h) >> 14);

87 
h
 += (h << 4);

88 
h
 ^= ((() h) >> 10);

90  
h
;

91 
	}
}

93 
size_t
 
	$hashm­Size
(
Hashm­
* 
m­
) {

94  
m­
->
size
;

95 
	}
}

97 
šlše
 
size_t
 
	$ÿlcuÏ‹Index
(
size_t
 
buck‘CouÁ
, 
hash
) {

98  ((
size_t
è
hash
è& (
buck‘CouÁ
 - 1);

99 
	}
}

101 
	$ex·ndIfNeûs§ry
(
Hashm­
* 
m­
) {

103 ià(
m­
->
size
 > (m­->
buck‘CouÁ
 * 3 / 4)) {

105 
size_t
 
ÃwBuck‘CouÁ
 = 
m­
->
buck‘CouÁ
 << 1;

106 
EÁry
** 
ÃwBuck‘s
 = 
	`ÿÎoc
(
ÃwBuck‘CouÁ
, (Entry*));

107 ià(
ÃwBuck‘s
 =ğ
NULL
) {

113 
size_t
 
i
;

114 
i
 = 0; i < 
m­
->
buck‘CouÁ
; i++) {

115 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
i
];

116 
’Œy
 !ğ
NULL
) {

117 
EÁry
* 
Ãxt
 = 
’Œy
->next;

118 
size_t
 
šdex
 = 
	`ÿlcuÏ‹Index
(
ÃwBuck‘CouÁ
, 
’Œy
->
hash
);

119 
’Œy
->
Ãxt
 = 
ÃwBuck‘s
[
šdex
];

120 
ÃwBuck‘s
[
šdex
] = 
’Œy
;

121 
’Œy
 = 
Ãxt
;

126 
	`ä“
(
m­
->
buck‘s
);

127 
m­
->
buck‘s
 = 
ÃwBuck‘s
;

128 
m­
->
buck‘CouÁ
 = 
ÃwBuck‘CouÁ
;

130 
	}
}

132 
	$hashm­Lock
(
Hashm­
* 
m­
) {

133 
	`mu‹x_lock
(&
m­
->
lock
);

134 
	}
}

136 
	$hashm­UÆock
(
Hashm­
* 
m­
) {

137 
	`mu‹x_uÆock
(&
m­
->
lock
);

138 
	}
}

140 
	$hashm­F»e
(
Hashm­
* 
m­
) {

141 
size_t
 
i
;

142 
i
 = 0; i < 
m­
->
buck‘CouÁ
; i++) {

143 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
i
];

144 
’Œy
 !ğ
NULL
) {

145 
EÁry
* 
Ãxt
 = 
’Œy
->next;

146 
	`ä“
(
’Œy
);

147 
’Œy
 = 
Ãxt
;

150 
	`ä“
(
m­
->
buck‘s
);

151 
	`mu‹x_de¡roy
(&
m­
->
lock
);

152 
	`ä“
(
m­
);

153 
	}
}

155 
	$hashm­Hash
(* 
key
, 
size_t
 
keySize
) {

156 
h
 = 
keySize
;

157 * 
d©a
 = (*è
key
;

158 
size_t
 
i
;

159 
i
 = 0; i < 
keySize
; i++) {

160 
h
 = h * 31 + *
d©a
;

161 
d©a
++;

163  
h
;

164 
	}
}

166 
EÁry
* 
	$ü—‹EÁry
(* 
key
, 
hash
, * 
v®ue
) {

167 
EÁry
* 
’Œy
 = 
	`m®loc
((Entry));

168 ià(
’Œy
 =ğ
NULL
) {

169  
NULL
;

171 
’Œy
->
key
 = key;

172 
’Œy
->
hash
 = hash;

173 
’Œy
->
v®ue
 = value;

174 
’Œy
->
Ãxt
 = 
NULL
;

175  
’Œy
;

176 
	}
}

178 
šlše
 
boŞ
 
equ®Keys
(* 
keyA
, 
hashA
, * 
keyB
, 
hashB
,

179 
	$boŞ
 (*
equ®s
)(*, *)) {

180 ià(
keyA
 =ğ
keyB
) {

181  
Œue
;

183 ià(
hashA
 !ğ
hashB
) {

184  
çl£
;

186  
	`equ®s
(
keyA
, 
keyB
);

187 
	}
}

189 * 
	$hashm­Put
(
Hashm­
* 
m­
, * 
key
, * 
v®ue
) {

190 
hash
 = 
	`hashKey
(
m­
, 
key
);

191 
size_t
 
šdex
 = 
	`ÿlcuÏ‹Index
(
m­
->
buck‘CouÁ
, 
hash
);

193 
EÁry
** 
p
 = &(
m­
->
buck‘s
[
šdex
]);

194 
Œue
) {

195 
EÁry
* 
cu¼’t
 = *
p
;

198 ià(
cu¼’t
 =ğ
NULL
) {

199 *
p
 = 
	`ü—‹EÁry
(
key
, 
hash
, 
v®ue
);

200 ià(*
p
 =ğ
NULL
) {

201 
”ºo
 = 
ENOMEM
;

202  
NULL
;

204 
m­
->
size
++;

205 
	`ex·ndIfNeûs§ry
(
m­
);

206  
NULL
;

210 ià(
	`equ®Keys
(
cu¼’t
->
key
, cu¼’t->
hash
, key, hash, 
m­
->
equ®s
)) {

211 * 
ŞdV®ue
 = 
cu¼’t
->
v®ue
;

212 
cu¼’t
->
v®ue
 = value;

213  
ŞdV®ue
;

217 
p
 = &
cu¼’t
->
Ãxt
;

219 
	}
}

221 * 
	$hashm­G‘
(
Hashm­
* 
m­
, * 
key
) {

222 
hash
 = 
	`hashKey
(
m­
, 
key
);

223 
size_t
 
šdex
 = 
	`ÿlcuÏ‹Index
(
m­
->
buck‘CouÁ
, 
hash
);

225 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
šdex
];

226 
’Œy
 !ğ
NULL
) {

227 ià(
	`equ®Keys
(
’Œy
->
key
,ƒÁry->
hash
, key, hash, 
m­
->
equ®s
)) {

228  
’Œy
->
v®ue
;

230 
’Œy
 =ƒÁry->
Ãxt
;

233  
NULL
;

234 
	}
}

236 
boŞ
 
	$hashm­CÚšsKey
(
Hashm­
* 
m­
, * 
key
) {

237 
hash
 = 
	`hashKey
(
m­
, 
key
);

238 
size_t
 
šdex
 = 
	`ÿlcuÏ‹Index
(
m­
->
buck‘CouÁ
, 
hash
);

240 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
šdex
];

241 
’Œy
 !ğ
NULL
) {

242 ià(
	`equ®Keys
(
’Œy
->
key
,ƒÁry->
hash
, key, hash, 
m­
->
equ®s
)) {

243  
Œue
;

245 
’Œy
 =ƒÁry->
Ãxt
;

248  
çl£
;

249 
	}
}

251 * 
hashm­Memoize
(
Hashm­
* 
m­
, * 
key
,

252 * (*
š™ŸlV®ue
)(* 
key
, * 
cÚ‹xt
), * context) {

253 
	ghash
 = 
hashKey
(
m­
, 
key
);

254 
size_t
 
	gšdex
 = 
ÿlcuÏ‹Index
(
m­
->
buck‘CouÁ
, 
hash
);

256 
EÁry
** 
	gp
 = &(
m­
->
buck‘s
[
šdex
]);

257 
	gŒue
) {

258 
EÁry
* 
	gcu¼’t
 = *
p
;

261 ià(
	gcu¼’t
 =ğ
NULL
) {

262 *
p
 = 
ü—‹EÁry
(
key
, 
hash
, 
NULL
);

263 ià(*
	gp
 =ğ
NULL
) {

264 
”ºo
 = 
ENOMEM
;

265  
	gNULL
;

267 * 
	gv®ue
 = 
š™ŸlV®ue
(
key
, 
cÚ‹xt
);

268 (*
	gp
)->
	gv®ue
 = 
v®ue
;

269 
	gm­
->
	gsize
++;

270 
ex·ndIfNeûs§ry
(
m­
);

271  
	gv®ue
;

275 ià(
equ®Keys
(
cu¼’t
->
key
, cu¼’t->
hash
, key, hash, 
m­
->
equ®s
)) {

276  
	gcu¼’t
->
	gv®ue
;

280 
	gp
 = &
cu¼’t
->
Ãxt
;

284 * 
	$hashm­Remove
(
Hashm­
* 
m­
, * 
key
) {

285 
hash
 = 
	`hashKey
(
m­
, 
key
);

286 
size_t
 
šdex
 = 
	`ÿlcuÏ‹Index
(
m­
->
buck‘CouÁ
, 
hash
);

289 
EÁry
** 
p
 = &(
m­
->
buck‘s
[
šdex
]);

290 
EÁry
* 
cu¼’t
;

291 (
cu¼’t
 = *
p
è!ğ
NULL
) {

292 ià(
	`equ®Keys
(
cu¼’t
->
key
, cu¼’t->
hash
, key, hash, 
m­
->
equ®s
)) {

293 * 
v®ue
 = 
cu¼’t
->value;

294 *
p
 = 
cu¼’t
->
Ãxt
;

295 
	`ä“
(
cu¼’t
);

296 
m­
->
size
--;

297  
v®ue
;

300 
p
 = &
cu¼’t
->
Ãxt
;

303  
NULL
;

304 
	}
}

306 
hashm­FÜEach
(
Hashm­
* 
m­
,

307 
	$boŞ
 (*
ÿÎback
)(* 
key
, * 
v®ue
, * 
cÚ‹xt
),

308 * 
cÚ‹xt
) {

309 
size_t
 
i
;

310 
i
 = 0; i < 
m­
->
buck‘CouÁ
; i++) {

311 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
i
];

312 
’Œy
 !ğ
NULL
) {

313 
EÁry
 *
Ãxt
 = 
’Œy
->next;

314 ià(!
	`ÿÎback
(
’Œy
->
key
,ƒÁry->
v®ue
, 
cÚ‹xt
)) {

317 
’Œy
 = 
Ãxt
;

320 
	}
}

322 
size_t
 
	$hashm­Cu¼’tC­ac™y
(
Hashm­
* 
m­
) {

323 
size_t
 
buck‘CouÁ
 = 
m­
->bucketCount;

324  
buck‘CouÁ
 * 3 / 4;

325 
	}
}

327 
size_t
 
	$hashm­CouÁCŞlisiÚs
(
Hashm­
* 
m­
) {

328 
size_t
 
cŞlisiÚs
 = 0;

329 
size_t
 
i
;

330 
i
 = 0; i < 
m­
->
buck‘CouÁ
; i++) {

331 
EÁry
* 
’Œy
 = 
m­
->
buck‘s
[
i
];

332 
’Œy
 !ğ
NULL
) {

333 ià(
’Œy
->
Ãxt
 !ğ
NULL
) {

334 
cŞlisiÚs
++;

336 
’Œy
 =ƒÁry->
Ãxt
;

339  
cŞlisiÚs
;

340 
	}
}

342 
	$hashm­IÁHash
(* 
key
) {

344  *((*è
key
);

345 
	}
}

347 
boŞ
 
	$hashm­IÁEqu®s
(* 
keyA
, * 
keyB
) {

348 
a
 = *((*è
keyA
);

349 
b
 = *((*è
keyB
);

350  
a
 =ğ
b
;

351 
	}
}

	@libs/libcutils/include/ashmem.h

12 #iâdeà
_LINUX_ASHMEM_H


13 
	#_LINUX_ASHMEM_H


	)

15 
	~<lšux/lim™s.h
>

16 
	~<lšux/ioùl.h
>

17 
	~<lšux/ty³s.h
>

18 
	#ASHMEM_NAME_LEN
 256

	)

20 
	#ASHMEM_NAME_DEF
 "dev/ashmem"

	)

23 
	#ASHMEM_NOT_PURGED
 0

	)

24 
	#ASHMEM_WAS_PURGED
 1

	)

27 
	#ASHMEM_IS_UNPINNED
 0

	)

28 
	#ASHMEM_IS_PINNED
 1

	)

30 
	sashmem_pš
 {

31 
__u32
 
	moff£t
;

32 
__u32
 
	mËn
;

35 
	#__ASHMEMIOC
 0x77

	)

37 
	#ASHMEM_SET_NAME
 
	`_IOW
(
__ASHMEMIOC
, 1, [
ASHMEM_NAME_LEN
])

	)

38 
	#ASHMEM_GET_NAME
 
	`_IOR
(
__ASHMEMIOC
, 2, [
ASHMEM_NAME_LEN
])

	)

39 
	#ASHMEM_SET_SIZE
 
	`_IOW
(
__ASHMEMIOC
, 3, 
size_t
)

	)

40 
	#ASHMEM_GET_SIZE
 
	`_IO
(
__ASHMEMIOC
, 4)

	)

41 
	#ASHMEM_SET_PROT_MASK
 
	`_IOW
(
__ASHMEMIOC
, 5, )

	)

42 
	#ASHMEM_GET_PROT_MASK
 
	`_IO
(
__ASHMEMIOC
, 6)

	)

43 
	#ASHMEM_PIN
 
	`_IOW
(
__ASHMEMIOC
, 7, 
ashmem_pš
)

	)

44 
	#ASHMEM_UNPIN
 
	`_IOW
(
__ASHMEMIOC
, 8, 
ashmem_pš
)

	)

45 
	#ASHMEM_GET_PIN_STATUS
 
	`_IO
(
__ASHMEMIOC
, 9)

	)

46 
	#ASHMEM_PURGE_ALL_CACHES
 
	`_IO
(
__ASHMEMIOC
, 10)

	)

	@libs/libcutils/iosched_policy.c

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<uni¡d.h
>

22 
	~<¡ršg.h
>

23 
	~<”ºo.h
>

24 
	~<fú.h
>

26 #ifdeà
HAVE_SCHED_H


28 
	~<cuts/iosched_pŞicy.h
>

30 
iİrio_£t
(
which
, 
who
, 
iİrio
);

33 
	mWHO_PROCESS
 = 1,

34 
	mWHO_PGRP
,

35 
	mWHO_USER
,

38 
	#CLASS_SHIFT
 13

	)

39 
	#IOPRIO_NORM
 4

	)

41 
	$ªdroid_£t_iİrio
(
pid
, 
IoSchedCÏss
 
şazz
, 
iİrio
) {

42 #ifdeà
HAVE_ANDROID_OS


43 ià(
	`iİrio_£t
(
WHO_PROCESS
, 
pid
, 
iİrio
 | (
şazz
 << 
CLASS_SHIFT
))) {

48 
	}
}

50 
	$ªdroid_g‘_iİrio
(
pid
, 
IoSchedCÏss
 *
şazz
, *
iİrio
) {

51 #ifdeà
HAVE_ANDROID_OS


52 
rc
;

54 ià((
rc
 = 
	`iİrio_g‘
(
WHO_PROCESS
, 
pid
)) < 0) {

58 *
şazz
 = (
rc
 >> 
CLASS_SHIFT
);

59 *
iİrio
 = (
rc
 & 0xff);

61 *
şazz
 = 
IoSchedCÏss_NONE
;

62 *
iİrio
 = 0;

65 
	}
}

	@libs/libcutils/klog.c

17 
	~<sys/¡©.h
>

18 
	~<sys/ty³s.h
>

19 
	~<fú.h
>

20 
	~<¡d¬g.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

26 
	~<cuts/klog.h
>

28 
	gklog_fd
 = -1;

29 
	gklog_Ëv–
 = 
KLOG_DEFAULT_LEVEL
;

31 
	$klog_£t_Ëv–
(
Ëv–
) {

32 
klog_Ëv–
 = 
Ëv–
;

33 
	}
}

35 
	$klog_š™
()

37 cÚ¡ *
Çme
 = "/dev/__kmsg__";

38 ià(
	`mknod
(
Çme
, 
S_IFCHR
 | 0600, (1 << 8) | 11) == 0) {

39 
klog_fd
 = 
	`İ’
(
Çme
, 
O_WRONLY
);

40 
	`fú
(
klog_fd
, 
F_SETFD
, 
FD_CLOEXEC
);

41 
	`uÆšk
(
Çme
);

43 
	}
}

45 
	#LOG_BUF_MAX
 512

	)

47 
	$klog_wr™e
(
Ëv–
, cÚ¡ *
fmt
, ...)

49 
buf
[
LOG_BUF_MAX
];

50 
va_li¡
 
­
;

52 ià(
Ëv–
 > 
klog_Ëv–
) ;

53 ià(
klog_fd
 < 0) ;

55 
	`va_¡¬t
(
­
, 
fmt
);

56 
	`v¢´štf
(
buf
, 
LOG_BUF_MAX
, 
fmt
, 
­
);

57 
buf
[
LOG_BUF_MAX
 - 1] = 0;

58 
	`va_’d
(
­
);

59 
	`wr™e
(
klog_fd
, 
buf
, 
	`¡¾’
(buf));

60 
	}
}

	@libs/libcutils/list.c

17 
	~<cuts/li¡.h
>

19 
	$li¡_š™
(
li¡node
 *
node
)

21 
node
->
Ãxt
 =‚ode;

22 
node
->
´ev
 =‚ode;

23 
	}
}

25 
	$li¡_add_
(
li¡node
 *
h—d
, li¡nod*
™em
)

27 
™em
->
Ãxt
 = 
h—d
;

28 
™em
->
´ev
 = 
h—d
->prev;

29 
h—d
->
´ev
->
Ãxt
 = 
™em
;

30 
h—d
->
´ev
 = 
™em
;

31 
	}
}

33 
	$li¡_»move
(
li¡node
 *
™em
)

35 
™em
->
Ãxt
->
´ev
 = item->prev;

36 
™em
->
´ev
->
Ãxt
 = item->next;

37 
	}
}

	@libs/libcutils/load_file.c

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<fú.h
>

22 *
	$lßd_fe
(cÚ¡ *
â
, *
_sz
)

24 *
d©a
;

25 
sz
;

26 
fd
;

28 
d©a
 = 0;

29 
fd
 = 
	`İ’
(
â
, 
O_RDONLY
);

30 if(
fd
 < 0)  0;

32 
sz
 = 
	`l£ek
(
fd
, 0, 
SEEK_END
);

33 if(
sz
 < 0è
oİs
;

35 if(
	`l£ek
(
fd
, 0, 
SEEK_SET
è!ğ0è
oİs
;

37 
d©a
 = (*è
	`m®loc
(
sz
 + 1);

38 if(
d©a
 =ğ0è
oİs
;

40 if(
	`»ad
(
fd
, 
d©a
, 
sz
è!ğszè
oİs
;

41 
	`şo£
(
fd
);

42 
d©a
[
sz
] = 0;

44 if(
_sz
è*_sz = 
sz
;

45  
d©a
;

47 
oİs
:

48 
	`şo£
(
fd
);

49 if(
d©a
 !ğ0è
	`ä“
(data);

51 
	}
}

	@libs/libcutils/loghack.h

21 #iâdeà
_CUTILS_LOGHACK_H


22 
	#_CUTILS_LOGHACK_H


	)

24 #ifdeà
HAVE_ANDROID_OS


25 
	~<cuts/log.h
>

27 
	~<¡dio.h
>

28 
	#ALOG
(
Ëv–
, ...) \

29 (()
	`´štf
("cuts:" 
Ëv–
 "/" 
LOG_TAG
 ": " 
__VA_ARGS__
))

	)

30 
	#ALOGV
(...è
	`ALOG
("V", 
__VA_ARGS__
)

	)

31 
	#ALOGD
(...è
	`ALOG
("D", 
__VA_ARGS__
)

	)

32 
	#ALOGI
(...è
	`ALOG
("I", 
__VA_ARGS__
)

	)

33 
	#ALOGW
(...è
	`ALOG
("W", 
__VA_ARGS__
)

	)

34 
	#ALOGE
(...è
	`ALOG
("E", 
__VA_ARGS__
)

	)

35 
	#LOG_ALWAYS_FATAL
(...èdØ{ 
	`ALOGE
(
__VA_ARGS__
); 
	`ex™
(1); } 0)

	)

	@libs/libcutils/memory.c

17 
	~<cuts/memÜy.h
>

19 #ià!
HAVE_MEMSET16


20 
	$ªdroid_mem£t16
(
ušt16_t
* 
d¡
, ušt16_ˆ
v®ue
, 
size_t
 
size
)

22 
size
 >>= 1;

23 
size
--) {

24 *
d¡
++ = 
v®ue
;

26 
	}
}

29 #ià!
HAVE_MEMSET32


30 
	$ªdroid_mem£t32
(
ušt32_t
* 
d¡
, ušt32_ˆ
v®ue
, 
size_t
 
size
)

32 
size
 >>= 2;

33 
size
--) {

34 *
d¡
++ = 
v®ue
;

36 
	}
}

39 #ià!
HAVE_STRLCPY


56 
	~<sys/ty³s.h
>

57 
	~<¡ršg.h
>

66 
size_t


67 
	$¡¾ıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
siz
)

69 *
d
 = 
d¡
;

70 cÚ¡ *
s
 = 
¤c
;

71 
size_t
 
n
 = 
siz
;

74 ià(
n
 != 0) {

75 --
n
 != 0) {

76 ià((*
d
++ = *
s
++) == '\0')

82 ià(
n
 == 0) {

83 ià(
siz
 != 0)

84 *
d
 = '\0';

85 *
s
++)

89 (
s
 - 
¤c
 - 1);

90 
	}
}

	@libs/libcutils/misc_rw.c

2 
	#LOG_TAG
 "misc_rw"

	)

4 
	~<uni¡d.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dio.h
>

8 
	~<”ºo.h
>

9 
	~<sys/ty³s.h
>

10 
	~<sys/¡©.h
>

11 
	~<fú.h
>

15 cÚ¡ *
	gMISC_DEVICE
 = "/dev/by-name/misc";

17 
	#LOGE
(...è
	`årštf
(
¡d”r
, "E:" 
__VA_ARGS__
)

	)

21 
	sboÙlßd”_mes§ge
 {

22 
	mcommªd
[32];

23 
	m¡©us
[32];

24 
	m»cov”y
[1024];

32 
	$g‘_mtd_·¹™iÚ_šdex_byÇme
(cÚ¡ * 
Çme
)

34 * 
lše
 = 
NULL
;

35 
size_t
 
Ën
 = 0;

36 
ssize_t
 
»ad
;

37 
šdex
 = 0;

38 
FILE
* 
å
;

39 
å
 = 
	`fİ’
("/proc/mtd","r");

40 if(
å
 =ğ
NULL
){

41 
	`LOGE
("İ’ /´oc/mtd faed(%s)\n",
	`¡»¼Ü
(
”ºo
));

44 (
»ad
 = 
	`g‘lše
(&
lše
, &
Ën
, 
å
)) != -1) {

45 ifĞ
	`¡r¡r
(
lše
,
Çme
è=ğ
NULL
 )

47 
šdex
 = 
lše
[3] - '0';

50 
	`ä“
(
lše
);

51  
šdex
;

52 
	}
}

53 
	$is_mmc_Ü_mtd
()

55 
·¹_šdex
 = 0;

56 
is_mtd
 = 
	`acûss
("/dev/mtd0", 
F_OK
);

57 if(
is_mtd
 == -1)

59 
·¹_šdex
 = 
	`g‘_mtd_·¹™iÚ_šdex_byÇme
("misc");

60  
·¹_šdex
;

61 
	}
}

63 
	$g‘_boÙlßd”_mes§ge_block
(
boÙlßd”_mes§ge
 *
out
,

64 cÚ¡ * 
misc
)

66 
deviû
[50];

67 
FILE
* 
f
;

68 
id
 = 
	`is_mmc_Ü_mtd
();

69 if(
id
 == 0){

70 
	`¡rıy
(
deviû
,
misc
);

73 
	`¥rštf
(
deviû
,"/dev/mtd%d",
id
);

76 
f
 = 
	`fİ’
(
deviû
, "rb");

77 ià(
f
 =ğ
NULL
) {

78 
	`LOGE
("Cª'ˆİ’ %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

81 
boÙlßd”_mes§ge
 
‹mp
;

82 
couÁ
 = 
	`ä—d
(&
‹mp
, Ñemp), 1, 
f
);

83 ià(
couÁ
 != 1) {

84 
	`LOGE
("Faed„—dšg %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

87 ià(
	`fşo£
(
f
) != 0) {

88 
	`LOGE
("Faed closšg %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

91 
	`memıy
(
out
, &
‹mp
, (temp));

93 
	}
}

95 
	$£t_boÙlßd”_mes§ge_block
(cÚ¡ 
boÙlßd”_mes§ge
 *
š
,

96 cÚ¡ * 
misc
)

98 
deviû
[50];

99 
FILE
* 
f
;

100 
id
 = 
	`is_mmc_Ü_mtd
();

101 if(
id
 == 0){

102 
	`¡rıy
(
deviû
,
misc
);

105 
	`¥rštf
(
deviû
,"/dev/mtd%d",
id
);

106 
	`sy¡em
("mtdƒrase misc");

109 
f
 = 
	`fİ’
(
deviû
,"wb");

110 ià(
f
 =ğ
NULL
) {

111 
	`LOGE
("Cª'ˆİ’ %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

114 
couÁ
 = 
	`fwr™e
(
š
, (*š), 1, 
f
);

115 ià(
couÁ
 != 1) {

116 
	`LOGE
("Faed wr™šg %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

119 
	`fsync
(
f
);

120 ià(
	`fşo£
(
f
) != 0) {

121 
	`LOGE
("Faed closšg %s\n(%s)\n", 
deviû
, 
	`¡»¼Ü
(
”ºo
));

125 
	}
}

127 
	$wr™e_misc
(*
»asÚ
){

129 if(
	`¡rcmp
(
»asÚ
,"efex") != 0){

133 
boÙlßd”_mes§ge
 
boÙ
, 
‹mp
;

135 
	`mem£t
(&
boÙ
, 0, (boot));

136 if(!
	`¡rcmp
("»cov”y",
»asÚ
)){

137 
»asÚ
 = "boot-recovery";

140 
	`¡rıy
(
boÙ
.
commªd
,
»asÚ
);

141 ià(
	`£t_boÙlßd”_mes§ge_block
(&
boÙ
, 
MISC_DEVICE
) )

145 
	`mem£t
(&
‹mp
, 0, (temp));

146 ià(
	`g‘_boÙlßd”_mes§ge_block
(&
‹mp
, 
MISC_DEVICE
))

149 ifĞ
	`memcmp
(&
boÙ
, &
‹mp
, (boot)) )

154 
	}
}

169 cÚ¡ *
	gCOMMAND_FILE
 = "/cache/recovery/command";

171 
	$go_upd©e_·ckage
(cÚ¡ *
·th
){

175 
	}
}

	@libs/libcutils/mq.c

17 
	#LOG_TAG
 "mq"

	)

19 
	~<as£¹.h
>

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<±h»ad.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<uni¡d.h
>

27 
	~<sys/sock‘.h
>

28 
	~<sys/ty³s.h
>

29 
	~<sys/un.h
>

30 
	~<sys/uio.h
>

32 
	~<cuts/¬¿y.h
>

33 
	~<cuts/hashm­.h
>

34 
	~<cuts/£ËùÜ.h
>

36 
	~"loghack.h
"

37 
	~"bufãr.h
"

40 
	#PEER_HISTORY
 (16)

	)

42 
sockaddr
 
	tSock‘Add»ss
;

43 
sockaddr_un
 
	tUnixAdd»ss
;

50 
pid_t
 
	mpid
;

51 
uid_t
 
	muid
;

52 
gid_t
 
	mgid
;

53 } 
	tC»d’tŸls
;

56 
	tBy‹sLi¡’”
(
	tC»d’tŸls
 
	tüed’tŸls
, * 
	tby‹s
, 
	tsize_t
 
	tsize
);

59 
	tD—thLi¡’”
(
	tpid_t
 
	tpid
);

64 
	mCONNECTION_REQUEST
,

67 
	mCONNECTION
,

70 
	mCONNECTION_ERROR
,

73 
	mBYTES
,

74 } 
	tPack‘Ty³
;

78 
	mREADING_HEADER
,

81 
	mACCEPTING_CONNECTION
,

84 
	mREADING_BYTES
,

85 } 
	tIÅutS‹
;

90 
Pack‘Ty³
 
	mty³
;

93 
size_t
 
	msize
;

96 
C»d’tŸls
 
	müed’tŸls
;

98 } 
	tH—d”
;

101 
OutgošgPack‘
 
	tOutgošgPack‘
;

102 
	sOutgošgPack‘
 {

104 
H—d”
 
	mh—d”
;

108 
	msock‘
;

111 
Bufãr
* 
	mby‹s
;

115 (*
	mä“
)(
OutgošgPack‘
* 
	m·ck‘
);

118 * 
	mcÚ‹xt
;

121 
OutgošgPack‘
* 
	mÃxtPack‘
;

125 
P“rProxy
 
	tP“rProxy
;

130 
pid_t
 
	mpid
;

138 
Hashm­
* 
	m³”Prox›s
;

141 
S–eùÜ
* 
	m£ËùÜ
;

144 
±h»ad_mu‹x_t
 
	mmu‹x
;

147 
boŞ
 
	mma¡”
;

150 
P“rProxy
* 
	mma¡”Proxy
;

153 
By‹sLi¡’”
* 
	mÚBy‹s
;

156 
D—thLi¡’”
* 
	mÚD—th
;

159 
pid_t
 
	md—dP“rs
[
PEER_HISTORY
];

160 
size_t
 
	md—dP“rCursÜ
;

161 } 
	tP“r
;

163 
	sP“rProxy
 {

165 
C»d’tŸls
 
	müed’tŸls
;

168 
IÅutS‹
 
	mšputS‹
;

169 
Bufãr
* 
	mšputBufãr
;

170 
P“rProxy
* 
	mcÚÃùšg
;

173 
S–eùabËFd
* 
	mfd
;

181 
OutgošgPack‘
* 
	mcu¼’tPack‘
;

182 
OutgošgPack‘
* 
	mÏ¡Pack‘
;

185 
Bufãr
 
	moutgošgH—d”
;

188 
boŞ
 
	mma¡”
;

191 
P“r
* 
	m³”
;

198 
Hashm­
* 
	mcÚÃùiÚs
;

202 cÚ¡ * 
	gMASTER_PATH
 = "/master.peer";

205 cÚ¡ 
C»d’tŸls
 
	gMASTER_CREDENTIALS
 = {0, 0, 0};

208 
P“rProxy
* 
³”ProxyC»©e
(
P“r
* 
³”
, 
C»d’tŸls
 
üed’tŸls
);

211 
	$£tNÚBlockšg
(
fd
) {

212 
æags
;

213 ià((
æags
 = 
	`fú
(
fd
, 
F_GETFL
, 0)) < 0) {

214 
	`LOG_ALWAYS_FATAL
("fú(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

216 ià(
	`fú
(
fd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) < 0) {

217 
	`LOG_ALWAYS_FATAL
("fú(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

219 
	}
}

222 
	$şo£W™hW¬nšg
(
fd
) {

223 
»suÉ
 = 
	`şo£
(
fd
);

224 ià(
»suÉ
 == -1) {

225 
	`ALOGW
("şo£(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

227 
	}
}

230 
	$pidHash
(* 
key
) {

231 
pid_t
* 
pid
 = (pid_t*è
key
;

232  (è(*
pid
);

233 
	}
}

236 
boŞ
 
	$pidEqu®s
(* 
keyA
, * 
keyB
) {

237 
pid_t
* 
a
 = (pid_t*è
keyA
;

238 
pid_t
* 
b
 = (pid_t*è
keyB
;

239  *
a
 =ğ*
b
;

240 
	}
}

243 
UnixAdd»ss
* 
	$g‘Ma¡”Add»ss
() {

244 
UnixAdd»ss
 
ma¡”Add»ss
;

245 
boŞ
 
š™Ÿlized
 = 
çl£
;

246 ià(
š™Ÿlized
 =ğ
çl£
) {

247 
ma¡”Add»ss
.
sun_çmy
 = 
AF_LOCAL
;

248 
	`¡rıy
(
ma¡”Add»ss
.
sun_·th
, 
MASTER_PATH
);

249 
š™Ÿlized
 = 
Œue
;

251  &
ma¡”Add»ss
;

252 
	}
}

255 
	$³”Lock
(
P“r
* 
³”
) {

256 
	`±h»ad_mu‹x_lock
(&
³”
->
mu‹x
);

257 
	}
}

260 
	$³”UÆock
(
P“r
* 
³”
) {

261 
	`±h»ad_mu‹x_uÆock
(&
³”
->
mu‹x
);

262 
	}
}

265 
	$outgošgPack‘F»e
(
OutgošgPack‘
* 
·ck‘
) {

266 
	`ALOGD
("Freeing outgoing…acket.");

267 
	`ä“
(
·ck‘
);

268 
	}
}

273 
	$³”ProxyEx³ùH—d”
(
P“rProxy
* 
³”Proxy
) {

274 
³”Proxy
->
šputS‹
 = 
READING_HEADER
;

275 
	`bufãrP»·»FÜR—d
(
³”Proxy
->
šputBufãr
, (
H—d”
));

276 
	}
}

279 
	$³”ProxyP»·»OutgošgH—d”
(
P“rProxy
* 
³”Proxy
) {

280 
³”Proxy
->
outgošgH—d”
.
d©a


281 ğ(*è&(
³”Proxy
->
cu¼’tPack‘
->
h—d”
);

282 
³”Proxy
->
outgošgH—d”
.
size
 = (
H—d”
);

283 
	`bufãrP»·»FÜWr™e
(&
³”Proxy
->
outgošgH—d”
);

284 
	}
}

287 
	$³”ProxyEnqueueOutgošgPack‘
(
P“rProxy
* 
³”Proxy
,

288 
OutgošgPack‘
* 
ÃwPack‘
) {

289 
ÃwPack‘
->
ÃxtPack‘
 = 
NULL
;

290 ià(
³”Proxy
->
cu¼’tPack‘
 =ğ
NULL
) {

292 
³”Proxy
->
cu¼’tPack‘
 = 
ÃwPack‘
;

293 
³”Proxy
->
Ï¡Pack‘
 = 
ÃwPack‘
;

295 
	`³”ProxyP»·»OutgošgH—d”
(
³”Proxy
);

297 
³”Proxy
->
Ï¡Pack‘
->
ÃxtPack‘
 = 
ÃwPack‘
;

299 
	}
}

302 
	$³”ProxyLockAndEnqueueOutgošgPack‘
(
P“rProxy
* 
³”Proxy
,

303 
OutgošgPack‘
* 
ÃwPack‘
) {

304 
P“r
* 
³”
 = 
³”Proxy
->peer;

305 
	`³”Lock
(
³”
);

306 
	`³”ProxyEnqueueOutgošgPack‘
(
³”Proxy
, 
ÃwPack‘
);

307 
	`³”UÆock
(
³”
);

308 
	}
}

314 
boŞ
 
	$³”ProxyNextPack‘
(
P“rProxy
* 
³”Proxy
) {

315 
P“r
* 
³”
 = 
³”Proxy
->peer;

316 
	`³”Lock
(
³”
);

318 
OutgošgPack‘
* 
cu¼’t
 = 
³”Proxy
->
cu¼’tPack‘
;

320 ià(
cu¼’t
 =ğ
NULL
) {

322 
	`³”UÆock
(
³”
);

323  
çl£
;

326 
OutgošgPack‘
* 
Ãxt
 = 
cu¼’t
->
ÃxtPack‘
;

327 
³”Proxy
->
cu¼’tPack‘
 = 
Ãxt
;

328 
cu¼’t
->
ÃxtPack‘
 = 
NULL
;

329 
cu¼’t
->
	`ä“
(current);

330 ià(
Ãxt
 =ğ
NULL
) {

332 
³”Proxy
->
Ï¡Pack‘
 = 
NULL
;

333 
	`³”UÆock
(
³”
);

334  
çl£
;

336 
	`³”UÆock
(
³”
);

337 
	`³”ProxyP»·»OutgošgH—d”
(
³”Proxy
);

341  
Œue
;

343 
	}
}

348 
boŞ
 
	$³”IsD—d
(
P“r
* 
³”
, 
pid_t
 
pid
) {

349 
size_t
 
i
;

350 
i
 = 0; i < 
PEER_HISTORY
; i++) {

351 
pid_t
 
d—dP“r
 = 
³”
->
d—dP“rs
[
i
];

352 ià(
d—dP“r
 == 0) {

353  
çl£
;

355 ià(
d—dP“r
 =ğ
pid
) {

356  
Œue
;

359  
çl£
;

360 
	}
}

365 
boŞ
 
	$³”ProxyRemoveCÚÃùiÚ
(* 
key
, * 
v®ue
, * 
cÚ‹xt
) {

366 
P“rProxy
* 
d—dP“r
 = (P“rProxy*è
cÚ‹xt
;

367 
P“rProxy
* 
Ùh”P“r
 = (P“rProxy*è
v®ue
;

368 
	`hashm­Remove
(
Ùh”P“r
->
cÚÃùiÚs
, &(
d—dP“r
->
üed’tŸls
.
pid
));

369  
Œue
;

370 
	}
}

375 
	$³”ProxyKl
(
P“rProxy
* 
³”Proxy
, 
boŞ
 
”ºoIsS‘
) {

376 ià(
”ºoIsS‘
) {

377 
	`ALOGI
("P“¸%d d›d.ƒ¼no: %s", 
³”Proxy
->
üed’tŸls
.
pid
,

378 
	`¡»¼Ü
(
”ºo
));

380 
	`ALOGI
("P“¸%d d›d.", 
³”Proxy
->
üed’tŸls
.
pid
);

384 ià(
³”Proxy
->
ma¡”
) {

385 
	`LOG_ALWAYS_FATAL
("Lost connectiono master.");

388 
P“r
* 
loÿlP“r
 = 
³”Proxy
->
³”
;

389 
pid_t
 
pid
 = 
³”Proxy
->
üed’tŸls
.pid;

391 
	`³”Lock
(
loÿlP“r
);

394 
loÿlP“r
->
d—dP“rs
[loÿlP“r->
d—dP“rCursÜ
]

395 ğ
³”Proxy
->
üed’tŸls
.
pid
;

396 
loÿlP“r
->
d—dP“rCursÜ
++;

397 ià(
loÿlP“r
->
d—dP“rCursÜ
 =ğ
PEER_HISTORY
) {

398 
loÿlP“r
->
d—dP“rCursÜ
 = 0;

402 
	`hashm­Remove
(
loÿlP“r
->
³”Prox›s
, &
pid
);

406 
	`³”UÆock
(
loÿlP“r
);

409 ià(
³”Proxy
->
fd
 !ğ
NULL
) {

410 
³”Proxy
->
fd
->
»move
 = 
Œue
;

414 
	`³”ProxyNextPack‘
(
³”Proxy
)) {}

416 
	`bufãrF»e
(
³”Proxy
->
šputBufãr
);

419 ià(
³”Proxy
->
cÚÃùiÚs
 !ğ
NULL
) {

421 
	`hashm­FÜEach
(
³”Proxy
->
cÚÃùiÚs
, &
³”ProxyRemoveCÚÃùiÚ
,

422 
³”Proxy
);

423 
	`hashm­F»e
(
³”Proxy
->
cÚÃùiÚs
);

427 
loÿlP“r
->
	`ÚD—th
(
pid
);

430 
	`ä“
(
³”Proxy
);

431 
	}
}

433 
	$³”ProxyHªdËE¼Ü
(
P“rProxy
* 
³”Proxy
, * 
funùiÚName
) {

434 ià(
”ºo
 =ğ
EINTR
) {

436 
	`ALOGW
("%s(èš‹¼u±ed.", 
funùiÚName
);

437 } ià(
”ºo
 =ğ
EAGAIN
) {

438 
	`ALOGD
("EWOULDBLOCK");

441 
	`ALOGW
("E¼Ü„‘uºed by %s().", 
funùiÚName
);

442 
	`³”ProxyKl
(
³”Proxy
, 
Œue
);

444 
	}
}

450 
boŞ
 
	$³”ProxyWr™eFromBufãr
(
P“rProxy
* 
³”Proxy
, 
Bufãr
* 
outgošg
) {

451 
ssize_t
 
size
 = 
	`bufãrWr™e
(
outgošg
, 
³”Proxy
->
fd
->fd);

452 ià(
size
 < 0) {

453 
	`³”ProxyHªdËE¼Ü
(
³”Proxy
, "write");

454  
çl£
;

456  
	`bufãrWr™eCom¶‘e
(
outgošg
);

458 
	}
}

461 
	$³”ProxyWr™eBy‹s
(
P“rProxy
* 
³”Proxy
) {

462 
Bufãr
* 
bufãr
 = 
³”Proxy
->
cu¼’tPack‘
->
by‹s
;

463 ià(
	`³”ProxyWr™eFromBufãr
(
³”Proxy
, 
bufãr
)) {

464 
	`ALOGD
("Bytes written.");

465 
	`³”ProxyNextPack‘
(
³”Proxy
);

467 
	}
}

470 
	$³”ProxyWr™eCÚÃùiÚ
(
P“rProxy
* 
³”Proxy
) {

471 
sock‘
 = 
³”Proxy
->
cu¼’tPack‘
->socket;

474 
msghdr
 
msg
;

475 
iovec
 
iov
[1];

478 
cmsghdr
 
cm
;

479 
cÚŒŞ
[
	`CMSG_SPACE
(())];

480 } 
cÚŒŞ_un
;

482 
cmsghdr
 *
cm±r
;

484 
msg
.
msg_cÚŒŞ
 = 
cÚŒŞ_un
.
cÚŒŞ
;

485 
msg
.
msg_cÚŒŞËn
 = (
cÚŒŞ_un
.
cÚŒŞ
);

486 
cm±r
 = 
	`CMSG_FIRSTHDR
(&
msg
);

487 
cm±r
->
cmsg_Ën
 = 
	`CMSG_LEN
(());

488 
cm±r
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

489 
cm±r
->
cmsg_ty³
 = 
SCM_RIGHTS
;

492 *((*è
	`CMSG_DATA
(
cm±r
)èğ
³”Proxy
->
cu¼’tPack‘
->
sock‘
;

494 
msg
.
msg_Çme
 = 
NULL
;

495 
msg
.
msg_Çm–’
 = 0;

496 
iov
[0].
iov_ba£
 = "";

497 
iov
[0].
iov_Ën
 = 1;

498 
msg
.
msg_iov
 = 
iov
;

499 
msg
.
msg_iovËn
 = 1;

501 
ssize_t
 
»suÉ
 = 
	`£ndmsg
(
³”Proxy
->
fd
->fd, &
msg
, 0);

503 ià(
»suÉ
 < 0) {

504 
	`³”ProxyHªdËE¼Ü
(
³”Proxy
, "sendmsg");

507 
	`³”ProxyNextPack‘
(
³”Proxy
);

510 
	}
}

515 
	$³”ProxyWr™e
(
S–eùabËFd
* 
fd
) {

518 
P“rProxy
* 
³”Proxy
 = (P“rProxy*è
fd
->
d©a
;

519 
OutgošgPack‘
* 
cu¼’t
 = 
³”Proxy
->
cu¼’tPack‘
;

521 ià(
cu¼’t
 =ğ
NULL
) {

527 
Bufãr
* 
outgošgH—d”
 = &
³”Proxy
->outgoingHeader;

528 
boŞ
 
h—d”Wr™‹n
 = 
	`bufãrWr™eCom¶‘e
(
outgošgH—d”
);

529 ià(!
h—d”Wr™‹n
) {

530 
	`ALOGD
("Writing header...");

531 
h—d”Wr™‹n
 = 
	`³”ProxyWr™eFromBufãr
(
³”Proxy
, 
outgošgH—d”
);

532 ià(
h—d”Wr™‹n
) {

533 
	`ALOGD
("Header written.");

538 ià(
h—d”Wr™‹n
) {

539 
Pack‘Ty³
 
ty³
 = 
cu¼’t
->
h—d”
.type;

540 
ty³
) {

541 
CONNECTION
:

542 
	`³”ProxyWr™eCÚÃùiÚ
(
³”Proxy
);

544 
BYTES
:

545 
	`³”ProxyWr™eBy‹s
(
³”Proxy
);

547 
CONNECTION_REQUEST
:

548 
CONNECTION_ERROR
:

550 
	`³”ProxyNextPack‘
(
³”Proxy
);

553 
	`LOG_ALWAYS_FATAL
("UnknowÀ·ck‘y³: %d", 
ty³
);

556 
	}
}

561 
	$³”ProxyBefÜeS–eù
(
S–eùabËFd
* 
fd
) {

562 
	`ALOGD
("Before select...");

564 
P“rProxy
* 
³”Proxy
 = (P“rProxy*è
fd
->
d©a
;

566 
	`³”Lock
(
³”Proxy
->
³”
);

567 
boŞ
 
hasPack‘s
 = 
³”Proxy
->
cu¼’tPack‘
 !ğ
NULL
;

568 
	`³”UÆock
(
³”Proxy
->
³”
);

570 ià(
hasPack‘s
) {

571 
	`ALOGD
("Packets found. Setting onWritable().");

573 
fd
->
ÚWr™abË
 = &
³”ProxyWr™e
;

576 
fd
->
ÚWr™abË
 = 
NULL
;

578 
	}
}

581 
	$³”ProxyEx³ùBy‹s
(
P“rProxy
* 
³”Proxy
, 
H—d”
* 
h—d”
) {

582 
	`ALOGD
("Ex³ùšg %d by‹s.", 
h—d”
->
size
);

584 
³”Proxy
->
šputS‹
 = 
READING_BYTES
;

585 ià(
	`bufãrP»·»FÜR—d
(
³”Proxy
->
šputBufãr
, 
h—d”
->
size
) == -1) {

586 
	`ALOGW
("Couldn't‡llocate memory for incoming data. Size: %u",

587 (è
h—d”
->
size
);

590 
	`³”ProxyKl
(
³”Proxy
, 
çl£
);

592 
	}
}

601 
P“rProxy
* 
	$³”ProxyG‘OrC»©e
(
P“r
* 
³”
, 
pid_t
 
pid
,

602 
boŞ
 
»que¡CÚÃùiÚ
) {

603 ià(
pid
 =ğ
³”
->pid) {

604 
”ºo
 = 
EINVAL
;

605  
NULL
;

608 ià(
	`³”IsD—d
(
³”
, 
pid
)) {

609 
”ºo
 = 
EHOSTDOWN
;

610  
NULL
;

613 
P“rProxy
* 
³”Proxy
 = 
	`hashm­G‘
(
³”
->
³”Prox›s
, &
pid
);

614 ià(
³”Proxy
 !ğ
NULL
) {

615  
³”Proxy
;

619 ià(
³”
->
ma¡”
) {

620 
”ºo
 = 
EHOSTDOWN
;

621  
NULL
;

625 
C»d’tŸls
 
üed’tŸls
;

626 
üed’tŸls
.
pid
 =…id;

631 
üed’tŸls
.
uid
 = 0;

632 
üed’tŸls
.
gid
 = 0;

635 
OutgošgPack‘
* 
·ck‘
 = 
NULL
;

636 ià(
»que¡CÚÃùiÚ
) {

637 
·ck‘
 = 
	`ÿÎoc
(1, (
OutgošgPack‘
));

638 ià(
·ck‘
 =ğ
NULL
) {

639 
”ºo
 = 
ENOMEM
;

640  
NULL
;

643 
·ck‘
->
h—d”
.
ty³
 = 
CONNECTION_REQUEST
;

644 
·ck‘
->
h—d”
.
üed’tŸls
 = credentials;

645 
·ck‘
->
ä“
 = &
outgošgPack‘F»e
;

648 
³”Proxy
 = 
	`³”ProxyC»©e
(
³”
, 
üed’tŸls
);

649 ià(
³”Proxy
 =ğ
NULL
) {

650 
	`ä“
(
·ck‘
);

651 
”ºo
 = 
ENOMEM
;

652  
NULL
;

655 ià(
»que¡CÚÃùiÚ
) {

656 
P“rProxy
* 
ma¡”Proxy
 = 
³”
->masterProxy;

657 
	`³”ProxyEnqueueOutgošgPack‘
(
ma¡”Proxy
, 
·ck‘
);

660  
³”Proxy
;

662 
	}
}

668 
	$ma¡”ProxyEx³ùCÚÃùiÚ
(
P“rProxy
* 
ma¡”Proxy
,

669 
H—d”
* 
h—d”
) {

672 ià(!
ma¡”Proxy
->
ma¡”
) {

673 
	`ALOGW
("Non-master…rocess %driedo send us‡ connection.",

674 
ma¡”Proxy
->
üed’tŸls
.
pid
);

676 
	`³”ProxyKl
(
ma¡”Proxy
, 
çl£
);

680 
ma¡”Proxy
->
šputS‹
 = 
ACCEPTING_CONNECTION
;

681 
P“r
* 
loÿlP“r
 = 
ma¡”Proxy
->
³”
;

685 
pid_t
 
pid
 = 
h—d”
->
üed’tŸls
.pid;

686 
	`³”Lock
(
loÿlP“r
);

687 
P“rProxy
* 
³”Proxy
 = 
	`³”ProxyG‘OrC»©e
(
loÿlP“r
, 
pid
, 
çl£
);

688 ià(
³”Proxy
 =ğ
NULL
) {

689 
	`ALOGW
("P“¸´oxy c»©iÚ faed: %s", 
	`¡»¼Ü
(
”ºo
));

692 
³”Proxy
->
üed’tŸls
 = 
h—d”
->credentials;

694 
	`³”UÆock
(
loÿlP“r
);

697 
ma¡”Proxy
->
cÚÃùšg
 = 
³”Proxy
;

698 
	}
}

703 
³”ProxyR—d
(
S–eùabËFd
* 
fd
);

706 
	$³”ProxyS‘Fd
(
P“rProxy
* 
³”Proxy
, 
S–eùabËFd
* 
fd
) {

707 
³”Proxy
->
fd
 = fd;

708 
fd
->
d©a
 = 
³”Proxy
;

709 
fd
->
ÚR—dabË
 = &
³”ProxyR—d
;

710 
fd
->
befÜeS–eù
 = &
³”ProxyBefÜeS–eù
;

713 
	`£tNÚBlockšg
(
fd
->fd);

714 
	}
}

719 
	$ma¡”ProxyAcû±CÚÃùiÚ
(
P“rProxy
* 
ma¡”Proxy
) {

720 
msghdr
 
msg
;

721 
iovec
 
iov
[1];

722 
ssize_t
 
size
;

723 
ignÜed
;

724 
šcomšgFd
;

729 
cmsghdr
 
cm
;

730 
cÚŒŞ
[
	`CMSG_SPACE
(())];

731 } 
cÚŒŞ_un
;

732 
cmsghdr
 *
cm±r
;

733 
msg
.
msg_cÚŒŞ
 = 
cÚŒŞ_un
.
cÚŒŞ
;

734 
msg
.
msg_cÚŒŞËn
 = (
cÚŒŞ_un
.
cÚŒŞ
);

736 
msg
.
msg_Çme
 = 
NULL
;

737 
msg
.
msg_Çm–’
 = 0;

740 
iov
[0].
iov_ba£
 = &
ignÜed
;

741 
iov
[0].
iov_Ën
 = 1;

742 
msg
.
msg_iov
 = 
iov
;

743 
msg
.
msg_iovËn
 = 1;

745 
size
 = 
	`»cvmsg
(
ma¡”Proxy
->
fd
->fd, &
msg
, 0);

746 ià(
size
 < 0) {

747 ià(
”ºo
 =ğ
EINTR
) {

749 
	`ALOGW
("recvmsg() interrupted.");

751 } ià(
”ºo
 =ğ
EAGAIN
) {

755 
	`LOG_ALWAYS_FATAL
("Error„eading connection from master: %s",

756 
	`¡»¼Ü
(
”ºo
));

758 } ià(
size
 == 0) {

760 
	`LOG_ALWAYS_FATAL
("Received EOF from master.");

764 ià((
cm±r
 = 
	`CMSG_FIRSTHDR
(&
msg
)è!ğ
NULL


765 && 
cm±r
->
cmsg_Ën
 =ğ
	`CMSG_LEN
(())) {

766 ià(
cm±r
->
cmsg_Ëv–
 !ğ
SOL_SOCKET
) {

767 
	`LOG_ALWAYS_FATAL
("Expected SOL_SOCKET.");

769 ià(
cm±r
->
cmsg_ty³
 !ğ
SCM_RIGHTS
) {

770 
	`LOG_ALWAYS_FATAL
("Expected SCM_RIGHTS.");

772 
šcomšgFd
 = *((*è
	`CMSG_DATA
(
cm±r
));

774 
	`LOG_ALWAYS_FATAL
("Expected fd.");

778 
P“rProxy
* 
³”Proxy
 = 
ma¡”Proxy
->
cÚÃùšg
;

779 ià(
³”Proxy
 =ğ
NULL
) {

780 
	`ALOGW
("Received connection for unknown…eer.");

781 
	`şo£W™hW¬nšg
(
šcomšgFd
);

783 
P“r
* 
³”
 = 
ma¡”Proxy
->peer;

785 
S–eùabËFd
* 
£ËùabËFd
 = 
	`£ËùÜAdd
(
³”
->
£ËùÜ
, 
šcomšgFd
);

786 ià(
£ËùabËFd
 =ğ
NULL
) {

787 
	`ALOGW
("Error‡dding fdo selector for %d.",

788 
³”Proxy
->
üed’tŸls
.
pid
);

789 
	`şo£W™hW¬nšg
(
šcomšgFd
);

790 
	`³”ProxyKl
(
³”Proxy
, 
çl£
);

793 
	`³”ProxyS‘Fd
(
³”Proxy
, 
£ËùabËFd
);

796 
	`³”ProxyEx³ùH—d”
(
ma¡”Proxy
);

797 
	}
}

802 
	$outgošgPack‘F»eSock‘
(
OutgošgPack‘
* 
·ck‘
) {

803 
	`şo£W™hW¬nšg
(
·ck‘
->
sock‘
);

804 
	`outgošgPack‘F»e
(
·ck‘
);

805 
	}
}

810 
	$ma¡”CÚÃùP“rs
(
P“rProxy
* 
³”A
, P“rProxy* 
³”B
) {

811 
sock‘s
[2];

812 
»suÉ
 = 
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
sock‘s
);

813 ià(
»suÉ
 == -1) {

814 
	`ALOGW
("sock‘·œ(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

819 
OutgošgPack‘
* 
·ck‘A
 = 
	`ÿÎoc
(1, (OutgoingPacket));

820 
OutgošgPack‘
* 
·ck‘B
 = 
	`ÿÎoc
(1, (OutgoingPacket));

821 ià(
·ck‘A
 =ğ
NULL
 || 
·ck‘B
 == NULL) {

822 
	`ä“
(
·ck‘A
);

823 
	`ä“
(
·ck‘B
);

824 
	`ALOGW
("malloc()ƒrror. Failedoell…rocess %dhat…rocess %d is"

825 " d—d.", 
³”A
->
üed’tŸls
.
pid
, 
³”B
->credentials.pid);

829 
·ck‘A
->
h—d”
.
ty³
 = 
CONNECTION
;

830 
·ck‘B
->
h—d”
.
ty³
 = 
CONNECTION
;

832 
·ck‘A
->
h—d”
.
üed’tŸls
 = 
³”B
->credentials;

833 
·ck‘B
->
h—d”
.
üed’tŸls
 = 
³”A
->credentials;

835 
·ck‘A
->
sock‘
 = 
sock‘s
[0];

836 
·ck‘B
->
sock‘
 = 
sock‘s
[1];

838 
·ck‘A
->
ä“
 = &
outgošgPack‘F»eSock‘
;

839 
·ck‘B
->
ä“
 = &
outgošgPack‘F»eSock‘
;

841 
	`³”Lock
(
³”A
->
³”
);

842 
	`³”ProxyEnqueueOutgošgPack‘
(
³”A
, 
·ck‘A
);

843 
	`³”ProxyEnqueueOutgošgPack‘
(
³”B
, 
·ck‘B
);

844 
	`³”UÆock
(
³”A
->
³”
);

845 
	}
}

851 
	$ma¡”R•ÜtCÚÃùiÚE¼Ü
(
P“rProxy
* 
³”Proxy
,

852 
C»d’tŸls
 
üed’tŸls
) {

853 
OutgošgPack‘
* 
·ck‘
 = 
	`ÿÎoc
(1, (OutgoingPacket));

854 ià(
·ck‘
 =ğ
NULL
) {

855 
	`ALOGW
("malloc()ƒrror. Failedoell…rocess %dhat…rocess %d is"

856 " d—d.", 
³”Proxy
->
üed’tŸls
.
pid
, credentials.pid);

860 
·ck‘
->
h—d”
.
ty³
 = 
CONNECTION_ERROR
;

861 
·ck‘
->
h—d”
.
üed’tŸls
 = credentials;

862 
·ck‘
->
ä“
 = &
outgošgPack‘F»e
;

864 
	`³”ProxyLockAndEnqueueOutgošgPack‘
(
³”Proxy
, 
·ck‘
);

865 
	}
}

870 
	$ma¡”HªdËCÚÃùiÚReque¡
(
P“rProxy
* 
³”Proxy
,

871 
H—d”
* 
h—d”
) {

872 
P“r
* 
ma¡”
 = 
³”Proxy
->
³”
;

873 
pid_t
 
rg‘Pid
 = 
h—d”
->
üed’tŸls
.
pid
;

874 ià(!
	`hashm­CÚšsKey
(
³”Proxy
->
cÚÃùiÚs
, &
rg‘Pid
)) {

876 
P“rProxy
* 
rg‘P“r


877 ğ(
P“rProxy
*è
	`hashm­G‘
(
ma¡”
->
³”Prox›s
, &
rg‘Pid
);

878 ià(
rg‘P“r
 =ğ
NULL
) {

880 
	`ma¡”R•ÜtCÚÃùiÚE¼Ü
(
³”Proxy
, 
h—d”
->
üed’tŸls
);

882 
	`ma¡”CÚÃùP“rs
(
³”Proxy
, 
rg‘P“r
);

887 
	`³”ProxyEx³ùH—d”
(
³”Proxy
);

888 
	}
}

893 
	$ma¡”ProxyHªdËCÚÃùiÚE¼Ü
(
P“rProxy
* 
ma¡”Proxy
,

894 
H—d”
* 
h—d”
) {

895 
P“r
* 
³”
 = 
ma¡”Proxy
->peer;

898 
pid_t
 
pid
 = 
h—d”
->
üed’tŸls
.pid;

899 
P“rProxy
* 
³”Proxy
 = 
NULL
;

900 
	`³”Lock
(
³”
);

901 
³”Proxy
 = 
	`hashm­G‘
(
³”
->
³”Prox›s
, &
pid
);

902 
	`³”UÆock
(
³”
);

904 ià(
³”Proxy
 !ğ
NULL
) {

905 
	`ALOGI
("Couldn'ˆcÚÃùØ%d.", 
pid
);

906 
	`³”ProxyKl
(
³”Proxy
, 
çl£
);

908 
	`ALOGW
("P“¸´oxy fÜ %d‚Ù found. Thi shouldn'ˆh­³n.", 
pid
);

911 
	`³”ProxyEx³ùH—d”
(
ma¡”Proxy
);

912 
	}
}

917 
	$³”ProxyHªdËH—d”
(
P“rProxy
* 
³”Proxy
, 
H—d”
* 
h—d”
) {

918 
h—d”
->
ty³
) {

919 
CONNECTION_REQUEST
:

920 
	`ma¡”HªdËCÚÃùiÚReque¡
(
³”Proxy
, 
h—d”
);

922 
CONNECTION
:

923 
	`ma¡”ProxyEx³ùCÚÃùiÚ
(
³”Proxy
, 
h—d”
);

925 
CONNECTION_ERROR
:

926 
	`ma¡”ProxyHªdËCÚÃùiÚE¼Ü
(
³”Proxy
, 
h—d”
);

928 
BYTES
:

929 
	`³”ProxyEx³ùBy‹s
(
³”Proxy
, 
h—d”
);

932 
	`ALOGW
("Inv®id…ack‘y³ from %d: %d", 
³”Proxy
->
üed’tŸls
.
pid
,

933 
h—d”
->
ty³
);

934 
	`³”ProxyKl
(
³”Proxy
, 
çl£
);

936 
	}
}

942 
boŞ
 
	$³”ProxyBufãrIÅut
(
P“rProxy
* 
³”Proxy
) {

943 
Bufãr
* 
š
 = 
³”Proxy
->
šputBufãr
;

944 
ssize_t
 
size
 = 
	`bufãrR—d
(
š
, 
³”Proxy
->
fd
->fd);

945 ià(
size
 < 0) {

946 
	`³”ProxyHªdËE¼Ü
(
³”Proxy
, "read");

947  
çl£
;

948 } ià(
size
 == 0) {

950 
	`ALOGI
("EOF");

951 
	`³”ProxyKl
(
³”Proxy
, 
çl£
);

952  
çl£
;

953 } ià(
	`bufãrR—dCom¶‘e
(
š
)) {

955  
Œue
;

958  
çl£
;

960 
	}
}

965 
	$³”ProxyR—d
(
S–eùabËFd
* 
fd
) {

966 
	`ALOGD
("Reading...");

967 
P“rProxy
* 
³”Proxy
 = (P“rProxy*è
fd
->
d©a
;

968 
¡©e
 = 
³”Proxy
->
šputS‹
;

969 
Bufãr
* 
š
 = 
³”Proxy
->
šputBufãr
;

970 
¡©e
) {

971 
READING_HEADER
:

972 ià(
	`³”ProxyBufãrIÅut
(
³”Proxy
)) {

973 
	`ALOGD
("Header„ead.");

975 
H—d”
* 
h—d”
 = (H—d”*è
š
->
d©a
;

976 
	`³”ProxyHªdËH—d”
(
³”Proxy
, 
h—d”
);

979 
READING_BYTES
:

980 
	`ALOGD
("Reading bytes...");

981 ià(
	`³”ProxyBufãrIÅut
(
³”Proxy
)) {

982 
	`ALOGD
("Bytes„ead.");

984 
³”Proxy
->
³”
->
	`ÚBy‹s
Õ“rProxy->
üed’tŸls
,

985 
š
->
d©a
, in->
size
);

988 
	`³”ProxyEx³ùH—d”
(
³”Proxy
);

991 
ACCEPTING_CONNECTION
:

992 
	`ma¡”ProxyAcû±CÚÃùiÚ
(
³”Proxy
);

995 
	`LOG_ALWAYS_FATAL
("UnknowÀ¡©e: %d", 
¡©e
);

997 
	}
}

999 
P“rProxy
* 
	$³”ProxyC»©e
(
P“r
* 
³”
, 
C»d’tŸls
 
üed’tŸls
) {

1000 
P“rProxy
* 
³”Proxy
 = 
	`ÿÎoc
(1, (PeerProxy));

1001 ià(
³”Proxy
 =ğ
NULL
) {

1002  
NULL
;

1005 
³”Proxy
->
šputBufãr
 = 
	`bufãrC»©e
((
H—d”
));

1006 ià(
³”Proxy
->
šputBufãr
 =ğ
NULL
) {

1007 
	`ä“
(
³”Proxy
);

1008  
NULL
;

1011 
³”Proxy
->
³”
 =…eer;

1012 
³”Proxy
->
üed’tŸls
 = credentials;

1015 
	`³”ProxyEx³ùH—d”
(
³”Proxy
);

1019 
pid_t
* 
pid
 = &(
³”Proxy
->
üed’tŸls
.pid);

1020 
	`hashm­Put
(
³”
->
³”Prox›s
, 
pid
, 
³”Proxy
);

1021  
³”Proxy
;

1022 
	}
}

1025 
	$ma¡”Acû±CÚÃùiÚ
(
S–eùabËFd
* 
li¡’”Fd
) {

1027 
sock‘
 = 
	`acû±
(
li¡’”Fd
->
fd
, 
NULL
, NULL);

1028 ià(
sock‘
 == -1) {

1029 
	`ALOGW
("acû±(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1033 
	`ALOGD
("Acû±ed cÚÃùiÚ‡ fd %d.", 
sock‘
);

1036 
C»d’tŸls
 
üed’tŸls
;

1037 
uüed
 
uüed’tŸls
;

1038 
sockËn_t
 
üed’tŸlsSize
 = (
uüed
);

1039 
»suÉ
 = 
	`g‘sockİt
(
sock‘
, 
SOL_SOCKET
, 
SO_PEERCRED
,

1040 &
uüed’tŸls
, &
üed’tŸlsSize
);

1042 ià(
»suÉ
 == -1) {

1043 
	`ALOGW
("g‘sockİt(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1044 
	`şo£W™hW¬nšg
(
sock‘
);

1049 
üed’tŸls
.
pid
 = 
uüed’tŸls
.pid;

1050 
üed’tŸls
.
uid
 = 
uüed’tŸls
.uid;

1051 
üed’tŸls
.
gid
 = 
uüed’tŸls
.gid;

1053 
	`ALOGI
("Acû±ed cÚÃùiÚ from…roûs %d.", 
üed’tŸls
.
pid
);

1055 
P“r
* 
ma¡”P“r
 = (P“r*è
li¡’”Fd
->
d©a
;

1057 
	`³”Lock
(
ma¡”P“r
);

1060 
P“rProxy
* 
³”Proxy


1061 ğ
	`hashm­G‘
(
ma¡”P“r
->
³”Prox›s
, &
üed’tŸls
.
pid
);

1062 ià(
³”Proxy
 !ğ
NULL
) {

1063 
	`³”UÆock
(
ma¡”P“r
);

1064 
	`ALOGW
("AÌ—d cÚÃùedØ´oûs %d.", 
üed’tŸls
.
pid
);

1065 
	`şo£W™hW¬nšg
(
sock‘
);

1070 
S–eùabËFd
* 
sock‘Fd
 = 
	`£ËùÜAdd
(
ma¡”P“r
->
£ËùÜ
, 
sock‘
);

1071 ià(
sock‘Fd
 =ğ
NULL
) {

1072 
	`³”UÆock
(
ma¡”P“r
);

1073 
	`ALOGW
("malloc() failed.");

1074 
	`şo£W™hW¬nšg
(
sock‘
);

1079 
³”Proxy
 = 
	`³”ProxyC»©e
(
ma¡”P“r
, 
üed’tŸls
);

1080 
	`³”UÆock
(
ma¡”P“r
);

1081 ià(
³”Proxy
 =ğ
NULL
) {

1082 
	`ALOGW
("malloc() failed.");

1083 
sock‘Fd
->
»move
 = 
Œue
;

1084 
	`şo£W™hW¬nšg
(
sock‘
);

1086 
³”Proxy
->
cÚÃùiÚs
 = 
	`hashm­C»©e
(10, &
pidHash
, &
pidEqu®s
);

1087 
	`³”ProxyS‘Fd
(
³”Proxy
, 
sock‘Fd
);

1088 
	}
}

1093 
P“r
* 
	$³”C»©e
() {

1094 
P“r
* 
³”
 = 
	`ÿÎoc
(1, (Peer));

1095 ià(
³”
 =ğ
NULL
) {

1096 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

1098 
³”
->
³”Prox›s
 = 
	`hashm­C»©e
(10, &
pidHash
, &
pidEqu®s
);

1099 
³”
->
£ËùÜ
 = 
	`£ËùÜC»©e
();

1101 
±h»ad_mu‹x©Œ_t
 
©Œibu‹s
;

1102 ià(
	`±h»ad_mu‹x©Œ_š™
(&
©Œibu‹s
) != 0) {

1103 
	`LOG_ALWAYS_FATAL
("pthread_mutexattr_init()ƒrror.");

1105 ià(
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œibu‹s
, 
PTHREAD_MUTEX_RECURSIVE
) != 0) {

1106 
	`LOG_ALWAYS_FATAL
("pthread_mutexattr_settype()ƒrror.");

1108 ià(
	`±h»ad_mu‹x_š™
(&
³”
->
mu‹x
, &
©Œibu‹s
) != 0) {

1109 
	`LOG_ALWAYS_FATAL
("pthread_mutex_init()ƒrror.");

1112 
³”
->
pid
 = 
	`g‘pid
();

1113  
³”
;

1114 
	}
}

1117 
P“r
* 
	gloÿlP“r
;

1120 
	$outgošgPack‘F»eBy‹s
(
OutgošgPack‘
* 
·ck‘
) {

1121 
	`ALOGD
("Freeing outgoing…acket.");

1122 
	`bufãrF»e
(
·ck‘
->
by‹s
);

1123 
	`ä“
(
·ck‘
);

1124 
	}
}

1133 
	$³”S’dBy‹s
(
pid_t
 
pid
, cÚ¡ * 
by‹s
, 
size_t
 
size
) {

1134 
P“r
* 
³”
 = 
loÿlP“r
;

1135 
	`as£¹
(
³”
 !ğ
NULL
);

1137 
OutgošgPack‘
* 
·ck‘
 = 
	`ÿÎoc
(1, (OutgoingPacket));

1138 ià(
·ck‘
 =ğ
NULL
) {

1139 
”ºo
 = 
ENOMEM
;

1143 
Bufãr
* 
cİy
 = 
	`bufãrC»©e
(
size
);

1144 ià(
cİy
 =ğ
NULL
) {

1145 
	`ä“
(
·ck‘
);

1146 
”ºo
 = 
ENOMEM
;

1151 
	`memıy
(
cİy
->
d©a
, 
by‹s
, 
size
);

1152 
cİy
->
size
 = size;

1154 
·ck‘
->
by‹s
 = 
cİy
;

1155 
·ck‘
->
h—d”
.
ty³
 = 
BYTES
;

1156 
·ck‘
->
h—d”
.
size
 = size;

1157 
·ck‘
->
ä“
 = 
outgošgPack‘F»eBy‹s
;

1158 
	`bufãrP»·»FÜWr™e
(
·ck‘
->
by‹s
);

1160 
	`³”Lock
(
³”
);

1162 
P“rProxy
* 
³”Proxy
 = 
	`³”ProxyG‘OrC»©e
(
³”
, 
pid
, 
Œue
);

1163 ià(
³”Proxy
 =ğ
NULL
) {

1166 
	`³”UÆock
(
³”
);

1167 
·ck‘
->
	`ä“
(packet);

1170 
	`³”ProxyEnqueueOutgošgPack‘
(
³”Proxy
, 
·ck‘
);

1171 
	`³”UÆock
(
³”
);

1172 
	`£ËùÜWakeUp
(
³”
->
£ËùÜ
);

1175 
	}
}

1179 (*
	mä“
)(* 
	mcÚ‹xt
);

1180 * 
	mcÚ‹xt
;

1181 } 
	tSh¬edBy‹sF»”
;

1184 
	$outgošgPack‘F»eSh¬edBy‹s
(
OutgošgPack‘
* 
·ck‘
) {

1185 
Sh¬edBy‹sF»”
* 
sh¬edBy‹sF»”


1186 ğ(
Sh¬edBy‹sF»”
*è
·ck‘
->
cÚ‹xt
;

1187 
sh¬edBy‹sF»”
->
	`ä“
(sh¬edBy‹sF»”->
cÚ‹xt
);

1188 
	`ä“
(
sh¬edBy‹sF»”
);

1189 
	`ä“
(
·ck‘
);

1190 
	}
}

1200 
³”S’dSh¬edBy‹s
(
pid_t
 
pid
, * 
by‹s
, 
size_t
 
size
,

1201 (*
ä“
)(* 
cÚ‹xt
), * context) {

1202 
P“r
* 
³”
 = 
loÿlP“r
;

1203 
	`as£¹
(
³”
 !ğ
NULL
);

1205 
OutgošgPack‘
* 
·ck‘
 = 
	`ÿÎoc
(1, (OutgoingPacket));

1206 ià(
·ck‘
 =ğ
NULL
) {

1207 
”ºo
 = 
ENOMEM
;

1211 
Bufãr
* 
w¿µ”
 = 
	`bufãrW¿p
(
by‹s
, 
size
, size);

1212 ià(
w¿µ”
 =ğ
NULL
) {

1213 
	`ä“
(
·ck‘
);

1214 
”ºo
 = 
ENOMEM
;

1218 
Sh¬edBy‹sF»”
* 
sh¬edBy‹sF»”
 = 
	`m®loc
((SharedBytesFreer));

1219 ià(
sh¬edBy‹sF»”
 =ğ
NULL
) {

1220 
	`ä“
(
·ck‘
);

1221 
	`ä“
(
w¿µ”
);

1222 
”ºo
 = 
ENOMEM
;

1225 
sh¬edBy‹sF»”
->
ä“
 = free;

1226 
sh¬edBy‹sF»”
->
cÚ‹xt
 = context;

1228 
·ck‘
->
by‹s
 = 
w¿µ”
;

1229 
·ck‘
->
cÚ‹xt
 = 
sh¬edBy‹sF»”
;

1230 
·ck‘
->
h—d”
.
ty³
 = 
BYTES
;

1231 
·ck‘
->
h—d”
.
size
 = size;

1232 
·ck‘
->
ä“
 = &
outgošgPack‘F»eSh¬edBy‹s
;

1233 
	`bufãrP»·»FÜWr™e
(
·ck‘
->
by‹s
);

1235 
	`³”Lock
(
³”
);

1237 
P“rProxy
* 
³”Proxy
 = 
	`³”ProxyG‘OrC»©e
(
³”
, 
pid
, 
Œue
);

1238 ià(
³”Proxy
 =ğ
NULL
) {

1241 
	`³”UÆock
(
³”
);

1242 
·ck‘
->
	`ä“
(packet);

1245 
	`³”ProxyEnqueueOutgošgPack‘
(
³”Proxy
, 
·ck‘
);

1246 
	`³”UÆock
(
³”
);

1247 
	`£ËùÜWakeUp
(
³”
->
£ËùÜ
);

1250 
	}
}

1259 
	$ma¡”P“rIn™Ÿlize
(
By‹sLi¡’”
* 
by‹sLi¡’”
,

1260 
D—thLi¡’”
* 
d—thLi¡’”
) {

1262 
li¡’”Sock‘
 = 
	`sock‘
(
AF_LOCAL
, 
SOCK_STREAM
, 0);

1263 ià(
li¡’”Sock‘
 == -1) {

1264 
	`LOG_ALWAYS_FATAL
("sock‘(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1266 
	`uÆšk
(
MASTER_PATH
);

1267 
»suÉ
 = 
	`bšd
(
li¡’”Sock‘
, (
Sock‘Add»ss
*è
	`g‘Ma¡”Add»ss
(),

1268 (
UnixAdd»ss
));

1269 ià(
»suÉ
 == -1) {

1270 
	`LOG_ALWAYS_FATAL
("bšd(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1273 
	`ALOGD
("Li¡’” sock‘: %d", 
li¡’”Sock‘
);

1276 
»suÉ
 = 
	`li¡’
(
li¡’”Sock‘
, 16);

1277 ià(
»suÉ
 != 0) {

1278 
	`LOG_ALWAYS_FATAL
("li¡’(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1282 
	`£tNÚBlockšg
(
li¡’”Sock‘
);

1285 ià(
loÿlP“r
 !ğ
NULL
) {

1286 
	`LOG_ALWAYS_FATAL
("Peer is‡lready initialized.");

1288 
loÿlP“r
 = 
	`³”C»©e
();

1289 ià(
loÿlP“r
 =ğ
NULL
) {

1290 
	`LOG_ALWAYS_FATAL
("malloc() failed.");

1292 
loÿlP“r
->
ma¡”
 = 
Œue
;

1293 
loÿlP“r
->
ÚBy‹s
 = 
by‹sLi¡’”
;

1294 
loÿlP“r
->
ÚD—th
 = 
d—thLi¡’”
;

1297 
S–eùabËFd
* 
li¡’”Fd
 = 
	`£ËùÜAdd
(
loÿlP“r
->
£ËùÜ
, 
li¡’”Sock‘
);

1298 ià(
li¡’”Fd
 =ğ
NULL
) {

1299 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

1301 
li¡’”Fd
->
d©a
 = 
loÿlP“r
;

1302 
li¡’”Fd
->
ÚR—dabË
 = &
ma¡”Acû±CÚÃùiÚ
;

1303 
	}
}

1310 
	$³”In™Ÿlize
(
By‹sLi¡’”
* 
by‹sLi¡’”
,

1311 
D—thLi¡’”
* 
d—thLi¡’”
) {

1313 
ma¡”Sock‘
 = 
	`sock‘
(
AF_LOCAL
, 
SOCK_STREAM
, 0);

1314 ià(
ma¡”Sock‘
 == -1) {

1315 
	`LOG_ALWAYS_FATAL
("sock‘(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1317 
»suÉ
 = 
	`cÚÃù
(
ma¡”Sock‘
, (
Sock‘Add»ss
*è
	`g‘Ma¡”Add»ss
(),

1318 (
UnixAdd»ss
));

1319 ià(
»suÉ
 != 0) {

1320 
	`LOG_ALWAYS_FATAL
("cÚÃù(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

1324 ià(
loÿlP“r
 !ğ
NULL
) {

1325 
	`LOG_ALWAYS_FATAL
("Peer is‡lready initialized.");

1327 
loÿlP“r
 = 
	`³”C»©e
();

1328 ià(
loÿlP“r
 =ğ
NULL
) {

1329 
	`LOG_ALWAYS_FATAL
("malloc() failed.");

1331 
loÿlP“r
->
ÚBy‹s
 = 
by‹sLi¡’”
;

1332 
loÿlP“r
->
ÚD—th
 = 
d—thLi¡’”
;

1335 
S–eùabËFd
* 
ma¡”Fd
 = 
	`£ËùÜAdd
(
loÿlP“r
->
£ËùÜ
, 
ma¡”Sock‘
);

1336 ià(
ma¡”Fd
 =ğ
NULL
) {

1337 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

1341 
P“rProxy
* 
ma¡”Proxy
 = 
	`³”ProxyC»©e
(
loÿlP“r
, 
MASTER_CREDENTIALS
);

1342 ià(
ma¡”Proxy
 =ğ
NULL
) {

1343 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

1345 
	`³”ProxyS‘Fd
(
ma¡”Proxy
, 
ma¡”Fd
);

1346 
ma¡”Proxy
->
ma¡”
 = 
Œue
;

1347 
loÿlP“r
->
ma¡”Proxy
 = masterProxy;

1348 
	}
}

1351 
	$³”Loİ
() {

1352 
	`as£¹
(
loÿlP“r
 !ğ
NULL
);

1355 
	`£ËùÜLoİ
(
loÿlP“r
->
£ËùÜ
);

1356 
	}
}

	@libs/libcutils/multiuser.c

17 
	~<cuts/muÉiu£r.h
>

19 
u£rid_t
 
	$muÉiu£r_g‘_u£r_id
(
uid_t
 
uid
) {

20  
uid
 / 
MULTIUSER_APP_PER_USER_RANGE
;

21 
	}
}

23 
­pid_t
 
	$muÉiu£r_g‘_­p_id
(
uid_t
 
uid
) {

24  
uid
 % 
MULTIUSER_APP_PER_USER_RANGE
;

25 
	}
}

27 
uid_t
 
	$muÉiu£r_g‘_uid
(
u£rid_t
 
u£rId
, 
­pid_t
 
­pId
) {

28  
u£rId
 * 
MULTIUSER_APP_PER_USER_RANGE
 + (
­pId
 % MULTIUSER_APP_PER_USER_RANGE);

29 
	}
}

	@libs/libcutils/native_handle.c

17 
	#LOG_TAG
 "N©iveHªdË"

	)

19 
	~<¡dšt.h
>

20 
	~<”ºo.h
>

21 
	~<¡ršg.h
>

22 
	~<¡dlib.h
>

23 
	~<uni¡d.h
>

25 
	~<cuts/log.h
>

26 
	~<cuts/Çtive_hªdË.h
>

28 
Çtive_hªdË_t
* 
	$Çtive_hªdË_ü—‹
(
numFds
, 
numIÁs
)

30 
Çtive_hªdË_t
* 
h
 = 
	`m®loc
(

31 (
Çtive_hªdË_t
è+ ()*(
numFds
+
numIÁs
));

33 
h
->
v”siÚ
 = (
Çtive_hªdË_t
);

34 
h
->
numFds
 =‚umFds;

35 
h
->
numIÁs
 =‚umInts;

36  
h
;

37 
	}
}

39 
	$Çtive_hªdË_d–‘e
(
Çtive_hªdË_t
* 
h
)

41 ià(
h
) {

42 ià(
h
->
v”siÚ
 !ğ(
Çtive_hªdË_t
))

43  -
EINVAL
;

44 
	`ä“
(
h
);

47 
	}
}

49 
	$Çtive_hªdË_şo£
(cÚ¡ 
Çtive_hªdË_t
* 
h
)

51 ià(
h
->
v”siÚ
 !ğ(
Çtive_hªdË_t
))

52  -
EINVAL
;

54 cÚ¡ 
numFds
 = 
h
->numFds;

55 
i
;

56 
i
=0 ; i<
numFds
 ; i++) {

57 
	`şo£
(
h
->
d©a
[
i
]);

60 
	}
}

	@libs/libcutils/open_memstream.c

17 #iâdeà
HAVE_OPEN_MEMSTREAM


47 
	~<cuts/İ’_mem¡»am.h
>

48 
	~<¡dlib.h
>

49 
	~<sys/ty³s.h
>

50 
	~<uni¡d.h
>

51 
	~<¡dio.h
>

52 
	~<¡ršg.h
>

53 
	~<”ºo.h
>

54 
	~<as£¹.h
>

57 
	#DBUG
(
x
è
´štf
 
	)
x

59 
	#DBUG
(
x
è(()0)

	)

62 #ifdeà
HAVE_FUNOPEN


68 ** 
	mbuå
;

69 
size_t
* 
	msiz•
;

71 
size_t
 
	m®locSize
;

72 
size_t
 
	meof
;

73 
size_t
 
	moff£t
;

74 
	m§ved
;

75 } 
	tMemSŒ—m
;

77 
	#kIn™ŸlSize
 1024

	)

86 
	$’su»C­ac™y
(
MemSŒ—m
* 
¡»am
, 
wr™eSize
)

88 
	`DBUG
(("+++ƒnsu»C­ off=%d size=%d\n", 
¡»am
->
off£t
, 
wr™eSize
));

90 
size_t
 
ÃededSize
 = 
¡»am
->
off£t
 + 
wr™eSize
 + 1;

91 ià(
ÃededSize
 <ğ
¡»am
->
®locSize
)

94 
size_t
 
ÃwSize
;

96 ià(
¡»am
->
®locSize
 == 0) {

97 
ÃwSize
 = 
kIn™ŸlSize
;

99 
ÃwSize
 = 
¡»am
->
®locSize
;

100 
ÃwSize
 +=‚ewSize / 2;

103 ià(
ÃwSize
 < 
ÃededSize
)

104 
ÃwSize
 = 
ÃededSize
;

105 
	`DBUG
(("+++„ealloc %p->%po size=%d\n",

106 
¡»am
->
buå
, *¡»am->buå, 
ÃwSize
));

107 * 
ÃwBuf
 = (*è
	`»®loc
(*
¡»am
->
buå
, 
ÃwSize
);

108 ià(
ÃwBuf
 =ğ
NULL
)

111 *
¡»am
->
buå
 = 
ÃwBuf
;

112 
¡»am
->
®locSize
 = 
ÃwSize
;

114 
	}
}

123 
	$wr™e_mem¡»am
(* 
cook›
, cÚ¡ * 
buf
, 
size
)

125 
MemSŒ—m
* 
¡»am
 = (MemSŒ—m*è
cook›
;

127 ià(
	`’su»C­ac™y
(
¡»am
, 
size
) < 0)

131 ià(
¡»am
->
eof
 < sŒ—m->
off£t
) {

132 
	`DBUG
(("+++ zero-fill gap from %do %d\n",

133 
¡»am
->
eof
, sŒ—m->
off£t
-1));

134 
	`mem£t
(*
¡»am
->
buå
 + sŒ—m->
eof
, '\0',

135 
¡»am
->
off£t
 - sŒ—m->
eof
);

139 
	`memıy
(*
¡»am
->
buå
 + sŒ—m->
off£t
, 
buf
, 
size
);

140 
¡»am
->
off£t
 +ğ
size
;

142 ià(
¡»am
->
off£t
 > sŒ—m->
eof
) {

144 
	`DBUG
(("+++ EOF‡dvªûdØ%d,‡µ’dšg‚ul\n", 
¡»am
->
off£t
));

145 
	`as£¹
(
¡»am
->
off£t
 < sŒ—m->
®locSize
);

146 
¡»am
->
eof
 = sŒ—m->
off£t
;

149 
	`DBUG
(("+++ within written‡rea, saving '%c'‡t %d\n",

150 *(*
¡»am
->
buå
 + sŒ—m->
off£t
), stream->offset));

151 
¡»am
->
§ved
 = *(*¡»am->
buå
 + sŒ—m->
off£t
);

153 *(*
¡»am
->
buå
 + sŒ—m->
off£t
) = '\0';

154 *
¡»am
->
siz•
 = sŒ—m->
off£t
;

156  
size
;

157 
	}
}

164 
åos_t
 
	$£ek_mem¡»am
(* 
cook›
, 
åos_t
 
off£t
, 
wh’û
)

166 
MemSŒ—m
* 
¡»am
 = (MemSŒ—m*è
cook›
;

167 
off_t
 
ÃwPo¢
 = (off_tè
off£t
;

169 ià(
wh’û
 =ğ
SEEK_CUR
) {

170 
ÃwPo¢
 +ğ
¡»am
->
off£t
;

171 } ià(
wh’û
 =ğ
SEEK_END
) {

172 
ÃwPo¢
 +ğ
¡»am
->
eof
;

175 ià(
ÃwPo¢
 < 0 || ((
åos_t
)((
size_t
)‚ewPosn)) !=‚ewPosn) {

177 
	`DBUG
(("+++ bogu £ek off£ˆ%ld\n", (è
ÃwPo¢
));

178 
”ºo
 = 
EINVAL
;

179  (
åos_t
) -1;

182 ià(
¡»am
->
off£t
 < sŒ—m->
eof
) {

187 
	`DBUG
(("+++„estoring char '%c'‡t %d\n",

188 
¡»am
->
§ved
, sŒ—m->
off£t
));

189 *(*
¡»am
->
buå
 + sŒ—m->
off£t
èğ¡»am->
§ved
;

192 
¡»am
->
off£t
 = (
size_t
è
ÃwPo¢
;

194 ià(
¡»am
->
off£t
 < sŒ—m->
eof
) {

199 
¡»am
->
§ved
 = *(*¡»am->
buå
 + sŒ—m->
off£t
);

200 *(*
¡»am
->
buå
 + sŒ—m->
off£t
) = '\0';

201 *
¡»am
->
siz•
 = sŒ—m->
off£t
;

207 *
¡»am
->
siz•
 = sŒ—m->
eof
;

210  
ÃwPo¢
;

211 
	}
}

216 
	$şo£_mem¡»am
(* 
cook›
)

218 
	`ä“
(
cook›
);

220 
	}
}

225 
FILE
* 
	$İ’_mem¡»am
(** 
buå
, 
size_t
* 
siz•
)

227 
FILE
* 
å
;

228 
MemSŒ—m
* 
¡»am
;

230 ià(
buå
 =ğ
NULL
 || 
siz•
 == NULL) {

231 
”ºo
 = 
EINVAL
;

232  
NULL
;

235 
¡»am
 = (
MemSŒ—m
*è
	`ÿÎoc
(1, (MemStream));

236 ià(
¡»am
 =ğ
NULL
)

237  
NULL
;

239 
å
 = 
	`funİ’
(
¡»am
,

240 
NULL
, 
wr™e_mem¡»am
, 
£ek_mem¡»am
, 
şo£_mem¡»am
);

241 ià(
å
 =ğ
NULL
) {

242 
	`ä“
(
¡»am
);

243  
NULL
;

246 *
siz•
 = 0;

247 *
buå
 = 
NULL
;

248 
¡»am
->
buå
 = bufp;

249 
¡»am
->
siz•
 = sizep;

251  
å
;

252 
	}
}

255 
FILE
* 
	$İ’_mem¡»am
(** 
buå
, 
size_t
* 
siz•
)

257 
	`abÜt
();

258 
	}
}

264 
	#_GNU_SOURCE


	)

265 
	~<¡dio.h
>

266 
	~<¡dlib.h
>

267 
	~<¡ršg.h
>

282 
	$‹¡MemSŒ—m
()

284 
FILE
 *
¡»am
;

285 *
buf
;

286 
size_t
 
Ën
;

287 
off_t
 
eob
;

289 
	`´štf
("Test1\n");

292 
¡»am
 = 
	`İ’_mem¡»am
(&
buf
, &
Ën
);

293 
	`årštf
(
¡»am
, "hello my world");

294 
	`fæush
(
¡»am
);

295 
	`´štf
("buf=%s,†’=%zu\n", 
buf
, 
Ën
);

296 
eob
 = 
	`á–lo
(
¡»am
);

297 
	`f£eko
(
¡»am
, 0, 
SEEK_SET
);

298 
	`årštf
(
¡»am
, "good-bye");

299 
	`f£eko
(
¡»am
, 
eob
, 
SEEK_SET
);

300 
	`fşo£
(
¡»am
);

301 
	`´štf
("buf=%s,†’=%zu\n", 
buf
, 
Ën
);

302 
	`ä“
(
buf
);

304 
	`´štf
("Test2\n");

307 
¡»am
 = 
	`İ’_mem¡»am
(&
buf
, &
Ën
);

308 
	`årštf
(
¡»am
, "hello my world");

309 
	`fæush
(
¡»am
);

310 
	`´štf
("buf=%s,†’=%zu\n", 
buf
, 
Ën
);

311 
eob
 = 
	`á–lo
(
¡»am
);

312 
	`f£eko
(
¡»am
, 0, 
SEEK_SET
);

313 
	`årštf
(
¡»am
, "good-bye");

315 
	`fşo£
(
¡»am
);

316 
	`´štf
("buf=%s,†’=%zu\n", 
buf
, 
Ën
);

317 
	`ä“
(
buf
);

319 
	`´štf
("Test3\n");

322 cÚ¡ 
kCmpL’
 = 1024 + 128;

323 * 
cmp
 = 
	`m®loc
(
kCmpL’
);

324 
	`mem£t
(
cmp
, 0, 1024);

325 
	`mem£t
(
cmp
+1024, 0xff, 
kCmpL’
-1024);

326 
	`¥rštf
(
cmp
, "This-is-a-tes1234");

327 
	`¥rštf
(
cmp
 + 1022, "abcdef");

329 
¡»am
 = 
	`İ’_mem¡»am
 (&
buf
, &
Ën
);

330 
	`£tvbuf
(
¡»am
, 
NULL
, 
_IONBF
, 0);

331 
	`årštf
(
¡»am
, "This-is-a-test");

332 
	`f£ek
(
¡»am
, -1, 
SEEK_CUR
);

333 
	`årštf
(
¡»am
, "1234");

334 
	`f£ek
(
¡»am
, 1022, 
SEEK_SET
);

335 
	`åutc
('a', 
¡»am
);

336 
	`åutc
('b', 
¡»am
);

337 
	`åutc
('c', 
¡»am
);

338 
	`åutc
('d', 
¡»am
);

339 
	`åutc
('e', 
¡»am
);

340 
	`åutc
('f', 
¡»am
);

341 
	`fæush
(
¡»am
);

343 ià(
	`memcmp
(
buf
, 
cmp
, 
Ën
+1) != 0) {

344 
	`´štf
("mismatch\n");

346 
	`´štf
("match\n");

349 
	`´štf
("Test4\n");

350 
¡»am
 = 
	`İ’_mem¡»am
 (&
buf
, &
Ën
);

351 
	`f£ek
(
¡»am
, 5000, 
SEEK_SET
);

352 
	`f£ek
(
¡»am
, 4096, 
SEEK_SET
);

353 
	`f£ek
(
¡»am
, -1, 
SEEK_SET
);

354 
	`åutc
('x', 
¡»am
);

355 ià(
	`á–l
(
¡»am
) == 4097)

356 
	`´štf
("good\n");

358 
	`´štf
("BAD: off£ˆi %ld\n", 
	`á–l
(
¡»am
));

360 
	`´štf
("DONE\n");

363 
	}
}

	@libs/libcutils/partition_utils.c

17 
	~<sys/ty³s.h
>

18 
	~<uni¡d.h
>

19 
	~<fú.h
>

20 
	~<sys/¡©.h
>

21 
	~<sys/ioùl.h
>

22 
	~<sys/mouÁ.h
>

23 
	~<cuts/´İ”t›s.h
>

25 
	$Úly_Úe_ch¬
(*
buf
, 
Ën
, 
c
)

27 
i
, 
»t
;

29 
»t
 = 1;

30 
i
=0; i<
Ën
; i++) {

31 ià(
buf
[
i
] !ğ
c
) {

32 
»t
 = 0;

36  
»t
;

37 
	}
}

39 
	$·¹™iÚ_wed
(*
sourû
)

41 
buf
[4096];

42 
fd
, 
»t
, 
wed
;

44 ià((
fd
 = 
	`İ’
(
sourû
, 
O_RDONLY
)) < 0) {

48 
»t
 = 
	`»ad
(
fd
, 
buf
, (buf));

49 
	`şo£
(
fd
);

51 ià(
»t
 !ğ(
buf
)) {

56 ià(
	`Úly_Úe_ch¬
(
buf
, (buf), 0)) {

61 ià(
	`Úly_Úe_ch¬
(
buf
, (buf), 0xff)) {

66 
	}
}

	@libs/libcutils/private.h

1 #iâdeà
PRIVATE_H


3 
	#PRIVATE_H


	)

22 #iâdeà
lšt


23 #iâdeà
NOID


24 
	g´iv©ehid
[] = "@(#)private.h 8.2";

28 
	#GRANDPARENTED
 "LoÿÈtimzÚmu¡ b£t--£ziømªu®…age"

	)

35 #iâdeà
HAVE_ADJTIME


36 
	#HAVE_ADJTIME
 1

	)

39 #iâdeà
HAVE_GETTEXT


40 
	#HAVE_GETTEXT
 0

	)

43 #iâdeà
HAVE_INCOMPATIBLE_CTIME_R


44 
	#HAVE_INCOMPATIBLE_CTIME_R
 0

	)

47 #iâdeà
HAVE_SETTIMEOFDAY


48 
	#HAVE_SETTIMEOFDAY
 3

	)

51 #iâdeà
HAVE_STRERROR


52 
	#HAVE_STRERROR
 1

	)

55 #iâdeà
HAVE_SYMLINK


56 
	#HAVE_SYMLINK
 1

	)

59 #iâdeà
HAVE_SYS_STAT_H


60 
	#HAVE_SYS_STAT_H
 1

	)

63 #iâdeà
HAVE_SYS_WAIT_H


64 
	#HAVE_SYS_WAIT_H
 1

	)

67 #iâdeà
HAVE_UNISTD_H


68 
	#HAVE_UNISTD_H
 1

	)

71 #iâdeà
HAVE_UTMPX_H


72 
	#HAVE_UTMPX_H
 0

	)

75 #iâdeà
LOCALE_HOME


76 
	#LOCALE_HOME
 "/u¤/lib/loÿË"

	)

79 #ià
HAVE_INCOMPATIBLE_CTIME_R


80 
	#asùime_r
 
_šcom·tibË_asùime_r


	)

81 
	#ùime_r
 
_šcom·tibË_ùime_r


	)

88 
	~"sys/ty³s.h
"

89 
	~"¡dio.h
"

90 
	~"”ºo.h
"

91 
	~"¡ršg.h
"

92 
	~"lim™s.h
"

93 
	~"time.h
"

94 
	~"¡dlib.h
"

96 #ià
HAVE_GETTEXT


97 
	~"libš.h
"

100 #ià
HAVE_SYS_WAIT_H


101 
	~<sys/wa™.h
>

104 #iâdeà
WIFEXITED


105 
	#WIFEXITED
(
¡©us
è(((¡©usè& 0xffè=ğ0)

	)

107 #iâdeà
WEXITSTATUS


108 
	#WEXITSTATUS
(
¡©us
è(((¡©usè>> 8è& 0xff)

	)

111 #ià
HAVE_UNISTD_H


112 
	~"uni¡d.h
"

115 #ià!
HAVE_UNISTD_H


116 #iâdeà
F_OK


117 
	#F_OK
 0

	)

119 #iâdeà
R_OK


120 
	#R_OK
 4

	)

125 
	#is_dig™
(
c
è(()(cè- '0' <ğ9)

	)

133 #iâdeà
HAVE_STDINT_H


134 
	#HAVE_STDINT_H
 \

135 (199901 <ğ
__STDC_VERSION__
 || \

136 2 < (
__GLIBC__
 + (0 < 
__GLIBC_MINOR__
)))

	)

139 #ià
HAVE_STDINT_H


140 
	~"¡dšt.h
"

143 #iâdeà
INT_FAST64_MAX


145 #ià
defšed
 
LLONG_MAX
 || defšed 
__LONG_LONG_MAX__


146 
	tšt_ç¡64_t
;

148 #ià(
LONG_MAX
 >> 31) < 0xffffffff

149 
PËa£
 
u£
 
a
 
comp”
 
th©
 
suµÜts
 
	ga
 64-
b™
 
š‹g”
 
ty³
 (
Ü
 
wid”
);

150 
you
 
may
 
Ãed
 
to
 
compe
 
	gw™h
 "-DHAVE_STDINT_H".

152 
	tšt_ç¡64_t
;

156 #iâdeà
INT32_MAX


157 
	#INT32_MAX
 0x7fffffff

	)

159 #iâdeà
INT32_MIN


160 
	#INT32_MIN
 (-1 - 
INT32_MAX
)

	)

171 #iâdeà
P


172 
	#P
(
x
è
	)
x

179 #iâdeà
EXIT_SUCCESS


180 
	#EXIT_SUCCESS
 0

	)

187 #iâdeà
EXIT_FAILURE


188 
	#EXIT_FAILURE
 1

	)

195 #iâdeà
FILENAME_MAX


197 #iâdeà
MAXPATHLEN


198 #ifdeà
unix


199 
	~"sys/·¿m.h
"

203 #ifdeà
MAXPATHLEN


204 
	#FILENAME_MAX
 
MAXPATHLEN


	)

206 #iâdeà
MAXPATHLEN


207 
	#FILENAME_MAX
 1024

	)

216 #iâdeà
»move


217 
uÆšk
 
P
((cÚ¡ * 
f’ame
));

218 
	#»move
 
uÆšk


	)

227 #iâdeà
”ºo


228 
”ºo
;

237 #iâdeà
asùime_r


238 * 
asùime_r
();

245 * 
iÿÎoc
 
P
((
ÃËm
, 
–size
));

246 * 
iÿÎoc
 
P
((* 
Şd
, cÚ¡ * 
Ãw
));

247 * 
iıy®loc
 
P
((cÚ¡ * 
¡ršg
));

248 * 
im®loc
 
P
((
n
));

249 * 
œ—Îoc
 
P
((* 
poš‹r
, 
size
));

250 
icä“
 
P
((* 
poš‹r
));

251 
iä“
 
P
((* 
poš‹r
));

252 cÚ¡ * 
scheck
 
P
((cÚ¡ * 
¡ršg
, cÚ¡ * 
fÜm©
));

258 #iâdeà
TRUE


259 
	#TRUE
 1

	)

262 #iâdeà
FALSE


263 
	#FALSE
 0

	)

266 #iâdeà
TYPE_BIT


267 
	#TYPE_BIT
(
ty³
è( (ty³è* 
CHAR_BIT
)

	)

270 #iâdeà
TYPE_SIGNED


271 
	#TYPE_SIGNED
(
ty³
è((Ñy³è-1è< 0)

	)

279 #iâdeà
TYPE_INTEGRAL


280 
	#TYPE_INTEGRAL
(
ty³
è((Ñy³è0.5è!ğ0.5)

	)

283 #iâdeà
INT_STRLEN_MAXIMUM


290 
	#INT_STRLEN_MAXIMUM
(
ty³
) \

291 ((
	`TYPE_BIT
(
ty³
è- 
	`TYPE_SIGNED
(type)) * 302 / 1000 + \

292 1 + 
	`TYPE_SIGNED
(
ty³
))

	)

299 #iâdeà
GNUC_Ü_lšt


300 #ifdeà
lšt


301 
	#GNUC_Ü_lšt


	)

303 #iâdeà
lšt


304 #ifdeà
__GNUC__


305 
	#GNUC_Ü_lšt


	)

310 #iâdeà
INITIALIZE


311 #ifdeà
GNUC_Ü_lšt


312 
	#INITIALIZE
(
x
è((xèğ0)

	)

314 #iâdeà
GNUC_Ü_lšt


315 
	#INITIALIZE
(
x
)

	)

325 #iâdeà
_


326 #ià
HAVE_GETTEXT


327 
	#_
(
msgid
è
	`g‘‹xt
(msgid)

	)

329 
	#_
(
msgid
è
	)
msgid

333 #iâdeà
TZ_DOMAIN


334 
	#TZ_DOMAIN
 "tz"

	)

337 #ià
HAVE_INCOMPATIBLE_CTIME_R


338 #undeà
asùime_r


339 #undeà
ùime_r


340 *
asùime_r
 
P
((
tm
 const *, *));

341 *
ùime_r
 
P
((
time_t
 const *, *));

344 #iâdeà
YEARSPERREPEAT


345 
	#YEARSPERREPEAT
 400

	)

352 #iâdeà
AVGSECSPERYEAR


353 
	#AVGSECSPERYEAR
 31556952L

	)

356 #iâdeà
SECSPERREPEAT


357 
	#SECSPERREPEAT
 ((
št_ç¡64_t
è
YEARSPERREPEAT
 * (št_ç¡64_tè
AVGSECSPERYEAR
)

	)

360 #iâdeà
SECSPERREPEAT_BITS


361 
	#SECSPERREPEAT_BITS
 34

	)

	@libs/libcutils/process_name.c

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

19 
	~<cuts/´oûss_Çme.h
>

20 
	~<cuts/´İ”t›s.h
>

21 
	~<uni¡d.h
>

22 
	~<sys/ty³s.h
>

23 
	~<sys/¡©.h
>

24 
	~<fú.h
>

26 #ià
defšed
(
HAVE_PRCTL
)

27 
	~<sys/´ùl.h
>

30 
	#PROCESS_NAME_DEVICE
 "/sys/qemu_Œaû/´oûss_Çme"

	)

32 cÚ¡ * 
	g´oûss_Çme
 = "unknown";

33 
	gruÂšg_š_emuÏtÜ
 = -1;

35 
	$£t_´oûss_Çme
(cÚ¡ * 
Ãw_Çme
) {

36 
´İBuf
[
PROPERTY_VALUE_MAX
];

38 ià(
Ãw_Çme
 =ğ
NULL
) {

43 
Ën
 = 
	`¡¾’
(
Ãw_Çme
);

44 * 
cİy
 = (*è
	`m®loc
(
Ën
 + 1);

45 
	`¡rıy
(
cİy
, 
Ãw_Çme
);

46 
´oûss_Çme
 = (cÚ¡ *è
cİy
;

48 #ià
	`defšed
(
HAVE_PRCTL
)

49 ià(
Ën
 < 16) {

50 
	`´ùl
(
PR_SET_NAME
, (è
Ãw_Çme
, 0, 0, 0);

52 
	`´ùl
(
PR_SET_NAME
, (è
Ãw_Çme
 + 
Ën
 - 15, 0, 0, 0);

57 ià(
ruÂšg_š_emuÏtÜ
 == 0) {

63 ià(
ruÂšg_š_emuÏtÜ
 == -1) {

64 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
´İBuf
, "");

65 ià(
´İBuf
[0] == '1') {

66 
ruÂšg_š_emuÏtÜ
 = 1;

68 
ruÂšg_š_emuÏtÜ
 = 0;

80 
fd
 = 
	`İ’
(
PROCESS_NAME_DEVICE
, 
O_RDWR
);

81 ià(
fd
 < 0)

83 
	`wr™e
(
fd
, 
´oûss_Çme
, 
	`¡¾’
(process_name) + 1);

84 
	`şo£
(
fd
);

85 
	}
}

87 cÚ¡ * 
	$g‘_´oûss_Çme
() {

88  
´oûss_Çme
;

89 
	}
}

	@libs/libcutils/properties.c

17 
	#LOG_TAG
 "´İ”t›s"

	)

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

21 
	~<uni¡d.h
>

22 
	~<cuts/sock‘s.h
>

23 
	~<”ºo.h
>

24 
	~<as£¹.h
>

26 
	~<cuts/´İ”t›s.h
>

27 
	~"loghack.h
"

29 #ifdeà
HAVE_LIBC_SYSTEM_PROPERTIES


31 
	#_REALLY_INCLUDE_SYS__SYSTEM_PROPERTIES_H_


	)

34 
	$´İ”ty_£t
(cÚ¡ *
key
, cÚ¡ *
v®ue
)

40 
	}
}

42 
	$´İ”ty_g‘
(cÚ¡ *
key
, *
v®ue
, cÚ¡ *
deçuÉ_v®ue
)

59 
	}
}

61 
´İ”ty_li¡
((*
´İâ
)(cÚ¡ *
key
, cÚ¡ *
v®ue
, *
cook›
),

62 *
cook›
)

77 
	}
}

79 #–ià
defšed
(
HAVE_SYSTEM_PROPERTY_SERVER
)

87 
	~<¡dio.h
>

88 
	~<sys/ty³s.h
>

89 
	~<sys/sock‘.h
>

90 
	~<sys/un.h
>

91 
	~<±h»ad.h
>

93 
±h»ad_Úû_t
 
	ggIn™Onû
 = 
PTHREAD_ONCE_INIT
;

94 
±h»ad_mu‹x_t
 
	ggPrİ”tyFdLock
 = 
PTHREAD_MUTEX_INITIALIZER
;

95 
	ggPrİFd
 = -1;

102 
	$cÚÃùToS”v”
(cÚ¡ * 
feName
)

104 
sock
 = -1;

105 
cc
;

107 
sockaddr_un
 
addr
;

109 
sock
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

110 ià(
sock
 < 0) {

111 
	`ALOGW
("UNIX domaš sock‘ c»©çed (”ºo=%d)\n", 
”ºo
);

116 
	`¡rıy
(
addr
.
sun_·th
, 
feName
);

117 
addr
.
sun_çmy
 = 
AF_UNIX
;

118 
cc
 = 
	`cÚÃù
(
sock
, (
sockaddr
*è&
addr
, 
	`SUN_LEN
(&addr));

119 ià(
cc
 < 0) {

124 
	`şo£
(
sock
);

128  
sock
;

129 
	}
}

134 
	$š™
()

136 
	`as£¹
(
gPrİFd
 == -1);

138 
gPrİFd
 = 
	`cÚÃùToS”v”
(
SYSTEM_PROPERTY_PIPE_NAME
);

139 ià(
gPrİFd
 < 0) {

144 
	}
}

146 
	$´İ”ty_g‘
(cÚ¡ *
key
, *
v®ue
, cÚ¡ *
deçuÉ_v®ue
)

148 
£ndBuf
[1+
PROPERTY_KEY_MAX
];

149 
»cvBuf
[1+
PROPERTY_VALUE_MAX
];

150 
Ën
 = -1;

154 
	`±h»ad_Úû
(&
gIn™Onû
, 
š™
);

155 ià(
gPrİFd
 < 0) {

157 ià(
deçuÉ_v®ue
 !ğ
NULL
) {

158 
	`¡rıy
(
v®ue
, 
deçuÉ_v®ue
);

159 
Ën
 = 
	`¡¾’
(
v®ue
);

161  
Ën
;

164 ià(
	`¡¾’
(
key
è>ğ
PROPERTY_KEY_MAX
)  -1;

166 
	`mem£t
(
£ndBuf
, 0xdd, (sendBuf));

168 
£ndBuf
[0] = (è
kSy¡emPrİ”tyG‘
;

169 
	`¡rıy
(
£ndBuf
+1, 
key
);

171 
	`±h»ad_mu‹x_lock
(&
gPrİ”tyFdLock
);

172 ià(
	`wr™e
(
gPrİFd
, 
£ndBuf
, (sendBuf)) != (sendBuf)) {

173 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

176 ià(
	`»ad
(
gPrİFd
, 
»cvBuf
, (recvBuf)) != (recvBuf)) {

177 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

180 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

183 ià(
»cvBuf
[0] == 0) {

184 ià(
deçuÉ_v®ue
 !ğ
NULL
) {

185 
	`¡rıy
(
v®ue
, 
deçuÉ_v®ue
);

186 
Ën
 = 
	`¡¾’
(
v®ue
);

194 
v®ue
[0] = '\0';

195 
Ën
 = 0;

197 } ià(
»cvBuf
[0] == 1) {

198 
	`¡rıy
(
v®ue
, 
»cvBuf
+1);

199 
Ën
 = 
	`¡¾’
(
v®ue
);

201 
	`ALOGE
("Got strange„esponseo…roperty_get„equest (%d)\n",

202 
»cvBuf
[0]);

203 
	`as£¹
(0);

209  
Ën
;

210 
	}
}

213 
	$´İ”ty_£t
(cÚ¡ *
key
, cÚ¡ *
v®ue
)

215 
£ndBuf
[1+
PROPERTY_KEY_MAX
+
PROPERTY_VALUE_MAX
];

216 
»cvBuf
[1];

217 
»suÉ
 = -1;

221 
	`±h»ad_Úû
(&
gIn™Onû
, 
š™
);

222 ià(
gPrİFd
 < 0)

225 ià(
	`¡¾’
(
key
è>ğ
PROPERTY_KEY_MAX
)  -1;

226 ià(
	`¡¾’
(
v®ue
è>ğ
PROPERTY_VALUE_MAX
)  -1;

228 
	`mem£t
(
£ndBuf
, 0xdd, (sendBuf));

230 
£ndBuf
[0] = (è
kSy¡emPrİ”tyS‘
;

231 
	`¡rıy
(
£ndBuf
+1, 
key
);

232 
	`¡rıy
(
£ndBuf
+1+
PROPERTY_KEY_MAX
, 
v®ue
);

234 
	`±h»ad_mu‹x_lock
(&
gPrİ”tyFdLock
);

235 ià(
	`wr™e
(
gPrİFd
, 
£ndBuf
, (sendBuf)) != (sendBuf)) {

236 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

239 ià(
	`»ad
(
gPrİFd
, 
»cvBuf
, (recvBuf)) != (recvBuf)) {

240 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

243 
	`±h»ad_mu‹x_uÆock
(&
gPrİ”tyFdLock
);

245 ià(
»cvBuf
[0] != 1)

248 
	}
}

250 
´İ”ty_li¡
((*
´İâ
)(cÚ¡ *
key
, cÚ¡ *
v®ue
, *
cook›
),

251 *
cook›
)

254 
	`±h»ad_Úû
(&
gIn™Onû
, 
š™
);

255 ià(
gPrİFd
 < 0)

259 
	}
}

265 
	~<cuts/th»ads.h
>

267 
mu‹x_t
 
	g’v_lock
 = 
MUTEX_INITIALIZER
;

269 
	$´İ”ty_g‘
(cÚ¡ *
key
, *
v®ue
, cÚ¡ *
deçuÉ_v®ue
)

271 
’ame
[
PROPERTY_KEY_MAX
 + 6];

272 *
p
;

273 
Ën
;

275 
Ën
 = 
	`¡¾’
(
key
);

276 if(
Ën
 >ğ
PROPERTY_KEY_MAX
)  -1;

277 
	`memıy
(
’ame
, "PROP_", 5);

278 
	`memıy
(
’ame
 + 5, 
key
, 
Ën
 + 1);

280 
	`mu‹x_lock
(&
’v_lock
);

282 
p
 = 
	`g‘’v
(
’ame
);

283 if(
p
 == 0)… = "";

284 
Ën
 = 
	`¡¾’
(
p
);

285 if(
Ën
 >ğ
PROPERTY_VALUE_MAX
) {

286 
Ën
 = 
PROPERTY_VALUE_MAX
 - 1;

289 if((
Ën
 =ğ0è&& 
deçuÉ_v®ue
) {

290 
Ën
 = 
	`¡¾’
(
deçuÉ_v®ue
);

291 
	`memıy
(
v®ue
, 
deçuÉ_v®ue
, 
Ën
 + 1);

293 
	`memıy
(
v®ue
, 
p
, 
Ën
);

294 
v®ue
[
Ën
] = 0;

297 
	`mu‹x_uÆock
(&
’v_lock
);

299  
Ën
;

300 
	}
}

303 
	$´İ”ty_£t
(cÚ¡ *
key
, cÚ¡ *
v®ue
)

305 
’ame
[
PROPERTY_KEY_MAX
 + 6];

306 *
p
;

307 
Ën
;

308 
r
;

310 if(
	`¡¾’
(
v®ue
è>ğ
PROPERTY_VALUE_MAX
)  -1;

312 
Ën
 = 
	`¡¾’
(
key
);

313 if(
Ën
 >ğ
PROPERTY_KEY_MAX
)  -1;

314 
	`memıy
(
’ame
, "PROP_", 5);

315 
	`memıy
(
’ame
 + 5, 
key
, 
Ën
 + 1);

317 
	`mu‹x_lock
(&
’v_lock
);

318 #ifdeà
HAVE_MS_C_RUNTIME


320 
‹mp
[256];

321 
	`¢´štf
Ğ
‹mp
, Ñemp), "%s=%s", 
’ame
, 
v®ue
);

322 
	`pu‹nv
(
‹mp
);

323 
r
 = 0;

326 
r
 = 
	`£‹nv
(
’ame
, 
v®ue
, 1);

328 
	`mu‹x_uÆock
(&
’v_lock
);

330  
r
;

331 
	}
}

333 
´İ”ty_li¡
((*
´İâ
)(cÚ¡ *
key
, cÚ¡ *
v®ue
, *
cook›
),

334 *
cook›
)

337 
	}
}

	@libs/libcutils/qsort_r_compat.c

17 
	~<¡dlib.h
>

18 
	~<cuts/qsÜt_r_com·t.h
>

20 #ià
HAVE_BSD_QSORT_R


26 
qsÜt_r_com·t
(* 
ba£
, 
size_t
 
Ãl
, size_ˆ
width
, * 
thunk
,

27 (*
com·r
)(*, const * , const *)) {

28 
	`qsÜt_r
(
ba£
, 
Ãl
, 
width
, 
thunk
, 
com·r
);

29 
	}
}

31 #–ià
HAVE_GNU_QSORT_R


37 
	scom·r_d©a
 {

38 * 
	mthunk
;

39 (*
	mcom·r
)(*, const * , const *);

42 
	$com·r_w¿µ”
(cÚ¡ * 
a
, cÚ¡ * 
b
, * 
d©a
) {

43 
com·r_d©a
* com·r_d©¨ğ(com·r_d©a*)
d©a
;

44  
com·r_d©a
->
	`com·r
(com·r_d©a->
thunk
, 
a
, 
b
);

45 
	}
}

47 
qsÜt_r_com·t
(* 
ba£
, 
size_t
 
Ãl
, size_ˆ
width
, * 
thunk
,

48 (*
com·r
)(*, const * , const *)) {

49 
com·r_d©a
 compar_data;

50 
com·r_d©a
.
thunk
 =hunk;

51 
com·r_d©a
.
com·r
 = compar;

52 
	`qsÜt_r
(
ba£
, 
Ãl
, 
width
, 
com·r_w¿µ”
, &
com·r_d©a
);

53 
	}
}

61 
	~<cuts/th»ads.h
>

63 
th»ad_¡Üe_t
 
	gcom·r_d©a_key
 = 
THREAD_STORE_INITIALIZER
;

65 
	scom·r_d©a
 {

66 * 
	mthunk
;

67 (*
	mcom·r
)(*, const * , const *);

70 
	$com·r_w¿µ”
(cÚ¡ * 
a
, cÚ¡ * 
b
) {

71 
com·r_d©a
* com·r_d©¨ğ(com·r_d©a*)
	`th»ad_¡Üe_g‘
(&
com·r_d©a_key
);

72  
com·r_d©a
->
	`com·r
(com·r_d©a->
thunk
, 
a
, 
b
);

73 
	}
}

75 
qsÜt_r_com·t
(* 
ba£
, 
size_t
 
Ãl
, size_ˆ
width
, * 
thunk
,

76 (*
com·r
)(*, const * , const *)) {

77 
com·r_d©a
 compar_data;

78 
com·r_d©a
.
thunk
 =hunk;

79 
com·r_d©a
.
com·r
 = compar;

80 
	`th»ad_¡Üe_£t
(&
com·r_d©a_key
, &
com·r_d©a
, 
NULL
);

81 
	`qsÜt
(
ba£
, 
Ãl
, 
width
, 
com·r_w¿µ”
);

82 
	}
}

	@libs/libcutils/qtaguid.c

20 
	#LOG_TAG
 "qguid"

	)

22 
	~<cuts/qguid.h
>

23 
	~<cuts/log.h
>

24 
	~<”ºo.h
>

25 
	~<fú.h
>

26 
	~<¡dio.h
>

27 
	~<¡ršg.h
>

28 
	~<uni¡d.h
>

29 
	~<±h»ad.h
>

31 cÚ¡ * 
	gCTRL_PROCPATH
 = "/proc/net/xt_qtaguid/ctrl";

32 cÚ¡ 
	gCTRL_MAX_INPUT_LEN
 = 128;

33 cÚ¡ *
	gGLOBAL_PACIFIER_PARAM
 = "/sys/module/xt_qtaguid/parameters/passive";

34 cÚ¡ *
	gTAG_PACIFIER_PARAM
 = "/sys/module/xt_qtaguid/parameters/tag_tracking_passive";

44 
	g»sT¿ckFd
 = -1;

45 
±h»ad_Úû_t
 
	g»sT¿ckIn™DÚe
 = 
PTHREAD_ONCE_INIT
;

48 
	$qguid_»sT¿ck
() {

49 
»sT¿ckFd
 = 
	`TEMP_FAILURE_RETRY
(
	`İ’
("/dev/xt_qguid", 
O_RDONLY
));

50 ià(
»sT¿ckFd
 >=0) {

51 
	`TEMP_FAILURE_RETRY
(
	`fú
(
»sT¿ckFd
, 
F_SETFD
, 
FD_CLOEXEC
));

53 
	}
}

60 
	$wr™e_ù¾
(cÚ¡ *
cmd
) {

61 
fd
, 
»s
, 
§vedE¼no
;

63 
	`ALOGV
("wr™e_ù¾(%s)", 
cmd
);

65 
fd
 = 
	`TEMP_FAILURE_RETRY
(
	`İ’
(
CTRL_PROCPATH
, 
O_WRONLY
));

66 ià(
fd
 < 0) {

67  -
”ºo
;

70 
»s
 = 
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
fd
, 
cmd
, 
	`¡¾’
(cmd)));

71 ià(
»s
 < 0) {

72 
§vedE¼no
 = 
”ºo
;

74 
§vedE¼no
 = 0;

76 ià(
»s
 < 0) {

77 
	`ALOGI
("Faed wr™e_ù¾(%sè»s=%dƒ¼no=%d", 
cmd
, 
»s
, 
§vedE¼no
);

79 
	`şo£
(
fd
);

80  -
§vedE¼no
;

81 
	}
}

83 
	$wr™e_·¿m
(cÚ¡ *
·¿m_·th
, cÚ¡ *
v®ue
) {

84 
·¿m_fd
;

85 
»s
;

87 
·¿m_fd
 = 
	`TEMP_FAILURE_RETRY
(
	`İ’
(
·¿m_·th
, 
O_WRONLY
));

88 ià(
·¿m_fd
 < 0) {

89  -
”ºo
;

91 
»s
 = 
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
·¿m_fd
, 
v®ue
, 
	`¡¾’
(value)));

92 ià(
»s
 < 0) {

93  -
”ºo
;

95 
	`şo£
(
·¿m_fd
);

97 
	}
}

99 
	$qguid_gSock‘
(
sockfd
, 
g
, 
uid_t
 
uid
) {

100 
lšeBuf
[
CTRL_MAX_INPUT_LEN
];

101 
»s
;

102 
ušt64_t
 
kTag
 = ((ušt64_t)
g
 << 32);

104 
	`±h»ad_Úû
(&
»sT¿ckIn™DÚe
, 
qguid_»sT¿ck
);

106 
	`¢´štf
(
lšeBuf
, ÖšeBuf), "ˆ%d %Îu %d", 
sockfd
, 
kTag
, 
uid
);

108 
	`ALOGV
("Taggšg sock‘ %d w™hag %Îx{%u,0} fÜ uid %d", 
sockfd
, 
kTag
, 
g
, 
uid
);

110 
»s
 = 
	`wr™e_ù¾
(
lšeBuf
);

111 ià(
»s
 < 0) {

112 
	`ALOGI
("Tagging socket %d withag %llx(%d) for uid %d failedƒrrno=%d",

113 
sockfd
, 
kTag
, 
g
, 
uid
, 
»s
);

116  
»s
;

117 
	}
}

119 
	$qguid_uÁagSock‘
(
sockfd
) {

120 
lšeBuf
[
CTRL_MAX_INPUT_LEN
];

121 
»s
;

123 
	`ALOGV
("UÁaggšg sock‘ %d", 
sockfd
);

125 
	`¢´štf
(
lšeBuf
, ÖšeBuf), "u %d", 
sockfd
);

126 
»s
 = 
	`wr™e_ù¾
(
lšeBuf
);

127 ià(
»s
 < 0) {

128 
	`ALOGI
("UÁaggšg sock‘ %d faedƒ¼no=%d", 
sockfd
, 
»s
);

131  
»s
;

132 
	}
}

134 
	$qguid_£tCouÁ”S‘
(
couÁ”S‘Num
, 
uid_t
 
uid
) {

135 
lšeBuf
[
CTRL_MAX_INPUT_LEN
];

136 
»s
;

138 
	`ALOGV
("S‘tšg couÁ” tØ£ˆ%d fÜ uid %d", 
couÁ”S‘Num
, 
uid
);

140 
	`¢´štf
(
lšeBuf
, ÖšeBuf), " %d %d", 
couÁ”S‘Num
, 
uid
);

141 
»s
 = 
	`wr™e_ù¾
(
lšeBuf
);

142  
»s
;

143 
	}
}

145 
	$qguid_d–‘eTagD©a
(
g
, 
uid_t
 
uid
) {

146 
lšeBuf
[
CTRL_MAX_INPUT_LEN
];

147 
fd
, 
út
 = 0, 
»s
 = 0;

148 
ušt64_t
 
kTag
 = (ušt64_t)
g
 << 32;

150 
	`ALOGV
("D–‘šgag d©¨w™hag %Îx{%d,0} fÜ uid %d", 
kTag
, 
g
, 
uid
);

152 
	`±h»ad_Úû
(&
»sT¿ckIn™DÚe
, 
qguid_»sT¿ck
);

154 
	`¢´štf
(
lšeBuf
, ÖšeBuf), "d %Îu %d", 
kTag
, 
uid
);

155 
»s
 = 
	`wr™e_ù¾
(
lšeBuf
);

156 ià(
»s
 < 0) {

157 
	`ALOGI
("Deleteingag data withag %llx/%d for uid %d failed with cnt=%dƒrrno=%d",

158 
kTag
, 
g
, 
uid
, 
út
, 
”ºo
);

161  
»s
;

162 
	}
}

164 
	$qguid_£tPacif›r
(
Ú
) {

165 
·¿m_fd
;

166 
»s
;

167 cÚ¡ *
v®ue
;

169 
v®ue
 = 
Ú
 ? "Y" : "N";

170 ià(
	`wr™e_·¿m
(
GLOBAL_PACIFIER_PARAM
, 
v®ue
) < 0) {

171  -
”ºo
;

173 ià(
	`wr™e_·¿m
(
TAG_PACIFIER_PARAM
, 
v®ue
) < 0) {

174  -
”ºo
;

177 
	}
}

	@libs/libcutils/record_stream.c

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<as£¹.h
>

21 
	~<”ºo.h
>

22 
	~<cuts/»cÜd_¡»am.h
>

23 
	~<¡ršg.h
>

24 
	~<¡dšt.h
>

25 #ifdeà
HAVE_WINSOCK


26 
	~<wšsock2.h
>

28 
	~<Ãtš‘/š.h
>

31 
	#HEADER_SIZE
 4

	)

33 
	sRecÜdSŒ—m
 {

34 
	mfd
;

35 
size_t
 
	mmaxRecÜdL’
;

37 *
	mbufãr
;

39 *
	muncÚsumed
;

40 *
	m»ad_’d
;

41 *
	mbufãr_’d
;

45 
RecÜdSŒ—m
 *
	$»cÜd_¡»am_Ãw
(
fd
, 
size_t
 
maxRecÜdL’
)

47 
RecÜdSŒ—m
 *
»t
;

49 
	`as£¹
 (
maxRecÜdL’
 <= 0xffff);

51 
»t
 = (
RecÜdSŒ—m
 *)
	`ÿÎoc
(1, (RecordStream));

53 
»t
->
fd
 = fd;

54 
»t
->
maxRecÜdL’
 = maxRecordLen;

55 
»t
->
bufãr
 = (*)
	`m®loc
 (
maxRecÜdL’
 + 
HEADER_SIZE
);

57 
»t
->
uncÚsumed
 =„‘->
bufãr
;

58 
»t
->
»ad_’d
 =„‘->
bufãr
;

59 
»t
->
bufãr_’d
 =„‘->
bufãr
 + 
maxRecÜdL’
 + 
HEADER_SIZE
;

61  
»t
;

62 
	}
}

65 
	$»cÜd_¡»am_ä“
(
RecÜdSŒ—m
 *
rs
)

67 
	`ä“
(
rs
->
bufãr
);

68 
	`ä“
(
rs
);

69 
	}
}

73 * 
	$g‘EndOfRecÜd
 (*
p_begš
,

74 *
p_’d
)

76 
size_t
 
Ën
;

77 * 
p_»t
;

79 ià(
p_’d
 < 
p_begš
 + 
HEADER_SIZE
) {

80  
NULL
;

84 
Ën
 = 
	`Áohl
(*((
ušt32_t
 *)
p_begš
));

86 
p_»t
 = 
p_begš
 + 
HEADER_SIZE
 + 
Ën
;

88 ià(
p_’d
 < 
p_»t
) {

89  
NULL
;

92  
p_»t
;

93 
	}
}

95 *
	$g‘NextRecÜd
 (
RecÜdSŒ—m
 *
p_rs
, 
size_t
 *
p_outRecÜdL’
)

97 *
»cÜd_¡¬t
, *
»cÜd_’d
;

99 
»cÜd_’d
 = 
	`g‘EndOfRecÜd
 (
p_rs
->
uncÚsumed
,…_rs->
»ad_’d
);

101 ià(
»cÜd_’d
 !ğ
NULL
) {

103 
»cÜd_¡¬t
 = 
p_rs
->
uncÚsumed
 + 
HEADER_SIZE
;

104 
p_rs
->
uncÚsumed
 = 
»cÜd_’d
;

106 *
p_outRecÜdL’
 = 
»cÜd_’d
 - 
»cÜd_¡¬t
;

108  
»cÜd_¡¬t
;

111  
NULL
;

112 
	}
}

127 
	$»cÜd_¡»am_g‘_Ãxt
 (
RecÜdSŒ—m
 *
p_rs
, ** 
p_outRecÜd
,

128 
size_t
 *
p_outRecÜdL’
)

130 *
»t
;

132 
ssize_t
 
couÁR—d
;

135 
»t
 = 
	`g‘NextRecÜd
 (
p_rs
, 
p_outRecÜdL’
);

137 ià(
»t
 !ğ
NULL
) {

138 *
p_outRecÜd
 = 
»t
;

143 ià(
p_rs
->
uncÚsumed
 =ğp_rs->
bufãr


144 && 
p_rs
->
»ad_’d
 =ğp_rs->
bufãr_’d


148 
	`as£¹
 (0);

149 
”ºo
 = 
EFBIG
;

153 ià(
p_rs
->
uncÚsumed
 !ğp_rs->
bufãr
) {

155 
size_t
 
toMove
;

157 
toMove
 = 
p_rs
->
»ad_’d
 -…_rs->
uncÚsumed
;

158 ià(
toMove
) {

159 
	`memmove
(
p_rs
->
bufãr
,…_rs->
uncÚsumed
, 
toMove
);

162 
p_rs
->
»ad_’d
 =…_rs->
bufãr
 + 
toMove
;

163 
p_rs
->
uncÚsumed
 =…_rs->
bufãr
;

166 
couÁR—d
 = 
	`»ad
 (
p_rs
->
fd
,…_rs->
»ad_’d
,…_rs->
bufãr_’d
 -…_rs->read_end);

168 ià(
couÁR—d
 <= 0) {

170 *
p_outRecÜd
 = 
NULL
;

171  
couÁR—d
;

174 
p_rs
->
»ad_’d
 +ğ
couÁR—d
;

176 
»t
 = 
	`g‘NextRecÜd
 (
p_rs
, 
p_outRecÜdL’
);

178 ià(
»t
 =ğ
NULL
) {

180 
”ºo
 = 
EAGAIN
;

184 *
p_outRecÜd
 = 
»t
;

186 
	}
}

	@libs/libcutils/sched_policy.c

19 
	#LOG_TAG
 "SchedPŞicy"

	)

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<uni¡d.h
>

24 
	~<¡ršg.h
>

25 
	~<”ºo.h
>

26 
	~<fú.h
>

27 
	~<cuts/sched_pŞicy.h
>

28 
	~<cuts/log.h
>

34 
šlše
 
SchedPŞicy
 
	$_pŞicy
(
SchedPŞicy
 
p
)

36  
p
 =ğ
SP_DEFAULT
 ? 
SP_SYSTEM_DEFAULT
 :…;

37 
	}
}

39 #ià
defšed
(
HAVE_ANDROID_OS
è&& defšed(
HAVE_SCHED_H
è&& defšed(
HAVE_PTHREADS
)

41 
	~<sched.h
>

42 
	~<±h»ad.h
>

44 #iâdeà
SCHED_NORMAL


45 
	#SCHED_NORMAL
 0

	)

48 #iâdeà
SCHED_BATCH


49 
	#SCHED_BATCH
 3

	)

52 
	#POLICY_DEBUG
 0

	)

54 
	#CAN_SET_SP_SYSTEM
 0

55 

	)

56 
±h»ad_Úû_t
 
	gthe_Úû
 = 
PTHREAD_ONCE_INIT
;

58 
	g__sys_suµÜts_schedgroups
 = -1;

61 
	gbg_cgroup_fd
 = -1;

62 
	gfg_cgroup_fd
 = -1;

63 #ià
CAN_SET_SP_SYSTEM


64 
	gsy¡em_cgroup_fd
 = -1;

68 
	$add_tid_to_cgroup
(
tid
, 
SchedPŞicy
 
pŞicy
)

70 
fd
;

72 
pŞicy
) {

73 
SP_BACKGROUND
:

74 
fd
 = 
bg_cgroup_fd
;

76 
SP_FOREGROUND
:

77 
SP_AUDIO_APP
:

78 
SP_AUDIO_SYS
:

79 
fd
 = 
fg_cgroup_fd
;

81 #ià
CAN_SET_SP_SYSTEM


82 
SP_SYSTEM
:

83 
fd
 = 
sy¡em_cgroup_fd
;

87 
fd
 = -1;

91 ià(
fd
 < 0) {

92 
	`SLOGE
("add_tid_to_cgrou°çed;…Şicy=%d\n", 
pŞicy
);

97 
‹xt
[22];

98 *
’d
 = 
‹xt
 + (text) - 1;

99 *
±r
 = 
’d
;

100 *
±r
 = '\0';

101 
tid
 > 0) {

102 *--
±r
 = '0' + (
tid
 % 10);

103 
tid
 =id / 10;

106 ià(
	`wr™e
(
fd
, 
±r
, 
’d
 -…tr) < 0) {

111 ià(
”ºo
 =ğ
ESRCH
)

113 
	`SLOGW
("add_tid_to_cgroup failedo write '%s' (%s);…olicy=%d\n",

114 
±r
, 
	`¡»¼Ü
(
”ºo
), 
pŞicy
);

119 
	}
}

121 
	$__š™Ÿlize
() {

122 * 
f’ame
;

123 ià(!
	`acûss
("/dev/ıuùl/sks", 
F_OK
)) {

124 
__sys_suµÜts_schedgroups
 = 1;

126 #ià
CAN_SET_SP_SYSTEM


127 
f’ame
 = "/dev/cpuctl/tasks";

128 
sy¡em_cgroup_fd
 = 
	`İ’
(
f’ame
, 
O_WRONLY
 | 
O_CLOEXEC
);

129 ià(
sy¡em_cgroup_fd
 < 0) {

130 
	`SLOGV
("İ’ oà% çed: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

134 
f’ame
 = "/dev/cpuctl/apps/tasks";

135 
fg_cgroup_fd
 = 
	`İ’
(
f’ame
, 
O_WRONLY
 | 
O_CLOEXEC
);

136 ià(
fg_cgroup_fd
 < 0) {

137 
	`SLOGE
("İ’ oà% çed: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

140 
f’ame
 = "/dev/cpuctl/apps/bg_non_interactive/tasks";

141 
bg_cgroup_fd
 = 
	`İ’
(
f’ame
, 
O_WRONLY
 | 
O_CLOEXEC
);

142 ià(
bg_cgroup_fd
 < 0) {

143 
	`SLOGE
("İ’ oà% çed: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

146 
__sys_suµÜts_schedgroups
 = 0;

148 
	}
}

161 
	$g‘ScheduËrGroup
(
tid
, * 
buf
, 
size_t
 
bufL’
)

163 #ifdeà
HAVE_ANDROID_OS


164 
·thBuf
[32];

165 
lšeBuf
[256];

166 
FILE
 *
å
;

168 
	`¢´štf
(
·thBuf
, Õ©hBuf), "/´oc/%d/cgroup", 
tid
);

169 ià(!(
å
 = 
	`fİ’
(
·thBuf
, "r"))) {

173 
	`fg‘s
(
lšeBuf
, ÖšeBufè-1, 
å
)) {

174 *
Ãxt
 = 
lšeBuf
;

175 *
subsys
;

176 *
g½
;

177 
size_t
 
Ën
;

180 ià(!
	`¡r£p
(&
Ãxt
, ":")) {

181 
out_bad_d©a
;

184 ià(!(
subsys
 = 
	`¡r£p
(&
Ãxt
, ":"))) {

185 
out_bad_d©a
;

188 ià(
	`¡rcmp
(
subsys
, "cpu")) {

193 ià(!(
g½
 = 
	`¡r£p
(&
Ãxt
, ":"))) {

194 
out_bad_d©a
;

196 
g½
++;

197 
Ën
 = 
	`¡¾’
(
g½
);

198 
g½
[
Ën
-1] = '\0';

200 ià(
bufL’
 <ğ
Ën
) {

201 
Ën
 = 
bufL’
 - 1;

203 
	`¡ºıy
(
buf
, 
g½
, 
Ën
);

204 
buf
[
Ën
] = '\0';

205 
	`fşo£
(
å
);

209 
	`SLOGE
("Failedo find cpu subsys");

210 
	`fşo£
(
å
);

212 
out_bad_d©a
:

213 
	`SLOGE
("Bad cgrou°d©¨{%s}", 
lšeBuf
);

214 
	`fşo£
(
å
);

217 
”ºo
 = 
ENOSYS
;

220 
	}
}

222 
	$g‘_sched_pŞicy
(
tid
, 
SchedPŞicy
 *
pŞicy
)

224 #ifdeà
HAVE_GETTID


225 ià(
tid
 == 0) {

226 
tid
 = 
	`g‘tid
();

229 
	`±h»ad_Úû
(&
the_Úû
, 
__š™Ÿlize
);

231 ià(
__sys_suµÜts_schedgroups
) {

232 
g½Buf
[32];

233 ià(
	`g‘ScheduËrGroup
(
tid
, 
g½Buf
, (grpBuf)) < 0)

235 ià(
g½Buf
[0] == '\0') {

236 *
pŞicy
 = 
SP_SYSTEM
;

237 } ià(!
	`¡rcmp
(
g½Buf
, "apps/bg_non_interactive")) {

238 *
pŞicy
 = 
SP_BACKGROUND
;

239 } ià(!
	`¡rcmp
(
g½Buf
, "apps")) {

240 *
pŞicy
 = 
SP_FOREGROUND
;

242 
”ºo
 = 
ERANGE
;

246 
rc
 = 
	`sched_g‘scheduËr
(
tid
);

247 ià(
rc
 < 0)

249 ià(
rc
 =ğ
SCHED_NORMAL
)

250 *
pŞicy
 = 
SP_FOREGROUND
;

251 ià(
rc
 =ğ
SCHED_BATCH
)

252 *
pŞicy
 = 
SP_BACKGROUND
;

254 
”ºo
 = 
ERANGE
;

259 
	}
}

261 
	$£t_sched_pŞicy
(
tid
, 
SchedPŞicy
 
pŞicy
)

263 #ifdeà
HAVE_GETTID


264 ià(
tid
 == 0) {

265 
tid
 = 
	`g‘tid
();

268 
pŞicy
 = 
	`_pŞicy
(policy);

269 
	`±h»ad_Úû
(&
the_Úû
, 
__š™Ÿlize
);

271 #ià
POLICY_DEBUG


272 
¡©fe
[64];

273 
¡©lše
[1024];

274 
th»ad_Çme
[255];

275 
fd
;

277 
	`¥rštf
(
¡©fe
, "/´oc/%d/¡©", 
tid
);

278 
	`mem£t
(
th»ad_Çme
, 0, (thread_name));

280 
fd
 = 
	`İ’
(
¡©fe
, 
O_RDONLY
);

281 ià(
fd
 >= 0) {

282 
rc
 = 
	`»ad
(
fd
, 
¡©lše
, 1023);

283 
	`şo£
(
fd
);

284 
¡©lše
[
rc
] = 0;

285 *
p
 = 
¡©lše
;

286 *
q
;

288 
p
 = 
¡©lše
; *p != '(';…++);

289 
p
++;

290 
q
 = 
p
; *q != ')'; q++);

292 
	`¡ºıy
(
th»ad_Çme
, 
p
, (
q
-p));

294 
pŞicy
) {

295 
SP_BACKGROUND
:

296 
	`SLOGD
("vvvid %d (%s)", 
tid
, 
th»ad_Çme
);

298 
SP_FOREGROUND
:

299 
SP_AUDIO_APP
:

300 
SP_AUDIO_SYS
:

301 
	`SLOGD
("^^^id %d (%s)", 
tid
, 
th»ad_Çme
);

303 
SP_SYSTEM
:

304 
	`SLOGD
("///id %d (%s)", 
tid
, 
th»ad_Çme
);

307 
	`SLOGD
("???id %d (%s)", 
tid
, 
th»ad_Çme
);

312 ià(
__sys_suµÜts_schedgroups
) {

313 ià(
	`add_tid_to_cgroup
(
tid
, 
pŞicy
)) {

314 ià(
”ºo
 !ğ
ESRCH
 &&ƒ¼nØ!ğ
ENOENT
)

315  -
”ºo
;

318 
sched_·¿m
 
·¿m
;

320 
·¿m
.
sched_´iÜ™y
 = 0;

321 
	`sched_£tscheduËr
(
tid
,

322 (
pŞicy
 =ğ
SP_BACKGROUND
) ?

323 
SCHED_BATCH
 : 
SCHED_NORMAL
,

324 &
·¿m
);

328 
	}
}

334 
	$£t_sched_pŞicy
(
tid
, 
SchedPŞicy
 
pŞicy
)

337 
	}
}

339 
	$g‘_sched_pŞicy
(
tid
, 
SchedPŞicy
 *
pŞicy
)

341 *
pŞicy
 = 
SP_SYSTEM_DEFAULT
;

343 
	}
}

347 cÚ¡ *
	$g‘_sched_pŞicy_Çme
(
SchedPŞicy
 
pŞicy
)

349 
pŞicy
 = 
	`_pŞicy
(policy);

350 cÚ¡ * cÚ¡ 
¡ršgs
[
SP_CNT
] = {

351 [
SP_BACKGROUND
] = "bg",

352 [
SP_FOREGROUND
] = "fg",

353 [
SP_SYSTEM
] = " ",

354 [
SP_AUDIO_APP
] = "aa",

355 [
SP_AUDIO_SYS
] = "as",

357 ià((
pŞicy
 < 
SP_CNT
è&& (
¡ršgs
[pŞicy] !ğ
NULL
))

358  
¡ršgs
[
pŞicy
];

361 
	}
}

	@libs/libcutils/selector.c

17 
	#LOG_TAG
 "£ËùÜ"

	)

19 
	~<as£¹.h
>

20 
	~<”ºo.h
>

21 
	~<±h»ad.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/ty³s.h
>

25 
	~<uni¡d.h
>

27 
	~<cuts/¬¿y.h
>

28 
	~<cuts/£ËùÜ.h
>

30 
	~"loghack.h
"

32 
	sS–eùÜ
 {

33 
A¼ay
* 
	m£ËùabËFds
;

34 
boŞ
 
	mloİšg
;

35 
fd_£t
 
	m»adFds
;

36 
fd_£t
 
	mwr™eFds
;

37 
fd_£t
 
	mexû±Fds
;

38 
	mmaxFd
;

39 
	mwakeupPe
[2];

40 
S–eùabËFd
* 
	mwakeupFd
;

42 
boŞ
 
	mšS–eù
;

43 
±h»ad_mu‹x_t
 
	mšS–eùLock
;

47 
	$—tWakeupD©a
(
S–eùabËFd
* 
wakeupFd
) {

48 
g¬bage
[64];

49 ià(
	`»ad
(
wakeupFd
->
fd
, 
g¬bage
, (garbage)) < 0) {

50 ià(
”ºo
 =ğ
EINTR
) {

51 
	`ALOGI
("read() interrupted.");

53 
	`LOG_ALWAYS_FATAL
("Thi should‚ev” h­³n: %s", 
	`¡»¼Ü
(
”ºo
));

56 
	}
}

58 
	$£tInS–eù
(
S–eùÜ
* 
£ËùÜ
, 
boŞ
 
šS–eù
) {

59 
	`±h»ad_mu‹x_lock
(&
£ËùÜ
->
šS–eùLock
);

60 
£ËùÜ
->
šS–eù
 = inSelect;

61 
	`±h»ad_mu‹x_uÆock
(&
£ËùÜ
->
šS–eùLock
);

62 
	}
}

64 
boŞ
 
	$isInS–eù
(
S–eùÜ
* 
£ËùÜ
) {

65 
	`±h»ad_mu‹x_lock
(&
£ËùÜ
->
šS–eùLock
);

66 
boŞ
 
šS–eù
 = 
£ËùÜ
->inSelect;

67 
	`±h»ad_mu‹x_uÆock
(&
£ËùÜ
->
šS–eùLock
);

68  
šS–eù
;

69 
	}
}

71 
	$£ËùÜWakeUp
(
S–eùÜ
* 
£ËùÜ
) {

72 ià(!
	`isInS–eù
(
£ËùÜ
)) {

77 
g¬bage
[1];

78 ià(
	`wr™e
(
£ËùÜ
->
wakeupPe
[1], 
g¬bage
, (garbage)) < 0) {

79 ià(
”ºo
 =ğ
EINTR
) {

80 
	`ALOGI
("read() interrupted.");

82 
	`LOG_ALWAYS_FATAL
("Thi should‚ev” h­³n: %s", 
	`¡»¼Ü
(
”ºo
));

85 
	}
}

87 
S–eùÜ
* 
	$£ËùÜC»©e
() {

88 
S–eùÜ
* 
£ËùÜ
 = 
	`ÿÎoc
(1, (Selector));

89 ià(
£ËùÜ
 =ğ
NULL
) {

90 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

92 
£ËùÜ
->
£ËùabËFds
 = 
	`¬¿yC»©e
();

95 ià(
	`pe
(
£ËùÜ
->
wakeupPe
) < 0) {

96 
	`LOG_ALWAYS_FATAL
("pe(è”rÜ: %s", 
	`¡»¼Ü
(
”ºo
));

99 
	`ALOGD
("Wakeu°fd: %d", 
£ËùÜ
->
wakeupPe
[0]);

101 
S–eùabËFd
* 
wakeupFd
 = 
	`£ËùÜAdd
(
£ËùÜ
, s–eùÜ->
wakeupPe
[0]);

102 ià(
wakeupFd
 =ğ
NULL
) {

103 
	`LOG_ALWAYS_FATAL
("malloc()ƒrror.");

105 
wakeupFd
->
ÚR—dabË
 = &
—tWakeupD©a
;

107 
	`±h»ad_mu‹x_š™
(&
£ËùÜ
->
šS–eùLock
, 
NULL
);

109  
£ËùÜ
;

110 
	}
}

112 
S–eùabËFd
* 
	$£ËùÜAdd
(
S–eùÜ
* 
£ËùÜ
, 
fd
) {

113 
	`as£¹
(
£ËùÜ
 !ğ
NULL
);

115 
S–eùabËFd
* 
£ËùabËFd
 = 
	`ÿÎoc
(1, (SelectableFd));

116 ià(
£ËùabËFd
 !ğ
NULL
) {

117 
£ËùabËFd
->
£ËùÜ
 = selector;

118 
£ËùabËFd
->
fd
 = fd;

120 
	`¬¿yAdd
(
£ËùÜ
->
£ËùabËFds
, 
£ËùabËFd
);

123  
£ËùabËFd
;

124 
	}
}

130 
šlše
 
boŞ
 
maybeAdd
(
S–eùabËFd
* 
£ËùabËFd
,

131 (*
ÿÎback
)(
S–eùabËFd
*), 
fd_£t
* 
fdS‘
) {

132 ià(
ÿÎback
 !ğ
NULL
) {

133 
	`FD_SET
(
£ËùabËFd
->
fd
, 
fdS‘
);

134  
Œue
;

136  
çl£
;

137 
	}
}

142 
	$´•¬eFÜS–eù
(
S–eùÜ
* 
£ËùÜ
) {

143 
fd_£t
* 
exû±Fds
 = &
£ËùÜ
->exceptFds;

144 
fd_£t
* 
»adFds
 = &
£ËùÜ
->readFds;

145 
fd_£t
* 
wr™eFds
 = &
£ËùÜ
->writeFds;

147 
	`FD_ZERO
(
exû±Fds
);

148 
	`FD_ZERO
(
»adFds
);

149 
	`FD_ZERO
(
wr™eFds
);

151 
A¼ay
* 
£ËùabËFds
 = 
£ËùÜ
->selectableFds;

152 
i
 = 0;

153 
£ËùÜ
->
maxFd
 = 0;

154 
size
 = 
	`¬¿ySize
(
£ËùabËFds
);

155 
i
 < 
size
) {

156 
S–eùabËFd
* 
£ËùabËFd
 = 
	`¬¿yG‘
(
£ËùabËFds
, 
i
);

157 ià(
£ËùabËFd
->
»move
) {

159 
	`¬¿yRemove
(
£ËùabËFds
, 
i
);

160 
size
--;

161 ià(
£ËùabËFd
->
ÚRemove
 !ğ
NULL
) {

162 
£ËùabËFd
->
	`ÚRemove
(selectableFd);

164 
	`ä“
(
£ËùabËFd
);

166 ià(
£ËùabËFd
->
befÜeS–eù
 !ğ
NULL
) {

167 
£ËùabËFd
->
	`befÜeS–eù
(selectableFd);

170 
boŞ
 
šS‘
 = 
çl£
;

171 ià(
	`maybeAdd
(
£ËùabËFd
, s–eùabËFd->
ÚExû±
, 
exû±Fds
)) {

172 
	`ALOGD
("S–eùšg fd %d fÜ wr™šg...", 
£ËùabËFd
->
fd
);

173 
šS‘
 = 
Œue
;

175 ià(
	`maybeAdd
(
£ËùabËFd
, s–eùabËFd->
ÚR—dabË
, 
»adFds
)) {

176 
	`ALOGD
("S–eùšg fd %d fÜ„—dšg...", 
£ËùabËFd
->
fd
);

177 
šS‘
 = 
Œue
;

179 ià(
	`maybeAdd
(
£ËùabËFd
, s–eùabËFd->
ÚWr™abË
, 
wr™eFds
)) {

180 
šS‘
 = 
Œue
;

183 ià(
šS‘
) {

185 
fd
 = 
£ËùabËFd
->fd;

186 ià(
fd
 > 
£ËùÜ
->
maxFd
) {

187 
£ËùÜ
->
maxFd
 = 
fd
;

192 
i
++;

195 
	}
}

201 
šlše
 
maybeInvoke
(
S–eùabËFd
* 
£ËùabËFd
,

202 (*
ÿÎback
)(
S–eùabËFd
*), 
fd_£t
* 
fdS‘
) {

203 ià(
ÿÎback
 !ğ
NULL
 && !
£ËùabËFd
->
»move
 &&

204 
	`FD_ISSET
(
£ËùabËFd
->
fd
, 
fdS‘
)) {

205 
	`ALOGD
("S–eùed fd %d.", 
£ËùabËFd
->
fd
);

206 
	`ÿÎback
(
£ËùabËFd
);

208 
	}
}

214 
	$fœeEv’ts
(
S–eùÜ
* 
£ËùÜ
) {

215 
A¼ay
* 
£ËùabËFds
 = 
£ËùÜ
->selectableFds;

216 
size
 = 
	`¬¿ySize
(
£ËùabËFds
);

217 
i
;

218 
i
 = 0; i < 
size
; i++) {

219 
S–eùabËFd
* 
£ËùabËFd
 = 
	`¬¿yG‘
(
£ËùabËFds
, 
i
);

220 
	`maybeInvoke
(
£ËùabËFd
, s–eùabËFd->
ÚExû±
,

221 &
£ËùÜ
->
exû±Fds
);

222 
	`maybeInvoke
(
£ËùabËFd
, s–eùabËFd->
ÚR—dabË
,

223 &
£ËùÜ
->
»adFds
);

224 
	`maybeInvoke
(
£ËùabËFd
, s–eùabËFd->
ÚWr™abË
,

225 &
£ËùÜ
->
wr™eFds
);

227 
	}
}

229 
	$£ËùÜLoİ
(
S–eùÜ
* 
£ËùÜ
) {

231 ià(
£ËùÜ
->
loİšg
) {

232 
	`LOG_ALWAYS_FATAL
("Already†ooping.");

234 
£ËùÜ
->
loİšg
 = 
Œue
;

236 
Œue
) {

237 
	`£tInS–eù
(
£ËùÜ
, 
Œue
);

239 
	`´•¬eFÜS–eù
(
£ËùÜ
);

241 
	`ALOGD
("Entering select().");

244 
»suÉ
 = 
	`£Ëù
(
£ËùÜ
->
maxFd
 + 1, &£ËùÜ->
»adFds
,

245 &
£ËùÜ
->
wr™eFds
, &£ËùÜ->
exû±Fds
, 
NULL
);

247 
	`ALOGD
("Exiting select().");

249 
	`£tInS–eù
(
£ËùÜ
, 
çl£
);

251 ià(
»suÉ
 == -1) {

253 ià(
”ºo
 =ğ
EINTR
) {

254 
	`ALOGI
("select() interrupted.");

256 
	`LOG_ALWAYS_FATAL
("select()ƒrror: %s",

257 
	`¡»¼Ü
(
”ºo
));

259 } ià(
»suÉ
 > 0) {

260 
	`fœeEv’ts
(
£ËùÜ
);

263 
	}
}

	@libs/libcutils/socket_inaddr_any_server.c

18 
	~<cuts/sock‘s.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

26 #iâdeà
HAVE_WINSOCK


27 
	~<sys/sock‘.h
>

28 
	~<sys/£Ëù.h
>

29 
	~<sys/ty³s.h
>

30 
	~<Ãtš‘/š.h
>

33 
	#LISTEN_BACKLOG
 4

	)

36 
	$sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
)

38 
sockaddr_š
 
addr
;

39 
size_t
 
®’
;

40 
s
, 
n
;

42 
	`mem£t
(&
addr
, 0, (addr));

43 
addr
.
sš_çmy
 = 
AF_INET
;

44 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

45 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

47 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

48 if(
s
 < 0)  -1;

50 
n
 = 1;

51 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
n
, (n));

53 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

54 
	`şo£
(
s
);

58 ià(
ty³
 =ğ
SOCK_STREAM
) {

59 
»t
;

61 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

63 ià(
»t
 < 0) {

64 
	`şo£
(
s
);

69  
s
;

70 
	}
}

	@libs/libcutils/socket_local.h

17 #iâdeà
__SOCKET_LOCAL_H


18 
	#__SOCKET_LOCAL_H


	)

20 
	#FILESYSTEM_SOCKET_PREFIX
 "/tmp/"

	)

21 
	#ANDROID_RESERVED_SOCKET_PREFIX
 "/dev/sock‘/"

	)

36 
sock‘_make_sockaddr_un
(cÚ¡ *
Çme
, 
Çme¥aûId
,

37 
sockaddr_un
 *
p_addr
, 
sockËn_t
 *
®’
);

	@libs/libcutils/socket_local_client.c

17 
	~<cuts/sock‘s.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

21 
	~<uni¡d.h
>

22 
	~<”ºo.h
>

23 
	~<¡ddef.h
>

25 #ifdeà
HAVE_WINSOCK


27 
	$sock‘_loÿl_ş›Á
(cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
)

29 
”ºo
 = 
ENOSYS
;

31 
	}
}

35 
	~<sys/sock‘.h
>

36 
	~<sys/un.h
>

37 
	~<sys/£Ëù.h
>

38 
	~<sys/ty³s.h
>

40 
	~"sock‘_loÿl.h
"

42 
	#LISTEN_BACKLOG
 4

	)

45 
	$sock‘_make_sockaddr_un
(cÚ¡ *
Çme
, 
Çme¥aûId
,

46 
sockaddr_un
 *
p_addr
, 
sockËn_t
 *
®’
)

48 
	`mem£t
 (
p_addr
, 0,  (*p_addr));

49 
size_t
 
Çm–’
;

51 
Çme¥aûId
) {

52 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
:

53 #ifdeà
HAVE_LINUX_LOCAL_SOCKET_NAMESPACE


54 
Çm–’
 = 
	`¡¾’
(
Çme
);

57 ià((
Çm–’
 + 1è> (
p_addr
->
sun_·th
)) {

58 
”rÜ
;

66 
p_addr
->
sun_·th
[0] = 0;

67 
	`memıy
(
p_addr
->
sun_·th
 + 1, 
Çme
, 
Çm–’
);

71 
Çm–’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
FILESYSTEM_SOCKET_PREFIX
);

73 ià(
Çm–’
 > (*
p_addr
)

74 - 
	`off£tof
(
sockaddr_un
, 
sun_·th
) - 1) {

75 
”rÜ
;

78 
	`¡rıy
(
p_addr
->
sun_·th
, 
FILESYSTEM_SOCKET_PREFIX
);

79 
	`¡rÿt
(
p_addr
->
sun_·th
, 
Çme
);

83 
ANDROID_SOCKET_NAMESPACE_RESERVED
:

84 
Çm–’
 = 
	`¡¾’
(
Çme
è+ sŒËn(
ANDROID_RESERVED_SOCKET_PREFIX
);

86 ià(
Çm–’
 > (*
p_addr
)

87 - 
	`off£tof
(
sockaddr_un
, 
sun_·th
) - 1) {

88 
”rÜ
;

91 
	`¡rıy
(
p_addr
->
sun_·th
, 
ANDROID_RESERVED_SOCKET_PREFIX
);

92 
	`¡rÿt
(
p_addr
->
sun_·th
, 
Çme
);

95 
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
:

96 
Çm–’
 = 
	`¡¾’
(
Çme
);

98 ià(
Çm–’
 > (*
p_addr
)

99 - 
	`off£tof
(
sockaddr_un
, 
sun_·th
) - 1) {

100 
”rÜ
;

103 
	`¡rıy
(
p_addr
->
sun_·th
, 
Çme
);

110 
p_addr
->
sun_çmy
 = 
AF_LOCAL
;

111 *
®’
 = 
Çm–’
 + 
	`off£tof
(
sockaddr_un
, 
sun_·th
) + 1;

113 
”rÜ
:

115 
	}
}

124 
	$sock‘_loÿl_ş›Á_cÚÃù
(
fd
, cÚ¡ *
Çme
, 
Çme¥aûId
,

125 
ty³
)

127 
sockaddr_un
 
addr
;

128 
sockËn_t
 
®’
;

129 
size_t
 
Çm–’
;

130 
”r
;

132 
”r
 = 
	`sock‘_make_sockaddr_un
(
Çme
, 
Çme¥aûId
, &
addr
, &
®’
);

134 ià(
”r
 < 0) {

135 
”rÜ
;

138 if(
	`cÚÃù
(
fd
, (
sockaddr
 *è&
addr
, 
®’
) < 0) {

139 
”rÜ
;

142  
fd
;

144 
”rÜ
:

146 
	}
}

152 
	$sock‘_loÿl_ş›Á
(cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
)

154 
s
;

156 
s
 = 
	`sock‘
(
AF_LOCAL
, 
ty³
, 0);

157 if(
s
 < 0)  -1;

159 iàĞ0 > 
	`sock‘_loÿl_ş›Á_cÚÃù
(
s
, 
Çme
, 
Çme¥aûId
, 
ty³
)) {

160 
	`şo£
(
s
);

164  
s
;

165 
	}
}

	@libs/libcutils/socket_local_server.c

18 
	~<cuts/sock‘s.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

26 #ifdeà
HAVE_WINSOCK


28 
	$sock‘_loÿl_£rv”
(cÚ¡ *
Çme
, 
Çme¥aûId
, 
ty³
)

30 
”ºo
 = 
ENOSYS
;

32 
	}
}

36 
	~<sys/sock‘.h
>

37 
	~<sys/un.h
>

38 
	~<sys/£Ëù.h
>

39 
	~<sys/ty³s.h
>

40 
	~<Ãtš‘/š.h
>

42 
	~"sock‘_loÿl.h
"

44 
	#LISTEN_BACKLOG
 4

	)

53 
	$sock‘_loÿl_£rv”_bšd
(
s
, cÚ¡ *
Çme
, 
Çme¥aûId
)

55 
sockaddr_un
 
addr
;

56 
sockËn_t
 
®’
;

57 
n
;

58 
”r
;

60 
”r
 = 
	`sock‘_make_sockaddr_un
(
Çme
, 
Çme¥aûId
, &
addr
, &
®’
);

62 ià(
”r
 < 0) {

67 #iâdeà
HAVE_LINUX_LOCAL_SOCKET_NAMESPACE


70 ià(
Çme¥aûId
 =ğ
ANDROID_SOCKET_NAMESPACE_RESERVED


71 || 
Çme¥aûId
 =ğ
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
) {

74 
	`uÆšk
(
addr
.
sun_·th
);

77 
n
 = 1;

78 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
n
, (n));

80 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, 
®’
) < 0) {

84  
s
;

86 
	}
}

95 
	$sock‘_loÿl_£rv”
(cÚ¡ *
Çme
, 
Çme¥aû
, 
ty³
)

97 
”r
;

98 
s
;

100 
s
 = 
	`sock‘
(
AF_LOCAL
, 
ty³
, 0);

101 ià(
s
 < 0)  -1;

103 
”r
 = 
	`sock‘_loÿl_£rv”_bšd
(
s
, 
Çme
, 
Çme¥aû
);

105 ià(
”r
 < 0) {

106 
	`şo£
(
s
);

110 ià(
ty³
 =ğ
SOCK_STREAM
) {

111 
»t
;

113 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

115 ià(
»t
 < 0) {

116 
	`şo£
(
s
);

121  
s
;

122 
	}
}

	@libs/libcutils/socket_loopback_client.c

18 
	~<cuts/sock‘s.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

26 #iâdeà
HAVE_WINSOCK


27 
	~<sys/sock‘.h
>

28 
	~<sys/£Ëù.h
>

29 
	~<sys/ty³s.h
>

30 
	~<Ãtš‘/š.h
>

37 
	$sock‘_loİback_ş›Á
(
pÜt
, 
ty³
)

39 
sockaddr_š
 
addr
;

40 
sockËn_t
 
®’
;

41 
s
;

43 
	`mem£t
(&
addr
, 0, (addr));

44 
addr
.
sš_çmy
 = 
AF_INET
;

45 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

46 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

48 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

49 if(
s
 < 0)  -1;

51 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

52 
	`şo£
(
s
);

56  
s
;

58 
	}
}

	@libs/libcutils/socket_loopback_server.c

18 
	~<cuts/sock‘s.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

26 
	#LISTEN_BACKLOG
 4

	)

28 #iâdeà
HAVE_WINSOCK


29 
	~<sys/sock‘.h
>

30 
	~<sys/£Ëù.h
>

31 
	~<sys/ty³s.h
>

32 
	~<Ãtš‘/š.h
>

36 
	$sock‘_loİback_£rv”
(
pÜt
, 
ty³
)

38 
sockaddr_š
 
addr
;

39 
size_t
 
®’
;

40 
s
, 
n
;

42 
	`mem£t
(&
addr
, 0, (addr));

43 
addr
.
sš_çmy
 = 
AF_INET
;

44 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

45 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

47 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

48 if(
s
 < 0)  -1;

50 
n
 = 1;

51 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
n
, (n));

53 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

54 
	`şo£
(
s
);

58 ià(
ty³
 =ğ
SOCK_STREAM
) {

59 
»t
;

61 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

63 ià(
»t
 < 0) {

64 
	`şo£
(
s
);

69  
s
;

70 
	}
}

	@libs/libcutils/socket_network_client.c

18 
	~<cuts/sock‘s.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

23 
	~<”ºo.h
>

24 
	~<¡ddef.h
>

26 #iâdeà
HAVE_WINSOCK


27 
	~<sys/sock‘.h
>

28 
	~<sys/£Ëù.h
>

29 
	~<sys/ty³s.h
>

30 
	~<Ãtš‘/š.h
>

31 
	~<Ãtdb.h
>

39 
	$sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
)

41 
ho¡’t
 *
hp
;

42 
sockaddr_š
 
addr
;

43 
sockËn_t
 
®’
;

44 
s
;

46 
hp
 = 
	`g‘ho¡byÇme
(
ho¡
);

47 if(
hp
 == 0)  -1;

49 
	`mem£t
(&
addr
, 0, (addr));

50 
addr
.
sš_çmy
 = 
hp
->
h_add¹y³
;

51 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

52 
	`memıy
(&
addr
.
sš_addr
, 
hp
->
h_addr
, hp->
h_Ëngth
);

54 
s
 = 
	`sock‘
(
hp
->
h_add¹y³
, 
ty³
, 0);

55 if(
s
 < 0)  -1;

57 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

58 
	`şo£
(
s
);

62  
s
;

64 
	}
}

	@libs/libcutils/sockets.c

17 
	~<cuts/log.h
>

18 
	~<cuts/sock‘s.h
>

20 #ifdeà
HAVE_ANDROID_OS


22 
	~<´iv©e/ªdroid_fesy¡em_cÚfig.h
>

25 
boŞ
 
	$sock‘_³”_is_Œu¡ed
(
fd
)

27 #ifdeà
HAVE_ANDROID_OS


28 
uüed
 
ü
;

29 
sockËn_t
 
Ën
 = (
ü
);

30 
n
 = 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_PEERCRED
, &
ü
, &
Ën
);

32 ià(
n
 != 0) {

33 
	`ALOGE
("could‚Ù g‘ sock‘ c»d’tŸls: %s\n", 
	`¡»¼Ü
(
”ºo
));

34  
çl£
;

37 ià((
ü
.
uid
 !ğ
AID_ROOT
è&& (ü.uid !ğ
AID_SHELL
)) {

38 
	`ALOGE
("uÁru¡ed u£rid oÀÙh”ƒnd oàsock‘: u£rid %d\n", 
ü
.
uid
);

39  
çl£
;

43  
Œue
;

44 
	}
}

	@libs/libcutils/str_parms.c

17 
	#LOG_TAG
 "¡r_·¿ms"

	)

20 
	#_GNU_SOURCE
 1

	)

21 
	~<”ºo.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

27 
	~<cuts/hashm­.h
>

28 
	~<cuts/log.h
>

29 
	~<cuts/memÜy.h
>

31 
	~<cuts/¡r_·rms.h
>

33 
	s¡r_·rms
 {

34 
Hashm­
 *
	mm­
;

38 
boŞ
 
	$¡r_eq
(*
key_a
, *
key_b
)

40  !
	`¡rcmp
((cÚ¡ *)
key_a
, (cÚ¡ *)
key_b
);

41 
	}
}

44 
	$¡r_hash_â
(*
¡r
)

46 
ušt32_t
 
hash
 = 5381;

47 *
p
;

49 
p
 = 
¡r
;… && *p;…++)

50 
hash
 = ((hash << 5è+ hashè+ *
p
;

51  ()
hash
;

52 
	}
}

54 
¡r_·rms
 *
	$¡r_·rms_ü—‹
()

56 
¡r_·rms
 *str_parms;

58 
¡r_·rms
 = 
	`ÿÎoc
(1, (str_parms));

59 ià(!
¡r_·rms
)

60  
NULL
;

62 
¡r_·rms
->
m­
 = 
	`hashm­C»©e
(5, 
¡r_hash_â
, 
¡r_eq
);

63 ià(!
¡r_·rms
->
m­
)

64 
”r
;

66  
¡r_·rms
;

68 
”r
:

69 
	`ä“
(
¡r_·rms
);

70  
NULL
;

71 
	}
}

73 
	s»move_ùxt
 {

74 
¡r_·rms
 *
	m¡r_·rms
;

75 cÚ¡ *
	mkey
;

78 
boŞ
 
	$»move_·œ
(*
key
, *
v®ue
, *
cÚ‹xt
)

80 
»move_ùxt
 *
ùxt
 = 
cÚ‹xt
;

81 
boŞ
 
should_cÚtšue
;

91 ià(!
ùxt
->
key
) {

92 
should_cÚtšue
 = 
Œue
;

93 
do_»move
;

94 } ià(!
	`¡rcmp
(
ùxt
->
key
, key)) {

95 
should_cÚtšue
 = 
çl£
;

96 
do_»move
;

99  
Œue
;

101 
do_»move
:

102 
	`hashm­Remove
(
ùxt
->
¡r_·rms
->
m­
, 
key
);

103 
	`ä“
(
key
);

104 
	`ä“
(
v®ue
);

105  
should_cÚtšue
;

106 
	}
}

108 
	$¡r_·rms_d–
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
)

110 
»move_ùxt
 
ùxt
 = {

111 .
¡r_·rms
 = str_parms,

112 .
key
 = key,

114 
	`hashm­FÜEach
(
¡r_·rms
->
m­
, 
»move_·œ
, &
ùxt
);

115 
	}
}

117 
	$¡r_·rms_de¡roy
(
¡r_·rms
 *str_parms)

119 
»move_ùxt
 
ùxt
 = {

120 .
¡r_·rms
 = str_parms,

123 
	`hashm­FÜEach
(
¡r_·rms
->
m­
, 
»move_·œ
, &
ùxt
);

124 
	`hashm­F»e
(
¡r_·rms
->
m­
);

125 
	`ä“
(
¡r_·rms
);

126 
	}
}

128 
¡r_·rms
 *
	$¡r_·rms_ü—‹_¡r
(cÚ¡ *
_¡ršg
)

130 
¡r_·rms
 *str_parms;

131 *
¡r
;

132 *
kv·œ
;

133 *
tmp¡r
;

134 
™ems
 = 0;

136 
¡r_·rms
 = 
	`¡r_·rms_ü—‹
();

137 ià(!
¡r_·rms
)

138 
”r_ü—‹_¡r_·rms
;

140 
¡r
 = 
	`¡rdup
(
_¡ršg
);

141 ià(!
¡r
)

142 
”r_¡rdup
;

144 
	`ALOGV
("%s: sourû sŒšg =ğ'%s'\n", 
__func__
, 
_¡ršg
);

146 
kv·œ
 = 
	`¡¹ok_r
(
¡r
, ";", &
tmp¡r
);

147 
kv·œ
 && *kvpair) {

148 *
eq
 = 
	`¡rchr
(
kv·œ
, '=');

149 *
v®ue
;

150 *
key
;

151 *
Şd_v®
;

153 ià(
eq
 =ğ
kv·œ
)

154 
Ãxt_·œ
;

156 ià(
eq
) {

157 
key
 = 
	`¡ºdup
(
kv·œ
, 
eq
 - kvpair);

158 ià(*(++
eq
))

159 
v®ue
 = 
	`¡rdup
(
eq
);

161 
v®ue
 = 
	`¡rdup
("");

163 
key
 = 
	`¡rdup
(
kv·œ
);

164 
v®ue
 = 
	`¡rdup
("");

168 
Şd_v®
 = 
	`hashm­Put
(
¡r_·rms
->
m­
, 
key
, 
v®ue
);

169 ià(
Şd_v®
) {

170 
	`ä“
(
Şd_v®
);

171 
	`ä“
(
key
);

174 
™ems
++;

175 
Ãxt_·œ
:

176 
kv·œ
 = 
	`¡¹ok_r
(
NULL
, ";", &
tmp¡r
);

179 ià(!
™ems
)

180 
	`ALOGV
("%s:‚Ø™em found iÀ¡ršg\n", 
__func__
);

182 
	`ä“
(
¡r
);

184  
¡r_·rms
;

186 
”r_¡rdup
:

187 
	`¡r_·rms_de¡roy
(
¡r_·rms
);

188 
”r_ü—‹_¡r_·rms
:

189  
NULL
;

190 
	}
}

192 
	$¡r_·rms_add_¡r
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

193 cÚ¡ *
v®ue
)

195 *
Şd_v®
;

196 *
tmp_key
;

197 *
tmp_v®
;

199 
tmp_key
 = 
	`¡rdup
(
key
);

200 
tmp_v®
 = 
	`¡rdup
(
v®ue
);

201 
Şd_v®
 = 
	`hashm­Put
(
¡r_·rms
->
m­
, 
tmp_key
, 
tmp_v®
);

203 ià(
Şd_v®
) {

204 
	`ä“
(
Şd_v®
);

205 
	`ä“
(
tmp_key
);

206 } ià(
”ºo
 =ğ
ENOMEM
) {

207 
	`ä“
(
tmp_key
);

208 
	`ä“
(
tmp_v®
);

209  -
ENOMEM
;

212 
	}
}

214 
	$¡r_·rms_add_št
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
, 
v®ue
)

216 
v®_¡r
[12];

217 
»t
;

219 
»t
 = 
	`¢´štf
(
v®_¡r
, (v®_¡r), "%d", 
v®ue
);

220 ià(
»t
 < 0)

221  -
EINVAL
;

223 
»t
 = 
	`¡r_·rms_add_¡r
(
¡r_·rms
, 
key
, 
v®_¡r
);

224  
»t
;

225 
	}
}

227 
	$¡r_·rms_add_æßt
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

228 
v®ue
)

230 
v®_¡r
[23];

231 
»t
;

233 
»t
 = 
	`¢´štf
(
v®_¡r
, (v®_¡r), "%.10f", 
v®ue
);

234 ià(
»t
 < 0)

235  -
EINVAL
;

237 
»t
 = 
	`¡r_·rms_add_¡r
(
¡r_·rms
, 
key
, 
v®_¡r
);

238  
»t
;

239 
	}
}

241 
	$¡r_·rms_g‘_¡r
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
, *
v®
,

242 
Ën
)

244 *
v®ue
;

246 
v®ue
 = 
	`hashm­G‘
(
¡r_·rms
->
m­
, (*)
key
);

247 ià(
v®ue
)

248  
	`¡¾ıy
(
v®
, 
v®ue
, 
Ën
);

250  -
ENOENT
;

251 
	}
}

253 
	$¡r_·rms_g‘_št
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
, *
v®
)

255 *
v®ue
;

256 *
’d
;

258 
v®ue
 = 
	`hashm­G‘
(
¡r_·rms
->
m­
, (*)
key
);

259 ià(!
v®ue
)

260  -
ENOENT
;

262 *
v®
 = ()
	`¡¹Ş
(
v®ue
, &
’d
, 0);

263 ià(*
v®ue
 !ğ'\0' && *
’d
 == '\0')

266  -
EINVAL
;

267 
	}
}

269 
	$¡r_·rms_g‘_æßt
(
¡r_·rms
 *¡r_·rms, cÚ¡ *
key
,

270 *
v®
)

272 
out
;

273 *
v®ue
;

274 *
’d
;

276 
v®ue
 = 
	`hashm­G‘
(
¡r_·rms
->
m­
, (*)
key
);

277 ià(!
v®ue
)

278  -
ENOENT
;

280 
out
 = 
	`¡¹of
(
v®ue
, &
’d
);

281 ià(*
v®ue
 !ğ'\0' && *
’d
 == '\0')

284  -
EINVAL
;

285 
	}
}

287 
boŞ
 
	$combše_¡ršgs
(*
key
, *
v®ue
, *
cÚ‹xt
)

289 **
Şd_¡r
 = 
cÚ‹xt
;

290 *
Ãw_¡r
;

291 
»t
;

293 
»t
 = 
	`a¥rštf
(&
Ãw_¡r
, "%s%s%s=%s",

294 *
Şd_¡r
 ? *old_str : "",

295 *
Şd_¡r
 ? ";" : "",

296 (*)
key
,

297 (*)
v®ue
);

298 ià(*
Şd_¡r
)

299 
	`ä“
(*
Şd_¡r
);

301 ià(
»t
 >= 0) {

302 *
Şd_¡r
 = 
Ãw_¡r
;

303  
Œue
;

306 *
Şd_¡r
 = 
NULL
;

307  
çl£
;

308 
	}
}

310 *
	$¡r_·rms_to_¡r
(
¡r_·rms
 *str_parms)

312 *
¡r
 = 
NULL
;

314 ià(
	`hashm­Size
(
¡r_·rms
->
m­
) > 0)

315 
	`hashm­FÜEach
(
¡r_·rms
->
m­
, 
combše_¡ršgs
, &
¡r
);

317 
¡r
 = 
	`¡rdup
("");

318  
¡r
;

319 
	}
}

321 
boŞ
 
	$dump_’Œy
(*
key
, *
v®ue
, *
cÚ‹xt
)

323 
	`ALOGI
("key: '%s' v®ue: '%s'\n", (*)
key
, (*)
v®ue
);

324  
Œue
;

325 
	}
}

327 
	$¡r_·rms_dump
(
¡r_·rms
 *str_parms)

329 
	`hashm­FÜEach
(
¡r_·rms
->
m­
, 
dump_’Œy
, str_parms);

330 
	}
}

332 #ifdeà
TEST_STR_PARMS


333 
	$‹¡_¡r_·rms_¡r
(cÚ¡ *
¡r
)

335 
¡r_·rms
 *str_parms;

336 *
out_¡r
;

337 
»t
;

339 
¡r_·rms
 = 
	`¡r_·rms_ü—‹_¡r
(
¡r
);

340 
	`¡r_·rms_add_¡r
(
¡r_·rms
, "dude", "woah");

341 
	`¡r_·rms_add_¡r
(
¡r_·rms
, "dude", "woah");

342 
	`¡r_·rms_d–
(
¡r_·rms
, "dude");

343 
	`¡r_·rms_dump
(
¡r_·rms
);

344 
out_¡r
 = 
	`¡r_·rms_to_¡r
(
¡r_·rms
);

345 
	`¡r_·rms_de¡roy
(
¡r_·rms
);

346 
	`ALOGI
("%s: '%s' sŒšgif›d i '%s'", 
__func__
, 
¡r
, 
out_¡r
);

347 
	`ä“
(
out_¡r
);

348 
	}
}

350 
	$maš
()

352 
¡r_·rms
 *str_parms;

354 
	`‹¡_¡r_·rms_¡r
("");

355 
	`‹¡_¡r_·rms_¡r
(";");

356 
	`‹¡_¡r_·rms_¡r
("=");

357 
	`‹¡_¡r_·rms_¡r
("=;");

358 
	`‹¡_¡r_·rms_¡r
("=bar");

359 
	`‹¡_¡r_·rms_¡r
("=bar;");

360 
	`‹¡_¡r_·rms_¡r
("foo=");

361 
	`‹¡_¡r_·rms_¡r
("foo=;");

362 
	`‹¡_¡r_·rms_¡r
("foo=bar");

363 
	`‹¡_¡r_·rms_¡r
("foo=bar;");

364 
	`‹¡_¡r_·rms_¡r
("foo=bar;baz");

365 
	`‹¡_¡r_·rms_¡r
("foo=bar;baz=");

366 
	`‹¡_¡r_·rms_¡r
("foo=bar;baz=bat");

367 
	`‹¡_¡r_·rms_¡r
("foo=bar;baz=bat;");

368 
	`‹¡_¡r_·rms_¡r
("foo=bar;baz=bat;foo=bar");

371 
	}
}

	@libs/libcutils/strdup16to8.c

18 
	~<lim™s.h
>

20 
	~<cuts/j¡ršg.h
>

21 
	~<as£¹.h
>

22 
	~<¡dlib.h
>

29 
size_t
 
	$¡ºËn16to8
(cÚ¡ 
ch¬16_t
* 
utf16SŒ
, 
size_t
 
Ën
)

31 
size_t
 
utf8L’
 = 0;

57 ià(
Ën
 < (
SIZE_MAX
-1)/3) {

58 
Ën
--) {

59 
uic
 = *
utf16SŒ
++;

61 ià(
uic
 > 0x07ff)

62 
utf8L’
 += 3;

63 ià(
uic
 > 0x7f || uic == 0)

64 
utf8L’
 += 2;

66 
utf8L’
++;

68  
utf8L’
;

72 
Ën
--) {

73 
uic
 = *
utf16SŒ
++;

74 
size_t
 
utf8Cur
 = 
utf8L’
;

76 ià(
uic
 > 0x07ff)

77 
utf8L’
 += 3;

78 ià(
uic
 > 0x7f || uic == 0)

79 
utf8L’
 += 2;

81 
utf8L’
++;

83 ià(
utf8L’
 < 
utf8Cur
)

84  
SIZE_MAX
-1;

88 ià(
utf8L’
 =ğ
SIZE_MAX
)

89 
utf8L’
 = 
SIZE_MAX
-1;

91  
utf8L’
;

92 
	}
}

107 * 
	$¡ºıy16to8
(* 
utf8SŒ
, cÚ¡ 
ch¬16_t
* 
utf16SŒ
, 
size_t
 
Ën
)

109 * 
utf8cur
 = 
utf8SŒ
;

115 
Ën
--) {

116 
uic
 = *
utf16SŒ
++;

118 ià(
uic
 > 0x07ff) {

119 *
utf8cur
++ = (
uic
 >> 12) | 0xe0;

120 *
utf8cur
++ = ((
uic
 >> 6) & 0x3f) | 0x80;

121 *
utf8cur
++ = (
uic
 & 0x3f) | 0x80;

122 } ià(
uic
 > 0x7f || uic == 0) {

123 *
utf8cur
++ = (
uic
 >> 6) | 0xc0;

124 *
utf8cur
++ = (
uic
 & 0x3f) | 0x80;

126 *
utf8cur
++ = 
uic
;

128 ià(
uic
 == 0) {

134 *
utf8cur
 = '\0';

136  
utf8SŒ
;

137 
	}
}

143 * 
	$¡ºdup16to8
 (cÚ¡ 
ch¬16_t
* 
s
, 
size_t
 
n
)

145 * 
»t
;

146 
size_t
 
Ën
;

148 ià(
s
 =ğ
NULL
) {

149  
NULL
;

152 
Ën
 = 
	`¡ºËn16to8
(
s
, 
n
);

158 ià(
Ën
 >ğ
SIZE_MAX
-1)

159  
NULL
;

161 
»t
 = 
	`m®loc
(
Ën
 + 1);

162 ià(
»t
 =ğ
NULL
)

163  
NULL
;

165 
	`¡ºıy16to8
 (
»t
, 
s
, 
n
);

167  
»t
;

168 
	}
}

	@libs/libcutils/strdup8to16.c

18 
	~<cuts/j¡ršg.h
>

19 
	~<as£¹.h
>

20 
	~<¡dlib.h
>

21 
	~<lim™s.h
>

27 
	#UTF16_REPLACEMENT_CHAR
 0xfffd

	)

30 
	#UTF8_SEQ_LENGTH
(
ch
è(((0xe5000000 >> ((ch >> 3è& 0x1e)è& 3è+ 1)

	)

33 
	#UTF8_SHIFT_AND_MASK
(
unicode
, 
by‹
) \

34 (
unicode
)<<=6; (unicodeè|ğ(0x3à& (
by‹
));

	)

36 
	#UNICODE_UPPER_LIMIT
 0x10fffd

	)

43 
ch¬16_t
 * 
	$¡rdup8to16
 (cÚ¡ * 
s
, 
size_t
 *
out_Ën
)

45 
ch¬16_t
 *
»t
;

46 
size_t
 
Ën
;

48 ià(
s
 =ğ
NULL
)  NULL;

50 
Ën
 = 
	`¡¾’8to16
(
s
);

53 ià(
Ën
 && 
SIZE_MAX
/ËÀ< (
ch¬16_t
))

54  
NULL
;

57 
»t
 = (
ch¬16_t
 *è
	`m®loc
 ((ch¬16_tè* 
Ën
);

59  
	`¡rıy8to16
 (
»t
, 
s
, 
out_Ën
);

60 
	}
}

68 
size_t
 
	$¡¾’8to16
 (cÚ¡ * 
utf8SŒ
)

70 
size_t
 
Ën
 = 0;

71 
ic
;

72 
ex³ùed
 = 0;

74 (
ic
 = *
utf8SŒ
++) != '\0') {

78 ià((
ic
 & 0xc0) == 0x80) {

83 
ex³ùed
--;

84 ià(
ex³ùed
 < 0) {

85 
Ën
++;

88 
Ën
++;

89 
ex³ùed
 = 
	`UTF8_SEQ_LENGTH
(
ic
) - 1;

92 ià(
ex³ùed
 == 3) {

93 
Ën
++;

98  
Ën
;

99 
	}
}

112 
šlše
 
ušt32_t
 
	$g‘Utf32FromUtf8
(cÚ¡ ** 
pUtf8PŒ
)

114 
ušt32_t
 
»t
;

115 
£q_Ën
;

116 
i
;

119 cÚ¡ 
Ëad”Mask
[4] = {0xff, 0x1f, 0x0f, 0x07};

122 ià(((**
pUtf8PŒ
) & 0xc0) == 0x80) {

123 (*
pUtf8PŒ
)++;

124  
UTF16_REPLACEMENT_CHAR
;

128 
£q_Ën
 = 
	`UTF8_SEQ_LENGTH
(**
pUtf8PŒ
);

130 
»t
 = (**
pUtf8PŒ
è& 
Ëad”Mask
 [
£q_Ën
 - 1];

132 ià(**
pUtf8PŒ
 =ğ'\0'è 
»t
;

134 (*
pUtf8PŒ
)++;

135 
i
 = 1; i < 
£q_Ën
 ; i++, (*
pUtf8PŒ
)++) {

136 ià((**
pUtf8PŒ
è=ğ'\0'è 
UTF16_REPLACEMENT_CHAR
;

137 ià(((**
pUtf8PŒ
è& 0xc0è!ğ0x80è 
UTF16_REPLACEMENT_CHAR
;

139 
	`UTF8_SHIFT_AND_MASK
(
»t
, **
pUtf8PŒ
);

142  
»t
;

143 
	}
}

151 
ch¬16_t
 * 
	$¡rıy8to16
 (
ch¬16_t
 *
utf16SŒ
, cÚ¡ *
utf8SŒ
,

152 
size_t
 *
out_Ën
)

154 
ch¬16_t
 *
de¡
 = 
utf16SŒ
;

156 *
utf8SŒ
 != '\0') {

157 
ušt32_t
 
»t
;

159 
»t
 = 
	`g‘Utf32FromUtf8
(&
utf8SŒ
);

161 ià(
»t
 <= 0xffff) {

162 *
de¡
++ = (
ch¬16_t
è
»t
;

163 } ià(
»t
 <ğ
UNICODE_UPPER_LIMIT
) {

167 *
de¡
++ = 0xd800 | ((
»t
 - 0x10000) >> 10);

168 *
de¡
++ = 0xdc00 | ((
»t
 - 0x10000) & 0x3ff);

170 *
de¡
++ = 
UTF16_REPLACEMENT_CHAR
;

174 *
out_Ën
 = 
de¡
 - 
utf16SŒ
;

176  
utf16SŒ
;

177 
	}
}

185 
ch¬16_t
 * 
	$¡rıyËn8to16
 (
ch¬16_t
 *
utf16SŒ
, cÚ¡ *
utf8SŒ
,

186 
Ëngth
, 
size_t
 *
out_Ën
)

190 
ch¬16_t
 *
de¡
 = 
utf16SŒ
;

192 cÚ¡ *
’d
 = 
utf8SŒ
 + 
Ëngth
;

193 
utf8SŒ
 < 
’d
) {

194 
ušt32_t
 
»t
;

196 
»t
 = 
	`g‘Utf32FromUtf8
(&
utf8SŒ
);

198 ià(
»t
 <= 0xffff) {

199 *
de¡
++ = (
ch¬16_t
è
»t
;

200 } ià(
»t
 <ğ
UNICODE_UPPER_LIMIT
) {

204 *
de¡
++ = 0xd800 | ((
»t
 - 0x10000) >> 10);

205 *
de¡
++ = 0xdc00 | ((
»t
 - 0x10000) & 0x3ff);

207 *
de¡
++ = 
UTF16_REPLACEMENT_CHAR
;

211 *
out_Ën
 = 
de¡
 - 
utf16SŒ
;

213  
utf16SŒ
;

214 
	}
}

	@libs/libcutils/threads.c

17 
	~<cuts/th»ads.h
>

19 #ifdeà
HAVE_PTHREADS


20 * 
	$th»ad_¡Üe_g‘
Ğ
th»ad_¡Üe_t
* 
¡Üe
 )

22 cÚ¡ 
±h»ad_key_t
 
k
 = 
¡Üe
->
s
;

24 ià(!
¡Üe
->
has_s
)

25  
NULL
;

27  
	`±h»ad_g‘¥ecific
Ğ
¡Üe
->
s
 );

28 
	}
}

30 
	$th»ad_¡Üe_£t
Ğ
th»ad_¡Üe_t
* 
¡Üe
,

31 * 
v®ue
,

32 
th»ad_¡Üe_de¡ruù_t
 
de¡roy
)

34 
	`±h»ad_mu‹x_lock
Ğ&
¡Üe
->
lock
 );

35 ià(!
¡Üe
->
has_s
) {

36 ià(
	`±h»ad_key_ü—‹
Ğ&
¡Üe
->
s
, 
de¡roy
) != 0) {

37 
	`±h»ad_mu‹x_uÆock
(&
¡Üe
->
lock
);

40 
¡Üe
->
has_s
 = 1;

42 
	`±h»ad_mu‹x_uÆock
Ğ&
¡Üe
->
lock
 );

44 
	`±h»ad_£t¥ecific
Ğ
¡Üe
->
s
, 
v®ue
 );

45 
	}
}

49 #ifdeà
HAVE_WIN32_THREADS


50 * 
	$th»ad_¡Üe_g‘
Ğ
th»ad_¡Üe_t
* 
¡Üe
 )

52 ià(!
¡Üe
->
has_s
)

53  
NULL
;

55  (*è
	`TlsG‘V®ue
Ğ
¡Üe
->
s
 );

56 
	}
}

58 
	$th»ad_¡Üe_£t
Ğ
th»ad_¡Üe_t
* 
¡Üe
,

59 * 
v®ue
,

60 
th»ad_¡Üe_de¡ruù_t
 
de¡roy
 )

63 ià(!
¡Üe
->
lock_š™
) {

64 
¡Üe
->
lock_š™
 = -1;

65 
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ&
¡Üe
->
lock
 );

66 
¡Üe
->
lock_š™
 = -2;

67 } 
¡Üe
->
lock_š™
 != -2) {

68 
	`SË•
(10);

71 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
¡Üe
->
lock
 );

72 ià(!
¡Üe
->
has_s
) {

73 
¡Üe
->
s
 = 
	`TlsAÎoc
();

74 ià(
¡Üe
->
s
 =ğ
TLS_OUT_OF_INDEXES
) {

75 
	`L—veCr™iÿlSeùiÚ
Ğ&
¡Üe
->
lock
 );

78 
¡Üe
->
has_s
 = 1;

80 
	`L—veCr™iÿlSeùiÚ
Ğ&
¡Üe
->
lock
 );

82 
	`TlsS‘V®ue
Ğ
¡Üe
->
s
, 
v®ue
 );

83 
	}
}

	@libs/libcutils/tzfile.h

1 #iâdeà
TZFILE_H


3 
	#TZFILE_H


	)

22 #iâdeà
lšt


23 #iâdeà
NOID


24 
	gtzfehid
[] = "@(#)tzfile.h 8.1";

32 #iâdeà
TZDIR


33 
	#TZDIR
 "/u¤/sh¬e/zÚešfo"

	)

36 #iâdeà
TZDEFAULT


37 
	#TZDEFAULT
 "loÿÉime"

	)

40 #iâdeà
TZDEFRULES


41 
	#TZDEFRULES
 "posixruËs"

	)

48 
	#TZ_MAGIC
 "TZif"

	)

50 
	stzh—d
 {

51 
	mtzh_magic
[4];

52 
	mtzh_v”siÚ
[1];

53 
	mtzh_»£rved
[15];

54 
	mtzh_‰isgmtút
[4];

55 
	mtzh_‰is¡dút
[4];

56 
	mtzh_Ë­út
[4];

57 
	mtzh_timeút
[4];

58 
	mtzh_ty³út
[4];

59 
	mtzh_ch¬út
[4];

102 #iâdeà
TZ_MAX_TIMES


103 
	#TZ_MAX_TIMES
 1200

	)

106 #iâdeà
TZ_MAX_TYPES


107 #iâdeà
NOSOLAR


108 
	#TZ_MAX_TYPES
 256

	)

110 #ifdeà
NOSOLAR


115 
	#TZ_MAX_TYPES
 20

	)

119 #iâdeà
TZ_MAX_CHARS


120 
	#TZ_MAX_CHARS
 50

	)

124 #iâdeà
TZ_MAX_LEAPS


125 
	#TZ_MAX_LEAPS
 50

	)

128 
	#SECSPERMIN
 60

	)

129 
	#MINSPERHOUR
 60

	)

130 
	#HOURSPERDAY
 24

	)

131 
	#DAYSPERWEEK
 7

	)

132 
	#DAYSPERNYEAR
 365

	)

133 
	#DAYSPERLYEAR
 366

	)

134 
	#SECSPERHOUR
 (
SECSPERMIN
 * 
MINSPERHOUR
)

	)

135 
	#SECSPERDAY
 ((è
SECSPERHOUR
 * 
HOURSPERDAY
)

	)

136 
	#MONSPERYEAR
 12

	)

138 
	#TM_SUNDAY
 0

	)

139 
	#TM_MONDAY
 1

	)

140 
	#TM_TUESDAY
 2

	)

141 
	#TM_WEDNESDAY
 3

	)

142 
	#TM_THURSDAY
 4

	)

143 
	#TM_FRIDAY
 5

	)

144 
	#TM_SATURDAY
 6

	)

146 
	#TM_JANUARY
 0

	)

147 
	#TM_FEBRUARY
 1

	)

148 
	#TM_MARCH
 2

	)

149 
	#TM_APRIL
 3

	)

150 
	#TM_MAY
 4

	)

151 
	#TM_JUNE
 5

	)

152 
	#TM_JULY
 6

	)

153 
	#TM_AUGUST
 7

	)

154 
	#TM_SEPTEMBER
 8

	)

155 
	#TM_OCTOBER
 9

	)

156 
	#TM_NOVEMBER
 10

	)

157 
	#TM_DECEMBER
 11

	)

159 
	#TM_YEAR_BASE
 1900

	)

161 
	#EPOCH_YEAR
 1970

	)

162 
	#EPOCH_WDAY
 
TM_THURSDAY


	)

164 
	#i¦—p
(
y
è(((yè% 4è=ğ0 && (((yè% 100è!ğ0 || ((yè% 400è=ğ0))

	)

178 
	#i¦—p_sum
(
a
, 
b
è
	`i¦—p
(×è% 400 + (bè% 400)

	)

	@libs/libcutils/tzstrftime.c

1 #iâdeà
lšt


2 #iâdeà
NOID


3 
	g–s›id
[] = "@(#)strftime.c 8.1";

11 
	~<¡dio.h
>

12 
	~<time.h
>

13 
	~<tzfe.h
>

14 
	~<lim™s.h
>

15 
	~<cuts/tztime.h
>

34 #iâdeà
LIBC_SCCS


35 #iâdeà
lšt


36 cÚ¡ 
	gsccsid
[] = "@(#)strftime.c 5.4 (Berkeley) 3/14/89";

40 
	~<ùy³.h
>

42 
	#P
(
x
è
	)
x

44 * 
_add
 
P
((const *, *, const *, ));

45 * 
_cÚv
 
P
((, const *, *, const *));

46 * 
_fmt
 
P
((cÚ¡ *, cÚ¡ 
tm
 *, *, const *,

47 *, cÚ¡ 
¡ráime_loÿË
 *
LoÿË
));

48 * 
_ycÚv
 
P
((, , , , *, const *, ));

49 * 
g‘fÜm©
 
P
((, *, *, *, *));

51 * 
tzÇme
[];

59 #iâdeà
TYPE_BIT


60 
	#TYPE_BIT
(
ty³
è( (ty³è* 
CHAR_BIT
)

	)

63 #iâdeà
TYPE_SIGNED


64 
	#TYPE_SIGNED
(
ty³
è((Ñy³è-1è< 0)

	)

67 #iâdeà
INT_STRLEN_MAXIMUM


74 
	#INT_STRLEN_MAXIMUM
(
ty³
) \

75 ((
	`TYPE_BIT
(
ty³
è- 
	`TYPE_SIGNED
(type)) * 302 / 1000 + \

76 1 + 
	`TYPE_SIGNED
(
ty³
))

	)

84 #iâdeà
YEAR_2000_NAME


85 
	#YEAR_2000_NAME
 "CHECK_STRFTIME_FORMATS_FOR_TWO_DIGIT_YEARS"

	)

88 
	#IN_NONE
 0

	)

89 
	#IN_SOME
 1

	)

90 
	#IN_THIS
 2

	)

91 
	#IN_ALL
 3

	)

93 
	#FORCE_LOWER_CASE
 0x100

	)

95 
size_t


96 
	$¡ráime_tz
(
s
, 
maxsize
, 
fÜm©
, 
t
, 
LoÿË
)

97 * cÚ¡ 
s
;

98 cÚ¡ 
size_t
 
maxsize
;

99 cÚ¡ * cÚ¡ 
fÜm©
;

100 cÚ¡ 
tm
 * cÚ¡ 
t
;

101 cÚ¡ 
¡ráime_loÿË
 *
LoÿË
;

103 * 
p
;

104 
w¬n
;

106 
w¬n
 = 
IN_NONE
;

107 
p
 = 
	`_fmt
(((
fÜm©
 =ğ
NULL
è? "%c" : fÜm©), 
t
, 
s
, s + 
maxsize
, &
w¬n
, 
LoÿË
);

109 ià(
w¬n
 !ğ
IN_NONE
 && 
	`g‘’v
(
YEAR_2000_NAME
è!ğ
NULL
) {

110 (è
	`årštf
(
¡d”r
, "\n");

111 ià(
fÜm©
 =ğ
NULL
)

112 (è
	`årštf
(
¡d”r
, "NULL strftime format ");

113 (è
	`årštf
(
¡d”r
, "strftime format \"%s\" ",

114 
fÜm©
);

115 (è
	`årštf
(
¡d”r
, "yields onlywo digits of years in ");

116 ià(
w¬n
 =ğ
IN_SOME
)

117 (è
	`årštf
(
¡d”r
, "some†ocales");

118 ià(
w¬n
 =ğ
IN_THIS
)

119 (è
	`årštf
(
¡d”r
, "the current†ocale");

120 (è
	`årštf
(
¡d”r
, "all†ocales");

121 (è
	`årštf
(
¡d”r
, "\n");

124 ià(
p
 =ğ
s
 + 
maxsize
)

126 *
p
 = '\0';

127  
p
 - 
s
;

128 
	}
}

130 *
	$g‘fÜm©
(
modif›r
, *
nÜm®
, *
und”scÜe
,

131 *
dash
, *
z”o
) {

132 
modif›r
) {

134  
und”scÜe
;

137  
dash
;

140  
z”o
;

143  
nÜm®
;

144 
	}
}

147 
	$_fmt
(
fÜm©
, 
t
, 
±
, 
±lim
, 
w¬Å
, 
LoÿË
)

148 cÚ¡ * 
fÜm©
;

149 cÚ¡ 
tm
 * cÚ¡ 
t
;

150 * 
±
;

151 cÚ¡ * cÚ¡ 
±lim
;

152 * 
w¬Å
;

153 cÚ¡ 
¡ráime_loÿË
 *
LoÿË
;

155  ; *
fÜm©
; ++format) {

156 ià(*
fÜm©
 == '%') {

157 
modif›r
 = 0;

158 
Ïb–
:

159 *++
fÜm©
) {

161 --
fÜm©
;

164 
±
 = 
	`_add
((
t
->
tm_wday
 < 0 ||

165 
t
->
tm_wday
 >ğ
DAYSPERWEEK
) ?

166 "?" : 
LoÿË
->
w“kday
[
t
->
tm_wday
],

167 
±
, 
±lim
, 
modif›r
);

170 
±
 = 
	`_add
((
t
->
tm_wday
 < 0 ||

171 
t
->
tm_wday
 >ğ
DAYSPERWEEK
) ?

172 "?" : 
LoÿË
->
wday
[
t
->
tm_wday
],

173 
±
, 
±lim
, 
modif›r
);

176 ià(
modif›r
 == '-') {

177 
±
 = 
	`_add
((
t
->
tm_mÚ
 < 0 ||

178 
t
->
tm_mÚ
 >ğ
MONSPERYEAR
) ?

179 "?" : 
LoÿË
->
¡ªd®Úe_mÚth
[
t
->
tm_mÚ
],

180 
±
, 
±lim
, 
modif›r
);

182 
±
 = 
	`_add
((
t
->
tm_mÚ
 < 0 ||

183 
t
->
tm_mÚ
 >ğ
MONSPERYEAR
) ?

184 "?" : 
LoÿË
->
mÚth
[
t
->
tm_mÚ
],

185 
±
, 
±lim
, 
modif›r
);

190 
±
 = 
	`_add
((
t
->
tm_mÚ
 < 0 ||

191 
t
->
tm_mÚ
 >ğ
MONSPERYEAR
) ?

192 "?" : 
LoÿË
->
mÚ
[
t
->
tm_mÚ
],

193 
±
, 
±lim
, 
modif›r
);

203 
±
 = 
	`_ycÚv
(
t
->
tm_y—r
, 
TM_YEAR_BASE
, 1, 0,

204 
±
, 
±lim
, 
modif›r
);

208 
w¬n2
 = 
IN_SOME
;

210 
±
 = 
	`_fmt
(
LoÿË
->
c_fmt
, 
t
,…t, 
±lim
, 
w¬Å
, Locale);

211 ià(
w¬n2
 =ğ
IN_ALL
)

212 
w¬n2
 = 
IN_THIS
;

213 ià(
w¬n2
 > *
w¬Å
)

214 *
w¬Å
 = 
w¬n2
;

218 
±
 = 
	`_fmt
("%m/%d/%y", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

221 
±
 = 
	`_cÚv
(
t
->
tm_mday
,

222 
	`g‘fÜm©
(
modif›r
, "%02d",

224 
±
, 
±lim
);

237 
Ïb–
;

243 
modif›r
 = *
fÜm©
;

244 
Ïb–
;

246 
±
 = 
	`_cÚv
(
t
->
tm_mday
,

247 
	`g‘fÜm©
(
modif›r
, "%2d",

249 
±
, 
±lim
);

252 
±
 = 
	`_fmt
("%Y-%m-%d", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

255 
±
 = 
	`_cÚv
(
t
->
tm_hour
,

256 
	`g‘fÜm©
(
modif›r
, "%02d",

258 
±
, 
±lim
);

261 
±
 = 
	`_cÚv
((
t
->
tm_hour
 % 12) ?

262 (
t
->
tm_hour
 % 12) : 12,

263 
	`g‘fÜm©
(
modif›r
, "%02d",

265 
±
, 
±lim
);

268 
±
 = 
	`_cÚv
(
t
->
tm_yday
 + 1,

269 
	`g‘fÜm©
(
modif›r
, "%03d", "%3d", "%d", "%03d"),

270 
±
, 
±lim
);

283 
±
 = 
	`_cÚv
(
t
->
tm_hour
,

284 
	`g‘fÜm©
(
modif›r
, "%2d",

286 
±
, 
±lim
);

288 #ifdeà
KITCHEN_SINK


293 
±
 = 
	`_add
("k™ch’ sšk",…t, 
±lim
, 
modif›r
);

306 
±
 = 
	`_cÚv
((
t
->
tm_hour
 % 12) ?

307 (
t
->
tm_hour
 % 12) : 12,

308 
	`g‘fÜm©
(
modif›r
, "%2d",

310 
±
, 
±lim
);

313 
±
 = 
	`_cÚv
(
t
->
tm_mš
,

314 
	`g‘fÜm©
(
modif›r
, "%02d",

316 
±
, 
±lim
);

319 
±
 = 
	`_cÚv
(
t
->
tm_mÚ
 + 1,

320 
	`g‘fÜm©
(
modif›r
, "%02d",

322 
±
, 
±lim
);

325 
±
 = 
	`_add
("\n",…t, 
±lim
, 
modif›r
);

328 
±
 = 
	`_add
((
t
->
tm_hour
 >ğ(
HOURSPERDAY
 / 2)) ?

329 
LoÿË
->
pm
 :

330 
LoÿË
->
am
,

331 
±
, 
±lim
, 
modif›r
);

334 
±
 = 
	`_add
((
t
->
tm_hour
 >ğ(
HOURSPERDAY
 / 2)) ?

335 
LoÿË
->
pm
 :

336 
LoÿË
->
am
,

337 
±
, 
±lim
, 
FORCE_LOWER_CASE
);

340 
±
 = 
	`_fmt
("%H:%M", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

343 
±
 = 
	`_fmt
("%I:%M:%S %p", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

346 
±
 = 
	`_cÚv
(
t
->
tm_£c
,

347 
	`g‘fÜm©
(
modif›r
, "%02d",

349 
±
, 
±lim
);

353 
tm
m;

354 
buf
[
	`INT_STRLEN_MAXIMUM
(

355 
time_t
) + 1];

356 
time_t
 
mkt
;

358 
tm
 = *
t
;

359 
mkt
 = 
	`mktime
(&
tm
);

360 ià(
	`TYPE_SIGNED
(
time_t
))

361 (è
	`¥rštf
(
buf
, "%ld",

362 (è
mkt
);

363 (è
	`¥rštf
(
buf
, "%lu",

364 (è
mkt
);

365 
±
 = 
	`_add
(
buf
,…t, 
±lim
, 
modif›r
);

369 
±
 = 
	`_fmt
("%H:%M:%S", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

372 
±
 = 
	`_add
("\t",…t, 
±lim
, 
modif›r
);

375 
±
 = 
	`_cÚv
((
t
->
tm_yday
 + 
DAYSPERWEEK
 -

376 
t
->
tm_wday
è/ 
DAYSPERWEEK
,

377 
	`g‘fÜm©
(
modif›r
, "%02d",

379 
±
, 
±lim
);

388 
±
 = 
	`_cÚv
((
t
->
tm_wday
 == 0) ?

389 
DAYSPERWEEK
 : 
t
->
tm_wday
, "%d", 
±
, 
±lim
);

413 
y—r
;

414 
ba£
;

415 
yday
;

416 
wday
;

417 
w
;

419 
y—r
 = 
t
->
tm_y—r
;

420 
ba£
 = 
TM_YEAR_BASE
;

421 
yday
 = 
t
->
tm_yday
;

422 
wday
 = 
t
->
tm_wday
;

424 
Ën
;

425 
bÙ
;

426 
tİ
;

428 
Ën
 = 
	`i¦—p_sum
(
y—r
, 
ba£
) ?

429 
DAYSPERLYEAR
 :

430 
DAYSPERNYEAR
;

435 
bÙ
 = ((
yday
 + 11 - 
wday
) %

436 
DAYSPERWEEK
) - 3;

441 
tİ
 = 
bÙ
 -

442 (
Ën
 % 
DAYSPERWEEK
);

443 ià(
tİ
 < -3)

444 
tİ
 +ğ
DAYSPERWEEK
;

445 
tİ
 +ğ
Ën
;

446 ià(
yday
 >ğ
tİ
) {

447 ++
ba£
;

448 
w
 = 1;

451 ià(
yday
 >ğ
bÙ
) {

452 
w
 = 1 + ((
yday
 - 
bÙ
) /

453 
DAYSPERWEEK
);

456 --
ba£
;

457 
yday
 +ğ
	`i¦—p_sum
(
y—r
, 
ba£
) ?

458 
DAYSPERLYEAR
 :

459 
DAYSPERNYEAR
;

461 #ifdeà
XPG4_1994_04_09


462 ià((
w
 == 52 &&

463 
t
->
tm_mÚ
 =ğ
TM_JANUARY
) ||

464 (
w
 == 1 &&

465 
t
->
tm_mÚ
 =ğ
TM_DECEMBER
))

466 
w
 = 53;

468 ià(*
fÜm©
 == 'V')

469 
±
 = 
	`_cÚv
(
w
,

470 
	`g‘fÜm©
(
modif›r
,

475 
±
, 
±lim
);

476 ià(*
fÜm©
 == 'g') {

477 *
w¬Å
 = 
IN_ALL
;

478 
±
 = 
	`_ycÚv
(
y—r
, 
ba£
, 0, 1,

479 
±
, 
±lim
, 
modif›r
);

480 } 
±
 = 
	`_ycÚv
(
y—r
, 
ba£
, 1, 1,

481 
±
, 
±lim
, 
modif›r
);

490 
±
 = 
	`_fmt
("%e-%b-%Y", 
t
,…t, 
±lim
, 
w¬Å
, 
LoÿË
);

493 
±
 = 
	`_cÚv
((
t
->
tm_yday
 + 
DAYSPERWEEK
 -

494 (
t
->
tm_wday
 ?

495 (
t
->
tm_wday
 - 1) :

496 (
DAYSPERWEEK
 - 1))) / DAYSPERWEEK,

497 
	`g‘fÜm©
(
modif›r
, "%02d",

499 
±
, 
±lim
);

502 
±
 = 
	`_cÚv
(
t
->
tm_wday
, "%d",…t, 
±lim
);

505 
±
 = 
	`_fmt
(
LoÿË
->
X_fmt
, 
t
,…t, 
±lim
, 
w¬Å
, Locale);

509 
w¬n2
 = 
IN_SOME
;

511 
±
 = 
	`_fmt
(
LoÿË
->
x_fmt
, 
t
,…t, 
±lim
, &
w¬n2
, Locale);

512 ià(
w¬n2
 =ğ
IN_ALL
)

513 
w¬n2
 = 
IN_THIS
;

514 ià(
w¬n2
 > *
w¬Å
)

515 *
w¬Å
 = 
w¬n2
;

519 *
w¬Å
 = 
IN_ALL
;

520 
±
 = 
	`_ycÚv
(
t
->
tm_y—r
, 
TM_YEAR_BASE
, 0, 1,

521 
±
, 
±lim
, 
modif›r
);

524 
±
 = 
	`_ycÚv
(
t
->
tm_y—r
, 
TM_YEAR_BASE
, 1, 1,

525 
±
, 
±lim
, 
modif›r
);

528 #ifdeà
TM_ZONE


529 ià(
t
->
TM_ZONE
 !ğ
NULL
)

530 
±
 = 
	`_add
(
t
->
TM_ZONE
,…t, 
±lim
,

531 
modif›r
);

534 ià(
t
->
tm_isd¡
 >= 0)

535 
±
 = 
	`_add
(
tzÇme
[
t
->
tm_isd¡
 != 0],

536 
±
, 
±lim
, 
modif›r
);

545 
diff
;

546 cÚ¡ * 
sign
;

548 ià(
t
->
tm_isd¡
 < 0)

550 #ifdeà
TM_GMTOFF


551 
diff
 = 
t
->
TM_GMTOFF
;

572 ià(
t
->
tm_isd¡
 == 0)

573 #ifdeà
USG_COMPAT


574 
diff
 = -
timezÚe
;

579 #ifdeà
ALTZONE


580 
diff
 = -
®tzÚe
;

585 ià(
diff
 < 0) {

586 
sign
 = "-";

587 
diff
 = -diff;

588 } 
sign
 = "+";

589 
±
 = 
	`_add
(
sign
,…t, 
±lim
, 
modif›r
);

590 
diff
 /ğ
SECSPERMIN
;

591 
diff
 = (difà/ 
MINSPERHOUR
) * 100 +

592 (
diff
 % 
MINSPERHOUR
);

593 
±
 = 
	`_cÚv
(
diff
,

594 
	`g‘fÜm©
(
modif›r
, "%04d",

596 
±
, 
±lim
);

600 
±
 = 
	`_fmt
(
LoÿË
->
d©e_fmt
, 
t
,…t, 
±lim
,

601 
w¬Å
, 
LoÿË
);

613 ià(
±
 =ğ
±lim
)

615 *
±
++ = *
fÜm©
;

617  
±
;

618 
	}
}

621 
	$_cÚv
(
n
, 
fÜm©
, 
±
, 
±lim
)

622 cÚ¡ 
n
;

623 cÚ¡ * cÚ¡ 
fÜm©
;

624 * cÚ¡ 
±
;

625 cÚ¡ * cÚ¡ 
±lim
;

627 
buf
[
	`INT_STRLEN_MAXIMUM
() + 1];

629 (è
	`¥rštf
(
buf
, 
fÜm©
, 
n
);

630  
	`_add
(
buf
, 
±
, 
±lim
, 0);

631 
	}
}

634 
	$_add
(
¡r
, 
±
, 
±lim
, 
modif›r
)

635 cÚ¡ * 
¡r
;

636 * 
±
;

637 cÚ¡ * cÚ¡ 
±lim
;

638 
modif›r
;

640 
c
;

642 
modif›r
) {

643 
FORCE_LOWER_CASE
:

644 
±
 < 
±lim
 && (*± = 
	`tŞow”
(*
¡r
++)) != '\0') {

645 ++
±
;

650 
±
 < 
±lim
 && (*± = 
	`touµ”
(*
¡r
++)) != '\0') {

651 ++
±
;

656 
±
 < 
±lim
 && (
c
 = *
¡r
++) != '\0') {

657 ià(
	`isuµ”
(
c
)) {

658 
c
 = 
	`tŞow”
(c);

659 } ià(
	`i¦ow”
(
c
)) {

660 
c
 = 
	`touµ”
(c);

662 *
±
 = 
c
;

663 ++
±
;

669 
±
 < 
±lim
 && (*± = *
¡r
++) != '\0') {

670 ++
±
;

674  
±
;

675 
	}
}

686 
	$_ycÚv
(
a
, 
b
, 
cÚv”t_tİ
, 
cÚv”t_yy
, 
±
, 
±lim
, 
modif›r
)

687 cÚ¡ 
a
;

688 cÚ¡ 
b
;

689 cÚ¡ 
cÚv”t_tİ
;

690 cÚ¡ 
cÚv”t_yy
;

691 * 
±
;

692 cÚ¡ * cÚ¡ 
±lim
;

693 
modif›r
;

695 
Ëad
;

696 
Œa
;

698 
	#DIVISOR
 100

	)

699 
Œa
 = 
a
 % 
DIVISOR
 + 
b
 % DIVISOR;

700 
Ëad
 = 
a
 / 
DIVISOR
 + 
b
 / DIVISOR + 
Œa
 / DIVISOR;

701 
Œa
 %ğ
DIVISOR
;

702 ià(
Œa
 < 0 && 
Ëad
 > 0) {

703 
Œa
 +ğ
DIVISOR
;

704 --
Ëad
;

705 } ià(
Ëad
 < 0 && 
Œa
 > 0) {

706 
Œa
 -ğ
DIVISOR
;

707 ++
Ëad
;

709 ià(
cÚv”t_tİ
) {

710 ià(
Ëad
 =ğ0 && 
Œa
 < 0)

711 
±
 = 
	`_add
("-0",…t, 
±lim
, 
modif›r
);

712 
±
 = 
	`_cÚv
(
Ëad
, 
	`g‘fÜm©
(
modif›r
, "%02d",

714 
±
, 
±lim
);

716 ià(
cÚv”t_yy
)

717 
±
 = 
	`_cÚv
(((
Œa
 < 0) ? -trail :rail),

718 
	`g‘fÜm©
(
modif›r
, "%02d", "%2d", "%d", "%02d"),

719 
±
, 
±lim
);

720  
±
;

721 
	}
}

723 #ifdeà
LOCALE_HOME


724 
lc_time_T
 *

725 
_loc
 
P
(())

727 cÚ¡ 
	gloÿË_home
[] = 
LOCALE_HOME
;

728 cÚ¡ 
	glc_time
[] = "LC_TIME";

729 * 
	gloÿË_buf
;

731 
	gfd
;

732 
	gŞdsun
;

733 * 
	glbuf
;

734 * 
	gÇme
;

735 * 
	gp
;

736 cÚ¡ ** 
	g­
;

737 cÚ¡ * 
	g¶im
;

738 
	gf’ame
[
FILENAME_MAX
];

739 
¡©
 
	g¡
;

740 
size_t
 
	gÇmesize
;

741 
size_t
 
	gbufsize
;

746 ià(
	gloÿËbuf
.
	gmÚ
[0])

747  &
	gloÿËbuf
;

748 
	gÇme
 = 
£oÿË
(
LC_TIME
, (*è
NULL
);

749 ià(
	gÇme
 =ğ
NULL
 || *
Çme
 == '\0')

750 
no_loÿË
;

754 
	glbuf
 = 
loÿË_buf
;

755 ià(
	glbuf
 !ğ
NULL
 && 
¡rcmp
(
Çme
, 
lbuf
) == 0) {

756 
p
 = 
lbuf
;

757 
	g­
 = (cÚ¡ **è&
loÿËbuf
;

758 
	g­
 < (cÚ¡ **è(&
	gloÿËbuf
 + 1);

759 ++
	g­
)

760 *
	g­
 = 
p
 +ğ
¡¾’
(p) + 1;

761  &
	gloÿËbuf
;

766 
	gÇmesize
 = 
¡¾’
(
Çme
) + 1;

767 ià( 
	gf’ame
 <

768 (( 
	gloÿË_home
è+ 
	gÇmesize
 + ( 
	glc_time
)))

769 
	gno_loÿË
;

770 
	gŞdsun
 = 0;

771 (è
¥rštf
(
f’ame
, "%s/%s/%s", 
loÿË_home
, 
Çme
, 
lc_time
);

772 
	gfd
 = 
İ’
(
f’ame
, 
O_RDONLY
);

773 ià(
	gfd
 < 0) {

777 
	gŞdsun
 = 1;

778 (è
¥rštf
(
f’ame
, "%s/%s/%s", 
loÿË_home
,

779 
lc_time
, 
Çme
);

780 
	gfd
 = 
İ’
(
f’ame
, 
O_RDONLY
);

781 ià(
	gfd
 < 0)

782 
	gno_loÿË
;

784 ià(
f¡©
(
fd
, &
¡
) != 0)

785 
bad_loÿË
;

786 ià(
	g¡
.
	g¡_size
 <= 0)

787 
bad_loÿË
;

788 
	gbufsize
 = 
Çmesize
 + 
¡
.
¡_size
;

789 
	gloÿË_buf
 = 
NULL
;

790 
	glbuf
 = (
lbuf
 =ğ
NULL
è? 
m®loc
(
bufsize
è: 
»®loc
(lbuf, bufsize);

791 ià(
	glbuf
 =ğ
NULL
)

792 
bad_loÿË
;

793 (è
¡rıy
(
lbuf
, 
Çme
);

794 
	gp
 = 
lbuf
 + 
Çmesize
;

795 
	g¶im
 = 
p
 + 
¡
.
¡_size
;

796 ià(
»ad
(
fd
, 
p
, (
size_t
è
¡
.
¡_size
) != st.st_size)

797 
bad_lbuf
;

798 ià(
şo£
(
fd
) != 0)

799 
bad_lbuf
;

803 ià(
	g¶im
[-1] != '\n')

804 
bad_lbuf
;

805 
	g­
 = (cÚ¡ **è&
loÿËbuf
;

806 
	g­
 < (cÚ¡ **è(&
	gloÿËbuf
 + 1);

807 ++
	g­
) {

808 ià(
	gp
 =ğ
¶im
)

809 
bad_lbuf
;

810 *
	g­
 = 
p
;

811 *
	gp
 != '\n')

812 ++
p
;

813 *
	gp
++ = '\0';

815 ià(
	gŞdsun
) {

824 
	gloÿËbuf
.
	gd©e_fmt
 = 
loÿËbuf
.
c_fmt
;

829 
	gloÿË_buf
 = 
lbuf
;

831  &
	gloÿËbuf
;

833 
	gbad_lbuf
:

834 
ä“
(
lbuf
);

835 
	gbad_loÿË
:

836 (è
şo£
(
fd
);

837 
	gno_loÿË
:

838 
loÿËbuf
 = 
C_time_loÿË
;

839 
	gloÿË_buf
 = 
NULL
;

840  &
	gloÿËbuf
;

	@libs/libcutils/tztime.c

6 
	~<¡dio.h
>

8 #iâdeà
lšt


9 #iâdeà
NOID


10 
	g–s›id
[] = "@(#)localtime.c 8.3";

21 
	~"´iv©e.h
"

22 
	~"tzfe.h
"

23 
	~"fú.h
"

24 
	~"æßt.h
"

26 #iâdeà
TZ_ABBR_MAX_LEN


27 
	#TZ_ABBR_MAX_LEN
 16

	)

30 #iâdeà
TZ_ABBR_CHAR_SET


31 
	#TZ_ABBR_CHAR_SET
 \

32 "abcdefghijklmnİqr¡uvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 :+-._"

	)

35 #iâdeà
TZ_ABBR_ERR_CHAR


36 
	#TZ_ABBR_ERR_CHAR
 '_'

	)

39 
	#INDEXFILE
 "/sy¡em/u¤/sh¬e/zÚešfo/zÚešfo.idx"

	)

40 
	#DATAFILE
 "/sy¡em/u¤/sh¬e/zÚešfo/zÚešfo.d©"

	)

41 
	#NAMELEN
 40

	)

42 
	#INTLEN
 4

	)

43 
	#READLEN
 (
NAMELEN
 + 3 * 
INTLEN
)

	)

49 #ifdeà
O_BINARY


50 
	#OPEN_MODE
 (
O_RDONLY
 | 
O_BINARY
)

	)

52 #iâdeà
O_BINARY


53 
	#OPEN_MODE
 
O_RDONLY


	)

61 cÚ¡ 
time_t
 
	gTIME_T_MAX
 =

62 
TYPE_INTEGRAL
(
time_t
) ?

63 Ğ
TYPE_SIGNED
(
time_t
) ?

64 ~((
time_t
)1 << (
TYPE_BIT
(time_t)-1))

66 ~(
time_t
)0

69 Ğ(
time_t
è> (è? (time_t)
DBL_MAX
 : (time_t)
FLT_MAX
 );

71 cÚ¡ 
time_t
 
	gTIME_T_MIN
 =

72 
TYPE_INTEGRAL
(
time_t
) ?

73 Ğ
TYPE_SIGNED
(
time_t
) ?

74 ((
time_t
)1 << (
TYPE_BIT
(time_t)-1))

79 Ğ(
time_t
è> (è? (time_t)
DBL_MIN
 : (time_t)
FLT_MIN
 );

81 #iâdeà
WILDABBR


101 
	#WILDABBR
 " "

	)

104 
	gwdabbr
[] = 
WILDABBR
;

106 cÚ¡ 
	ggmt
[] = "GMT";

115 #iâdeà
TZDEFRULESTRING


116 
	#TZDEFRULESTRING
 ",M4.1.0,M10.5.0"

	)

119 
	s‰šfo
 {

120 
	m‰_gmtoff
;

121 
	m‰_isd¡
;

122 
	m‰_abbršd
;

123 
	m‰_‰is¡d
;

124 
	m‰_‰isgmt
;

127 
	slsšfo
 {

128 
time_t
 
	mls_Œªs
;

129 
	mls_cÜr
;

132 
	#BIGGEST
(
a
, 
b
è((×è> (b)è? (aè: (b))

	)

134 #ifdeà
TZNAME_MAX


135 
	#MY_TZNAME_MAX
 
TZNAME_MAX


	)

137 #iâdeà
TZNAME_MAX


138 
	#MY_TZNAME_MAX
 255

	)

141 
	s¡©e
 {

142 
	mË­út
;

143 
	mtimeút
;

144 
	mty³út
;

145 
	mch¬út
;

146 
	mgoback
;

147 
	mgßh—d
;

148 
time_t
 
	m©s
[
TZ_MAX_TIMES
];

149 
	mty³s
[
TZ_MAX_TIMES
];

150 
‰šfo
 
	m‰is
[
TZ_MAX_TYPES
];

151 
	mch¬s
[
BIGGEST
(BIGGEST(
TZ_MAX_CHARS
 + 1,  
gmt
),

152 (2 * (
MY_TZNAME_MAX
 + 1)))];

153 
lsšfo
 
	mlsis
[
TZ_MAX_LEAPS
];

156 
	sruË
 {

157 
	mr_ty³
;

158 
	mr_day
;

159 
	mr_w“k
;

160 
	mr_mÚ
;

161 
	mr_time
;

164 
	#JULIAN_DAY
 0

	)

165 
	#DAY_OF_YEAR
 1

	)

166 
	#MONTH_NTH_DAY_OF_WEEK
 2

	)

172 
d‘zcode
 
P
((cÚ¡ * 
cod•
));

173 
time_t
 
d‘zcode64
 
P
((cÚ¡ * 
cod•
));

174 
difãr_by_»³©
 
P
((
time_t
 
t1
,ime_ˆ
t0
));

175 cÚ¡ * 
g‘zÇme
 
P
((cÚ¡ * 
¡½
));

176 cÚ¡ * 
g‘qzÇme
 
P
((cÚ¡ * 
¡½
, cÚ¡ 
d–im
));

177 cÚ¡ * 
g‘num
 
P
((cÚ¡ * 
¡½
, * 
nump
, 
mš
,

178 
max
));

179 cÚ¡ * 
g‘£cs
 
P
((cÚ¡ * 
¡½
, * 
£c¥
));

180 cÚ¡ * 
g‘off£t
 
P
((cÚ¡ * 
¡½
, * 
off£
));

181 cÚ¡ * 
g‘ruË
 
P
((cÚ¡ * 
¡½
, 
ruË
 * 
ruËp
));

182 
gmßd
 
P
((
¡©e
 * 
¥
));

183 
tm
 * 
gmtsub
 
P
((cÚ¡ 
time_t
 * 
tim•
, 
off£t
,

184 
tm
 * 
tmp
));

185 
tm
 * 
loÿlsub
 
P
((cÚ¡ 
time_t
 * 
tim•
, 
off£t
,

186 
tm
 * 
tmp
, cÚ¡ 
¡©e
 *
¥
));

187 
šüem’t_ov”æow
 
P
((* 
numb”
, 
d–
));

188 
Ë­s_thru_’d_of
 
P
((
y
));

189 
lÚg_šüem’t_ov”æow
 
P
((* 
numb”
, 
d–
));

190 
lÚg_nÜm®ize_ov”æow
 
P
((* 
‹n¥Œ
,

191 * 
un™¥Œ
, 
ba£
));

192 
nÜm®ize_ov”æow
 
P
((* 
‹n¥Œ
, * 
un™¥Œ
,

193 
ba£
));

194 
£‰zÇme
 
P
(());

195 
time_t
 
time1
 
P
((
tm
 * 
tmp
,

196 
tm
 * (*
funı
è
P
((cÚ¡ 
time_t
 *,

197 , 
tm
 *, cÚ¡ 
¡©e
* 
¥
)),

198 
off£t
, cÚ¡ 
¡©e
 * 
¥
));

199 
time_t
 
time2
 
P
((
tm
 *
tmp
,

200 
tm
 * (*
funı
è
P
((cÚ¡ 
time_t
 *,

201 , 
tm
*, cÚ¡ 
¡©e
* 
¥
)),

202 
off£t
, * 
okayp
, cÚ¡ 
¡©e
 * 
¥
));

203 
time_t
 
time2sub
 
P
((
tm
 *
tmp
,

204 
tm
 * (*
funı
è
P
((cÚ¡ 
time_t
*, , tm*,cÚ¡ 
¡©e
 *
¥
)),

205 
off£t
, * 
okayp
, 
do_nÜm_£cs
,

206 cÚ¡ 
¡©e
 *
¥
));

207 
tm
 * 
timesub
 
P
((cÚ¡ 
time_t
 * 
tim•
, 
off£t
,

208 cÚ¡ 
¡©e
 * 
¥
, 
tm
 * 
tmp
));

209 
tmcomp
 
P
((cÚ¡ 
tm
 * 
©mp
,

210 cÚ¡ 
tm
 * 
btmp
));

211 
time_t
 
Œª¡ime
 
P
(Ñime_ˆ
jªfœ¡
, 
y—r
,

212 cÚ¡ 
ruË
 * 
ruËp
, 
off£t
));

213 
tzlßd
 
P
((cÚ¡ * 
Çme
, 
¡©e
 * 
¥
,

214 
dÛx‹nd
));

215 
tzlßd_unÿched
 
P
((cÚ¡ * 
Çme
, 
¡©e
 * 
¥
,

216 
dÛx‹nd
));

217 
tz·r£
 
P
((cÚ¡ * 
Çme
, 
¡©e
 * 
¥
,

218 
Ï¡d™ch
));

220 #ifdeà
ALL_STATE


221 
¡©e
 * 
	ggmŒ
;

224 #iâdeà
ALL_STATE


225 
¡©e
 
	ggmtmem
;

226 
	#gmŒ
 (&
gmtmem
)

	)

229 
	#CACHE_COUNT
 4

	)

230 * 
	gg_ÿcheNames
[
CACHE_COUNT
] = {0,0};

231 
¡©e
 
	gg_ÿcheS‹s
[
CACHE_COUNT
];

232 
	gg_Ï¡Cache
 = 0;

233 
¡©e
 
	gg_utc
;

234 
	gg_utcS‘
 = 0;

237 #iâdeà
TZ_STRLEN_MAX


238 
	#TZ_STRLEN_MAX
 255

	)

241 
	glş_TZÇme
[
TZ_STRLEN_MAX
 + 1];

242 
	glş_is_£t
;

243 
	ggmt_is_£t
;

245 * 
	gtzÇme
[2] = {

246 
wdabbr
,

247 
wdabbr


258 
tm
 
	gtm
;

260 #ifdeà
USG_COMPAT


261 
time_t
 
	gtimezÚe
 = 0;

262 
	gdaylight
 = 0;

265 #ifdeà
ALTZONE


266 
time_t
 
	g®tzÚe
 = 0;

270 
	$d‘zcode
(
cod•
)

271 cÚ¡ * cÚ¡ 
cod•
;

273 
»suÉ
;

274 
i
;

276 
»suÉ
 = (
cod•
[0] & 0x80) ? ~0L : 0;

277 
i
 = 0; i < 4; ++i)

278 
»suÉ
 = (»suÉ << 8è| (
cod•
[
i
] & 0xff);

279  
»suÉ
;

280 
	}
}

282 
time_t


283 
	$d‘zcode64
(
cod•
)

284 cÚ¡ * cÚ¡ 
cod•
;

286 
time_t
 
»suÉ
;

287 
i
;

289 
»suÉ
 = (
cod•
[0] & 0x80è? (~(
št_ç¡64_t
) 0) : 0;

290 
i
 = 0; i < 8; ++i)

291 
»suÉ
 =„esuÉ * 256 + (
cod•
[
i
] & 0xff);

292  
»suÉ
;

293 
	}
}

296 
	$difãr_by_»³©
(
t1
, 
t0
)

297 cÚ¡ 
time_t
 
t1
;

298 cÚ¡ 
time_t
 
t0
;

300 ià(
	`TYPE_INTEGRAL
(
time_t
) &&

301 
	`TYPE_BIT
(
time_t
è- 
	`TYPE_SIGNED
Ñime_tè< 
SECSPERREPEAT_BITS
)

303  
t1
 - 
t0
 =ğ
SECSPERREPEAT
;

304 
	}
}

306 
	$tošt
(*
s
) {

307  (
s
[0] << 24) | (s[1] << 16) | (s[2] << 8) | s[3];

308 
	}
}

311 
	$tzlßd
(cÚ¡ *
Çme
, 
¡©e
 * cÚ¡ 
¥
, cÚ¡ 
dÛx‹nd
)

313 ià(
Çme
) {

314 
i
, 
”r
;

315 ià(0 =ğ
	`¡rcmp
(
Çme
, "UTC")) {

316 ià(!
g_utcS‘
) {

317 
	`tzlßd_unÿched
(
Çme
, &
g_utc
, 1);

318 
g_utcS‘
 = 1;

321 *
¥
 = 
g_utc
;

324 
i
=0; i<
CACHE_COUNT
; i++) {

325 ià(
g_ÿcheNames
[
i
] && 0 =ğ
	`¡rcmp
(
Çme
, g_cacheNames[i])) {

326 *
¥
 = 
g_ÿcheS‹s
[
i
];

332 
g_Ï¡Cache
++;

333 ià(
g_Ï¡Cache
 >ğ
CACHE_COUNT
) {

334 
g_Ï¡Cache
 = 0;

336 
i
 = 
g_Ï¡Cache
;

337 ià(
g_ÿcheNames
[
i
]) {

338 
	`ä“
(
g_ÿcheNames
[
i
]);

340 
”r
 = 
	`tzlßd_unÿched
(
Çme
, &(
g_ÿcheS‹s
[
i
]), 1);

341 ià(
”r
 == 0) {

342 
g_ÿcheNames
[
i
] = 
	`¡rdup
(
Çme
);

343 *
¥
 = 
g_ÿcheS‹s
[
i
];

346 
g_ÿcheNames
[
i
] = 
NULL
;

347  
”r
;

350  
	`tzlßd_unÿched
(
Çme
, 
¥
, 
dÛx‹nd
);

351 
	}
}

354 
	$tzlßd_unÿched
(
Çme
, 
¥
, 
dÛx‹nd
)

355 cÚ¡ * 
Çme
;

356 
¡©e
 * cÚ¡ 
¥
;

357 cÚ¡ 
dÛx‹nd
;

359 cÚ¡ * 
p
;

360 
i
;

361 
fid
;

362 
¡Üed
;

363 
Ä—d
;

365 
tzh—d
zhead;

366 
buf
[2 * (
tzh—d
) +

367 2 *  *
¥
 +

368 4 * 
TZ_MAX_TIMES
];

369 } 
u
;

370 
tÜ—d
 =  
u
.
buf
;

372 ià(
Çme
 =ğ
NULL
 && (Çmğ
TZDEFAULT
) == NULL)

375 
dßcûss
;

383 
fuÎÇme
[
FILENAME_MAX
 + 1];

384 cÚ¡ *
ÜigÇme
 = 
Çme
;

386 ià(
Çme
[0] == ':')

387 ++
Çme
;

388 
dßcûss
 = 
Çme
[0] == '/';

389 ià(!
dßcûss
) {

390 ià((
p
 = 
TZDIR
è=ğ
NULL
)

392 ià((
	`¡¾’
(
p
è+ sŒËn(
Çme
è+ 1è>ğ 
fuÎÇme
)

394 (è
	`¡rıy
(
fuÎÇme
, 
p
);

395 (è
	`¡rÿt
(
fuÎÇme
, "/");

396 (è
	`¡rÿt
(
fuÎÇme
, 
Çme
);

400 ià(
	`¡rchr
(
Çme
, '.'è!ğ
NULL
)

401 
dßcûss
 = 
TRUE
;

402 
Çme
 = 
fuÎÇme
;

404 ià(
dßcûss
 && 
	`acûss
(
Çme
, 
R_OK
) != 0)

406 ià((
fid
 = 
	`İ’
(
Çme
, 
OPEN_MODE
)) == -1) {

407 
buf
[
READLEN
];

408 
Çme
[
NAMELEN
 + 1];

409 
fidix
 = 
	`İ’
(
INDEXFILE
, 
OPEN_MODE
);

410 
off
 = -1;

412 ià(
fidix
 < 0) {

416 
	`»ad
(
fidix
, 
buf
, (buf)) == (buf)) {

417 
	`memıy
(
Çme
, 
buf
, 
NAMELEN
);

418 
Çme
[
NAMELEN
] = '\0';

420 ià(
	`¡rcmp
(
Çme
, 
ÜigÇme
) == 0) {

421 
off
 = 
	`tošt
((*è
buf
 + 
NAMELEN
);

422 
tÜ—d
 = 
	`tošt
((*è
buf
 + 
NAMELEN
 + 
INTLEN
);

427 
	`şo£
(
fidix
);

429 ià(
off
 < 0)

432 
fid
 = 
	`İ’
(
DATAFILE
, 
OPEN_MODE
);

434 ià(
fid
 < 0) {

438 ià(
	`l£ek
(
fid
, 
off
, 
SEEK_SET
) < 0) {

443 
Ä—d
 = 
	`»ad
(
fid
, 
u
.
buf
, 
tÜ—d
);

444 ià(
	`şo£
(
fid
è< 0 || 
Ä—d
 <= 0)

446 
¡Üed
 = 4; stored <= 8; stored *= 2) {

447 
‰is¡dút
;

448 
‰isgmtút
;

450 
‰is¡dút
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_‰is¡dút
);

451 
‰isgmtút
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_‰isgmtút
);

452 
¥
->
Ë­út
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_Ë­út
);

453 
¥
->
timeút
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_timeút
);

454 
¥
->
ty³út
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_ty³út
);

455 
¥
->
ch¬út
 = (è
	`d‘zcode
(
u
.
tzh—d
.
tzh_ch¬út
);

456 
p
 = 
u
.
tzh—d
.
tzh_ch¬út
 +  u.tzhead.tzh_charcnt;

457 ià(
¥
->
Ë­út
 < 0 || sp->Ë­úˆ> 
TZ_MAX_LEAPS
 ||

458 
¥
->
ty³út
 <ğ0 || sp->ty³úˆ> 
TZ_MAX_TYPES
 ||

459 
¥
->
timeút
 < 0 || sp->timeúˆ> 
TZ_MAX_TIMES
 ||

460 
¥
->
ch¬út
 < 0 || sp->ch¬úˆ> 
TZ_MAX_CHARS
 ||

461 (
‰is¡dút
 !ğ
¥
->
ty³út
 &&tisstdcnt != 0) ||

462 (
‰isgmtút
 !ğ
¥
->
ty³út
 &&tisgmtcnt != 0))

464 ià(
Ä—d
 - (
p
 - 
u
.
buf
) <

465 
¥
->
timeút
 * 
¡Üed
 +

466 
¥
->
timeút
 +

467 
¥
->
ty³út
 * 6 +

468 
¥
->
ch¬út
 +

469 
¥
->
Ë­út
 * (
¡Üed
 + 4) +

470 
‰is¡dút
 +

471 
‰isgmtút
)

473 
i
 = 0; i < 
¥
->
timeút
; ++i) {

474 
¥
->
©s
[
i
] = (
¡Üed
 == 4) ?

475 
	`d‘zcode
(
p
è: 
	`d‘zcode64
(p);

476 
p
 +ğ
¡Üed
;

478 
i
 = 0; i < 
¥
->
timeút
; ++i) {

479 
¥
->
ty³s
[
i
] = (è*
p
++;

480 ià(
¥
->
ty³s
[
i
] >ğ¥->
ty³út
)

483 
i
 = 0; i < 
¥
->
ty³út
; ++i) {

484 
‰šfo
 * 
‰i¥
;

486 
‰i¥
 = &
¥
->
‰is
[
i
];

487 
‰i¥
->
‰_gmtoff
 = 
	`d‘zcode
(
p
);

488 
p
 += 4;

489 
‰i¥
->
‰_isd¡
 = (è*
p
++;

490 ià(
‰i¥
->
‰_isd¡
 != 0 &&tisp->tt_isdst != 1)

492 
‰i¥
->
‰_abbršd
 = (è*
p
++;

493 ià(
‰i¥
->
‰_abbršd
 < 0 ||

494 
‰i¥
->
‰_abbršd
 > 
¥
->
ch¬út
)

497 
i
 = 0; i < 
¥
->
ch¬út
; ++i)

498 
¥
->
ch¬s
[
i
] = *
p
++;

499 
¥
->
ch¬s
[
i
] = '\0';

500 
i
 = 0; i < 
¥
->
Ë­út
; ++i) {

501 
lsšfo
 * 
lsi¥
;

503 
lsi¥
 = &
¥
->
lsis
[
i
];

504 
lsi¥
->
ls_Œªs
 = (
¡Üed
 == 4) ?

505 
	`d‘zcode
(
p
è: 
	`d‘zcode64
(p);

506 
p
 +ğ
¡Üed
;

507 
lsi¥
->
ls_cÜr
 = 
	`d‘zcode
(
p
);

508 
p
 += 4;

510 
i
 = 0; i < 
¥
->
ty³út
; ++i) {

511 
‰šfo
 * 
‰i¥
;

513 
‰i¥
 = &
¥
->
‰is
[
i
];

514 ià(
‰is¡dút
 == 0)

515 
‰i¥
->
‰_‰is¡d
 = 
FALSE
;

517 
‰i¥
->
‰_‰is¡d
 = *
p
++;

518 ià(
‰i¥
->
‰_‰is¡d
 !ğ
TRUE
 &&

519 
‰i¥
->
‰_‰is¡d
 !ğ
FALSE
)

523 
i
 = 0; i < 
¥
->
ty³út
; ++i) {

524 
‰šfo
 * 
‰i¥
;

526 
‰i¥
 = &
¥
->
‰is
[
i
];

527 ià(
‰isgmtút
 == 0)

528 
‰i¥
->
‰_‰isgmt
 = 
FALSE
;

530 
‰i¥
->
‰_‰isgmt
 = *
p
++;

531 ià(
‰i¥
->
‰_‰isgmt
 !ğ
TRUE
 &&

532 
‰i¥
->
‰_‰isgmt
 !ğ
FALSE
)

541 
i
 = 0; i < 
¥
->
timeút
 - 2; ++i)

542 ià(
¥
->
©s
[
i
] > sp->ats[i + 1]) {

543 ++
i
;

544 ià(
	`TYPE_SIGNED
(
time_t
)) {

548 
¥
->
timeút
 = 
i
;

553 
j
;

555 
j
 = 0; j + 
i
 < 
¥
->
timeút
; ++j) {

556 
¥
->
©s
[
j
] = sp->©s[j + 
i
];

557 
¥
->
ty³s
[
j
] = sp->ty³s[j + 
i
];

559 
¥
->
timeút
 = 
j
;

566 ià(
u
.
tzh—d
.
tzh_v”siÚ
[0] == '\0')

568 
Ä—d
 -ğ
p
 - 
u
.
buf
;

569 
i
 = 0; i < 
Ä—d
; ++i)

570 
u
.
buf
[
i
] = 
p
[i];

574 ià(
¡Üed
 >ğ(è(
time_t
è&& 
	`TYPE_INTEGRAL
(time_t))

577 ià(
dÛx‹nd
 && 
Ä—d
 > 2 &&

578 
u
.
buf
[0] =ğ'\n' && u.buf[
Ä—d
 - 1] == '\n' &&

579 
¥
->
ty³út
 + 2 <ğ
TZ_MAX_TYPES
) {

580 
¡©e
 
ts
;

581 
»suÉ
;

583 
u
.
buf
[
Ä—d
 - 1] = '\0';

584 
»suÉ
 = 
	`tz·r£
(&
u
.
buf
[1], &
ts
, 
FALSE
);

585 ià(
»suÉ
 =ğ0 && 
ts
.
ty³út
 == 2 &&

586 
¥
->
ch¬út
 + 
ts
.ch¬úˆ<ğ
TZ_MAX_CHARS
) {

587 
i
 = 0; i < 2; ++i)

588 
ts
.
‰is
[
i
].
‰_abbršd
 +=

589 
¥
->
ch¬út
;

590 
i
 = 0; i < 
ts
.
ch¬út
; ++i)

591 
¥
->
ch¬s
[¥->
ch¬út
++] =

592 
ts
.
ch¬s
[
i
];

593 
i
 = 0;

594 
i
 < 
ts
.
timeút
 &&

595 
ts
.
©s
[
i
] <=

596 
¥
->
©s
[¥->
timeút
 - 1])

597 ++
i
;

598 
i
 < 
ts
.
timeút
 &&

599 
¥
->
timeút
 < 
TZ_MAX_TIMES
) {

600 
¥
->
©s
[¥->
timeút
] =

601 
ts
.
©s
[
i
];

602 
¥
->
ty³s
[¥->
timeút
] =

603 
¥
->
ty³út
 +

604 
ts
.
ty³s
[
i
];

605 ++
¥
->
timeút
;

606 ++
i
;

608 
¥
->
‰is
[¥->
ty³út
++] = 
ts
.ttis[0];

609 
¥
->
‰is
[¥->
ty³út
++] = 
ts
.ttis[1];

612 
i
 = 2 * 
YEARSPERREPEAT
;

613 
¥
->
goback
 = sp->
gßh—d
 = sp->
timeút
 > 
i
;

614 
¥
->
goback
 &ğ¥->
ty³s
[
i
] == sp->types[0] &&

615 
	`difãr_by_»³©
(
¥
->
©s
[
i
], sp->ats[0]);

616 
¥
->
gßh—d
 &=

617 
¥
->
ty³s
[¥->
timeút
 - 1] =ğ¥->ty³s[¥->timeúˆ- 1 - 
i
] &&

618 
	`difãr_by_»³©
(
¥
->
©s
[¥->
timeút
 - 1],

619 
¥
->
©s
[¥->
timeút
 - 1 - 
i
]);

621 
	}
}

623 cÚ¡ 
	gmÚ_Ëngths
[2][
MONSPERYEAR
] = {

628 cÚ¡ 
	gy—r_Ëngths
[2] = {

629 
DAYSPERNYEAR
, 
DAYSPERLYEAR


639 
	$g‘zÇme
(
¡½
)

640 cÚ¡ * 
¡½
;

642 
c
;

644 (
c
 = *
¡½
è!ğ'\0' && !
	`is_dig™
(c) && c != ',' && c != '-' &&

645 
c
 != '+')

646 ++
¡½
;

647  
¡½
;

648 
	}
}

660 
	$g‘qzÇme
(cÚ¡ *
¡½
, cÚ¡ 
d–im
)

662 
c
;

664 (
c
 = *
¡½
è!ğ'\0' && c !ğ
d–im
)

665 ++
¡½
;

666  
¡½
;

667 
	}
}

677 
	$g‘num
(
¡½
, 
nump
, 
mš
, 
max
)

678 cÚ¡ * 
¡½
;

679 * cÚ¡ 
nump
;

680 cÚ¡ 
mš
;

681 cÚ¡ 
max
;

683 
c
;

684 
num
;

686 ià(
¡½
 =ğ
NULL
 || !
	`is_dig™
(
c
 = *strp))

687  
NULL
;

688 
num
 = 0;

690 
num
 =‚um * 10 + (
c
 - '0');

691 ià(
num
 > 
max
)

692  
NULL
;

693 
c
 = *++
¡½
;

694 } 
	`is_dig™
(
c
));

695 ià(
num
 < 
mš
)

696  
NULL
;

697 *
nump
 = 
num
;

698  
¡½
;

699 
	}
}

710 
	$g‘£cs
(
¡½
, 
£c¥
)

711 cÚ¡ * 
¡½
;

712 * cÚ¡ 
£c¥
;

714 
num
;

722 
¡½
 = 
	`g‘num
(¡½, &
num
, 0, 
HOURSPERDAY
 * 
DAYSPERWEEK
 - 1);

723 ià(
¡½
 =ğ
NULL
)

724  
NULL
;

725 *
£c¥
 = 
num
 * (è
SECSPERHOUR
;

726 ià(*
¡½
 == ':') {

727 ++
¡½
;

728 
¡½
 = 
	`g‘num
(¡½, &
num
, 0, 
MINSPERHOUR
 - 1);

729 ià(
¡½
 =ğ
NULL
)

730  
NULL
;

731 *
£c¥
 +ğ
num
 * 
SECSPERMIN
;

732 ià(*
¡½
 == ':') {

733 ++
¡½
;

735 
¡½
 = 
	`g‘num
(¡½, &
num
, 0, 
SECSPERMIN
);

736 ià(
¡½
 =ğ
NULL
)

737  
NULL
;

738 *
£c¥
 +ğ
num
;

741  
¡½
;

742 
	}
}

752 
	$g‘off£t
(
¡½
, 
off£
)

753 cÚ¡ * 
¡½
;

754 * cÚ¡ 
off£
;

756 
Ãg
 = 0;

758 ià(*
¡½
 == '-') {

759 
Ãg
 = 1;

760 ++
¡½
;

761 } ià(*
¡½
 == '+')

762 ++
¡½
;

763 
¡½
 = 
	`g‘£cs
(¡½, 
off£
);

764 ià(
¡½
 =ğ
NULL
)

765  
NULL
;

766 ià(
Ãg
)

767 *
off£
 = -*offsetp;

768  
¡½
;

769 
	}
}

779 
	$g‘ruË
(
¡½
, 
ruËp
)

780 cÚ¡ * 
¡½
;

781 
ruË
 * cÚ¡ 
ruËp
;

783 ià(*
¡½
 == 'J') {

787 
ruËp
->
r_ty³
 = 
JULIAN_DAY
;

788 ++
¡½
;

789 
¡½
 = 
	`g‘num
(¡½, &
ruËp
->
r_day
, 1, 
DAYSPERNYEAR
);

790 } ià(*
¡½
 == 'M') {

794 
ruËp
->
r_ty³
 = 
MONTH_NTH_DAY_OF_WEEK
;

795 ++
¡½
;

796 
¡½
 = 
	`g‘num
(¡½, &
ruËp
->
r_mÚ
, 1, 
MONSPERYEAR
);

797 ià(
¡½
 =ğ
NULL
)

798  
NULL
;

799 ià(*
¡½
++ != '.')

800  
NULL
;

801 
¡½
 = 
	`g‘num
(¡½, &
ruËp
->
r_w“k
, 1, 5);

802 ià(
¡½
 =ğ
NULL
)

803  
NULL
;

804 ià(*
¡½
++ != '.')

805  
NULL
;

806 
¡½
 = 
	`g‘num
(¡½, &
ruËp
->
r_day
, 0, 
DAYSPERWEEK
 - 1);

807 } ià(
	`is_dig™
(*
¡½
)) {

811 
ruËp
->
r_ty³
 = 
DAY_OF_YEAR
;

812 
¡½
 = 
	`g‘num
(¡½, &
ruËp
->
r_day
, 0, 
DAYSPERLYEAR
 - 1);

813 }  
NULL
;

814 ià(
¡½
 =ğ
NULL
)

815  
NULL
;

816 ià(*
¡½
 == '/') {

820 ++
¡½
;

821 
¡½
 = 
	`g‘£cs
(¡½, &
ruËp
->
r_time
);

822 } 
ruËp
->
r_time
 = 2 * 
SECSPERHOUR
;

823  
¡½
;

824 
	}
}

832 
time_t


833 
	$Œª¡ime
(
jªfœ¡
, 
y—r
, 
ruËp
, 
off£t
)

834 cÚ¡ 
time_t
 
jªfœ¡
;

835 cÚ¡ 
y—r
;

836 cÚ¡ 
ruË
 * cÚ¡ 
ruËp
;

837 cÚ¡ 
off£t
;

839 
Ë­y—r
;

840 
time_t
 
v®ue
;

841 
i
;

842 
d
, 
m1
, 
yy0
, 
yy1
, 
yy2
, 
dow
;

844 
	`INITIALIZE
(
v®ue
);

845 
Ë­y—r
 = 
	`i¦—p
(
y—r
);

846 
ruËp
->
r_ty³
) {

848 
JULIAN_DAY
:

856 
v®ue
 = 
jªfœ¡
 + (
ruËp
->
r_day
 - 1è* 
SECSPERDAY
;

857 ià(
Ë­y—r
 && 
ruËp
->
r_day
 >= 60)

858 
v®ue
 +ğ
SECSPERDAY
;

861 
DAY_OF_YEAR
:

867 
v®ue
 = 
jªfœ¡
 + 
ruËp
->
r_day
 * 
SECSPERDAY
;

870 
MONTH_NTH_DAY_OF_WEEK
:

874 
v®ue
 = 
jªfœ¡
;

875 
i
 = 0; i < 
ruËp
->
r_mÚ
 - 1; ++i)

876 
v®ue
 +ğ
mÚ_Ëngths
[
Ë­y—r
][
i
] * 
SECSPERDAY
;

882 
m1
 = (
ruËp
->
r_mÚ
 + 9) % 12 + 1;

883 
yy0
 = (
ruËp
->
r_mÚ
 <ğ2è? (
y—r
 - 1) : year;

884 
yy1
 = 
yy0
 / 100;

885 
yy2
 = 
yy0
 % 100;

886 
dow
 = ((26 * 
m1
 - 2) / 10 +

887 1 + 
yy2
 + yy2 / 4 + 
yy1
 / 4 - 2 * yy1) % 7;

888 ià(
dow
 < 0)

889 
dow
 +ğ
DAYSPERWEEK
;

896 
d
 = 
ruËp
->
r_day
 - 
dow
;

897 ià(
d
 < 0)

898 
d
 +ğ
DAYSPERWEEK
;

899 
i
 = 1; i < 
ruËp
->
r_w“k
; ++i) {

900 ià(
d
 + 
DAYSPERWEEK
 >=

901 
mÚ_Ëngths
[
Ë­y—r
][
ruËp
->
r_mÚ
 - 1])

903 
d
 +ğ
DAYSPERWEEK
;

909 
v®ue
 +ğ
d
 * 
SECSPERDAY
;

919  
v®ue
 + 
ruËp
->
r_time
 + 
off£t
;

920 
	}
}

928 
	$tz·r£
(
Çme
, 
¥
, 
Ï¡d™ch
)

929 cÚ¡ * 
Çme
;

930 
¡©e
 * cÚ¡ 
¥
;

931 cÚ¡ 
Ï¡d™ch
;

933 cÚ¡ * 
¡dÇme
;

934 cÚ¡ * 
d¡Çme
;

935 
size_t
 
¡dËn
;

936 
size_t
 
d¡Ën
;

937 
¡doff£t
;

938 
d¡off£t
;

939 
time_t
 * 
©p
;

940 * 
ty³p
;

941 * 
ı
;

942 
lßd_»suÉ
;

944 
	`INITIALIZE
(
d¡Çme
);

945 
¡dÇme
 = 
Çme
;

946 ià(
Ï¡d™ch
) {

947 
¡dËn
 = 
	`¡¾’
(
Çme
);

948 
Çme
 +ğ
¡dËn
;

949 ià(
¡dËn
 >ğ 
¥
->
ch¬s
)

950 
¡dËn
 = ( 
¥
->
ch¬s
) - 1;

951 
¡doff£t
 = 0;

953 ià(*
Çme
 == '<') {

954 
Çme
++;

955 
¡dÇme
 = 
Çme
;

956 
Çme
 = 
	`g‘qzÇme
(name, '>');

957 ià(*
Çme
 != '>')

959 
¡dËn
 = 
Çme
 - 
¡dÇme
;

960 
Çme
++;

962 
Çme
 = 
	`g‘zÇme
(name);

963 
¡dËn
 = 
Çme
 - 
¡dÇme
;

965 ià(*
Çme
 == '\0')

967 
Çme
 = 
	`g‘off£t
Òame, &
¡doff£t
);

968 ià(
Çme
 =ğ
NULL
)

971 
lßd_»suÉ
 = 
	`tzlßd
(
TZDEFRULES
, 
¥
, 
FALSE
);

972 ià(
lßd_»suÉ
 != 0)

973 
¥
->
Ë­út
 = 0;

974 
¥
->
timeút
 = 0;

975 ià(*
Çme
 != '\0') {

976 ià(*
Çme
 == '<') {

977 
d¡Çme
 = ++
Çme
;

978 
Çme
 = 
	`g‘qzÇme
(name, '>');

979 ià(*
Çme
 != '>')

981 
d¡Ën
 = 
Çme
 - 
d¡Çme
;

982 
Çme
++;

984 
d¡Çme
 = 
Çme
;

985 
Çme
 = 
	`g‘zÇme
(name);

986 
d¡Ën
 = 
Çme
 - 
d¡Çme
;

988 ià(*
Çme
 != '\0' && *name != ',' && *name != ';') {

989 
Çme
 = 
	`g‘off£t
Òame, &
d¡off£t
);

990 ià(
Çme
 =ğ
NULL
)

992 } 
d¡off£t
 = 
¡doff£t
 - 
SECSPERHOUR
;

993 ià(*
Çme
 =ğ'\0' && 
lßd_»suÉ
 != 0)

994 
Çme
 = 
TZDEFRULESTRING
;

995 ià(*
Çme
 == ',' || *name == ';') {

996 
ruË
 
¡¬t
;

997 
ruË
 
’d
;

998 
y—r
;

999 
time_t
 
jªfœ¡
;

1000 
time_t
 
¡¬‰ime
;

1001 
time_t
 
’dtime
;

1003 ++
Çme
;

1004 ià((
Çme
 = 
	`g‘ruË
Òame, &
¡¬t
)è=ğ
NULL
)

1006 ià(*
Çme
++ != ',')

1008 ià((
Çme
 = 
	`g‘ruË
Òame, &
’d
)è=ğ
NULL
)

1010 ià(*
Çme
 != '\0')

1012 
¥
->
ty³út
 = 2;

1016 
¥
->
‰is
[0].
‰_gmtoff
 = -
d¡off£t
;

1017 
¥
->
‰is
[0].
‰_isd¡
 = 1;

1018 
¥
->
‰is
[0].
‰_abbršd
 = 
¡dËn
 + 1;

1019 
¥
->
‰is
[1].
‰_gmtoff
 = -
¡doff£t
;

1020 
¥
->
‰is
[1].
‰_isd¡
 = 0;

1021 
¥
->
‰is
[1].
‰_abbršd
 = 0;

1022 
©p
 = 
¥
->
©s
;

1023 
ty³p
 = 
¥
->
ty³s
;

1024 
jªfœ¡
 = 0;

1025 
y—r
 = 
EPOCH_YEAR
;

1026 
¥
->
timeút
 + 2 <ğ
TZ_MAX_TIMES
;

1027 ++
y—r
) {

1028 
time_t
 
Ãwfœ¡
;

1030 
¡¬‰ime
 = 
	`Œª¡ime
(
jªfœ¡
, 
y—r
, &
¡¬t
,

1031 
¡doff£t
);

1032 
’dtime
 = 
	`Œª¡ime
(
jªfœ¡
, 
y—r
, &
’d
,

1033 
d¡off£t
);

1034 ià(
¡¬‰ime
 > 
’dtime
) {

1035 *
©p
++ = 
’dtime
;

1036 *
ty³p
++ = 1;

1037 *
©p
++ = 
¡¬‰ime
;

1038 *
ty³p
++ = 0;

1040 *
©p
++ = 
¡¬‰ime
;

1041 *
ty³p
++ = 0;

1042 *
©p
++ = 
’dtime
;

1043 *
ty³p
++ = 1;

1045 
¥
->
timeút
 += 2;

1046 
Ãwfœ¡
 = 
jªfœ¡
;

1047 
Ãwfœ¡
 +ğ
y—r_Ëngths
[
	`i¦—p
(
y—r
)] *

1048 
SECSPERDAY
;

1049 ià(
Ãwfœ¡
 <ğ
jªfœ¡
)

1051 
jªfœ¡
 = 
Ãwfœ¡
;

1054 
theœ¡doff£t
;

1055 
theœd¡off£t
;

1056 
theœoff£t
;

1057 
isd¡
;

1058 
i
;

1059 
j
;

1061 ià(*
Çme
 != '\0')

1066 
theœ¡doff£t
 = 0;

1067 
i
 = 0; i < 
¥
->
timeút
; ++i) {

1068 
j
 = 
¥
->
ty³s
[
i
];

1069 ià(!
¥
->
‰is
[
j
].
‰_isd¡
) {

1070 
theœ¡doff£t
 =

1071 -
¥
->
‰is
[
j
].
‰_gmtoff
;

1075 
theœd¡off£t
 = 0;

1076 
i
 = 0; i < 
¥
->
timeút
; ++i) {

1077 
j
 = 
¥
->
ty³s
[
i
];

1078 ià(
¥
->
‰is
[
j
].
‰_isd¡
) {

1079 
theœd¡off£t
 =

1080 -
¥
->
‰is
[
j
].
‰_gmtoff
;

1087 
isd¡
 = 
FALSE
;

1088 
theœoff£t
 = 
theœ¡doff£t
;

1093 
i
 = 0; i < 
¥
->
timeút
; ++i) {

1094 
j
 = 
¥
->
ty³s
[
i
];

1095 
¥
->
ty³s
[
i
] = sp->
‰is
[
j
].
‰_isd¡
;

1096 ià(
¥
->
‰is
[
j
].
‰_‰isgmt
) {

1113 ià(
isd¡
 && !
¥
->
‰is
[
j
].
‰_‰is¡d
) {

1114 
¥
->
©s
[
i
] +ğ
d¡off£t
 -

1115 
theœd¡off£t
;

1117 
¥
->
©s
[
i
] +ğ
¡doff£t
 -

1118 
theœ¡doff£t
;

1121 
theœoff£t
 = -
¥
->
‰is
[
j
].
‰_gmtoff
;

1122 ià(
¥
->
‰is
[
j
].
‰_isd¡
)

1123 
theœd¡off£t
 = 
theœoff£t
;

1124 
theœ¡doff£t
 = 
theœoff£t
;

1130 
¥
->
‰is
[0].
‰_gmtoff
 = -
¡doff£t
;

1131 
¥
->
‰is
[0].
‰_isd¡
 = 
FALSE
;

1132 
¥
->
‰is
[0].
‰_abbršd
 = 0;

1133 
¥
->
‰is
[1].
‰_gmtoff
 = -
d¡off£t
;

1134 
¥
->
‰is
[1].
‰_isd¡
 = 
TRUE
;

1135 
¥
->
‰is
[1].
‰_abbršd
 = 
¡dËn
 + 1;

1136 
¥
->
ty³út
 = 2;

1139 
d¡Ën
 = 0;

1140 
¥
->
ty³út
 = 1;

1141 
¥
->
timeút
 = 0;

1142 
¥
->
‰is
[0].
‰_gmtoff
 = -
¡doff£t
;

1143 
¥
->
‰is
[0].
‰_isd¡
 = 0;

1144 
¥
->
‰is
[0].
‰_abbršd
 = 0;

1146 
¥
->
ch¬út
 = 
¡dËn
 + 1;

1147 ià(
d¡Ën
 != 0)

1148 
¥
->
ch¬út
 +ğ
d¡Ën
 + 1;

1149 ià((
size_t
è
¥
->
ch¬út
 >  sp->
ch¬s
)

1151 
ı
 = 
¥
->
ch¬s
;

1152 (è
	`¡ºıy
(
ı
, 
¡dÇme
, 
¡dËn
);

1153 
ı
 +ğ
¡dËn
;

1154 *
ı
++ = '\0';

1155 ià(
d¡Ën
 != 0) {

1156 (è
	`¡ºıy
(
ı
, 
d¡Çme
, 
d¡Ën
);

1157 *(
ı
 + 
d¡Ën
) = '\0';

1160 
	}
}

1163 
	$gmßd
(
¥
)

1164 
¡©e
 * cÚ¡ 
¥
;

1166 ià(
	`tzlßd
(
gmt
, 
¥
, 
TRUE
) != 0)

1167 (è
	`tz·r£
(
gmt
, 
¥
, 
TRUE
);

1168 
	}
}

1180 
tm
 *

1181 
	$loÿlsub
(
tim•
, 
off£t
, 
tmp
, 
¥
)

1182 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1183 cÚ¡ 
off£t
;

1184 
tm
 * cÚ¡ 
tmp
;

1185 cÚ¡ 
¡©e
 * 
¥
;

1187 cÚ¡ 
‰šfo
 * 
‰i¥
;

1188 
i
;

1189 
tm
 * 
»suÉ
;

1190 cÚ¡ 
time_t
 
t
 = *
tim•
;

1192 #ifdeà
ALL_STATE


1193 ià(
¥
 =ğ
NULL
)

1194  
	`gmtsub
(
tim•
, 
off£t
, 
tmp
);

1196 ià((
¥
->
goback
 && 
t
 < sp->
©s
[0]) ||

1197 (
¥
->
gßh—d
 && 
t
 > sp->
©s
[¥->
timeút
 - 1])) {

1198 
time_t
 
Ãwt
 = 
t
;

1199 
time_t
 
£cÚds
;

1200 
time_t
 
tcyşes
;

1201 
št_ç¡64_t
 
icyşes
;

1203 ià(
t
 < 
¥
->
©s
[0])

1204 
£cÚds
 = 
¥
->
©s
[0] - 
t
;

1205 
£cÚds
 = 
t
 - 
¥
->
©s
[¥->
timeút
 - 1];

1206 --
£cÚds
;

1207 
tcyşes
 = 
£cÚds
 / 
YEARSPERREPEAT
 / 
AVGSECSPERYEAR
;

1208 ++
tcyşes
;

1209 
icyşes
 = 
tcyşes
;

1210 ià(
tcyşes
 - 
icyşes
 >= 1 || icycles -cycles >= 1)

1211  
NULL
;

1212 
£cÚds
 = 
icyşes
;

1213 
£cÚds
 *ğ
YEARSPERREPEAT
;

1214 
£cÚds
 *ğ
AVGSECSPERYEAR
;

1215 ià(
t
 < 
¥
->
©s
[0])

1216 
Ãwt
 +ğ
£cÚds
;

1217 
Ãwt
 -ğ
£cÚds
;

1218 ià(
Ãwt
 < 
¥
->
©s
[0] ||

1219 
Ãwt
 > 
¥
->
©s
[¥->
timeút
 - 1])

1220  
NULL
;

1221 
»suÉ
 = 
	`loÿlsub
(&
Ãwt
, 
off£t
, 
tmp
, 
¥
);

1222 ià(
»suÉ
 =ğ
tmp
) {

1223 
time_t
 
Ãwy
;

1225 
Ãwy
 = 
tmp
->
tm_y—r
;

1226 ià(
t
 < 
¥
->
©s
[0])

1227 
Ãwy
 -ğ
icyşes
 * 
YEARSPERREPEAT
;

1228 
Ãwy
 +ğ
icyşes
 * 
YEARSPERREPEAT
;

1229 
tmp
->
tm_y—r
 = 
Ãwy
;

1230 ià(
tmp
->
tm_y—r
 !ğ
Ãwy
)

1231  
NULL
;

1233  
»suÉ
;

1235 ià(
¥
->
timeút
 =ğ0 || 
t
 < sp->
©s
[0]) {

1236 
i
 = 0;

1237 
¥
->
‰is
[
i
].
‰_isd¡
)

1238 ià(++
i
 >ğ
¥
->
ty³út
) {

1239 
i
 = 0;

1243 
lo
 = 1;

1244 
hi
 = 
¥
->
timeút
;

1246 
lo
 < 
hi
) {

1247 
mid
 = (
lo
 + 
hi
) >> 1;

1249 ià(
t
 < 
¥
->
©s
[
mid
])

1250 
hi
 = 
mid
;

1251 
lo
 = 
mid
 + 1;

1253 
i
 = (è
¥
->
ty³s
[
lo
 - 1];

1255 
‰i¥
 = &
¥
->
‰is
[
i
];

1262 
»suÉ
 = 
	`timesub
(&
t
, 
‰i¥
->
‰_gmtoff
, 
¥
, 
tmp
);

1263 
tmp
->
tm_isd¡
 = 
‰i¥
->
‰_isd¡
;

1264 #ifdeà
HAVE_TM_GMTOFF


1265 
tmp
->
tm_gmtoff
 = 
‰i¥
->
‰_gmtoff
;

1267 
tzÇme
[
tmp
->
tm_isd¡
] = &
¥
->
ch¬s
[
‰i¥
->
‰_abbršd
];

1268 #ifdeà
TM_ZONE


1269 
tmp
->
TM_ZONE
 = &
¥
->
ch¬s
[
‰i¥
->
‰_abbršd
];

1271  
»suÉ
;

1272 
	}
}

1277 
tm
 *

1278 
	$loÿÉime
(
tim•
)

1279 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1281 
	`tz£t
();

1282  
	`loÿlsub
(
tim•
, 0L, &
tm
);

1283 
	}
}

1292 
	$loÿÉime_tz
(cÚ¡ 
time_t
 * cÚ¡ 
tim•
, 
tm
 * 
tmp
, cÚ¡ * 
tz
)

1294 
¡©e
 
¡
;

1295 ià(
	`tzlßd
(
tz
, &
¡
, 
TRUE
) != 0) {

1297 
	`gmßd
(&
¡
);

1300 
	`loÿlsub
(
tim•
, 0L, 
tmp
, &
¡
);

1301 
	}
}

1307 
tm
 *

1308 
	$gmtsub
(
tim•
, 
off£t
, 
tmp
)

1309 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1310 cÚ¡ 
off£t
;

1311 
tm
 * cÚ¡ 
tmp
;

1313 
tm
 * 
»suÉ
;

1315 ià(!
gmt_is_£t
) {

1316 
gmt_is_£t
 = 
TRUE
;

1317 #ifdeà
ALL_STATE


1318 
gmŒ
 = (
¡©e
 *è
	`m®loc
( *gmtptr);

1319 ià(
gmŒ
 !ğ
NULL
)

1321 
	`gmßd
(
gmŒ
);

1323 
»suÉ
 = 
	`timesub
(
tim•
, 
off£t
, 
gmŒ
, 
tmp
);

1324 #ifdeà
TM_ZONE


1330 ià(
off£t
 != 0)

1331 
tmp
->
TM_ZONE
 = 
wdabbr
;

1333 #ifdeà
ALL_STATE


1334 ià(
gmŒ
 =ğ
NULL
)

1335 
tmp
->
TM_ZONE
 = 
gmt
;

1336 
tmp
->
TM_ZONE
 = 
gmŒ
->
ch¬s
;

1338 #iâdeà
ALL_STATE


1339 
tmp
->
TM_ZONE
 = 
gmŒ
->
ch¬s
;

1343  
»suÉ
;

1344 
	}
}

1348 
tm
 *

1349 
	$gmtime
(
tim•
)

1350 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1352  
	`gmtsub
(
tim•
, 0L, &
tm
);

1353 
	}
}

1362 
tm
 *

1363 
	$gmtime_r
(
tim•
, 
tmp
)

1364 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1365 
tm
 * 
tmp
;

1367  
	`gmtsub
(
tim•
, 0L, 
tmp
);

1368 
	}
}

1371 #ifdeà
STD_INSPIRED


1375 
tm
 *

1376 
	$ofáime
(
tim•
, 
off£t
)

1377 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1378 cÚ¡ 
off£t
;

1380  
	`gmtsub
(
tim•
, 
off£t
, &
tm
);

1381 
	}
}

1392 
	$Ë­s_thru_’d_of
(
y
)

1393 cÚ¡ 
y
;

1395  (
y
 >= 0) ? (y / 4 - y / 100 + y / 400) :

1396 -(
	`Ë­s_thru_’d_of
(-(
y
 + 1)) + 1);

1397 
	}
}

1399 
tm
 *

1400 
	$timesub
(
tim•
, 
off£t
, 
¥
, 
tmp
)

1401 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1402 cÚ¡ 
off£t
;

1403 cÚ¡ 
¡©e
 * cÚ¡ 
¥
;

1404 
tm
 * cÚ¡ 
tmp
;

1406 cÚ¡ 
lsšfo
 * 
Í
;

1407 
time_t
 
tdays
;

1408 
idays
;

1409 
»m
;

1410 
y
;

1411 cÚ¡ * 

;

1412 
cÜr
;

1413 
h™
;

1414 
i
;

1416 
cÜr
 = 0;

1417 
h™
 = 0;

1418 #ifdeà
ALL_STATE


1419 
i
 = (
¥
 =ğ
NULL
è? 0 : sp->
Ë­út
;

1421 #iâdeà
ALL_STATE


1422 
i
 = 
¥
->
Ë­út
;

1424 --
i
 >= 0) {

1425 
Í
 = &
¥
->
lsis
[
i
];

1426 ià(*
tim•
 >ğ
Í
->
ls_Œªs
) {

1427 ià(*
tim•
 =ğ
Í
->
ls_Œªs
) {

1428 
h™
 = ((
i
 =ğ0 && 
Í
->
ls_cÜr
 > 0) ||

1429 
Í
->
ls_cÜr
 > 
¥
->
lsis
[
i
 - 1].ls_corr);

1430 ià(
h™
)

1431 
i
 > 0 &&

1432 
¥
->
lsis
[
i
].
ls_Œªs
 ==

1433 
¥
->
lsis
[
i
 - 1].
ls_Œªs
 + 1 &&

1434 
¥
->
lsis
[
i
].
ls_cÜr
 ==

1435 
¥
->
lsis
[
i
 - 1].
ls_cÜr
 + 1) {

1436 ++
h™
;

1437 --
i
;

1440 
cÜr
 = 
Í
->
ls_cÜr
;

1444 
y
 = 
EPOCH_YEAR
;

1445 
tdays
 = *
tim•
 / 
SECSPERDAY
;

1446 
»m
 = *
tim•
 - 
tdays
 * 
SECSPERDAY
;

1447 
tdays
 < 0 ||day >ğ
y—r_Ëngths
[
	`i¦—p
(
y
)]) {

1448 
Ãwy
;

1449 
time_t
 
td–
;

1450 
id–
;

1451 
Ë­days
;

1453 
td–
 = 
tdays
 / 
DAYSPERLYEAR
;

1454 
id–
 = 
td–
;

1455 ià(
td–
 - 
id–
 >= 1 || idelta -delta >= 1)

1456  
NULL
;

1457 ià(
id–
 == 0)

1458 
id–
 = (
tdays
 < 0) ? -1 : 1;

1459 
Ãwy
 = 
y
;

1460 ià(
	`šüem’t_ov”æow
(&
Ãwy
, 
id–
))

1461  
NULL
;

1462 
Ë­days
 = 
	`Ë­s_thru_’d_of
(
Ãwy
 - 1) -

1463 
	`Ë­s_thru_’d_of
(
y
 - 1);

1464 
tdays
 -ğ((
time_t
è
Ãwy
 - 
y
è* 
DAYSPERNYEAR
;

1465 
tdays
 -ğ
Ë­days
;

1466 
y
 = 
Ãwy
;

1469 
£cÚds
;

1471 
£cÚds
 = 
tdays
 * 
SECSPERDAY
 + 0.5;

1472 
tdays
 = 
£cÚds
 / 
SECSPERDAY
;

1473 
»m
 +ğ
£cÚds
 - 
tdays
 * 
SECSPERDAY
;

1478 
idays
 = 
tdays
;

1479 
»m
 +ğ
off£t
 - 
cÜr
;

1480 
»m
 < 0) {

1481 
»m
 +ğ
SECSPERDAY
;

1482 --
idays
;

1484 
»m
 >ğ
SECSPERDAY
) {

1485 
»m
 -ğ
SECSPERDAY
;

1486 ++
idays
;

1488 
idays
 < 0) {

1489 ià(
	`šüem’t_ov”æow
(&
y
, -1))

1490  
NULL
;

1491 
idays
 +ğ
y—r_Ëngths
[
	`i¦—p
(
y
)];

1493 
idays
 >ğ
y—r_Ëngths
[
	`i¦—p
(
y
)]) {

1494 
idays
 -ğ
y—r_Ëngths
[
	`i¦—p
(
y
)];

1495 ià(
	`šüem’t_ov”æow
(&
y
, 1))

1496  
NULL
;

1498 
tmp
->
tm_y—r
 = 
y
;

1499 ià(
	`šüem’t_ov”æow
(&
tmp
->
tm_y—r
, -
TM_YEAR_BASE
))

1500  
NULL
;

1501 
tmp
->
tm_yday
 = 
idays
;

1505 
tmp
->
tm_wday
 = 
EPOCH_WDAY
 +

1506 ((
y
 - 
EPOCH_YEAR
è% 
DAYSPERWEEK
) *

1507 (
DAYSPERNYEAR
 % 
DAYSPERWEEK
) +

1508 
	`Ë­s_thru_’d_of
(
y
 - 1) -

1509 
	`Ë­s_thru_’d_of
(
EPOCH_YEAR
 - 1) +

1510 
idays
;

1511 
tmp
->
tm_wday
 %ğ
DAYSPERWEEK
;

1512 ià(
tmp
->
tm_wday
 < 0)

1513 
tmp
->
tm_wday
 +ğ
DAYSPERWEEK
;

1514 
tmp
->
tm_hour
 = (è(
»m
 / 
SECSPERHOUR
);

1515 
»m
 %ğ
SECSPERHOUR
;

1516 
tmp
->
tm_mš
 = (è(
»m
 / 
SECSPERMIN
);

1521 
tmp
->
tm_£c
 = (è(
»m
 % 
SECSPERMIN
è+ 
h™
;

1522 

 = 
mÚ_Ëngths
[
	`i¦—p
(
y
)];

1523 
tmp
->
tm_mÚ
 = 0; 
idays
 >ğ

[tmp->tm_mon]; ++(tmp->tm_mon))

1524 
idays
 -ğ

[
tmp
->
tm_mÚ
];

1525 
tmp
->
tm_mday
 = (è(
idays
 + 1);

1526 
tmp
->
tm_isd¡
 = 0;

1527 #ifdeà
TM_GMTOFF


1528 
tmp
->
TM_GMTOFF
 = 
off£t
;

1530  
tmp
;

1531 
	}
}

1536 
	$ùime
(
tim•
)

1537 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1545  
	`asùime
(
	`loÿÉime
(
tim•
));

1546 
	}
}

1552 
	$ùime_r
(
tim•
, 
buf
)

1553 cÚ¡ 
time_t
 * cÚ¡ 
tim•
;

1554 * 
buf
;

1556 
tm
 
mytm
;

1558  
	`asùime_r
(
	`loÿÉime_r
(
tim•
, &
mytm
), 
buf
);

1559 
	}
}

1571 #iâdeà
WRONG


1572 
	#WRONG
 (-1)

	)

1580 
	$šüem’t_ov”æow
(
numb”
, 
d–
)

1581 * 
numb”
;

1582 
d–
;

1584 
numb”0
 = ()*
numb”
;

1585 
numb”1
 = ()(
numb”0
 + 
d–
);

1587 *
numb”
 = ()
numb”1
;

1589 ià(
d–
 >= 0) {

1590  (()
numb”1
 < ()
numb”0
);

1592  (()
numb”1
 > ()
numb”0
);

1594 
	}
}

1597 
	$lÚg_šüem’t_ov”æow
(
numb”
, 
d–
)

1598 * 
numb”
;

1599 
d–
;

1601 
numb”0
 = ()*
numb”
;

1602 
numb”1
 = ()(
numb”0
 + 
d–
);

1604 *
numb”
 = ()
numb”1
;

1606 ià(
d–
 >= 0) {

1607  (()
numb”1
 < ()
numb”0
);

1609  (()
numb”1
 > ()
numb”0
);

1611 
	}
}

1614 
	$nÜm®ize_ov”æow
(
‹n¥Œ
, 
un™¥Œ
, 
ba£
)

1615 * cÚ¡ 
‹n¥Œ
;

1616 * cÚ¡ 
un™¥Œ
;

1617 cÚ¡ 
ba£
;

1619 
‹nsd–
;

1621 
‹nsd–
 = (*
un™¥Œ
 >= 0) ?

1622 (*
un™¥Œ
 / 
ba£
) :

1623 (-1 - (-1 - *
un™¥Œ
è/ 
ba£
);

1624 *
un™¥Œ
 -ğ
‹nsd–
 * 
ba£
;

1625  
	`šüem’t_ov”æow
(
‹n¥Œ
, 
‹nsd–
);

1626 
	}
}

1629 
	$lÚg_nÜm®ize_ov”æow
(
‹n¥Œ
, 
un™¥Œ
, 
ba£
)

1630 * cÚ¡ 
‹n¥Œ
;

1631 * cÚ¡ 
un™¥Œ
;

1632 cÚ¡ 
ba£
;

1634 
‹nsd–
;

1636 
‹nsd–
 = (*
un™¥Œ
 >= 0) ?

1637 (*
un™¥Œ
 / 
ba£
) :

1638 (-1 - (-1 - *
un™¥Œ
è/ 
ba£
);

1639 *
un™¥Œ
 -ğ
‹nsd–
 * 
ba£
;

1640  
	`lÚg_šüem’t_ov”æow
(
‹n¥Œ
, 
‹nsd–
);

1641 
	}
}

1644 
	$tmcomp
(
©mp
, 
btmp
)

1645 cÚ¡ 
tm
 * cÚ¡ 
©mp
;

1646 cÚ¡ 
tm
 * cÚ¡ 
btmp
;

1648 
»suÉ
;

1650 ià((
»suÉ
 = (
©mp
->
tm_y—r
 - 
btmp
->tm_year)) == 0 &&

1651 (
»suÉ
 = (
©mp
->
tm_mÚ
 - 
btmp
->tm_mon)) == 0 &&

1652 (
»suÉ
 = (
©mp
->
tm_mday
 - 
btmp
->tm_mday)) == 0 &&

1653 (
»suÉ
 = (
©mp
->
tm_hour
 - 
btmp
->tm_hour)) == 0 &&

1654 (
»suÉ
 = (
©mp
->
tm_mš
 - 
btmp
->tm_min)) == 0)

1655 
»suÉ
 = 
©mp
->
tm_£c
 - 
btmp
->tm_sec;

1656  
»suÉ
;

1657 
	}
}

1659 
time_t


1660 
	$time2sub
(
tmp
, 
funı
, 
off£t
, 
okayp
, 
do_nÜm_£cs
, 
¥
)

1661 
tm
 * cÚ¡ 
tmp
;

1662 
tm
 * (* cÚ¡ 
funı
è
	`P
((cÚ¡ 
time_t
*, , tm*,cÚ¡ 
¡©e
 *
¥
));

1663 cÚ¡ 
off£t
;

1664 * cÚ¡ 
okayp
;

1665 cÚ¡ 
do_nÜm_£cs
;

1666 cÚ¡ 
¡©e
 * 
¥
;

1668 
dœ
;

1669 
i
, 
j
;

1670 
§ved_£cÚds
;

1671 
li
;

1672 
time_t
 
lo
;

1673 
time_t
 
hi
;

1674 
y
;

1675 
time_t
 
Ãwt
;

1676 
time_t
 
t
;

1677 
tm
 
you¹m
, 
mytm
;

1679 *
okayp
 = 
FALSE
;

1680 
you¹m
 = *
tmp
;

1681 ià(
do_nÜm_£cs
) {

1682 ià(
	`nÜm®ize_ov”æow
(&
you¹m
.
tm_mš
, &you¹m.
tm_£c
,

1683 
SECSPERMIN
))

1684  
WRONG
;

1686 ià(
	`nÜm®ize_ov”æow
(&
you¹m
.
tm_hour
, &you¹m.
tm_mš
, 
MINSPERHOUR
))

1687  
WRONG
;

1688 ià(
	`nÜm®ize_ov”æow
(&
you¹m
.
tm_mday
, &you¹m.
tm_hour
, 
HOURSPERDAY
))

1689  
WRONG
;

1690 
y
 = 
you¹m
.
tm_y—r
;

1691 ià(
	`lÚg_nÜm®ize_ov”æow
(&
y
, &
you¹m
.
tm_mÚ
, 
MONSPERYEAR
))

1692  
WRONG
;

1697 ià(
	`lÚg_šüem’t_ov”æow
(&
y
, 
TM_YEAR_BASE
))

1698  
WRONG
;

1699 
you¹m
.
tm_mday
 <= 0) {

1700 ià(
	`lÚg_šüem’t_ov”æow
(&
y
, -1))

1701  
WRONG
;

1702 
li
 = 
y
 + (1 < 
you¹m
.
tm_mÚ
);

1703 
you¹m
.
tm_mday
 +ğ
y—r_Ëngths
[
	`i¦—p
(
li
)];

1705 
you¹m
.
tm_mday
 > 
DAYSPERLYEAR
) {

1706 
li
 = 
y
 + (1 < 
you¹m
.
tm_mÚ
);

1707 
you¹m
.
tm_mday
 -ğ
y—r_Ëngths
[
	`i¦—p
(
li
)];

1708 ià(
	`lÚg_šüem’t_ov”æow
(&
y
, 1))

1709  
WRONG
;

1712 
i
 = 
mÚ_Ëngths
[
	`i¦—p
(
y
)][
you¹m
.
tm_mÚ
];

1713 ià(
you¹m
.
tm_mday
 <ğ
i
)

1715 
you¹m
.
tm_mday
 -ğ
i
;

1716 ià(++
you¹m
.
tm_mÚ
 >ğ
MONSPERYEAR
) {

1717 
you¹m
.
tm_mÚ
 = 0;

1718 ià(
	`lÚg_šüem’t_ov”æow
(&
y
, 1))

1719  
WRONG
;

1722 ià(
	`lÚg_šüem’t_ov”æow
(&
y
, -
TM_YEAR_BASE
))

1723  
WRONG
;

1724 
you¹m
.
tm_y—r
 = 
y
;

1725 ià(
you¹m
.
tm_y—r
 !ğ
y
)

1726  
WRONG
;

1727 ià(
you¹m
.
tm_£c
 >ğ0 && you¹m.tm_£ø< 
SECSPERMIN
)

1728 
§ved_£cÚds
 = 0;

1729 ià(
y
 + 
TM_YEAR_BASE
 < 
EPOCH_YEAR
) {

1738 ià(
	`šüem’t_ov”æow
(&
you¹m
.
tm_£c
, 1 - 
SECSPERMIN
))

1739  
WRONG
;

1740 
§ved_£cÚds
 = 
you¹m
.
tm_£c
;

1741 
you¹m
.
tm_£c
 = 
SECSPERMIN
 - 1;

1743 
§ved_£cÚds
 = 
you¹m
.
tm_£c
;

1744 
you¹m
.
tm_£c
 = 0;

1749 ià(!
	`TYPE_SIGNED
(
time_t
)) {

1750 
lo
 = 0;

1751 
hi
 = 
lo
 - 1;

1752 } ià(!
	`TYPE_INTEGRAL
(
time_t
)) {

1753 ià((
time_t
) > ())

1754 
hi
 = (
time_t
è
DBL_MAX
;

1755 
hi
 = (
time_t
è
FLT_MAX
;

1756 
lo
 = -
hi
;

1758 
lo
 = 1;

1759 
i
 = 0; i < (è
	`TYPE_BIT
(
time_t
) - 1; ++i)

1760 
lo
 *= 2;

1761 
hi
 = -(
lo
 + 1);

1764 
t
 = 
lo
 / 2 + 
hi
 / 2;

1765 ià(
t
 < 
lo
)

1766 
t
 = 
lo
;

1767 ià(
t
 > 
hi
)

1768 
t
 = 
hi
;

1769 ià((*
funı
)(&
t
, 
off£t
, &
mytm
, 
¥
è=ğ
NULL
) {

1775 
dœ
 = (
t
 > 0) ? 1 : -1;

1776 } 
dœ
 = 
	`tmcomp
(&
mytm
, &
you¹m
);

1777 ià(
dœ
 != 0) {

1778 ià(
t
 =ğ
lo
) {

1779 ià(
t
 =ğ
TIME_T_MAX
)

1780  
WRONG
;

1781 ++
t
;

1782 ++
lo
;

1783 } ià(
t
 =ğ
hi
) {

1784 ià(
t
 =ğ
TIME_T_MIN
)

1785  
WRONG
;

1786 --
t
;

1787 --
hi
;

1789 ià(
lo
 > 
hi
)

1790  
WRONG
;

1791 ià(
dœ
 > 0)

1792 
hi
 = 
t
;

1793 
lo
 = 
t
;

1796 ià(
you¹m
.
tm_isd¡
 < 0 || 
mytm
.tm_isdst == yourtm.tm_isdst)

1807 #ifdeà
ALL_STATE


1808 ià(
¥
 =ğ
NULL
)

1809  
WRONG
;

1811 
i
 = 
¥
->
ty³út
 - 1; i >= 0; --i) {

1812 ià(
¥
->
‰is
[
i
].
‰_isd¡
 !ğ
you¹m
.
tm_isd¡
)

1814 
j
 = 
¥
->
ty³út
 - 1; j >= 0; --j) {

1815 ià(
¥
->
‰is
[
j
].
‰_isd¡
 =ğ
you¹m
.
tm_isd¡
)

1817 
Ãwt
 = 
t
 + 
¥
->
‰is
[
j
].
‰_gmtoff
 -

1818 
¥
->
‰is
[
i
].
‰_gmtoff
;

1819 ià((*
funı
)(&
Ãwt
, 
off£t
, &
mytm
, 
¥
è=ğ
NULL
)

1821 ià(
	`tmcomp
(&
mytm
, &
you¹m
) != 0)

1823 ià(
mytm
.
tm_isd¡
 !ğ
you¹m
.tm_isdst)

1828 
t
 = 
Ãwt
;

1829 
Ïb–
;

1832  
WRONG
;

1834 
Ïb–
:

1835 
Ãwt
 = 
t
 + 
§ved_£cÚds
;

1836 ià((
Ãwt
 < 
t
è!ğ(
§ved_£cÚds
 < 0))

1837  
WRONG
;

1838 
t
 = 
Ãwt
;

1839 ià((*
funı
)(&
t
, 
off£t
, 
tmp
, 
¥
))

1840 *
okayp
 = 
TRUE
;

1841  
t
;

1842 
	}
}

1844 
time_t


1845 
	$time2
(
tmp
, 
funı
, 
off£t
, 
okayp
, 
¥
)

1846 
tm
 * cÚ¡ 
tmp
;

1847 
tm
 * (* cÚ¡ 
funı
è
	`P
((cÚ¡ 
time_t
*, , tm*,

1848 cÚ¡ 
¡©e
* 
¥
));

1849 cÚ¡ 
off£t
;

1850 * cÚ¡ 
okayp
;

1851 cÚ¡ 
¡©e
 * 
¥
;

1853 
time_t
 
t
;

1860 
t
 = 
	`time2sub
(
tmp
, 
funı
, 
off£t
, 
okayp
, 
FALSE
, 
¥
);

1861  *
okayp
 ? 
t
 : 
	`time2sub
(
tmp
, 
funı
, 
off£t
, okayp, 
TRUE
, 
¥
);

1862 
	}
}

1864 
time_t


1865 
	$time1
(
tmp
, 
funı
, 
off£t
, 
¥
)

1866 
tm
 * cÚ¡ 
tmp
;

1867 
tm
 * (* cÚ¡ 
funı
è
	`P
((cÚ¡ 
time_t
 *, , tm *, cÚ¡ 
¡©e
* 
¥
));

1868 cÚ¡ 
off£t
;

1869 cÚ¡ 
¡©e
 * 
¥
;

1871 
time_t
 
t
;

1872 
§mei
, 
Ùh”i
;

1873 
§mešd
, 
Ùh”šd
;

1874 
i
;

1875 
n£’
;

1876 
£’
[
TZ_MAX_TYPES
];

1877 
ty³s
[
TZ_MAX_TYPES
];

1878 
okay
;

1880 ià(
tmp
->
tm_isd¡
 > 1)

1881 
tmp
->
tm_isd¡
 = 1;

1882 
t
 = 
	`time2
(
tmp
, 
funı
, 
off£t
, &
okay
, 
¥
);

1883 
	#PCTS
 1

	)

1884 #ifdeà
PCTS


1888 ià(
okay
)

1889  
t
;

1890 ià(
tmp
->
tm_isd¡
 < 0)

1891 
tmp
->
tm_isd¡
 = 0;

1893 #iâdeà
PCTS


1894 ià(
okay
 || 
tmp
->
tm_isd¡
 < 0)

1895  
t
;

1906 #ifdeà
ALL_STATE


1907 ià(
¥
 =ğ
NULL
)

1908  
WRONG
;

1910 
i
 = 0; i < 
¥
->
ty³út
; ++i)

1911 
£’
[
i
] = 
FALSE
;

1912 
n£’
 = 0;

1913 
i
 = 
¥
->
timeút
 - 1; i >= 0; --i)

1914 ià(!
£’
[
¥
->
ty³s
[
i
]]) {

1915 
£’
[
¥
->
ty³s
[
i
]] = 
TRUE
;

1916 
ty³s
[
n£’
++] = 
¥
->ty³s[
i
];

1918 
§mešd
 = 0; samešd < 
n£’
; ++sameind) {

1919 
§mei
 = 
ty³s
[
§mešd
];

1920 ià(
¥
->
‰is
[
§mei
].
‰_isd¡
 !ğ
tmp
->
tm_isd¡
)

1922 
Ùh”šd
 = 0; oth”šd < 
n£’
; ++otherind) {

1923 
Ùh”i
 = 
ty³s
[
Ùh”šd
];

1924 ià(
¥
->
‰is
[
Ùh”i
].
‰_isd¡
 =ğ
tmp
->
tm_isd¡
)

1926 
tmp
->
tm_£c
 +ğ
¥
->
‰is
[
Ùh”i
].
‰_gmtoff
 -

1927 
¥
->
‰is
[
§mei
].
‰_gmtoff
;

1928 
tmp
->
tm_isd¡
 = !tmp->tm_isdst;

1929 
t
 = 
	`time2
(
tmp
, 
funı
, 
off£t
, &
okay
, 
¥
);

1930 ià(
okay
)

1931  
t
;

1932 
tmp
->
tm_£c
 -ğ
¥
->
‰is
[
Ùh”i
].
‰_gmtoff
 -

1933 
¥
->
‰is
[
§mei
].
‰_gmtoff
;

1934 
tmp
->
tm_isd¡
 = !tmp->tm_isdst;

1937  
WRONG
;

1938 
	}
}

1941 
time_t


1942 
	$mktime_tz
(
tm
 * cÚ¡ 
tmp
, cÚ¡ * 
tz
)

1944 
¡©e
 
¡
;

1945 ià(
	`tzlßd
(
tz
, &
¡
, 
TRUE
) != 0) {

1947 
	`gmßd
(&
¡
);

1949  
	`time1
(
tmp
, 
loÿlsub
, 0L, &
¡
);

1950 
	}
}

	@libs/libcutils/uevent.c

17 
	~<cuts/uev’t.h
>

19 
	~<”ºo.h
>

20 
	~<¡dboŞ.h
>

21 
	~<¡ršg.h
>

22 
	~<¡ršgs.h
>

23 
	~<sys/sock‘.h
>

24 
	~<sys/un.h
>

25 
	~<uni¡d.h
>

27 
	~<lšux/Ãšk.h
>

32 
ssize_t
 
	$uev’t_k”Ãl_muÉiÿ¡_»cv
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
)

34 
uid_t
 
u£r
 = -1;

35  
	`uev’t_k”Ãl_muÉiÿ¡_uid_»cv
(
sock‘
, 
bufãr
, 
Ëngth
, &
u£r
);

36 
	}
}

47 
ssize_t
 
	$uev’t_k”Ãl_muÉiÿ¡_uid_»cv
(
sock‘
, *
bufãr
,

48 
size_t
 
Ëngth
, 
uid_t
 *
u£r
)

50 
iovec
 
iov
 = { 
bufãr
, 
Ëngth
 };

51 
sockaddr_Æ
 
addr
;

52 
cÚŒŞ
[
	`CMSG_SPACE
((
uüed
))];

53 
msghdr
 
hdr
 = {

54 &
addr
,

55 (
addr
),

56 &
iov
,

58 
cÚŒŞ
,

59 (
cÚŒŞ
),

63 *
u£r
 = -1;

64 
ssize_t
 
n
 = 
	`»cvmsg
(
sock‘
, &
hdr
, 0);

65 ià(
n
 <= 0) {

66  
n
;

69 
cmsghdr
 *
cmsg
 = 
	`CMSG_FIRSTHDR
(&
hdr
);

70 ià(
cmsg
 =ğ
NULL
 || cmsg->
cmsg_ty³
 !ğ
SCM_CREDENTIALS
) {

72 
out
;

75 
uüed
 *
üed
 = (uüed *)
	`CMSG_DATA
(
cmsg
);

76 *
u£r
 = 
üed
->
uid
;

77 ià(
üed
->
uid
 != 0) {

79 
out
;

82 ià(
addr
.
Æ_groups
 =ğ0 ||‡ddr.
Æ_pid
 != 0) {

84 
out
;

87  
n
;

89 
out
:

91 
	`bz”o
(
bufãr
, 
Ëngth
);

92 
”ºo
 = 
EIO
;

94 
	}
}

96 
	$uev’t_İ’_sock‘
(
buf_sz
, 
boŞ
 
·ssüed
)

98 
sockaddr_Æ
 
addr
;

99 
Ú
 = 
·ssüed
;

100 
s
;

102 
	`mem£t
(&
addr
, 0, (addr));

103 
addr
.
Æ_çmy
 = 
AF_NETLINK
;

104 
addr
.
Æ_pid
 = 
	`g‘pid
();

105 
addr
.
Æ_groups
 = 0xffffffff;

107 
s
 = 
	`sock‘
(
PF_NETLINK
, 
SOCK_DGRAM
, 
NETLINK_KOBJECT_UEVENT
);

108 if(
s
 < 0)

111 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_RCVBUFFORCE
, &
buf_sz
, (buf_sz));

112 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_PASSCRED
, &
Ú
, (on));

114 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

115 
	`şo£
(
s
);

119  
s
;

120 
	}
}

	@libs/libcutils/uio.c

17 #iâdeà
HAVE_SYS_UIO_H


19 
	~<cuts/uio.h
>

20 
	~<uni¡d.h
>

22 
	$»adv
Ğ
fd
, 
iovec
* 
vecs
, 
couÁ
 )

24 
tÙ®
 = 0;

26  ; 
couÁ
 > 0; couÁ--, 
vecs
++ ) {

27 cÚ¡ * 
buf
 = 
vecs
->
iov_ba£
;

28 
Ën
 = 
vecs
->
iov_Ën
;

30 
Ën
 > 0) {

31 
»t
 = 
	`»ad
Ğ
fd
, 
buf
, 
Ën
 );

32 ià(
»t
 < 0) {

33 ià(
tÙ®
 == 0)

34 
tÙ®
 = -1;

35 
Ex™
;

37 ià(
»t
 == 0)

38 
Ex™
;

40 
tÙ®
 +ğ
»t
;

41 
buf
 +ğ
»t
;

42 
Ën
 -ğ
»t
;

45 
Ex™
:

46  
tÙ®
;

47 
	}
}

49 
	$wr™ev
Ğ
fd
, cÚ¡ 
iovec
* 
vecs
, 
couÁ
 )

51 
tÙ®
 = 0;

53  ; 
couÁ
 > 0; couÁ--, 
vecs
++ ) {

54 cÚ¡ * 
buf
 = (cÚ¡ *)
vecs
->
iov_ba£
;

55 
Ën
 = ()
vecs
->
iov_Ën
;

57 
Ën
 > 0) {

58 
»t
 = 
	`wr™e
Ğ
fd
, 
buf
, 
Ën
 );

59 ià(
»t
 < 0) {

60 ià(
tÙ®
 == 0)

61 
tÙ®
 = -1;

62 
Ex™
;

64 ià(
»t
 == 0)

65 
Ex™
;

67 
tÙ®
 +ğ
»t
;

68 
buf
 +ğ
»t
;

69 
Ën
 -ğ
»t
;

72 
Ex™
:

73  
tÙ®
;

74 
	}
}

	@libs/libcutils/zygote.c

17 
	#LOG_TAG
 "ZygÙe"

	)

19 
	~<cuts/sock‘s.h
>

20 
	~<cuts/zygÙe.h
>

21 
	~<cuts/log.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

25 
	~<”ºo.h
>

26 
	~<time.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dlib.h
>

29 
	~<uni¡d.h
>

30 
	~<¬·/š‘.h
>

31 
	~<sys/ty³s.h
>

32 
	~<sys/sock‘.h
>

34 
	#ZYGOTE_SOCKET
 "zygÙe"

	)

36 
	#ZYGOTE_RETRY_COUNT
 1000

	)

37 
	#ZYGOTE_RETRY_MILLIS
 500

	)

39 
»¶aû_Æ
(*
¡r
);

45 
	$£nd_»que¡
(
fd
, 
£ndStdio
, 
¬gc
, cÚ¡ **
¬gv
)

47 #iâdeà
HAVE_ANDROID_OS


52 
ušt32_t
 
pid
;

53 
i
;

54 
iovec
 
ivs
[2];

55 
msghdr
 
msg
;

56 
¬gc_bufãr
[12];

57 cÚ¡ *
Ãwlše_¡ršg
 = "\n";

58 
cmsghdr
 *
cmsg
;

59 
msgbuf
[
	`CMSG_SPACE
(() * 3)];

60 *
cmsg_·ylßd
;

61 
ssize_t
 
»t
;

63 
	`mem£t
(&
msg
, 0, (msg));

64 
	`mem£t
(&
ivs
, 0, (ivs));

67 
	`¢´štf
(
¬gc_bufãr
, ×rgc_bufãr), "%d\n", 
¬gc
);

69 
ivs
[0].
iov_ba£
 = 
¬gc_bufãr
;

70 
ivs
[0].
iov_Ën
 = 
	`¡¾’
(
¬gc_bufãr
);

72 
msg
.
msg_iov
 = 
ivs
;

73 
msg
.
msg_iovËn
 = 1;

75 ià(
£ndStdio
 != 0) {

77 
msg
.
msg_cÚŒŞ
 = 
msgbuf
;

78 
msg
.
msg_cÚŒŞËn
 =  
msgbuf
;

80 
cmsg
 = 
	`CMSG_FIRSTHDR
(&
msg
);

82 
cmsg
->
cmsg_Ën
 = 
	`CMSG_LEN
(3 * ());

83 
cmsg
->
cmsg_Ëv–
 = 
SOL_SOCKET
;

84 
cmsg
->
cmsg_ty³
 = 
SCM_RIGHTS
;

86 
cmsg_·ylßd
 = (*)
	`CMSG_DATA
(
cmsg
);

87 
cmsg_·ylßd
[0] = 
STDIN_FILENO
;

88 
cmsg_·ylßd
[1] = 
STDOUT_FILENO
;

89 
cmsg_·ylßd
[2] = 
STDERR_FILENO
;

93 
»t
 = 
	`£ndmsg
(
fd
, &
msg
, 
MSG_NOSIGNAL
);

94 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

96 ià(
»t
 < 0) {

101 
msg
.
msg_cÚŒŞ
 = 
NULL
;

102 
msg
.
msg_cÚŒŞËn
 = 0;

105 
i
 = 0; i < 
¬gc
; i++) {

106 *
toä“
 = 
NULL
;

107 cÚ¡ *
tİršt
;

109 
tİršt
 = 
¬gv
[
i
];

111 ià(
	`¡rchr
(
tİršt
, '\n'è!ğ
NULL
) {

112 
toä“
 = 
	`¡rdup
(
tİršt
);

113 
tİršt
 = 
toä“
;

114 
	`»¶aû_Æ
(
toä“
);

117 
ivs
[0].
iov_ba£
 = (*)
tİršt
;

118 
ivs
[0].
iov_Ën
 = 
	`¡¾’
(
tİršt
);

119 
ivs
[1].
iov_ba£
 = (*)
Ãwlše_¡ršg
;

120 
ivs
[1].
iov_Ën
 = 1;

122 
msg
.
msg_iovËn
 = 2;

125 
»t
 = 
	`£ndmsg
(
fd
, &
msg
, 
MSG_NOSIGNAL
);

126 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

128 ià(
toä“
 !ğ
NULL
) {

129 
	`ä“
(
toä“
);

132 ià(
»t
 < 0) {

139 
ivs
[0].
iov_ba£
 = &
pid
;

140 
ivs
[0].
iov_Ën
 = (
pid
);

141 
msg
.
msg_iovËn
 = 1;

145 
»t
 = 
	`»cvmsg
(
fd
, &
msg
, 
MSG_NOSIGNAL
 | 
MSG_WAITALL
);

146 } 
»t
 < 0 && 
”ºo
 =ğ
EINTR
);

148 ià(
»t
 < 0) {

152 
ivs
[0].
iov_Ën
 -ğ
»t
;

153 
ivs
[0].
iov_ba£
 +ğ
»t
;

154 } 
ivs
[0].
iov_Ën
 > 0);

156 
pid
 = 
	`Áohl
(pid);

158  
pid
;

160 
	}
}

162 
zygÙe_run_wa™
(
¬gc
, cÚ¡ **
¬gv
, (*
po¡_run_func
)())

164 
fd
;

165 
pid
;

166 
”r
;

167 cÚ¡ *
Ãw¬gv
[
¬gc
 + 1];

169 
fd
 = 
	`sock‘_loÿl_ş›Á
(
ZYGOTE_SOCKET
,

170 
ANDROID_SOCKET_NAMESPACE_RESERVED
, 
AF_LOCAL
);

172 ià(
fd
 < 0) {

178 
Ãw¬gv
[0] = "--peer-wait";

179 
	`memıy
(
Ãw¬gv
 + 1, 
¬gv
, 
¬gc
 * (*argv));

181 
pid
 = 
	`£nd_»que¡
(
fd
, 1, 
¬gc
 + 1, 
Ãw¬gv
);

183 ià(
pid
 > 0 && 
po¡_run_func
 !ğ
NULL
) {

184 
	`po¡_run_func
(
pid
);

189 
dummy
;

190 
”r
 = 
	`»ad
(
fd
, &
dummy
, (dummy));

191 } (
”r
 < 0 && 
”ºo
 =ğ
EINTR
) ||ƒrr != 0);

194 
”r
 = 
	`şo£
(
fd
);

195 } 
”r
 < 0 && 
”ºo
 =ğ
EINTR
);

198 
	}
}

216 
	$zygÙe_run_ÚeshÙ
(
£ndStdio
, 
¬gc
, cÚ¡ **
¬gv
)

218 
fd
 = -1;

219 
”r
;

220 
i
;

221 
»Œ›s
;

222 
pid
;

223 cÚ¡ **
Ãw¬gv
 = 
¬gv
;

224 cÚ¡ 
Ãw¬gc
 = 
¬gc
;

226 
»Œ›s
 = 0; (
fd
 < 0è&& (»Œ› < 
ZYGOTE_RETRY_COUNT
);„etries++) {

227 ià(
»Œ›s
 > 0) {

228 
time¥ec
 
ts
;

230 
	`mem£t
(&
ts
, 0, (ts));

231 
ts
.
tv_n£c
 = 
ZYGOTE_RETRY_MILLIS
 * 1000 * 1000;

234 
”r
 = 
	`Çno¦“p
 (&
ts
, &ts);

235 } 
”r
 < 0 && 
”ºo
 =ğ
EINTR
);

237 
fd
 = 
	`sock‘_loÿl_ş›Á
(
ZYGOTE_SOCKET
, 
AF_LOCAL
,

238 
ANDROID_SOCKET_NAMESPACE_RESERVED
);

241 ià(
fd
 < 0) {

245 
pid
 = 
	`£nd_»que¡
(
fd
, 0, 
Ãw¬gc
, 
Ãw¬gv
);

248 
”r
 = 
	`şo£
(
fd
);

249 } 
”r
 < 0 && 
”ºo
 =ğ
EINTR
);

251  
pid
;

252 
	}
}

257 
	$»¶aû_Æ
(*
¡r
)

259 ; *
¡r
; str++) {

260 ià(*
¡r
 == '\n') {

261 *
¡r
 = ' ';

264 
	}
}

	@libs/libmincrypt/mincrypt/rsa.h

28 #iâdeà
_EMBEDDED_RSA_H_


29 
	#_EMBEDDED_RSA_H_


	)

31 
	~<š‰y³s.h
>

33 #ifdeà
__ılu¥lus


37 
	#RSANUMBYTES
 256

	)

38 
	#RSANUMWORDS
 (
RSANUMBYTES
 / (
ušt32_t
))

	)

40 
	sRSAPublicKey
 {

41 
Ën
;

42 
ušt32_t
 
n0šv
;

43 
ušt32_t
 
n
[
RSANUMWORDS
];

44 
ušt32_t
 
¼
[
RSANUMWORDS
];

45 
expÚ’t
;

46 } 
	tRSAPublicKey
;

48 
RSA_v”ify
(cÚ¡ 
RSAPublicKey
 *
key
,

49 cÚ¡ 
ušt8_t
* 
sigÇtu»
,

50 cÚ¡ 
Ën
,

51 cÚ¡ 
ušt8_t
* 
sha
);

53 #ifdeà
__ılu¥lus


	@libs/libmincrypt/mincrypt/sha.h

28 #iâdeà
_EMBEDDED_SHA_H_


29 
	#_EMBEDDED_SHA_H_


	)

31 
	~<š‰y³s.h
>

33 #ifdeà
__ılu¥lus


37 
	sSHA_CTX
 {

38 
ušt64_t
 
couÁ
;

39 
ušt32_t
 
¡©e
[5];

40 #ià
defšed
(
HAVE_ENDIAN_H
è&& defšed(
HAVE_LITTLE_ENDIAN
)

42 
ušt8_t
 
b
[64];

43 
ušt32_t
 
w
[16];

44 } 
buf
;

46 
ušt8_t
 
buf
[64];

48 } 
	tSHA_CTX
;

50 
SHA_š™
(
SHA_CTX
* 
ùx
);

51 
SHA_upd©e
(
SHA_CTX
* 
ùx
, cÚ¡ * 
d©a
, 
Ën
);

52 cÚ¡ 
ušt8_t
* 
SHA_fš®
(
SHA_CTX
* 
ùx
);

55 cÚ¡ 
ušt8_t
* 
SHA
(cÚ¡ * 
d©a
, 
Ën
, ušt8_t* 
dige¡
);

57 
	#SHA_DIGEST_SIZE
 20

	)

59 #ifdeà
__ılu¥lus


	@libs/libmincrypt/rsa.c

28 
	~"mšüy±/r§.h
"

30 
RSA_e_f4_v”ify
(cÚ¡ 
RSAPublicKey
* 
key
,

31 cÚ¡ 
ušt8_t
* 
sigÇtu»
,

32 cÚ¡ 
Ën
,

33 cÚ¡ 
ušt8_t
* 
sha
);

35 
RSA_e_3_v”ify
(cÚ¡ 
RSAPublicKey
 *
key
,

36 cÚ¡ 
ušt8_t
 *
sigÇtu»
,

37 cÚ¡ 
Ën
,

38 cÚ¡ 
ušt8_t
 *
sha
);

40 
	$RSA_v”ify
(cÚ¡ 
RSAPublicKey
 *
key
,

41 cÚ¡ 
ušt8_t
 *
sigÇtu»
,

42 cÚ¡ 
Ën
,

43 cÚ¡ 
ušt8_t
 *
sha
) {

44 
key
->
expÚ’t
) {

46  
	`RSA_e_3_v”ify
(
key
, 
sigÇtu»
, 
Ën
, 
sha
);

49  
	`RSA_e_f4_v”ify
(
key
, 
sigÇtu»
, 
Ën
, 
sha
);

54 
	}
}

	@libs/libmincrypt/rsa_e_3.c

28 
	~"mšüy±/r§.h
"

29 
	~"mšüy±/sha.h
"

32 
	$subM
(cÚ¡ 
RSAPublicKey
 *
key
, 
ušt32_t
 *
a
) {

33 
št64_t
 
A
 = 0;

34 
i
;

35 
i
 = 0; i < 
key
->
Ën
; ++i) {

36 
A
 +ğ(
ušt64_t
)
a
[
i
] - 
key
->
n
[i];

37 
a
[
i
] = (
ušt32_t
)
A
;

38 
A
 >>= 32;

40 
	}
}

43 
	$geM
(cÚ¡ 
RSAPublicKey
 *
key
, cÚ¡ 
ušt32_t
 *
a
) {

44 
i
;

45 
i
 = 
key
->
Ën
; i;) {

46 --
i
;

47 ià(
a
[
i
] < 
key
->
n
[i])  0;

48 ià(
a
[
i
] > 
key
->
n
[i])  1;

51 
	}
}

54 
	$mÚtMulAdd
(cÚ¡ 
RSAPublicKey
 *
key
,

55 
ušt32_t
* 
c
,

56 cÚ¡ 
ušt32_t
 
a
,

57 cÚ¡ 
ušt32_t
* 
b
) {

58 
ušt64_t
 
A
 = (ušt64_t)
a
 * 
b
[0] + 
c
[0];

59 
ušt32_t
 
d0
 = (ušt32_t)
A
 * 
key
->
n0šv
;

60 
ušt64_t
 
B
 = (ušt64_t)
d0
 * 
key
->
n
[0] + (
ušt32_t
)
A
;

61 
i
;

63 
i
 = 1; i < 
key
->
Ën
; ++i) {

64 
A
 = (A >> 32è+ (
ušt64_t
)
a
 * 
b
[
i
] + 
c
[i];

65 
B
 = (B >> 32è+ (
ušt64_t
)
d0
 * 
key
->
n
[
i
] + (
ušt32_t
)
A
;

66 
c
[
i
 - 1] = (
ušt32_t
)
B
;

69 
A
 = (A >> 32è+ (
B
 >> 32);

71 
c
[
i
 - 1] = (
ušt32_t
)
A
;

73 ià(
A
 >> 32) {

74 
	`subM
(
key
, 
c
);

76 
	}
}

79 
	$mÚtMul
(cÚ¡ 
RSAPublicKey
 *
key
,

80 
ušt32_t
* 
c
,

81 cÚ¡ 
ušt32_t
* 
a
,

82 cÚ¡ 
ušt32_t
* 
b
) {

83 
i
;

84 
i
 = 0; i < 
key
->
Ën
; ++i) {

85 
c
[
i
] = 0;

87 
i
 = 0; i < 
key
->
Ën
; ++i) {

88 
	`mÚtMulAdd
(
key
, 
c
, 
a
[
i
], 
b
);

90 
	}
}

95 
	$modpow3
(cÚ¡ 
RSAPublicKey
 *
key
,

96 
ušt8_t
* 
šout
) {

97 
ušt32_t
 
a
[
RSANUMWORDS
];

98 
ušt32_t
 
aR
[
RSANUMWORDS
];

99 
ušt32_t
 
¯R
[
RSANUMWORDS
];

100 
ušt32_t
 *
¯a
 = 
aR
;

101 
i
;

104 
i
 = 0; i < 
key
->
Ën
; ++i) {

105 
ušt32_t
 
tmp
 =

106 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 0] << 24) |

107 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 1] << 16) |

108 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 2] << 8) |

109 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 3] << 0);

110 
a
[
i
] = 
tmp
;

113 
	`mÚtMul
(
key
, 
aR
, 
a
, key->
¼
);

114 
	`mÚtMul
(
key
, 
¯R
, 
aR
,‡R);

115 
	`mÚtMul
(
key
, 
¯a
, 
¯R
, 
a
);

118 ià(
	`geM
(
key
, 
¯a
)) {

119 
	`subM
(
key
, 
¯a
);

123 
i
 = 
key
->
Ën
 - 1; i >= 0; --i) {

124 
ušt32_t
 
tmp
 = 
¯a
[
i
];

125 *
šout
++ = 
tmp
 >> 24;

126 *
šout
++ = 
tmp
 >> 16;

127 *
šout
++ = 
tmp
 >> 8;

128 *
šout
++ = 
tmp
 >> 0;

130 
	}
}

137 cÚ¡ 
ušt8_t
 
	g·ddšg
[
RSANUMBYTES
 - 
SHA_DIGEST_SIZE
] = {

162 
	$RSA_e_3_v”ify
(cÚ¡ 
RSAPublicKey
 *
key
,

163 cÚ¡ 
ušt8_t
 *
sigÇtu»
,

164 cÚ¡ 
Ën
,

165 cÚ¡ 
ušt8_t
 *
sha
) {

166 
ušt8_t
 
buf
[
RSANUMBYTES
];

167 
i
;

169 ià(
key
->
Ën
 !ğ
RSANUMWORDS
) {

173 ià(
Ën
 !ğ(
buf
)) {

177 ià(
key
->
expÚ’t
 != 3) {

181 
i
 = 0; i < 
Ën
; ++i) {

182 
buf
[
i
] = 
sigÇtu»
[i];

185 
	`modpow3
(
key
, 
buf
);

188 
i
 = 0; i < (è(
·ddšg
); ++i) {

189 ià(
buf
[
i
] !ğ
·ddšg
[i]) {

195 ; 
i
 < 
Ën
; ++i) {

196 ià(
buf
[
i
] !ğ*
sha
++) {

202 
	}
}

	@libs/libmincrypt/rsa_e_f4.c

28 
	~"mšüy±/r§.h
"

29 
	~"mšüy±/sha.h
"

32 
	$subM
(cÚ¡ 
RSAPublicKey
* 
key
,

33 
ušt32_t
* 
a
) {

34 
št64_t
 
A
 = 0;

35 
i
;

36 
i
 = 0; i < 
key
->
Ën
; ++i) {

37 
A
 +ğ(
ušt64_t
)
a
[
i
] - 
key
->
n
[i];

38 
a
[
i
] = (
ušt32_t
)
A
;

39 
A
 >>= 32;

41 
	}
}

44 
	$geM
(cÚ¡ 
RSAPublicKey
* 
key
,

45 cÚ¡ 
ušt32_t
* 
a
) {

46 
i
;

47 
i
 = 
key
->
Ën
; i;) {

48 --
i
;

49 ià(
a
[
i
] < 
key
->
n
[i])  0;

50 ià(
a
[
i
] > 
key
->
n
[i])  1;

53 
	}
}

56 
	$mÚtMulAdd
(cÚ¡ 
RSAPublicKey
* 
key
,

57 
ušt32_t
* 
c
,

58 cÚ¡ 
ušt32_t
 
a
,

59 cÚ¡ 
ušt32_t
* 
b
) {

60 
ušt64_t
 
A
 = (ušt64_t)
a
 * 
b
[0] + 
c
[0];

61 
ušt32_t
 
d0
 = (ušt32_t)
A
 * 
key
->
n0šv
;

62 
ušt64_t
 
B
 = (ušt64_t)
d0
 * 
key
->
n
[0] + (
ušt32_t
)
A
;

63 
i
;

65 
i
 = 1; i < 
key
->
Ën
; ++i) {

66 
A
 = (A >> 32è+ (
ušt64_t
)
a
 * 
b
[
i
] + 
c
[i];

67 
B
 = (B >> 32è+ (
ušt64_t
)
d0
 * 
key
->
n
[
i
] + (
ušt32_t
)
A
;

68 
c
[
i
 - 1] = (
ušt32_t
)
B
;

71 
A
 = (A >> 32è+ (
B
 >> 32);

73 
c
[
i
 - 1] = (
ušt32_t
)
A
;

75 ià(
A
 >> 32) {

76 
	`subM
(
key
, 
c
);

78 
	}
}

81 
	$mÚtMul
(cÚ¡ 
RSAPublicKey
* 
key
,

82 
ušt32_t
* 
c
,

83 cÚ¡ 
ušt32_t
* 
a
,

84 cÚ¡ 
ušt32_t
* 
b
) {

85 
i
;

86 
i
 = 0; i < 
key
->
Ën
; ++i) {

87 
c
[
i
] = 0;

89 
i
 = 0; i < 
key
->
Ën
; ++i) {

90 
	`mÚtMulAdd
(
key
, 
c
, 
a
[
i
], 
b
);

92 
	}
}

96 
	$modpowF4
(cÚ¡ 
RSAPublicKey
* 
key
,

97 
ušt8_t
* 
šout
) {

98 
ušt32_t
 
a
[
RSANUMWORDS
];

99 
ušt32_t
 
aR
[
RSANUMWORDS
];

100 
ušt32_t
 
¯R
[
RSANUMWORDS
];

101 
ušt32_t
* 
¯a
 = 
¯R
;

102 
i
;

105 
i
 = 0; i < 
key
->
Ën
; ++i) {

106 
ušt32_t
 
tmp
 =

107 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 0] << 24) |

108 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 1] << 16) |

109 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 2] << 8) |

110 (
šout
[((
key
->
Ën
 - 1 - 
i
) * 4) + 3] << 0);

111 
a
[
i
] = 
tmp
;

114 
	`mÚtMul
(
key
, 
aR
, 
a
, key->
¼
);

115 
i
 = 0; i < 16; i += 2) {

116 
	`mÚtMul
(
key
, 
¯R
, 
aR
,‡R);

117 
	`mÚtMul
(
key
, 
aR
, 
¯R
,‡aR);

119 
	`mÚtMul
(
key
, 
¯a
, 
aR
, 
a
);

122 ià(
	`geM
(
key
, 
¯a
)) {

123 
	`subM
(
key
, 
¯a
);

127 
i
 = 
key
->
Ën
 - 1; i >= 0; --i) {

128 
ušt32_t
 
tmp
 = 
¯a
[
i
];

129 *
šout
++ = 
tmp
 >> 24;

130 *
šout
++ = 
tmp
 >> 16;

131 *
šout
++ = 
tmp
 >> 8;

132 *
šout
++ = 
tmp
 >> 0;

134 
	}
}

148 cÚ¡ 
ušt8_t
 
	gkEx³ùedPadShaR§2048
[
SHA_DIGEST_SIZE
] = {

155 
	$RSA_e_f4_v”ify
(cÚ¡ 
RSAPublicKey
* 
key
,

156 cÚ¡ 
ušt8_t
* 
sigÇtu»
,

157 cÚ¡ 
Ën
,

158 cÚ¡ 
ušt8_t
* 
sha
) {

159 
ušt8_t
 
buf
[
RSANUMBYTES
];

160 
i
;

162 ià(
key
->
Ën
 !ğ
RSANUMWORDS
) {

166 ià(
Ën
 !ğ(
buf
)) {

170 ià(
key
->
expÚ’t
 != 65537) {

174 
i
 = 0; i < 
Ën
; ++i) {

175 
buf
[
i
] = 
sigÇtu»
[i];

178 
	`modpowF4
(
key
, 
buf
);

181 
i
 = 
Ën
 - 
SHA_DIGEST_SIZE
; i <†en; ++i) {

182 
buf
[
i
] ^ğ*
sha
++;

186 
	`SHA
(
buf
, 
Ën
, buf);

189 
i
 = 0; i < 
SHA_DIGEST_SIZE
; ++i) {

190 ià(
buf
[
i
] !ğ
kEx³ùedPadShaR§2048
[i]) {

196 
	}
}

	@libs/libmincrypt/sha.c

28 
	~"mšüy±/sha.h
"

33 #ià
defšed
(
HAVE_ENDIAN_H
è&& defšed(
HAVE_LITTLE_ENDIAN
)

35 
	~<by‹sw­.h
>

36 
	~<memÜy.h
>

41 
šlše
 
ušt32_t
 
	$rÜ27
(
ušt32_t
 
v®
) {

42  (
v®
 >> 27) | (val << 5);

43 
	}
}

44 
šlše
 
ušt32_t
 
	$rÜ2
(
ušt32_t
 
v®
) {

45  (
v®
 >> 2) | (val << 30);

46 
	}
}

47 
šlše
 
ušt32_t
 
	$rÜ31
(
ušt32_t
 
v®
) {

48  (
v®
 >> 31) | (val << 1);

49 
	}
}

51 
	$SHA1_T¿nsfÜm
(
SHA_CTX
* 
ùx
) {

52 
ušt32_t
 
W
[80];

53 
ušt32_t
 
A
, 
B
, 
C
, 
D
, 
E
;

54 
t
;

56 
A
 = 
ùx
->
¡©e
[0];

57 
B
 = 
ùx
->
¡©e
[1];

58 
C
 = 
ùx
->
¡©e
[2];

59 
D
 = 
ùx
->
¡©e
[3];

60 
E
 = 
ùx
->
¡©e
[4];

62 
	#SHA_F1
(
A
,
B
,
C
,
D
,
E
,
t
) \

63 
E
 +ğ
	`rÜ27
(
A
) + \

64 (
W
[
t
] = 
	`bsw­_32
(
ùx
->
buf
.
w
[t])) + \

65 (
D
^(
B
&(
C
^D))) + 0x5A827999; \

66 
B
 = 
	`rÜ2
(B);

	)

68 
t
 = 0; < 15; += 5) {

69 
	`SHA_F1
(
A
,
B
,
C
,
D
,
E
,
t
 + 0);

70 
	`SHA_F1
(
E
,
A
,
B
,
C
,
D
,
t
 + 1);

71 
	`SHA_F1
(
D
,
E
,
A
,
B
,
C
,
t
 + 2);

72 
	`SHA_F1
(
C
,
D
,
E
,
A
,
B
,
t
 + 3);

73 
	`SHA_F1
(
B
,
C
,
D
,
E
,
A
,
t
 + 4);

75 
	`SHA_F1
(
A
,
B
,
C
,
D
,
E
,
t
 + 0);

77 #undeà
SHA_F1


79 
	#SHA_F1
(
A
,
B
,
C
,
D
,
E
,
t
) \

80 
E
 +ğ
	`rÜ27
(
A
) + \

81 (
W
[
t
] = 
	`rÜ31
(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16])) + \

82 (
D
^(
B
&(
C
^D))) + 0x5A827999; \

83 
B
 = 
	`rÜ2
(B);

	)

85 
	`SHA_F1
(
E
,
A
,
B
,
C
,
D
,
t
 + 1);

86 
	`SHA_F1
(
D
,
E
,
A
,
B
,
C
,
t
 + 2);

87 
	`SHA_F1
(
C
,
D
,
E
,
A
,
B
,
t
 + 3);

88 
	`SHA_F1
(
B
,
C
,
D
,
E
,
A
,
t
 + 4);

90 #undeà
SHA_F1


92 
	#SHA_F2
(
A
,
B
,
C
,
D
,
E
,
t
) \

93 
E
 +ğ
	`rÜ27
(
A
) + \

94 (
W
[
t
] = 
	`rÜ31
(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16])) + \

95 (
B
^
C
^
D
) + 0x6ED9EBA1; \

96 
B
 = 
	`rÜ2
(B);

	)

98 
t
 = 20; < 40; += 5) {

99 
	`SHA_F2
(
A
,
B
,
C
,
D
,
E
,
t
 + 0);

100 
	`SHA_F2
(
E
,
A
,
B
,
C
,
D
,
t
 + 1);

101 
	`SHA_F2
(
D
,
E
,
A
,
B
,
C
,
t
 + 2);

102 
	`SHA_F2
(
C
,
D
,
E
,
A
,
B
,
t
 + 3);

103 
	`SHA_F2
(
B
,
C
,
D
,
E
,
A
,
t
 + 4);

106 #undeà
SHA_F2


108 
	#SHA_F3
(
A
,
B
,
C
,
D
,
E
,
t
) \

109 
E
 +ğ
	`rÜ27
(
A
) + \

110 (
W
[
t
] = 
	`rÜ31
(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16])) + \

111 ((
B
&
C
)|(
D
&(B|C))) + 0x8F1BBCDC; \

112 
B
 = 
	`rÜ2
(B);

	)

114 ; 
t
 < 60; += 5) {

115 
	`SHA_F3
(
A
,
B
,
C
,
D
,
E
,
t
 + 0);

116 
	`SHA_F3
(
E
,
A
,
B
,
C
,
D
,
t
 + 1);

117 
	`SHA_F3
(
D
,
E
,
A
,
B
,
C
,
t
 + 2);

118 
	`SHA_F3
(
C
,
D
,
E
,
A
,
B
,
t
 + 3);

119 
	`SHA_F3
(
B
,
C
,
D
,
E
,
A
,
t
 + 4);

122 #undeà
SHA_F3


124 
	#SHA_F4
(
A
,
B
,
C
,
D
,
E
,
t
) \

125 
E
 +ğ
	`rÜ27
(
A
) + \

126 (
W
[
t
] = 
	`rÜ31
(W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16])) + \

127 (
B
^
C
^
D
) + 0xCA62C1D6; \

128 
B
 = 
	`rÜ2
(B);

	)

130 ; 
t
 < 80; += 5) {

131 
	`SHA_F4
(
A
,
B
,
C
,
D
,
E
,
t
 + 0);

132 
	`SHA_F4
(
E
,
A
,
B
,
C
,
D
,
t
 + 1);

133 
	`SHA_F4
(
D
,
E
,
A
,
B
,
C
,
t
 + 2);

134 
	`SHA_F4
(
C
,
D
,
E
,
A
,
B
,
t
 + 3);

135 
	`SHA_F4
(
B
,
C
,
D
,
E
,
A
,
t
 + 4);

138 #undeà
SHA_F4


140 
ùx
->
¡©e
[0] +ğ
A
;

141 
ùx
->
¡©e
[1] +ğ
B
;

142 
ùx
->
¡©e
[2] +ğ
C
;

143 
ùx
->
¡©e
[3] +ğ
D
;

144 
ùx
->
¡©e
[4] +ğ
E
;

145 
	}
}

147 
	$SHA_upd©e
(
SHA_CTX
* 
ùx
, cÚ¡ * 
d©a
, 
Ën
) {

148 
i
 = 
ùx
->
couÁ
 % (ùx->
buf
);

149 cÚ¡ 
ušt8_t
* 
p
 = (cÚ¡ ušt8_t*)
d©a
;

151 
ùx
->
couÁ
 +ğ
Ën
;

153 
Ën
 > (
ùx
->
buf
è- 
i
) {

154 
	`memıy
(&
ùx
->
buf
.
b
[
i
], 
p
, (ctx->buf) - i);

155 
Ën
 -ğ(
ùx
->
buf
è- 
i
;

156 
p
 +ğ(
ùx
->
buf
è- 
i
;

157 
	`SHA1_T¿nsfÜm
(
ùx
);

158 
i
 = 0;

161 
Ën
--) {

162 
ùx
->
buf
.
b
[
i
++] = *
p
++;

163 ià(
i
 =ğ(
ùx
->
buf
)) {

164 
	`SHA1_T¿nsfÜm
(
ùx
);

165 
i
 = 0;

168 
	}
}

171 cÚ¡ 
ušt8_t
* 
	$SHA_fš®
(
SHA_CTX
* 
ùx
) {

172 
ušt64_t
 
út
 = 
ùx
->
couÁ
 * 8;

173 
i
;

175 
	`SHA_upd©e
(
ùx
, (
ušt8_t
*)"\x80", 1);

176 (
ùx
->
couÁ
 % (ùx->
buf
)) != ((ctx->buf) - 8)) {

177 
	`SHA_upd©e
(
ùx
, (
ušt8_t
*)"\0", 1);

179 
i
 = 0; i < 8; ++i) {

180 
ušt8_t
 
tmp
 = 
út
 >> ((7 - 
i
) * 8);

181 
	`SHA_upd©e
(
ùx
, &
tmp
, 1);

184 
i
 = 0; i < 5; i++) {

185 
ùx
->
buf
.
w
[
i
] = 
	`bsw­_32
(ùx->
¡©e
[i]);

188  
ùx
->
buf
.
b
;

189 
	}
}

193 
	#rŞ
(
b™s
, 
v®ue
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

195 
	$SHA1_ŒªsfÜm
(
SHA_CTX
 *
ùx
) {

196 
ušt32_t
 
W
[80];

197 
ušt32_t
 
A
, 
B
, 
C
, 
D
, 
E
;

198 
ušt8_t
 *
p
 = 
ùx
->
buf
;

199 
t
;

201 
t
 = 0; < 16; ++t) {

202 
ušt32_t
 
tmp
 = *
p
++ << 24;

203 
tmp
 |ğ*
p
++ << 16;

204 
tmp
 |ğ*
p
++ << 8;

205 
tmp
 |ğ*
p
++;

206 
W
[
t
] = 
tmp
;

209 ; 
t
 < 80;++) {

210 
W
[
t
] = 
	`rŞ
(1,W[t-3] ^ W[t-8] ^ W[t-14] ^ W[t-16]);

213 
A
 = 
ùx
->
¡©e
[0];

214 
B
 = 
ùx
->
¡©e
[1];

215 
C
 = 
ùx
->
¡©e
[2];

216 
D
 = 
ùx
->
¡©e
[3];

217 
E
 = 
ùx
->
¡©e
[4];

219 
t
 = 0; < 80;++) {

220 
ušt32_t
 
tmp
 = 
	`rŞ
(5,
A
è+ 
E
 + 
W
[
t
];

222 ià(
t
 < 20)

223 
tmp
 +ğ(
D
^(
B
&(
C
^D))) + 0x5A827999;

224 iàĞ
t
 < 40)

225 
tmp
 +ğ(
B
^
C
^
D
) + 0x6ED9EBA1;

226 iàĞ
t
 < 60)

227 
tmp
 +ğ((
B
&
C
)|(
D
&(B|C))) + 0x8F1BBCDC;

229 
tmp
 +ğ(
B
^
C
^
D
) + 0xCA62C1D6;

231 
E
 = 
D
;

232 
D
 = 
C
;

233 
C
 = 
	`rŞ
(30,
B
);

234 
B
 = 
A
;

235 
A
 = 
tmp
;

238 
ùx
->
¡©e
[0] +ğ
A
;

239 
ùx
->
¡©e
[1] +ğ
B
;

240 
ùx
->
¡©e
[2] +ğ
C
;

241 
ùx
->
¡©e
[3] +ğ
D
;

242 
ùx
->
¡©e
[4] +ğ
E
;

243 
	}
}

245 
	$SHA_upd©e
(
SHA_CTX
 *
ùx
, cÚ¡ *
d©a
, 
Ën
) {

246 
i
 = 
ùx
->
couÁ
 % (ùx->
buf
);

247 cÚ¡ 
ušt8_t
* 
p
 = (cÚ¡ ušt8_t*)
d©a
;

249 
ùx
->
couÁ
 +ğ
Ën
;

251 
Ën
--) {

252 
ùx
->
buf
[
i
++] = *
p
++;

253 ià(
i
 =ğ(
ùx
->
buf
)) {

254 
	`SHA1_ŒªsfÜm
(
ùx
);

255 
i
 = 0;

258 
	}
}

259 cÚ¡ 
ušt8_t
 *
	$SHA_fš®
(
SHA_CTX
 *
ùx
) {

260 
ušt8_t
 *
p
 = 
ùx
->
buf
;

261 
ušt64_t
 
út
 = 
ùx
->
couÁ
 * 8;

262 
i
;

264 
	`SHA_upd©e
(
ùx
, (
ušt8_t
*)"\x80", 1);

265 (
ùx
->
couÁ
 % (ùx->
buf
)) != ((ctx->buf) - 8)) {

266 
	`SHA_upd©e
(
ùx
, (
ušt8_t
*)"\0", 1);

268 
i
 = 0; i < 8; ++i) {

269 
ušt8_t
 
tmp
 = 
út
 >> ((7 - 
i
) * 8);

270 
	`SHA_upd©e
(
ùx
, &
tmp
, 1);

273 
i
 = 0; i < 5; i++) {

274 
ušt32_t
 
tmp
 = 
ùx
->
¡©e
[
i
];

275 *
p
++ = 
tmp
 >> 24;

276 *
p
++ = 
tmp
 >> 16;

277 *
p
++ = 
tmp
 >> 8;

278 *
p
++ = 
tmp
 >> 0;

281  
ùx
->
buf
;

282 
	}
}

286 
	$SHA_š™
(
SHA_CTX
* 
ùx
) {

287 
ùx
->
¡©e
[0] = 0x67452301;

288 
ùx
->
¡©e
[1] = 0xEFCDAB89;

289 
ùx
->
¡©e
[2] = 0x98BADCFE;

290 
ùx
->
¡©e
[3] = 0x10325476;

291 
ùx
->
¡©e
[4] = 0xC3D2E1F0;

292 
ùx
->
couÁ
 = 0;

293 
	}
}

296 cÚ¡ 
ušt8_t
* 
	$SHA
(cÚ¡ *
d©a
, 
Ën
, 
ušt8_t
 *
dige¡
) {

297 cÚ¡ 
ušt8_t
 *
p
;

298 
i
;

299 
SHA_CTX
 
ùx
;

300 
	`SHA_š™
(&
ùx
);

301 
	`SHA_upd©e
(&
ùx
, 
d©a
, 
Ën
);

302 
p
 = 
	`SHA_fš®
(&
ùx
);

303 
i
 = 0; i < 
SHA_DIGEST_SIZE
; ++i) {

304 
dige¡
[
i
] = *
p
++;

306  
dige¡
;

307 
	}
}

	@libs/libmincrypt/tools/DumpPublicKey.java

17 
·ckage
 
	gcom
.
	gªdroid
.
	gdumpkey
;

19 
impÜt
 
	gjava
.
	gio
.
	gFeIÅutSŒ—m
;

20 
impÜt
 
	gjava
.
	gm©h
.
	gBigIÁeg”
;

21 
impÜt
 
	gjava
.
	g£cur™y
.
	gû¹
.
	gC”tifiÿ‹FaùÜy
;

22 
impÜt
 
	gjava
.
	g£cur™y
.
	gû¹
.
	gC”tifiÿ‹
;

23 
impÜt
 
	gjava
.
	g£cur™y
.
	gKeyStÜe
;

24 
impÜt
 
	gjava
.
	g£cur™y
.
	gKey
;

25 
impÜt
 
	gjava
.
	g£cur™y
.
	gPublicKey
;

26 
impÜt
 
	gjava
.
	g£cur™y
.
	gš‹rçûs
.
	gRSAPublicKey
;

33 şas 
	cDumpPublicKey
 {

42 
	$check
(
RSAPublicKey
 
key
è
throws
 
Exû±iÚ
 {

43 
BigIÁeg”
 
pubexp
 = 
key
.
	`g‘PublicExpÚ’t
();

44 
BigIÁeg”
 
modulus
 = 
key
.
	`g‘Modulus
();

45 
v”siÚ
;

47 ià(
pubexp
.
	`equ®s
(
BigIÁeg”
.
	`v®ueOf
(3))) {

48 
v”siÚ
 = 1;

49 } ià(
pubexp
.
	`equ®s
(
BigIÁeg”
.
	`v®ueOf
(65537))) {

50 
v”siÚ
 = 2;

52 
throw
 
Ãw
 
	`Exû±iÚ
("Publicƒxponent should be 3 or 65537 but is " +

53 
pubexp
.
	`toSŒšg
(10) + ".");

56 ià(
modulus
.
	`b™L’gth
() != 2048) {

57 
throw
 
Ãw
 
	`Exû±iÚ
("Modulus should be 2048 bits†ong but is " +

58 
modulus
.
	`b™L’gth
() + " bits.");

61  
v”siÚ
;

70 
SŒšg
 
	$´št
(
RSAPublicKey
 
key
è
throws
 
Exû±iÚ
 {

71 
v”siÚ
 = 
	`check
(
key
);

73 
BigIÁeg”
 
N
 = 
key
.
	`g‘Modulus
();

75 
SŒšgBud”
 
»suÉ
 = 
Ãw
 
	`SŒšgBud”
();

77 
nwÜds
 = 
N
.
	`b™L’gth
() / 32;

79 ià(
v”siÚ
 > 1) {

80 
»suÉ
.
	`­³nd
("v");

81 
»suÉ
.
	`­³nd
(
IÁeg”
.
	`toSŒšg
(
v”siÚ
));

82 
»suÉ
.
	`­³nd
(" ");

85 
»suÉ
.
	`­³nd
("{");

86 
»suÉ
.
	`­³nd
(
nwÜds
);

88 
BigIÁeg”
 
B
 = BigIÁeg”.
	`v®ueOf
(0x100000000L);

89 
BigIÁeg”
 
N0šv
 = 
B
.
	`subŒaù
(
N
.
	`modInv”£
(B));

91 
»suÉ
.
	`­³nd
(",0x");

92 
»suÉ
.
	`­³nd
(
N0šv
.
	`toSŒšg
(16));

94 
BigIÁeg”
 
R
 = BigIÁeg”.
	`v®ueOf
(2).
	`pow
(
N
.
	`b™L’gth
());

95 
BigIÁeg”
 
RR
 = 
R
.
	`muÉly
(R).
	`mod
(
N
);

98 
»suÉ
.
	`­³nd
(",{");

99 
i
 = 0; i < 
nwÜds
; ++i) {

100 
n
 = 
N
.
	`mod
(
B
).
	`lÚgV®ue
();

101 
»suÉ
.
	`­³nd
(
n
);

103 ià(
i
 !ğ
nwÜds
 - 1) {

104 
»suÉ
.
	`­³nd
(",");

107 
N
 = N.
	`divide
(
B
);

109 
»suÉ
.
	`­³nd
("}");

112 
»suÉ
.
	`­³nd
(",{");

113 
i
 = 0; i < 
nwÜds
; ++i) {

114 
¼
 = 
RR
.
	`mod
(
B
).
	`lÚgV®ue
();

115 
»suÉ
.
	`­³nd
(
¼
);

117 ià(
i
 !ğ
nwÜds
 - 1) {

118 
»suÉ
.
	`­³nd
(",");

121 
RR
 = RR.
	`divide
(
B
);

123 
»suÉ
.
	`­³nd
("}");

125 
»suÉ
.
	`­³nd
("}");

126  
»suÉ
.
	`toSŒšg
();

127 
	}
}

129 
public
 
	$maš
(
SŒšg
[] 
¬gs
) {

130 ià(
¬gs
.
Ëngth
 < 1) {

131 
Sy¡em
.
”r
.
	`´šn
("Usage: DumpPublicKey certfile ... > source.c");

132 
Sy¡em
.
	`ex™
(1);

134 
Œy
 {

135 
i
 = 0; i < 
¬gs
.
Ëngth
; i++) {

136 
FeIÅutSŒ—m
 
šput
 = 
Ãw
 
	`FeIÅutSŒ—m
(
¬gs
[
i
]);

137 
C”tifiÿ‹FaùÜy
 
cf
 = C”tifiÿ‹FaùÜy.
	`g‘In¡ªû
("X.509");

138 
C”tifiÿ‹
 
û¹
 = 
cf
.
	`g’”©eC”tifiÿ‹
(
šput
);

139 
RSAPublicKey
 
key
 = (RSAPublicKeyè(
û¹
.
	`g‘PublicKey
());

140 
	`check
(
key
);

141 
Sy¡em
.
out
.
	`´št
Õršt(
key
));

142 
Sy¡em
.
out
.
	`´šn
(
i
 < 
¬gs
.
Ëngth
 - 1 ? "," : "");

144 } 
	`ÿtch
 (
Exû±iÚ
 
e
) {

145 
e
.
	`´štSckT¿û
();

146 
Sy¡em
.
	`ex™
(1);

148 
Sy¡em
.
	`ex™
(0);

149 
	}
}

	@log_service.c

18 
	~<¡dlib.h
>

19 
	~<¡dio.h
>

20 
	~<uni¡d.h
>

21 
	~<¡ršg.h
>

22 
	~<fú.h
>

23 
	~<”ºo.h
>

24 
	~<sys/sock‘.h
>

25 
	~<cuts/logg”.h
>

26 
	~"sysd•s.h
"

27 
	~"adb.h
"

29 
	#LOG_FILE_DIR
 "/dev/log/"

	)

31 
wr™e_log_’Œy
(
fd
, 
logg”_’Œy
 *
buf
);

33 
	$log_£rviû
(
fd
, *
cook›
)

36 * 
log_f•©h
 = 
cook›
;

39 
logfd
 = 
	`unix_İ’
(
log_f•©h
, 
O_RDONLY
);

40 ià(
logfd
 < 0) {

41 
dÚe
;

45 
buf
[
LOGGER_ENTRY_MAX_LEN
 + 1] 
	`__©Œibu‹__
((
	`®igÃd
(4)));

46 
logg”_’Œy
 *
’Œy
 = (logg”_’Œy *è
buf
;

49 
»t
;

51 
»t
 = 
	`unix_»ad
(
logfd
, 
’Œy
, 
LOGGER_ENTRY_MAX_LEN
);

52 ià(
»t
 < 0) {

53 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

56 
dÚe
;

58 ià(!
»t
) {

60 
dÚe
;

65 
’Œy
->
msg
[’Œy->
Ën
] = '\0';

67 
	`wr™e_log_’Œy
(
fd
, 
’Œy
);

70 
dÚe
:

71 
	`unix_şo£
(
fd
);

72 
	`ä“
(
log_f•©h
);

73 
	}
}

76 * 
	$g‘_log_fe_·th
(cÚ¡ * 
log_Çme
) {

77 *
log_deviû
 = 
	`m®loc
(
	`¡¾’
(
LOG_FILE_DIR
è+ sŒËn(
log_Çme
) + 1);

79 
	`¡rıy
(
log_deviû
, 
LOG_FILE_DIR
);

80 
	`¡rÿt
(
log_deviû
, 
log_Çme
);

82  
log_deviû
;

83 
	}
}

87 
	$wr™e_log_’Œy
(
fd
, 
logg”_’Œy
 *
buf
)

89 
size_t
 
size
 = (
logg”_’Œy
è+ 
buf
->
Ën
;

91 
	`wr™ex
(
fd
, 
buf
, 
size
);

92 
	}
}

	@mutex_list.h

6 #iâdeà
ADB_MUTEX


7 #”rÜ 
ADB_MUTEX
 
nÙ
 
defšed
 
wh’
 
šşudšg
 
this
 
fe


9 
	$ADB_MUTEX
(
dns_lock
)

10 
	$ADB_MUTEX
(
sock‘_li¡_lock
)

11 
	$ADB_MUTEX
(
Œª¥Üt_lock
)

12 #ià
ADB_HOST


13 
	$ADB_MUTEX
(
loÿl_Œª¥Üts_lock
)

15 
	$ADB_MUTEX
(
usb_lock
)

24 
	$ADB_MUTEX
(
D_lock
)

26 #undeà
ADB_MUTEX


	@private/android_filesystem_config.h

22 #iâdeà
_ANDROID_FILESYSTEM_CONFIG_H_


23 
	#_ANDROID_FILESYSTEM_CONFIG_H_


	)

25 
	~<¡ršg.h
>

26 
	~<sys/¡©.h
>

27 
	~<sys/ty³s.h
>

33 
	#AID_ROOT
 0

	)

35 
	#AID_SYSTEM
 1000

	)

37 
	#AID_RADIO
 1001

	)

38 
	#AID_BLUETOOTH
 1002

	)

39 
	#AID_GRAPHICS
 1003

	)

40 
	#AID_INPUT
 1004

	)

41 
	#AID_AUDIO
 1005

	)

42 
	#AID_CAMERA
 1006

	)

43 
	#AID_LOG
 1007

	)

44 
	#AID_COMPASS
 1008

	)

45 
	#AID_MOUNT
 1009

	)

46 
	#AID_WIFI
 1010

	)

47 
	#AID_ADB
 1011

	)

48 
	#AID_INSTALL
 1012

	)

49 
	#AID_MEDIA
 1013

	)

50 
	#AID_DHCP
 1014

	)

51 
	#AID_SDCARD_RW
 1015

	)

52 
	#AID_VPN
 1016

	)

53 
	#AID_KEYSTORE
 1017

	)

54 
	#AID_USB
 1018

	)

55 
	#AID_DRM
 1019

	)

56 
	#AID_MDNSR
 1020

	)

57 
	#AID_GPS
 1021

	)

58 
	#AID_UNUSED1
 1022

	)

59 
	#AID_MEDIA_RW
 1023

	)

60 
	#AID_MTP
 1024

	)

61 
	#AID_UNUSED2
 1025

	)

62 
	#AID_DRMRPC
 1026

	)

63 
	#AID_NFC
 1027

	)

64 
	#AID_SDCARD_R
 1028

	)

66 
	#AID_SHELL
 2000

	)

67 
	#AID_CACHE
 2001

	)

68 
	#AID_DIAG
 2002

	)

72 
	#AID_NET_BT_ADMIN
 3001

	)

73 
	#AID_NET_BT
 3002

	)

74 
	#AID_INET
 3003

	)

75 
	#AID_NET_RAW
 3004

	)

76 
	#AID_NET_ADMIN
 3005

	)

77 
	#AID_NET_BW_STATS
 3006

	)

78 
	#AID_NET_BW_ACCT
 3007

	)

79 
	#AID_NET_BT_STACK
 3008

	)

81 
	#AID_MISC
 9998

	)

82 
	#AID_NOBODY
 9999

	)

84 
	#AID_APP
 10000

	)

86 
	#AID_ISOLATED_START
 99000

	)

87 
	#AID_ISOLATED_END
 99999

	)

89 
	#AID_USER
 100000

	)

91 
	#AID_SHARED_GID_START
 50000

	)

92 
	#AID_SHARED_GID_END
 59999

	)

94 #ià!
defšed
(
EXCLUDE_FS_CONFIG_STRUCTURES
)

95 
	sªdroid_id_šfo
 {

96 cÚ¡ *
	mÇme
;

97 
	maid
;

100 cÚ¡ 
ªdroid_id_šfo
 
	gªdroid_ids
[] = {

101 { "roÙ", 
AID_ROOT
, },

102 { "sy¡em", 
AID_SYSTEM
, },

103 { "¿dio", 
AID_RADIO
, },

104 { "blu‘oÙh", 
AID_BLUETOOTH
, },

105 { "g¿phics", 
AID_GRAPHICS
, },

106 { "šput", 
AID_INPUT
, },

107 { "audio", 
AID_AUDIO
, },

108 { "ÿm”a", 
AID_CAMERA
, },

109 { "log", 
AID_LOG
, },

110 { "com·ss", 
AID_COMPASS
, },

111 { "mouÁ", 
AID_MOUNT
, },

112 { "wifi", 
AID_WIFI
, },

113 { "dhı", 
AID_DHCP
, },

114 { "adb", 
AID_ADB
, },

115 { "š¡®l", 
AID_INSTALL
, },

116 { "medŸ", 
AID_MEDIA
, },

117 { "drm", 
AID_DRM
, },

118 { "mdn¤", 
AID_MDNSR
, },

119 { "nfc", 
AID_NFC
, },

120 { "drm½c", 
AID_DRMRPC
, },

121 { "sh–l", 
AID_SHELL
, },

122 { "ÿche", 
AID_CACHE
, },

123 { "dŸg", 
AID_DIAG
, },

124 { "Ãt_bt_admš", 
AID_NET_BT_ADMIN
, },

125 { "Ãt_bt", 
AID_NET_BT
, },

126 { "Ãt_bt_¡ack", 
AID_NET_BT_STACK
, },

127 { "sdÿrd_r", 
AID_SDCARD_R
, },

128 { "sdÿrd_rw", 
AID_SDCARD_RW
, },

129 { "medŸ_rw", 
AID_MEDIA_RW
, },

130 { "v²", 
AID_VPN
, },

131 { "key¡Üe", 
AID_KEYSTORE
, },

132 { "usb", 
AID_USB
, },

133 { "m", 
AID_MTP
, },

134 { "gps", 
AID_GPS
, },

135 { "š‘", 
AID_INET
, },

136 { "Ãt_¿w", 
AID_NET_RAW
, },

137 { "Ãt_admš", 
AID_NET_ADMIN
, },

138 { "Ãt_bw_¡©s", 
AID_NET_BW_STATS
, },

139 { "Ãt_bw_acù", 
AID_NET_BW_ACCT
, },

140 { "misc", 
AID_MISC
, },

141 { "nobody", 
AID_NOBODY
, },

144 
	#ªdroid_id_couÁ
 \

145 ((
ªdroid_ids
è/ ×ndroid_ids[0]))

	)

147 
	sfs_·th_cÚfig
 {

148 
	mmode
;

149 
	muid
;

150 
	mgid
;

151 cÚ¡ *
	m´efix
;

160 
fs_·th_cÚfig
 
	gªdroid_dœs
[] = {

161 { 00770, 
AID_SYSTEM
, 
AID_CACHE
, "cache" },

162 { 00771, 
AID_SYSTEM
, AID_SYSTEM, "data/app" },

163 { 00771, 
AID_SYSTEM
, AID_SYSTEM, "data/app-private" },

164 { 00771, 
AID_SYSTEM
, AID_SYSTEM, "data/dalvik-cache" },

165 { 00771, 
AID_SYSTEM
, AID_SYSTEM, "data/data" },

166 { 00771, 
AID_SHELL
, AID_SHELL, "data/local/tmp" },

167 { 00771, 
AID_SHELL
, AID_SHELL, "data/local" },

168 { 01771, 
AID_SYSTEM
, 
AID_MISC
, "data/misc" },

169 { 00770, 
AID_DHCP
, AID_DHCP, "data/misc/dhcp" },

170 { 00775, 
AID_MEDIA_RW
, AID_MEDIA_RW, "data/media" },

171 { 00775, 
AID_MEDIA_RW
, AID_MEDIA_RW, "data/media/Music" },

172 { 00771, 
AID_SYSTEM
, AID_SYSTEM, "data" },

173 { 00750, 
AID_ROOT
, 
AID_SHELL
, "sbin" },

174 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/bin" },

175 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/vendor" },

176 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/xbin" },

177 { 00755, 
AID_ROOT
, AID_ROOT, "system/etc/ppp" },

178 { 00777, 
AID_ROOT
, AID_ROOT, "sdcard" },

179 { 00755, 
AID_ROOT
, AID_ROOT, 0 },

188 
fs_·th_cÚfig
 
	gªdroid_fes
[] = {

189 { 00440, 
AID_ROOT
, 
AID_SHELL
, "system/etc/init.goldfish.rc" },

190 { 00550, 
AID_ROOT
, 
AID_SHELL
, "system/etc/init.goldfish.sh" },

191 { 00440, 
AID_ROOT
, 
AID_SHELL
, "system/etc/init.trout.rc" },

192 { 00550, 
AID_ROOT
, 
AID_SHELL
, "system/etc/init.ril" },

193 { 00550, 
AID_ROOT
, 
AID_SHELL
, "system/etc/init.testmenu" },

194 { 00550, 
AID_DHCP
, 
AID_SHELL
, "system/etc/dhcpcd/dhcpcd-run-hooks" },

195 { 00440, 
AID_BLUETOOTH
, AID_BLUETOOTH, "system/etc/dbus.conf" },

196 { 00444, 
AID_RADIO
, 
AID_AUDIO
, "system/etc/AudioPara4.csv" },

197 { 00555, 
AID_ROOT
, AID_ROOT, "system/etc/ppp/*" },

198 { 00555, 
AID_ROOT
, AID_ROOT, "system/etc/rc.*" },

199 { 00644, 
AID_SYSTEM
, AID_SYSTEM, "data/app/*" },

200 { 00644, 
AID_MEDIA_RW
, AID_MEDIA_RW, "data/media/*" },

201 { 00644, 
AID_SYSTEM
, AID_SYSTEM, "data/app-private/*" },

202 { 00644, 
AID_APP
, AID_APP, "data/data/*" },

205 { 02755, 
AID_ROOT
, 
AID_NET_RAW
, "system/bin/ping" },

206 { 02750, 
AID_ROOT
, 
AID_INET
, "system/bin/netcfg" },

209 { 06755, 
AID_ROOT
, AID_ROOT, "system/xbin/su" },

210 { 06755, 
AID_ROOT
, AID_ROOT, "system/xbin/librank" },

211 { 06755, 
AID_ROOT
, AID_ROOT, "system/xbin/procrank" },

212 { 06755, 
AID_ROOT
, AID_ROOT, "system/xbin/procmem" },

213 { 06755, 
AID_ROOT
, AID_ROOT, "system/xbin/tcpdump" },

214 { 04770, 
AID_ROOT
, 
AID_RADIO
, "system/bin/pppd-ril" },

217 { 06750, 
AID_ROOT
, 
AID_SHELL
, "system/bin/run-as" },

218 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/bin/*" },

219 { 00755, 
AID_ROOT
, AID_ROOT, "system/lib/valgrind/*" },

220 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/xbin/*" },

221 { 00755, 
AID_ROOT
, 
AID_SHELL
, "system/vendor/bin/*" },

222 { 00750, 
AID_ROOT
, 
AID_SHELL
, "sbin/*" },

223 { 00755, 
AID_ROOT
, AID_ROOT, "bin/*" },

224 { 00750, 
AID_ROOT
, 
AID_SHELL
, "init*" },

225 { 00750, 
AID_ROOT
, 
AID_SHELL
, "charger*" },

226 { 00750, 
AID_ROOT
, 
AID_SHELL
, "sbin/fs_mgr" },

227 { 00640, 
AID_ROOT
, 
AID_SHELL
, "fstab.*" },

228 { 00644, 
AID_ROOT
, AID_ROOT, 0 },

231 
šlše
 
	$fs_cÚfig
(cÚ¡ *
·th
, 
dœ
,

232 *
uid
, *
gid
, *
mode
)

234 
fs_·th_cÚfig
 *
pc
;

235 
¶’
;

237 
pc
 = 
dœ
 ? 
ªdroid_dœs
 : 
ªdroid_fes
;

238 
¶’
 = 
	`¡¾’
(
·th
);

239 ; 
pc
->
´efix
;…c++){

240 
Ën
 = 
	`¡¾’
(
pc
->
´efix
);

241 ià(
dœ
) {

242 if(
¶’
 < 
Ën
) ;

243 if(!
	`¡ºcmp
(
pc
->
´efix
, 
·th
, 
Ën
)) ;

247 ià(
pc
->
´efix
[
Ën
 -1] == '*') {

248 if(!
	`¡ºcmp
(
pc
->
´efix
, 
·th
, 
Ën
 - 1)) ;

249 } ià(
¶’
 =ğ
Ën
){

250 if(!
	`¡ºcmp
(
pc
->
´efix
, 
·th
, 
Ën
)) ;

253 *
uid
 = 
pc
->uid;

254 *
gid
 = 
pc
->gid;

255 *
mode
 = (*mod& (~07777)è| 
pc
->mode;

258 
	`årštf
(
¡d”r
,"< '%s' '%s' %d %d %o >\n",

259 
·th
, 
pc
->
´efix
 ?…c->´efix : "", *
uid
, *
gid
, *
mode
);

261 
	}
}

	@qemu/qemu.c

20 
	~"qemu.h
"

21 
	#LOG_TAG
 "h¬dw¬e-qemu"

	)

22 
	~<cuts/log.h
>

23 
	~<cuts/´İ”t›s.h
>

24 
	~<cuts/sock‘s.h
>

25 
	~<”ºo.h
>

26 
	~<fú.h
>

27 
	~<‹rmios.h
>

28 
	~<¡dio.h
>

29 
	~<¡d¬g.h
>

31 
	#QEMU_DEBUG
 0

	)

33 #ià
QEMU_DEBUG


34 
	#D
(...è
	`ALOGD
(
__VA_ARGS__
)

	)

36 
	#D
(...è(()0)

	)

39 
	~"qemu_pe.h
"

42 
	$qemu_check
()

44 
š_qemu
 = -1;

46 ià(
	`__butš_ex³ù
(
š_qemu
 < 0,0)) {

47 
´İBuf
[
PROPERTY_VALUE_MAX
];

48 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
´İBuf
, "");

49 
š_qemu
 = (
´İBuf
[0] == '1');

51  
š_qemu
;

52 
	}
}

55 
	$qemu_fd_wr™e
Ğ
fd
, cÚ¡ * 
cmd
, 
Ën
 )

57 
Ën2
;

59 
Ën2
 = 
	`wr™e
(
fd
, 
cmd
, 
Ën
);

60 } 
Ën2
 < 0 && 
”ºo
 =ğ
EINTR
);

61  
Ën2
;

62 
	}
}

65 
	$qemu_fd_»ad
Ğ
fd
, * 
buff
, 
Ën
 )

67 
Ën2
;

69 
Ën2
 = 
	`»ad
(
fd
, 
buff
, 
Ën
);

70 } 
Ën2
 < 0 && 
”ºo
 =ğ
EINTR
);

71  
Ën2
;

72 
	}
}

75 
	$qemu_chªÃl_İ’_qemud_pe
Ğ
QemuChªÃl
* 
chªÃl
,

76 cÚ¡ * 
Çme
 )

78 
fd
;

79 
pe_Çme
[512];

81 
	`¢´štf
(
pe_Çme
, Õe_Çme), "qemud:%s", 
Çme
);

82 
fd
 = 
	`qemu_pe_İ’
(
pe_Çme
);

83 ià(
fd
 < 0) {

84 
	`D
("nØqemud…e: %s", 
	`¡»¼Ü
(
”ºo
));

88 
chªÃl
->
is_qemud
 = 1;

89 
chªÃl
->
fd
 = fd;

91 
	}
}

94 
	$qemu_chªÃl_İ’_qemud
Ğ
QemuChªÃl
* 
chªÃl
,

95 cÚ¡ * 
Çme
 )

97 
fd
, 
»t
, 
Çm–’
 = 
	`¡¾’
(
Çme
);

98 
ªsw”
[2];

100 
fd
 = 
	`sock‘_loÿl_ş›Á
( "qemud",

101 
ANDROID_SOCKET_NAMESPACE_RESERVED
,

102 
SOCK_STREAM
 );

103 ià(
fd
 < 0) {

104 
	`D
("nØqemud cÚŒŞ sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

109 ià(
	`qemu_fd_wr™e
(
fd
, 
Çme
, 
Çm–’
) !=‚amelen) {

110 
	`D
("can't send service‚ameo qemud: %s",

111 
	`¡»¼Ü
(
”ºo
));

112 
	`şo£
(
fd
);

117 ià(
	`qemu_fd_»ad
(
fd
, 
ªsw”
, 2) != 2 ||

118 
ªsw”
[0] != 'O' ||‡nswer[1] != 'K') {

119 
	`D
("ÿÁ' cÚÃùØ% £rviûhrough qemud", 
Çme
);

120 
	`şo£
(
fd
);

124 
chªÃl
->
is_qemud
 = 1;

125 
chªÃl
->
fd
 = fd;

127 
	}
}

131 
	$qemu_chªÃl_İ’_qemud_Şd
Ğ
QemuChªÃl
* 
chªÃl
,

132 cÚ¡ * 
Çme
 )

134 
fd
;

136 
	`¢´štf
(
chªÃl
->
deviû
,  channel->device,

137 "qemud_%s", 
Çme
);

139 
fd
 = 
	`sock‘_loÿl_ş›Á
Ğ
chªÃl
->
deviû
,

140 
ANDROID_SOCKET_NAMESPACE_RESERVED
,

141 
SOCK_STREAM
 );

142 ià(
fd
 < 0) {

143 
	`D
("no '%s' control socket‡vailable: %s",

144 
chªÃl
->
deviû
, 
	`¡»¼Ü
(
”ºo
));

148 
	`şo£
(
fd
);

149 
chªÃl
->
is_qemud_Şd
 = 1;

151 
	}
}

155 
	$qemu_chªÃl_İ’_‰y
Ğ
QemuChªÃl
* 
chªÃl
,

156 cÚ¡ * 
Çme
,

157 
mode
 )

159 
key
[
PROPERTY_KEY_MAX
];

160 
´İ
[
PROPERTY_VALUE_MAX
];

161 
»t
;

163 
»t
 = 
	`¢´štf
(
key
,  key, "ro.k”Ãl.ªdroid.%s", 
Çme
);

164 ià(
»t
 >ğ() 
key
)

167 ià(
	`´İ”ty_g‘
(
key
, 
´İ
, "") == 0) {

168 
	`D
("nØk”Ãl-´ovided % deviû‚ame", 
Çme
);

172 
»t
 = 
	`¢´štf
(
chªÃl
->
deviû
,  channel->device,

173 "/dev/%s", 
´İ
);

174 ià(
»t
 >ğ() 
chªÃl
->
deviû
) {

175 
	`D
("% deviû‚amtoØlÚg: '%s'", 
Çme
, 
´İ
);

179 
chªÃl
->
is_‰y
 = !
	`memcmp
("/dev/‰y", chªÃl->
deviû
, 8);

181 
	}
}

184 
	$qemu_chªÃl_İ’
Ğ
QemuChªÃl
* 
chªÃl
,

185 cÚ¡ * 
Çme
,

186 
mode
 )

188 
fd
 = -1;

191 ià(!
chªÃl
->
is_š™ed
)

193 
chªÃl
->
is_š™ed
 = 1;

196 ià(
	`qemu_chªÃl_İ’_qemud_pe
(
chªÃl
, 
Çme
) == 0)

199 ià(
	`qemu_chªÃl_İ’_qemud
(
chªÃl
, 
Çme
) == 0)

202 ià(
	`qemu_chªÃl_İ’_qemud_Şd
(
chªÃl
, 
Çme
) == 0)

205 ià(
	`qemu_chªÃl_İ’_‰y
(
chªÃl
, 
Çme
, 
mode
) == 0)

208 
chªÃl
->
is_avaabË
 = 0;

212 
chªÃl
->
is_avaabË
 = 1;

216 ià(!
chªÃl
->
is_avaabË
) {

217 
”ºo
 = 
ENOENT
;

221 ià(
chªÃl
->
is_qemud
) {

222  
	`dup
(
chªÃl
->
fd
);

225 ià(
chªÃl
->
is_qemud_Şd
) {

227 
fd
 = 
	`sock‘_loÿl_ş›Á
Ğ
chªÃl
->
deviû
,

228 
ANDROID_SOCKET_NAMESPACE_RESERVED
,

229 
SOCK_STREAM
 );

230 } 
fd
 < 0 && 
”ºo
 =ğ
EINTR
);

235 
fd
 = 
	`İ’
(
chªÃl
->
deviû
, 
mode
);

236 } 
fd
 < 0 && 
”ºo
 =ğ
EINTR
);

239 ià(
fd
 >ğ0 && 
chªÃl
->
is_‰y
) {

240 
‹rmios
 
ios
;

241 
	`tcg‘©Œ
Ğ
fd
, &
ios
 );

242 
ios
.
c_læag
 = 0;

243 
	`tc£‰r
Ğ
fd
, 
TCSANOW
, &
ios
 );

246  
fd
;

247 
	}
}

251 
	$qemu_commªd_vfÜm©
Ğ* 
bufãr
,

252 
bufãr_size
,

253 cÚ¡ * 
fÜm©
,

254 
va_li¡
 
¬gs
 )

256 
h—d”
[5];

257 
Ën
;

259 ià(
bufãr_size
 < 6)

262 
Ën
 = 
	`v¢´štf
(
bufãr
+4, 
bufãr_size
-4, 
fÜm©
, 
¬gs
);

263 ià(
Ën
 >ğ
bufãr_size
-4)

266 
	`¢´štf
(
h—d”
,  h—d”, "%04x", 
Ën
);

267 
	`memıy
(
bufãr
, 
h—d”
, 4);

268  
Ën
 + 4;

269 
	}
}

272 
	$qemu_commªd_fÜm©
Ğ* 
bufãr
,

273 
bufãr_size
,

274 cÚ¡ * 
fÜm©
,

277 
va_li¡
 
¬gs
;

278 
»t
;

280 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

281 
»t
 = 
	`qemu_commªd_fÜm©
(
bufãr
, 
bufãr_size
, 
fÜm©
, 
¬gs
);

282 
	`va_’d
(
¬gs
);

283  
»t
;

284 
	}
}

288 
	$qemu_cÚŒŞ_fd
()

290 
QemuChªÃl
 
chªÃl
[1];

291 
fd
;

293 
fd
 = 
	`qemu_chªÃl_İ’
Ğ
chªÃl
, "hw-cÚŒŞ", 
O_RDWR
 );

294 ià(
fd
 < 0) {

295 
	`D
("%s: could‚Ù o³ÀcÚŒŞ chªÃl: %s", 
__FUNCTION__
,

296 
	`¡»¼Ü
(
”ºo
));

298  
fd
;

299 
	}
}

302 
	$qemu_cÚŒŞ_£nd
(cÚ¡ * 
cmd
, 
Ën
)

304 
fd
, 
Ën2
;

306 ià(
Ën
 < 0) {

307 
”ºo
 = 
EINVAL
;

311 
fd
 = 
	`qemu_cÚŒŞ_fd
();

312 ià(
fd
 < 0)

315 
Ën2
 = 
	`qemu_fd_wr™e
(
fd
, 
cmd
, 
Ën
);

316 
	`şo£
(
fd
);

317 ià(
Ën2
 !ğ
Ën
) {

318 
	`D
("%s: could‚ot sendƒverything %d < %d",

319 
__FUNCTION__
, 
Ën2
, 
Ën
);

323 
	}
}

327 
	$qemu_cÚŒŞ_commªd
ĞcÚ¡ * 
fmt
, ... )

329 
va_li¡
 
¬gs
;

330 
commªd
[256];

331 
Ën
, 
fd
;

333 
	`va_¡¬t
(
¬gs
, 
fmt
);

334 
Ën
 = 
	`qemu_commªd_vfÜm©
Ğ
commªd
,  commªd, 
fmt
, 
¬gs
 );

335 
	`va_’d
(
¬gs
);

337 ià(
Ën
 < 0 ||†’ >ğ() 
commªd
) {

338 ià(
Ën
 < 0) {

339 
	`D
("%s: could‚Ù s’d: %s", 
__FUNCTION__
, 
	`¡»¼Ü
(
”ºo
));

341 
	`D
("%s:oØÏrg%d > %d", 
__FUNCTION__
, 
Ën
, ()( 
commªd
));

343 
”ºo
 = 
EINVAL
;

347  
	`qemu_cÚŒŞ_£nd
Ğ
commªd
, 
Ën
 );

348 
	}
}

350 
	$qemu_cÚŒŞ_qu”y
ĞcÚ¡ * 
que¡iÚ
, 
que¡iÚËn
,

351 * 
ªsw”
, 
ªsw”size
 )

353 
»t
, 
fd
, 
Ën
, 
»suÉ
 = -1;

354 
h—d”
[5], *
’d
;

356 ià(
que¡iÚËn
 <= 0) {

357 
”ºo
 = 
EINVAL
;

361 
fd
 = 
	`qemu_cÚŒŞ_fd
();

362 ià(
fd
 < 0)

365 
»t
 = 
	`qemu_fd_wr™e
Ğ
fd
, 
que¡iÚ
, 
que¡iÚËn
 );

366 ià(
»t
 !ğ
que¡iÚËn
) {

367 
	`D
("%s: could‚Ù wr™®l: %d < %d", 
__FUNCTION__
,

368 
»t
, 
que¡iÚËn
);

369 
Ex™
;

373 
»t
 = 
	`qemu_fd_»ad
Ğ
fd
, 
h—d”
, 4 );

374 ià(
»t
 != 4) {

375 
	`D
("%s: could‚ot„ead header (%d != 4)",

376 
__FUNCTION__
, 
»t
);

377 
Ex™
;

380 
h—d”
[4] = 0;

381 
Ën
 = 
	`¡¹Ş
Ğ
h—d”
, &
’d
, 16 );

382 iàĞ
Ën
 < 0 || 
’d
 =ğ
NULL
 ||ƒnd !ğ
h—d”
+4 ||†’ > 
ªsw”size
 ) {

383 
	`D
("%s: could‚ot…arse header: '%s'",

384 
__FUNCTION__
, 
h—d”
);

385 
Ex™
;

389 
»t
 = 
	`qemu_fd_»ad
Ğ
fd
, 
ªsw”
, 
Ën
 );

390 ià(
»t
 !ğ
Ën
) {

391 
	`D
("%s: could‚ot„ead‡ll of‡nswer %d < %d",

392 
__FUNCTION__
, 
»t
, 
Ën
);

393 
Ex™
;

396 
»suÉ
 = 
Ën
;

398 
Ex™
:

399 
	`şo£
(
fd
);

400  
»suÉ
;

401 
	}
}

	@qemu/qemu.h

16 #iâdeà
_libs_h¬dw¬e_qemu_h


17 
	#_libs_h¬dw¬e_qemu_h


	)

19 #ifdeà
__ılu¥lus


23 #ifdeà
QEMU_HARDWARE


26 
qemu_check
();

35 
	mis_š™ed
;

36 
	mis_avaabË
;

37 
	mis_qemud
;

38 
	mis_qemud_Şd
;

39 
	mis_‰y
;

40 
	mfd
;

41 
	mdeviû
[32];

42 } 
	tQemuChªÃl
;

53 
qemu_chªÃl_İ’
Ğ
QemuChªÃl
* 
chªÃl
,

54 cÚ¡ * 
Çme
,

55 
mode
 );

65 
qemu_commªd_fÜm©
Ğ* 
bufãr
,

66 
bufãr_size
,

67 cÚ¡ * 
fÜm©
,

75 
qemu_cÚŒŞ_commªd
ĞcÚ¡ * 
fmt
, ... );

83 
qemu_cÚŒŞ_qu”y
ĞcÚ¡ * 
que¡iÚ
, 
que¡iÚËn
,

84 * 
ªsw”
, 
ªsw”size
 );

90 #ifdeà
QEMU_HARDWARE


91 
	#QEMU_FALLBACK
(
x
) \

93 ià(
	`qemu_check
()) \

94  
qemu_
 ## 
x
 ; \

95 } 0)

	)

96 
	#QEMU_FALLBACK_VOID
(
x
) \

98 ià(
	`qemu_check
()) { \

99 
qemu_
 ## 
x
 ; \

102 } 0)

	)

104 
	#QEMU_FALLBACK
(
x
è(()0)

	)

105 
	#QEMU_FALLBACK_VOID
(
x
è(()0)

	)

108 #ifdeà
__ılu¥lus


	@qemu/qemu_pipe.h

16 #iâdeà
ANDROID_INCLUDE_HARDWARE_QEMU_PIPE_H


17 
	#ANDROID_INCLUDE_HARDWARE_QEMU_PIPE_H


	)

19 
	~<sys/cdefs.h
>

20 
	~<uni¡d.h
>

21 
	~<fú.h
>

22 
	~<sys/mmª.h
>

23 
	~<±h»ad.h
>

24 
	~<¡dlib.h
>

25 
	~<¡dio.h
>

26 
	~<”ºo.h
>

28 #iâdeà
D


29 
	#D
(...èdo{}0)

	)

37 #iâdeà
TEMP_FAILURE_RETRY


39 
	#TEMP_FAILURE_RETRY
(
exp
) ({ \

40 
	`ty³of
 (
exp
è
_rc
; \

42 
_rc
 = (
exp
); \

43 } 
_rc
 =ğ-1 && 
”ºo
 =ğ
EINTR
); \

44 
_rc
; })

	)

69 
__šlše__
 

70 
	$qemu_pe_İ’
(cÚ¡ * 
peName
)

72 
buff
[256];

73 
buffL’
;

74 
fd
, 
»t
;

76 ià(
peName
 =ğ
NULL
 ||…ipeName[0] == '\0') {

77 
”ºo
 = 
EINVAL
;

81 
	`¢´štf
(
buff
,  buff, "pe:%s", 
peName
);

83 
fd
 = 
	`İ’
("/dev/qemu_pe", 
O_RDWR
);

84 ià(
fd
 < 0) {

85 
	`D
("%s: Could‚Ù o³À/dev/qemu_pe: %s", 
__FUNCTION__
, 
	`¡»¼Ü
(
”ºo
));

90 
buffL’
 = 
	`¡¾’
(
buff
);

92 
»t
 = 
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
fd
, 
buff
, 
buffL’
+1));

93 ià(
»t
 !ğ
buffL’
+1) {

94 
	`D
("%s: Could‚Ù cÚÃùØ% p£rviû: %s", 
__FUNCTION__
, 
peName
, 
	`¡»¼Ü
(
”ºo
));

95 ià(
»t
 == 0) {

96 
”ºo
 = 
ECONNRESET
;

97 } ià(
»t
 > 0) {

98 
”ºo
 = 
EINVAL
;

103  
fd
;

104 
	}
}

	@remount_service.c

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

21 
	~<fú.h
>

22 
	~<sys/mouÁ.h
>

23 
	~<”ºo.h
>

25 
	~"sysd•s.h
"

27 
	#TRACE_TAG
 
TRACE_ADB


	)

28 
	~"adb.h
"

31 
	gsy¡em_ro
 = 1;

34 *
	$fšd_mouÁ
(cÚ¡ *
dœ
)

36 
fd
;

37 
»s
;

38 
size
;

39 *
tok’
 = 
NULL
;

40 cÚ¡ 
d–ims
[] = "\n";

41 
buf
[4096];

43 
fd
 = 
	`unix_İ’
("/´oc/mouÁs", 
O_RDONLY
);

44 ià(
fd
 < 0)

45  
NULL
;

47 
buf
[(buf) - 1] = '\0';

48 
size
 = 
	`adb_»ad
(
fd
, 
buf
, (buf) - 1);

49 
	`adb_şo£
(
fd
);

51 
tok’
 = 
	`¡¹ok
(
buf
, 
d–ims
);

53 
tok’
) {

54 
mouÁ_dev
[256];

55 
mouÁ_dœ
[256];

56 
mouÁ_äeq
;

57 
mouÁ_·s¢o
;

59 
»s
 = 
	`ssÿnf
(
tok’
, "%255s %255s %*s %*s %d %d\n",

60 
mouÁ_dev
, 
mouÁ_dœ
, &
mouÁ_äeq
, &
mouÁ_·s¢o
);

61 
mouÁ_dev
[255] = 0;

62 
mouÁ_dœ
[255] = 0;

63 ià(
»s
 =ğ4 && (
	`¡rcmp
(
dœ
, 
mouÁ_dœ
) == 0))

64  
	`¡rdup
(
mouÁ_dev
);

66 
tok’
 = 
	`¡¹ok
(
NULL
, 
d–ims
);

68  
NULL
;

69 
	}
}

72 
	$»mouÁ_sy¡em
()

74 *
dev
;

76 ià(
sy¡em_ro
 == 0) {

80 
dev
 = 
	`fšd_mouÁ
("/system");

82 ià(!
dev
)

85 
sy¡em_ro
 = 
	`mouÁ
(
dev
, "/sy¡em", "nÚe", 
MS_REMOUNT
, 
NULL
);

87 
	`ä“
(
dev
);

89  
sy¡em_ro
;

90 
	}
}

92 
	$wr™e_¡ršg
(
fd
, cÚ¡ * 
¡r
)

94 
	`wr™ex
(
fd
, 
¡r
, 
	`¡¾’
(str));

95 
	}
}

97 
	$»mouÁ_£rviû
(
fd
, *
cook›
)

99 
»t
 = 
	`»mouÁ_sy¡em
();

101 ià(!
»t
)

102 
	`wr™e_¡ršg
(
fd
, "remount succeeded\n");

104 
bufãr
[200];

105 
	`¢´štf
(
bufãr
, (bufãr), "»mouÁ faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

106 
	`wr™e_¡ršg
(
fd
, 
bufãr
);

109 
	`adb_şo£
(
fd
);

110 
	}
}

	@services.c

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

21 
	~<”ºo.h
>

23 
	~"sysd•s.h
"

25 
	#TRACE_TAG
 
TRACE_SERVICES


	)

26 
	~"adb.h
"

27 
	~"fe_sync_£rviû.h
"

29 #ià
ADB_HOST


30 #iâdeà
HAVE_WINSOCK


31 
	~<Ãtš‘/š.h
>

32 
	~<Ãtdb.h
>

33 
	~<sys/ioùl.h
>

36 
	~<cuts/ªdroid_»boÙ.h
>

39 
¡šfo
 
	t¡šfo
;

41 
	s¡šfo
 {

42 (*
	mfunc
)(
	mfd
, *
	mcook›
);

43 
	mfd
;

44 *
	mcook›
;

48 *
	$£rviû_boÙ¡¿p_func
(*
x
)

50 
¡šfo
 *
¡i
 = 
x
;

51 
¡i
->
	`func
(¡i->
fd
, sti->
cook›
);

52 
	`ä“
(
¡i
);

54 
	}
}

56 #ià
ADB_HOST


57 
ADB_MUTEX_DEFINE
Ğ
dns_lock
 );

59 
	$dns_£rviû
(
fd
, *
cook›
)

61 *
ho¡Çme
 = 
cook›
;

62 
ho¡’t
 *
hp
;

63 
z”o
 = 0;

65 
	`adb_mu‹x_lock
(&
dns_lock
);

66 
hp
 = 
	`g‘ho¡byÇme
(
ho¡Çme
);

67 
	`ä“
(
cook›
);

68 if(
hp
 == 0) {

69 
	`wr™ex
(
fd
, &
z”o
, 4);

71 
	`wr™ex
(
fd
, 
hp
->
h_addr
, 4);

73 
	`adb_mu‹x_uÆock
(&
dns_lock
);

74 
	`adb_şo£
(
fd
);

75 
	}
}

77 
»cov”y_mode
;

79 
	$»cov”_£rviû
(
s
, *
cook›
)

81 
buf
[4096];

82 
couÁ
 = (è
cook›
;

83 
fd
;

85 
fd
 = 
	`adb_ü—t
("/tmp/update", 0644);

86 if(
fd
 < 0) {

87 
	`adb_şo£
(
s
);

91 
couÁ
 > 0) {

92 
xãr
 = (
couÁ
 > 4096) ? 4096 : count;

93 if(
	`»adx
(
s
, 
buf
, 
xãr
)) ;

94 if(
	`wr™ex
(
fd
, 
buf
, 
xãr
)) ;

95 
couÁ
 -ğ
xãr
;

98 if(
couÁ
 == 0) {

99 
	`wr™ex
(
s
, "OKAY", 4);

101 
	`wr™ex
(
s
, "FAIL", 4);

103 
	`adb_şo£
(
fd
);

104 
	`adb_şo£
(
s
);

106 
fd
 = 
	`adb_ü—t
("/tmp/update.begin", 0644);

107 
	`adb_şo£
(
fd
);

108 
	}
}

110 
	$»¡¬t_roÙ_£rviû
(
fd
, *
cook›
)

112 
buf
[100];

113 
v®ue
[
PROPERTY_VALUE_MAX
];

115 ià(
	`g‘uid
() == 0) {

116 
	`¢´štf
(
buf
, (buf), "adbd is‡lready„unning‡s„oot\n");

117 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

118 
	`adb_şo£
(
fd
);

120 
	`´İ”ty_g‘
("ro.debuggabË", 
v®ue
, "");

121 ià(
	`¡rcmp
(
v®ue
, "1") != 0) {

122 
	`¢´štf
(
buf
, (buf), "adbd cannot„un‡s„oot in…roduction builds\n");

123 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

124 
	`adb_şo£
(
fd
);

128 
	`´İ”ty_£t
("service.adb.root", "1");

129 
	`¢´štf
(
buf
, (buf), "restarting‡dbd‡s„oot\n");

130 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

131 
	`adb_şo£
(
fd
);

133 
	}
}

135 
	$»¡¬t_tı_£rviû
(
fd
, *
cook›
)

137 
buf
[100];

138 
v®ue
[
PROPERTY_VALUE_MAX
];

139 
pÜt
 = ()
cook›
;

141 ià(
pÜt
 <= 0) {

142 
	`¢´štf
(
buf
, (buf), "invalid…ort\n");

143 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

144 
	`adb_şo£
(
fd
);

148 
	`¢´štf
(
v®ue
, (v®ue), "%d", 
pÜt
);

149 
	`´İ”ty_£t
("£rviû.adb.tı.pÜt", 
v®ue
);

150 
	`¢´štf
(
buf
, (buf), "»¡¬tšg iÀTCP modpÜt: %d\n", 
pÜt
);

151 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

152 
	`adb_şo£
(
fd
);

153 
	}
}

155 
	$»¡¬t_usb_£rviû
(
fd
, *
cook›
)

157 
buf
[100];

159 
	`´İ”ty_£t
("service.adb.tcp.port", "0");

160 
	`¢´štf
(
buf
, (buf), "restarting in USB mode\n");

161 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

162 
	`adb_şo£
(
fd
);

163 
	}
}

165 
	$»boÙ_£rviû
(
fd
, *
¬g
)

167 
buf
[100];

168 
pid
, 
»t
;

170 
	`sync
();

175 
pid
 = 
	`fÜk
();

176 ià(
pid
 == 0) {

178 
	`exeş
("/system/bin/vdc", "/system/bin/vdc", "volume", "unmount",

179 
	`g‘’v
("EXTERNAL_STORAGE"), "fÜû", 
NULL
);

180 } ià(
pid
 > 0) {

182 
	`wa™pid
(
pid
, &
»t
, 0);

185 
»t
 = 
	`ªdroid_»boÙ
(
ANDROID_RB_RESTART2
, 0, (*è
¬g
);

186 ià(
»t
 < 0) {

187 
	`¢´štf
(
buf
, (buf), "»boÙ faed: %s\n", 
	`¡»¼Ü
(
”ºo
));

188 
	`wr™ex
(
fd
, 
buf
, 
	`¡¾’
(buf));

190 
	`ä“
(
¬g
);

191 
	`adb_şo£
(
fd
);

192 
	}
}

197 
	$echo_£rviû
(
fd
, *
cook›
)

199 
buf
[4096];

200 
r
;

201 *
p
;

202 
c
;

205 
r
 = 
	`»ad
(
fd
, 
buf
, 4096);

206 if(
r
 =ğ0è
dÚe
;

207 if(
r
 < 0) {

208 if(
”ºo
 =ğ
EINTR
) ;

209 
dÚe
;

212 
c
 = 
r
;

213 
p
 = 
buf
;

214 
c
 > 0) {

215 
r
 = 
	`wr™e
(
fd
, 
p
, 
c
);

216 if(
r
 > 0) {

217 
c
 -ğ
r
;

218 
p
 +ğ
r
;

221 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

222 
dÚe
;

225 
dÚe
:

226 
	`şo£
(
fd
);

227 
	}
}

230 
ü—‹_£rviû_th»ad
((*
func
)(, *), *
cook›
)

232 
¡šfo
 *
¡i
;

233 
adb_th»ad_t
 
t
;

234 
s
[2];

236 if(
	`adb_sock‘·œ
(
s
)) {

237 
	`´štf
("cannot create service socket…air\n");

241 
¡i
 = 
	`m®loc
((
¡šfo
));

242 if(
¡i
 =ğ0è
	`çl
("cannot‡llocate stinfo");

243 
¡i
->
func
 = func;

244 
¡i
->
cook›
 = cookie;

245 
¡i
->
fd
 = 
s
[1];

247 if(
	`adb_th»ad_ü—‹
Ğ&
t
, 
£rviû_boÙ¡¿p_func
, 
¡i
)){

248 
	`ä“
(
¡i
);

249 
	`adb_şo£
(
s
[0]);

250 
	`adb_şo£
(
s
[1]);

251 
	`´štf
("cannot create servicehread\n");

255 
	`D
("£rviûh»ad s¹ed, %d:%d\n",
s
[0], s[1]);

256  
s
[0];

257 
	}
}

259 #ià!
ADB_HOST


260 
	$ü—‹_sub´oûss
(cÚ¡ *
cmd
, cÚ¡ *
¬g0
, cÚ¡ *
¬g1
, 
pid_t
 *
pid
)

262 #ifdeà
HAVE_WIN32_PROC


263 
	`D
("ü—‹_sub´oûss(cmd=%s,‡rg0=%s,‡rg1=%s)\n", 
cmd
, 
¬g0
, 
¬g1
);

264 
	`årštf
(
¡d”r
, "”rÜ: c»©e_sub´oûs nÙ im¶em’‹d oÀWš32 (% % %s)\n", 
cmd
, 
¬g0
, 
¬g1
);

267 *
devÇme
;

268 
±m
;

270 
±m
 = 
	`unix_İ’
("/dev/±mx", 
O_RDWR
);

271 if(
±m
 < 0){

272 
	`´štf
("[ cªnÙ o³À/dev/±mx - % ]\n",
	`¡»¼Ü
(
”ºo
));

275 
	`fú
(
±m
, 
F_SETFD
, 
FD_CLOEXEC
);

277 if(
	`g¿Á±
(
±m
è|| 
	`uÆock±
(ptm) ||

278 ((
devÇme
 = (*è
	`±¢ame
(
±m
)) == 0)){

279 
	`´štf
("[roubË w™h /dev/±mx - % ]\n", 
	`¡»¼Ü
(
”ºo
));

280 
	`adb_şo£
(
±m
);

284 *
pid
 = 
	`fÜk
();

285 if(*
pid
 < 0) {

286 
	`´štf
("- fÜk faed: % -\n", 
	`¡»¼Ü
(
”ºo
));

287 
	`adb_şo£
(
±m
);

291 if(*
pid
 == 0){

292 
±s
;

294 
	`£tsid
();

296 
±s
 = 
	`unix_İ’
(
devÇme
, 
O_RDWR
);

297 if(
±s
 < 0) {

298 
	`årštf
(
¡d”r
, "chd faedØİ’…£udo-‹rm sÏve: %s\n", 
devÇme
);

299 
	`ex™
(-1);

302 
	`dup2
(
±s
, 0);

303 
	`dup2
(
±s
, 1);

304 
	`dup2
(
±s
, 2);

306 
	`adb_şo£
(
±s
);

307 
	`adb_şo£
(
±m
);

310 
‹xt
[64];

311 
	`¢´štf
(
‹xt
, ext, "/´oc/%d/oom_adj", 
	`g‘pid
());

312 
fd
 = 
	`adb_İ’
(
‹xt
, 
O_WRONLY
);

313 ià(
fd
 >= 0) {

314 
	`adb_wr™e
(
fd
, "0", 1);

315 
	`adb_şo£
(
fd
);

317 
	`D
("adb: uÇbËØİ’ %s\n", 
‹xt
);

319 
	`exeş
(
cmd
, cmd, 
¬g0
, 
¬g1
, 
NULL
);

320 
	`årštf
(
¡d”r
, "-ƒxec '%s' failed: %s (%d) -\n",

321 
cmd
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

322 
	`ex™
(-1);

328  
±m
;

331 
	}
}

334 #ià
ADB_HOST


335 
	#SHELL_COMMAND
 "/bš/sh"

	)

337 
	#SHELL_COMMAND
 "/bš/adb_sh–l"

	)

340 #ià!
ADB_HOST


341 
	$sub´oc_wa™”_£rviû
(
fd
, *
cook›
)

343 
pid_t
 
pid
 = (pid_t)
cook›
;

345 
	`D
("’‹»d. fd=%d oàpid=%d\n", 
fd
, 
pid
);

347 
¡©us
;

348 
pid_t
 
p
 = 
	`wa™pid
(
pid
, &
¡©us
, 0);

349 ià(
p
 =ğ
pid
) {

350 
	`D
("fd=%d,…o¡ wa™pidÕid=%dè¡©us=%04x\n", 
fd
, 
p
, 
¡©us
);

351 ià(
	`WIFSIGNALED
(
¡©us
)) {

352 
	`D
("*** KËd by sigÇÈ%d\n", 
	`WTERMSIG
(
¡©us
));

354 } ià(!
	`WIFEXITED
(
¡©us
)) {

355 
	`D
("*** Didn'ˆex™!!. stu %d\n", 
¡©us
);

357 } ià(
	`WEXITSTATUS
(
¡©us
) >= 0) {

358 
	`D
("*** Ex™ cod%d\n", 
	`WEXITSTATUS
(
¡©us
));

363 
	`D
("sh–Èex™ed fd=%d oàpid=%dƒ¼=%d\n", 
fd
, 
pid
, 
”ºo
);

364 ià(
SHELL_EXIT_NOTIFY_FD
 >=0) {

365 
»s
;

366 
»s
 = 
	`wr™ex
(
SHELL_EXIT_NOTIFY_FD
, &
fd
, (fd));

367 
	`D
("notified shellƒxit via fd=%d for…id=%d„es=%dƒrrno=%d\n",

368 
SHELL_EXIT_NOTIFY_FD
, 
pid
, 
»s
, 
”ºo
);

370 
	}
}

372 
	$ü—‹_sub´oc_th»ad
(cÚ¡ *
Çme
)

374 
¡šfo
 *
¡i
;

375 
adb_th»ad_t
 
t
;

376 
»t_fd
;

377 
pid_t
 
pid
;

378 if(
Çme
) {

379 
»t_fd
 = 
	`ü—‹_sub´oûss
(
SHELL_COMMAND
, "-c", 
Çme
, &
pid
);

381 
»t_fd
 = 
	`ü—‹_sub´oûss
(
SHELL_COMMAND
, "-", 0, &
pid
);

383 
	`D
("ü—‹_sub´oûss(è»t_fd=%d…id=%d‚ame:%s\n", 
»t_fd
, 
pid
,
Çme
);

385 
¡i
 = 
	`m®loc
((
¡šfo
));

386 if(
¡i
 =ğ0è
	`çl
("cannot‡llocate stinfo");

387 
¡i
->
func
 = 
sub´oc_wa™”_£rviû
;

388 
¡i
->
cook›
 = (*)
pid
;

389 
¡i
->
fd
 = 
»t_fd
;

391 if(
	`adb_th»ad_ü—‹
Ğ&
t
, 
£rviû_boÙ¡¿p_func
, 
¡i
)){

392 
	`ä“
(
¡i
);

393 
	`adb_şo£
(
»t_fd
);

394 
	`´štf
("cannot create servicehread\n");

398 
	`D
("£rviûh»ad s¹ed, fd=%d…id=%d\n",
»t_fd
, 
pid
);

399  
»t_fd
;

400 
	}
}

403 
	$£rviû_to_fd
(cÚ¡ *
Çme
)

405 
»t
 = -1;

407 if(!
	`¡ºcmp
(
Çme
, "tcp:", 4)) {

408 
pÜt
 = 
	`©oi
(
Çme
 + 4);

409 
Çme
 = 
	`¡rchr
(name + 4, ':');

410 if(
Çme
 == 0) {

411 
»t
 = 
	`sock‘_loİback_ş›Á
(
pÜt
, 
SOCK_STREAM
);

412 ià(
»t
 >= 0)

413 
	`di§bË_tı_ÇgË
(
»t
);

415 #ià
ADB_HOST


416 
	`adb_mu‹x_lock
(&
dns_lock
);

417 
»t
 = 
	`sock‘_ÃtwÜk_ş›Á
(
Çme
 + 1, 
pÜt
, 
SOCK_STREAM
);

418 
	`adb_mu‹x_uÆock
(&
dns_lock
);

423 #iâdeà
HAVE_WINSOCK


424 } if(!
	`¡ºcmp
(
Çme
, "local:", 6)) {

425 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 6,

426 
ANDROID_SOCKET_NAMESPACE_RESERVED
, 
SOCK_STREAM
);

427 } if(!
	`¡ºcmp
(
Çme
, "localreserved:", 14)) {

428 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 14,

429 
ANDROID_SOCKET_NAMESPACE_RESERVED
, 
SOCK_STREAM
);

430 } if(!
	`¡ºcmp
(
Çme
, "localabstract:", 14)) {

431 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 14,

432 
ANDROID_SOCKET_NAMESPACE_ABSTRACT
, 
SOCK_STREAM
);

433 } if(!
	`¡ºcmp
(
Çme
, "localfilesystem:", 16)) {

434 
»t
 = 
	`sock‘_loÿl_ş›Á
(
Çme
 + 16,

435 
ANDROID_SOCKET_NAMESPACE_FILESYSTEM
, 
SOCK_STREAM
);

437 #ià
ADB_HOST


438 } if(!
	`¡ºcmp
("dns:", 
Çme
, 4)){

439 *
n
 = 
	`¡rdup
(
Çme
 + 4);

440 if(
n
 == 0)  -1;

441 
»t
 = 
	`ü—‹_£rviû_th»ad
(
dns_£rviû
, 
n
);

443 } if(!
	`¡ºcmp
("dev:", 
Çme
, 4)) {

444 
»t
 = 
	`unix_İ’
(
Çme
 + 4, 
O_RDWR
);

445 } if(!
	`¡ºcmp
(
Çme
, "framebuffer:", 12)) {

446 
»t
 = 
	`ü—‹_£rviû_th»ad
(
äamebufãr_£rviû
, 0);

447 } if(
»cov”y_mode
 && !
	`¡ºcmp
(
Çme
, "recover:", 8)) {

448 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»cov”_£rviû
, (*è
	`©oi
(
Çme
 + 8));

449 } ià(!
	`¡ºcmp
(
Çme
, "jdwp:", 5)) {

450 
»t
 = 
	`ü—‹_jdwp_cÚÃùiÚ_fd
(
	`©oi
(
Çme
+5));

451 } ià(!
	`¡ºcmp
(
Çme
, "log:", 4)) {

452 
»t
 = 
	`ü—‹_£rviû_th»ad
(
log_£rviû
, 
	`g‘_log_fe_·th
(
Çme
 + 4));

453 } if(!
HOST
 && !
	`¡ºcmp
(
Çme
, "shell:", 6)) {

454 if(
Çme
[6]) {

455 
»t
 = 
	`ü—‹_sub´oc_th»ad
(
Çme
 + 6);

457 
»t
 = 
	`ü—‹_sub´oc_th»ad
(0);

459 } if(!
	`¡ºcmp
(
Çme
, "sync:", 5)) {

460 
»t
 = 
	`ü—‹_£rviû_th»ad
(
fe_sync_£rviû
, 
NULL
);

461 } if(!
	`¡ºcmp
(
Çme
, "remount:", 8)) {

462 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»mouÁ_£rviû
, 
NULL
);

463 } if(!
	`¡ºcmp
(
Çme
, "reboot:", 7)) {

464 * 
¬g
 = 
	`¡rdup
(
Çme
 + 7);

465 if(
¬g
 == 0)  -1;

466 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»boÙ_£rviû
, 
¬g
);

467 } if(!
	`¡ºcmp
(
Çme
, "root:", 5)) {

468 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_roÙ_£rviû
, 
NULL
);

469 } if(!
	`¡ºcmp
(
Çme
, "backup:", 7)) {

470 * 
¬g
 = 
	`¡rdup
(
Çme
+7);

471 ià(
¬g
 =ğ
NULL
)  -1;

472 
»t
 = 
	`backup_£rviû
(
BACKUP
, 
¬g
);

473 } if(!
	`¡ºcmp
(
Çme
, "restore:", 8)) {

474 
»t
 = 
	`backup_£rviû
(
RESTORE
, 
NULL
);

475 } if(!
	`¡ºcmp
(
Çme
, "tcpip:", 6)) {

476 
pÜt
;

477 ià(
	`ssÿnf
(
Çme
 + 6, "%d", &
pÜt
) == 0) {

478 
pÜt
 = 0;

480 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_tı_£rviû
, (*)
pÜt
);

481 } if(!
	`¡ºcmp
(
Çme
, "usb:", 4)) {

482 
»t
 = 
	`ü—‹_£rviû_th»ad
(
»¡¬t_usb_£rviû
, 
NULL
);

485 } if(!
	`¡ºcmp
(
Çme
, "echo:", 5)){

486 
»t
 = 
	`ü—‹_£rviû_th»ad
(
echo_£rviû
, 0);

489 ià(
»t
 >= 0) {

490 
	`şo£_Ú_exec
(
»t
);

492  
»t
;

493 
	}
}

495 #ià
ADB_HOST


496 
	s¡©e_šfo
 {

497 
Œª¥Üt_ty³
 
	mŒª¥Üt
;

498 * 
	m£rŸl
;

499 
	m¡©e
;

502 
	$wa™_fÜ_¡©e
(
fd
, * 
cook›
)

504 
¡©e_šfo
* 
sšfo
 = 
cook›
;

505 * 
”r
 = "unknownƒrror";

507 
	`D
("wa™_fÜ_¡©%d\n", 
sšfo
->
¡©e
);

509 
©¿n¥Üt
 *
t
 = 
	`acquœe_Úe_Œª¥Üt
(
sšfo
->
¡©e
, sšfo->
Œª¥Üt
, sšfo->
£rŸl
, &
”r
);

510 if(
t
 != 0) {

511 
	`wr™ex
(
fd
, "OKAY", 4);

513 
	`£ndçmsg
(
fd
, 
”r
);

516 ià(
sšfo
->
£rŸl
)

517 
	`ä“
(
sšfo
->
£rŸl
);

518 
	`ä“
(
sšfo
);

519 
	`adb_şo£
(
fd
);

520 
	`D
("wait_for_state is done\n");

521 
	}
}

524 #ià
ADB_HOST


525 
asock‘
* 
	$ho¡_£rviû_to_sock‘
(cÚ¡ * 
Çme
, cÚ¡ *
£rŸl
)

527 ià(!
	`¡rcmp
(
Çme
,"track-devices")) {

528  
	`ü—‹_deviû_Œack”
();

529 } ià(!
	`¡ºcmp
(
Çme
, "wa™-fÜ-", 
	`¡¾’
("wait-for-"))) {

530 
¡©e_šfo
* 
sšfo
 = 
	`m®loc
((state_info));

532 ià(
£rŸl
)

533 
sšfo
->
£rŸl
 = 
	`¡rdup
(serial);

535 
sšfo
->
£rŸl
 = 
NULL
;

537 
Çme
 +ğ
	`¡¾’
("wait-for-");

539 ià(!
	`¡ºcmp
(
Çme
, "loÿl", 
	`¡¾’
("local"))) {

540 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtLoÿl
;

541 
sšfo
->
¡©e
 = 
CS_DEVICE
;

542 } ià(!
	`¡ºcmp
(
Çme
, "usb", 
	`¡¾’
("usb"))) {

543 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtUsb
;

544 
sšfo
->
¡©e
 = 
CS_DEVICE
;

545 } ià(!
	`¡ºcmp
(
Çme
, "ªy", 
	`¡¾’
("any"))) {

546 
sšfo
->
Œª¥Üt
 = 
kT¿n¥ÜtAny
;

547 
sšfo
->
¡©e
 = 
CS_DEVICE
;

549 
	`ä“
(
sšfo
);

550  
NULL
;

553 
fd
 = 
	`ü—‹_£rviû_th»ad
(
wa™_fÜ_¡©e
, 
sšfo
);

554  
	`ü—‹_loÿl_sock‘
(
fd
);

556  
NULL
;

557 
	}
}

	@sockets.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<”ºo.h
>

21 
	~<¡ršg.h
>

22 
	~<ùy³.h
>

24 
	~"sysd•s.h
"

26 
	#TRACE_TAG
 
TRACE_SOCKETS


	)

27 
	~"adb.h
"

29 
ADB_MUTEX_DEFINE
Ğ
sock‘_li¡_lock
 );

31 
loÿl_sock‘_şo£_locked
(
asock‘
 *
s
);

33 
	$£ndçmsg
(
fd
, cÚ¡ *
»asÚ
)

35 
buf
[9];

36 
Ën
;

37 
Ën
 = 
	`¡¾’
(
»asÚ
);

38 if(
Ën
 > 0xffff)†en = 0xffff;

39 
	`¢´štf
(
buf
,  buf, "FAIL%04x", 
Ën
);

40 if(
	`wr™ex
(
fd
, 
buf
, 8))  -1;

41  
	`wr™ex
(
fd
, 
»asÚ
, 
Ën
);

42 
	}
}

46 
	gloÿl_sock‘_Ãxt_id
 = 1;

48 
asock‘
 
	gloÿl_sock‘_li¡
 = {

49 .
Ãxt
 = &
loÿl_sock‘_li¡
,

50 .
	g´ev
 = &
loÿl_sock‘_li¡
,

57 
asock‘
 
	gloÿl_sock‘_şosšg_li¡
 = {

58 .
Ãxt
 = &
loÿl_sock‘_şosšg_li¡
,

59 .
	g´ev
 = &
loÿl_sock‘_şosšg_li¡
,

62 
asock‘
 *
	$fšd_loÿl_sock‘
(
id
)

64 
asock‘
 *
s
;

65 
asock‘
 *
»suÉ
 = 
NULL
;

67 
	`adb_mu‹x_lock
(&
sock‘_li¡_lock
);

68 
s
 = 
loÿl_sock‘_li¡
.
Ãxt
; s != &local_socket_list; s = s->next) {

69 ià(
s
->
id
 == id) {

70 
»suÉ
 = 
s
;

74 
	`adb_mu‹x_uÆock
(&
sock‘_li¡_lock
);

76  
»suÉ
;

77 
	}
}

80 
	$š£¹_loÿl_sock‘
(
asock‘
* 
s
,‡sock‘* 
li¡
)

82 
s
->
Ãxt
 = 
li¡
;

83 
s
->
´ev
 = s->
Ãxt
->prev;

84 
s
->
´ev
->
Ãxt
 = s;

85 
s
->
Ãxt
->
´ev
 = s;

86 
	}
}

89 
	$š¡®l_loÿl_sock‘
(
asock‘
 *
s
)

91 
	`adb_mu‹x_lock
(&
sock‘_li¡_lock
);

93 
s
->
id
 = 
loÿl_sock‘_Ãxt_id
++;

94 
	`š£¹_loÿl_sock‘
(
s
, &
loÿl_sock‘_li¡
);

96 
	`adb_mu‹x_uÆock
(&
sock‘_li¡_lock
);

97 
	}
}

99 
	$»move_sock‘
(
asock‘
 *
s
)

102 ià(
s
->
´ev
 && s->
Ãxt
)

104 
s
->
´ev
->
Ãxt
 = s->next;

105 
s
->
Ãxt
->
´ev
 = s->prev;

106 
s
->
Ãxt
 = 0;

107 
s
->
´ev
 = 0;

108 
s
->
id
 = 0;

110 
	}
}

112 
	$şo£_®l_sock‘s
(
©¿n¥Üt
 *
t
)

114 
asock‘
 *
s
;

119 
	`adb_mu‹x_lock
(&
sock‘_li¡_lock
);

120 
»¡¬t
:

121 
s
 = 
loÿl_sock‘_li¡
.
Ãxt
; s != &local_socket_list; s = s->next){

122 if(
s
->
Œª¥Üt
 =ğ
t
 || (s->
³”
 && s->peer->transport ==)) {

123 
	`loÿl_sock‘_şo£_locked
(
s
);

124 
»¡¬t
;

127 
	`adb_mu‹x_uÆock
(&
sock‘_li¡_lock
);

128 
	}
}

130 
	$loÿl_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

132 
	`D
("LS(%d):ƒnqueu%d\n", 
s
->
id
, 
p
->
Ën
);

134 
p
->
±r
 =…->
d©a
;

140 if(
s
->
pkt_fœ¡
) {

141 
’queue
;

147 
p
->
Ën
 > 0) {

148 
r
 = 
	`adb_wr™e
(
s
->
fd
, 
p
->
±r
,…->
Ën
);

149 if(
r
 > 0) {

150 
p
->
Ën
 -ğ
r
;

151 
p
->
±r
 +ğ
r
;

154 if((
r
 =ğ0è|| (
”ºo
 !ğ
EAGAIN
)) {

155 
	`D
Ğ"LS(%d):‚Ù„—dy,ƒ¼no=%d: %s\n", 
s
->
id
, 
”ºo
, 
	`¡»¼Ü
(errno) );

156 
s
->
	`şo£
(s);

163 if(
p
->
Ën
 == 0) {

164 
	`put_­ack‘
(
p
);

168 
’queue
:

169 
p
->
Ãxt
 = 0;

170 if(
s
->
pkt_fœ¡
) {

171 
s
->
pkt_Ï¡
->
Ãxt
 = 
p
;

173 
s
->
pkt_fœ¡
 = 
p
;

175 
s
->
pkt_Ï¡
 = 
p
;

178 
	`fdev’t_add
(&
s
->
fde
, 
FDE_WRITE
);

181 
	}
}

183 
	$loÿl_sock‘_»ady
(
asock‘
 *
s
)

187 
	`fdev’t_add
(&
s
->
fde
, 
FDE_READ
);

189 
	}
}

191 
	$loÿl_sock‘_şo£
(
asock‘
 *
s
)

193 
	`adb_mu‹x_lock
(&
sock‘_li¡_lock
);

194 
	`loÿl_sock‘_şo£_locked
(
s
);

195 
	`adb_mu‹x_uÆock
(&
sock‘_li¡_lock
);

196 
	}
}

199 
	$loÿl_sock‘_de¡roy
(
asock‘
 *
s
)

201 
­ack‘
 *
p
, *
n
;

202 
ex™_Ú_şo£
 = 
s
->exit_on_close;

204 
	`D
("LS(%d): de¡royšg fde.fd=%d\n", 
s
->
id
, s->
fde
.
fd
);

209 
	`fdev’t_»move
(&
s
->
fde
);

212 
p
 = 
s
->
pkt_fœ¡
;…;… = 
n
) {

213 
	`D
("LS(%d): disÿrdšg %d by‹s\n", 
s
->
id
, 
p
->
Ën
);

214 
n
 = 
p
->
Ãxt
;

215 
	`put_­ack‘
(
p
);

217 
	`»move_sock‘
(
s
);

218 
	`ä“
(
s
);

220 ià(
ex™_Ú_şo£
) {

221 
	`D
("local_socket_destroy:ƒxiting\n");

222 
	`ex™
(1);

224 
	}
}

227 
	$loÿl_sock‘_şo£_locked
(
asock‘
 *
s
)

229 
	`D
("’‹»d. LS(%dèfd=%d\n", 
s
->
id
, s->
fd
);

230 if(
s
->
³”
) {

231 
	`D
("LS(%d): closing…eer.…eer->id=%d…eer->fd=%d\n",

232 
s
->
id
, s->
³”
->id, s->³”->
fd
);

233 
s
->
³”
->peer = 0;

235 ià(
s
->
³”
->
şo£
 =ğ
loÿl_sock‘_şo£
) {

236 
	`loÿl_sock‘_şo£_locked
(
s
->
³”
);

238 
s
->
³”
->
	`şo£
(s->peer);

240 
s
->
³”
 = 0;

246 ià(
s
->
şosšg
 || s->
pkt_fœ¡
 =ğ
NULL
) {

247 
id
 = 
s
->id;

248 
	`loÿl_sock‘_de¡roy
(
s
);

249 
	`D
("LS(%d): clo£d\n", 
id
);

255 
	`D
("LS(%d): closšg\n", 
s
->
id
);

256 
s
->
şosšg
 = 1;

257 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_READ
);

258 
	`»move_sock‘
(
s
);

259 
	`D
("LS(%d):…uˆÚ sock‘_şosšg_li¡ fd=%d\n", 
s
->
id
, s->
fd
);

260 
	`š£¹_loÿl_sock‘
(
s
, &
loÿl_sock‘_şosšg_li¡
);

261 
	}
}

263 
	$loÿl_sock‘_ev’t_func
(
fd
, 
ev
, *
_s
)

265 
asock‘
 *
s
 = 
_s
;

267 
	`D
("LS(%d):ƒv’t_func(fd=%d(==%d),ƒv=%04x)\n", 
s
->
id
, s->
fd
, fd, 
ev
);

272 if(
ev
 & 
FDE_WRITE
){

273 
­ack‘
 *
p
;

275 (
p
 = 
s
->
pkt_fœ¡
) != 0) {

276 
p
->
Ën
 > 0) {

277 
r
 = 
	`adb_wr™e
(
fd
, 
p
->
±r
,…->
Ën
);

278 if(
r
 > 0) {

279 
p
->
±r
 +ğ
r
;

280 
p
->
Ën
 -ğ
r
;

283 if(
r
 < 0) {

287 if(
”ºo
 =ğ
EAGAIN
) ;

288 if(
”ºo
 =ğ
EINTR
) ;

290 
	`D
(" closšg‡á” wr™beÿu£„=%d‡ndƒ¼nØi %d\n", 
r
, 
”ºo
);

291 
s
->
	`şo£
(s);

295 if(
p
->
Ën
 == 0) {

296 
s
->
pkt_fœ¡
 = 
p
->
Ãxt
;

297 if(
s
->
pkt_fœ¡
 =ğ0ès->
pkt_Ï¡
 = 0;

298 
	`put_­ack‘
(
p
);

305 ià(
s
->
şosšg
) {

306 
	`D
(" closing because 'closing' is set‡fter write\n");

307 
s
->
	`şo£
(s);

315 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_WRITE
);

316 
s
->
³”
->
	`»ady
(s->peer);

320 if(
ev
 & 
FDE_READ
){

321 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

322 *
x
 = 
p
->
d©a
;

323 
size_t
 
ava
 = 
MAX_PAYLOAD
;

324 
r
;

325 
is_eof
 = 0;

327 
ava
 > 0) {

328 
r
 = 
	`adb_»ad
(
fd
, 
x
, 
ava
);

329 
	`D
("LS(%d):…o¡‡db_»ad(fd=%d,...èr=%d (”ºo=%dèava=%d\n", 
s
->
id
, s->
fd
, 
r
,„<0?
”ºo
:0, 
ava
);

330 if(
r
 > 0) {

331 
ava
 -ğ
r
;

332 
x
 +ğ
r
;

335 if(
r
 < 0) {

336 if(
”ºo
 =ğ
EAGAIN
) ;

337 if(
”ºo
 =ğ
EINTR
) ;

341 
is_eof
 = 1;

344 
	`D
("LS(%d): fd=%d…ost‡vail†oop.„=%d is_eof=%d forced_eof=%d\n",

345 
s
->
id
, s->
fd
, 
r
, 
is_eof
, s->
fde
.
fÜû_eof
);

346 if((
ava
 =ğ
MAX_PAYLOAD
è|| (
s
->
³”
 == 0)) {

347 
	`put_­ack‘
(
p
);

349 
p
->
Ën
 = 
MAX_PAYLOAD
 - 
ava
;

351 
r
 = 
s
->
³”
->
	`’queue
(s->³”, 
p
);

352 
	`D
("LS(%d): fd=%d…o¡…“r->’queue().„=%d\n", 
s
->
id
, s->
fd
, 
r
);

354 if(
r
 < 0) {

366 if(
r
 > 0) {

371 
	`fdev’t_d–
(&
s
->
fde
, 
FDE_READ
);

375 if((
s
->
fde
.
fÜû_eof
 && !
r
è|| 
is_eof
) {

376 
	`D
(" closšg beÿu£ is_eof=%d„=%d s->fde.fÜû_eof=%d\n", 
is_eof
, 
r
, 
s
->
fde
.
fÜû_eof
);

377 
s
->
	`şo£
(s);

381 if(
ev
 & 
FDE_ERROR
){

387 
	`D
("LS(%d): FDE_ERROR (fd=%d)\n", 
s
->
id
, s->
fd
);

391 
	}
}

393 
asock‘
 *
	$ü—‹_loÿl_sock‘
(
fd
)

395 
asock‘
 *
s
 = 
	`ÿÎoc
(1, (asocket));

396 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

397 
s
->
fd
 = fd;

398 
s
->
’queue
 = 
loÿl_sock‘_’queue
;

399 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

400 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

401 
	`š¡®l_loÿl_sock‘
(
s
);

403 
	`fdev’t_š¡®l
(&
s
->
fde
, 
fd
, 
loÿl_sock‘_ev’t_func
, s);

406 
	`D
("LS(%d): c»©ed (fd=%d)\n", 
s
->
id
, s->
fd
);

407  
s
;

408 
	}
}

410 
asock‘
 *
	$ü—‹_loÿl_£rviû_sock‘
(cÚ¡ *
Çme
)

412 
asock‘
 *
s
;

413 
fd
;

415 #ià!
ADB_HOST


416 ià(!
	`¡rcmp
(
Çme
,"jdwp")) {

417  
	`ü—‹_jdwp_£rviû_sock‘
();

419 ià(!
	`¡rcmp
(
Çme
,"track-jdwp")) {

420  
	`ü—‹_jdwp_Œack”_£rviû_sock‘
();

423 
fd
 = 
	`£rviû_to_fd
(
Çme
);

424 if(
fd
 < 0)  0;

426 
s
 = 
	`ü—‹_loÿl_sock‘
(
fd
);

427 
	`D
("LS(%d): boundØ'%s' vŸ %d\n", 
s
->
id
, 
Çme
, 
fd
);

429 #ià!
ADB_HOST


430 ià((!
	`¡ºcmp
(
Çme
, "roÙ:", 5è&& 
	`g‘uid
() != 0)

431 || !
	`¡ºcmp
(
Çme
, "usb:", 4)

432 || !
	`¡ºcmp
(
Çme
, "tcpip:", 6)) {

433 
	`D
("LS(%d):ƒÇblšgƒx™_Ú_şo£\n", 
s
->
id
);

434 
s
->
ex™_Ú_şo£
 = 1;

438  
s
;

439 
	}
}

441 #ià
ADB_HOST


442 
asock‘
 *
	$ü—‹_ho¡_£rviû_sock‘
(cÚ¡ *
Çme
, cÚ¡ * 
£rŸl
)

444 
asock‘
 *
s
;

446 
s
 = 
	`ho¡_£rviû_to_sock‘
(
Çme
, 
£rŸl
);

448 ià(
s
 !ğ
NULL
) {

449 
	`D
("LS(%dèboundØ'%s'\n", 
s
->
id
, 
Çme
);

450  
s
;

453  
s
;

454 
	}
}

460 
	s¬emÙesock‘
 {

461 
asock‘
 
	msock‘
;

462 
adiscÚÃù
 
	mdiscÚÃù
;

463 } 
	t¬emÙesock‘
;

465 
	$»mÙe_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

467 
	`D
("entered„emote_socket_enqueue RS(%d) WRITE fd=%d…eer.fd=%d\n",

468 
s
->
id
, s->
fd
, s->
³”
->fd);

469 
p
->
msg
.
commªd
 = 
A_WRTE
;

470 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

471 
p
->
msg
.
¬g1
 = 
s
->
id
;

472 
p
->
msg
.
d©a_Ëngth
 =…->
Ën
;

473 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

475 
	}
}

477 
	$»mÙe_sock‘_»ady
(
asock‘
 *
s
)

479 
	`D
("entered„emote_socket_ready RS(%d) OKAY fd=%d…eer.fd=%d\n",

480 
s
->
id
, s->
fd
, s->
³”
->fd);

481 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

482 
p
->
msg
.
commªd
 = 
A_OKAY
;

483 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

484 
p
->
msg
.
¬g1
 = 
s
->
id
;

485 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

486 
	}
}

488 
	$»mÙe_sock‘_şo£
(
asock‘
 *
s
)

490 
	`D
("entered„emote_socket_close RS(%d) CLOSE fd=%d…eer->fd=%d\n",

491 
s
->
id
, s->
fd
, s->
³”
?s->peer->fd:-1);

492 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

493 
p
->
msg
.
commªd
 = 
A_CLSE
;

494 if(
s
->
³”
) {

495 
p
->
msg
.
¬g0
 = 
s
->
³”
->
id
;

496 
s
->
³”
->peer = 0;

497 
	`D
("RS(%d)…eer->close()ing…eer->id=%d…eer->fd=%d\n",

498 
s
->
id
, s->
³”
->id, s->³”->
fd
);

499 
s
->
³”
->
	`şo£
(s->peer);

501 
p
->
msg
.
¬g1
 = 
s
->
id
;

502 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

503 
	`D
("RS(%d): clo£d\n", 
s
->
id
);

504 
	`»move_Œª¥Üt_discÚÃù
Ğ
s
->
Œª¥Üt
, &((
¬emÙesock‘
*)s)->
discÚÃù
 );

505 
	`ä“
(
s
);

506 
	}
}

508 
	$»mÙe_sock‘_discÚÃù
(* 
_s
, 
©¿n¥Üt
* 
t
)

510 
asock‘
* 
s
 = 
_s
;

511 
asock‘
* 
³”
 = 
s
->peer;

513 
	`D
("»mÙe_sock‘_discÚÃù RS(%d)\n", 
s
->
id
);

514 ià(
³”
) {

515 
³”
->³” = 
NULL
;

516 
³”
->
	`şo£
(peer);

518 
	`»move_Œª¥Üt_discÚÃù
Ğ
s
->
Œª¥Üt
, &((
¬emÙesock‘
*)s)->
discÚÃù
 );

519 
	`ä“
(
s
);

520 
	}
}

522 
asock‘
 *
	$ü—‹_»mÙe_sock‘
(
id
, 
©¿n¥Üt
 *
t
)

524 
asock‘
 *
s
 = 
	`ÿÎoc
(1, (
¬emÙesock‘
));

525 
adiscÚÃù
* 
dis
 = &((
¬emÙesock‘
*)
s
)->
discÚÃù
;

527 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

528 
s
->
id
 = id;

529 
s
->
’queue
 = 
»mÙe_sock‘_’queue
;

530 
s
->
»ady
 = 
»mÙe_sock‘_»ady
;

531 
s
->
şo£
 = 
»mÙe_sock‘_şo£
;

532 
s
->
Œª¥Üt
 = 
t
;

534 
dis
->
func
 = 
»mÙe_sock‘_discÚÃù
;

535 
dis
->
İaque
 = 
s
;

536 
	`add_Œª¥Üt_discÚÃù
Ğ
t
, 
dis
 );

537 
	`D
("RS(%d): c»©ed\n", 
s
->
id
);

538  
s
;

539 
	}
}

541 
	$cÚÃù_to_»mÙe
(
asock‘
 *
s
, cÚ¡ *
de¡š©iÚ
)

543 
	`D
("CÚÃù_to_»mÙÿÎ RS(%dèfd=%d\n", 
s
->
id
, s->
fd
);

544 
­ack‘
 *
p
 = 
	`g‘_­ack‘
();

545 
Ën
 = 
	`¡¾’
(
de¡š©iÚ
) + 1;

547 if(
Ën
 > (
MAX_PAYLOAD
-1)) {

548 
	`çl
("destination oversized");

551 
	`D
("LS(%d): cÚÃù('%s')\n", 
s
->
id
, 
de¡š©iÚ
);

552 
p
->
msg
.
commªd
 = 
A_OPEN
;

553 
p
->
msg
.
¬g0
 = 
s
->
id
;

554 
p
->
msg
.
d©a_Ëngth
 = 
Ën
;

555 
	`¡rıy
((*è
p
->
d©a
, 
de¡š©iÚ
);

556 
	`£nd_·ck‘
(
p
, 
s
->
Œª¥Üt
);

557 
	}
}

562 
	$loÿl_sock‘_»ady_nÙify
(
asock‘
 *
s
)

564 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

565 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

566 
	`adb_wr™e
(
s
->
fd
, "OKAY", 4);

567 
s
->
	`»ady
(s);

568 
	}
}

573 
	$loÿl_sock‘_şo£_nÙify
(
asock‘
 *
s
)

575 
s
->
»ady
 = 
loÿl_sock‘_»ady
;

576 
s
->
şo£
 = 
loÿl_sock‘_şo£
;

577 
	`£ndçmsg
(
s
->
fd
, "closed");

578 
s
->
	`şo£
(s);

579 
	}
}

581 
	$unhex
(*
s
, 
Ën
)

583 
n
 = 0, 
c
;

585 
Ën
-- > 0) {

586 (
c
 = *
s
++)) {

591 
c
 -= '0';

595 
c
 = c - 'a' + 10;

599 
c
 = c - 'A' + 10;

605 
n
 = (À<< 4è| 
c
;

608  
n
;

609 
	}
}

611 
	#PREFIX
(
¡r
è{ sŒ, (¡rè- 1 }

	)

612 cÚ¡ 
	s´efix_¡ruù
 {

613 cÚ¡ *
	m¡r
;

614 cÚ¡ 
size_t
 
	mËn
;

615 } 
	g´efixes
[] = {

616 
PREFIX
("usb:"),

617 
PREFIX
("product:"),

618 
PREFIX
("model:"),

619 
PREFIX
("device:"),

621 cÚ¡ 
	gnum_´efixes
 = ((
´efixes
) / (prefixes[0]));

627 *
	$sk_ho¡_£rŸl
(*
£rviû
) {

628 *
fœ¡_cŞÚ
, *
£rŸl_’d
;

629 
i
;

631 
i
 = 0; i < 
num_´efixes
; i++) {

632 ià(!
	`¡ºcmp
(
£rviû
, 
´efixes
[
i
].
¡r
,…»fixes[i].
Ën
))

633  
	`¡rchr
(
£rviû
 + 
´efixes
[
i
].
Ën
, ':');

636 
fœ¡_cŞÚ
 = 
	`¡rchr
(
£rviû
, ':');

637 ià(!
fœ¡_cŞÚ
) {

639  
NULL
;

641 
£rŸl_’d
 = 
fœ¡_cŞÚ
;

642 ià(
	`isdig™
(
£rŸl_’d
[1])) {

643 
£rŸl_’d
++;

644 (*
£rŸl_’d
è&& 
	`isdig™
(*serial_end)) {

645 
£rŸl_’d
++;

647 ià((*
£rŸl_’d
) != ':') {

649 
£rŸl_’d
 = 
fœ¡_cŞÚ
;

652  
£rŸl_’d
;

653 
	}
}

655 
	$sm¬t_sock‘_’queue
(
asock‘
 *
s
, 
­ack‘
 *
p
)

657 
Ën
;

658 #ià
ADB_HOST


659 *
£rviû
 = 
NULL
;

660 * 
£rŸl
 = 
NULL
;

661 
Œª¥Üt_ty³
 
‰y³
 = 
kT¿n¥ÜtAny
;

664 
	`D
("SS(%d):ƒnqueu%d\n", 
s
->
id
, 
p
->
Ën
);

666 if(
s
->
pkt_fœ¡
 == 0) {

667 
s
->
pkt_fœ¡
 = 
p
;

668 
s
->
pkt_Ï¡
 = 
p
;

670 if((
s
->
pkt_fœ¡
->
Ën
 + 
p
->Ënè> 
MAX_PAYLOAD
) {

671 
	`D
("SS(%d): ov”æow\n", 
s
->
id
);

672 
	`put_­ack‘
(
p
);

673 
ç
;

676 
	`memıy
(
s
->
pkt_fœ¡
->
d©a
 + s->pkt_fœ¡->
Ën
,

677 
p
->
d©a
,…->
Ën
);

678 
s
->
pkt_fœ¡
->
Ën
 +ğ
p
->len;

679 
	`put_­ack‘
(
p
);

681 
p
 = 
s
->
pkt_fœ¡
;

685 if(
p
->
Ën
 < 4)  0;

687 
Ën
 = 
	`unhex
(
p
->
d©a
, 4);

688 if((
Ën
 < 1) || (len > 1024)) {

689 
	`D
("SS(%d): bad siz(%d)\n", 
s
->
id
, 
Ën
);

690 
ç
;

693 
	`D
("SS(%d):†’ i %d\n", 
s
->
id
, 
Ën
 );

695 if((
Ën
 + 4è> 
p
->len) {

696 
	`D
("SS(%d): wa™šg fÜ %d mÜby‹s\n", 
s
->
id
, 
Ën
+4 - 
p
->len);

700 
p
->
d©a
[
Ën
 + 4] = 0;

702 
	`D
("SS(%d): '%s'\n", 
s
->
id
, (*è(
p
->
d©a
 + 4));

704 #ià
ADB_HOST


705 
£rviû
 = (*)
p
->
d©a
 + 4;

706 if(!
	`¡ºcmp
(
£rviû
, "ho¡-£rŸl:", 
	`¡¾’
("host-serial:"))) {

707 * 
£rŸl_’d
;

708 
£rviû
 +ğ
	`¡¾’
("host-serial:");

711 
£rŸl_’d
 = 
	`sk_ho¡_£rŸl
(
£rviû
);

712 ià(
£rŸl_’d
) {

713 *
£rŸl_’d
 = 0;

714 
£rŸl
 = 
£rviû
;

715 
£rviû
 = 
£rŸl_’d
 + 1;

717 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡-usb:", 
	`¡¾’
("host-usb:"))) {

718 
‰y³
 = 
kT¿n¥ÜtUsb
;

719 
£rviû
 +ğ
	`¡¾’
("host-usb:");

720 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡-loÿl:", 
	`¡¾’
("host-local:"))) {

721 
‰y³
 = 
kT¿n¥ÜtLoÿl
;

722 
£rviû
 +ğ
	`¡¾’
("host-local:");

723 } ià(!
	`¡ºcmp
(
£rviû
, "ho¡:", 
	`¡¾’
("host:"))) {

724 
‰y³
 = 
kT¿n¥ÜtAny
;

725 
£rviû
 +ğ
	`¡¾’
("host:");

727 
£rviû
 = 
NULL
;

730 ià(
£rviû
) {

731 
asock‘
 *
s2
;

738 if(
	`hªdË_ho¡_»que¡
(
£rviû
, 
‰y³
, 
£rŸl
, 
s
->
³”
->
fd
, s) == 0) {

740 
	`D
Ğ"SS(%d): hªdËd ho¡ s”viû '%s'\n", 
s
->
id
, 
£rviû
 );

741 
ç
;

743 ià(!
	`¡ºcmp
(
£rviû
, "Œª¥Üt", 
	`¡¾’
("transport"))) {

744 
	`D
Ğ"SS(%d): okay¿n¥Üt\n", 
s
->
id
 );

745 
p
->
Ën
 = 0;

753 
s2
 = 
	`ü—‹_ho¡_£rviû_sock‘
(
£rviû
, 
£rŸl
);

754 if(
s2
 == 0) {

755 
	`D
Ğ"SS(%d): couldn'ˆü—‹ ho¡ s”viû '%s'\n", 
s
->
id
, 
£rviû
 );

756 
	`£ndçmsg
(
s
->
³”
->
fd
, "unknown host service");

757 
ç
;

767 
	`adb_wr™e
(
s
->
³”
->
fd
, "OKAY", 4);

769 
s
->
³”
->
»ady
 = 
loÿl_sock‘_»ady
;

770 
s
->
³”
->
şo£
 = 
loÿl_sock‘_şo£
;

771 
s
->
³”
->³” = 
s2
;

772 
s2
->
³”
 = 
s
->peer;

773 
s
->
³”
 = 0;

774 
	`D
Ğ"SS(%d): okay\n", 
s
->
id
 );

775 
s
->
	`şo£
(s);

778 
s2
->
	`»ady
(s2);

782 ià(
s
->
Œª¥Üt
 =ğ
NULL
) {

783 * 
”rÜ_¡ršg
 = "unknown failure";

784 
s
->
Œª¥Üt
 = 
	`acquœe_Úe_Œª¥Üt
 (
CS_ANY
,

785 
kT¿n¥ÜtAny
, 
NULL
, &
”rÜ_¡ršg
);

787 ià(
s
->
Œª¥Üt
 =ğ
NULL
) {

788 
	`£ndçmsg
(
s
->
³”
->
fd
, 
”rÜ_¡ršg
);

789 
ç
;

794 if(!(
s
->
Œª¥Üt
è|| (s->Œª¥Üt->
cÚÃùiÚ_¡©e
 =ğ
CS_OFFLINE
)) {

798 
	`£ndçmsg
(
s
->
³”
->
fd
, "device offline (x)");

799 
ç
;

808 
s
->
³”
->
»ady
 = 
loÿl_sock‘_»ady_nÙify
;

809 
s
->
³”
->
şo£
 = 
loÿl_sock‘_şo£_nÙify
;

810 
s
->
³”
->peer = 0;

812 
s
->
³”
->
Œª¥Üt
 = s->transport;

814 
	`cÚÃù_to_»mÙe
(
s
->
³”
, (*è(
p
->
d©a
 + 4));

815 
s
->
³”
 = 0;

816 
s
->
	`şo£
(s);

819 
ç
:

824 
s
->
	`şo£
(s);

826 
	}
}

828 
	$sm¬t_sock‘_»ady
(
asock‘
 *
s
)

830 
	`D
("SS(%d):„—dy\n", 
s
->
id
);

831 
	}
}

833 
	$sm¬t_sock‘_şo£
(
asock‘
 *
s
)

835 
	`D
("SS(%d): clo£d\n", 
s
->
id
);

836 if(
s
->
pkt_fœ¡
){

837 
	`put_­ack‘
(
s
->
pkt_fœ¡
);

839 if(
s
->
³”
) {

840 
s
->
³”
->peer = 0;

841 
s
->
³”
->
	`şo£
(s->peer);

842 
s
->
³”
 = 0;

844 
	`ä“
(
s
);

845 
	}
}

847 
asock‘
 *
ü—‹_sm¬t_sock‘
((*
aùiÚ_cb
)×sock‘ *
s
, cÚ¡ *
aù
))

849 
	`D
("Creating smart socket \n");

850 
asock‘
 *
s
 = 
	`ÿÎoc
(1, (asocket));

851 ià(
s
 =ğ
NULL
è
	`çl
("cannot‡llocate socket");

852 
s
->
’queue
 = 
sm¬t_sock‘_’queue
;

853 
s
->
»ady
 = 
sm¬t_sock‘_»ady
;

854 
s
->
şo£
 = 
sm¬t_sock‘_şo£
;

855 
s
->
exŒa
 = 
aùiÚ_cb
;

857 
	`D
("SS(%d): c»©ed %p\n", 
s
->
id
, 
aùiÚ_cb
);

858  
s
;

859 
	}
}

861 
	$sm¬t_sock‘_aùiÚ
(
asock‘
 *
s
, cÚ¡ *
aù
)

864 
	}
}

866 
	$cÚÃù_to_sm¬tsock‘
(
asock‘
 *
s
)

868 
	`D
("Connectingo smart socket \n");

869 
asock‘
 *
ss
 = 
	`ü—‹_sm¬t_sock‘
(
sm¬t_sock‘_aùiÚ
);

870 
s
->
³”
 = 
ss
;

871 
ss
->
³”
 = 
s
;

872 
s
->
	`»ady
(s);

873 
	}
}

	@sysdeps.h

20 #iâdeà
_ADB_SYSDEPS_H


21 
	#_ADB_SYSDEPS_H


	)

23 #ifdeà
__CYGWIN__


24 #undeà
_WIN32


27 #ifdeà
_WIN32


29 
	~<wšdows.h
>

30 
	~<wšsock2.h
>

31 
	~<ws2tı.h
>

32 
	~<´oûss.h
>

33 
	~<fú.h
>

34 
	~<io.h
>

35 
	~<sys/¡©.h
>

36 
	~<”ºo.h
>

37 
	~<ùy³.h
>

39 
	#OS_PATH_SEPARATOR
 '\\'

	)

40 
	#OS_PATH_SEPARATOR_STR
 "\\"

	)

41 
	#ENV_PATH_SEPARATOR_STR
 ";"

	)

43 
CRITICAL_SECTION
 
	tadb_mu‹x_t
;

45 
	#ADB_MUTEX_DEFINE
(
x
è
adb_mu‹x_t
 
	)
x

49 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

50 
	~"mu‹x_li¡.h
"

52 
adb_sysd•s_š™
();

54 
__šlše__
 
	$adb_mu‹x_lock
Ğ
adb_mu‹x_t
* 
lock
 )

56 
	`EÁ”Cr™iÿlSeùiÚ
Ğ
lock
 );

57 
	}
}

59 
__šlše__
 
	$adb_mu‹x_uÆock
Ğ
adb_mu‹x_t
* 
lock
 )

61 
	`L—veCr™iÿlSeùiÚ
Ğ
lock
 );

62 
	}
}

64 ¡ruù { 
	mtid
; } 
	tadb_th»ad_t
;

66 * (*
	tadb_th»ad_func_t
)(* 
	t¬g
);

68 (*
	twš_th»ad_func_t
)(* 
	t¬g
);

70 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
th»ad
, 
adb_th»ad_func_t
 
func
, * 
¬g
)

72 
th»ad
->
tid
 = 
	`_begšth»ad
Ğ(
wš_th»ad_func_t
)
func
, 0, 
¬g
 );

73 ià(
th»ad
->
tid
 == ()-1L) {

77 
	}
}

79 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

82 
	}
}

84 
di§bË_tı_ÇgË
(
fd
);

86 
	#l¡©
 
¡©


	)

88 
	#S_ISLNK
(
m
è0

	)

90 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

92 
rc
 = 
	`uÆšk
(
·th
);

94 ià(
rc
 =ğ-1 && 
”ºo
 =ğ
EACCES
) {

97 
rc
 = 
	`chmod
(
·th
, 
_S_IREAD
|
_S_IWRITE
 );

98 ià(
rc
 == 0)

99 
rc
 = 
	`uÆšk
(
·th
);

101  
rc
;

102 
	}
}

103 #undeà
uÆšk


104 
	#uÆšk
 
___xxx_uÆšk


	)

106 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

108  
	`_mkdœ
(
·th
);

109 
	}
}

110 #undeà
mkdœ


111 
	#mkdœ
 
___xxx_mkdœ


	)

113 
adb_İ’
(cÚ¡ * 
·th
, 
İtiÚs
);

114 
adb_ü—t
(cÚ¡ * 
·th
, 
mode
);

115 
adb_»ad
(
fd
, * 
buf
, 
Ën
);

116 
adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
Ën
);

117 
adb_l£ek
(
fd
, 
pos
, 
wh”e
);

118 
adb_shutdown
(
fd
);

119 
adb_şo£
(
fd
);

121 
__šlše__
 
	$unix_şo£
(
fd
)

123  
	`şo£
(
fd
);

124 
	}
}

125 #undeà
şo£


126 
	#şo£
 
____xxx_şo£


	)

128 
__šlše__
 
	$unix_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
)

130  
	`»ad
(
fd
, 
buf
, 
Ën
);

131 
	}
}

132 #undeà
»ad


133 
	#»ad
 
___xxx_»ad


	)

135 
__šlše__
 
	$unix_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

137  
	`wr™e
(
fd
, 
buf
, 
Ën
);

138 
	}
}

139 #undeà
wr™e


140 
	#wr™e
 
___xxx_wr™e


	)

142 
__šlše__
 
	$adb_İ’_mode
(cÚ¡ * 
·th
, 
İtiÚs
, 
mode
)

144  
	`adb_İ’
(
·th
, 
İtiÚs
);

145 
	}
}

147 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

149 ià((
İtiÚs
 & 
O_CREAT
) == 0)

151  
	`İ’
(
·th
, 
İtiÚs
);

155 
mode
;

156 
va_li¡
 
¬gs
;

157 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

158 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

159 
	`va_’d
Ğ
¬gs
 );

160  
	`İ’
(
·th
, 
İtiÚs
, 
mode
);

162 
	}
}

163 
	#İ’
 
___xxx_unix_İ’


	)

167 * 
lßd_fe
(cÚ¡ * 
·thÇme
, * 
psize
);

170 
sock‘_loİback_ş›Á
(
pÜt
, 
ty³
);

171 
sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
);

172 
sock‘_loİback_£rv”
(
pÜt
, 
ty³
);

173 
sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
);

177 
	#FDE_READ
 0x0001

	)

178 
	#FDE_WRITE
 0x0002

	)

179 
	#FDE_ERROR
 0x0004

	)

180 
	#FDE_DONT_CLOSE
 0x0080

	)

182 
fdev’t
 
	tfdev’t
;

184 (*
	tfd_func
)(
	tfd
, 
	tev’ts
, *
	tu£rd©a
);

186 
fdev’t
 *
	`fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
);

187 
	`fdev’t_de¡roy
(
fdev’t
 *
fde
);

188 
	`fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
);

189 
	`fdev’t_»move
(
fdev’t
 *
™em
);

190 
	`fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
);

191 
	`fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
);

192 
	`fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
);

193 
	`fdev’t_loİ
();

195 
	sfdev’t
 {

196 
fdev’t
 *
Ãxt
;

197 
fdev’t
 *
´ev
;

199 
fd
;

200 
fÜû_eof
;

202 
¡©e
;

203 
ev’ts
;

205 
fd_func
 
func
;

206 *
¬g
;

209 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

211 
	`SË•
Ğ
m£cÚds
 );

212 
	}
}

214 
adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
);

216 #undeà
acû±


217 
	#acû±
 
___xxx_acû±


	)

219 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

221 
İt
 = 
bufsize
;

222  
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, (cÚ¡ *)&
İt
, (opt));

223 
	}
}

225 
adb_sock‘·œ
Ğ
sv
[2] );

227 
__šlše__
 * 
	$adb_dœ¡¬t
ĞcÚ¡ * 
·th
 )

229 * 
p
 = 
	`¡rchr
(
·th
, '/');

230 * 
p2
 = 
	`¡rchr
(
·th
, '\\');

232 iàĞ!
p
 )

233 
p
 = 
p2
;

234 iàĞ
p2
 &&…2 > 
p
 )

235 
p
 = 
p2
;

237  
p
;

238 
	}
}

240 
__šlše__
 * 
	$adb_dœ¡İ
ĞcÚ¡ * 
·th
 )

242 * 
p
 = 
	`¡¼chr
(
·th
, '/');

243 * 
p2
 = 
	`¡¼chr
(
·th
, '\\');

245 iàĞ!
p
 )

246 
p
 = 
p2
;

247 iàĞ
p2
 &&…2 > 
p
 )

248 
p
 = 
p2
;

250  
p
;

251 
	}
}

253 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

255  
	`i§Íha
(
·th
[0]) &&…ath[1] == ':' &&…ath[2] == '\\';

256 
	}
}

258 * 
adb_¡¹ok_r
(*
¡r
, cÚ¡ *
d–im
, **
§v•Œ
);

262 
	~"fdev’t.h
"

263 
	~<cuts/sock‘s.h
>

264 
	~<cuts/´İ”t›s.h
>

265 
	~<cuts/misc.h
>

266 
	~<sigÇl.h
>

267 
	~<sys/wa™.h
>

268 
	~<sys/¡©.h
>

269 
	~<fú.h
>

271 
	~<±h»ad.h
>

272 
	~<uni¡d.h
>

273 
	~<fú.h
>

274 
	~<¡d¬g.h
>

275 
	~<Ãtš‘/š.h
>

276 
	~<Ãtš‘/tı.h
>

277 
	~<¡ršg.h
>

279 
	#OS_PATH_SEPARATOR
 '/'

	)

280 
	#OS_PATH_SEPARATOR_STR
 "/"

	)

281 
	#ENV_PATH_SEPARATOR_STR
 ":"

	)

283 
±h»ad_mu‹x_t
 
	tadb_mu‹x_t
;

285 
	#ADB_MUTEX_INITIALIZER
 
PTHREAD_MUTEX_INITIALIZER


	)

286 
	#adb_mu‹x_š™
 
±h»ad_mu‹x_š™


	)

287 
	#adb_mu‹x_lock
 
±h»ad_mu‹x_lock


	)

288 
	#adb_mu‹x_uÆock
 
±h»ad_mu‹x_uÆock


	)

289 
	#adb_mu‹x_de¡roy
 
±h»ad_mu‹x_de¡roy


	)

291 
	#ADB_MUTEX_DEFINE
(
m
è
adb_mu‹x_t
 m = 
PTHREAD_MUTEX_INITIALIZER


	)

293 
	#adb_cÚd_t
 
±h»ad_cÚd_t


	)

294 
	#adb_cÚd_š™
 
±h»ad_cÚd_š™


	)

295 
	#adb_cÚd_wa™
 
±h»ad_cÚd_wa™


	)

296 
	#adb_cÚd_brßdÿ¡
 
±h»ad_cÚd_brßdÿ¡


	)

297 
	#adb_cÚd_sigÇl
 
±h»ad_cÚd_sigÇl


	)

298 
	#adb_cÚd_de¡roy
 
±h»ad_cÚd_de¡roy


	)

301 
	#ADB_MUTEX
(
x
è
adb_mu‹x_t
 x;

	)

302 
	~"mu‹x_li¡.h
"

304 
__šlše__
 
	$şo£_Ú_exec
(
fd
)

306 
	`fú
Ğ
fd
, 
F_SETFD
, 
FD_CLOEXEC
 );

307 
	}
}

309 
__šlše__
 
	$unix_İ’
(cÚ¡ * 
·th
, 
İtiÚs
,...)

311 ià((
İtiÚs
 & 
O_CREAT
) == 0)

313  
	`İ’
(
·th
, 
İtiÚs
);

317 
mode
;

318 
va_li¡
 
¬gs
;

319 
	`va_¡¬t
Ğ
¬gs
, 
İtiÚs
 );

320 
mode
 = 
	`va_¬g
Ğ
¬gs
, );

321 
	`va_’d
Ğ
¬gs
 );

322  
	`İ’
(
·th
, 
İtiÚs
, 
mode
);

324 
	}
}

326 
__šlše__
 
	$adb_İ’_mode
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
, 
mode
 )

328  
	`İ’
Ğ
·thÇme
, 
İtiÚs
, 
mode
 );

329 
	}
}

332 
__šlše__
 
	$adb_İ’
ĞcÚ¡ * 
·thÇme
, 
İtiÚs
 )

334 
fd
 = 
	`İ’
Ğ
·thÇme
, 
İtiÚs
 );

335 ià(
fd
 < 0)

337 
	`şo£_Ú_exec
Ğ
fd
 );

338  
fd
;

339 
	}
}

340 #undeà
İ’


341 
	#İ’
 
___xxx_İ’


	)

343 
__šlše__
 
	$adb_shutdown
(
fd
)

345  
	`shutdown
(
fd
, 
SHUT_RDWR
);

346 
	}
}

347 #undeà
shutdown


348 
	#shutdown
 
____xxx_shutdown


	)

350 
__šlše__
 
	$adb_şo£
(
fd
)

352  
	`şo£
(
fd
);

353 
	}
}

354 #undeà
şo£


355 
	#şo£
 
____xxx_şo£


	)

358 
__šlše__
 
	$adb_»ad
(
fd
, * 
buf
, 
size_t
 
Ën
)

360  
	`»ad
(
fd
, 
buf
, 
Ën
);

361 
	}
}

363 #undeà
»ad


364 
	#»ad
 
___xxx_»ad


	)

366 
__šlše__
 
	$adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
size_t
 
Ën
)

368  
	`wr™e
(
fd
, 
buf
, 
Ën
);

369 
	}
}

370 #undeà
wr™e


371 
	#wr™e
 
___xxx_wr™e


	)

373 
__šlše__
 
	$adb_l£ek
(
fd
, 
pos
, 
wh”e
)

375  
	`l£ek
(
fd
, 
pos
, 
wh”e
);

376 
	}
}

377 #undeà
l£ek


378 
	#l£ek
 
___xxx_l£ek


	)

380 
__šlše__
 
	$adb_uÆšk
(cÚ¡ * 
·th
)

382  
	`uÆšk
(
·th
);

383 
	}
}

384 #undeà
uÆšk


385 
	#uÆšk
 
___xxx_uÆšk


	)

387 
__šlše__
 
	$adb_ü—t
(cÚ¡ * 
·th
, 
mode
)

389 
fd
 = 
	`ü—t
(
·th
, 
mode
);

391 iàĞ
fd
 < 0 )

394 
	`şo£_Ú_exec
(
fd
);

395  
fd
;

396 
	}
}

397 #undeà
ü—t


398 
	#ü—t
 
___xxx_ü—t


	)

400 
__šlše__
 
	$adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
)

402 
fd
;

404 
fd
 = 
	`acû±
(
£rv”fd
, 
addr
, 
add¾’
);

405 ià(
fd
 >= 0)

406 
	`şo£_Ú_exec
(
fd
);

408  
fd
;

409 
	}
}

411 #undeà
acû±


412 
	#acû±
 
___xxx_acû±


	)

414 
	#unix_»ad
 
adb_»ad


	)

415 
	#unix_wr™e
 
adb_wr™e


	)

416 
	#unix_şo£
 
adb_şo£


	)

418 
±h»ad_t
 
	tadb_th»ad_t
;

420 * (*
	tadb_th»ad_func_t
)Ğ* 
	t¬g
 );

422 
__šlše__
 
	$adb_th»ad_ü—‹
Ğ
adb_th»ad_t
 *
±h»ad
, 
adb_th»ad_func_t
 
¡¬t
, * 
¬g
 )

424 
±h»ad_©Œ_t
 
©Œ
;

426 
	`±h»ad_©Œ_š™
 (&
©Œ
);

427 
	`±h»ad_©Œ_£td‘ach¡©e
 (&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

429  
	`±h»ad_ü—‹
Ğ
±h»ad
, &
©Œ
, 
¡¬t
, 
¬g
 );

430 
	}
}

432 
__šlše__
 
	$adb_sock‘_£tbufsize
Ğ
fd
, 
bufsize
 )

434 
İt
 = 
bufsize
;

435  
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
İt
, (opt));

436 
	}
}

438 
__šlše__
 
	$di§bË_tı_ÇgË
(
fd
)

440 
Ú
 = 1;

441 
	`£tsockİt
Ğ
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
Ú
, (on) );

442 
	}
}

445 
__šlše__
 
	$unix_sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
[2] )

447  
	`sock‘·œ
Ğ
d
, 
ty³
, 
´ÙocŞ
, 
sv
 );

448 
	}
}

450 
__šlše__
 
	$adb_sock‘·œ
Ğ
sv
[2] )

452 
rc
;

454 
rc
 = 
	`unix_sock‘·œ
Ğ
AF_UNIX
, 
SOCK_STREAM
, 0, 
sv
 );

455 ià(
rc
 < 0)

458 
	`şo£_Ú_exec
Ğ
sv
[0] );

459 
	`şo£_Ú_exec
Ğ
sv
[1] );

461 
	}
}

463 #undeà
sock‘·œ


464 
	#sock‘·œ
 
___xxx_sock‘·œ


	)

466 
__šlše__
 
	$adb_¦“p_ms
Ğ
m£cÚds
 )

468 
	`u¦“p
Ğ
m£cÚds
*1000 );

469 
	}
}

471 
__šlše__
 
	$adb_mkdœ
(cÚ¡ * 
·th
, 
mode
)

473  
	`mkdœ
(
·th
, 
mode
);

474 
	}
}

475 #undeà
mkdœ


476 
	#mkdœ
 
___xxx_mkdœ


	)

478 
__šlše__
 
	$adb_sysd•s_š™
()

480 
	}
}

482 
__šlše__
 * 
	$adb_dœ¡¬t
(cÚ¡ * 
·th
)

484  
	`¡rchr
(
·th
, '/');

485 
	}
}

487 
__šlše__
 * 
	$adb_dœ¡İ
(cÚ¡ * 
·th
)

489  
	`¡¼chr
(
·th
, '/');

490 
	}
}

492 
__šlše__
 
	$adb_is_absŞu‹_ho¡_·th
ĞcÚ¡ * 
·th
 )

494  
·th
[0] == '/';

495 
	}
}

497 
__šlše__
 * 
	$adb_¡¹ok_r
(*
¡r
, cÚ¡ *
d–im
, **
§v•Œ
)

499  
	`¡¹ok_r
(
¡r
, 
d–im
, 
§v•Œ
);

500 
	}
}

501 #undeà
¡¹ok_r


502 
	#¡¹ok_r
 
___xxx_¡¹ok_r


	)

	@sysdeps_win32.c

1 
	~"sysd•s.h
"

2 
	~<wšdows.h
>

3 
	~<wšsock2.h
>

4 
	~<¡dio.h
>

5 
	~<”ºo.h
>

6 
	#TRACE_TAG
 
TRACE_SYSDEPS


	)

7 
	~"adb.h
"

9 
çl
(cÚ¡ *
fmt
, ...);

11 
	#as£¹
(
cÚd
èdØ{ ià(!(cÚd)è
	`çl
Ğ"as£¹iÚ faed '%s' oÀ%s:%ld\n", #cÚd, 
__FILE__
, 
__LINE__
 ); } 0)

	)

21 *
	$lßd_fe
(cÚ¡ *
â
, *
_sz
)

23 
HANDLE
 
fe
;

24 *
d©a
;

25 
DWORD
 
fe_size
;

27 
fe
 = 
	`C»©eFe
Ğ
â
,

28 
GENERIC_READ
,

29 
FILE_SHARE_READ
,

30 
NULL
,

31 
OPEN_EXISTING
,

33 
NULL
 );

35 ià(
fe
 =ğ
INVALID_HANDLE_VALUE
)

36  
NULL
;

38 
fe_size
 = 
	`G‘FeSize
Ğ
fe
, 
NULL
 );

39 
d©a
 = 
NULL
;

41 ià(
fe_size
 > 0) {

42 
d©a
 = (*è
	`m®loc
Ğ
fe_size
 + 1 );

43 ià(
d©a
 =ğ
NULL
) {

44 
	`D
("lßd_fe: could‚Ù‡Îoÿ‹ %ld by‹s\n", 
fe_size
 );

45 
fe_size
 = 0;

47 
DWORD
 
out_by‹s
;

49 iàĞ!
	`R—dFe
Ğ
fe
, 
d©a
, 
fe_size
, &
out_by‹s
, 
NULL
 ) ||

50 
out_by‹s
 !ğ
fe_size
 )

52 
	`D
("lßd_fe: could‚Ù„—d %ld by‹ äom '%s'\n", 
fe_size
, 
â
);

53 
	`ä“
(
d©a
);

54 
d©a
 = 
NULL
;

55 
fe_size
 = 0;

59 
	`Clo£HªdË
Ğ
fe
 );

61 *
_sz
 = (è
fe_size
;

62  
d©a
;

63 
	}
}

73 cÚ¡ 
	tFHCÏssRec_
* 
	tFHCÏss
;

75 
FHRec_
* 
	tFH
;

77 
Ev’tHookRec_
* 
	tEv’tHook
;

79 
	sFHCÏssRec_


81 (*
	m_fh_š™
èĞ
FH
 
	mf
 );

82 (*
	m_fh_şo£
)Ğ
FH
 
	mf
 );

83 (*
	m_fh_l£ek
)Ğ
FH
 
	mf
, 
	mpos
, 
	mÜigš
 );

84 (*
	m_fh_»ad
èĞ
FH
 
	mf
, * 
	mbuf
, 
	mËn
 );

85 (*
	m_fh_wr™e
)Ğ
FH
 
	mf
, cÚ¡ * 
	mbuf
, 
	mËn
 );

86 (*
	m_fh_hook
èĞ
FH
 
	mf
, 
	mev’ts
, 
Ev’tHook
 
	mhook
 );

88 } 
	tFHCÏssRec
;

91 
Sock‘PaœRec_
* 
	tSock‘Paœ
;

93 
	sFHRec_


95 
FHCÏss
 
	mşazz
;

96 
	mu£d
;

97 
	meof
;

99 
HANDLE
 
	mhªdË
;

100 
SOCKET
 
	msock‘
;

101 
Sock‘Paœ
 
	m·œ
;

102 } 
	mu
;

104 
HANDLE
 
	mev’t
;

105 
	mmask
;

107 
	mÇme
[32];

109 } 
	tFHRec
;

111 
	#fh_hªdË
 
u
.
hªdË


	)

112 
	#fh_sock‘
 
u
.
sock‘


	)

113 
	#fh_·œ
 
u
.
·œ


	)

115 
	#WIN32_FH_BASE
 100

	)

117 
	#WIN32_MAX_FHS
 128

	)

119 
adb_mu‹x_t
 
	g_wš32_lock
;

120 
FHRec
 
	g_wš32_fhs
[ 
WIN32_MAX_FHS
 ];

121 
	g_wš32_fh_couÁ
;

123 
FH


124 
	$_fh_äom_št
Ğ
fd
 )

126 
FH
 
f
;

128 
fd
 -ğ
WIN32_FH_BASE
;

130 ià(
fd
 < 0 || fd >ğ
_wš32_fh_couÁ
) {

131 
	`D
Ğ"_fh_äom_št: inv®id fd %d\n", 
fd
 + 
WIN32_FH_BASE
 );

132 
”ºo
 = 
EBADF
;

133  
NULL
;

136 
f
 = &
_wš32_fhs
[
fd
];

138 ià(
f
->
u£d
 == 0) {

139 
	`D
Ğ"_fh_äom_št: inv®id fd %d\n", 
fd
 + 
WIN32_FH_BASE
 );

140 
”ºo
 = 
EBADF
;

141  
NULL
;

144  
f
;

145 
	}
}

149 
	$_fh_to_št
Ğ
FH
 
f
 )

151 ià(
f
 && f->
u£d
 && f >ğ
_wš32_fhs
 && f < _wš32_fh + 
WIN32_MAX_FHS
)

152  ()(
f
 - 
_wš32_fhs
è+ 
WIN32_FH_BASE
;

155 
	}
}

157 
FH


158 
	$_fh_®loc
Ğ
FHCÏss
 
şazz
 )

160 
Â
;

161 
FH
 
f
 = 
NULL
;

163 
	`adb_mu‹x_lock
Ğ&
_wš32_lock
 );

165 ià(
_wš32_fh_couÁ
 < 
WIN32_MAX_FHS
) {

166 
f
 = &
_wš32_fhs
[ 
_wš32_fh_couÁ
++ ];

167 
Ex™
;

170 
Â
 = 0;‚À< 
WIN32_MAX_FHS
;‚n++) {

171 iàĞ
_wš32_fhs
[
Â
].
şazz
 =ğ
NULL
) {

172 
f
 = &
_wš32_fhs
[
Â
];

173 
Ex™
;

176 
	`D
( "_fh_alloc:‚o more free file descriptors\n" );

177 
Ex™
:

178 ià(
f
) {

179 
f
->
şazz
 = clazz;

180 
f
->
u£d
 = 1;

181 
f
->
eof
 = 0;

182 
şazz
->
	`_fh_š™
(
f
);

184 
	`adb_mu‹x_uÆock
Ğ&
_wš32_lock
 );

185  
f
;

186 
	}
}

190 
	$_fh_şo£
Ğ
FH
 
f
 )

192 iàĞ
f
->
u£d
 ) {

193 
f
->
şazz
->
	`_fh_şo£
( f );

194 
f
->
u£d
 = 0;

195 
f
->
eof
 = 0;

196 
f
->
şazz
 = 
NULL
;

199 
	}
}

202 cÚ¡ 
FHCÏssRec
 
	g_fh_fe_şass
;

203 cÚ¡ 
FHCÏssRec
 
	g_fh_sock‘_şass
;

214 
	$_fh_fe_š™
Ğ
FH
 
f
 )

216 
f
->
fh_hªdË
 = 
INVALID_HANDLE_VALUE
;

217 
	}
}

220 
	$_fh_fe_şo£
Ğ
FH
 
f
 )

222 
	`Clo£HªdË
Ğ
f
->
fh_hªdË
 );

223 
f
->
fh_hªdË
 = 
INVALID_HANDLE_VALUE
;

225 
	}
}

228 
	$_fh_fe_»ad
Ğ
FH
 
f
, * 
buf
, 
Ën
 )

230 
DWORD
 
»ad_by‹s
;

232 iàĞ!
	`R—dFe
Ğ
f
->
fh_hªdË
, 
buf
, (
DWORD
)
Ën
, &
»ad_by‹s
, 
NULL
 ) ) {

233 
	`D
Ğ"adb_»ad: could‚Ù„—d %d by‹ äom %s\n", 
Ën
, 
f
->
Çme
 );

234 
”ºo
 = 
EIO
;

236 } ià(
»ad_by‹s
 < (
DWORD
)
Ën
) {

237 
f
->
eof
 = 1;

239  ()
»ad_by‹s
;

240 
	}
}

243 
	$_fh_fe_wr™e
Ğ
FH
 
f
, cÚ¡ * 
buf
, 
Ën
 )

245 
DWORD
 
wrÙe_by‹s
;

247 iàĞ!
	`Wr™eFe
Ğ
f
->
fh_hªdË
, 
buf
, (
DWORD
)
Ën
, &
wrÙe_by‹s
, 
NULL
 ) ) {

248 
	`D
Ğ"adb_fe_wr™e: could‚Ù wr™%d by‹ äom %s\n", 
Ën
, 
f
->
Çme
 );

249 
”ºo
 = 
EIO
;

251 } ià(
wrÙe_by‹s
 < (
DWORD
)
Ën
) {

252 
f
->
eof
 = 1;

254  ()
wrÙe_by‹s
;

255 
	}
}

258 
	$_fh_fe_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 )

260 
DWORD
 
m‘hod
;

261 
DWORD
 
»suÉ
;

263 
Üigš
)

265 
SEEK_SET
: 
m‘hod
 = 
FILE_BEGIN
; ;

266 
SEEK_CUR
: 
m‘hod
 = 
FILE_CURRENT
; ;

267 
SEEK_END
: 
m‘hod
 = 
FILE_END
; ;

269 
”ºo
 = 
EINVAL
;

273 
»suÉ
 = 
	`S‘FePoš‹r
Ğ
f
->
fh_hªdË
, 
pos
, 
NULL
, 
m‘hod
 );

274 ià(
»suÉ
 =ğ
INVALID_SET_FILE_POINTER
) {

275 
”ºo
 = 
EIO
;

278 
f
->
eof
 = 0;

280  ()
»suÉ
;

281 
	}
}

283 
_fh_fe_hook
Ğ
FH
 
f
, 
ev’t
, 
Ev’tHook
 
ev’thook
 );

285 cÚ¡ 
FHCÏssRec
 
	g_fh_fe_şass
 =

287 
_fh_fe_š™
,

288 
_fh_fe_şo£
,

289 
_fh_fe_l£ek
,

290 
_fh_fe_»ad
,

291 
_fh_fe_wr™e
,

292 
_fh_fe_hook


303 
	$adb_İ’
(cÚ¡ * 
·th
, 
İtiÚs
)

305 
FH
 
f
;

307 
DWORD
 
desœedAcûss
 = 0;

308 
DWORD
 
sh¬eMode
 = 
FILE_SHARE_READ
 | 
FILE_SHARE_WRITE
;

310 
İtiÚs
) {

311 
O_RDONLY
:

312 
desœedAcûss
 = 
GENERIC_READ
;

314 
O_WRONLY
:

315 
desœedAcûss
 = 
GENERIC_WRITE
;

317 
O_RDWR
:

318 
desœedAcûss
 = 
GENERIC_READ
 | 
GENERIC_WRITE
;

321 
	`D
("adb_İ’: inv®id o±iÚ (0x%0x)\n", 
İtiÚs
);

322 
”ºo
 = 
EINVAL
;

326 
f
 = 
	`_fh_®loc
Ğ&
_fh_fe_şass
 );

327 iàĞ!
f
 ) {

328 
”ºo
 = 
ENOMEM
;

332 
f
->
fh_hªdË
 = 
	`C»©eFe
Ğ
·th
, 
desœedAcûss
, 
sh¬eMode
, 
NULL
, 
OPEN_EXISTING
,

333 0, 
NULL
 );

335 iàĞ
f
->
fh_hªdË
 =ğ
INVALID_HANDLE_VALUE
 ) {

336 
	`_fh_şo£
(
f
);

337 
	`D
Ğ"adb_İ’: could‚Ù o³À'%s':", 
·th
 );

338 
	`G‘La¡E¼Ü
()) {

339 
ERROR_FILE_NOT_FOUND
:

340 
	`D
( "file‚ot found\n" );

341 
”ºo
 = 
ENOENT
;

344 
ERROR_PATH_NOT_FOUND
:

345 
	`D
( "path‚ot found\n" );

346 
”ºo
 = 
ENOTDIR
;

350 
	`D
( "unknownƒrror\n" );

351 
”ºo
 = 
ENOENT
;

356 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d(%s)", 
	`_fh_to_št
(f), 
·th
 );

357 
	`D
Ğ"adb_İ’: '%s' => fd %d\n", 
·th
, 
	`_fh_to_št
(
f
) );

358  
	`_fh_to_št
(
f
);

359 
	}
}

362 
	$adb_ü—t
(cÚ¡ * 
·th
, 
mode
)

364 
FH
 
f
;

366 
f
 = 
	`_fh_®loc
Ğ&
_fh_fe_şass
 );

367 iàĞ!
f
 ) {

368 
”ºo
 = 
ENOMEM
;

372 
f
->
fh_hªdË
 = 
	`C»©eFe
Ğ
·th
, 
GENERIC_WRITE
, 
FILE_SHARE_READ
 | 
FILE_SHARE_WRITE
,

373 
NULL
, 
CREATE_ALWAYS
, 
FILE_ATTRIBUTE_NORMAL
,

374 
NULL
 );

376 iàĞ
f
->
fh_hªdË
 =ğ
INVALID_HANDLE_VALUE
 ) {

377 
	`_fh_şo£
(
f
);

378 
	`D
Ğ"adb_ü—t: could‚Ù o³À'%s':", 
·th
 );

379 
	`G‘La¡E¼Ü
()) {

380 
ERROR_FILE_NOT_FOUND
:

381 
	`D
( "file‚ot found\n" );

382 
”ºo
 = 
ENOENT
;

385 
ERROR_PATH_NOT_FOUND
:

386 
	`D
( "path‚ot found\n" );

387 
”ºo
 = 
ENOTDIR
;

391 
	`D
( "unknownƒrror\n" );

392 
”ºo
 = 
ENOENT
;

396 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d(%s)", 
	`_fh_to_št
(f), 
·th
 );

397 
	`D
Ğ"adb_ü—t: '%s' => fd %d\n", 
·th
, 
	`_fh_to_št
(
f
) );

398  
	`_fh_to_št
(
f
);

399 
	}
}

402 
	$adb_»ad
(
fd
, * 
buf
, 
Ën
)

404 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

406 ià(
f
 =ğ
NULL
) {

410  
f
->
şazz
->
	`_fh_»ad
Ğf, 
buf
, 
Ën
 );

411 
	}
}

414 
	$adb_wr™e
(
fd
, cÚ¡ * 
buf
, 
Ën
)

416 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

418 ià(
f
 =ğ
NULL
) {

422  
f
->
şazz
->
	`_fh_wr™e
(f, 
buf
, 
Ën
);

423 
	}
}

426 
	$adb_l£ek
(
fd
, 
pos
, 
wh”e
)

428 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

430 ià(!
f
) {

434  
f
->
şazz
->
	`_fh_l£ek
(f, 
pos
, 
wh”e
);

435 
	}
}

438 
	$adb_shutdown
(
fd
)

440 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

442 ià(!
f
) {

446 
	`D
Ğ"adb_shutdown: %s\n", 
f
->
Çme
);

447 
	`shutdown
Ğ
f
->
fh_sock‘
, 
SD_BOTH
 );

449 
	}
}

452 
	$adb_şo£
(
fd
)

454 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

456 ià(!
f
) {

460 
	`D
Ğ"adb_şo£: %s\n", 
f
->
Çme
);

461 
	`_fh_şo£
(
f
);

463 
	}
}

474 
	$_sock‘_£t_”ºo
( )

476 
	`WSAG‘La¡E¼Ü
()) {

477 0: 
”ºo
 = 0; ;

478 
WSAEWOULDBLOCK
: 
”ºo
 = 
EAGAIN
; ;

479 
WSAEINTR
: 
”ºo
 = 
EINTR
; ;

481 
	`D
Ğ"_sock‘_£t_”ºo: unhªdËd v®u%d\n", 
	`WSAG‘La¡E¼Ü
() );

482 
”ºo
 = 
EINVAL
;

484 
	}
}

487 
	$_fh_sock‘_š™
Ğ
FH
 
f
 )

489 
f
->
fh_sock‘
 = 
INVALID_SOCKET
;

490 
f
->
ev’t
 = 
	`WSAC»©eEv’t
();

491 
f
->
mask
 = 0;

492 
	}
}

495 
	$_fh_sock‘_şo£
Ğ
FH
 
f
 )

498 
	`shutdown
Ğ
f
->
fh_sock‘
, 
SD_BOTH
 );

499 
	`şo£sock‘
Ğ
f
->
fh_sock‘
 );

500 
f
->
fh_sock‘
 = 
INVALID_SOCKET
;

501 
	`Clo£HªdË
Ğ
f
->
ev’t
 );

502 
f
->
mask
 = 0;

504 
	}
}

507 
	$_fh_sock‘_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 )

509 
”ºo
 = 
EPIPE
;

511 
	}
}

514 
	$_fh_sock‘_»ad
Ğ
FH
 
f
, * 
buf
, 
Ën
 )

516 
»suÉ
 = 
	`»cv
Ğ
f
->
fh_sock‘
, 
buf
, 
Ën
, 0 );

517 ià(
»suÉ
 =ğ
SOCKET_ERROR
) {

518 
	`_sock‘_£t_”ºo
();

519 
»suÉ
 = -1;

521  
»suÉ
;

522 
	}
}

525 
	$_fh_sock‘_wr™e
Ğ
FH
 
f
, cÚ¡ * 
buf
, 
Ën
 )

527 
»suÉ
 = 
	`£nd
Ğ
f
->
fh_sock‘
, 
buf
, 
Ën
, 0 );

528 ià(
»suÉ
 =ğ
SOCKET_ERROR
) {

529 
	`_sock‘_£t_”ºo
();

530 
»suÉ
 = -1;

532  
»suÉ
;

533 
	}
}

535 
_fh_sock‘_hook
Ğ
FH
 
f
, 
ev’t
, 
Ev’tHook
 
hook
 );

537 cÚ¡ 
FHCÏssRec
 
	g_fh_sock‘_şass
 =

539 
_fh_sock‘_š™
,

540 
_fh_sock‘_şo£
,

541 
_fh_sock‘_l£ek
,

542 
_fh_sock‘_»ad
,

543 
_fh_sock‘_wr™e
,

544 
_fh_sock‘_hook


555 
	~<wšsock2.h
>

557 
	g_wšsock_š™
;

560 
	$_ş—nup_wšsock
( )

562 
	`WSACËªup
();

563 
	}
}

566 
	$_š™_wšsock
( )

568 ià(!
_wšsock_š™
) {

569 
WSADATA
 
w§D©a
;

570 
rc
 = 
	`WSAS¹up
Ğ
	`MAKEWORD
(2,2), &
w§D©a
);

571 ià(
rc
 != 0) {

572 
	`çl
( "adb: could‚ot initialize Winsock\n" );

574 
	`©ex™
Ğ
_ş—nup_wšsock
 );

575 
_wšsock_š™
 = 1;

577 
	}
}

579 
	$sock‘_loİback_ş›Á
(
pÜt
, 
ty³
)

581 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

582 
sockaddr_š
 
addr
;

583 
SOCKET
 
s
;

585 ià(!
f
)

588 ià(!
_wšsock_š™
)

589 
	`_š™_wšsock
();

591 
	`mem£t
(&
addr
, 0, (addr));

592 
addr
.
sš_çmy
 = 
AF_INET
;

593 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

594 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

596 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

597 if(
s
 =ğ
INVALID_SOCKET
) {

598 
	`D
("socket_loopback_client: could‚ot create socket\n" );

599 
	`_fh_şo£
(
f
);

603 
f
->
fh_sock‘
 = 
s
;

604 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

605 
	`D
("sock‘_loİback_ş›Á: could‚Ù cÚÃùØ%s:%d\n", 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
pÜt
 );

606 
	`_fh_şo£
(
f
);

609 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÖo-ş›Á:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

610 
	`D
Ğ"sock‘_loİback_ş›Á:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

611  
	`_fh_to_št
(
f
);

612 
	}
}

614 
	#LISTEN_BACKLOG
 4

	)

616 
	$sock‘_loİback_£rv”
(
pÜt
, 
ty³
)

618 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

619 
sockaddr_š
 
addr
;

620 
SOCKET
 
s
;

621 
n
;

623 ià(!
f
) {

627 ià(!
_wšsock_š™
)

628 
	`_š™_wšsock
();

630 
	`mem£t
(&
addr
, 0, (addr));

631 
addr
.
sš_çmy
 = 
AF_INET
;

632 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

633 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

635 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

636 if(
s
 =ğ
INVALID_SOCKET
)  -1;

638 
f
->
fh_sock‘
 = 
s
;

640 
n
 = 1;

641 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (cÚ¡ *)&
n
, (n));

643 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

644 
	`_fh_şo£
(
f
);

647 ià(
ty³
 =ğ
SOCK_STREAM
) {

648 
»t
;

650 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

651 ià(
»t
 < 0) {

652 
	`_fh_şo£
(
f
);

656 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÖo-£rv”:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

657 
	`D
Ğ"sock‘_loİback_£rv”:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

658  
	`_fh_to_št
(
f
);

659 
	}
}

662 
	$sock‘_ÃtwÜk_ş›Á
(cÚ¡ *
ho¡
, 
pÜt
, 
ty³
)

664 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

665 
ho¡’t
 *
hp
;

666 
sockaddr_š
 
addr
;

667 
SOCKET
 
s
;

669 ià(!
f
)

672 ià(!
_wšsock_š™
)

673 
	`_š™_wšsock
();

675 
hp
 = 
	`g‘ho¡byÇme
(
ho¡
);

676 if(
hp
 == 0) {

677 
	`_fh_şo£
(
f
);

681 
	`mem£t
(&
addr
, 0, (addr));

682 
addr
.
sš_çmy
 = 
hp
->
h_add¹y³
;

683 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

684 
	`memıy
(&
addr
.
sš_addr
, 
hp
->
h_addr
, hp->
h_Ëngth
);

686 
s
 = 
	`sock‘
(
hp
->
h_add¹y³
, 
ty³
, 0);

687 if(
s
 =ğ
INVALID_SOCKET
) {

688 
	`_fh_şo£
(
f
);

691 
f
->
fh_sock‘
 = 
s
;

693 if(
	`cÚÃù
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

694 
	`_fh_şo£
(
f
);

698 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%dÒ‘-ş›Á:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

699 
	`D
Ğ"sock‘_ÃtwÜk_ş›Á: ho¡ '%s'…Üˆ%dy³ % => fd %d\n", 
ho¡
, 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

700  
	`_fh_to_št
(
f
);

701 
	}
}

704 
	$sock‘_šaddr_ªy_£rv”
(
pÜt
, 
ty³
)

706 
FH
 
f
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

707 
sockaddr_š
 
addr
;

708 
SOCKET
 
s
;

709 
n
;

711 ià(!
f
)

714 ià(!
_wšsock_š™
)

715 
	`_š™_wšsock
();

717 
	`mem£t
(&
addr
, 0, (addr));

718 
addr
.
sš_çmy
 = 
AF_INET
;

719 
addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

720 
addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

722 
s
 = 
	`sock‘
(
AF_INET
, 
ty³
, 0);

723 if(
s
 =ğ
INVALID_SOCKET
) {

724 
	`_fh_şo£
(
f
);

728 
f
->
fh_sock‘
 = 
s
;

729 
n
 = 1;

730 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_EXCLUSIVEADDRUSE
, (cÚ¡ *)&
n
, (n));

732 if(
	`bšd
(
s
, (
sockaddr
 *è&
addr
, (addr)) < 0) {

733 
	`_fh_şo£
(
f
);

737 ià(
ty³
 =ğ
SOCK_STREAM
) {

738 
»t
;

740 
»t
 = 
	`li¡’
(
s
, 
LISTEN_BACKLOG
);

741 ià(
»t
 < 0) {

742 
	`_fh_şo£
(
f
);

746 
	`¢´štf
Ğ
f
->
Çme
, (f->Çme), "%d×ny-£rv”:%s%d)", 
	`_fh_to_št
(f), 
ty³
 !ğ
SOCK_STREAM
 ? "udp:" : "", 
pÜt
 );

747 
	`D
Ğ"sock‘_šaddr_£rv”:…Üˆ%dy³ % => fd %d\n", 
pÜt
, 
ty³
 !ğ
SOCK_STREAM
 ? "udp" : "tı", 
	`_fh_to_št
(
f
) );

748  
	`_fh_to_št
(
f
);

749 
	}
}

751 #undeà
acû±


752 
	$adb_sock‘_acû±
(
£rv”fd
, 
sockaddr
* 
addr
, 
sockËn_t
 *
add¾’
)

754 
FH
 
£rv”fh
 = 
	`_fh_äom_št
(
£rv”fd
);

755 
FH
 
fh
;

757 iàĞ!
£rv”fh
 || s”v”fh->
şazz
 !ğ&
_fh_sock‘_şass
 ) {

758 
	`D
Ğ"adb_sock‘_acû±: inv®id fd %d\n", 
£rv”fd
 );

762 
fh
 = 
	`_fh_®loc
Ğ&
_fh_sock‘_şass
 );

763 ià(!
fh
) {

764 
	`D
( "adb_socket_accept:‚otƒnough memoryo‡llocate‡ccepted socket descriptor\n" );

768 
fh
->
fh_sock‘
 = 
	`acû±
Ğ
£rv”fh
->fh_sock‘, 
addr
, 
add¾’
 );

769 ià(
fh
->
fh_sock‘
 =ğ
INVALID_SOCKET
) {

770 
	`_fh_şo£
Ğ
fh
 );

771 
	`D
Ğ"adb_sock‘_acû±:‡cû± oÀfd %d„‘uºƒ¼Ü %ld\n", 
£rv”fd
, 
	`G‘La¡E¼Ü
() );

775 
	`¢´štf
Ğ
fh
->
Çme
, (fh->Çme), "%d×cû±:%s)", 
	`_fh_to_št
(fh), 
£rv”fh
->name );

776 
	`D
Ğ"adb_sock‘_acû± oÀfd %d„‘uº fd %d\n", 
£rv”fd
, 
	`_fh_to_št
(
fh
) );

777  
	`_fh_to_št
(
fh
);

778 
	}
}

781 
	$di§bË_tı_ÇgË
(
fd
)

783 
FH
 
fh
 = 
	`_fh_äom_št
(
fd
);

784 
Ú
;

786 iàĞ!
fh
 || fh->
şazz
 !ğ&
_fh_sock‘_şass
 )

789 
	`£tsockİt
Ğ
fh
->
fh_sock‘
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (cÚ¡ *)&
Ú
, (on) );

790 
	}
}

827 
	#BIP_BUFFER_SIZE
 4096

	)

830 
	~<¡dio.h
>

831 
	#BIPD
(
x
è
D
 
	)
x

832 
	#BIPDUMP
 
b_dump_hex


	)

834 
	$b_dump_hex
ĞcÚ¡ * 
±r
, 
size_t
 
Ën
 )

836 
Â
, 
Ën2
 = 
Ën
;

838 ià(
Ën2
 > 8)†en2 = 8;

840 
Â
 = 0;‚À< 
Ën2
;‚n++)

841 
	`´štf
("%02x", 
±r
[
Â
]);

842 
	`´štf
(" ");

844 
Â
 = 0;‚À< 
Ën2
;‚n++) {

845 
c
 = 
±r
[
Â
];

846 ià(
c
 < 32 || c > 127)

847 
c
 = '.';

848 
	`´štf
("%c", 
c
);

850 
	`´štf
("\n");

851 
	`fæush
(
¡dout
);

852 
	}
}

855 
	#BIPD
(
x
èdØ{} 0)

	)

856 
	#BIPDUMP
(
p
,
l
è
	`BIPD
Õ)

	)

859 
	sBBufãrRec_


861 
	ma_¡¬t
;

862 
	ma_’d
;

863 
	mb_’d
;

864 
	mfdš
;

865 
	mfdout
;

866 
	mşo£d
;

867 
	mÿn_wr™e
;

868 
HANDLE
 
	mevt_wr™e
;

869 
	mÿn_»ad
;

870 
HANDLE
 
	mevt_»ad
;

871 
CRITICAL_SECTION
 
	mlock
;

872 
	mbuff
[ 
BIP_BUFFER_SIZE
 ];

874 } 
	tBBufãrRec
, *
	tBBufãr
;

877 
	$b_bufãr_š™
Ğ
BBufãr
 
bufãr
 )

879 
	`D
Ğ"b™_bufãr_š™ %p\n", 
bufãr
 );

880 
bufãr
->
a_¡¬t
 = 0;

881 
bufãr
->
a_’d
 = 0;

882 
bufãr
->
b_’d
 = 0;

883 
bufãr
->
ÿn_wr™e
 = 1;

884 
bufãr
->
ÿn_»ad
 = 0;

885 
bufãr
->
fdš
 = 0;

886 
bufãr
->
fdout
 = 0;

887 
bufãr
->
şo£d
 = 0;

888 
bufãr
->
evt_wr™e
 = 
	`C»©eEv’t
Ğ
NULL
, 
TRUE
, TRUE, NULL );

889 
bufãr
->
evt_»ad
 = 
	`C»©eEv’t
Ğ
NULL
, 
TRUE
, 
FALSE
, NULL );

890 
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ&
bufãr
->
lock
 );

891 
	}
}

894 
	$b_bufãr_şo£
Ğ
BBufãr
 
b
 )

896 
b
->
şo£d
 = 1;

898 ià(!
b
->
ÿn_»ad
) {

899 
	`S‘Ev’t
Ğ
b
->
evt_»ad
 );

901 ià(!
b
->
ÿn_wr™e
) {

902 
	`S‘Ev’t
Ğ
b
->
evt_wr™e
 );

904 
	}
}

907 
	$b_bufãr_dÚe
Ğ
BBufãr
 
b
 )

909 
	`BIPD
(Ğ"b_bufãr_dÚe: %d->%d\n", 
b
->
fdš
, b->
fdout
 ));

910 
	`Clo£HªdË
Ğ
b
->
evt_»ad
 );

911 
	`Clo£HªdË
Ğ
b
->
evt_wr™e
 );

912 
	`D–‘eCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

913 
	}
}

916 
	$b_bufãr_wr™e
Ğ
BBufãr
 
b
, cÚ¡ * 
¤c
, 
Ën
 )

918 
ava
, 
couÁ
 = 0;

920 ià(
Ën
 <= 0)

923 
	`BIPD
(Ğ"b_bufãr_wr™e:ƒÁ” %d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

924 
	`BIPDUMP
Ğ
¤c
, 
Ën
 );

926 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

928 !
b
->
ÿn_wr™e
) {

929 
»t
;

930 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

932 ià(
b
->
şo£d
) {

933 
”ºo
 = 
EPIPE
;

937 
»t
 = 
	`Wa™FÜSšgËObjeù
Ğ
b
->
evt_wr™e
, 
INFINITE
 );

938 ià(
»t
 !ğ
WAIT_OBJECT_0
) {

939 
	`D
Ğ"b_bufãr_wr™e:ƒ¼Ü %d->%d Wa™FÜSšgËObjeù„‘uºed %d,ƒ¼Ü %ld\n", 
b
->
fdš
, b->
fdout
, 
»t
, 
	`G‘La¡E¼Ü
() );

942 ià(
b
->
şo£d
) {

943 
”ºo
 = 
EPIPE
;

946 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

949 
	`BIPD
(Ğ"b_bufãr_wr™e:ƒxeø%d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

951 
ava
 = 
BIP_BUFFER_SIZE
 - 
b
->
a_’d
;

952 ià(
ava
 > 0)

955 ià(
ava
 > 
Ën
)

956 
ava
 = 
Ën
;

958 
	`memıy
Ğ
b
->
buff
 + b->
a_’d
, 
¤c
, 
ava
 );

959 
¤c
 +ğ
ava
;

960 
couÁ
 +ğ
ava
;

961 
Ën
 -ğ
ava
;

963 
b
->
a_’d
 +ğ
ava
;

964 ià(
b
->
a_’d
 =ğ
BIP_BUFFER_SIZE
 && b->
a_¡¬t
 == 0) {

965 
b
->
ÿn_wr™e
 = 0;

966 
	`Re£tEv’t
Ğ
b
->
evt_wr™e
 );

967 
Ex™
;

971 ià(
Ën
 == 0)

972 
Ex™
;

974 
ava
 = 
b
->
a_¡¬t
 - b->
b_’d
;

975 
	`as£¹
Ğ
ava
 > 0 );

977 ià(
ava
 > 
Ën
)

978 
ava
 = 
Ën
;

980 
	`memıy
Ğ
b
->
buff
 + b->
b_’d
, 
¤c
, 
ava
 );

981 
couÁ
 +ğ
ava
;

982 
b
->
b_’d
 +ğ
ava
;

984 ià(
b
->
b_’d
 =ğb->
a_¡¬t
) {

985 
b
->
ÿn_wr™e
 = 0;

986 
	`Re£tEv’t
Ğ
b
->
evt_wr™e
 );

989 
Ex™
:

990 
	`as£¹
Ğ
couÁ
 > 0 );

992 iàĞ!
b
->
ÿn_»ad
 ) {

993 
b
->
ÿn_»ad
 = 1;

994 
	`S‘Ev’t
Ğ
b
->
evt_»ad
 );

997 
	`BIPD
(( "bip_buffer_write:ƒxit %d->%d count %d (as=%d‡e=%d be=%d cw=%d cr=%d\n",

998 
b
->
fdš
, b->
fdout
, 
couÁ
, b->
a_¡¬t
, b->
a_’d
, b->
b_’d
, b->
ÿn_wr™e
, b->
ÿn_»ad
 ));

999 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1001  
couÁ
;

1002 
	}
}

1005 
	$b_bufãr_»ad
Ğ
BBufãr
 
b
, * 
d¡
, 
Ën
 )

1007 
ava
, 
couÁ
 = 0;

1009 ià(
Ën
 <= 0)

1012 
	`BIPD
(Ğ"b_bufãr_»ad:ƒÁ” %d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

1014 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1015  !
b
->
ÿn_»ad
 )

1018 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1019 
”ºo
 = 
EAGAIN
;

1022 
»t
;

1023 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1025 ià(
b
->
şo£d
) {

1026 
”ºo
 = 
EPIPE
;

1030 
»t
 = 
	`Wa™FÜSšgËObjeù
Ğ
b
->
evt_»ad
, 
INFINITE
 );

1031 ià(
»t
 !ğ
WAIT_OBJECT_0
) {

1032 
	`D
Ğ"b_bufãr_»ad:ƒ¼Ü %d->%d Wa™FÜSšgËObjeù„‘uºed %d,ƒ¼Ü %ld\n", 
b
->
fdš
, b->
fdout
, 
»t
, 
	`G‘La¡E¼Ü
());

1035 ià(
b
->
şo£d
) {

1036 
”ºo
 = 
EPIPE
;

1039 
	`EÁ”Cr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1043 
	`BIPD
(Ğ"b_bufãr_»ad:ƒxeø%d->%d†’ %d\n", 
b
->
fdš
, b->
fdout
, 
Ën
 ));

1045 
ava
 = 
b
->
a_’d
 - b->
a_¡¬t
;

1046 
	`as£¹
Ğ
ava
 > 0 );

1048 ià(
ava
 > 
Ën
)

1049 
ava
 = 
Ën
;

1051 
	`memıy
Ğ
d¡
, 
b
->
buff
 + b->
a_¡¬t
, 
ava
 );

1052 
d¡
 +ğ
ava
;

1053 
couÁ
 +ğ
ava
;

1054 
Ën
 -ğ
ava
;

1056 
b
->
a_¡¬t
 +ğ
ava
;

1057 ià(
b
->
a_¡¬t
 < b->
a_’d
)

1058 
Ex™
;

1060 
b
->
a_¡¬t
 = 0;

1061 
b
->
a_’d
 = b->
b_’d
;

1062 
b
->
b_’d
 = 0;

1064 
ava
 = 
b
->
a_’d
;

1065 ià(
ava
 > 0) {

1066 ià(
ava
 > 
Ën
)

1067 
ava
 = 
Ën
;

1068 
	`memıy
Ğ
d¡
, 
b
->
buff
, 
ava
 );

1069 
couÁ
 +ğ
ava
;

1070 
b
->
a_¡¬t
 +ğ
ava
;

1072 iàĞ
b
->
a_¡¬t
 < b->
a_’d
 )

1073 
Ex™
;

1075 
b
->
a_¡¬t
 = b->
a_’d
 = 0;

1078 
b
->
ÿn_»ad
 = 0;

1079 
	`Re£tEv’t
Ğ
b
->
evt_»ad
 );

1081 
Ex™
:

1082 
	`as£¹
Ğ
couÁ
 > 0 );

1084 ià(!
b
->
ÿn_wr™e
 ) {

1085 
b
->
ÿn_wr™e
 = 1;

1086 
	`S‘Ev’t
Ğ
b
->
evt_wr™e
 );

1089 
	`BIPDUMP
Ğ(cÚ¡ *)
d¡
 - 
couÁ
, count );

1090 
	`BIPD
(( "bip_buffer_read:ƒxit %d->%d count %d (as=%d‡e=%d be=%d cw=%d cr=%d\n",

1091 
b
->
fdš
, b->
fdout
, 
couÁ
, b->
a_¡¬t
, b->
a_’d
, b->
b_’d
, b->
ÿn_wr™e
, b->
ÿn_»ad
 ));

1092 
	`L—veCr™iÿlSeùiÚ
Ğ&
b
->
lock
 );

1094  
couÁ
;

1095 
	}
}

1097 
	sSock‘PaœRec_


1099 
BBufãrRec
 
	ma2b_b
;

1100 
BBufãrRec
 
	mb2a_b
;

1101 
FH
 
	ma_fd
;

1102 
	mu£d
;

1104 } 
	tSock‘PaœRec
;

1106 
	$_fh_sock‘·œ_š™
Ğ
FH
 
f
 )

1108 
f
->
fh_·œ
 = 
NULL
;

1109 
	}
}

1112 
	$_fh_sock‘·œ_şo£
Ğ
FH
 
f
 )

1114 iàĞ
f
->
fh_·œ
 ) {

1115 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1117 iàĞ
f
 =ğ
·œ
->
a_fd
 ) {

1118 
·œ
->
a_fd
 = 
NULL
;

1121 
	`b_bufãr_şo£
Ğ&
·œ
->
b2a_b
 );

1122 
	`b_bufãr_şo£
Ğ&
·œ
->
a2b_b
 );

1124 iàĞ--
·œ
->
u£d
 == 0 ) {

1125 
	`b_bufãr_dÚe
Ğ&
·œ
->
b2a_b
 );

1126 
	`b_bufãr_dÚe
Ğ&
·œ
->
a2b_b
 );

1127 
	`ä“
Ğ
·œ
 );

1129 
f
->
fh_·œ
 = 
NULL
;

1132 
	}
}

1135 
	$_fh_sock‘·œ_l£ek
Ğ
FH
 
f
, 
pos
, 
Üigš
 )

1137 
”ºo
 = 
ESPIPE
;

1139 
	}
}

1142 
	$_fh_sock‘·œ_»ad
Ğ
FH
 
f
, * 
buf
, 
Ën
 )

1144 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1145 
BBufãr
 
b
;

1147 ià(!
·œ
)

1150 iàĞ
f
 =ğ
·œ
->
a_fd
 )

1151 
b
 = &
·œ
->
b2a_b
;

1153 
b
 = &
·œ
->
a2b_b
;

1155  
	`b_bufãr_»ad
Ğ
b
, 
buf
, 
Ën
 );

1156 
	}
}

1159 
	$_fh_sock‘·œ_wr™e
Ğ
FH
 
f
, cÚ¡ * 
buf
, 
Ën
 )

1161 
Sock‘Paœ
 
·œ
 = 
f
->
fh_·œ
;

1162 
BBufãr
 
b
;

1164 ià(!
·œ
)

1167 iàĞ
f
 =ğ
·œ
->
a_fd
 )

1168 
b
 = &
·œ
->
a2b_b
;

1170 
b
 = &
·œ
->
b2a_b
;

1172  
	`b_bufãr_wr™e
Ğ
b
, 
buf
, 
Ën
 );

1173 
	}
}

1176 
_fh_sock‘·œ_hook
Ğ
FH
 
f
, 
ev’t
, 
Ev’tHook
 
hook
 );

1178 cÚ¡ 
FHCÏssRec
 
	g_fh_sock‘·œ_şass
 =

1180 
_fh_sock‘·œ_š™
,

1181 
_fh_sock‘·œ_şo£
,

1182 
_fh_sock‘·œ_l£ek
,

1183 
_fh_sock‘·œ_»ad
,

1184 
_fh_sock‘·œ_wr™e
,

1185 
_fh_sock‘·œ_hook


1189 
	$adb_sock‘·œ
Ğ
sv
[2] )

1191 
FH
 
ç
, 
fb
;

1192 
Sock‘Paœ
 
·œ
;

1194 
ç
 = 
	`_fh_®loc
Ğ&
_fh_sock‘·œ_şass
 );

1195 
fb
 = 
	`_fh_®loc
Ğ&
_fh_sock‘·œ_şass
 );

1197 ià(!
ç
 || !
fb
)

1198 
Fa
;

1200 
·œ
 = 
	`m®loc
( (*pair) );

1201 ià(
·œ
 =ğ
NULL
) {

1202 
	`D
("adb_socketpair:‚otƒnough memoryo‡llocate…ipes\n" );

1203 
Fa
;

1206 
	`b_bufãr_š™
Ğ&
·œ
->
a2b_b
 );

1207 
	`b_bufãr_š™
Ğ&
·œ
->
b2a_b
 );

1209 
ç
->
fh_·œ
 = 
·œ
;

1210 
fb
->
fh_·œ
 = 
·œ
;

1211 
·œ
->
u£d
 = 2;

1212 
·œ
->
a_fd
 = 
ç
;

1214 
sv
[0] = 
	`_fh_to_št
(
ç
);

1215 
sv
[1] = 
	`_fh_to_št
(
fb
);

1217 
·œ
->
a2b_b
.
fdš
 = 
sv
[0];

1218 
·œ
->
a2b_b
.
fdout
 = 
sv
[1];

1219 
·œ
->
b2a_b
.
fdš
 = 
sv
[1];

1220 
·œ
->
b2a_b
.
fdout
 = 
sv
[0];

1222 
	`¢´štf
Ğ
ç
->
Çme
, (ç->Çme), "%dÕaœ:%d)", 
sv
[0], sv[1] );

1223 
	`¢´štf
Ğ
fb
->
Çme
, (fb->Çme), "%dÕaœ:%d)", 
sv
[1], sv[0] );

1224 
	`D
Ğ"adb_sock‘·œ:„‘uº (%d, %d)\n", 
sv
[0], sv[1] );

1227 
Fa
:

1228 
	`_fh_şo£
(
fb
);

1229 
	`_fh_şo£
(
ç
);

1231 
	}
}

1244 
	#FATAL
(
x
...è
	`çl
(
__FUNCTION__
, x)

	)

1246 #ià
DEBUG


1247 
	$dump_fde
(
fdev’t
 *
fde
, cÚ¡ *
šfo
)

1249 
	`årštf
(
¡d”r
,"FDE #%03d %c%c%ø%s\n", 
fde
->
fd
,

1250 
fde
->
¡©e
 & 
FDE_READ
 ? 'R' : ' ',

1251 
fde
->
¡©e
 & 
FDE_WRITE
 ? 'W' : ' ',

1252 
fde
->
¡©e
 & 
FDE_ERROR
 ? 'E' : ' ',

1253 
šfo
);

1254 
	}
}

1256 
	#dump_fde
(
fde
, 
šfo
èdØ{ } 0)

	)

1259 
	#FDE_EVENTMASK
 0x00ff

	)

1260 
	#FDE_STATEMASK
 0xff00

	)

1262 
	#FDE_ACTIVE
 0x0100

	)

1263 
	#FDE_PENDING
 0x0200

	)

1264 
	#FDE_CREATED
 0x0400

	)

1266 
fdev’t_¶i¡_’queue
(
fdev’t
 *
node
);

1267 
fdev’t_¶i¡_»move
(
fdev’t
 *
node
);

1268 
fdev’t
 *
fdev’t_¶i¡_dequeue
();

1270 
fdev’t
 
	gli¡_³ndšg
 = {

1271 .
Ãxt
 = &
li¡_³ndšg
,

1272 .
	g´ev
 = &
li¡_³ndšg
,

1275 
fdev’t
 **
	gfd_bË
 = 0;

1276 
	gfd_bË_max
 = 0;

1278 
Ev’tLoİ”Rec_
* 
	tEv’tLoİ”
;

1280 
	sEv’tHookRec_


1282 
Ev’tHook
 
	mÃxt
;

1283 
FH
 
	mfh
;

1284 
HANDLE
 
	mh
;

1285 
	mwª‹d
;

1286 
	m»ady
;

1287 * 
	maux
;

1288 (*
	m´•¬e
)Ğ
Ev’tHook
 
	mhook
 );

1289 (*
	m¡¬t
èĞ
Ev’tHook
 
	mhook
 );

1290 (*
	m¡İ
èĞ
Ev’tHook
 
	mhook
 );

1291 (*
	mcheck
èĞ
Ev’tHook
 
	mhook
 );

1292 (*
	m³ek
èĞ
Ev’tHook
 
	mhook
 );

1293 } 
	tEv’tHookRec
;

1295 
Ev’tHook
 
	g_ä“_hooks
;

1297 
Ev’tHook


1298 
	$ev’t_hook_®loc
Ğ
FH
 
fh
 )

1300 
Ev’tHook
 
hook
 = 
_ä“_hooks
;

1301 ià(
hook
 !ğ
NULL
)

1302 
_ä“_hooks
 = 
hook
->
Ãxt
;

1304 
hook
 = 
	`m®loc
( (*hook) );

1305 ià(
hook
 =ğ
NULL
)

1306 
	`çl
( "could‚ot‡llocateƒvent hook\n" );

1308 
hook
->
Ãxt
 = 
NULL
;

1309 
hook
->
fh
 = fh;

1310 
hook
->
wª‹d
 = 0;

1311 
hook
->
»ady
 = 0;

1312 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

1313 
hook
->
aux
 = 
NULL
;

1315 
hook
->
´•¬e
 = 
NULL
;

1316 
hook
->
¡¬t
 = 
NULL
;

1317 
hook
->
¡İ
 = 
NULL
;

1318 
hook
->
check
 = 
NULL
;

1319 
hook
->
³ek
 = 
NULL
;

1321  
hook
;

1322 
	}
}

1325 
	$ev’t_hook_ä“
Ğ
Ev’tHook
 
hook
 )

1327 
hook
->
fh
 = 
NULL
;

1328 
hook
->
wª‹d
 = 0;

1329 
hook
->
»ady
 = 0;

1330 
hook
->
Ãxt
 = 
_ä“_hooks
;

1331 
_ä“_hooks
 = 
hook
;

1332 
	}
}

1336 
	$ev’t_hook_sigÇl
Ğ
Ev’tHook
 
hook
 )

1338 
FH
 
f
 = 
hook
->
fh
;

1339 
fd
 = 
	`_fh_to_št
(
f
);

1340 
fdev’t
* 
fde
 = 
fd_bË
[ 
fd
 - 
WIN32_FH_BASE
 ];

1342 ià(
fde
 !ğ
NULL
 && fde->
fd
 == fd) {

1343 ià((
fde
->
¡©e
 & 
FDE_PENDING
) == 0) {

1344 
fde
->
¡©e
 |ğ
FDE_PENDING
;

1345 
	`fdev’t_¶i¡_’queue
Ğ
fde
 );

1347 
fde
->
ev’ts
 |ğ
hook
->
wª‹d
;

1349 
	}
}

1352 
	#MAX_LOOPER_HANDLES
 
WIN32_MAX_FHS


	)

1354 
	sEv’tLoİ”Rec_


1356 
Ev’tHook
 
	mhooks
;

1357 
HANDLE
 
	mhb
[ 
MAX_LOOPER_HANDLES
 ];

1358 
	mhb_couÁ
;

1360 } 
	tEv’tLoİ”Rec
;

1362 
Ev’tHook
*

1363 
	$ev’t_loİ”_fšd_p
Ğ
Ev’tLoİ”
 
loİ”
, 
FH
 
fh
 )

1365 
Ev’tHook
 *
²ode
 = &
loİ”
->
hooks
;

1366 
Ev’tHook
 
node
 = *
²ode
;

1368 iàĞ
node
 =ğ
NULL
 ||‚ode->
fh
 == fh )

1370 
²ode
 = &
node
->
Ãxt
;

1371 
node
 = *
²ode
;

1373  
²ode
;

1374 
	}
}

1377 
	$ev’t_loİ”_hook
Ğ
Ev’tLoİ”
 
loİ”
, 
fd
, 
ev’ts
 )

1379 
FH
 
f
 = 
	`_fh_äom_št
(
fd
);

1380 
Ev’tHook
 *
²ode
;

1381 
Ev’tHook
 
node
;

1383 ià(
f
 =ğ
NULL
) {

1384 
	`D
("ev’t_loİ”_hook: inv®id fd=%d\n", 
fd
);

1388 
²ode
 = 
	`ev’t_loİ”_fšd_p
Ğ
loİ”
, 
f
 );

1389 
node
 = *
²ode
;

1390 iàĞ
node
 =ğ
NULL
 ) {

1391 
node
 = 
	`ev’t_hook_®loc
Ğ
f
 );

1392 
node
->
Ãxt
 = *
²ode
;

1393 *
²ode
 = 
node
;

1396 iàĞ(
node
->
wª‹d
 & 
ev’ts
) !=ƒvents ) {

1398 
	`D
("event_looper_hook: call hook for %d (new=%x, old=%x)\n",

1399 
fd
, 
node
->
wª‹d
, 
ev’ts
);

1400 
f
->
şazz
->
	`_fh_hook
Ğf, 
ev’ts
 & ~
node
->
wª‹d
,‚ode );

1401 
node
->
wª‹d
 |ğ
ev’ts
;

1403 
	`D
("event_looper_hook: ignoringƒvents %x for %d wanted=%x)\n",

1404 
ev’ts
, 
fd
, 
node
->
wª‹d
);

1406 
	}
}

1409 
	$ev’t_loİ”_unhook
Ğ
Ev’tLoİ”
 
loİ”
, 
fd
, 
ev’ts
 )

1411 
FH
 
fh
 = 
	`_fh_äom_št
(
fd
);

1412 
Ev’tHook
 *
²ode
 = 
	`ev’t_loİ”_fšd_p
Ğ
loİ”
, 
fh
 );

1413 
Ev’tHook
 
node
 = *
²ode
;

1415 ià(
node
 !ğ
NULL
) {

1416 
ev’ts2
 = 
ev’ts
 & 
node
->
wª‹d
;

1417 iàĞ
ev’ts2
 == 0 ) {

1418 
	`D
Ğ"ev’t_loİ”_unhook:ƒv’t %x‚Ù„egi¡”ed fÜ fd %d\n", 
ev’ts
, 
fd
 );

1421 
node
->
wª‹d
 &ğ~
ev’ts2
;

1422 ià(!
node
->
wª‹d
) {

1423 *
²ode
 = 
node
->
Ãxt
;

1424 
	`ev’t_hook_ä“
Ğ
node
 );

1427 
	}
}

1448 
	#WAIT_ALL_CHUNK_SIZE
 63

	)

1451 
	sWa™FÜAÎP¬am
 {

1455 
HANDLE
 
	mmaš_ev’t
;

1464 
LONG
 vŞ©*
	msigÇËd_šdex
;

1466 
HANDLE
* 
	mhªdËs
;

1468 
	mhªdËs_couÁ
;

1470 
	mfœ¡_hªdË_šdex
;

1472 
HANDLE
 
	mth»ad
;

1473 } 
	tWa™FÜAÎP¬am
;

1476 
__¡dÿÎ


1477 
	$_š_wa™”_th»ad
(* 
¬g
)

1479 
HANDLE
 
wa™_Ú
[
WAIT_ALL_CHUNK_SIZE
 + 1];

1480 
»s
;

1481 
Wa™FÜAÎP¬am
* cÚ¡ 
·¿m
 = (Wa™FÜAÎP¬am*)
¬g
;

1485 
wa™_Ú
[0] = 
·¿m
->
maš_ev’t
;

1487 
	`memıy
(
wa™_Ú
 + 1, 
·¿m
->
hªdËs
,…¬am->
hªdËs_couÁ
 * (
HANDLE
));

1489 
»s
 = 
	`Wa™FÜMuÉËObjeùs
(
·¿m
->
hªdËs_couÁ
 + 1, 
wa™_Ú
, 
FALSE
, 
INFINITE
);

1490 ià(
»s
 > 0 &&„e < (
·¿m
->
hªdËs_couÁ
 + 1)) {

1493 
	`IÁ”lockedCom·»Exchªge
(
·¿m
->
sigÇËd_šdex
,

1494 
»s
 - 1L + 
·¿m
->
fœ¡_hªdË_šdex
, -1L);

1498 
	`S‘Ev’t
(
·¿m
->
maš_ev’t
);

1500 
	`_’dth»adex
(0);

1502 
	}
}

1513 
	$_wa™_fÜ_®l
(
HANDLE
* 
hªdËs
, 
hªdËs_couÁ
)

1515 
Wa™FÜAÎP¬am
* 
th»ads
;

1516 
HANDLE
 
maš_ev’t
;

1517 
chunks
, 
chunk
, 
»mašs
;

1529 vŞ©
LONG
 
sig_šdex
 = -1;

1532 
chunks
 = 
hªdËs_couÁ
 / 
WAIT_ALL_CHUNK_SIZE
;

1533 
»mašs
 = 
hªdËs_couÁ
 % 
WAIT_ALL_CHUNK_SIZE
;

1534 
th»ads
 = (
Wa™FÜAÎP¬am
*)
	`m®loc
((
chunks
 + (
»mašs
 ? 1 : 0)) *

1535 (
Wa™FÜAÎP¬am
));

1536 ià(
th»ads
 =ğ
NULL
) {

1537 
	`D
("UÇbËØ®loÿ‹h»ad‡¼ay fÜ %d hªdËs.", 
hªdËs_couÁ
);

1538  ()
WAIT_FAILED
;

1543 
maš_ev’t
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
FALSE
, NULL);

1544 ià(
maš_ev’t
 =ğ
NULL
) {

1545 
	`D
("UÇbËØü—‹ mašƒv’t. E¼Ü: %d", 
	`G‘La¡E¼Ü
());

1546 
	`ä“
(
th»ads
);

1547  ()
WAIT_FAILED
;

1554 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1555 
th»ads
[
chunk
].
maš_ev’t
 = main_event;

1556 
th»ads
[
chunk
].
sigÇËd_šdex
 = &
sig_šdex
;

1557 
th»ads
[
chunk
].
fœ¡_hªdË_šdex
 = 
WAIT_ALL_CHUNK_SIZE
 * chunk;

1558 
th»ads
[
chunk
].
hªdËs
 = hªdË +h»ads[chunk].
fœ¡_hªdË_šdex
;

1559 
th»ads
[
chunk
].
hªdËs_couÁ
 = 
WAIT_ALL_CHUNK_SIZE
;

1561 ià(
»mašs
) {

1562 
th»ads
[
chunk
].
maš_ev’t
 = main_event;

1563 
th»ads
[
chunk
].
sigÇËd_šdex
 = &
sig_šdex
;

1564 
th»ads
[
chunk
].
fœ¡_hªdË_šdex
 = 
WAIT_ALL_CHUNK_SIZE
 * chunk;

1565 
th»ads
[
chunk
].
hªdËs
 = hªdË +h»ads[chunk].
fœ¡_hªdË_šdex
;

1566 
th»ads
[
chunk
].
hªdËs_couÁ
 = 
»mašs
;

1567 
chunks
++;

1571 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1574 
th»ads
[
chunk
].
th»ad
 = (
HANDLE
)
	`_begšth»adex
(
NULL
, 0, 
_š_wa™”_th»ad
,

1575 &
th»ads
[
chunk
], 0, 
NULL
);

1576 ià(
th»ads
[
chunk
].
th»ad
 =ğ
NULL
) {

1578 
	`D
("Unableo create‡ waitinghread %d of %d.ƒrrno=%d",

1579 
chunk
, 
chunks
, 
”ºo
);

1580 
chunks
 = 
chunk
;

1581 
	`S‘Ev’t
(
maš_ev’t
);

1587 
	`Wa™FÜSšgËObjeù
(
maš_ev’t
, 
INFINITE
);

1590 
chunk
 = 0; chunk < 
chunks
; chunk++) {

1591 
	`Wa™FÜSšgËObjeù
(
th»ads
[
chunk
].
th»ad
, 
INFINITE
);

1592 
	`Clo£HªdË
(
th»ads
[
chunk
].
th»ad
);

1595 
	`Clo£HªdË
(
maš_ev’t
);

1596 
	`ä“
(
th»ads
);

1599 cÚ¡ 
»t
 = ()
	`IÁ”lockedCom·»Exchªge
(&
sig_šdex
, -1, -1);

1600  (
»t
 >ğ0è?„‘ : ()
WAIT_FAILED
;

1601 
	}
}

1603 
Ev’tLoİ”Rec
 
	gwš32_loİ”
;

1605 
	$fdev’t_š™
()

1607 
wš32_loİ”
.
hb_couÁ
 = 0;

1608 
wš32_loİ”
.
hooks
 = 
NULL
;

1609 
	}
}

1611 
	$fdev’t_cÚÃù
(
fdev’t
 *
fde
)

1613 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1614 
ev’ts
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1616 ià(
ev’ts
 != 0)

1617 
	`ev’t_loİ”_hook
Ğ
loİ”
, 
fde
->
fd
, 
ev’ts
 );

1618 
	}
}

1620 
	$fdev’t_discÚÃù
(
fdev’t
 *
fde
)

1622 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1623 
ev’ts
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1625 ià(
ev’ts
 != 0)

1626 
	`ev’t_loİ”_unhook
Ğ
loİ”
, 
fde
->
fd
, 
ev’ts
 );

1627 
	}
}

1629 
	$fdev’t_upd©e
(
fdev’t
 *
fde
, 
ev’ts
)

1631 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1632 
ev’ts0
 = 
fde
->
¡©e
 & 
FDE_EVENTMASK
;

1634 ià(
ev’ts
 !ğ
ev’ts0
) {

1635 
»moves
 = 
ev’ts0
 & ~
ev’ts
;

1636 
adds
 = 
ev’ts
 & ~
ev’ts0
;

1637 ià(
»moves
) {

1638 
	`D
("fdev’t_upd©e:„emov%x from %d\n", 
»moves
, 
fde
->
fd
);

1639 
	`ev’t_loİ”_unhook
Ğ
loİ”
, 
fde
->
fd
, 
»moves
 );

1641 ià(
adds
) {

1642 
	`D
("fdev’t_upd©e:‡dd %xØ%d\n", 
adds
, 
fde
->
fd
);

1643 
	`ev’t_loİ”_hook
 ( 
loİ”
, 
fde
->
fd
, 
adds
 );

1646 
	}
}

1648 
	$fdev’t_´oûss
()

1650 
Ev’tLoİ”
 
loİ”
 = &
wš32_loİ”
;

1651 
Ev’tHook
 
hook
;

1652 
gÙÚe
 = 0;

1655 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1656 
hook
->
»ady
 = 0;

1657 ià(
hook
->
´•¬e
) {

1658 
hook
->
	`´•¬e
(hook);

1659 ià(
hook
->
»ady
 != 0) {

1660 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1661 
gÙÚe
 = 1;

1667 ià(!
gÙÚe
)

1669 
loİ”
->
hb_couÁ
 = 0;

1671 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
)

1673 ià(
hook
->
¡¬t
 && !hook->
	`¡¬t
(hook)) {

1674 
	`D
( "fdevent_process:ƒrror when starting‡ hook\n" );

1677 ià(
hook
->
h
 !ğ
INVALID_HANDLE_VALUE
) {

1678 
Â
;

1680 
Â
 = 0;‚À< 
loİ”
->
hb_couÁ
;‚n++)

1682 iàĞ
loİ”
->
hb
[
Â
] =ğ
hook
->
h
 )

1683 
DÚtAdd
;

1685 
loİ”
->
hb
[†oİ”->
hb_couÁ
++ ] = 
hook
->
h
;

1686 
DÚtAdd
:

1691 ià(
loİ”
->
hb_couÁ
 == 0) {

1692 
	`D
( "fdevent_process:‚othingo wait for !!\n" );

1698 
wa™_»t
;

1700 
	`D
Ğ"adb_wš32: wa™šg fÜ %dƒv’ts\n", 
loİ”
->
hb_couÁ
 );

1701 ià(
loİ”
->
hb_couÁ
 > 
MAXIMUM_WAIT_OBJECTS
) {

1702 
	`D
("hªdË couÁ %dƒxûed MAXIMUM_WAIT_OBJECTS.\n", 
loİ”
->
hb_couÁ
);

1703 
wa™_»t
 = 
	`_wa™_fÜ_®l
(
loİ”
->
hb
,†oİ”->
hb_couÁ
);

1705 
wa™_»t
 = 
	`Wa™FÜMuÉËObjeùs
Ğ
loİ”
->
hb_couÁ
,†oİ”->
hb
, 
FALSE
, 
INFINITE
 );

1707 ià(
wa™_»t
 =ğ()
WAIT_FAILED
) {

1708 
	`D
Ğ"adb_wš32: wa™ faed,ƒ¼Ü %ld\n", 
	`G‘La¡E¼Ü
() );

1710 
	`D
Ğ"adb_wš32: gÙ oÃ (šdex %d)\n", 
wa™_»t
 );

1715 ià(()
wa™_»t
 < ()
loİ”
->
hb_couÁ
)

1717 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
)

1719 iàĞ
loİ”
->
hb
[
wa™_»t
] =ğ
hook
->
h
 &&

1720 (!
hook
->
check
 || hook->
	`check
(hook)) )

1722 
	`D
Ğ"adb_wš32: sigÇlšg % fÜ %x\n", 
hook
->
fh
->
Çme
, hook->
»ady
 );

1723 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1724 
gÙÚe
 = 1;

1731 !
gÙÚe
);

1733 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1734 ià(
hook
->
¡İ
)

1735 
hook
->
	`¡İ
( hook );

1739 
hook
 = 
loİ”
->
hooks
; hook; hook = hook->
Ãxt
) {

1740 ià(
hook
->
³ek
 && hook->
	`³ek
(hook))

1741 
	`ev’t_hook_sigÇl
Ğ
hook
 );

1743 
	}
}

1746 
	$fdev’t_»gi¡”
(
fdev’t
 *
fde
)

1748 
fd
 = 
fde
->fd - 
WIN32_FH_BASE
;

1750 if(
fd
 < 0) {

1751 
	`FATAL
("bogu Ãg©ivfd (%d)\n", 
fde
->
fd
);

1754 if(
fd
 >ğ
fd_bË_max
) {

1755 
Şdmax
 = 
fd_bË_max
;

1756 if(
fde
->
fd
 > 32000) {

1757 
	`FATAL
("bogu huuuugfd (%d)\n", 
fde
->
fd
);

1759 if(
fd_bË_max
 == 0) {

1760 
	`fdev’t_š™
();

1761 
fd_bË_max
 = 256;

1763 
fd_bË_max
 <ğ
fd
) {

1764 
fd_bË_max
 *= 2;

1766 
fd_bË
 = 
	`»®loc
(fd_bË, (
fdev’t
*è* 
fd_bË_max
);

1767 if(
fd_bË
 == 0) {

1768 
	`FATAL
("could‚Ùƒx·nd fd_bËØ%dƒÁr›s\n", 
fd_bË_max
);

1770 
	`mem£t
(
fd_bË
 + 
Şdmax
, 0, (è* (
fd_bË_max
 - oldmax));

1773 
fd_bË
[
fd
] = 
fde
;

1774 
	}
}

1776 
	$fdev’t_uÄegi¡”
(
fdev’t
 *
fde
)

1778 
fd
 = 
fde
->fd - 
WIN32_FH_BASE
;

1780 if((
fd
 < 0è|| (fd >ğ
fd_bË_max
)) {

1781 
	`FATAL
("fd ouˆoà¿ng(%d)\n", 
fde
->
fd
);

1784 if(
fd_bË
[
fd
] !ğ
fde
) {

1785 
	`FATAL
("fd_table out of sync");

1788 
fd_bË
[
fd
] = 0;

1790 if(!(
fde
->
¡©e
 & 
FDE_DONT_CLOSE
)) {

1791 
	`dump_fde
(
fde
, "close");

1792 
	`adb_şo£
(
fde
->
fd
);

1794 
	}
}

1796 
	$fdev’t_¶i¡_’queue
(
fdev’t
 *
node
)

1798 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

1800 
node
->
Ãxt
 = 
li¡
;

1801 
node
->
´ev
 = 
li¡
->prev;

1802 
node
->
´ev
->
Ãxt
 =‚ode;

1803 
li¡
->
´ev
 = 
node
;

1804 
	}
}

1806 
	$fdev’t_¶i¡_»move
(
fdev’t
 *
node
)

1808 
node
->
´ev
->
Ãxt
 =‚ode->next;

1809 
node
->
Ãxt
->
´ev
 =‚ode->prev;

1810 
node
->
Ãxt
 = 0;

1811 
node
->
´ev
 = 0;

1812 
	}
}

1814 
fdev’t
 *
	$fdev’t_¶i¡_dequeue
()

1816 
fdev’t
 *
li¡
 = &
li¡_³ndšg
;

1817 
fdev’t
 *
node
 = 
li¡
->
Ãxt
;

1819 if(
node
 =ğ
li¡
)  0;

1821 
li¡
->
Ãxt
 = 
node
->next;

1822 
li¡
->
Ãxt
->
´ev
 =†ist;

1823 
node
->
Ãxt
 = 0;

1824 
node
->
´ev
 = 0;

1826  
node
;

1827 
	}
}

1829 
fdev’t
 *
	$fdev’t_ü—‹
(
fd
, 
fd_func
 
func
, *
¬g
)

1831 
fdev’t
 *
fde
 = (fdev’t*è
	`m®loc
((fdevent));

1832 if(
fde
 == 0)  0;

1833 
	`fdev’t_š¡®l
(
fde
, 
fd
, 
func
, 
¬g
);

1834 
fde
->
¡©e
 |ğ
FDE_CREATED
;

1835  
fde
;

1836 
	}
}

1838 
	$fdev’t_de¡roy
(
fdev’t
 *
fde
)

1840 if(
fde
 == 0) ;

1841 if(!(
fde
->
¡©e
 & 
FDE_CREATED
)) {

1842 
	`FATAL
("fd%°nÙ c»©ed by fdev’t_ü—‹()\n", 
fde
);

1844 
	`fdev’t_»move
(
fde
);

1845 
	}
}

1847 
	$fdev’t_š¡®l
(
fdev’t
 *
fde
, 
fd
, 
fd_func
 
func
, *
¬g
)

1849 
	`mem£t
(
fde
, 0, (
fdev’t
));

1850 
fde
->
¡©e
 = 
FDE_ACTIVE
;

1851 
fde
->
fd
 = fd;

1852 
fde
->
func
 = func;

1853 
fde
->
¬g
 =‡rg;

1855 
	`fdev’t_»gi¡”
(
fde
);

1856 
	`dump_fde
(
fde
, "connect");

1857 
	`fdev’t_cÚÃù
(
fde
);

1858 
fde
->
¡©e
 |ğ
FDE_ACTIVE
;

1859 
	}
}

1861 
	$fdev’t_»move
(
fdev’t
 *
fde
)

1863 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

1864 
	`fdev’t_¶i¡_»move
(
fde
);

1867 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

1868 
	`fdev’t_discÚÃù
(
fde
);

1869 
	`dump_fde
(
fde
, "disconnect");

1870 
	`fdev’t_uÄegi¡”
(
fde
);

1873 
fde
->
¡©e
 = 0;

1874 
fde
->
ev’ts
 = 0;

1875 
	}
}

1878 
	$fdev’t_£t
(
fdev’t
 *
fde
, 
ev’ts
)

1880 
ev’ts
 &ğ
FDE_EVENTMASK
;

1882 if((
fde
->
¡©e
 & 
FDE_EVENTMASK
è=ğ()
ev’ts
) ;

1884 if(
fde
->
¡©e
 & 
FDE_ACTIVE
) {

1885 
	`fdev’t_upd©e
(
fde
, 
ev’ts
);

1886 
	`dump_fde
(
fde
, "update");

1889 
fde
->
¡©e
 = (fde->¡©& 
FDE_STATEMASK
è| 
ev’ts
;

1891 if(
fde
->
¡©e
 & 
FDE_PENDING
) {

1896 
fde
->
ev’ts
 &= (~events);

1897 if(
fde
->
ev’ts
 == 0) {

1898 
	`fdev’t_¶i¡_»move
(
fde
);

1899 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

1902 
	}
}

1904 
	$fdev’t_add
(
fdev’t
 *
fde
, 
ev’ts
)

1906 
	`fdev’t_£t
(

1907 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è| (
ev’ts
 & FDE_EVENTMASK));

1908 
	}
}

1910 
	$fdev’t_d–
(
fdev’t
 *
fde
, 
ev’ts
)

1912 
	`fdev’t_£t
(

1913 
fde
, (fde->
¡©e
 & 
FDE_EVENTMASK
è& (~(
ev’ts
 & FDE_EVENTMASK)));

1914 
	}
}

1916 
	$fdev’t_loİ
()

1918 
fdev’t
 *
fde
;

1921 #ià
DEBUG


1922 
	`årštf
(
¡d”r
,"--- ---- waiting forƒvents\n");

1924 
	`fdev’t_´oûss
();

1926 (
fde
 = 
	`fdev’t_¶i¡_dequeue
())) {

1927 
ev’ts
 = 
fde
->events;

1928 
fde
->
ev’ts
 = 0;

1929 
fde
->
¡©e
 &ğ(~
FDE_PENDING
);

1930 
	`dump_fde
(
fde
, "callback");

1931 
fde
->
	`func
(fde->
fd
, 
ev’ts
, fde->
¬g
);

1934 
	}
}

1939 
	$_ev’t_fe_´•¬e
Ğ
Ev’tHook
 
hook
 )

1941 ià(
hook
->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
)) {

1943 
hook
->
»ady
 |ğhook->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
);

1945 
	}
}

1947 
	$_ev’t_fe_³ek
Ğ
Ev’tHook
 
hook
 )

1949  (
hook
->
wª‹d
 & (
FDE_READ
|
FDE_WRITE
));

1950 
	}
}

1952 
	$_fh_fe_hook
Ğ
FH
 
f
, 
ev’ts
, 
Ev’tHook
 
hook
 )

1954 
hook
->
h
 = 
f
->
fh_hªdË
;

1955 
hook
->
´•¬e
 = 
_ev’t_fe_´•¬e
;

1956 
hook
->
³ek
 = 
_ev’t_fe_³ek
;

1957 
	}
}

1962 
	$_ev’t_sock‘_v”ify
Ğ
Ev’tHook
 
hook
, 
WSANETWORKEVENTS
* 
evts
 )

1964 iàĞ
evts
->
lN‘wÜkEv’ts
 & (
FD_READ
|
FD_ACCEPT
|
FD_CLOSE
) ) {

1965 ià(
hook
->
wª‹d
 & 
FDE_READ
)

1966 
hook
->
»ady
 |ğ
FDE_READ
;

1967 ià((
evts
->
iE¼ÜCode
[
FD_READ
] !ğ0è&& 
hook
->
wª‹d
 & 
FDE_ERROR
)

1968 
hook
->
»ady
 |ğ
FDE_ERROR
;

1970 iàĞ
evts
->
lN‘wÜkEv’ts
 & (
FD_WRITE
|
FD_CONNECT
|
FD_CLOSE
) ) {

1971 ià(
hook
->
wª‹d
 & 
FDE_WRITE
)

1972 
hook
->
»ady
 |ğ
FDE_WRITE
;

1973 ià((
evts
->
iE¼ÜCode
[
FD_WRITE
] !ğ0è&& 
hook
->
wª‹d
 & 
FDE_ERROR
)

1974 
hook
->
»ady
 |ğ
FDE_ERROR
;

1976 iàĞ
evts
->
lN‘wÜkEv’ts
 & 
FD_OOB
 ) {

1977 ià(
hook
->
wª‹d
 & 
FDE_ERROR
)

1978 
hook
->
»ady
 |ğ
FDE_ERROR
;

1980 
	}
}

1982 
	$_ev’t_sock‘_´•¬e
Ğ
Ev’tHook
 
hook
 )

1984 
WSANETWORKEVENTS
 
evts
;

1987 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
hook
->
fh
->
fh_sock‘
, 
NULL
, &
evts
 ))

1988 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

1989 
	}
}

1991 
	$_sock‘_wª‹d_to_æags
Ğ
wª‹d
 )

1993 
æags
 = 0;

1994 ià(
wª‹d
 & 
FDE_READ
)

1995 
æags
 |ğ
FD_READ
 | 
FD_ACCEPT
 | 
FD_CLOSE
;

1997 ià(
wª‹d
 & 
FDE_WRITE
)

1998 
æags
 |ğ
FD_WRITE
 | 
FD_CONNECT
 | 
FD_CLOSE
;

2000 ià(
wª‹d
 & 
FDE_ERROR
)

2001 
æags
 |ğ
FD_OOB
;

2003  
æags
;

2004 
	}
}

2006 
	$_ev’t_sock‘_¡¬t
Ğ
Ev’tHook
 
hook
 )

2009 
FH
 
fh
 = 
hook
->fh;

2010 
æags
 = 
	`_sock‘_wª‹d_to_æags
Ğ
hook
->
wª‹d
 );

2012 
hook
->
h
 = 
fh
->
ev’t
;

2013 ià(
hook
->
h
 =ğ
INVALID_HANDLE_VALUE
) {

2014 
	`D
Ğ"_ev’t_sock‘_¡¬t:‚Øev’ˆfÜ %s\n", 
fh
->
Çme
 );

2018 iàĞ
æags
 !ğ
fh
->
mask
 ) {

2019 
	`D
Ğ"_ev’t_sock‘_¡¬t: hookšg % fÜ %x (æag %ld)\n", 
hook
->
fh
->
Çme
, hook->
wª‹d
, 
æags
 );

2020 iàĞ
	`WSAEv’tS–eù
Ğ
fh
->
fh_sock‘
, 
hook
->
h
, 
æags
 ) ) {

2021 
	`D
Ğ"_ev’t_sock‘_¡¬t: WSAEv’tS–eù(èfÜ % çed,ƒ¼Ü %d\n", 
hook
->
fh
->
Çme
, 
	`WSAG‘La¡E¼Ü
() );

2022 
	`Clo£HªdË
Ğ
hook
->
h
 );

2023 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

2024 
	`ex™
(1);

2027 
fh
->
mask
 = 
æags
;

2030 
	}
}

2032 
	$_ev’t_sock‘_¡İ
Ğ
Ev’tHook
 
hook
 )

2034 
hook
->
h
 = 
INVALID_HANDLE_VALUE
;

2035 
	}
}

2037 
	$_ev’t_sock‘_check
Ğ
Ev’tHook
 
hook
 )

2039 
»suÉ
 = 0;

2040 
FH
 
fh
 = 
hook
->fh;

2041 
WSANETWORKEVENTS
 
evts
;

2043 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
fh
->
fh_sock‘
, 
hook
->
h
, &
evts
 ) ) {

2044 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

2045 
»suÉ
 = (
hook
->
»ady
 != 0);

2046 ià(
»suÉ
) {

2047 
	`Re£tEv’t
Ğ
hook
->
h
 );

2050 
	`D
Ğ"_ev’t_sock‘_check % »tuº %d\n", 
fh
->
Çme
, 
»suÉ
 );

2051  
»suÉ
;

2052 
	}
}

2054 
	$_ev’t_sock‘_³ek
Ğ
Ev’tHook
 
hook
 )

2056 
WSANETWORKEVENTS
 
evts
;

2057 
FH
 
fh
 = 
hook
->fh;

2060 ià(!
	`WSAEnumN‘wÜkEv’ts
Ğ
fh
->
fh_sock‘
, 
NULL
, &
evts
 )) {

2061 
	`_ev’t_sock‘_v”ify
Ğ
hook
, &
evts
 );

2062 ià(
hook
->
»ady
)

2063 
	`Re£tEv’t
Ğ
hook
->
h
 );

2066  
hook
->
»ady
 != 0;

2067 
	}
}

2071 
	$_fh_sock‘_hook
Ğ
FH
 
f
, 
ev’ts
, 
Ev’tHook
 
hook
 )

2073 
hook
->
´•¬e
 = 
_ev’t_sock‘_´•¬e
;

2074 
hook
->
¡¬t
 = 
_ev’t_sock‘_¡¬t
;

2075 
hook
->
¡İ
 = 
_ev’t_sock‘_¡İ
;

2076 
hook
->
check
 = 
_ev’t_sock‘_check
;

2077 
hook
->
³ek
 = 
_ev’t_sock‘_³ek
;

2079 
	`_ev’t_sock‘_¡¬t
Ğ
hook
 );

2080 
	}
}

2085 
	$_ev’t_sock‘·œ_´•¬e
Ğ
Ev’tHook
 
hook
 )

2087 
FH
 
fh
 = 
hook
->fh;

2088 
Sock‘Paœ
 
·œ
 = 
fh
->
fh_·œ
;

2089 
BBufãr
 
rb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
b2a_b
 : &·œ->
a2b_b
;

2090 
BBufãr
 
wb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
a2b_b
 : &·œ->
b2a_b
;

2092 ià(
hook
->
wª‹d
 & 
FDE_READ
 && 
rb
->
ÿn_»ad
)

2093 
hook
->
»ady
 |ğ
FDE_READ
;

2095 ià(
hook
->
wª‹d
 & 
FDE_WRITE
 && 
wb
->
ÿn_wr™e
)

2096 
hook
->
»ady
 |ğ
FDE_WRITE
;

2097 
	}
}

2099 
	$_ev’t_sock‘·œ_¡¬t
Ğ
Ev’tHook
 
hook
 )

2101 
FH
 
fh
 = 
hook
->fh;

2102 
Sock‘Paœ
 
·œ
 = 
fh
->
fh_·œ
;

2103 
BBufãr
 
rb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
b2a_b
 : &·œ->
a2b_b
;

2104 
BBufãr
 
wb
 = (
·œ
->
a_fd
 =ğ
fh
è? &·œ->
a2b_b
 : &·œ->
b2a_b
;

2106 ià(
hook
->
wª‹d
 =ğ
FDE_READ
)

2107 
hook
->
h
 = 
rb
->
evt_»ad
;

2109 ià(
hook
->
wª‹d
 =ğ
FDE_WRITE
)

2110 
hook
->
h
 = 
wb
->
evt_wr™e
;

2113 
	`D
("_event_socketpair_start: can't handle FDE_READ+FDE_WRITE\n" );

2116 
	`D
( "_event_socketpair_start: hook %s for %x wanted=%x\n",

2117 
hook
->
fh
->
Çme
, 
	`_fh_to_št
(fh), hook->
wª‹d
);

2119 
	}
}

2121 
	$_ev’t_sock‘·œ_³ek
Ğ
Ev’tHook
 
hook
 )

2123 
	`_ev’t_sock‘·œ_´•¬e
Ğ
hook
 );

2124  
hook
->
»ady
 != 0;

2125 
	}
}

2127 
	$_fh_sock‘·œ_hook
Ğ
FH
 
fh
, 
ev’ts
, 
Ev’tHook
 
hook
 )

2129 
hook
->
´•¬e
 = 
_ev’t_sock‘·œ_´•¬e
;

2130 
hook
->
¡¬t
 = 
_ev’t_sock‘·œ_¡¬t
;

2131 
hook
->
³ek
 = 
_ev’t_sock‘·œ_³ek
;

2132 
	}
}

2136 
	$adb_sysd•s_š™
( )

2138 
	#ADB_MUTEX
(
x
è
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ& x );

	)

2139 
	~"mu‹x_li¡.h
"

2140 
	`In™ŸlizeCr™iÿlSeùiÚ
Ğ&
_wš32_lock
 );

2141 
	}
}

2175 
	$adb_¡¹ok_r
(*
s
, cÚ¡ *
d–im
, **
Ï¡
)

2177 *
¥ªp
;

2178 
c
, 
sc
;

2179 *
tok
;

2182 ià(
s
 =ğ
NULL
 && ( ğ*
Ï¡
) == NULL)

2183  (
NULL
);

2188 
cÚt
:

2189 
c
 = *
s
++;

2190 
¥ªp
 = (*)
d–im
; (
sc
 = *spanp++) != 0;) {

2191 ià(
c
 =ğ
sc
)

2192 
cÚt
;

2195 ià(
c
 == 0) {

2196 *
Ï¡
 = 
NULL
;

2197  (
NULL
);

2199 
tok
 = 
s
 - 1;

2206 
c
 = *
s
++;

2207 
¥ªp
 = (*)
d–im
;

2209 ià((
sc
 = *
¥ªp
++è=ğ
c
) {

2210 ià(
c
 == 0)

2211 
s
 = 
NULL
;

2213 
s
[-1] = 0;

2214 *
Ï¡
 = 
s
;

2215  (
tok
);

2217 } 
sc
 != 0);

2220 
	}
}

	@test_track_devices.c

2 
	~<Ãtdb.h
>

3 
	~<sys/sock‘.h
>

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<”ºo.h
>

7 
	~<memÜy.h
>

10 
	$·nic
ĞcÚ¡ * 
msg
 )

12 
	`årštf
(
¡d”r
, "PANIC: %s: %s\n", 
msg
, 
	`¡»¼Ü
(
”ºo
));

13 
	`ex™
(1);

14 
	}
}

17 
	$unix_wr™e
Ğ
fd
, cÚ¡ * 
buf
, 
Ën
 )

19 
»suÉ
 = 0;

20 
Ën
 > 0) {

21 
Ën2
 = 
	`wr™e
(
fd
, 
buf
, 
Ën
);

22 ià(
Ën2
 < 0) {

23 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

27 
»suÉ
 +ğ
Ën2
;

28 
Ën
 -ğ
Ën2
;

29 
buf
 +ğ
Ën2
;

31  
»suÉ
;

32 
	}
}

35 
	$unix_»ad
Ğ
fd
, * 
buf
, 
Ën
 )

37 
»suÉ
 = 0;

38 
Ën
 > 0) {

39 
Ën2
 = 
	`»ad
(
fd
, 
buf
, 
Ën
);

40 ià(
Ën2
 < 0) {

41 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

45 
»suÉ
 +ğ
Ën2
;

46 
Ën
 -ğ
Ën2
;

47 
buf
 +ğ
Ën2
;

49  
»suÉ
;

50 
	}
}

53 
	$maš
( )

55 
»t
, 
s
;

56 
sockaddr_š
 
£rv”
;

57 
bufãr
[1024];

58 cÚ¡ * 
»que¡
 = "host:track-devices";

59 
Ën
;

61 
	`mem£t
Ğ&
£rv”
, 0, (server) );

62 
£rv”
.
sš_çmy
 = 
AF_INET
;

63 
£rv”
.
sš_pÜt
 = 
	`htÚs
(5037);

64 
£rv”
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

66 
s
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

67 
»t
 = 
	`cÚÃù
Ğ
s
, (
sockaddr
*è&
£rv”
, (server) );

68 ià(
»t
 < 0è
	`·nic
( "could‚ot connecto server" );

71 
Ën
 = 
	`¢´štf
Ğ
bufãr
,  bufãr, "%04x%s", 
	`¡¾’
(
»que¡
),„equest );

72 ià(
	`unix_wr™e
(
s
, 
bufãr
, 
Ën
) < 0)

73 
	`·nic
( "could‚ot send„equest" );

76 ià(
	`unix_»ad
(
s
, 
bufãr
, 4) != 4)

77 
	`·nic
( "could‚ot„ead„equest" );

79 
	`´štf
Ğ"£rv”‡nsw”: %.*s\n", 4, 
bufãr
 );

83 
h—d
[5] = "0000";

85 ià(
	`unix_»ad
(
s
, 
h—d
, 4) < 0)

86 
	`·nic
("could‚ot„ead†ength");

88 iàĞ
	`ssÿnf
Ğ
h—d
, "%04x", &
Ën
 ) != 1 )

89 
	`·nic
("could‚ot decode†ength");

91 ià(
	`unix_»ad
(
s
, 
bufãr
, 
Ën
) !=†en)

92 
	`·nic
("could‚ot„ead data");

94 
	`´štf
Ğ"»ûived h—d” %.* (%d by‹s):\n%.*s", 4, 
h—d
, 
Ën
,†’, 
bufãr
 );

96 
	`şo£
(
s
);

97 
	}
}

	@test_track_jdwp.c

2 
	~<Ãtdb.h
>

3 
	~<sys/sock‘.h
>

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<”ºo.h
>

7 
	~<memÜy.h
>

10 
	$·nic
ĞcÚ¡ * 
msg
 )

12 
	`årštf
(
¡d”r
, "PANIC: %s: %s\n", 
msg
, 
	`¡»¼Ü
(
”ºo
));

13 
	`ex™
(1);

14 
	}
}

17 
	$unix_wr™e
Ğ
fd
, cÚ¡ * 
buf
, 
Ën
 )

19 
»suÉ
 = 0;

20 
Ën
 > 0) {

21 
Ën2
 = 
	`wr™e
(
fd
, 
buf
, 
Ën
);

22 ià(
Ën2
 < 0) {

23 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

27 
»suÉ
 +ğ
Ën2
;

28 
Ën
 -ğ
Ën2
;

29 
buf
 +ğ
Ën2
;

31  
»suÉ
;

32 
	}
}

35 
	$unix_»ad
Ğ
fd
, * 
buf
, 
Ën
 )

37 
»suÉ
 = 0;

38 
Ën
 > 0) {

39 
Ën2
 = 
	`»ad
(
fd
, 
buf
, 
Ën
);

40 ià(
Ën2
 < 0) {

41 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

45 
»suÉ
 +ğ
Ën2
;

46 
Ën
 -ğ
Ën2
;

47 
buf
 +ğ
Ën2
;

49  
»suÉ
;

50 
	}
}

53 
	$maš
( )

55 
»t
, 
s
;

56 
sockaddr_š
 
£rv”
;

57 
bufãr
[1024];

58 cÚ¡ * 
»que¡
 = "track-jdwp";

59 
Ën
;

61 
	`mem£t
Ğ&
£rv”
, 0, (server) );

62 
£rv”
.
sš_çmy
 = 
AF_INET
;

63 
£rv”
.
sš_pÜt
 = 
	`htÚs
(5037);

64 
£rv”
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

66 
s
 = 
	`sock‘
Ğ
PF_INET
, 
SOCK_STREAM
, 0 );

67 
»t
 = 
	`cÚÃù
Ğ
s
, (
sockaddr
*è&
£rv”
, (server) );

68 ià(
»t
 < 0è
	`·nic
( "could‚ot connecto server" );

71 
Ën
 = 
	`¢´štf
Ğ
bufãr
,  bufãr, "%04x%s", 
	`¡¾’
(
»que¡
),„equest );

72 ià(
	`unix_wr™e
(
s
, 
bufãr
, 
Ën
) < 0)

73 
	`·nic
( "could‚ot send„equest" );

76 ià(
	`unix_»ad
(
s
, 
bufãr
, 4) != 4)

77 
	`·nic
( "could‚ot„ead„equest" );

79 
	`´štf
Ğ"£rv”‡nsw”: %.*s\n", 4, 
bufãr
 );

83 
h—d
[5] = "0000";

85 ià(
	`unix_»ad
(
s
, 
h—d
, 4) < 0)

86 
	`·nic
("could‚ot„ead†ength");

88 iàĞ
	`ssÿnf
Ğ
h—d
, "%04x", &
Ën
 ) != 1 )

89 
	`·nic
("could‚ot decode†ength");

91 ià(
	`unix_»ad
(
s
, 
bufãr
, 
Ën
) !=†en)

92 
	`·nic
("could‚ot„ead data");

94 
	`´štf
Ğ"»ûived h—d” %.* (%d by‹s):\n%.*s", 4, 
h—d
, 
Ën
,†’, 
bufãr
 );

96 
	`şo£
(
s
);

97 
	}
}

	@transport.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

21 
	~<”ºo.h
>

23 
	~"sysd•s.h
"

25 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

26 
	~"adb.h
"

28 
Œª¥Üt_uÄef
(
©¿n¥Üt
 *
t
);

30 
©¿n¥Üt
 
	gŒª¥Üt_li¡
 = {

31 .
Ãxt
 = &
Œª¥Üt_li¡
,

32 .
	g´ev
 = &
Œª¥Üt_li¡
,

35 
ADB_MUTEX_DEFINE
Ğ
Œª¥Üt_lock
 );

37 #ià
ADB_TRACE


38 
	#MAX_DUMP_HEX_LEN
 16

	)

39 
	$dump_hex
ĞcÚ¡ * 
±r
, 
size_t
 
Ën
 )

41 
Â
, 
Ën2
 = 
Ën
;

44 
bufãr
[
MAX_DUMP_HEX_LEN
 *2 + 1 + MAX_DUMP_HEX_LEN + 1 ], *
pb
 = buffer;

46 ià(
Ën2
 > 
MAX_DUMP_HEX_LEN
)†en2 = MAX_DUMP_HEX_LEN;

48 
Â
 = 0;‚À< 
Ën2
;‚n++) {

49 
	`¥rštf
(
pb
, "%02x", 
±r
[
Â
]);

50 
pb
 += 2;

52 
	`¥rštf
(
pb
++, " ");

54 
Â
 = 0;‚À< 
Ën2
;‚n++) {

55 
c
 = 
±r
[
Â
];

56 ià(
c
 < 32 || c > 127)

57 
c
 = '.';

58 *
pb
++ = 
c
;

60 *
pb
++ = '\0';

61 
	`DR
("%s\n", 
bufãr
);

62 
	}
}

66 
	$kick_Œª¥Üt
(
©¿n¥Üt
* 
t
)

68 ià(
t
 && !t->
kicked
)

70 
kicked
;

72 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

73 
kicked
 = 
t
->kicked;

74 ià(!
kicked
)

75 
t
->
kicked
 = 1;

76 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

78 ià(!
kicked
)

79 
t
->
	`kick
(t);

81 
	}
}

84 
	$run_Œª¥Üt_discÚÃùs
(
©¿n¥Üt
* 
t
)

86 
adiscÚÃù
* 
dis
 = 
t
->
discÚÃùs
.
Ãxt
;

88 
	`D
("%s:„un_Œª¥Üt_discÚÃùs\n", 
t
->
£rŸl
);

89 
dis
 !ğ&
t
->
discÚÃùs
) {

90 
adiscÚÃù
* 
Ãxt
 = 
dis
->next;

91 
dis
->
	`func
Ğdis->
İaque
, 
t
 );

92 
dis
 = 
Ãxt
;

94 
	}
}

96 #ià
ADB_TRACE


98 
	$dump_·ck‘
(cÚ¡ * 
Çme
, cÚ¡ * 
func
, 
­ack‘
* 
p
)

100 
commªd
 = 
p
->
msg
.command;

101 
Ën
 = 
p
->
msg
.
d©a_Ëngth
;

102 
cmd
[9];

103 
¬g0
[12], 
¬g1
[12];

104 
n
;

106 
n
 = 0;‚ < 4;‚++) {

107 
b
 = (
commªd
 >> (
n
*8)) & 255;

108 ià(
b
 < 32 || b >= 127)

110 
cmd
[
n
] = ()
b
;

112 ià(
n
 == 4) {

113 
cmd
[4] = 0;

117 
	`¢´štf
(
cmd
,  cmd, "%08x", 
commªd
);

120 ià(
p
->
msg
.
¬g0
 < 256U)

121 
	`¢´štf
(
¬g0
, ‡rg0, "%d", 
p
->
msg
.arg0);

123 
	`¢´štf
(
¬g0
, ‡rg0, "0x%x", 
p
->
msg
.arg0);

125 ià(
p
->
msg
.
¬g1
 < 256U)

126 
	`¢´štf
(
¬g1
, ‡rg1, "%d", 
p
->
msg
.arg1);

128 
	`¢´štf
(
¬g1
, ‡rg1, "0x%x", 
p
->
msg
.arg1);

130 
	`D
("%s: %s: [%s]‡rg0=%s‡rg1=%s (len=%d) ",

131 
Çme
, 
func
, 
cmd
, 
¬g0
, 
¬g1
, 
Ën
);

132 
	`dump_hex
(
p
->
d©a
, 
Ën
);

133 
	}
}

137 
	$»ad_·ck‘
(
fd
, cÚ¡ * 
Çme
, 
­ack‘
** 
µack‘
)

139 *
p
 = (*)
µack‘
;

140 
r
;

141 
Ën
 = (*
µack‘
);

142 
buff
[8];

143 ià(!
Çme
) {

144 
	`¢´štf
(
buff
,  buff, "fd=%d", 
fd
);

145 
Çme
 = 
buff
;

147 
Ën
 > 0) {

148 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

149 if(
r
 > 0) {

150 
Ën
 -ğ
r
;

151 
p
 +ğ
r
;

153 
	`D
("%s:„—d_·ck‘ (fd=%d),ƒ¼Ü„‘=%dƒ¼no=%d: %s\n", 
Çme
, 
fd
, 
r
, 
”ºo
, 
	`¡»¼Ü
(errno));

154 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

159 #ià
ADB_TRACE


160 ià(
ADB_TRACING
) {

161 
	`dump_·ck‘
(
Çme
, "äom„emÙe", *
µack‘
);

165 
	}
}

168 
	$wr™e_·ck‘
(
fd
, cÚ¡ * 
Çme
, 
­ack‘
** 
µack‘
)

170 *
p
 = (*è
µack‘
;

171 
r
, 
Ën
 = (
µack‘
);

172 
buff
[8];

173 ià(!
Çme
) {

174 
	`¢´štf
(
buff
,  buff, "fd=%d", 
fd
);

175 
Çme
 = 
buff
;

178 #ià
ADB_TRACE


179 ià(
ADB_TRACING
) {

180 
	`dump_·ck‘
(
Çme
, "tØ»mÙe", *
µack‘
);

183 
Ën
 = (
µack‘
);

184 
Ën
 > 0) {

185 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

186 if(
r
 > 0) {

187 
Ën
 -ğ
r
;

188 
p
 +ğ
r
;

190 
	`D
("%s: wr™e_·ck‘ (fd=%dè”rÜ„‘=%dƒ¼no=%d: %s\n", 
Çme
, 
fd
, 
r
, 
”ºo
, 
	`¡»¼Ü
(errno));

191 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

196 
	}
}

198 
	$Œª¥Üt_sock‘_ev’ts
(
fd
, 
ev’ts
, *
_t
)

200 
©¿n¥Üt
 *
t
 = 
_t
;

201 
	`D
("Œª¥Üt_sock‘_ev’ts(fd=%d,ƒv’ts=%04x,...)\n", 
fd
, 
ev’ts
);

202 if(
ev’ts
 & 
FDE_READ
){

203 
­ack‘
 *
p
 = 0;

204 if(
	`»ad_·ck‘
(
fd
, 
t
->
£rŸl
, &
p
)){

205 
	`D
("%s: faedØ»ad…ack‘ from¿n¥Üˆsock‘ oÀfd %d\n", 
t
->
£rŸl
, 
fd
);

207 
	`hªdË_·ck‘
(
p
, (
©¿n¥Üt
 *è
_t
);

210 
	}
}

212 
	$£nd_·ck‘
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

214 *
x
;

215 
sum
;

216 
couÁ
;

218 
p
->
msg
.
magic
 =…->msg.
commªd
 ^ 0xffffffff;

220 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

221 
x
 = (*è
p
->
d©a
;

222 
sum
 = 0;

223 
couÁ
-- > 0){

224 
sum
 +ğ*
x
++;

226 
p
->
msg
.
d©a_check
 = 
sum
;

228 
	`´št_·ck‘
("£nd", 
p
);

230 ià(
t
 =ğ
NULL
) {

231 
	`D
("Transport is‚ull \n");

233 
”ºo
 = 0;

234 
	`çl_”ºo
("Transport is‚ull");

237 if(
	`wr™e_·ck‘
(
t
->
Œª¥Üt_sock‘
,->
£rŸl
, &
p
)){

238 
	`çl_”ºo
("cannotƒnqueue…acket onransport socket");

240 
	}
}

255 *
	$ouut_th»ad
(*
_t
)

257 
©¿n¥Üt
 *
t
 = 
_t
;

258 
­ack‘
 *
p
;

260 
	`D
("%s: startingransport outputhread on fd %d, SYNC online (%d)\n",

261 
t
->
£rŸl
,->
fd
,->
sync_tok’
 + 1);

262 
p
 = 
	`g‘_­ack‘
();

263 
p
->
msg
.
commªd
 = 
A_SYNC
;

264 
p
->
msg
.
¬g0
 = 1;

265 
p
->
msg
.
¬g1
 = ++(
t
->
sync_tok’
);

266 
p
->
msg
.
magic
 = 
A_SYNC
 ^ 0xffffffff;

267 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

268 
	`put_­ack‘
(
p
);

269 
	`D
("%s: faedØwr™SYNC…ack‘\n", 
t
->
£rŸl
);

270 
oİs
;

273 
	`D
("%s: d©¨pum°¡¬‹d\n", 
t
->
£rŸl
);

275 
p
 = 
	`g‘_­ack‘
();

277 if(
t
->
	`»ad_äom_»mÙe
(
p
,) == 0){

278 
	`D
("%s:„eceived„emote…acket, sendingoransport\n",

279 
t
->
£rŸl
);

280 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)){

281 
	`put_­ack‘
(
p
);

282 
	`D
("%s: faedØwr™­ack‘ØŒª¥Üt\n", 
t
->
£rŸl
);

283 
oİs
;

286 
	`D
("%s:„emÙ»ad faed fÜ¿n¥Üt\n", 
t
->
£rŸl
);

287 
	`put_­ack‘
(
p
);

292 
	`D
("%s: SYNC ofæšfÜ¿n¥Üt\n", 
t
->
£rŸl
);

293 
p
 = 
	`g‘_­ack‘
();

294 
p
->
msg
.
commªd
 = 
A_SYNC
;

295 
p
->
msg
.
¬g0
 = 0;

296 
p
->
msg
.
¬g1
 = 0;

297 
p
->
msg
.
magic
 = 
A_SYNC
 ^ 0xffffffff;

298 if(
	`wr™e_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

299 
	`put_­ack‘
(
p
);

300 
	`D
("%s: faedØwr™SYNC‡·ck‘ØŒª¥Üt", 
t
->
£rŸl
);

303 
oİs
:

304 
	`D
("%s:¿n¥Üˆouuˆth»ad i ex™šg\n", 
t
->
£rŸl
);

305 
	`kick_Œª¥Üt
(
t
);

306 
	`Œª¥Üt_uÄef
(
t
);

308 
	}
}

310 *
	$šput_th»ad
(*
_t
)

312 
©¿n¥Üt
 *
t
 = 
_t
;

313 
­ack‘
 *
p
;

314 
aùive
 = 0;

316 
	`D
("%s: startingransport inputhread,„eading from fd %d\n",

317 
t
->
£rŸl
,->
fd
);

320 if(
	`»ad_·ck‘
(
t
->
fd
,->
£rŸl
, &
p
)) {

321 
	`D
("%s: failedo„ead‡packet fromransport on fd %d\n",

322 
t
->
£rŸl
,->
fd
 );

325 if(
p
->
msg
.
commªd
 =ğ
A_SYNC
){

326 if(
p
->
msg
.
¬g0
 == 0) {

327 
	`D
("%s:¿n¥ÜˆSYNC ofæše\n", 
t
->
£rŸl
);

328 
	`put_­ack‘
(
p
);

331 if(
p
->
msg
.
¬g1
 =ğ
t
->
sync_tok’
) {

332 
	`D
("%s:¿n¥ÜˆSYNC oÆše\n", 
t
->
£rŸl
);

333 
aùive
 = 1;

335 
	`D
("%s:ransport ignoring SYNC %d != %d\n",

336 
t
->
£rŸl
, 
p
->
msg
.
¬g1
,->
sync_tok’
);

340 if(
aùive
) {

341 
	`D
("%s:¿n¥ÜˆgÙ…ack‘, s’dšgØ»mÙe\n", 
t
->
£rŸl
);

342 
t
->
	`wr™e_to_»mÙe
(
p
,);

344 
	`D
("%s:¿n¥ÜˆignÜšg…ack‘ whofæše\n", 
t
->
£rŸl
);

348 
	`put_­ack‘
(
p
);

353 
	`şo£_®l_sock‘s
(
t
);

355 
	`D
("%s:¿n¥Üˆšpuˆth»ad i ex™šg, fd %d\n", 
t
->
£rŸl
,->
fd
);

356 
	`kick_Œª¥Üt
(
t
);

357 
	`Œª¥Üt_uÄef
(
t
);

359 
	}
}

362 
	gŒª¥Üt_»gi¡¿tiÚ_£nd
 = -1;

363 
	gŒª¥Üt_»gi¡¿tiÚ_»cv
 = -1;

364 
fdev’t
 
	gŒª¥Üt_»gi¡¿tiÚ_fde
;

367 #ià
ADB_HOST


368 
	$li¡_Œª¥Üts_msg
(* 
bufãr
, 
size_t
 
bufã¾’
)

370 
h—d
[5];

371 
Ën
;

373 
Ën
 = 
	`li¡_Œª¥Üts
(
bufãr
+4, 
bufã¾’
-4, 0);

374 
	`¢´štf
(
h—d
, (h—d), "%04x", 
Ën
);

375 
	`memıy
(
bufãr
, 
h—d
, 4);

376 
Ën
 += 4;

377  
Ën
;

378 
	}
}

385 
deviû_Œack”
 
	tdeviû_Œack”
;

386 
	sdeviû_Œack”
 {

387 
asock‘
 
	msock‘
;

388 
	mupd©e_Ãeded
;

389 
deviû_Œack”
* 
	mÃxt
;

393 
deviû_Œack”
* 
	gdeviû_Œack”_li¡
;

396 
	$deviû_Œack”_»move
Ğ
deviû_Œack”
* 
Œack”
 )

398 
deviû_Œack”
** 
²ode
 = &
deviû_Œack”_li¡
;

399 
deviû_Œack”
* 
node
 = *
²ode
;

401 
	`adb_mu‹x_lock
Ğ&
Œª¥Üt_lock
 );

402 
node
) {

403 ià(
node
 =ğ
Œack”
) {

404 *
²ode
 = 
node
->
Ãxt
;

407 
²ode
 = &
node
->
Ãxt
;

408 
node
 = *
²ode
;

410 
	`adb_mu‹x_uÆock
Ğ&
Œª¥Üt_lock
 );

411 
	}
}

414 
	$deviû_Œack”_şo£
Ğ
asock‘
* 
sock‘
 )

416 
deviû_Œack”
* 
Œack”
 = (deviû_Œack”*è
sock‘
;

417 
asock‘
* 
³”
 = 
sock‘
->peer;

419 
	`D
Ğ"deviû¿ck” %°»moved\n", 
Œack”
);

420 ià(
³”
) {

421 
³”
->³” = 
NULL
;

422 
³”
->
	`şo£
(peer);

424 
	`deviû_Œack”_»move
(
Œack”
);

425 
	`ä“
(
Œack”
);

426 
	}
}

429 
	$deviû_Œack”_’queue
Ğ
asock‘
* 
sock‘
, 
­ack‘
* 
p
 )

432 
	`put_­ack‘
(
p
);

433 
	`deviû_Œack”_şo£
(
sock‘
);

435 
	}
}

438 
	$deviû_Œack”_£nd
Ğ
deviû_Œack”
* 
Œack”
,

439 cÚ¡ * 
bufãr
,

440 
Ën
 )

442 
­ack‘
* 
p
 = 
	`g‘_­ack‘
();

443 
asock‘
* 
³”
 = 
Œack”
->
sock‘
.peer;

445 
	`memıy
(
p
->
d©a
, 
bufãr
, 
Ën
);

446 
p
->
Ën
 =†en;

447  
³”
->
	`’queue
Ğ³”, 
p
 );

448 
	}
}

452 
	$deviû_Œack”_»ady
Ğ
asock‘
* 
sock‘
 )

454 
deviû_Œack”
* 
Œack”
 = (deviû_Œack”*è
sock‘
;

458 ià(
Œack”
->
upd©e_Ãeded
 > 0) {

459 
bufãr
[1024];

460 
Ën
;

462 
Œack”
->
upd©e_Ãeded
 = 0;

464 
Ën
 = 
	`li¡_Œª¥Üts_msg
(
bufãr
, (buffer));

465 
	`deviû_Œack”_£nd
(
Œack”
, 
bufãr
, 
Ën
);

467 
	}
}

470 
asock‘
*

471 
	$ü—‹_deviû_Œack”
()

473 
deviû_Œack”
* 
Œack”
 = 
	`ÿÎoc
(1,(*tracker));

475 if(
Œack”
 =ğ0è
	`çl
("cannot‡llocate deviceracker");

477 
	`D
Ğ"deviû¿ck” %°ü—‹d\n", 
Œack”
);

479 
Œack”
->
sock‘
.
’queue
 = 
deviû_Œack”_’queue
;

480 
Œack”
->
sock‘
.
»ady
 = 
deviû_Œack”_»ady
;

481 
Œack”
->
sock‘
.
şo£
 = 
deviû_Œack”_şo£
;

482 
Œack”
->
upd©e_Ãeded
 = 1;

484 
Œack”
->
Ãxt
 = 
deviû_Œack”_li¡
;

485 
deviû_Œack”_li¡
 = 
Œack”
;

487  &
Œack”
->
sock‘
;

488 
	}
}

492 
	$upd©e_Œª¥Üts
()

494 
bufãr
[1024];

495 
Ën
;

496 
deviû_Œack”
* 
Œack”
;

498 
Ën
 = 
	`li¡_Œª¥Üts_msg
(
bufãr
, (buffer));

500 
Œack”
 = 
deviû_Œack”_li¡
;

501 
Œack”
 !ğ
NULL
) {

502 
deviû_Œack”
* 
Ãxt
 = 
Œack”
->next;

504 
	`deviû_Œack”_£nd
(
Œack”
, 
bufãr
, 
Ën
);

505 
Œack”
 = 
Ãxt
;

507 
	}
}

509 
	$upd©e_Œª¥Üts
()

512 
	}
}

515 
tmsg
 
	ttmsg
;

516 
	stmsg


518 
©¿n¥Üt
 *
	mŒª¥Üt
;

519 
	maùiÚ
;

523 
	$Œª¥Üt_»ad_aùiÚ
(
fd
, 
tmsg
* 
m
)

525 *
p
 = (*)
m
;

526 
Ën
 = (*
m
);

527 
r
;

529 
Ën
 > 0) {

530 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

531 if(
r
 > 0) {

532 
Ën
 -ğ
r
;

533 
p
 +ğ
r
;

535 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

536 
	`D
("transport_read_action: on fd %d,ƒrror %d: %s\n",

537 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

542 
	}
}

545 
	$Œª¥Üt_wr™e_aùiÚ
(
fd
, 
tmsg
* 
m
)

547 *
p
 = (*)
m
;

548 
Ën
 = (*
m
);

549 
r
;

551 
Ën
 > 0) {

552 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

553 if(
r
 > 0) {

554 
Ën
 -ğ
r
;

555 
p
 +ğ
r
;

557 if((
r
 < 0è&& (
”ºo
 =ğ
EINTR
)) ;

558 
	`D
("transport_write_action: on fd %d,ƒrror %d: %s\n",

559 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

564 
	}
}

566 
	$Œª¥Üt_»gi¡¿tiÚ_func
(
_fd
, 
ev
, *
d©a
)

568 
tmsg
 
m
;

569 
adb_th»ad_t
 
ouut_th»ad_±r
;

570 
adb_th»ad_t
 
šput_th»ad_±r
;

571 
s
[2];

572 
©¿n¥Üt
 *
t
;

574 if(!(
ev
 & 
FDE_READ
)) {

578 if(
	`Œª¥Üt_»ad_aùiÚ
(
_fd
, &
m
)) {

579 
	`çl_”ºo
("cannot„eadransport„egistration socket");

582 
t
 = 
m
.
Œª¥Üt
;

584 if(
m
.
aùiÚ
 == 0){

585 
	`D
("Œª¥Üt: % »movšg‡nd f»e'šg %d\n", 
t
->
£rŸl
,->
Œª¥Üt_sock‘
);

590 
	`fdev’t_»move
(&(
t
->
Œª¥Üt_fde
));

591 
	`adb_şo£
(
t
->
fd
);

593 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

594 
t
->
Ãxt
->
´ev
 =->prev;

595 
t
->
´ev
->
Ãxt
 =->next;

596 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

598 
	`run_Œª¥Üt_discÚÃùs
(
t
);

600 ià(
t
->
´oduù
)

601 
	`ä“
(
t
->
´oduù
);

602 ià(
t
->
£rŸl
)

603 
	`ä“
(
t
->
£rŸl
);

604 ià(
t
->
mod–
)

605 
	`ä“
(
t
->
mod–
);

606 ià(
t
->
deviû
)

607 
	`ä“
(
t
->
deviû
);

608 ià(
t
->
dev·th
)

609 
	`ä“
(
t
->
dev·th
);

611 
	`mem£t
(
t
,0x“,(
©¿n¥Üt
));

612 
	`ä“
(
t
);

614 
	`upd©e_Œª¥Üts
();

619 ià(
t
->
cÚÃùiÚ_¡©e
 !ğ
CS_NOPERM
) {

621 
t
->
»f_couÁ
 = 2;

623 if(
	`adb_sock‘·œ
(
s
)) {

624 
	`çl_”ºo
("cannot openransport socketpair");

627 
	`D
("Œª¥Üt: % (%d,%dè¡¬tšg\n", 
t
->
£rŸl
, 
s
[0], s[1]);

629 
t
->
Œª¥Üt_sock‘
 = 
s
[0];

630 
t
->
fd
 = 
s
[1];

632 
	`fdev’t_š¡®l
(&(
t
->
Œª¥Üt_fde
),

633 
t
->
Œª¥Üt_sock‘
,

634 
Œª¥Üt_sock‘_ev’ts
,

635 
t
);

637 
	`fdev’t_£t
(&(
t
->
Œª¥Üt_fde
), 
FDE_READ
);

639 if(
	`adb_th»ad_ü—‹
(&
šput_th»ad_±r
, 
šput_th»ad
, 
t
)){

640 
	`çl_”ºo
("cannot create inputhread");

643 if(
	`adb_th»ad_ü—‹
(&
ouut_th»ad_±r
, 
ouut_th»ad
, 
t
)){

644 
	`çl_”ºo
("cannot create outputhread");

649 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

650 
t
->
Ãxt
 = &
Œª¥Üt_li¡
;

651 
t
->
´ev
 = 
Œª¥Üt_li¡
.prev;

652 
t
->
Ãxt
->
´ev
 =;

653 
t
->
´ev
->
Ãxt
 =;

654 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

656 
t
->
discÚÃùs
.
Ãxt
 =->discÚÃùs.
´ev
 = &t->disconnects;

658 
	`upd©e_Œª¥Üts
();

659 
	}
}

661 
	$š™_Œª¥Üt_»gi¡¿tiÚ
()

663 
s
[2];

665 if(
	`adb_sock‘·œ
(
s
)){

666 
	`çl_”ºo
("cannot openransport„egistration socketpair");

669 
Œª¥Üt_»gi¡¿tiÚ_£nd
 = 
s
[0];

670 
Œª¥Üt_»gi¡¿tiÚ_»cv
 = 
s
[1];

672 
	`fdev’t_š¡®l
(&
Œª¥Üt_»gi¡¿tiÚ_fde
,

673 
Œª¥Üt_»gi¡¿tiÚ_»cv
,

674 
Œª¥Üt_»gi¡¿tiÚ_func
,

677 
	`fdev’t_£t
(&
Œª¥Üt_»gi¡¿tiÚ_fde
, 
FDE_READ
);

678 
	}
}

681 
	$»gi¡”_Œª¥Üt
(
©¿n¥Üt
 *
Œª¥Üt
)

683 
tmsg
 
m
;

684 
m
.
Œª¥Üt
 =ransport;

685 
m
.
aùiÚ
 = 1;

686 
	`D
("Œª¥Üt: % »gi¡”ed\n", 
Œª¥Üt
->
£rŸl
);

687 if(
	`Œª¥Üt_wr™e_aùiÚ
(
Œª¥Üt_»gi¡¿tiÚ_£nd
, &
m
)) {

688 
	`çl_”ºo
("cannot writeransport„egistration socket\n");

690 
	}
}

692 
	$»move_Œª¥Üt
(
©¿n¥Üt
 *
Œª¥Üt
)

694 
tmsg
 
m
;

695 
m
.
Œª¥Üt
 =ransport;

696 
m
.
aùiÚ
 = 0;

697 
	`D
("Œª¥Üt: % »moved\n", 
Œª¥Üt
->
£rŸl
);

698 if(
	`Œª¥Üt_wr™e_aùiÚ
(
Œª¥Üt_»gi¡¿tiÚ_£nd
, &
m
)) {

699 
	`çl_”ºo
("cannot writeransport„egistration socket\n");

701 
	}
}

704 
	$Œª¥Üt_uÄef_locked
(
©¿n¥Üt
 *
t
)

706 
t
->
»f_couÁ
--;

707 ià(
t
->
»f_couÁ
 == 0) {

708 
	`D
("Œª¥Üt: % uÄeà(kickšg‡nd closšg)\n", 
t
->
£rŸl
);

709 ià(!
t
->
kicked
) {

710 
t
->
kicked
 = 1;

711 
t
->
	`kick
(t);

713 
t
->
	`şo£
(t);

714 
	`»move_Œª¥Üt
(
t
);

716 
	`D
("Œª¥Üt: % uÄeà(couÁ=%d)\n", 
t
->
£rŸl
,->
»f_couÁ
);

718 
	}
}

720 
	$Œª¥Üt_uÄef
(
©¿n¥Üt
 *
t
)

722 ià(
t
) {

723 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

724 
	`Œª¥Üt_uÄef_locked
(
t
);

725 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

727 
	}
}

729 
	$add_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
)

731 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

732 
dis
->
Ãxt
 = &
t
->
discÚÃùs
;

733 
dis
->
´ev
 = dis->
Ãxt
->prev;

734 
dis
->
´ev
->
Ãxt
 = dis;

735 
dis
->
Ãxt
->
´ev
 = dis;

736 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

737 
	}
}

739 
	$»move_Œª¥Üt_discÚÃù
(
©¿n¥Üt
* 
t
, 
adiscÚÃù
* 
dis
)

741 
dis
->
´ev
->
Ãxt
 = dis->next;

742 
dis
->
Ãxt
->
´ev
 = dis->prev;

743 
dis
->
Ãxt
 = dis->
´ev
 = dis;

744 
	}
}

746 
	$qu®_ch¬_is_šv®id
(
ch
)

748 ià('A' <ğ
ch
 && ch <= 'Z')

750 ià('a' <ğ
ch
 && ch <= 'z')

752 ià('0' <ğ
ch
 && ch <= '9')

755 
	}
}

757 
	$qu®_m©ch
(cÚ¡ *
to_‹¡
,

758 cÚ¡ *
´efix
, cÚ¡ *
qu®
, 
§n™ize_qu®
)

760 ià(!
to_‹¡
 || !*to_test)

762  !
qu®
 || !*qual;

764 ià(!
qu®
)

767 ià(
´efix
) {

768 *
´efix
) {

769 ià(*
´efix
++ !ğ*
to_‹¡
++)

774 *
qu®
) {

775 
ch
 = *
qu®
++;

776 ià(
§n™ize_qu®
 && 
	`qu®_ch¬_is_šv®id
(
ch
))

777 
ch
 = '_';

778 ià(
ch
 !ğ*
to_‹¡
++)

783  !*
to_‹¡
;

784 
	}
}

786 
©¿n¥Üt
 *
	$acquœe_Úe_Œª¥Üt
(
¡©e
, 
Œª¥Üt_ty³
 
‰y³
, cÚ¡ * 
£rŸl
, ** 
”rÜ_out
)

788 
©¿n¥Üt
 *
t
;

789 
©¿n¥Üt
 *
»suÉ
 = 
NULL
;

790 
ambiguous
 = 0;

792 
»Œy
:

793 ià(
”rÜ_out
)

794 *
”rÜ_out
 = "device‚ot found";

796 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

797 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

798 ià(
t
->
cÚÃùiÚ_¡©e
 =ğ
CS_NOPERM
) {

799 ià(
”rÜ_out
)

800 *
”rÜ_out
 = "insufficient…ermissions for device";

805 ià(
£rŸl
) {

806 ià((
t
->
£rŸl
 && !
	`¡rcmp
(serial,->serial)) ||

807 (
t
->
dev·th
 && !
	`¡rcmp
(
£rŸl
,->devpath)) ||

808 
	`qu®_m©ch
(
£rŸl
, "´oduù:", 
t
->
´oduù
, 0) ||

809 
	`qu®_m©ch
(
£rŸl
, "mod–:", 
t
->
mod–
, 1) ||

810 
	`qu®_m©ch
(
£rŸl
, "deviû:", 
t
->
deviû
, 0)) {

811 ià(
»suÉ
) {

812 ià(
”rÜ_out
)

813 *
”rÜ_out
 = "morehan one device";

814 
ambiguous
 = 1;

815 
»suÉ
 = 
NULL
;

818 
»suÉ
 = 
t
;

821 ià(
‰y³
 =ğ
kT¿n¥ÜtUsb
 && 
t
->
ty³
 == kTransportUsb) {

822 ià(
»suÉ
) {

823 ià(
”rÜ_out
)

824 *
”rÜ_out
 = "morehan one device";

825 
ambiguous
 = 1;

826 
»suÉ
 = 
NULL
;

829 
»suÉ
 = 
t
;

830 } ià(
‰y³
 =ğ
kT¿n¥ÜtLoÿl
 && 
t
->
ty³
 == kTransportLocal) {

831 ià(
»suÉ
) {

832 ià(
”rÜ_out
)

833 *
”rÜ_out
 = "morehan oneƒmulator";

834 
ambiguous
 = 1;

835 
»suÉ
 = 
NULL
;

838 
»suÉ
 = 
t
;

839 } ià(
‰y³
 =ğ
kT¿n¥ÜtAny
) {

840 ià(
»suÉ
) {

841 ià(
”rÜ_out
)

842 *
”rÜ_out
 = "morehan one device‡ndƒmulator";

843 
ambiguous
 = 1;

844 
»suÉ
 = 
NULL
;

847 
»suÉ
 = 
t
;

851 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

853 ià(
»suÉ
) {

855 ià(
»suÉ
 &&„esuÉ->
cÚÃùiÚ_¡©e
 =ğ
CS_OFFLINE
) {

856 ià(
”rÜ_out
)

857 *
”rÜ_out
 = "device offline";

858 
»suÉ
 = 
NULL
;

861 ià(
»suÉ
 && 
¡©e
 !ğ
CS_ANY
 &&„esuÉ->
cÚÃùiÚ_¡©e
 != state) {

862 ià(
”rÜ_out
)

863 *
”rÜ_out
 = "invalid device state";

864 
»suÉ
 = 
NULL
;

868 ià(
»suÉ
) {

870 ià(
”rÜ_out
)

871 *
”rÜ_out
 = 
NULL
;

872 } ià(
¡©e
 !ğ
CS_ANY
 && (
£rŸl
 || !
ambiguous
)) {

873 
	`adb_¦“p_ms
(1000);

874 
»Œy
;

877  
»suÉ
;

878 
	}
}

880 #ià
ADB_HOST


881 cÚ¡ *
	$¡©’ame
(
©¿n¥Üt
 *
t
)

883 
t
->
cÚÃùiÚ_¡©e
){

884 
CS_OFFLINE
:  "offline";

885 
CS_BOOTLOADER
:  "bootloader";

886 
CS_DEVICE
:  "device";

887 
CS_HOST
:  "host";

888 
CS_RECOVERY
:  "recovery";

889 
CS_SIDELOAD
:  "sideload";

890 
CS_NOPERM
:  "no…ermissions";

893 
	}
}

895 
	$add_qu®
(**
buf
, 
size_t
 *
buf_size
,

896 cÚ¡ *
´efix
, cÚ¡ *
qu®
, 
§n™ize_qu®
)

898 
size_t
 
Ën
;

899 
´efix_Ën
;

901 ià(!
buf
 || !*buà|| !
buf_size
 || !*buf_siz|| !
qu®
 || !*qual)

904 
Ën
 = 
	`¢´štf
(*
buf
, *
buf_size
, "%s%n%s", 
´efix
, &
´efix_Ën
, 
qu®
);

906 ià(
§n™ize_qu®
) {

907 *
ı
;

908 
ı
 = *
buf
 + 
´efix_Ën
; c°< *buà+ 
Ën
; cp++) {

909 ià(
	`qu®_ch¬_is_šv®id
(*
ı
))

910 *
ı
 = '_';

914 *
buf_size
 -ğ
Ën
;

915 *
buf
 +ğ
Ën
;

916 
	}
}

918 
size_t
 
	$fÜm©_Œª¥Üt
(
©¿n¥Üt
 *
t
, *
buf
, 
size_t
 
bufsize
,

919 
lÚg_li¡šg
)

921 cÚ¡ * 
£rŸl
 = 
t
->serial;

922 ià(!
£rŸl
 || !serial[0])

923 
£rŸl
 = "????????????";

925 ià(!
lÚg_li¡šg
) {

926  
	`¢´štf
(
buf
, 
bufsize
, "%s\t%s\n", 
£rŸl
, 
	`¡©’ame
(
t
));

928 
size_t
 
Ën
, 
»maššg
 = 
bufsize
;

930 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "%-22 %s", 
£rŸl
, 
	`¡©’ame
(
t
));

931 
»maššg
 -ğ
Ën
;

932 
buf
 +ğ
Ën
;

934 
	`add_qu®
(&
buf
, &
»maššg
, " ", 
t
->
dev·th
, 0);

935 
	`add_qu®
(&
buf
, &
»maššg
, "…roduù:", 
t
->
´oduù
, 0);

936 
	`add_qu®
(&
buf
, &
»maššg
, " mod–:", 
t
->
mod–
, 1);

937 
	`add_qu®
(&
buf
, &
»maššg
, " deviû:", 
t
->
deviû
, 0);

939 
Ën
 = 
	`¢´štf
(
buf
, 
»maššg
, "\n");

940 
»maššg
 -ğ
Ën
;

942  
bufsize
 - 
»maššg
;

944 
	}
}

946 
	$li¡_Œª¥Üts
(*
buf
, 
size_t
 
bufsize
, 
lÚg_li¡šg
)

948 * 
p
 = 
buf
;

949 * 
’d
 = 
buf
 + 
bufsize
;

950 
Ën
;

951 
©¿n¥Üt
 *
t
;

954 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

955 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

956 
Ën
 = 
	`fÜm©_Œª¥Üt
(
t
, 
p
, 
’d
 -…, 
lÚg_li¡šg
);

957 ià(
p
 + 
Ën
 >ğ
’d
) {

961 
p
 +ğ
Ën
;

963 
p
[0] = 0;

964 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

965  
p
 - 
buf
;

966 
	}
}

970 
	$şo£_usb_deviûs
()

972 
©¿n¥Üt
 *
t
;

974 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

975 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

976 iàĞ!
t
->
kicked
 ) {

977 
t
->
kicked
 = 1;

978 
t
->
	`kick
(t);

981 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

982 
	}
}

985 
	$»gi¡”_sock‘_Œª¥Üt
(
s
, cÚ¡ *
£rŸl
, 
pÜt
, 
loÿl
)

987 
©¿n¥Üt
 *
t
 = 
	`ÿÎoc
(1, (atransport));

988 
buff
[32];

990 ià(!
£rŸl
) {

991 
	`¢´štf
(
buff
,  buff, "T-%p", 
t
);

992 
£rŸl
 = 
buff
;

994 
	`D
("Œª¥Üt: % š™'šg fÜ sock‘ %d, oÀpÜˆ%d\n", 
£rŸl
, 
s
, 
pÜt
);

995 iàĞ
	`š™_sock‘_Œª¥Üt
(
t
, 
s
, 
pÜt
, 
loÿl
) < 0 ) {

996 
	`adb_şo£
(
s
);

997 
	`ä“
(
t
);

1000 if(
£rŸl
) {

1001 
t
->
£rŸl
 = 
	`¡rdup
(serial);

1003 
	`»gi¡”_Œª¥Üt
(
t
);

1004 
	}
}

1006 #ià
ADB_HOST


1007 
©¿n¥Üt
 *
	$fšd_Œª¥Üt
(cÚ¡ *
£rŸl
)

1009 
©¿n¥Üt
 *
t
;

1011 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1012 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

1013 ià(
t
->
£rŸl
 && !
	`¡rcmp
(serial,->serial)) {

1017 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1019 ià(
t
 !ğ&
Œª¥Üt_li¡
)

1020  
t
;

1023 
	}
}

1025 
	$uÄegi¡”_Œª¥Üt
(
©¿n¥Üt
 *
t
)

1027 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1028 
t
->
Ãxt
->
´ev
 =->prev;

1029 
t
->
´ev
->
Ãxt
 =->next;

1030 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1032 
	`kick_Œª¥Üt
(
t
);

1033 
	`Œª¥Üt_uÄef
(
t
);

1034 
	}
}

1037 
	$uÄegi¡”_®l_tı_Œª¥Üts
()

1039 
©¿n¥Üt
 *
t
, *
Ãxt
;

1040 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1041 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =‚ext) {

1042 
Ãxt
 = 
t
->next;

1043 ià(
t
->
ty³
 =ğ
kT¿n¥ÜtLoÿl
 &&->
adb_pÜt
 == 0) {

1044 
t
->
Ãxt
->
´ev
 =->prev;

1045 
t
->
´ev
->
Ãxt
 =‚ext;

1047 ià(!
t
->
kicked
)

1049 
t
->
kicked
 = 1;

1050 
t
->
	`kick
(t);

1052 
	`Œª¥Üt_uÄef_locked
(
t
);

1056 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1057 
	}
}

1061 
	$»gi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
usb
, cÚ¡ *
£rŸl
, cÚ¡ *
dev·th
, 
wr™—bË
)

1063 
©¿n¥Üt
 *
t
 = 
	`ÿÎoc
(1, (atransport));

1064 
	`D
("Œª¥Üt: %°š™'šg fÜ usb_hªdË %°(¢='%s')\n", 
t
, 
usb
,

1065 
£rŸl
 ? serial : "");

1066 
	`š™_usb_Œª¥Üt
(
t
, 
usb
, (
wr™—bË
 ? 
CS_OFFLINE
 : 
CS_NOPERM
));

1067 if(
£rŸl
) {

1068 
t
->
£rŸl
 = 
	`¡rdup
(serial);

1070 if(
dev·th
) {

1071 
t
->
dev·th
 = 
	`¡rdup
(devpath);

1073 
	`»gi¡”_Œª¥Üt
(
t
);

1074 
	}
}

1077 
	$uÄegi¡”_usb_Œª¥Üt
(
usb_hªdË
 *
usb
)

1079 
©¿n¥Üt
 *
t
;

1080 
	`adb_mu‹x_lock
(&
Œª¥Üt_lock
);

1081 
t
 = 
Œª¥Üt_li¡
.
Ãxt
; != &transport_list; =->next) {

1082 ià(
t
->
usb
 =ğusb &&->
cÚÃùiÚ_¡©e
 =ğ
CS_NOPERM
) {

1083 
t
->
Ãxt
->
´ev
 =->prev;

1084 
t
->
´ev
->
Ãxt
 =->next;

1088 
	`adb_mu‹x_uÆock
(&
Œª¥Üt_lock
);

1089 
	}
}

1091 #undeà
TRACE_TAG


1092 
	#TRACE_TAG
 
TRACE_RWX


	)

1094 
	$»adx
(
fd
, *
±r
, 
size_t
 
Ën
)

1096 *
p
 = 
±r
;

1097 
r
;

1098 #ià
ADB_TRACE


1099 
Ën0
 = 
Ën
;

1101 
	`D
("»adx: fd=%d wª‹d=%d\n", 
fd
, ()
Ën
);

1102 
Ën
 > 0) {

1103 
r
 = 
	`adb_»ad
(
fd
, 
p
, 
Ën
);

1104 if(
r
 > 0) {

1105 
Ën
 -ğ
r
;

1106 
p
 +ğ
r
;

1108 ià(
r
 < 0) {

1109 
	`D
("»adx: fd=%dƒ¼Ü %d: %s\n", 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

1110 ià(
”ºo
 =ğ
EINTR
)

1113 
	`D
("»adx: fd=%d discÚÃùed\n", 
fd
);

1119 #ià
ADB_TRACE


1120 
	`D
("»adx: fd=%d wª‹d=%d gÙ=%d\n", 
fd
, 
Ën0
,†’0 - 
Ën
);

1121 
	`dump_hex
Ğ
±r
, 
Ën0
 );

1124 
	}
}

1126 
	$wr™ex
(
fd
, cÚ¡ *
±r
, 
size_t
 
Ën
)

1128 *
p
 = (*è
±r
;

1129 
r
;

1131 #ià
ADB_TRACE


1132 
	`D
("wr™ex: fd=%d†’=%d: ", 
fd
, ()
Ën
);

1133 
	`dump_hex
Ğ
±r
, 
Ën
 );

1135 
Ën
 > 0) {

1136 
r
 = 
	`adb_wr™e
(
fd
, 
p
, 
Ën
);

1137 if(
r
 > 0) {

1138 
Ën
 -ğ
r
;

1139 
p
 +ğ
r
;

1141 ià(
r
 < 0) {

1142 
	`D
("wr™ex: fd=%dƒ¼Ü %d: %s\n", 
fd
, 
”ºo
, 
	`¡»¼Ü
(errno));

1143 ià(
”ºo
 =ğ
EINTR
)

1146 
	`D
("wr™ex: fd=%d discÚÃùed\n", 
fd
);

1152 
	}
}

1154 
	$check_h—d”
(
­ack‘
 *
p
)

1156 if(
p
->
msg
.
magic
 !ğÕ->msg.
commªd
 ^ 0xffffffff)) {

1157 
	`D
("check_header(): invalid magic\n");

1161 if(
p
->
msg
.
d©a_Ëngth
 > 
MAX_PAYLOAD
) {

1162 
	`D
("check_h—d”(): %d > MAX_PAYLOAD\n", 
p
->
msg
.
d©a_Ëngth
);

1167 
	}
}

1169 
	$check_d©a
(
­ack‘
 *
p
)

1171 
couÁ
, 
sum
;

1172 *
x
;

1174 
couÁ
 = 
p
->
msg
.
d©a_Ëngth
;

1175 
x
 = 
p
->
d©a
;

1176 
sum
 = 0;

1177 
couÁ
-- > 0) {

1178 
sum
 +ğ*
x
++;

1181 if(
sum
 !ğ
p
->
msg
.
d©a_check
) {

1186 
	}
}

	@transport.h

17 #iâdeà
__TRANSPORT_H


18 
	#__TRANSPORT_H


	)

24 
»adx
(
fd
, *
±r
, 
size_t
 
Ën
);

25 
wr™ex
(
fd
, cÚ¡ *
±r
, 
size_t
 
Ën
);

	@transport_local.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

22 
	~"sysd•s.h
"

23 
	~<sys/ty³s.h
>

25 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

26 
	~"adb.h
"

28 #ifdeà
HAVE_BIG_ENDIAN


29 
	#H4
(
x
è(((xè& 0xFF000000è>> 24è| (((xè& 0x00FF0000è>> 8è| (((xè& 0x0000FF00è<< 8è| (((xè& 0x000000FFè<< 24)

	)

30 
šlše
 
	$fix_’dŸns
(
­ack‘
 *
p
)

32 
p
->
msg
.
commªd
 = 
	`H4
(p->msg.command);

33 
p
->
msg
.
¬g0
 = 
	`H4
(p->msg.arg0);

34 
p
->
msg
.
¬g1
 = 
	`H4
(p->msg.arg1);

35 
p
->
msg
.
d©a_Ëngth
 = 
	`H4
(p->msg.data_length);

36 
p
->
msg
.
d©a_check
 = 
	`H4
(p->msg.data_check);

37 
p
->
msg
.
magic
 = 
	`H4
(p->msg.magic);

38 
	}
}

40 
	#fix_’dŸns
(
p
èdØ{} 0)

	)

43 #ià
ADB_HOST


48 
	#ADB_LOCAL_TRANSPORT_MAX
 16

	)

50 
ADB_MUTEX_DEFINE
Ğ
loÿl_Œª¥Üts_lock
 );

52 
©¿n¥Üt
* 
	gloÿl_Œª¥Üts
[ 
ADB_LOCAL_TRANSPORT_MAX
 ];

55 
	$»mÙe_»ad
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

57 if(
	`»adx
(
t
->
sfd
, &
p
->
msg
, (
ames§ge
))){

58 
	`D
("remote†ocal:„eaderminated (message)\n");

62 
	`fix_’dŸns
(
p
);

64 #ià0 && 
defšed
 
HAVE_BIG_ENDIAN


65 
	`D
("read„emote…acket: %04x‡rg0=%0x‡rg1=%0x data_length=%0x data_check=%0x magic=%0x\n",

66 
p
->
msg
.
commªd
,…->msg.
¬g0
,…->msg.
¬g1
,…->msg.
d©a_Ëngth
,…->msg.
d©a_check
,…->msg.
magic
);

68 if(
	`check_h—d”
(
p
)) {

69 
	`D
("bad header:erminated (data)\n");

73 if(
	`»adx
(
t
->
sfd
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)){

74 
	`D
("remote†ocal:erminated (data)\n");

78 if(
	`check_d©a
(
p
)) {

79 
	`D
("bad data:erminated (data)\n");

84 
	}
}

86 
	$»mÙe_wr™e
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

88 
Ëngth
 = 
p
->
msg
.
d©a_Ëngth
;

90 
	`fix_’dŸns
(
p
);

92 #ià0 && 
defšed
 
HAVE_BIG_ENDIAN


93 
	`D
("write„emote…acket: %04x‡rg0=%0x‡rg1=%0x data_length=%0x data_check=%0x magic=%0x\n",

94 
p
->
msg
.
commªd
,…->msg.
¬g0
,…->msg.
¬g1
,…->msg.
d©a_Ëngth
,…->msg.
d©a_check
,…->msg.
magic
);

96 if(
	`wr™ex
(
t
->
sfd
, &
p
->
msg
, (
ames§ge
è+ 
Ëngth
)) {

97 
	`D
("remote†ocal: writeerminated\n");

102 
	}
}

105 
	$loÿl_cÚÃù
(
pÜt
) {

106  
	`loÿl_cÚÃù_¬b™¿ry_pÜts
(
pÜt
-1,…ort);

107 
	}
}

109 
	$loÿl_cÚÃù_¬b™¿ry_pÜts
(
cÚsŞe_pÜt
, 
adb_pÜt
)

111 
buf
[64];

112 
fd
 = -1;

114 #ià
ADB_HOST


115 cÚ¡ *
ho¡
 = 
	`g‘’v
("ADBHOST");

116 ià(
ho¡
) {

117 
fd
 = 
	`sock‘_ÃtwÜk_ş›Á
(
ho¡
, 
adb_pÜt
, 
SOCK_STREAM
);

120 ià(
fd
 < 0) {

121 
fd
 = 
	`sock‘_loİback_ş›Á
(
adb_pÜt
, 
SOCK_STREAM
);

124 ià(
fd
 >= 0) {

125 
	`D
("ş›Á: cÚÃùed oÀ»mÙÚ fd %d\n", 
fd
);

126 
	`şo£_Ú_exec
(
fd
);

127 
	`di§bË_tı_ÇgË
(
fd
);

128 
	`¢´štf
(
buf
,  buf, "%s%d", 
LOCAL_CLIENT_PREFIX
, 
cÚsŞe_pÜt
);

129 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, 
buf
, 
adb_pÜt
, 1);

133 
	}
}

136 *
	$ş›Á_sock‘_th»ad
(*
x
)

138 #ià
ADB_HOST


139 
pÜt
 = 
DEFAULT_ADB_LOCAL_TRANSPORT_PORT
;

140 
couÁ
 = 
ADB_LOCAL_TRANSPORT_MAX
;

142 
	`D
("transport: client_socket_thread() starting\n");

147  ; 
couÁ
 > 0; couÁ--, 
pÜt
 += 2 ) {

148 (è
	`loÿl_cÚÃù
(
pÜt
);

152 
	}
}

154 *
	$£rv”_sock‘_th»ad
(* 
¬g
)

156 
£rv”fd
, 
fd
;

157 
sockaddr
 
addr
;

158 
sockËn_t
 
®’
;

159 
pÜt
 = ()
¬g
;

161 
	`D
("transport: server_socket_thread() starting\n");

162 
£rv”fd
 = -1;

164 if(
£rv”fd
 == -1) {

165 
£rv”fd
 = 
	`sock‘_šaddr_ªy_£rv”
(
pÜt
, 
SOCK_STREAM
);

166 if(
£rv”fd
 < 0) {

167 
	`D
("server: cannot bind socket yet\n");

168 
	`adb_¦“p_ms
(1000);

171 
	`şo£_Ú_exec
(
£rv”fd
);

174 
®’
 = (
addr
);

175 
	`D
("£rv”:ryšgØg‘‚ew cÚÃùiÚ from %d\n", 
pÜt
);

176 
fd
 = 
	`adb_sock‘_acû±
(
£rv”fd
, &
addr
, &
®’
);

177 if(
fd
 >= 0) {

178 
	`D
("£rv”:‚ew cÚÃùiÚ oÀfd %d\n", 
fd
);

179 
	`şo£_Ú_exec
(
fd
);

180 
	`di§bË_tı_ÇgË
(
fd
);

181 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, "ho¡", 
pÜt
, 1);

184 
	`D
("transport: server_socket_thread()ƒxiting\n");

186 
	}
}

189 #ià!
ADB_HOST


194 #undeà
İ’


195 #undeà
wr™e


196 
	#İ’
 
adb_İ’


	)

197 
	#wr™e
 
adb_wr™e


	)

198 
	~<qemu/qemu_pe.h
>

199 #undeà
İ’


200 #undeà
wr™e


201 
	#İ’
 
___xxx_İ’


	)

202 
	#wr™e
 
___xxx_wr™e


	)

232 *
	$qemu_sock‘_th»ad
(* 
¬g
)

235 cÚ¡ 
_acû±_»q
[] = "accept";

237 cÚ¡ 
_¡¬t_»q
[] = "start";

239 cÚ¡ 
_ok_»¥
[] = "ok";

241 cÚ¡ 
pÜt
 = ()
¬g
;

242 
»s
, 
fd
;

243 
tmp
[256];

244 
cÚ_Çme
[32];

246 
	`D
("transport: qemu_socket_thread() starting\n");

249 
	`¢´štf
(
cÚ_Çme
, (cÚ_Çme), "qemud:adb:%d", 
pÜt
);

252 
fd
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

253 ià(
fd
 < 0) {

256 
adb_th»ad_t
 
thr
;

257 
	`D
("adb service is‚ot‡vailable. Falling backo TCP socket.\n");

258 
	`adb_th»ad_ü—‹
(&
thr
, 
£rv”_sock‘_th»ad
, 
¬g
);

268 
»s
 = 
	`adb_wr™e
(
fd
, 
_acû±_»q
, 
	`¡¾’
(_accept_req));

269 ià((
size_t
)
»s
 =ğ
	`¡¾’
(
_acû±_»q
)) {

272 
»s
 = 
	`adb_»ad
(
fd
, 
tmp
, (tmp));

273 ià(
»s
 !ğ2 || 
	`memcmp
(
tmp
, 
_ok_»¥
, 2)) {

274 
	`D
("Accepting ADB host connection has failed.\n");

275 
	`adb_şo£
(
fd
);

279 
	`»gi¡”_sock‘_Œª¥Üt
(
fd
, "ho¡", 
pÜt
, 1);

280 
	`adb_wr™e
(
fd
, 
_¡¬t_»q
, 
	`¡¾’
(_start_req));

284 
fd
 = 
	`qemu_pe_İ’
(
cÚ_Çme
);

285 ià(
fd
 < 0) {

286 
	`D
("adb service become unavailable.\n");

290 
	`D
("UÇbËØ£ndh'%s'„eque¡ØADB s”viû.\n", 
_acû±_»q
);

294 
	`D
("transport: qemu_socket_thread()ƒxiting\n");

296 
	}
}

299 
	$loÿl_š™
(
pÜt
)

301 
adb_th»ad_t
 
thr
;

302 * (*
func
)(*);

304 if(
HOST
) {

305 
func
 = 
ş›Á_sock‘_th»ad
;

307 #ià
ADB_HOST


308 
func
 = 
£rv”_sock‘_th»ad
;

312 
is_qemu
[
PROPERTY_VALUE_MAX
];

313 
	`´İ”ty_g‘
("ro.k”Ãl.qemu", 
is_qemu
, "");

314 ià(!
	`¡rcmp
(
is_qemu
, "1")) {

316 
func
 = 
qemu_sock‘_th»ad
;

319 
func
 = 
£rv”_sock‘_th»ad
;

324 
	`D
("Œª¥Üt:†oÿÈ% š™\n", 
HOST
 ? "client" : "server");

326 if(
	`adb_th»ad_ü—‹
(&
thr
, 
func
, (*)
pÜt
)) {

327 
	`çl_”ºo
("cannot create†ocal socket %shread",

328 
HOST
 ? "client" : "server");

330 
	}
}

332 
	$»mÙe_kick
(
©¿n¥Üt
 *
t
)

334 
fd
 = 
t
->
sfd
;

335 
t
->
sfd
 = -1;

336 
	`adb_shutdown
(
fd
);

337 
	`adb_şo£
(
fd
);

339 #ià
ADB_HOST


340 if(
HOST
) {

341 
Â
;

342 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

343 
Â
 = 0;‚À< 
ADB_LOCAL_TRANSPORT_MAX
;‚n++) {

344 ià(
loÿl_Œª¥Üts
[
Â
] =ğ
t
) {

345 
loÿl_Œª¥Üts
[
Â
] = 
NULL
;

349 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

352 
	}
}

354 
	$»mÙe_şo£
(
©¿n¥Üt
 *
t
)

356 
	`adb_şo£
(
t
->
fd
);

357 
	}
}

360 #ià
ADB_HOST


362 
©¿n¥Üt
* 
	$fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
)

364 
i
;

365 
i
 = 0; i < 
ADB_LOCAL_TRANSPORT_MAX
; i++) {

366 ià(
loÿl_Œª¥Üts
[
i
] &&†oÿl_Œª¥Üts[i]->
adb_pÜt
 ==‡db_port) {

367  
loÿl_Œª¥Üts
[
i
];

370  
NULL
;

371 
	}
}

373 
©¿n¥Üt
* 
	$fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt
(
adb_pÜt
)

375 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

376 
©¿n¥Üt
* 
»suÉ
 = 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
);

377 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

378  
»suÉ
;

379 
	}
}

382 
	$g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
()

384 
i
;

385 
i
 = 0; i < 
ADB_LOCAL_TRANSPORT_MAX
; i++) {

386 ià(
loÿl_Œª¥Üts
[
i
] =ğ
NULL
) {

387  
i
;

391 
	}
}

393 
	$g‘_avaabË_loÿl_Œª¥Üt_šdex
()

395 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

396 
»suÉ
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
();

397 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

398  
»suÉ
;

399 
	}
}

402 
	$š™_sock‘_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
s
, 
adb_pÜt
, 
loÿl
)

404 
ç
 = 0;

406 
t
->
kick
 = 
»mÙe_kick
;

407 
t
->
şo£
 = 
»mÙe_şo£
;

408 
t
->
»ad_äom_»mÙe
 = 
»mÙe_»ad
;

409 
t
->
wr™e_to_»mÙe
 = 
»mÙe_wr™e
;

410 
t
->
sfd
 = 
s
;

411 
t
->
sync_tok’
 = 1;

412 
t
->
cÚÃùiÚ_¡©e
 = 
CS_OFFLINE
;

413 
t
->
ty³
 = 
kT¿n¥ÜtLoÿl
;

414 
t
->
adb_pÜt
 = 0;

416 #ià
ADB_HOST


417 ià(
HOST
 && 
loÿl
) {

418 
	`adb_mu‹x_lock
Ğ&
loÿl_Œª¥Üts_lock
 );

420 
t
->
adb_pÜt
 =‡db_port;

421 
©¿n¥Üt
* 
exi¡šg_Œª¥Üt
 =

422 
	`fšd_emuÏtÜ_Œª¥Üt_by_adb_pÜt_locked
(
adb_pÜt
);

423 
šdex
 = 
	`g‘_avaabË_loÿl_Œª¥Üt_šdex_locked
();

424 ià(
exi¡šg_Œª¥Üt
 !ğ
NULL
) {

425 
	`D
("localransport for…ort %d‡lready„egistered (%p)?\n",

426 
adb_pÜt
, 
exi¡šg_Œª¥Üt
);

427 
ç
 = -1;

428 } ià(
šdex
 < 0) {

430 
	`D
("cannot„egister moreƒmulators. Maximum is %d\n",

431 
ADB_LOCAL_TRANSPORT_MAX
);

432 
ç
 = -1;

434 
loÿl_Œª¥Üts
[
šdex
] = 
t
;

437 
	`adb_mu‹x_uÆock
Ğ&
loÿl_Œª¥Üts_lock
 );

440  
ç
;

441 
	}
}

	@transport_usb.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

21 
	~<sysd•s.h
>

23 
	#TRACE_TAG
 
TRACE_TRANSPORT


	)

24 
	~"adb.h
"

26 #ià
ADB_HOST


27 
	~"usb_v’dÜs.h
"

30 #ifdeà
HAVE_BIG_ENDIAN


31 
	#H4
(
x
è(((xè& 0xFF000000è>> 24è| (((xè& 0x00FF0000è>> 8è| (((xè& 0x0000FF00è<< 8è| (((xè& 0x000000FFè<< 24)

	)

32 
šlše
 
	$fix_’dŸns
(
­ack‘
 *
p
)

34 
p
->
msg
.
commªd
 = 
	`H4
(p->msg.command);

35 
p
->
msg
.
¬g0
 = 
	`H4
(p->msg.arg0);

36 
p
->
msg
.
¬g1
 = 
	`H4
(p->msg.arg1);

37 
p
->
msg
.
d©a_Ëngth
 = 
	`H4
(p->msg.data_length);

38 
p
->
msg
.
d©a_check
 = 
	`H4
(p->msg.data_check);

39 
p
->
msg
.
magic
 = 
	`H4
(p->msg.magic);

40 
	}
}

41 
	$ho¡_to_Ë32
(
n
)

43  
	`H4
(
n
);

44 
	}
}

46 
	#fix_’dŸns
(
p
èdØ{} 0)

	)

47 
	$ho¡_to_Ë32
(
n
)

49  
n
;

50 
	}
}

53 
	$»mÙe_»ad
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

55 if(
	`usb_»ad
(
t
->
usb
, &
p
->
msg
, (
ames§ge
))){

56 
	`D
("remote usb:„eaderminated (message)\n");

60 
	`fix_’dŸns
(
p
);

62 if(
	`check_h—d”
(
p
)) {

63 
	`D
("remote usb: check_header failed\n");

67 if(
p
->
msg
.
d©a_Ëngth
) {

68 if(
	`usb_»ad
(
t
->
usb
, 
p
->
d©a
,…->
msg
.
d©a_Ëngth
)){

69 
	`D
("remote usb:erminated (data)\n");

74 if(
	`check_d©a
(
p
)) {

75 
	`D
("remote usb: check_data failed\n");

80 
	}
}

82 
	$»mÙe_wr™e
(
­ack‘
 *
p
, 
©¿n¥Üt
 *
t
)

84 
size
 = 
p
->
msg
.
d©a_Ëngth
;

86 
	`fix_’dŸns
(
p
);

88 if(
	`usb_wr™e
(
t
->
usb
, &
p
->
msg
, (
ames§ge
))) {

89 
	`D
("remote usb: 1 - writeerminated\n");

92 if(
p
->
msg
.
d©a_Ëngth
 == 0)  0;

93 if(
	`usb_wr™e
(
t
->
usb
, &
p
->
d©a
, 
size
)) {

94 
	`D
("remote usb: 2 - writeerminated\n");

99 
	}
}

101 
	$»mÙe_şo£
(
©¿n¥Üt
 *
t
)

103 
	`usb_şo£
(
t
->
usb
);

104 
t
->
usb
 = 0;

105 
	}
}

107 
	$»mÙe_kick
(
©¿n¥Üt
 *
t
)

109 
	`usb_kick
(
t
->
usb
);

110 
	}
}

112 
	$š™_usb_Œª¥Üt
(
©¿n¥Üt
 *
t
, 
usb_hªdË
 *
h
, 
¡©e
)

114 
	`D
("transport: usb\n");

115 
t
->
şo£
 = 
»mÙe_şo£
;

116 
t
->
kick
 = 
»mÙe_kick
;

117 
t
->
»ad_äom_»mÙe
 = 
»mÙe_»ad
;

118 
t
->
wr™e_to_»mÙe
 = 
»mÙe_wr™e
;

119 
t
->
sync_tok’
 = 1;

120 
t
->
cÚÃùiÚ_¡©e
 = 
¡©e
;

121 
t
->
ty³
 = 
kT¿n¥ÜtUsb
;

122 
t
->
usb
 = 
h
;

124 #ià
ADB_HOST


125 
HOST
 = 1;

127 
HOST
 = 0;

129 
	}
}

131 #ià
ADB_HOST


132 
	$is_adb_š‹rçû
(
vid
, 
pid
, 
usb_şass
, 
usb_subşass
, 
usb_´ÙocŞ
)

134 
i
;

135 
i
 = 0; i < 
v’dÜIdCouÁ
; i++) {

136 ià(
vid
 =ğ
v’dÜIds
[
i
]) {

137 ià(
usb_şass
 =ğ
ADB_CLASS
 && 
usb_subşass
 =ğ
ADB_SUBCLASS
 &&

138 
usb_´ÙocŞ
 =ğ
ADB_PROTOCOL
) {

147 
	}
}

	@usb_libusb.c

20 
	~<sys/’dŸn.h
>

21 
	~<sys/ioùl.h
>

22 
	~<sys/ty³s.h
>

23 
	~<sys/uio.h
>

25 
	~<”r.h
>

26 
	~<”ºo.h
>

27 
	~<pŞl.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršgs.h
>

31 
	~<¡ršg.h
>

32 
	~<sy£x™s.h
>

33 
	~<uni¡d.h
>

34 
	~<libusb.h
>

35 
	~"sysd•s.h
"

37 
	#TRACE_TAG
 
TRACE_USB


	)

38 
	~"adb.h
"

40 
adb_mu‹x_t
 
	gusb_lock
 = 
ADB_MUTEX_INITIALIZER
;

41 
libusb_cÚ‹xt
 *
	gùx
 = 
NULL
;

43 
	susb_hªdË


45 
usb_hªdË
 *
	m´ev
;

46 
usb_hªdË
 *
	mÃxt
;

48 
libusb_deviû
 *
	mdev
;

49 
libusb_deviû_hªdË
 *
	mdevh
;

50 
	mš‹rçû
;

51 
ušt8_t
 
	mdev_bus
;

52 
ušt8_t
 
	mdev_addr
;

54 
	mz”o_mask
;

55 
	m’d_pošt_add»ss
[2];

56 
	m£rŸl
[128];

58 
adb_cÚd_t
 
	mnÙify
;

59 
adb_mu‹x_t
 
	mlock
;

62 
usb_hªdË
 
	ghªdË_li¡
 = {

63 .
´ev
 = &
hªdË_li¡
,

64 .
	gÃxt
 = &
hªdË_li¡
,

68 
	$usb_ş—nup
()

70 
	`libusb_ex™
(
ùx
);

71 
	}
}

74 
	$»pÜt_bulk_libusb_”rÜ
(
r
)

76 
r
) {

77 
LIBUSB_ERROR_TIMEOUT
:

78 
	`D
("Transferimeout\n");

81 
LIBUSB_ERROR_PIPE
:

82 
	`D
("Control„equest is‚ot supported\n");

85 
LIBUSB_ERROR_OVERFLOW
:

86 
	`D
("Device offered more data\n");

89 
LIBUSB_ERROR_NO_DEVICE
 :

90 
	`D
("Device was disconnected\n");

94 
	`D
("E¼Ü %d duršg¿nsãr\n", 
r
);

97 
	}
}

100 
	$usb_bulk_wr™e
(
usb_hªdË
 *
uh
, cÚ¡ *
d©a
, 
Ën
)

102 
r
 = 0;

103 
Œªsã¼ed
 = 0;

105 
r
 = 
	`libusb_bulk_Œªsãr
(
uh
->
devh
, uh->
’d_pošt_add»ss
[1], (*)
d©a
, 
Ën
,

106 &
Œªsã¼ed
, 0);

108 ià(
r
 != 0) {

109 
	`D
("usb_bulk_write(): ");

110 
	`»pÜt_bulk_libusb_”rÜ
(
r
);

111  
r
;

114  (
Œªsã¼ed
);

115 
	}
}

118 
	$usb_bulk_»ad
(
usb_hªdË
 *
uh
, *
d©a
, 
Ën
)

120 
r
 = 0;

121 
Œªsã¼ed
 = 0;

123 
r
 = 
	`libusb_bulk_Œªsãr
(
uh
->
devh
, uh->
’d_pošt_add»ss
[0], 
d©a
, 
Ën
,

124 &
Œªsã¼ed
, 0);

126 ià(
r
 != 0) {

127 
	`D
("usb_bulk_read(): ");

128 
	`»pÜt_bulk_libusb_”rÜ
(
r
);

129  
r
;

132  (
Œªsã¼ed
);

133 
	}
}

136 
	$usb_wr™e
(
usb_hªdË
 *
uh
, cÚ¡ *
_d©a
, 
Ën
)

138 *
d©a
 = (*è
_d©a
;

139 
n
;

140 
Ãed_z”o
 = 0;

142 ià(
uh
->
z”o_mask
 == 1) {

143 ià(!(
Ën
 & 
uh
->
z”o_mask
)) {

144 
Ãed_z”o
 = 1;

148 
	`D
("usb_wr™e(): %p:%d ->¿n¥Üˆ%p\n", 
_d©a
, 
Ën
, 
uh
);

150 
Ën
 > 0) {

151 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

153 
n
 = 
	`usb_bulk_wr™e
(
uh
, 
d©a
, 
xãr
);

155 ià(
n
 !ğ
xãr
) {

156 
	`D
("usb_wr™e(): faed fÜ¿n¥Üˆ%°(%d by‹ Ëá)\n", 
uh
, 
Ën
);

160 
Ën
 -ğ
xãr
;

161 
d©a
 +ğ
xãr
;

164 ià(
Ãed_z”o
){

165 
n
 = 
	`usb_bulk_wr™e
(
uh
, 
_d©a
, 0);

167 ià(
n
 < 0) {

168 
	`D
("usb_wr™e(): faedØfšish o³¿tiÚ fÜ¿n¥Üˆ%p\n", 
uh
);

170  
n
;

174 
	}
}

177 
	$usb_»ad
(
usb_hªdË
 *
uh
, *
_d©a
, 
Ën
)

179 *
d©a
 = (*è
_d©a
;

180 
n
;

182 
	`D
("usb_»ad(): %p:%d <-¿n¥Üˆ%p\n", 
_d©a
, 
Ën
, 
uh
);

184 
Ën
 > 0) {

185 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

187 
n
 = 
	`usb_bulk_»ad
(
uh
, 
d©a
, 
xãr
);

189 ià(
n
 !ğ
xãr
) {

190 ià(
n
 > 0) {

191 
d©a
 +ğ
n
;

192 
Ën
 -ğ
n
;

196 
	`D
("usb_»ad(): faed fÜ¿n¥Üˆ%°(%d by‹ Ëá)\n", 
uh
, 
Ën
);

200 
Ën
 -ğ
xãr
;

201 
d©a
 +ğ
xãr
;

205 
	}
}

208 
	$usb_şo£
(
usb_hªdË
 *
h
)

210 
	`D
("usb_şo£(): closšg¿n¥Üˆ%p\n", 
h
);

211 
	`adb_mu‹x_lock
(&
usb_lock
);

213 
h
->
Ãxt
->
´ev
 = h->prev;

214 
h
->
´ev
->
Ãxt
 = h->next;

215 
h
->
´ev
 = 
NULL
;

216 
h
->
Ãxt
 = 
NULL
;

218 
	`libusb_»Ëa£_š‹rçû
(
h
->
devh
, h->
š‹rçû
);

219 
	`libusb_şo£
(
h
->
devh
);

220 
	`libusb_uÄef_deviû
(
h
->
dev
);

222 
	`adb_mu‹x_uÆock
(&
usb_lock
);

224 
	`ä“
(
h
);

227 
	}
}

229 
	$usb_kick
(
usb_hªdË
 *
h
)

231 
	`D
("usb_cick(): kickšg¿n¥Üˆ%p\n", 
h
);

233 
	`adb_mu‹x_lock
(&
h
->
lock
);

234 
	`uÄegi¡”_usb_Œª¥Üt
(
h
);

235 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

237 
h
->
Ãxt
->
´ev
 = h->prev;

238 
h
->
´ev
->
Ãxt
 = h->next;

239 
h
->
´ev
 = 
NULL
;

240 
h
->
Ãxt
 = 
NULL
;

242 
	`libusb_»Ëa£_š‹rçû
(
h
->
devh
, h->
š‹rçû
);

243 
	`libusb_şo£
(
h
->
devh
);

244 
	`libusb_uÄef_deviû
(
h
->
dev
);

245 
	`ä“
(
h
);

246 
	}
}

249 
	$check_usb_š‹rçû
(
libusb_š‹rçû
 *
š‹rçû
,

250 
libusb_deviû_desütÜ
 *
desc
,

251 
usb_hªdË
 *
uh
)

253 
e
;

255 ià(
š‹rçû
->
num_®t£‰šg
 == 0) {

256 
	`D
("check_usb_interface(): No interface settings\n");

260 
libusb_š‹rçû_desütÜ
 *
idesc
 = &
š‹rçû
->
®t£‰šg
[0];

262 ià(
idesc
->
bNumEndpošts
 != 2) {

263 
	`D
("check_usb_interface(): Interface have‚ot 2ƒndpoints, ignoring\n");

267 
e
 = 0;ƒ < 
idesc
->
bNumEndpošts
;ƒ++) {

268 
libusb_’dpošt_desütÜ
 *
edesc
 = &
idesc
->
’dpošt
[
e
];

270 ià(
edesc
->
bmA‰ribu‹s
 !ğ
LIBUSB_TRANSFER_TYPE_BULK
) {

271 
	`D
("check_usb_interface(): Endpoint (%u) is‚ot bulk (%u), ignoring\n",

272 
edesc
->
bmA‰ribu‹s
, 
LIBUSB_TRANSFER_TYPE_BULK
);

276 ià(
edesc
->
bEndpoštAdd»ss
 & 
LIBUSB_ENDPOINT_IN
)

277 
uh
->
’d_pošt_add»ss
[0] = 
edesc
->
bEndpoštAdd»ss
;

279 
uh
->
’d_pošt_add»ss
[1] = 
edesc
->
bEndpoštAdd»ss
;

282 ià(
idesc
->
bIÁ”çûPrÙocŞ
 == 0x01) {

283 
uh
->
z”o_mask
 = 
edesc
->
wMaxPack‘Size
 - 1;

284 
	`D
("check_usb_interface(): Forced Android interface…rotocol v.1\n");

288 
	`D
("check_usb_interface(): Device: %04x:%04x "

290 
desc
->
idV’dÜ
, desc->
idProduù
, 
idesc
->
bIÁ”çûCÏss
,

291 
idesc
->
bIÁ”çûSubCÏss
, idesc->
bIÁ”çûPrÙocŞ
,

292 
uh
->
’d_pošt_add»ss
[0], uh->end_point_address[1]);

294 ià(!
	`is_adb_š‹rçû
(
desc
->
idV’dÜ
, desc->
idProduù
,

295 
idesc
->
bIÁ”çûCÏss
, idesc->
bIÁ”çûSubCÏss
,

296 
idesc
->
bIÁ”çûPrÙocŞ
))

298 
	`D
("not matches\n");

302 
	`D
("matches\n");

304 
	}
}

307 
	$check_usb_š‹rçûs
(
libusb_cÚfig_desütÜ
 *
cÚfig
,

308 
libusb_deviû_desütÜ
 *
desc
, 
usb_hªdË
 *
uh
)

310 
i
;

312 
i
 = 0; i < 
cÚfig
->
bNumIÁ”çûs
; ++i) {

313 ià(
	`check_usb_š‹rçû
(&
cÚfig
->
š‹rçû
[
i
], 
desc
, 
uh
) != -1) {

315 
	`D
("check_usb_interfaces(): Interface %d of %04x:%04x "

316 "m©che Android deviû\n", 
i
, 
desc
->
idV’dÜ
,

317 
desc
->
idProduù
);

319  
i
;

324 
	}
}

327 
	$»gi¡”_deviû
(
usb_hªdË
 *
uh
, cÚ¡ *
£rŸl
)

329 
	`D
("register_device(): Registering %p [%s]‡s USBransport\n",

330 
uh
, 
£rŸl
);

332 
usb_hªdË
 *
usb
ğ
NULL
;

334 
usb
 = 
	`ÿÎoc
(1, (
usb_hªdË
));

335 
	`memıy
(
usb
, 
uh
, (
usb_hªdË
));

336 
	`¡rıy
(
usb
->
£rŸl
, 
uh
->serial);

338 
	`adb_cÚd_š™
(&
usb
->
nÙify
, 0);

339 
	`adb_mu‹x_š™
(&
usb
->
lock
, 0);

341 
	`adb_mu‹x_lock
(&
usb_lock
);

343 
usb
->
Ãxt
 = &
hªdË_li¡
;

344 
usb
->
´ev
 = 
hªdË_li¡
.prev;

345 
usb
->
´ev
->
Ãxt
 = usb;

346 
usb
->
Ãxt
->
´ev
 = usb;

348 
	`adb_mu‹x_uÆock
(&
usb_lock
);

350 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 
£rŸl
, 
NULL
, 1);

353 
	}
}

356 
	$®»ady_»gi¡”ed
(
usb_hªdË
 *
uh
)

358 
usb_hªdË
 *
usb
ğ
NULL
;

359 
exi¡s
 = 0;

361 
	`adb_mu‹x_lock
(&
usb_lock
);

363 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next) {

364 ià((
usb
->
dev_bus
 =ğ
uh
->dev_bus) &&

365 (
usb
->
dev_addr
 =ğ
uh
->dev_addr))

367 
exi¡s
 = 1;

372 
	`adb_mu‹x_uÆock
(&
usb_lock
);

374  
exi¡s
;

375 
	}
}

378 
	$check_deviû
(
libusb_deviû
 *
dev
)

380 
usb_hªdË
 
uh
;

381 
i
 = 0;

382 
found
 = -1;

383 
£rŸl
[256] = {0};

385 
libusb_deviû_desütÜ
 
desc
;

386 
libusb_cÚfig_desütÜ
 *
cÚfig
 = 
NULL
;

388 
r
 = 
	`libusb_g‘_deviû_desütÜ
(
dev
, &
desc
);

390 ià(
r
 !ğ
LIBUSB_SUCCESS
) {

391 
	`D
("check_device(): Failedo get device descriptor\n");

395 ià((
desc
.
idV’dÜ
 =ğ0è&& (desc.
idProduù
 == 0))

398 
	`D
("check_device(): Probing usb device %04x:%04x\n",

399 
desc
.
idV’dÜ
, desc.
idProduù
);

401 ià(!
	`is_adb_š‹rçû
 (
desc
.
idV’dÜ
, desc.
idProduù
,

402 
ADB_CLASS
, 
ADB_SUBCLASS
, 
ADB_PROTOCOL
))

404 
	`D
("check_device(): Ignored due unknown vendor id\n");

408 
uh
.
dev_bus
 = 
	`libusb_g‘_bus_numb”
(
dev
);

409 
uh
.
dev_addr
 = 
	`libusb_g‘_deviû_add»ss
(
dev
);

411 ià(
	`®»ady_»gi¡”ed
(&
uh
)) {

412 
	`D
("check_device(): Device (bus: %d,‡ddress: %d) "

413 "i ®»ady„egi¡”ed\n", 
uh
.
dev_bus
, uh.
dev_addr
);

417 
	`D
("check_device(): Device bus: %d,‡ddress: %d\n",

418 
uh
.
dev_bus
, uh.
dev_addr
);

420 
r
 = 
	`libusb_g‘_aùive_cÚfig_desütÜ
(
dev
, &
cÚfig
);

422 ià(
r
 != 0) {

423 ià(
r
 =ğ
LIBUSB_ERROR_NOT_FOUND
) {

424 
	`D
("check_device(): Device %4x:%4x is unconfigured\n",

425 
desc
.
idV’dÜ
, desc.
idProduù
);

429 
	`D
("check_device(): Failedo get configuration for %4x:%4x\n",

430 
desc
.
idV’dÜ
, desc.
idProduù
);

434 ià(
cÚfig
 =ğ
NULL
) {

435 
	`D
("check_device(): Sanity check failed‡fter "

440 ià(
cÚfig
->
š‹rçû
 !ğ
NULL
) {

441 
found
 = 
	`check_usb_š‹rçûs
(
cÚfig
, &
desc
, &
uh
);

445 
	`libusb_ä“_cÚfig_desütÜ
(
cÚfig
);

447 
r
 = 
	`libusb_İ’
(
dev
, &
uh
.
devh
);

448 
uh
.
dev
 = dev;

450 ià(
r
 != 0) {

451 
r
) {

452 
LIBUSB_ERROR_NO_MEM
:

453 
	`D
("check_device(): Memory‡llocation…roblem\n");

456 
LIBUSB_ERROR_ACCESS
:

457 
	`D
("check_device(): Permissions…roblem, "

461 
LIBUSB_ERROR_NO_DEVICE
:

462 
	`D
("check_device(): Device disconected, bad cable?\n");

466 
	`D
("check_deviû():†ibusbrigg”edƒ¼Ü %d\n", 
r
);

469 
found
 = -1;

472 ià(
found
 >= 0) {

473 
	`D
("check_device(): Device matches Android interface\n");

475 
	`mem£t
(
£rŸl
, 0, (serial));

476 
uh
.
š‹rçû
 = 
found
;

478 
r
 = 
	`libusb_şaim_š‹rçû
(
uh
.
devh
, uh.
š‹rçû
);

480 ià(
r
 < 0) {

481 
	`D
("check_device(): Failedo claim interface %d\n",

482 
uh
.
š‹rçû
);

484 
ç
;

487 ià(
desc
.
iS”ŸlNumb”
) {

489 
ušt16_t
 
bufãr
[128] = {0};

490 
ušt16_t
 
Ïnguages
[128] = {0};

491 
ÏnguageCouÁ
 = 0;

493 
	`mem£t
(
Ïnguages
, 0, (languages));

494 
r
 = 
	`libusb_cÚŒŞ_Œªsãr
(
uh
.
devh
,

495 
LIBUSB_ENDPOINT_IN
 | 
LIBUSB_REQUEST_TYPE_STANDARD
 | 
LIBUSB_RECIPIENT_DEVICE
,

496 
LIBUSB_REQUEST_GET_DESCRIPTOR
, 
LIBUSB_DT_STRING
 << 8,

497 0, (
ušt8_t
 *)
Ïnguages
, (languages), 0);

499 ià(
r
 <= 0) {

500 
	`D
("check_device(): Failedo get†anguages count\n");

501 
ç
;

504 
ÏnguageCouÁ
 = (
r
 - 2) / 2;

506 
i
 = 1; i <ğ
ÏnguageCouÁ
; ++i) {

507 
	`mem£t
(
bufãr
, 0, (buffer));

509 
r
 = 
	`libusb_cÚŒŞ_Œªsãr
(
uh
.
devh
,

510 
LIBUSB_ENDPOINT_IN
 | 
LIBUSB_REQUEST_TYPE_STANDARD
 | 
LIBUSB_RECIPIENT_DEVICE
,

511 
LIBUSB_REQUEST_GET_DESCRIPTOR
, (
LIBUSB_DT_STRING
 << 8è| 
desc
.
iS”ŸlNumb”
,

512 
Ïnguages
[
i
], (
ušt8_t
 *)
bufãr
, (buffer), 0);

514 ià(
r
 > 0) {

515 
j
 = 0;

516 
r
 /= 2;

518 
j
 = 1; j < 
r
; ++j)

519 
£rŸl
[
j
 - 1] = 
bufãr
[j];

521 
£rŸl
[
j
 - 1] = '\0';

526 ià(
	`»gi¡”_deviû
(&
uh
, 
£rŸl
) == 0) {

527 
	`D
("check_device(): Failedo„egister device\n");

528 
ç_š‹rçû
;

531 
	`libusb_»f_deviû
(
dev
);

537 
ç_š‹rçû
:

538 
	`libusb_»Ëa£_š‹rçû
(
uh
.
devh
, uh.
š‹rçû
);

540 
ç
:

541 
	`libusb_şo£
(
uh
.
devh
);

542 
uh
.
devh
 = 
NULL
;

543 
	}
}

546 
	$check_deviû_cÚÃùed
(
usb_hªdË
 *
uh
)

548 
r
 = 
	`libusb_k”Ãl_driv”_aùive
(
uh
->
devh
, uh->
š‹rçû
);

550 ià(
r
 =ğ
LIBUSB_ERROR_NO_DEVICE
)

553 ià(
r
 < 0)

557 
	}
}

560 
	$kick_discÚÃùed
()

562 
usb_hªdË
 *
usb
ğ
NULL
;

564 
	`adb_mu‹x_lock
(&
usb_lock
);

566 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next) {

568 ià(
	`check_deviû_cÚÃùed
(
usb
) == 0) {

569 
	`D
("kick_disconnected(): Transport %p is‚ot online‡nymore\n",

570 
usb
);

572 
	`usb_kick
(
usb
);

576 
	`adb_mu‹x_uÆock
(&
usb_lock
);

577 
	}
}

580 
	$sÿn_usb_deviûs
()

582 
	`D
("scan_usb_devices(): started\n");

584 
libusb_deviû
 **
devs
ğ
NULL
;

585 
libusb_deviû
 *
dev
ğ
NULL
;

586 
ssize_t
 
út
 = 
	`libusb_g‘_deviû_li¡
(
ùx
, &
devs
);

588 ià(
út
 < 0) {

589 
	`D
("scan_usb_devices(): Failedo get device†ist (error: %d)\n",

590 
út
);

595 
i
 = 0;

597 (
dev
 = 
devs
[
i
++]è!ğ
NULL
) {

598 
	`check_deviû
(
dev
);

601 
	`libusb_ä“_deviû_li¡
(
devs
, 1);

602 
	}
}

605 
	$deviû_pŞl_th»ad
(* 
unu£d
)

607 
	`D
("device_poll_thread(): Created USB scanhread\n");

610 
	`¦“p
(5);

611 
	`kick_discÚÃùed
();

612 
	`sÿn_usb_deviûs
();

616  (
NULL
);

617 
	}
}

620 
	$sig®rm_hªdËr
(
signo
)

623 
	}
}

626 
	$usb_š™
()

628 
	`D
("usb_init(): started\n");

629 
adb_th»ad_t
 
tid
;

630 
sigaùiÚ
 
aùiÚs
;

632 
r
 = 
	`libusb_š™
(&
ùx
);

634 ià(
r
 !ğ
LIBUSB_SUCCESS
) {

635 
	`”r
(
EX_IOERR
, "Failedo init†ibusb\n");

638 
	`mem£t
(&
aùiÚs
, 0, (actions));

640 
	`sigem±y£t
(&
aùiÚs
.
§_mask
);

642 
aùiÚs
.
§_æags
 = 0;

643 
aùiÚs
.
§_hªdËr
 = 
sig®rm_hªdËr
;

645 
	`sigaùiÚ
(
SIGALRM
, &
aùiÚs
, 
NULL
);

648 
	`sÿn_usb_deviûs
();

651 ià(
	`adb_th»ad_ü—‹
(&
tid
, 
deviû_pŞl_th»ad
, 
NULL
)) {

652 
	`”r
(
EX_IOERR
, "cannot create USB scanhread\n");

655 
	`D
("usb_init(): finished\n");

656 
	}
}

	@usb_linux.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

22 
	~<sys/ioùl.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/time.h
>

25 
	~<dœ’t.h
>

26 
	~<fú.h
>

27 
	~<”ºo.h
>

28 
	~<ùy³.h
>

30 
	~<lšux/usbdeviû_fs.h
>

31 
	~<lšux/v”siÚ.h
>

32 #ià
LINUX_VERSION_CODE
 > 
KERNEL_VERSION
(2, 6, 20)

33 
	~<lšux/usb/ch9.h
>

35 
	~<lšux/usb_ch9.h
>

37 
	~<asm/by‹Üd”.h
>

39 
	~"sysd•s.h
"

41 
	#TRACE_TAG
 
TRACE_USB


	)

42 
	~"adb.h
"

46 
	#DBGX
(
x
...)

	)

48 
ADB_MUTEX_DEFINE
Ğ
usb_lock
 );

50 
	susb_hªdË


52 
usb_hªdË
 *
	m´ev
;

53 
usb_hªdË
 *
	mÃxt
;

55 
	mâame
[64];

56 
	mdesc
;

57 
	m•_š
;

58 
	m•_out
;

60 
	mz”o_mask
;

61 
	mwr™—bË
;

63 
usbdevfs_urb
 
	murb_š
;

64 
usbdevfs_urb
 
	murb_out
;

66 
	murb_š_busy
;

67 
	murb_out_busy
;

68 
	md—d
;

70 
adb_cÚd_t
 
	mnÙify
;

71 
adb_mu‹x_t
 
	mlock
;

74 
	mm¬k
;

77 
±h»ad_t
 
	m»­”_th»ad
;

80 
usb_hªdË
 
	ghªdË_li¡
 = {

81 .
´ev
 = &
hªdË_li¡
,

82 .
	gÃxt
 = &
hªdË_li¡
,

85 
	$known_deviû
(cÚ¡ *
dev_Çme
)

87 
usb_hªdË
 *
usb
;

89 
	`adb_mu‹x_lock
(&
usb_lock
);

90 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next){

91 if(!
	`¡rcmp
(
usb
->
âame
, 
dev_Çme
)) {

93 
usb
->
m¬k
 = 1;

94 
	`adb_mu‹x_uÆock
(&
usb_lock
);

98 
	`adb_mu‹x_uÆock
(&
usb_lock
);

100 
	}
}

102 
	$kick_discÚÃùed_deviûs
()

104 
usb_hªdË
 *
usb
;

106 
	`adb_mu‹x_lock
(&
usb_lock
);

108 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next){

109 ià(
usb
->
m¬k
 == 0) {

110 
	`usb_kick
(
usb
);

112 
usb
->
m¬k
 = 0;

115 
	`adb_mu‹x_uÆock
(&
usb_lock
);

117 
	}
}

119 
»gi¡”_deviû
(cÚ¡ *
dev_Çme
, cÚ¡ *
dev·th
,

120 
•_š
, 
•_out
,

121 
ifc
, 
£rŸl_šdex
, 
z”o_mask
);

123 
šlše
 
	$badÇme
(cÚ¡ *
Çme
)

125 *
Çme
) {

126 if(!
	`isdig™
(*
Çme
++))  1;

129 
	}
}

131 
fšd_usb_deviû
(cÚ¡ *
ba£
,

132 (*
»gi¡”_deviû_ÿÎback
)

135 
bu¢ame
[32], 
devÇme
[32];

136 
loÿl_•_š
, 
loÿl_•_out
;

137 
DIR
 *
busdœ
 , *
devdœ
 ;

138 
dœ’t
 *
de
;

139 
fd
 ;

141 
busdœ
 = 
	`İ’dœ
(
ba£
);

142 if(
busdœ
 == 0) ;

144 (
de
 = 
	`»addœ
(
busdœ
)) != 0) {

145 if(
	`badÇme
(
de
->
d_Çme
)) ;

147 
	`¢´štf
(
bu¢ame
,  bu¢ame, "%s/%s", 
ba£
, 
de
->
d_Çme
);

148 
devdœ
 = 
	`İ’dœ
(
bu¢ame
);

149 if(
devdœ
 == 0) ;

152 (
de
 = 
	`»addœ
(
devdœ
))) {

153 
devdesc
[4096];

154 * 
buåŒ
 = 
devdesc
;

155 * 
buãnd
;

156 
usb_deviû_desütÜ
* 
deviû
;

157 
usb_cÚfig_desütÜ
* 
cÚfig
;

158 
usb_š‹rçû_desütÜ
* 
š‹rçû
;

159 
usb_’dpošt_desütÜ
 *
•1
, *
•2
;

160 
z”o_mask
 = 0;

161 
vid
, 
pid
;

162 
size_t
 
desş’gth
;

164 if(
	`badÇme
(
de
->
d_Çme
)) ;

165 
	`¢´štf
(
devÇme
,  devÇme, "%s/%s", 
bu¢ame
, 
de
->
d_Çme
);

167 if(
	`known_deviû
(
devÇme
)) {

168 
	`DBGX
("skpšg %s\n", 
devÇme
);

173 if((
fd
 = 
	`unix_İ’
(
devÇme
, 
O_RDONLY
)) < 0) {

177 
desş’gth
 = 
	`adb_»ad
(
fd
, 
devdesc
, (devdesc));

178 
buãnd
 = 
buåŒ
 + 
desş’gth
;

181 ià(
desş’gth
 < 
USB_DT_DEVICE_SIZE
 + 
USB_DT_CONFIG_SIZE
) {

182 
	`D
("desş’gth %d i toØsm®l\n", 
desş’gth
);

183 
	`adb_şo£
(
fd
);

187 
deviû
 = (
usb_deviû_desütÜ
*)
buåŒ
;

188 
buåŒ
 +ğ
USB_DT_DEVICE_SIZE
;

190 if((
deviû
->
bL’gth
 !ğ
USB_DT_DEVICE_SIZE
è|| (deviû->
bDesütÜTy³
 !ğ
USB_DT_DEVICE
)) {

191 
	`adb_şo£
(
fd
);

195 
vid
 = 
deviû
->
idV’dÜ
;

196 
pid
 = 
deviû
->
idProduù
;

197 
	`DBGX
("[ % i V:%04x P:%04x ]\n", 
devÇme
, 
vid
, 
pid
);

200 
cÚfig
 = (
usb_cÚfig_desütÜ
 *)
buåŒ
;

201 
buåŒ
 +ğ
USB_DT_CONFIG_SIZE
;

202 ià(
cÚfig
->
bL’gth
 !ğ
USB_DT_CONFIG_SIZE
 || cÚfig->
bDesütÜTy³
 !ğ
USB_DT_CONFIG
) {

203 
	`D
("usb_config_descriptor‚ot found\n");

204 
	`adb_şo£
(
fd
);

209 
buåŒ
 < 
buãnd
) {

210 
Ëngth
 = 
buåŒ
[0];

211 
ty³
 = 
buåŒ
[1];

213 ià(
ty³
 =ğ
USB_DT_INTERFACE
) {

214 
š‹rçû
 = (
usb_š‹rçû_desütÜ
 *)
buåŒ
;

215 
buåŒ
 +ğ
Ëngth
;

217 ià(
Ëngth
 !ğ
USB_DT_INTERFACE_SIZE
) {

218 
	`D
("interface descriptor has wrong size\n");

222 
	`DBGX
("bInterfaceClass: %d, bInterfaceSubClass: %d,"

224 
š‹rçû
->
bIÁ”çûCÏss
, iÁ”çû->
bIÁ”çûSubCÏss
,

225 
š‹rçû
->
bIÁ”çûPrÙocŞ
, iÁ”çû->
bNumEndpošts
);

227 ià(
š‹rçû
->
bNumEndpošts
 == 2 &&

228 
	`is_adb_š‹rçû
(
vid
, 
pid
, 
š‹rçû
->
bIÁ”çûCÏss
,

229 
š‹rçû
->
bIÁ”çûSubCÏss
, iÁ”çû->
bIÁ”çûPrÙocŞ
)) {

231 
¡©
 
¡
;

232 
·thbuf
[128];

233 
lšk
[256];

234 *
dev·th
 = 
NULL
;

236 
	`DBGX
("looking for bulkƒndpoints\n");

238 
•1
 = (
usb_’dpošt_desütÜ
 *)
buåŒ
;

239 
buåŒ
 +ğ
USB_DT_ENDPOINT_SIZE
;

240 
•2
 = (
usb_’dpošt_desütÜ
 *)
buåŒ
;

241 
buåŒ
 +ğ
USB_DT_ENDPOINT_SIZE
;

243 ià(
buåŒ
 > 
devdesc
 + 
desş’gth
 ||

244 
•1
->
bL’gth
 !ğ
USB_DT_ENDPOINT_SIZE
 ||

245 
•1
->
bDesütÜTy³
 !ğ
USB_DT_ENDPOINT
 ||

246 
•2
->
bL’gth
 !ğ
USB_DT_ENDPOINT_SIZE
 ||

247 
•2
->
bDesütÜTy³
 !ğ
USB_DT_ENDPOINT
) {

248 
	`D
("endpoints‚ot found\n");

253 ià(
•1
->
bmA‰ribu‹s
 !ğ
USB_ENDPOINT_XFER_BULK
 ||

254 
•2
->
bmA‰ribu‹s
 !ğ
USB_ENDPOINT_XFER_BULK
) {

255 
	`D
("bulkƒndpoints‚ot found\n");

259 if(
š‹rçû
->
bIÁ”çûPrÙocŞ
 == 0x01) {

260 
z”o_mask
 = 
•1
->
wMaxPack‘Size
 - 1;

264 ià(
•1
->
bEndpoštAdd»ss
 & 
USB_ENDPOINT_DIR_MASK
) {

265 
loÿl_•_š
 = 
•1
->
bEndpoštAdd»ss
;

266 
loÿl_•_out
 = 
•2
->
bEndpoštAdd»ss
;

268 
loÿl_•_š
 = 
•2
->
bEndpoštAdd»ss
;

269 
loÿl_•_out
 = 
•1
->
bEndpoštAdd»ss
;

273 ià(!
	`f¡©
(
fd
, &
¡
è&& 
	`S_ISCHR
(¡.
¡_mode
)) {

274 *
¦ash
;

275 
ssize_t
 
lšk_Ën
;

276 
	`¢´štf
(
·thbuf
, (pathbuf), "/sys/dev/char/%d:%d",

277 
	`majÜ
(
¡
.
¡_rdev
), 
	`mšÜ
(st.st_rdev));

278 
lšk_Ën
 = 
	`»adlšk
(
·thbuf
, 
lšk
, (link) - 1);

279 ià(
lšk_Ën
 > 0) {

280 
lšk
[
lšk_Ën
] = '\0';

281 
¦ash
 = 
	`¡¼chr
(
lšk
, '/');

282 ià(
¦ash
) {

283 
	`¢´štf
(
·thbuf
, (pathbuf),

284 "usb:%s", 
¦ash
 + 1);

285 
dev·th
 = 
·thbuf
;

290 
	`»gi¡”_deviû_ÿÎback
(
devÇme
, 
dev·th
,

291 
loÿl_•_š
, 
loÿl_•_out
,

292 
š‹rçû
->
bIÁ”çûNumb”
, 
deviû
->
iS”ŸlNumb”
, 
z”o_mask
);

296 
buåŒ
 +ğ
Ëngth
;

300 
	`adb_şo£
(
fd
);

302 
	`şo£dœ
(
devdœ
);

304 
	`şo£dœ
(
busdœ
);

305 
	}
}

307 
	$usb_ş—nup
()

309 
	}
}

311 
	$usb_bulk_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

313 
usbdevfs_urb
 *
urb
 = &
h
->
urb_out
;

314 
»s
;

315 
timev®
 
tv
;

316 
time¥ec
 
ts
;

318 
	`mem£t
(
urb
, 0, (*urb));

319 
urb
->
ty³
 = 
USBDEVFS_URB_TYPE_BULK
;

320 
urb
->
’dpošt
 = 
h
->
•_out
;

321 
urb
->
¡©us
 = -1;

322 
urb
->
bufãr
 = (*è
d©a
;

323 
urb
->
bufãr_Ëngth
 = 
Ën
;

325 
	`D
("++ write ++\n");

327 
	`adb_mu‹x_lock
(&
h
->
lock
);

328 if(
h
->
d—d
) {

329 
»s
 = -1;

330 
ç
;

333 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_SUBMITURB
, 
urb
);

334 } (
»s
 < 0è&& (
”ºo
 =ğ
EINTR
));

336 if(
»s
 < 0) {

337 
ç
;

340 
»s
 = -1;

341 
h
->
urb_out_busy
 = 1;

344 
	`g‘timeofday
(&
tv
, 
NULL
);

345 
ts
.
tv_£c
 = 
tv
.tv_sec + 5;

346 
ts
.
tv_n£c
 = 
tv
.
tv_u£c
 * 1000L;

347 
»s
 = 
	`±h»ad_cÚd_timedwa™
(&
h
->
nÙify
, &h->
lock
, &
ts
);

348 if(
»s
 < 0 || 
h
->
d—d
) {

351 if(
h
->
urb_out_busy
 == 0) {

352 if(
urb
->
¡©us
 == 0) {

353 
»s
 = 
urb
->
aùu®_Ëngth
;

358 
ç
:

359 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

360 
	`D
("-- write --\n");

361  
»s
;

362 
	}
}

364 
	$usb_bulk_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

366 
usbdevfs_urb
 *
urb
 = &
h
->
urb_š
;

367 
usbdevfs_urb
 *
out
 = 
NULL
;

368 
»s
;

370 
	`mem£t
(
urb
, 0, (*urb));

371 
urb
->
ty³
 = 
USBDEVFS_URB_TYPE_BULK
;

372 
urb
->
’dpošt
 = 
h
->
•_š
;

373 
urb
->
¡©us
 = -1;

374 
urb
->
bufãr
 = 
d©a
;

375 
urb
->
bufãr_Ëngth
 = 
Ën
;

378 
	`adb_mu‹x_lock
(&
h
->
lock
);

379 if(
h
->
d—d
) {

380 
»s
 = -1;

381 
ç
;

384 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_SUBMITURB
, 
urb
);

385 } (
»s
 < 0è&& (
”ºo
 =ğ
EINTR
));

387 if(
»s
 < 0) {

388 
ç
;

391 
h
->
urb_š_busy
 = 1;

393 
	`D
("[„eap urb - wait ]\n");

394 
h
->
»­”_th»ad
 = 
	`±h»ad_£lf
();

395 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

396 
»s
 = 
	`ioùl
(
h
->
desc
, 
USBDEVFS_REAPURB
, &
out
);

397 
§ved_”ºo
 = 
”ºo
;

398 
	`adb_mu‹x_lock
(&
h
->
lock
);

399 
h
->
»­”_th»ad
 = 0;

400 if(
h
->
d—d
) {

401 
»s
 = -1;

404 if(
»s
 < 0) {

405 if(
§ved_”ºo
 =ğ
EINTR
) {

408 
	`D
("[„eap urb -ƒrror ]\n");

411 
	`D
("[ urb @%p status = %d,‡ctual = %d ]\n",

412 
out
, out->
¡©us
, out->
aùu®_Ëngth
);

414 if(
out
 =ğ&
h
->
urb_š
) {

415 
	`D
("[„eap urb - IN complete ]\n");

416 
h
->
urb_š_busy
 = 0;

417 if(
urb
->
¡©us
 == 0) {

418 
»s
 = 
urb
->
aùu®_Ëngth
;

420 
»s
 = -1;

424 if(
out
 =ğ&
h
->
urb_out
) {

425 
	`D
("[„eap urb - OUT compelete ]\n");

426 
h
->
urb_out_busy
 = 0;

427 
	`adb_cÚd_brßdÿ¡
(&
h
->
nÙify
);

430 
ç
:

431 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

432  
»s
;

433 
	}
}

436 
	$usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
_d©a
, 
Ën
)

438 *
d©a
 = (*è
_d©a
;

439 
n
;

440 
Ãed_z”o
 = 0;

442 if(
h
->
z”o_mask
) {

447 if(!(
Ën
 & 
h
->
z”o_mask
)) {

448 
Ãed_z”o
 = 1;

452 
Ën
 > 0) {

453 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

455 
n
 = 
	`usb_bulk_wr™e
(
h
, 
d©a
, 
xãr
);

456 if(
n
 !ğ
xãr
) {

457 
	`D
("ERROR:‚ = %d,ƒrrno = %d (%s)\n",

458 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

462 
Ën
 -ğ
xãr
;

463 
d©a
 +ğ
xãr
;

466 if(
Ãed_z”o
){

467 
n
 = 
	`usb_bulk_wr™e
(
h
, 
_d©a
, 0);

468  
n
;

472 
	}
}

474 
	$usb_»ad
(
usb_hªdË
 *
h
, *
_d©a
, 
Ën
)

476 *
d©a
 = (*è
_d©a
;

477 
n
;

479 
	`D
("++ usb_read ++\n");

480 
Ën
 > 0) {

481 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

483 
	`D
("[ usb„—d %d fd = %d], fÇme=%s\n", 
xãr
, 
h
->
desc
, h->
âame
);

484 
n
 = 
	`usb_bulk_»ad
(
h
, 
d©a
, 
xãr
);

485 
	`D
("[ usb„—d %d ] = %d, fÇme=%s\n", 
xãr
, 
n
, 
h
->
âame
);

486 if(
n
 !ğ
xãr
) {

487 if((
”ºo
 =ğ
ETIMEDOUT
è&& (
h
->
desc
 != -1)) {

488 
	`D
("[imeout ]\n");

489 if(
n
 > 0){

490 
d©a
 +ğ
n
;

491 
Ën
 -ğ
n
;

495 
	`D
("ERROR:‚ = %d,ƒrrno = %d (%s)\n",

496 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

500 
Ën
 -ğ
xãr
;

501 
d©a
 +ğ
xãr
;

504 
	`D
("-- usb_read --\n");

506 
	}
}

508 
	$usb_kick
(
usb_hªdË
 *
h
)

510 
	`D
("[ kickšg %°(fd = %dè]\n", 
h
, h->
desc
);

511 
	`adb_mu‹x_lock
(&
h
->
lock
);

512 if(
h
->
d—d
 == 0) {

513 
h
->
d—d
 = 1;

515 ià(
h
->
wr™—bË
) {

520 ià(
h
->
»­”_th»ad
) {

521 
	`±h»ad_kl
(
h
->
»­”_th»ad
, 
SIGALRM
);

529 
	`ioùl
(
h
->
desc
, 
USBDEVFS_DISCARDURB
, &h->
urb_š
);

530 
	`ioùl
(
h
->
desc
, 
USBDEVFS_DISCARDURB
, &h->
urb_out
);

531 
h
->
urb_š
.
¡©us
 = -
ENODEV
;

532 
h
->
urb_out
.
¡©us
 = -
ENODEV
;

533 
h
->
urb_š_busy
 = 0;

534 
h
->
urb_out_busy
 = 0;

535 
	`adb_cÚd_brßdÿ¡
(&
h
->
nÙify
);

537 
	`uÄegi¡”_usb_Œª¥Üt
(
h
);

540 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

541 
	}
}

543 
	$usb_şo£
(
usb_hªdË
 *
h
)

545 
	`D
("[ usb close ... ]\n");

546 
	`adb_mu‹x_lock
(&
usb_lock
);

547 
h
->
Ãxt
->
´ev
 = h->prev;

548 
h
->
´ev
->
Ãxt
 = h->next;

549 
h
->
´ev
 = 0;

550 
h
->
Ãxt
 = 0;

552 
	`adb_şo£
(
h
->
desc
);

553 
	`D
("[ usb clo£d %°(fd = %dè]\n", 
h
, h->
desc
);

554 
	`adb_mu‹x_uÆock
(&
usb_lock
);

556 
	`ä“
(
h
);

558 
	}
}

560 
	$»gi¡”_deviû
(cÚ¡ *
dev_Çme
, cÚ¡ *
dev·th
,

561 
•_š
, 
•_out
,

562 
š‹rçû
, 
£rŸl_šdex
, 
z”o_mask
)

564 
usb_hªdË
* 
usb
 = 0;

565 
n
 = 0;

566 
£rŸl
[256];

576 
	`adb_mu‹x_lock
(&
usb_lock
);

577 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next){

578 if(!
	`¡rcmp
(
usb
->
âame
, 
dev_Çme
)) {

579 
	`adb_mu‹x_uÆock
(&
usb_lock
);

583 
	`adb_mu‹x_uÆock
(&
usb_lock
);

585 
	`D
("[ usb†ocated‚ew device %s (%d/%d/%d) ]\n",

586 
dev_Çme
, 
•_š
, 
•_out
, 
š‹rçû
);

587 
usb
 = 
	`ÿÎoc
(1, (
usb_hªdË
));

588 
	`¡rıy
(
usb
->
âame
, 
dev_Çme
);

589 
usb
->
•_š
 =ƒp_in;

590 
usb
->
•_out
 =ƒp_out;

591 
usb
->
z”o_mask
 = zero_mask;

592 
usb
->
wr™—bË
 = 1;

594 
	`adb_cÚd_š™
(&
usb
->
nÙify
, 0);

595 
	`adb_mu‹x_š™
(&
usb
->
lock
, 0);

597 
usb
->
m¬k
 = 1;

598 
usb
->
»­”_th»ad
 = 0;

600 
usb
->
desc
 = 
	`unix_İ’
(usb->
âame
, 
O_RDWR
);

601 if(
usb
->
desc
 < 0) {

603 
usb
->
desc
 = 
	`unix_İ’
(usb->
âame
, 
O_RDONLY
);

604 if(
usb
->
desc
 < 0è
ç
;

605 
usb
->
wr™—bË
 = 0;

606 
	`D
("[ usb o³À»ad-Úly % fd = %d]\n", 
usb
->
âame
, usb->
desc
);

608 
	`D
("[ usb o³À% fd = %d]\n", 
usb
->
âame
, usb->
desc
);

609 
n
 = 
	`ioùl
(
usb
->
desc
, 
USBDEVFS_CLAIMINTERFACE
, &
š‹rçû
);

610 if(
n
 !ğ0è
ç
;

614 
£rŸl
[0] = 0;

615 
	`mem£t
(
£rŸl
, 0, (serial));

616 ià(
£rŸl_šdex
) {

617 
usbdevfs_ù¾Œªsãr
 
ù¾
;

618 
__u16
 
bufãr
[128];

619 
__u16
 
Ïnguages
[128];

620 
i
, 
»suÉ
;

621 
ÏnguageCouÁ
 = 0;

623 
	`mem£t
(
Ïnguages
, 0, (languages));

624 
	`mem£t
(&
ù¾
, 0, (ctrl));

627 
ù¾
.
bReque¡Ty³
 = 
USB_DIR_IN
|
USB_TYPE_STANDARD
|
USB_RECIP_DEVICE
;

628 
ù¾
.
bReque¡
 = 
USB_REQ_GET_DESCRIPTOR
;

629 
ù¾
.
wV®ue
 = (
USB_DT_STRING
 << 8) | 0;

630 
ù¾
.
wIndex
 = 0;

631 
ù¾
.
wL’gth
 = (
Ïnguages
);

632 
ù¾
.
d©a
 = 
Ïnguages
;

633 
ù¾
.
timeout
 = 1000;

635 
»suÉ
 = 
	`ioùl
(
usb
->
desc
, 
USBDEVFS_CONTROL
, &
ù¾
);

636 ià(
»suÉ
 > 0)

637 
ÏnguageCouÁ
 = (
»suÉ
 - 2) / 2;

639 
i
 = 1; i <ğ
ÏnguageCouÁ
; i++) {

640 
	`mem£t
(
bufãr
, 0, (buffer));

641 
	`mem£t
(&
ù¾
, 0, (ctrl));

643 
ù¾
.
bReque¡Ty³
 = 
USB_DIR_IN
|
USB_TYPE_STANDARD
|
USB_RECIP_DEVICE
;

644 
ù¾
.
bReque¡
 = 
USB_REQ_GET_DESCRIPTOR
;

645 
ù¾
.
wV®ue
 = (
USB_DT_STRING
 << 8è| 
£rŸl_šdex
;

646 
ù¾
.
wIndex
 = 
	`__Ë16_to_ıu
(
Ïnguages
[
i
]);

647 
ù¾
.
wL’gth
 = (
bufãr
);

648 
ù¾
.
d©a
 = 
bufãr
;

649 
ù¾
.
timeout
 = 1000;

651 
»suÉ
 = 
	`ioùl
(
usb
->
desc
, 
USBDEVFS_CONTROL
, &
ù¾
);

652 ià(
»suÉ
 > 0) {

653 
i
;

655 
»suÉ
 /= 2;

656 
i
 = 1; i < 
»suÉ
; i++)

657 
£rŸl
[
i
 - 1] = 
	`__Ë16_to_ıu
(
bufãr
[i]);

658 
£rŸl
[
i
 - 1] = 0;

665 
	`adb_mu‹x_lock
(&
usb_lock
);

666 
usb
->
Ãxt
 = &
hªdË_li¡
;

667 
usb
->
´ev
 = 
hªdË_li¡
.prev;

668 
usb
->
´ev
->
Ãxt
 = usb;

669 
usb
->
Ãxt
->
´ev
 = usb;

670 
	`adb_mu‹x_uÆock
(&
usb_lock
);

672 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 
£rŸl
, 
dev·th
, usb->
wr™—bË
);

675 
ç
:

676 
	`D
("[ usb open %sƒrror=%d,ƒrr_str = %s]\n",

677 
usb
->
âame
, 
”ºo
, 
	`¡»¼Ü
(errno));

678 if(
usb
->
desc
 >= 0) {

679 
	`adb_şo£
(
usb
->
desc
);

681 
	`ä“
(
usb
);

682 
	}
}

684 * 
	$deviû_pŞl_th»ad
(* 
unu£d
)

686 
	`D
("Created devicehread\n");

689 
	`fšd_usb_deviû
("/dev/bus/usb", 
»gi¡”_deviû
);

690 
	`kick_discÚÃùed_deviûs
();

691 
	`¦“p
(1);

693  
NULL
;

694 
	}
}

696 
	$sig®rm_hªdËr
(
signo
)

699 
	}
}

701 
	$usb_š™
()

703 
adb_th»ad_t
 
tid
;

704 
sigaùiÚ
 
aùiÚs
;

706 
	`mem£t
(&
aùiÚs
, 0, (actions));

707 
	`sigem±y£t
(&
aùiÚs
.
§_mask
);

708 
aùiÚs
.
§_æags
 = 0;

709 
aùiÚs
.
§_hªdËr
 = 
sig®rm_hªdËr
;

710 
	`sigaùiÚ
(
SIGALRM
,& 
aùiÚs
, 
NULL
);

712 if(
	`adb_th»ad_ü—‹
(&
tid
, 
deviû_pŞl_th»ad
, 
NULL
)){

713 
	`çl_”ºo
("cannot create inputhread");

715 
	}
}

	@usb_linux_client.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

22 
	~<lšux/usb/ch9.h
>

23 
	~<lšux/usb/funùiÚfs.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/ty³s.h
>

26 
	~<dœ’t.h
>

27 
	~<”ºo.h
>

29 
	~"sysd•s.h
"

31 
	#TRACE_TAG
 
TRACE_USB


	)

32 
	~"adb.h
"

34 
	#MAX_PACKET_SIZE_FS
 64

	)

35 
	#MAX_PACKET_SIZE_HS
 512

	)

37 
	#ıu_to_Ë16
(
x
è
	`htŞe16
(x)

	)

38 
	#ıu_to_Ë32
(
x
è
	`htŞe32
(x)

	)

40 
	susb_hªdË


42 
adb_cÚd_t
 
	mnÙify
;

43 
adb_mu‹x_t
 
	mlock
;

45 (*
	mwr™e
)(
usb_hªdË
 *
	mh
, cÚ¡ *
	md©a
, 
	mËn
);

46 (*
	m»ad
)(
usb_hªdË
 *
	mh
, *
	md©a
, 
	mËn
);

47 (*
	mkick
)(
usb_hªdË
 *
	mh
);

50 
	mfd
;

53 
	mcÚŒŞ
;

54 
	mbulk_out
;

55 
	mbulk_š
;

59 
usb_funùiÚfs_descs_h—d
 
	mh—d”
;

61 
usb_š‹rçû_desütÜ
 
	mštf
;

62 
usb_’dpošt_desütÜ_no_audio
 
	msourû
;

63 
usb_’dpošt_desütÜ_no_audio
 
	msšk
;

64 } 
__©Œibu‹__
((
·cked
)è
	mfs_descs
, 
	mhs_descs
;

65 } 
__©Œibu‹__
((
·cked
)è
	gdesütÜs
 = {

66 .
h—d”
 = {

67 .
magic
 = 
ıu_to_Ë32
(
FUNCTIONFS_DESCRIPTORS_MAGIC
),

68 .
	gËngth
 = 
ıu_to_Ë32
((
desütÜs
)),

69 .
	gfs_couÁ
 = 3,

70 .
	ghs_couÁ
 = 3,

72 .
	gfs_descs
 = {

73 .
štf
 = {

74 .
bL’gth
 = (
desütÜs
.
fs_descs
.
štf
),

75 .
	gbDesütÜTy³
 = 
USB_DT_INTERFACE
,

76 .
	gbIÁ”çûNumb”
 = 0,

77 .
	gbNumEndpošts
 = 2,

78 .
	gbIÁ”çûCÏss
 = 
ADB_CLASS
,

79 .
	gbIÁ”çûSubCÏss
 = 
ADB_SUBCLASS
,

80 .
	gbIÁ”çûPrÙocŞ
 = 
ADB_PROTOCOL
,

81 .
	giIÁ”çû
 = 1,

83 .
	gsourû
 = {

84 .
bL’gth
 = (
desütÜs
.
fs_descs
.
sourû
),

85 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

86 .
	gbEndpoštAdd»ss
 = 1 | 
USB_DIR_OUT
,

87 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

88 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_FS
,

90 .
	gsšk
 = {

91 .
bL’gth
 = (
desütÜs
.
fs_descs
.
sšk
),

92 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

93 .
	gbEndpoštAdd»ss
 = 2 | 
USB_DIR_IN
,

94 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

95 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_FS
,

98 .
	ghs_descs
 = {

99 .
štf
 = {

100 .
bL’gth
 = (
desütÜs
.
hs_descs
.
štf
),

101 .
	gbDesütÜTy³
 = 
USB_DT_INTERFACE
,

102 .
	gbIÁ”çûNumb”
 = 0,

103 .
	gbNumEndpošts
 = 2,

104 .
	gbIÁ”çûCÏss
 = 
ADB_CLASS
,

105 .
	gbIÁ”çûSubCÏss
 = 
ADB_SUBCLASS
,

106 .
	gbIÁ”çûPrÙocŞ
 = 
ADB_PROTOCOL
,

107 .
	giIÁ”çû
 = 1,

109 .
	gsourû
 = {

110 .
bL’gth
 = (
desütÜs
.
hs_descs
.
sourû
),

111 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

112 .
	gbEndpoštAdd»ss
 = 1 | 
USB_DIR_OUT
,

113 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

114 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_HS
,

116 .
	gsšk
 = {

117 .
bL’gth
 = (
desütÜs
.
hs_descs
.
sšk
),

118 .
	gbDesütÜTy³
 = 
USB_DT_ENDPOINT
,

119 .
	gbEndpoštAdd»ss
 = 2 | 
USB_DIR_IN
,

120 .
	gbmA‰ribu‹s
 = 
USB_ENDPOINT_XFER_BULK
,

121 .
	gwMaxPack‘Size
 = 
MAX_PACKET_SIZE_HS
,

126 
	#STR_INTERFACE_
 "ADB IÁ”çû"

	)

129 
usb_funùiÚfs_¡ršgs_h—d
 
	mh—d”
;

131 
__Ë16
 
	mcode
;

132 cÚ¡ 
	m¡r1
[(
STR_INTERFACE_
)];

133 } 
__©Œibu‹__
((
·cked
)è
	mÏng0
;

134 } 
__©Œibu‹__
((
·cked
)è
	g¡ršgs
 = {

135 .
h—d”
 = {

136 .
magic
 = 
ıu_to_Ë32
(
FUNCTIONFS_STRINGS_MAGIC
),

137 .
	gËngth
 = 
ıu_to_Ë32
((
¡ršgs
)),

138 .
	g¡r_couÁ
 = 
ıu_to_Ë32
(1),

139 .
	gÏng_couÁ
 = 
ıu_to_Ë32
(1),

141 .
	gÏng0
 = {

142 
ıu_to_Ë16
(0x0409),

143 
STR_INTERFACE_
,

149 *
	$usb_adb_İ’_th»ad
(*
x
)

151 
usb_hªdË
 *
usb
 = (usb_hªdË *)
x
;

152 
fd
;

156 
	`adb_mu‹x_lock
(&
usb
->
lock
);

157 
usb
->
fd
 != -1)

158 
	`adb_cÚd_wa™
(&
usb
->
nÙify
, &usb->
lock
);

159 
	`adb_mu‹x_uÆock
(&
usb
->
lock
);

161 
	`D
("[ usb_thread - opening device ]\n");

164 
fd
 = 
	`unix_İ’
("/dev/ªdroid_adb", 
O_RDWR
);

165 ià(
fd
 < 0) {

167 
fd
 = 
	`unix_İ’
("/dev/ªdroid", 
O_RDWR
);

169 ià(
fd
 < 0) {

170 
	`adb_¦“p_ms
(1000);

172 } 
fd
 < 0);

173 
	`D
("[ opening device succeeded ]\n");

175 
	`şo£_Ú_exec
(
fd
);

176 
usb
->
fd
 = fd;

178 
	`D
("[ usb_thread -„egistering device ]\n");

179 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 0, 0, 1);

184 
	}
}

186 
	$usb_adb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

188 
n
;

190 
	`D
("abouˆtØwr™(fd=%d,†’=%d)\n", 
h
->
fd
, 
Ën
);

191 
n
 = 
	`adb_wr™e
(
h
->
fd
, 
d©a
, 
Ën
);

192 if(
n
 !ğ
Ën
) {

193 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

194 
h
->
fd
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

197 
	`D
("[ dÚfd=%d ]\n", 
h
->
fd
);

199 
	}
}

201 
	$usb_adb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

203 
n
;

205 
	`D
("abouˆtØ»ad (fd=%d,†’=%d)\n", 
h
->
fd
, 
Ën
);

206 
n
 = 
	`adb_»ad
(
h
->
fd
, 
d©a
, 
Ën
);

207 if(
n
 !ğ
Ën
) {

208 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

209 
h
->
fd
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

212 
	`D
("[ dÚfd=%d ]\n", 
h
->
fd
);

214 
	}
}

216 
	$usb_adb_kick
(
usb_hªdË
 *
h
)

218 
	`D
("usb_kick\n");

219 
	`adb_mu‹x_lock
(&
h
->
lock
);

220 
	`adb_şo£
(
h
->
fd
);

221 
h
->
fd
 = -1;

224 
	`adb_cÚd_sigÇl
(&
h
->
nÙify
);

225 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

226 
	}
}

228 
	$usb_adb_š™
()

230 
usb_hªdË
 *
h
;

231 
adb_th»ad_t
 
tid
;

232 
fd
;

234 
h
 = 
	`ÿÎoc
(1, (
usb_hªdË
));

236 
h
->
wr™e
 = 
usb_adb_wr™e
;

237 
h
->
»ad
 = 
usb_adb_»ad
;

238 
h
->
kick
 = 
usb_adb_kick
;

239 
h
->
fd
 = -1;

241 
	`adb_cÚd_š™
(&
h
->
nÙify
, 0);

242 
	`adb_mu‹x_š™
(&
h
->
lock
, 0);

249 
fd
 = 
	`unix_İ’
("/dev/ªdroid_adb_’abË", 
O_RDWR
);

250 ià(
fd
 < 0) {

251 
	`D
("failedo open /dev/android_adb_enable\n");

253 
	`şo£_Ú_exec
(
fd
);

256 
	`D
("[ usb_init - startinghread ]\n");

257 if(
	`adb_th»ad_ü—‹
(&
tid
, 
usb_adb_İ’_th»ad
, 
h
)){

258 
	`çl_”ºo
("cannot create usbhread");

260 
	}
}

263 
	$š™_funùiÚfs
(
usb_hªdË
 *
h
)

265 
ssize_t
 
»t
;

267 
	`D
("OPENING %s\n", 
USB_FFS_ADB_EP0
);

268 
h
->
cÚŒŞ
 = 
	`adb_İ’
(
USB_FFS_ADB_EP0
, 
O_RDWR
);

269 ià(
h
->
cÚŒŞ
 < 0) {

270 
	`D
("[ %s: cªnÙ o³ÀcÚŒŞƒndpošt:ƒ¼no=%d]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

271 
”r
;

274 
»t
 = 
	`adb_wr™e
(
h
->
cÚŒŞ
, &
desütÜs
, (descriptors));

275 ià(
»t
 < 0) {

276 
	`D
("[ %s: wr™desütÜ çed:ƒ¼no=%d ]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

277 
”r
;

280 
»t
 = 
	`adb_wr™e
(
h
->
cÚŒŞ
, &
¡ršgs
, (strings));

281 ià(
»t
 < 0) {

282 
	`D
("[ %s: wr™šg sŒšg çed:ƒ¼no=%d]\n", 
USB_FFS_ADB_EP0
, 
”ºo
);

283 
”r
;

286 
h
->
bulk_out
 = 
	`adb_İ’
(
USB_FFS_ADB_OUT
, 
O_RDWR
);

287 ià(
h
->
bulk_out
 < 0) {

288 
	`D
("[ %s: cªnÙ o³Àbulk-ouˆ•:ƒ¼no=%d ]\n", 
USB_FFS_ADB_OUT
, 
”ºo
);

289 
”r
;

292 
h
->
bulk_š
 = 
	`adb_İ’
(
USB_FFS_ADB_IN
, 
O_RDWR
);

293 ià(
h
->
bulk_š
 < 0) {

294 
	`D
("[ %s: cªnÙ o³Àbulk-šƒp:ƒ¼no=%d ]\n", 
USB_FFS_ADB_IN
, 
”ºo
);

295 
”r
;

300 
”r
:

301 ià(
h
->
bulk_š
 > 0) {

302 
	`adb_şo£
(
h
->
bulk_š
);

303 
h
->
bulk_š
 = -1;

305 ià(
h
->
bulk_out
 > 0) {

306 
	`adb_şo£
(
h
->
bulk_out
);

307 
h
->
bulk_out
 = -1;

309 ià(
h
->
cÚŒŞ
 > 0) {

310 
	`adb_şo£
(
h
->
cÚŒŞ
);

311 
h
->
cÚŒŞ
 = -1;

314 
	}
}

316 *
	$usb_ffs_İ’_th»ad
(*
x
)

318 
usb_hªdË
 *
usb
 = (usb_hªdË *)
x
;

322 
	`adb_mu‹x_lock
(&
usb
->
lock
);

323 
usb
->
cÚŒŞ
 != -1)

324 
	`adb_cÚd_wa™
(&
usb
->
nÙify
, &usb->
lock
);

325 
	`adb_mu‹x_uÆock
(&
usb
->
lock
);

328 
	`š™_funùiÚfs
(
usb
);

330 ià(
usb
->
cÚŒŞ
 >= 0)

333 
	`adb_¦“p_ms
(1000);

336 
	`D
("[ usb_thread -„egistering device ]\n");

337 
	`»gi¡”_usb_Œª¥Üt
(
usb
, 0, 0, 1);

342 
	}
}

344 
	$bulk_wr™e
(
bulk_š
, cÚ¡ *
buf
, 
size_t
 
Ëngth
)

346 
size_t
 
couÁ
 = 0;

347 
»t
;

350 
»t
 = 
	`adb_wr™e
(
bulk_š
, 
buf
 + 
couÁ
, 
Ëngth
 - count);

351 ià(
»t
 < 0) {

352 ià(
”ºo
 !ğ
EINTR
)

353  
»t
;

355 
couÁ
 +ğ
»t
;

357 } 
couÁ
 < 
Ëngth
);

359 
	`D
("[ bulk_wr™dÚfd=%d ]\n", 
bulk_š
);

360  
couÁ
;

361 
	}
}

363 
	$usb_ffs_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

365 
n
;

367 
	`D
("abouˆtØwr™(fd=%d,†’=%d)\n", 
h
->
bulk_š
, 
Ën
);

368 
n
 = 
	`bulk_wr™e
(
h
->
bulk_š
, 
d©a
, 
Ën
);

369 ià(
n
 !ğ
Ën
) {

370 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

371 
h
->
bulk_š
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

374 
	`D
("[ dÚfd=%d ]\n", 
h
->
bulk_š
);

376 
	}
}

378 
	$bulk_»ad
(
bulk_out
, *
buf
, 
size_t
 
Ëngth
)

380 
size_t
 
couÁ
 = 0;

381 
»t
;

384 
»t
 = 
	`adb_»ad
(
bulk_out
, 
buf
 + 
couÁ
, 
Ëngth
 - count);

385 ià(
»t
 < 0) {

386 ià(
”ºo
 !ğ
EINTR
) {

387 
	`D
("[ bulk_read failed fd=%d†ength=%d count=%d ]\n",

388 
bulk_out
, 
Ëngth
, 
couÁ
);

389  
»t
;

392 
couÁ
 +ğ
»t
;

394 } 
couÁ
 < 
Ëngth
);

396  
couÁ
;

397 
	}
}

399 
	$usb_ffs_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

401 
n
;

403 
	`D
("abouˆtØ»ad (fd=%d,†’=%d)\n", 
h
->
bulk_out
, 
Ën
);

404 
n
 = 
	`bulk_»ad
(
h
->
bulk_out
, 
d©a
, 
Ën
);

405 ià(
n
 !ğ
Ën
) {

406 
	`D
("ERROR: fd = %d,‚ = %d,ƒrrno = %d (%s)\n",

407 
h
->
bulk_out
, 
n
, 
”ºo
, 
	`¡»¼Ü
(errno));

410 
	`D
("[ dÚfd=%d ]\n", 
h
->
bulk_out
);

412 
	}
}

414 
	$usb_ffs_kick
(
usb_hªdË
 *
h
)

416 
”r
;

418 
”r
 = 
	`ioùl
(
h
->
bulk_š
, 
FUNCTIONFS_CLEAR_HALT
);

419 ià(
”r
 < 0)

420 
	`D
("[ kick: sourû (fd=%dèş—¸h®ˆçed (%dè]", 
h
->
bulk_š
, 
”ºo
);

422 
”r
 = 
	`ioùl
(
h
->
bulk_out
, 
FUNCTIONFS_CLEAR_HALT
);

423 ià(
”r
 < 0)

424 
	`D
("[ kick: sšk (fd=%dèş—¸h®ˆçed (%dè]", 
h
->
bulk_out
, 
”ºo
);

426 
	`adb_mu‹x_lock
(&
h
->
lock
);

427 
	`adb_şo£
(
h
->
cÚŒŞ
);

428 
	`adb_şo£
(
h
->
bulk_out
);

429 
	`adb_şo£
(
h
->
bulk_š
);

430 
h
->
cÚŒŞ
 = h->
bulk_out
 = h->
bulk_š
 = -1;

433 
	`adb_cÚd_sigÇl
(&
h
->
nÙify
);

434 
	`adb_mu‹x_uÆock
(&
h
->
lock
);

435 
	}
}

437 
	$usb_ffs_š™
()

439 
usb_hªdË
 *
h
;

440 
adb_th»ad_t
 
tid
;

442 
	`D
("[ usb_init - using FunctionFS ]\n");

444 
h
 = 
	`ÿÎoc
(1, (
usb_hªdË
));

446 
h
->
wr™e
 = 
usb_ffs_wr™e
;

447 
h
->
»ad
 = 
usb_ffs_»ad
;

448 
h
->
kick
 = 
usb_ffs_kick
;

450 
h
->
cÚŒŞ
 = -1;

451 
h
->
bulk_out
 = -1;

452 
h
->
bulk_out
 = -1;

454 
	`adb_cÚd_š™
(&
h
->
nÙify
, 0);

455 
	`adb_mu‹x_š™
(&
h
->
lock
, 0);

457 
	`D
("[ usb_init - startinghread ]\n");

458 ià(
	`adb_th»ad_ü—‹
(&
tid
, 
usb_ffs_İ’_th»ad
, 
h
)){

459 
	`çl_”ºo
("[ cannot create usbhread ]\n");

461 
	}
}

463 
	$usb_š™
()

465 ià(
	`acûss
(
USB_FFS_ADB_EP0
, 
F_OK
) == 0)

466 
	`usb_ffs_š™
();

468 
	`usb_adb_š™
();

469 
	}
}

471 
	$usb_ş—nup
()

473 
	}
}

475 
	$usb_wr™e
(
usb_hªdË
 *
h
, cÚ¡ *
d©a
, 
Ën
)

477  
h
->
	`wr™e
(h, 
d©a
, 
Ën
);

478 
	}
}

480 
	$usb_»ad
(
usb_hªdË
 *
h
, *
d©a
, 
Ën
)

482  
h
->
	`»ad
(h, 
d©a
, 
Ën
);

483 
	}
}

484 
	$usb_şo£
(
usb_hªdË
 *
h
)

487 
	}
}

489 
	$usb_kick
(
usb_hªdË
 *
h
)

491 
h
->
	`kick
(h);

492 
	}
}

	@usb_osx.c

17 
	~<CÜeFound©iÚ/CÜeFound©iÚ.h
>

19 
	~<IOK™/IOK™Lib.h
>

20 
	~<IOK™/IOCFPlugIn.h
>

21 
	~<IOK™/usb/IOUSBLib.h
>

22 
	~<IOK™/IOMes§ge.h
>

23 
	~<mach/mach_pÜt.h
>

25 
	~"sysd•s.h
"

27 
	~<¡dio.h
>

29 
	#TRACE_TAG
 
TRACE_USB


	)

30 
	~"adb.h
"

31 
	~"usb_v’dÜs.h
"

33 
	#DBG
 
D


	)

35 
IONÙifiÿtiÚPÜtRef
 
	gnÙifiÿtiÚPÜt
 = 0;

36 
io_™”©Ü_t
* 
	gnÙifiÿtiÚI‹¿tÜs
;

38 
	susb_hªdË


40 
UIÁ8
 
	mbulkIn
;

41 
UIÁ8
 
	mbulkOut
;

42 
IOUSBIÁ”çûIÁ”çû
 **
	mš‹rçû
;

43 
io_objeù_t
 
	musbNÙifiÿtiÚ
;

44 
	mz”o_mask
;

47 
CFRunLoİRef
 
	gcu¼’tRunLoİ
 = 0;

48 
±h»ad_mu‹x_t
 
	g¡¬t_lock
;

49 
±h»ad_cÚd_t
 
	g¡¬t_cÚd
;

52 
AndroidIÁ”çûAdded
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
);

53 
AndroidIÁ”çûNÙify
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
,

54 
Çtu¿l_t
 
mes§geTy³
,

55 *
mes§geArgum’t
);

56 
usb_hªdË
* 
CheckIÁ”çû
(
IOUSBIÁ”çûIÁ”çû
 **
içû
,

57 
UIÁ16
 
v’dÜ
, UIÁ16 
´oduù
);

60 
	$In™USB
()

62 
CFMubËDiùiÚ¬yRef
 
m©chšgDiù
;

63 
CFRunLoİSourûRef
 
runLoİSourû
;

64 
SIÁ32
 
v’dÜ
, 
if_subşass
, 
if_´ÙocŞ
;

65 
i
;

69 
nÙifiÿtiÚPÜt
 = 
	`IONÙifiÿtiÚPÜtC»©e
(
kIOMa¡”PÜtDeçuÉ
);

70 
runLoİSourû
 = 
	`IONÙifiÿtiÚPÜtG‘RunLoİSourû
(
nÙifiÿtiÚPÜt
);

71 
	`CFRunLoİAddSourû
(
	`CFRunLoİG‘Cu¼’t
(), 
runLoİSourû
, 
kCFRunLoİDeçuÉMode
);

73 
	`mem£t
(
nÙifiÿtiÚI‹¿tÜs
, 0, (notificationIterators));

76 
i
 = 0; i < 
v’dÜIdCouÁ
; i++) {

81 
m©chšgDiù
 = 
	`IOS”viûM©chšg
(
kIOUSBIÁ”çûCÏssName
);

83 ià(!
m©chšgDiù
) {

84 
	`DBG
("ERR: Couldn't create USB matching dictionary.\n");

89 
v’dÜ
 = 
v’dÜIds
[
i
];

90 
if_subşass
 = 
ADB_SUBCLASS
;

91 
if_´ÙocŞ
 = 
ADB_PROTOCOL
;

92 
	`CFDiùiÚ¬yS‘V®ue
(
m©chšgDiù
, 
	`CFSTR
(
kUSBV’dÜID
),

93 
	`CFNumb”C»©e
(
kCFAÎoÿtÜDeçuÉ
,

94 
kCFNumb”SIÁ32Ty³
, &
v’dÜ
));

95 
	`CFDiùiÚ¬yS‘V®ue
(
m©chšgDiù
, 
	`CFSTR
(
kUSBIÁ”çûSubCÏss
),

96 
	`CFNumb”C»©e
(
kCFAÎoÿtÜDeçuÉ
,

97 
kCFNumb”SIÁ32Ty³
, &
if_subşass
));

98 
	`CFDiùiÚ¬yS‘V®ue
(
m©chšgDiù
, 
	`CFSTR
(
kUSBIÁ”çûPrÙocŞ
),

99 
	`CFNumb”C»©e
(
kCFAÎoÿtÜDeçuÉ
,

100 
kCFNumb”SIÁ32Ty³
, &
if_´ÙocŞ
));

101 
	`IOS”viûAddM©chšgNÙifiÿtiÚ
(

102 
nÙifiÿtiÚPÜt
,

103 
kIOFœ¡M©chNÙifiÿtiÚ
,

104 
m©chšgDiù
,

105 
AndroidIÁ”çûAdded
,

106 
NULL
,

107 &
nÙifiÿtiÚI‹¿tÜs
[
i
]);

111 
	`AndroidIÁ”çûAdded
(
NULL
, 
nÙifiÿtiÚI‹¿tÜs
[
i
]);

115 
	}
}

118 
	$AndroidIÁ”çûAdded
(*
»fCÚ
, 
io_™”©Ü_t
 
™”©Ü
)

120 
k”n_»tuº_t
 
kr
;

121 
io_£rviû_t
 
usbDeviû
;

122 
io_£rviû_t
 
usbIÁ”çû
;

123 
IOCFPlugInIÁ”çû
 **
¶ugInIÁ”çû
 = 
NULL
;

124 
IOUSBIÁ”çûIÁ”çû220
 **
içû
 = 
NULL
;

125 
IOUSBDeviûIÁ”çû197
 **
dev
 = 
NULL
;

126 
HRESULT
 
»suÉ
;

127 
SIÁ32
 
scÜe
;

128 
UIÁ32
 
loÿtiÚId
;

129 
UIÁ16
 
v’dÜ
;

130 
UIÁ16
 
´oduù
;

131 
UIÁ8
 
£rŸlIndex
;

132 
£rŸl
[256];

133 
dev·thBuf
[64];

134 *
dev·th
 = 
NULL
;

136 (
usbIÁ”çû
 = 
	`IOI‹¿tÜNext
(
™”©Ü
))) {

138 
kr
 = 
	`IOC»©ePlugInIÁ”çûFÜS”viû
(
usbIÁ”çû
,

139 
kIOUSBIÁ”çûU£rCl›ÁTy³ID
,

140 
kIOCFPlugInIÁ”çûID
,

141 &
¶ugInIÁ”çû
, &
scÜe
);

142 
	`IOObjeùR–—£
(
usbIÁ”çû
);

143 ià((
kIOR‘uºSucûss
 !ğ
kr
è|| (!
¶ugInIÁ”çû
)) {

144 
	`DBG
("ERR: UÇbËØü—‹‡Àš‹rçû…lug-š (%08x)\n", 
kr
);

149 
»suÉ
 = (*
¶ugInIÁ”çû
)->
	`Qu”yIÁ”çû
(plugInInterface,

150 
	`CFUUIDG‘UUIDBy‹s
(
kIOUSBIÁ”çûIÁ”çûID
), (
LPVOID
)

151 &
içû
);

153 (*
¶ugInIÁ”çû
)->
	`R–—£
(plugInInterface);

154 ià(
»suÉ
 || !
içû
) {

155 
	`DBG
("ERR: Couldn'ˆqu”yhš‹rçû (%08x)\n", (è
»suÉ
);

163 
kr
 = (*
içû
)->
	`G‘Deviû
(içû, &
usbDeviû
);

164 ià(
kIOR‘uºSucûss
 !ğ
kr
 || !
usbDeviû
) {

165 
	`DBG
("ERR: Couldn'ˆg¿b deviû from iÁ”çû (%08x)\n", 
kr
);

169 
¶ugInIÁ”çû
 = 
NULL
;

170 
scÜe
 = 0;

172 
kr
 = 
	`IOC»©ePlugInIÁ”çûFÜS”viû
(
usbDeviû
,

173 
kIOUSBDeviûU£rCl›ÁTy³ID
,

174 
kIOCFPlugInIÁ”çûID
,

175 &
¶ugInIÁ”çû
, &
scÜe
);

177 ()
	`IOObjeùR–—£
(
usbDeviû
);

178 ià((
kIOR‘uºSucûss
 !ğ
kr
è|| (!
¶ugInIÁ”çû
)) {

179 
	`DBG
("ERR: UÇbËØü—‹‡ deviû…lug-š (%08x)\n", 
kr
);

183 
»suÉ
 = (*
¶ugInIÁ”çû
)->
	`Qu”yIÁ”çû
(plugInInterface,

184 
	`CFUUIDG‘UUIDBy‹s
(
kIOUSBDeviûIÁ”çûID
), (
LPVOID
è&
dev
);

186 (*
¶ugInIÁ”çû
)->
	`R–—£
(plugInInterface);

187 ià(
»suÉ
 || !
dev
) {

188 
	`DBG
("ERR: Couldn't create‡ device interface (%08x)\n",

189 (è
»suÉ
);

196 
kr
 = (*
dev
)->
	`G‘DeviûV’dÜ
(dev, &
v’dÜ
);

197 
kr
 = (*
dev
)->
	`G‘DeviûProduù
(dev, &
´oduù
);

198 
kr
 = (*
dev
)->
	`G‘LoÿtiÚID
(dev, &
loÿtiÚId
);

199 ià(
kr
 == 0) {

200 
	`¢´štf
(
dev·thBuf
, (dev·thBuf), "usb:%lX", 
loÿtiÚId
);

201 
dev·th
 = 
dev·thBuf
;

203 
kr
 = (*
dev
)->
	`USBG‘S”ŸlNumb”SŒšgIndex
(dev, &
£rŸlIndex
);

205 ià(
£rŸlIndex
 > 0) {

206 
IOUSBDevReque¡
 
»q
;

207 
UIÁ16
 
bufãr
[256];

208 
UIÁ16
 
Ïnguages
[128];

210 
	`mem£t
(
Ïnguages
, 0, (languages));

212 
»q
.
bmReque¡Ty³
 =

213 
	`USBmakebmReque¡Ty³
(
kUSBIn
, 
kUSBSnd¬d
, 
kUSBDeviû
);

214 
»q
.
bReque¡
 = 
kUSBRqG‘DesütÜ
;

215 
»q
.
wV®ue
 = (
kUSBSŒšgDesc
 << 8) | 0;

216 
»q
.
wIndex
 = 0;

217 
»q
.
pD©a
 = 
Ïnguages
;

218 
»q
.
wL’gth
 = (
Ïnguages
);

219 
kr
 = (*
dev
)->
	`DeviûReque¡
(dev, &
»q
);

221 ià(
kr
 =ğ
kIOR‘uºSucûss
 && 
»q
.
wL’DÚe
 > 0) {

223 
ÏngCouÁ
 = (
»q
.
wL’DÚe
 - 2è/ 2, 
Ïng
;

225 
Ïng
 = 1;†ªg <ğ
ÏngCouÁ
;†ang++) {

227 
	`mem£t
(
bufãr
, 0, (buffer));

228 
	`mem£t
(&
»q
, 0, (req));

230 
»q
.
bmReque¡Ty³
 =

231 
	`USBmakebmReque¡Ty³
(
kUSBIn
, 
kUSBSnd¬d
, 
kUSBDeviû
);

232 
»q
.
bReque¡
 = 
kUSBRqG‘DesütÜ
;

233 
»q
.
wV®ue
 = (
kUSBSŒšgDesc
 << 8è| 
£rŸlIndex
;

234 
»q
.
wIndex
 = 
Ïnguages
[
Ïng
];

235 
»q
.
pD©a
 = 
bufãr
;

236 
»q
.
wL’gth
 = (
bufãr
);

237 
kr
 = (*
dev
)->
	`DeviûReque¡
(dev, &
»q
);

239 ià(
kr
 =ğ
kIOR‘uºSucûss
 && 
»q
.
wL’DÚe
 > 0) {

240 
i
, 
couÁ
;

244 
couÁ
 = (
»q
.
wL’DÚe
 - 1) / 2;

245 
i
 = 0; i < 
couÁ
; i++)

246 
£rŸl
[
i
] = 
bufãr
[i + 1];

247 
£rŸl
[
i
] = 0;

253 (*
dev
)->
	`R–—£
(dev);

255 
	`DBG
("INFO: Found vid=%04x…id=%04x s”Ÿl=%s\n", 
v’dÜ
, 
´oduù
,

256 
£rŸl
);

258 
usb_hªdË
* 
hªdË
 = 
	`CheckIÁ”çû
((
IOUSBIÁ”çûIÁ”çû
**)
içû
,

259 
v’dÜ
, 
´oduù
);

260 ià(
hªdË
 =ğ
NULL
) {

261 
	`DBG
("ERR: Could‚Ù fšd deviû iÁ”çû: %08x\n", 
kr
);

262 (*
içû
)->
	`R–—£
(iface);

266 
	`DBG
("AndroidDeviceAdded calling„egister_usb_transport\n");

267 
	`»gi¡”_usb_Œª¥Üt
(
hªdË
, (
£rŸl
[0] ? s”ŸÈ: 
NULL
), 
dev·th
, 1);

272 
kr
 = 
	`IOS”viûAddIÁ”e¡NÙifiÿtiÚ
(
nÙifiÿtiÚPÜt
,

273 
usbIÁ”çû
,

274 
kIOG’”®IÁ”e¡
,

275 
AndroidIÁ”çûNÙify
,

276 
hªdË
,

277 &
hªdË
->
usbNÙifiÿtiÚ
);

279 ià(
kIOR‘uºSucûss
 !ğ
kr
) {

280 
	`DBG
("ERR: UÇbËØü—‹ iÁ”e¡‚ÙifiÿtiÚ (%08x)\n", 
kr
);

283 
	}
}

286 
	$AndroidIÁ”çûNÙify
(*
»fCÚ
, 
io_£rviû_t
 
£rviû
, 
Çtu¿l_t
 
mes§geTy³
, *
mes§geArgum’t
)

288 
usb_hªdË
 *
hªdË
 = (usb_hªdË *)
»fCÚ
;

290 ià(
mes§geTy³
 =ğ
kIOMes§geS”viûIsT”mš©ed
) {

291 ià(!
hªdË
) {

292 
	`DBG
("ERR: NULL handle\n");

295 
	`DBG
("AndroidInterfaceNotify\n");

296 
	`IOObjeùR–—£
(
hªdË
->
usbNÙifiÿtiÚ
);

297 
	`usb_kick
(
hªdË
);

299 
	}
}

303 
usb_hªdË
*

304 
	$CheckIÁ”çû
(
IOUSBIÁ”çûIÁ”çû
 **
š‹rçû
, 
UIÁ16
 
v’dÜ
, UIÁ16 
´oduù
)

306 
usb_hªdË
* 
hªdË
 = 
NULL
;

307 
IOR‘uº
 
kr
;

308 
UIÁ8
 
š‹rçûNumEndpošts
, 
š‹rçûCÏss
, 
š‹rçûSubCÏss
, 
š‹rçûPrÙocŞ
;

309 
UIÁ8
 
’dpošt
;

314 
kr
 = (*
š‹rçû
)->
	`USBIÁ”çûO³n
(interface);

315 ià(
kr
 !ğ
kIOR‘uºSucûss
) {

316 
	`DBG
("ERR: Could‚Ù o³Àš‹rçû: (%08x)\n", 
kr
);

317  
NULL
;

321 
kr
 = (*
š‹rçû
)->
	`G‘NumEndpošts
(š‹rçû, &
š‹rçûNumEndpošts
);

322 ià(
kr
 !ğ
kIOR‘uºSucûss
) {

323 
	`DBG
("ERR: UÇbËØg‘‚umb” oà’dpošts: (%08x)\n", 
kr
);

324 
”r_g‘_num_•
;

328 ià((*
š‹rçû
)->
	`G‘IÁ”çûCÏss
(š‹rçû, &
š‹rçûCÏss
è!ğ
kIOR‘uºSucûss
 ||

329 (*
š‹rçû
)->
	`G‘IÁ”çûSubCÏss
(š‹rçû, &
š‹rçûSubCÏss
è!ğ
kIOR‘uºSucûss
 ||

330 (*
š‹rçû
)->
	`G‘IÁ”çûPrÙocŞ
(š‹rçû, &
š‹rçûPrÙocŞ
è!ğ
kIOR‘uºSucûss
) {

331 
	`DBG
("ERR: Unableo get interface class, subclass‡nd…rotocol\n");

332 
”r_g‘_š‹rçû_şass
;

337 ià(!
	`is_adb_š‹rçû
(
v’dÜ
, 
´oduù
, 
š‹rçûCÏss
,

338 
š‹rçûSubCÏss
, 
š‹rçûPrÙocŞ
))

339 
”r_bad_adb_š‹rçû
;

341 
hªdË
 = 
	`ÿÎoc
(1, (
usb_hªdË
));

345 
’dpošt
 = 0;ƒndpošˆ<ğ
š‹rçûNumEndpošts
;ƒndpoint++) {

346 
UIÁ8
 
ŒªsãrTy³
;

347 
UIÁ16
 
maxPack‘Size
;

348 
UIÁ8
 
š‹rv®
;

349 
UIÁ8
 
numb”
;

350 
UIÁ8
 
dœeùiÚ
;

352 
kr
 = (*
š‹rçû
)->
	`G‘PePrİ”t›s
(š‹rçû, 
’dpošt
, &
dœeùiÚ
,

353 &
numb”
, &
ŒªsãrTy³
, &
maxPack‘Size
, &
š‹rv®
);

355 ià(
kIOR‘uºSucûss
 =ğ
kr
) {

356 ià(
kUSBBulk
 !ğ
ŒªsãrTy³
)

359 ià(
kUSBIn
 =ğ
dœeùiÚ
)

360 
hªdË
->
bulkIn
 = 
’dpošt
;

362 ià(
kUSBOut
 =ğ
dœeùiÚ
)

363 
hªdË
->
bulkOut
 = 
’dpošt
;

365 
hªdË
->
z”o_mask
 = 
maxPack‘Size
 - 1;

367 
	`DBG
("ERR: FindDeviceInterface - could‚ot get…ipe…roperties\n");

368 
”r_g‘_pe_´İs
;

372 
hªdË
->
š‹rçû
 = interface;

373  
hªdË
;

375 
”r_g‘_pe_´İs
:

376 
	`ä“
(
hªdË
);

377 
”r_bad_adb_š‹rçû
:

378 
”r_g‘_š‹rçû_şass
:

379 
”r_g‘_num_•
:

380 (*
š‹rçû
)->
	`USBIÁ”çûClo£
(interface);

381  
NULL
;

382 
	}
}

385 * 
	$RunLoİTh»ad
(* 
unu£d
)

387 
i
;

389 
	`In™USB
();

391 
cu¼’tRunLoİ
 = 
	`CFRunLoİG‘Cu¼’t
();

394 
	`adb_mu‹x_lock
(&
¡¬t_lock
);

395 
	`adb_cÚd_sigÇl
(&
¡¬t_cÚd
);

396 
	`adb_mu‹x_uÆock
(&
¡¬t_lock
);

398 
	`CFRunLoİRun
();

399 
cu¼’tRunLoİ
 = 0;

401 
i
 = 0; i < 
v’dÜIdCouÁ
; i++) {

402 
	`IOObjeùR–—£
(
nÙifiÿtiÚI‹¿tÜs
[
i
]);

404 
	`IONÙifiÿtiÚPÜtDe¡roy
(
nÙifiÿtiÚPÜt
);

406 
	`DBG
("RunLoopThread done\n");

407  
NULL
;

408 
	}
}

411 
	gš™Ÿlized
 = 0;

412 
	$usb_š™
()

414 ià(!
š™Ÿlized
)

416 
adb_th»ad_t
 
tid
;

418 
nÙifiÿtiÚI‹¿tÜs
 = (
io_™”©Ü_t
*)
	`m®loc
(

419 
v’dÜIdCouÁ
 * (
io_™”©Ü_t
));

421 
	`adb_mu‹x_š™
(&
¡¬t_lock
, 
NULL
);

422 
	`adb_cÚd_š™
(&
¡¬t_cÚd
, 
NULL
);

424 if(
	`adb_th»ad_ü—‹
(&
tid
, 
RunLoİTh»ad
, 
NULL
))

425 
	`çl_”ºo
("cannot create inputhread");

428 
	`adb_mu‹x_lock
(&
¡¬t_lock
);

429 
	`adb_cÚd_wa™
(&
¡¬t_cÚd
, &
¡¬t_lock
);

430 
	`adb_mu‹x_uÆock
(&
¡¬t_lock
);

432 
	`adb_mu‹x_de¡roy
(&
¡¬t_lock
);

433 
	`adb_cÚd_de¡roy
(&
¡¬t_cÚd
);

435 
š™Ÿlized
 = 1;

437 
	}
}

439 
	$usb_ş—nup
()

441 
	`DBG
("usb_cleanup\n");

442 
	`şo£_usb_deviûs
();

443 ià(
cu¼’tRunLoİ
)

444 
	`CFRunLoİStİ
(
cu¼’tRunLoİ
);

446 ià(
nÙifiÿtiÚI‹¿tÜs
 !ğ
NULL
) {

447 
	`ä“
(
nÙifiÿtiÚI‹¿tÜs
);

448 
nÙifiÿtiÚI‹¿tÜs
 = 
NULL
;

450 
	}
}

452 
	$usb_wr™e
(
usb_hªdË
 *
hªdË
, cÚ¡ *
buf
, 
Ën
)

454 
IOR‘uº
 
»suÉ
;

456 ià(!
Ën
)

459 ià(!
hªdË
)

462 ià(
NULL
 =ğ
hªdË
->
š‹rçû
) {

463 
	`DBG
("ERR: usb_write interface was‚ull\n");

467 ià(0 =ğ
hªdË
->
bulkOut
) {

468 
	`DBG
("ERR: bulkOutƒndpoint‚ot‡ssigned\n");

472 
»suÉ
 =

473 (*
hªdË
->
š‹rçû
)->
	`Wr™ePe
(

474 
hªdË
->
š‹rçû
, hªdË->
bulkOut
, (*)
buf
, 
Ën
);

476 ià((
»suÉ
 =ğ0è&& (
hªdË
->
z”o_mask
)) {

478 if(!(
Ën
 & 
hªdË
->
z”o_mask
)) {

479 
»suÉ
 =

480 (*
hªdË
->
š‹rçû
)->
	`Wr™ePe
(

481 
hªdË
->
š‹rçû
, hªdË->
bulkOut
, (*)
buf
, 0);

485 ià(0 =ğ
»suÉ
)

488 
	`DBG
("ERR: usb_wr™çed w™h stu %d\n", 
»suÉ
);

490 
	}
}

492 
	$usb_»ad
(
usb_hªdË
 *
hªdË
, *
buf
, 
Ën
)

494 
IOR‘uº
 
»suÉ
;

495 
UIÁ32
 
numBy‹s
 = 
Ën
;

497 ià(!
Ën
) {

501 ià(!
hªdË
) {

505 ià(
NULL
 =ğ
hªdË
->
š‹rçû
) {

506 
	`DBG
("ERR: usb_read interface was‚ull\n");

510 ià(0 =ğ
hªdË
->
bulkIn
) {

511 
	`DBG
("ERR: bulkInƒndpoint‚ot‡ssigned\n");

515 
»suÉ
 =

516 (*
hªdË
->
š‹rçû
)->
	`R—dPe
(handle->interface,

517 
hªdË
->
bulkIn
, 
buf
, &
numBy‹s
);

519 ià(0 =ğ
»suÉ
)

522 
	`DBG
("ERR: usb_»ad faed w™h stu %d\n", 
»suÉ
);

526 
	}
}

528 
	$usb_şo£
(
usb_hªdË
 *
hªdË
)

531 
	}
}

533 
	$usb_kick
(
usb_hªdË
 *
hªdË
)

536 ià(!
hªdË
)

539 ià(
hªdË
->
š‹rçû
)

541 (*
hªdË
->
š‹rçû
)->
	`USBIÁ”çûClo£
(handle->interface);

542 (*
hªdË
->
š‹rçû
)->
	`R–—£
(handle->interface);

543 
hªdË
->
š‹rçû
 = 0;

545 
	}
}

	@usb_vendors.c

17 
	~"usb_v’dÜs.h
"

19 
	~<¡dio.h
>

21 #ifdeà
_WIN32


22 
	#WIN32_LEAN_AND_MEAN


	)

23 
	~"wšdows.h
"

24 
	~"shlobj.h
"

26 
	~<uni¡d.h
>

27 
	~<sys/¡©.h
>

30 
	~"sysd•s.h
"

31 
	~"adb.h
"

33 
	#ANDROID_PATH
 ".ªdroid"

	)

34 
	#ANDROID_ADB_INI
 "adb_usb.ši"

	)

36 
	#TRACE_TAG
 
TRACE_USB


	)

39 
	#VENDOR_ID_GOOGLE
 0x18d1

	)

41 
	#VENDOR_ID_INTEL
 0x8087

	)

43 
	#VENDOR_ID_HTC
 0x0bb4

	)

45 
	#VENDOR_ID_SAMSUNG
 0x04e8

	)

47 
	#VENDOR_ID_MOTOROLA
 0x22b8

	)

49 
	#VENDOR_ID_LGE
 0x1004

	)

51 
	#VENDOR_ID_HUAWEI
 0x12D1

	)

53 
	#VENDOR_ID_ACER
 0x0502

	)

55 
	#VENDOR_ID_SONY_ERICSSON
 0x0FCE

	)

57 
	#VENDOR_ID_FOXCONN
 0x0489

	)

59 
	#VENDOR_ID_DELL
 0x413c

	)

61 
	#VENDOR_ID_NVIDIA
 0x0955

	)

63 
	#VENDOR_ID_GARMIN_ASUS
 0x091E

	)

65 
	#VENDOR_ID_SHARP
 0x04dd

	)

67 
	#VENDOR_ID_ZTE
 0x19D2

	)

69 
	#VENDOR_ID_KYOCERA
 0x0482

	)

71 
	#VENDOR_ID_PANTECH
 0x10A9

	)

73 
	#VENDOR_ID_QUALCOMM
 0x05c6

	)

75 
	#VENDOR_ID_OTGV
 0x2257

	)

77 
	#VENDOR_ID_NEC
 0x0409

	)

79 
	#VENDOR_ID_PMC
 0x04DA

	)

81 
	#VENDOR_ID_TOSHIBA
 0x0930

	)

83 
	#VENDOR_ID_SK_TELESYS
 0x1F53

	)

85 
	#VENDOR_ID_KT_TECH
 0x2116

	)

87 
	#VENDOR_ID_ASUS
 0x0b05

	)

89 
	#VENDOR_ID_PHILIPS
 0x0471

	)

91 
	#VENDOR_ID_TI
 0x0451

	)

93 
	#VENDOR_ID_FUNAI
 0x0F1C

	)

95 
	#VENDOR_ID_GIGABYTE
 0x0414

	)

97 
	#VENDOR_ID_IRIVER
 0x2420

	)

99 
	#VENDOR_ID_COMPAL
 0x1219

	)

101 
	#VENDOR_ID_T_AND_A
 0x1BBB

	)

103 
	#VENDOR_ID_LENOVOMOBILE
 0x2006

	)

105 
	#VENDOR_ID_LENOVO
 0x17EF

	)

107 
	#VENDOR_ID_VIZIO
 0xE040

	)

109 
	#VENDOR_ID_K_TOUCH
 0x24E3

	)

111 
	#VENDOR_ID_PEGATRON
 0x1D4D

	)

113 
	#VENDOR_ID_ARCHOS
 0x0E79

	)

115 
	#VENDOR_ID_POSITIVO
 0x1662

	)

117 
	#VENDOR_ID_FUJITSU
 0x04C5

	)

119 
	#VENDOR_ID_LUMIGON
 0x25E3

	)

121 
	#VENDOR_ID_QUANTA
 0x0408

	)

123 
	#VENDOR_ID_INQ_MOBILE
 0x2314

	)

125 
	#VENDOR_ID_SONY
 0x054C

	)

127 
	#VENDOR_ID_LAB126
 0x1949

	)

129 
	#VENDOR_ID_YULONG_COOLPAD
 0x1EBF

	)

131 
	#VENDOR_ID_KOBO
 0x2237

	)

133 
	#VENDOR_ID_TELEEPOCH
 0x2340

	)

137 
	gbutInV’dÜIds
[] = {

138 
VENDOR_ID_GOOGLE
,

139 
VENDOR_ID_INTEL
,

140 
VENDOR_ID_HTC
,

141 
VENDOR_ID_SAMSUNG
,

142 
VENDOR_ID_MOTOROLA
,

143 
VENDOR_ID_LGE
,

144 
VENDOR_ID_HUAWEI
,

145 
VENDOR_ID_ACER
,

146 
VENDOR_ID_SONY_ERICSSON
,

147 
VENDOR_ID_FOXCONN
,

148 
VENDOR_ID_DELL
,

149 
VENDOR_ID_NVIDIA
,

150 
VENDOR_ID_GARMIN_ASUS
,

151 
VENDOR_ID_SHARP
,

152 
VENDOR_ID_ZTE
,

153 
VENDOR_ID_KYOCERA
,

154 
VENDOR_ID_PANTECH
,

155 
VENDOR_ID_QUALCOMM
,

156 
VENDOR_ID_OTGV
,

157 
VENDOR_ID_NEC
,

158 
VENDOR_ID_PMC
,

159 
VENDOR_ID_TOSHIBA
,

160 
VENDOR_ID_SK_TELESYS
,

161 
VENDOR_ID_KT_TECH
,

162 
VENDOR_ID_ASUS
,

163 
VENDOR_ID_PHILIPS
,

164 
VENDOR_ID_TI
,

165 
VENDOR_ID_FUNAI
,

166 
VENDOR_ID_GIGABYTE
,

167 
VENDOR_ID_IRIVER
,

168 
VENDOR_ID_COMPAL
,

169 
VENDOR_ID_T_AND_A
,

170 
VENDOR_ID_LENOVOMOBILE
,

171 
VENDOR_ID_LENOVO
,

172 
VENDOR_ID_VIZIO
,

173 
VENDOR_ID_K_TOUCH
,

174 
VENDOR_ID_PEGATRON
,

175 
VENDOR_ID_ARCHOS
,

176 
VENDOR_ID_POSITIVO
,

177 
VENDOR_ID_FUJITSU
,

178 
VENDOR_ID_LUMIGON
,

179 
VENDOR_ID_QUANTA
,

180 
VENDOR_ID_INQ_MOBILE
,

181 
VENDOR_ID_SONY
,

182 
VENDOR_ID_LAB126
,

183 
VENDOR_ID_YULONG_COOLPAD
,

184 
VENDOR_ID_KOBO
,

185 
VENDOR_ID_TELEEPOCH
,

188 
	#BUILT_IN_VENDOR_COUNT
 ((
butInV’dÜIds
)/(butInV’dÜIds[0]))

	)

191 
	#VENDOR_COUNT_MAX
 128

	)

193 
	gv’dÜIds
[
VENDOR_COUNT_MAX
];

194 
	gv’dÜIdCouÁ
 = 0;

196 
g‘_adb_usb_ši
(* 
buff
, 
size_t
 
Ën
);

198 
	$usb_v’dÜs_š™
()

200 ià(
VENDOR_COUNT_MAX
 < 
BUILT_IN_VENDOR_COUNT
) {

201 
	`årštf
(
¡d”r
, "VENDOR_COUNT_MAX‚ot bigƒnough for built-in vendor†ist.\n");

202 
	`ex™
(2);

206 
	`memıy
(
v’dÜIds
, 
butInV’dÜIds
, (builtInVendorIds));

209 
v’dÜIdCouÁ
 = 
BUILT_IN_VENDOR_COUNT
;

211 ià(
VENDOR_COUNT_MAX
 =ğ
BUILT_IN_VENDOR_COUNT
)

214 
‹mp
[
PATH_MAX
];

215 ià(
	`g‘_adb_usb_ši
(
‹mp
, (temp)) == 0) {

216 
FILE
 * 
f
 = 
	`fİ’
(
‹mp
, "rt");

218 ià(
f
 !ğ
NULL
) {

221 
	`fg‘s
(
‹mp
, Ñemp), 
f
è!ğ
NULL
) {

222 ià(
‹mp
[0] == '#')

225 
v®ue
 = 
	`¡¹Ş
(
‹mp
, 
NULL
, 0);

226 ià(
”ºo
 =ğ
EINVAL
 ||ƒ¼nØ=ğ
ERANGE
 || 
v®ue
 > 
INT_MAX
 || value < 0) {

227 
	`årštf
(
¡d”r
, "Inv®id cÚ‹Á iÀ%s. Qu™tšg.\n", 
ANDROID_ADB_INI
);

228 
	`ex™
(2);

231 
v’dÜIds
[
v’dÜIdCouÁ
++] = ()
v®ue
;

234 ià(
v’dÜIdCouÁ
 =ğ
VENDOR_COUNT_MAX
) {

240 
	}
}

245 
	$bud_·th
(* 
buff
, 
size_t
 
Ën
, cÚ¡ * 
fÜm©
, cÚ¡ * 
home
)

247 ià(
	`¢´štf
(
buff
, 
Ën
, 
fÜm©
, 
home
, 
ANDROID_PATH
, 
ANDROID_ADB_INI
) >= (signed)len) {

252 
	}
}

255 
	$g‘_adb_usb_ši
(* 
buff
, 
size_t
 
Ën
)

257 #ifdeà
_WIN32


258 cÚ¡ * 
home
 = 
	`g‘’v
("ANDROID_SDK_HOME");

259 ià(
home
 !ğ
NULL
) {

260  
	`bud_·th
(
buff
, 
Ën
, "%s\\%s\\%s", 
home
);

262 
·th
[
MAX_PATH
];

263 
	`SHG‘FŞd”P©h
Ğ
NULL
, 
CSIDL_PROFILE
, NULL, 0, 
·th
);

264  
	`bud_·th
(
buff
, 
Ën
, "%s\\%s\\%s", 
·th
);

267 cÚ¡ * 
home
 = 
	`g‘’v
("HOME");

268 ià(
home
 =ğ
NULL
)

269 
home
 = "/tmp";

271  
	`bud_·th
(
buff
, 
Ën
, "%s/%s/%s", 
home
);

273 
	}
}

	@usb_vendors.h

17 #iâdeà
__USB_VENDORS_H


18 
	#__USB_VENDORS_H


	)

20 
v’dÜIds
[];

21 
v’dÜIdCouÁ
;

23 
usb_v’dÜs_š™
();

	@usb_windows.c

17 
	~<wšdows.h
>

18 
	~<wš”rÜ.h
>

19 
	~<”ºo.h
>

20 
	~<usb100.h
>

21 
	~<adb_­i.h
>

22 
	~<¡dio.h
>

24 
	~"sysd•s.h
"

26 
	#TRACE_TAG
 
TRACE_USB


	)

27 
	~"adb.h
"

33 
	susb_hªdË
 {

35 
usb_hªdË
 *
	m´ev
;

38 
usb_hªdË
 *
	mÃxt
;

41 
ADBAPIHANDLE
 
	madb_š‹rçû
;

44 
ADBAPIHANDLE
 
	madb_»ad_pe
;

47 
ADBAPIHANDLE
 
	madb_wr™e_pe
;

50 * 
	mš‹rçû_Çme
;

53 
	mz”o_mask
;

57 cÚ¡ 
GUID
 
	gusb_şass_id
 = 
ANDROID_USB_CLASS_ID
;

60 
usb_hªdË
 
	ghªdË_li¡
 = {

61 .
´ev
 = &
hªdË_li¡
,

62 .
	gÃxt
 = &
hªdË_li¡
,

66 
ADB_MUTEX_DEFINE
Ğ
usb_lock
 );

69 
known_deviû
(cÚ¡ * 
dev_Çme
);

73 
known_deviû_locked
(cÚ¡ * 
dev_Çme
);

76 
»gi¡”_Ãw_deviû
(
usb_hªdË
* 
hªdË
);

79 
»cognized_deviû
(
usb_hªdË
* 
hªdË
);

83 
fšd_deviûs
();

87 * 
deviû_pŞl_th»ad
(* 
unu£d
);

90 
usb_š™
();

93 
usb_ş—nup
();

96 
usb_hªdË
* 
do_usb_İ’
(cÚ¡ 
wch¬_t
* 
š‹rçû_Çme
);

99 
usb_wr™e
(
usb_hªdË
* 
hªdË
, cÚ¡ * 
d©a
, 
Ën
);

102 
usb_»ad
(
usb_hªdË
 *
hªdË
, * 
d©a
, 
Ën
);

105 
usb_ş—nup_hªdË
(
usb_hªdË
* 
hªdË
);

108 
usb_kick
(
usb_hªdË
* 
hªdË
);

111 
usb_şo£
(
usb_hªdË
* 
hªdË
);

114 cÚ¡ *
usb_Çme
(
usb_hªdË
* 
hªdË
);

116 
	$known_deviû_locked
(cÚ¡ * 
dev_Çme
) {

117 
usb_hªdË
* 
usb
;

119 ià(
NULL
 !ğ
dev_Çme
) {

121 
usb
 = 
hªdË_li¡
.
Ãxt
; usb != &handle_list; usb = usb->next) {

123 if((
NULL
 !ğ
usb
->
š‹rçû_Çme
) &&

124 (0 =ğ
	`¡ricmp
(
usb
->
š‹rçû_Çme
, 
dev_Çme
))) {

131 
	}
}

133 
	$known_deviû
(cÚ¡ * 
dev_Çme
) {

134 
»t
 = 0;

136 ià(
NULL
 !ğ
dev_Çme
) {

137 
	`adb_mu‹x_lock
(&
usb_lock
);

138 
»t
 = 
	`known_deviû_locked
(
dev_Çme
);

139 
	`adb_mu‹x_uÆock
(&
usb_lock
);

142  
»t
;

143 
	}
}

145 
	$»gi¡”_Ãw_deviû
(
usb_hªdË
* 
hªdË
) {

146 ià(
NULL
 =ğ
hªdË
)

149 
	`adb_mu‹x_lock
(&
usb_lock
);

152 ià(
	`known_deviû_locked
(
hªdË
->
š‹rçû_Çme
)) {

153 
	`adb_mu‹x_uÆock
(&
usb_lock
);

158 
hªdË
->
Ãxt
 = &
hªdË_li¡
;

159 
hªdË
->
´ev
 = 
hªdË_li¡
.prev;

160 
hªdË
->
´ev
->
Ãxt
 = handle;

161 
hªdË
->
Ãxt
->
´ev
 = handle;

163 
	`adb_mu‹x_uÆock
(&
usb_lock
);

166 
	}
}

168 * 
	$deviû_pŞl_th»ad
(* 
unu£d
) {

169 
	`D
("Created devicehread\n");

172 
	`fšd_deviûs
();

173 
	`adb_¦“p_ms
(1000);

176  
NULL
;

177 
	}
}

179 
	$usb_š™
() {

180 
adb_th»ad_t
 
tid
;

182 if(
	`adb_th»ad_ü—‹
(&
tid
, 
deviû_pŞl_th»ad
, 
NULL
)) {

183 
	`çl_”ºo
("cannot create inputhread");

185 
	}
}

187 
	$usb_ş—nup
() {

188 
	}
}

190 
usb_hªdË
* 
	$do_usb_İ’
(cÚ¡ 
wch¬_t
* 
š‹rçû_Çme
) {

192 
usb_hªdË
* 
»t
 = (usb_hªdË*)
	`m®loc
((usb_handle));

193 ià(
NULL
 =ğ
»t
)

194  
NULL
;

197 
»t
->
Ãxt
 =„et;

198 
»t
->
´ev
 =„et;

201 
»t
->
adb_š‹rçû
 = 
	`AdbC»©eIÁ”çûByName
(
š‹rçû_Çme
);

203 ià(
NULL
 =ğ
»t
->
adb_š‹rçû
) {

204 
	`ä“
(
»t
);

205 
”ºo
 = 
	`G‘La¡E¼Ü
();

206  
NULL
;

210 
»t
->
adb_»ad_pe
 =

211 
	`AdbO³nDeçuÉBulkR—dEndpošt
(
»t
->
adb_š‹rçû
,

212 
AdbO³nAcûssTy³R—dWr™e
,

213 
AdbO³nSh¬šgModeR—dWr™e
);

214 ià(
NULL
 !ğ
»t
->
adb_»ad_pe
) {

216 
»t
->
adb_wr™e_pe
 =

217 
	`AdbO³nDeçuÉBulkWr™eEndpošt
(
»t
->
adb_š‹rçû
,

218 
AdbO³nAcûssTy³R—dWr™e
,

219 
AdbO³nSh¬šgModeR—dWr™e
);

220 ià(
NULL
 !ğ
»t
->
adb_wr™e_pe
) {

222 
Çme_Ën
 = 0;

225 
	`AdbG‘IÁ”çûName
(
»t
->
adb_š‹rçû
,

226 
NULL
,

227 &
Çme_Ën
,

228 
Œue
);

229 ià(0 !ğ
Çme_Ën
) {

230 
»t
->
š‹rçû_Çme
 = (*)
	`m®loc
(
Çme_Ën
);

232 ià(
NULL
 !ğ
»t
->
š‹rçû_Çme
) {

234 ià(
	`AdbG‘IÁ”çûName
(
»t
->
adb_š‹rçû
,

235 
»t
->
š‹rçû_Çme
,

236 &
Çme_Ën
,

237 
Œue
)) {

239  
»t
;

242 
	`S‘La¡E¼Ü
(
ERROR_OUTOFMEMORY
);

249 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

250 
	`usb_ş—nup_hªdË
(
»t
);

251 
	`ä“
(
»t
);

252 
	`S‘La¡E¼Ü
(
§ved_”ºo
);

254  
NULL
;

255 
	}
}

257 
	$usb_wr™e
(
usb_hªdË
* 
hªdË
, cÚ¡ * 
d©a
, 
Ën
) {

258 
time_out
 = 5000;

259 
wr™‹n
 = 0;

260 
»t
;

262 
	`D
("usb_wr™%d\n", 
Ën
);

263 ià(
NULL
 !ğ
hªdË
) {

265 
»t
 = 
	`AdbWr™eEndpoštSync
(
hªdË
->
adb_wr™e_pe
,

266 (*)
d©a
,

267 ()
Ën
,

268 &
wr™‹n
,

269 
time_out
);

270 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

272 ià(
»t
) {

274 
	`D
("usb_wr™gÙ: %ld,ƒx³ùed: %d\n", 
wr™‹n
, 
Ën
);

275 ià(
wr™‹n
 =ğ()
Ën
) {

276 if(
hªdË
->
z”o_mask
 && (
Ën
 & handle->zero_mask) == 0) {

278 
	`AdbWr™eEndpoštSync
(
hªdË
->
adb_wr™e_pe
,

279 (*)
d©a
,

281 &
wr™‹n
,

282 
time_out
);

288 ià(
§ved_”ºo
 =ğ
ERROR_INVALID_HANDLE
)

289 
	`usb_kick
(
hªdË
);

291 
”ºo
 = 
§ved_”ºo
;

293 
	`D
("usb_write NULL handle\n");

294 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

297 
	`D
("usb_wr™çed: %d\n", 
”ºo
);

300 
	}
}

302 
	$usb_»ad
(
usb_hªdË
 *
hªdË
, * 
d©a
, 
Ën
) {

303 
time_out
 = 0;

304 
»ad
 = 0;

305 
»t
;

307 
	`D
("usb_»ad %d\n", 
Ën
);

308 ià(
NULL
 !ğ
hªdË
) {

309 
Ën
 > 0) {

310 
xãr
 = (
Ën
 > 4096) ? 4096 :†en;

312 
»t
 = 
	`AdbR—dEndpoštSync
(
hªdË
->
adb_»ad_pe
,

313 (*)
d©a
,

314 ()
xãr
,

315 &
»ad
,

316 
time_out
);

317 
§ved_”ºo
 = 
	`G‘La¡E¼Ü
();

318 
	`D
("usb_wr™gÙ: %ld,ƒx³ùed: %d,ƒ¼no: %d\n", 
»ad
, 
xãr
, 
§ved_”ºo
);

319 ià(
»t
) {

320 
d©a
 +ğ
»ad
;

321 
Ën
 -ğ
»ad
;

323 ià(
Ën
 == 0)

327 ià(
§ved_”ºo
 =ğ
ERROR_INVALID_HANDLE
)

328 
	`usb_kick
(
hªdË
);

331 
”ºo
 = 
§ved_”ºo
;

334 
	`D
("usb_read NULL handle\n");

335 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

338 
	`D
("usb_»ad faed: %d\n", 
”ºo
);

341 
	}
}

343 
	$usb_ş—nup_hªdË
(
usb_hªdË
* 
hªdË
) {

344 ià(
NULL
 !ğ
hªdË
) {

345 ià(
NULL
 !ğ
hªdË
->
š‹rçû_Çme
)

346 
	`ä“
(
hªdË
->
š‹rçû_Çme
);

347 ià(
NULL
 !ğ
hªdË
->
adb_wr™e_pe
)

348 
	`AdbClo£HªdË
(
hªdË
->
adb_wr™e_pe
);

349 ià(
NULL
 !ğ
hªdË
->
adb_»ad_pe
)

350 
	`AdbClo£HªdË
(
hªdË
->
adb_»ad_pe
);

351 ià(
NULL
 !ğ
hªdË
->
adb_š‹rçû
)

352 
	`AdbClo£HªdË
(
hªdË
->
adb_š‹rçû
);

354 
hªdË
->
š‹rçû_Çme
 = 
NULL
;

355 
hªdË
->
adb_wr™e_pe
 = 
NULL
;

356 
hªdË
->
adb_»ad_pe
 = 
NULL
;

357 
hªdË
->
adb_š‹rçû
 = 
NULL
;

359 
	}
}

361 
	$usb_kick
(
usb_hªdË
* 
hªdË
) {

362 ià(
NULL
 !ğ
hªdË
) {

363 
	`adb_mu‹x_lock
(&
usb_lock
);

365 
	`usb_ş—nup_hªdË
(
hªdË
);

367 
	`adb_mu‹x_uÆock
(&
usb_lock
);

369 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

370 
”ºo
 = 
ERROR_INVALID_HANDLE
;

372 
	}
}

374 
	$usb_şo£
(
usb_hªdË
* 
hªdË
) {

375 
	`D
("usb_close\n");

377 ià(
NULL
 !ğ
hªdË
) {

379 
	`adb_mu‹x_lock
(&
usb_lock
);

381 ià((
hªdË
->
Ãxt
 !ğhªdËè&& (hªdË->
´ev
 != handle)) {

382 
hªdË
->
Ãxt
->
´ev
 = handle->prev;

383 
hªdË
->
´ev
->
Ãxt
 = handle->next;

384 
hªdË
->
´ev
 = handle;

385 
hªdË
->
Ãxt
 = handle;

388 
	`adb_mu‹x_uÆock
(&
usb_lock
);

391 
	`usb_ş—nup_hªdË
(
hªdË
);

392 
	`ä“
(
hªdË
);

396 
	}
}

398 cÚ¡ *
	$usb_Çme
(
usb_hªdË
* 
hªdË
) {

399 ià(
NULL
 =ğ
hªdË
) {

400 
	`S‘La¡E¼Ü
(
ERROR_INVALID_HANDLE
);

401 
”ºo
 = 
ERROR_INVALID_HANDLE
;

402  
NULL
;

405  (cÚ¡ *)
hªdË
->
š‹rçû_Çme
;

406 
	}
}

408 
	$»cognized_deviû
(
usb_hªdË
* 
hªdË
) {

409 ià(
NULL
 =ğ
hªdË
)

413 
USB_DEVICE_DESCRIPTOR
 
deviû_desc
;

415 ià(!
	`AdbG‘UsbDeviûDesütÜ
(
hªdË
->
adb_š‹rçû
,

416 &
deviû_desc
)) {

421 
USB_INTERFACE_DESCRIPTOR
 
š‹rf_desc
;

423 ià(!
	`AdbG‘UsbIÁ”çûDesütÜ
(
hªdË
->
adb_š‹rçû
,

424 &
š‹rf_desc
)) {

429 ià(2 !ğ
š‹rf_desc
.
bNumEndpošts
) {

433 ià(
	`is_adb_š‹rçû
(
deviû_desc
.
idV’dÜ
, deviû_desc.
idProduù
,

434 
š‹rf_desc
.
bIÁ”çûCÏss
, iÁ”f_desc.
bIÁ”çûSubCÏss
, iÁ”f_desc.
bIÁ”çûPrÙocŞ
)) {

436 if(
š‹rf_desc
.
bIÁ”çûPrÙocŞ
 == 0x01) {

437 
AdbEndpoštInfÜm©iÚ
 
’dpošt_šfo
;

439 ià(
	`AdbG‘EndpoštInfÜm©iÚ
(
hªdË
->
adb_š‹rçû
, 0, &
’dpošt_šfo
)) {

440 
hªdË
->
z”o_mask
 = 
’dpošt_šfo
.
max_·ck‘_size
 - 1;

448 
	}
}

450 
	$fšd_deviûs
() {

451 
usb_hªdË
* 
hªdË
 = 
NULL
;

452 
’Œy_bufãr
[2048];

453 
š‹rf_Çme
[2048];

454 
AdbIÁ”çûInfo
* 
Ãxt_š‹rçû
 = (AdbIÁ”çûInfo*)(&
’Œy_bufãr
[0]);

455 
’Œy_bufãr_size
 = (
’Œy_bufãr
);

456 * 
cİy_Çme
;

459 
ADBAPIHANDLE
 
’um_hªdË
 =

460 
	`AdbEnumIÁ”çûs
(
usb_şass_id
, 
Œue
,rue,rue);

462 ià(
NULL
 =ğ
’um_hªdË
)

465 
	`AdbNextIÁ”çû
(
’um_hªdË
, 
Ãxt_š‹rçû
, &
’Œy_bufãr_size
)) {

469 cÚ¡ 
wch¬_t
* 
wch¬_Çme
 = 
Ãxt_š‹rçû
->
deviû_Çme
;

470 
cİy_Çme
 = 
š‹rf_Çme
;

471 
L
'\0' !ğ*
wch¬_Çme
;

472 
wch¬_Çme
++, 
cİy_Çme
++) {

473 *
cİy_Çme
 = ()(*
wch¬_Çme
);

475 *
cİy_Çme
 = '\0';

478 ià(!
	`known_deviû
(
š‹rf_Çme
)) {

480 
hªdË
 = 
	`do_usb_İ’
(
Ãxt_š‹rçû
->
deviû_Çme
);

481 ià(
NULL
 !ğ
hªdË
) {

483 ià(
	`»cognized_deviû
(
hªdË
)) {

484 
	`D
("addšg‡‚ew deviû %s\n", 
š‹rf_Çme
);

485 
£rŸl_numb”
[512];

486 
£rŸl_numb”_Ën
 = (
£rŸl_numb”
);

487 ià(
	`AdbG‘S”ŸlNumb”
(
hªdË
->
adb_š‹rçû
,

488 
£rŸl_numb”
,

489 &
£rŸl_numb”_Ën
,

490 
Œue
)) {

492 ià(
	`»gi¡”_Ãw_deviû
(
hªdË
)) {

493 
	`»gi¡”_usb_Œª¥Üt
(
hªdË
, 
£rŸl_numb”
, 
NULL
, 1);

495 
	`D
("»gi¡”_Ãw_deviû faed fÜ %s\n", 
š‹rf_Çme
);

496 
	`usb_ş—nup_hªdË
(
hªdË
);

497 
	`ä“
(
hªdË
);

500 
	`D
("cannot get serial‚umber\n");

501 
	`usb_ş—nup_hªdË
(
hªdË
);

502 
	`ä“
(
hªdË
);

505 
	`usb_ş—nup_hªdË
(
hªdË
);

506 
	`ä“
(
hªdË
);

511 
’Œy_bufãr_size
 = (
’Œy_bufãr
);

514 
	`AdbClo£HªdË
(
’um_hªdË
);

515 
	}
}

	@utils.c

16 
	~"uts.h
"

17 
	~<¡d¬g.h
>

18 
	~<¡dio.h
>

19 
	~<¡ršg.h
>

22 
	$buff_addc
 (* 
buff
, * 
buffEnd
, 
c
)

24 
ava
 = 
buffEnd
 - 
buff
;

26 ià(
ava
 <= 0)

27  
buff
;

29 ià(
ava
 == 1) {

30 
buff
[0] = 0;

31  
buff
 + 1;

34 
buff
[0] = (è
c
;

35 
buff
[1] = 0;

36  
buff
 + 1;

37 
	}
}

40 
	$buff_adds
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
s
)

42 
¦’
 = 
	`¡¾’
(
s
);

44  
	`buff_addb
(
buff
, 
buffEnd
, 
s
, 
¦’
);

45 
	}
}

48 
	$buff_addb
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
d©a
, 
Ën
)

50 
ava
 = (
buffEnd
 - 
buff
);

52 ià(
ava
 <ğ0 || 
Ën
 <= 0)

53  
buff
;

55 ià(
Ën
 > 
ava
)

56 
Ën
 = 
ava
;

58 
	`memıy
(
buff
, 
d©a
, 
Ën
);

60 
buff
 +ğ
Ën
;

63 ià(
buff
 >ğ
buffEnd
) {

64 
buff
[-1] = 0;

66 
buff
[0] = 0;

68  
buff
;

69 
	}
}

72 
	$buff_add
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
fÜm©
, ... )

74 
ava
;

76 
ava
 = (
buffEnd
 - 
buff
);

78 ià(
ava
 > 0) {

79 
va_li¡
 
¬gs
;

80 
Â
;

82 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

83 
Â
 = 
	`v¢´štf
Ğ
buff
, 
ava
, 
fÜm©
, 
¬gs
);

84 
	`va_’d
(
¬gs
);

86 ià(
Â
 < 0) {

91 
Â
 = 
ava
;

93 ià(
Â
 > 
ava
) {

94 
Â
 = 
ava
;

97 
buff
 +ğ
Â
;

100 ià(
buff
 >ğ
buffEnd
)

101 
buff
[-1] = 0;

103 
buff
[0] = 0;

105  
buff
;

106 
	}
}

	@utils.h

16 #iâdeà
_ADB_UTILS_H


17 
	#_ADB_UTILS_H


	)

45 * 
buff_addc
 (* 
buff
, * 
buffEnd
, 
c
);

48 * 
buff_adds
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
s
);

53 * 
buff_addb
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
d©a
, 
Ën
);

56 * 
buff_add
 (* 
buff
, * 
buffEnd
, cÚ¡ * 
fÜm©
, ... );

65 
	#BUFF_DECL
(
_buff
,
_cursÜ
,
_’d
,
_size
) \

66 
_buff
[
_size
], *
_cursÜ
=_buff, *
_’d
 = _cursÜ + (_size)

	)

	@
1
.
0
162
4295
adb.c
adb.h
adb_auth.h
adb_auth_client.c
adb_auth_host.c
adb_client.c
adb_client.h
backup_service.c
commandline.c
console.c
fdevent.c
fdevent.h
file_sync_client.c
file_sync_service.c
file_sync_service.h
framebuffer_service.c
get_my_path_darwin.c
get_my_path_freebsd.c
get_my_path_linux.c
get_my_path_windows.c
jdwp_service.c
libs/libcutils/abort_socket.c
libs/libcutils/android_reboot.c
libs/libcutils/arch-arm/memset32.S
libs/libcutils/arch-x86/android_memset16.S
libs/libcutils/arch-x86/android_memset32.S
libs/libcutils/arch-x86/cache_wrapper.S
libs/libcutils/arch-x86/sse2-memset16-atom.S
libs/libcutils/arch-x86/sse2-memset32-atom.S
libs/libcutils/array.c
libs/libcutils/ashmem-dev.c
libs/libcutils/ashmem-host.c
libs/libcutils/atomic.c
libs/libcutils/buffer.c
libs/libcutils/buffer.h
libs/libcutils/config_utils.c
libs/libcutils/cpu_info.c
libs/libcutils/cutils/abort_socket.h
libs/libcutils/cutils/android_reboot.h
libs/libcutils/cutils/array.h
libs/libcutils/cutils/ashmem.h
libs/libcutils/cutils/atomic-arm.h
libs/libcutils/cutils/atomic-inline.h
libs/libcutils/cutils/atomic-mips.h
libs/libcutils/cutils/atomic-x86.h
libs/libcutils/cutils/atomic.h
libs/libcutils/cutils/bitops.h
libs/libcutils/cutils/compiler.h
libs/libcutils/cutils/config_utils.h
libs/libcutils/cutils/cpu_info.h
libs/libcutils/cutils/debugger.h
libs/libcutils/cutils/dir_hash.h
libs/libcutils/cutils/event_tag_map.h
libs/libcutils/cutils/fs.h
libs/libcutils/cutils/hashmap.h
libs/libcutils/cutils/iosched_policy.h
libs/libcutils/cutils/jstring.h
libs/libcutils/cutils/klog.h
libs/libcutils/cutils/list.h
libs/libcutils/cutils/log.h
libs/libcutils/cutils/log_bak_for_android.h
libs/libcutils/cutils/logd.h
libs/libcutils/cutils/logger.h
libs/libcutils/cutils/logprint.h
libs/libcutils/cutils/memory.h
libs/libcutils/cutils/misc.h
libs/libcutils/cutils/mq.h
libs/libcutils/cutils/multiuser.h
libs/libcutils/cutils/native_handle.h
libs/libcutils/cutils/open_memstream.h
libs/libcutils/cutils/partition_utils.h
libs/libcutils/cutils/process_name.h
libs/libcutils/cutils/properties.h
libs/libcutils/cutils/qsort_r_compat.h
libs/libcutils/cutils/qtaguid.h
libs/libcutils/cutils/record_stream.h
libs/libcutils/cutils/sched_policy.h
libs/libcutils/cutils/selector.h
libs/libcutils/cutils/sockets.h
libs/libcutils/cutils/str_parms.h
libs/libcutils/cutils/threads.h
libs/libcutils/cutils/tztime.h
libs/libcutils/cutils/uevent.h
libs/libcutils/cutils/uio.h
libs/libcutils/cutils/zygote.h
libs/libcutils/debugger.c
libs/libcutils/dir_hash.c
libs/libcutils/dlmalloc_stubs.c
libs/libcutils/fs.c
libs/libcutils/hashmap.c
libs/libcutils/include/ashmem.h
libs/libcutils/iosched_policy.c
libs/libcutils/klog.c
libs/libcutils/list.c
libs/libcutils/load_file.c
libs/libcutils/loghack.h
libs/libcutils/memory.c
libs/libcutils/misc_rw.c
libs/libcutils/mq.c
libs/libcutils/multiuser.c
libs/libcutils/native_handle.c
libs/libcutils/open_memstream.c
libs/libcutils/partition_utils.c
libs/libcutils/private.h
libs/libcutils/process_name.c
libs/libcutils/properties.c
libs/libcutils/qsort_r_compat.c
libs/libcutils/qtaguid.c
libs/libcutils/record_stream.c
libs/libcutils/sched_policy.c
libs/libcutils/selector.c
libs/libcutils/socket_inaddr_any_server.c
libs/libcutils/socket_local.h
libs/libcutils/socket_local_client.c
libs/libcutils/socket_local_server.c
libs/libcutils/socket_loopback_client.c
libs/libcutils/socket_loopback_server.c
libs/libcutils/socket_network_client.c
libs/libcutils/sockets.c
libs/libcutils/str_parms.c
libs/libcutils/strdup16to8.c
libs/libcutils/strdup8to16.c
libs/libcutils/threads.c
libs/libcutils/tzfile.h
libs/libcutils/tzstrftime.c
libs/libcutils/tztime.c
libs/libcutils/uevent.c
libs/libcutils/uio.c
libs/libcutils/zygote.c
libs/libmincrypt/mincrypt/rsa.h
libs/libmincrypt/mincrypt/sha.h
libs/libmincrypt/rsa.c
libs/libmincrypt/rsa_e_3.c
libs/libmincrypt/rsa_e_f4.c
libs/libmincrypt/sha.c
libs/libmincrypt/tools/DumpPublicKey.java
log_service.c
mutex_list.h
private/android_filesystem_config.h
qemu/qemu.c
qemu/qemu.h
qemu/qemu_pipe.h
remount_service.c
services.c
sockets.c
sysdeps.h
sysdeps_win32.c
test_track_devices.c
test_track_jdwp.c
transport.c
transport.h
transport_local.c
transport_usb.c
usb_libusb.c
usb_linux.c
usb_linux_client.c
usb_osx.c
usb_vendors.c
usb_vendors.h
usb_windows.c
utils.c
utils.h
